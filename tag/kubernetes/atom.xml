<?xml version="1.0"?>
<feed xmlns="http://www.w3.org/2005/Atom">
    <id>https://fangjiaxiaobai.github.io</id>
    <title>方家小白 • Posts by &#34;kubernetes&#34; tag</title>
    <link href="https://fangjiaxiaobai.github.io" />
    <updated>2022-07-31T10:18:00.000Z</updated>
    <category term="全站地图" />
    <category term="目录" />
    <category term="源码" />
    <category term="MySQL" />
    <category term="Redis" />
    <category term="数据结构" />
    <category term="日常" />
    <category term="Springboot" />
    <category term="Netty" />
    <category term="Elastic Search" />
    <category term="搜索" />
    <category term="雪花算法" />
    <category term="算法" />
    <category term="git" />
    <category term="k8s" />
    <category term="kubernetes" />
    <category term="MachineLearn" />
    <category term="猫影视" />
    <category term="log" />
    <category term="go-log" />
    <category term="图片" />
    <category term="RocketMQ" />
    <category term="消息队列" />
    <category term="go" />
    <category term="go-error" />
    <category term="线程池" />
    <category term="面经" />
    <category term="leetCode" />
    <category term="数组" />
    <category term="面经之算法题" />
    <category term="链表" />
    <category term="不做也罢的算法题" />
    <category term="有点难的算法题" />
    <category term="HD" />
    <category term="BQ" />
    <category term="AC" />
    <category term="动态规划" />
    <category term="String" />
    <category term="JDK" />
    <category term="JDK8" />
    <category term="数据结构与算法" />
    <category term="哈希算法" />
    <category term="排序" />
    <category term="冒泡排序" />
    <category term="交换排序" />
    <category term="HashMap" />
    <category term="分治思想排序" />
    <category term="桶排序" />
    <category term="线性思想排序" />
    <category term="快速排序" />
    <category term="分支思想排序" />
    <category term="递归" />
    <category term="选择排序" />
    <category term="go-设计模式" />
    <category term="Java" />
    <category term="dubbo" />
    <category term="模型评估" />
    <category term="架构" />
    <category term="笔记" />
    <category term="go-runtimes" />
    <category term="KNN" />
    <category term="JDK版本" />
    <category term="JDK11" />
    <category term="OOM" />
    <category term="JVM" />
    <category term="Stream" />
    <entry>
        <id>https://fangjiaxiaobai.github.io/2022/07/31/k8s/seris03-pod-lifecycle/</id>
        <title>k8s-Pod的生命周期</title>
        <link rel="alternate" href="https://fangjiaxiaobai.github.io/2022/07/31/k8s/seris03-pod-lifecycle/"/>
        <content type="html">&lt;p&gt;&lt;code&gt;K8s&lt;/code&gt;  中所有的内容都抽象为资源，资源实例化为对象。&lt;/p&gt;
&lt;h2 id=&#34;集群资源的分类&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#集群资源的分类&#34;&gt;#&lt;/a&gt; 集群资源的分类&lt;/h2&gt;
&lt;h3 id=&#34;名称空间级别&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#名称空间级别&#34;&gt;#&lt;/a&gt; 名称空间级别&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;工作负载型资源 (  &lt;code&gt;workload&lt;/code&gt;  )：  &lt;code&gt;Pod&lt;/code&gt; 、 &lt;code&gt;ReplicaSet&lt;/code&gt; 、 &lt;code&gt;Deployment&lt;/code&gt; 、 &lt;code&gt;StatefulSet&lt;/code&gt; 、 &lt;code&gt;DaemonSet、Job&lt;/code&gt; 、  &lt;code&gt;CronJob&lt;/code&gt;  (  &lt;code&gt;ReplicationController&lt;/code&gt;  在  &lt;code&gt;v1.11&lt;/code&gt;  版本被废弃 )&lt;/li&gt;
&lt;li&gt;服务发现及负载均衡型资源 (  &lt;code&gt;ServiceDiscovery LoadBalance&lt;/code&gt;  ):  &lt;code&gt;Service&lt;/code&gt; 、 &lt;code&gt;Ingress&lt;/code&gt; 、…&lt;/li&gt;
&lt;li&gt;配置与存储型资源： &lt;code&gt; Volume&lt;/code&gt;  (存储卷)、 &lt;code&gt;CSI&lt;/code&gt;  (容器存储接口，可以扩展各种各样的第三方存储卷)&lt;/li&gt;
&lt;li&gt;特殊类型的存储卷： &lt;code&gt;ConfigMap&lt;/code&gt;  (当配置中心来使用的资源类型)、 &lt;code&gt;Secret&lt;/code&gt;  (保存敏感数据)、  &lt;code&gt;DownwardAPI&lt;/code&gt;  (把外部环境中的信息输出给容器)&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&#34;集群级别&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#集群级别&#34;&gt;#&lt;/a&gt; 集群级别&lt;/h3&gt;
&lt;p&gt;一旦定义在集群内都可见。&lt;/p&gt;
&lt;p&gt;&lt;code&gt;Namespace&lt;/code&gt; ,  &lt;code&gt;Node&lt;/code&gt; ,  &lt;code&gt;Role&lt;/code&gt; ,  &lt;code&gt;ClusterRole&lt;/code&gt; ,  &lt;code&gt;RoleBindiing&lt;/code&gt; ,  &lt;code&gt;ClusterRoleBinding&lt;/code&gt;&lt;/p&gt;
&lt;h3 id=&#34;元数据型&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#元数据型&#34;&gt;#&lt;/a&gt; 元数据型&lt;/h3&gt;
&lt;p&gt;&lt;code&gt;HPA&lt;/code&gt; 、 &lt;code&gt;PodTemplate&lt;/code&gt; 、 &lt;code&gt;LimitRange&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;在 &lt;code&gt;k8s&lt;/code&gt;  中，一般使用  &lt;code&gt;yaml&lt;/code&gt;  格式的文件来创建符合我们预期期望的 &lt;code&gt;pod&lt;/code&gt; , 这样的  &lt;code&gt;yaml&lt;/code&gt;  文件，我们一般成为 资源清单。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;apiVersion&lt;/code&gt; :   &lt;code&gt;String&lt;/code&gt; ,  &lt;code&gt;K8s Api&lt;/code&gt;  的版本，可以用 &lt;code&gt;kubectl api-versions&lt;/code&gt;  命令查询&lt;/li&gt;
&lt;li&gt;&lt;code&gt;kind&lt;/code&gt; :  &lt;code&gt;String&lt;/code&gt; ,  &lt;code&gt;yaml&lt;/code&gt;  定义的资源类型和角色&lt;/li&gt;
&lt;li&gt;&lt;code&gt;metadata&lt;/code&gt; :  &lt;code&gt;Object&lt;/code&gt; , 元数据对象，固定值就写  &lt;code&gt;metadata&lt;/code&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;name&lt;/code&gt; : 元数据对象的名称&lt;/li&gt;
&lt;li&gt;&lt;code&gt;namespace&lt;/code&gt; : 元数据对象的命名空间，有我们自身定义&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;code&gt;spec&lt;/code&gt; : &lt;code&gt;Object&lt;/code&gt;  详细定义对象，固定值是 &lt;code&gt;Spec&lt;/code&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;containers[]&lt;/code&gt; :  &lt;code&gt;list&lt;/code&gt;  类型，这里是 &lt;code&gt;spec&lt;/code&gt;  对象的容器列表定义，是个列表
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;name&lt;/code&gt; :  &lt;code&gt;String&lt;/code&gt; , 这里是定义容器的名字&lt;/li&gt;
&lt;li&gt;&lt;code&gt;image&lt;/code&gt; :  &lt;code&gt;String&lt;/code&gt; , 这里定义要用到的镜像名称&lt;/li&gt;
&lt;li&gt;&lt;code&gt;imagePullPolicy&lt;/code&gt; :  &lt;code&gt;String&lt;/code&gt; , 定义镜像拉取策略，有 &lt;code&gt;Always&lt;/code&gt; , &lt;code&gt;Never&lt;/code&gt; , &lt;code&gt;IfNotPresent&lt;/code&gt; , 三个值。默认是  &lt;code&gt;Always&lt;/code&gt; .
&lt;ul&gt;
&lt;li&gt;1、 &lt;code&gt;Always&lt;/code&gt; : 每次都尝试拉取镜像&lt;/li&gt;
&lt;li&gt;2、 &lt;code&gt;Never&lt;/code&gt; : 表示仅使用本地镜像&lt;/li&gt;
&lt;li&gt;3、 &lt;code&gt;IfNotPresent&lt;/code&gt; : 如果本地有镜像就使用本地镜像，没有就拉取在线镜像。&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;code&gt;command[]&lt;/code&gt; ,  &lt;code&gt;List&lt;/code&gt; , 容器启动命令，因为是数据可以指定多个，不指定则使用镜像打包时使用的启动命令&lt;/li&gt;
&lt;li&gt;&lt;code&gt;args&lt;/code&gt; :  &lt;code&gt;List，&lt;/code&gt;  指定容器启动的命令参数，可以指定多个&lt;/li&gt;
&lt;li&gt;&lt;code&gt;workingDir&lt;/code&gt; :  &lt;code&gt;String&lt;/code&gt; , 指定容器的工作目录&lt;/li&gt;
&lt;li&gt;&lt;code&gt;volumeMountsp[]&lt;/code&gt; ,  &lt;code&gt;List&lt;/code&gt; : 指定容器内部的存储卷配置
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;name&lt;/code&gt; :  &lt;code&gt;String&lt;/code&gt; , 指定可以挂载的存储卷的名称&lt;/li&gt;
&lt;li&gt;&lt;code&gt;mountPath&lt;/code&gt; ,  &lt;code&gt;String&lt;/code&gt; , 指定可以被容器挂载的存储卷的路径&lt;/li&gt;
&lt;li&gt;&lt;code&gt;readOnly&lt;/code&gt; ,  &lt;code&gt;String&lt;/code&gt; , 设置存储卷路径的读写模型，  &lt;code&gt;true&lt;/code&gt;  或者  &lt;code&gt;false&lt;/code&gt; .&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;code&gt;ports[]&lt;/code&gt; ,  &lt;code&gt;List&amp;lt;Object&amp;gt;&lt;/code&gt;  , 指定容器使用的端口列表
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;name&lt;/code&gt; :  &lt;code&gt;String&lt;/code&gt; , 端口名称&lt;/li&gt;
&lt;li&gt;&lt;code&gt;containerPort&lt;/code&gt; :  &lt;code&gt;String&lt;/code&gt; , 容器你需要监听的端口号&lt;/li&gt;
&lt;li&gt;&lt;code&gt;hostPort&lt;/code&gt; :  &lt;code&gt;String&lt;/code&gt; , 指定容器所在主机需要监听的端口号，默认跟上面  &lt;code&gt;containerPort&lt;/code&gt;  相同， 注意设置了  &lt;code&gt;hostPort&lt;/code&gt;  同一台主机无法启动该容器的相同副本&lt;/li&gt;
&lt;li&gt;&lt;code&gt;protocol&lt;/code&gt; :  &lt;code&gt;String&lt;/code&gt; , 指定端口协议，支持  &lt;code&gt;TCP&lt;/code&gt; , &lt;code&gt;UDP&lt;/code&gt; , 默认是  &lt;code&gt;TCP&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;code&gt;env[]&lt;/code&gt; : &lt;code&gt;List&amp;lt;Object&amp;gt;&lt;/code&gt;  , 指定容器运行前需要设置的环境变量列表
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;name&lt;/code&gt; :  &lt;code&gt;String&lt;/code&gt; , 环境变量名称&lt;/li&gt;
&lt;li&gt;&lt;code&gt;value&lt;/code&gt; :  &lt;code&gt;String&lt;/code&gt; , 环境变量值&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;code&gt;resources&lt;/code&gt; :  &lt;code&gt;Object&lt;/code&gt; , 指定资源限制和资源请求的值
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;limits&lt;/code&gt; : 设置容器运行时的资源的运行上限
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;cpu&lt;/code&gt; :  &lt;code&gt;String&lt;/code&gt; ,  &lt;code&gt;CPU&lt;/code&gt;  的限制，单位为  &lt;code&gt;core&lt;/code&gt;  数，将用于  &lt;code&gt;docker run --cpu-shares&lt;/code&gt;  参数。&lt;/li&gt;
&lt;li&gt;&lt;code&gt;memory&lt;/code&gt; :  &lt;code&gt;String&lt;/code&gt; ,  &lt;code&gt;Mem&lt;/code&gt;  内存的限制，单位为  &lt;code&gt;MIB&lt;/code&gt; , &lt;code&gt;GiB&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;code&gt;requests&lt;/code&gt; :  &lt;code&gt;Object&lt;/code&gt; , 指定容器启动和调度时的限制设置
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;cpu&lt;/code&gt; :  &lt;code&gt;m&lt;/code&gt; ,   &lt;code&gt;CPU&lt;/code&gt;  请求。单位为 &lt;code&gt;core&lt;/code&gt;  数，容器启动时初始化可用数量&lt;/li&gt;
&lt;li&gt;&lt;code&gt;memory&lt;/code&gt; :  &lt;code&gt;String&lt;/code&gt; , 内存请求，单位  &lt;code&gt;MIB&lt;/code&gt; ,  &lt;code&gt;Gib&lt;/code&gt; , 容器启动的初始化可用数量&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;code&gt;restartPolicy&lt;/code&gt; :  &lt;code&gt;String&lt;/code&gt; , 定义 Pod 的重启策略，可选值是  &lt;code&gt;Always&lt;/code&gt; ,  &lt;code&gt;OnFailure&lt;/code&gt; , 默认值是  &lt;code&gt;Always&lt;/code&gt; .
&lt;ul&gt;
&lt;li&gt;1. &lt;code&gt;Always&lt;/code&gt; :  &lt;code&gt;Pod&lt;/code&gt;  一旦终止运行，则无论容器是否终止，  &lt;code&gt;kubelet&lt;/code&gt;  服务都将重启它。&lt;/li&gt;
&lt;li&gt;2、 &lt;code&gt;OnFailure&lt;/code&gt; : 只有 &lt;code&gt;Pod&lt;/code&gt;  以非 &lt;code&gt;0&lt;/code&gt;  退出码终止时，  &lt;code&gt;kubelet&lt;/code&gt;  才会重启该容器，如果容器正常结束，则不会重启&lt;/li&gt;
&lt;li&gt;3、 &lt;code&gt;Never&lt;/code&gt; .  &lt;code&gt;Pod&lt;/code&gt;  终止后， &lt;code&gt;kubelet&lt;/code&gt;  将退出码报告给 &lt;code&gt;Master&lt;/code&gt; ，不会重启 &lt;code&gt;Pod&lt;/code&gt; .&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;code&gt;nodeSelector&lt;/code&gt; :  &lt;code&gt;Object&lt;/code&gt; , 定义 &lt;code&gt;Node&lt;/code&gt;  的 &lt;code&gt;label&lt;/code&gt;  过滤标签，已 &lt;code&gt;key&lt;/code&gt; , &lt;code&gt;value&lt;/code&gt;  的格式指定。&lt;/li&gt;
&lt;li&gt;&lt;code&gt;imagePullSecrets&lt;/code&gt; :  &lt;code&gt;Object&lt;/code&gt; , 定义 &lt;code&gt;pull&lt;/code&gt;  镜像时使用 Secret 名称，以 &lt;code&gt;name:secretKey&lt;/code&gt;  格式指定&lt;/li&gt;
&lt;li&gt;&lt;code&gt;hostNetwork&lt;/code&gt; :  &lt;code&gt;Boolean&lt;/code&gt; , 定义是否使用主机网络，默认值为 &lt;code&gt;false&lt;/code&gt; , 设置为 &lt;code&gt;true&lt;/code&gt;  表示使用宿主机网络， 不使用 &lt;code&gt;docker&lt;/code&gt;  网桥，同时设置了 &lt;code&gt;true&lt;/code&gt;  将无法在同一台宿主机上启动第二个副本。&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;可以通过下面的命令实时查看 yaml 的配置内容&lt;/p&gt;
&lt;figure class=&#34;highlight shell&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;kubectl explain pod.&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h3 id=&#34;案例&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#案例&#34;&gt;#&lt;/a&gt; 案例&lt;/h3&gt;
&lt;p&gt;通过资源清单创建一个 pod.&lt;/p&gt;
&lt;figure class=&#34;highlight yaml&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;attr&#34;&gt;apiVersion:&lt;/span&gt; &lt;span class=&#34;string&#34;&gt;v1&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;attr&#34;&gt;kind:&lt;/span&gt; &lt;span class=&#34;string&#34;&gt;Pod&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;attr&#34;&gt;metadata:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;attr&#34;&gt;name:&lt;/span&gt; &lt;span class=&#34;string&#34;&gt;sample-demo&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;attr&#34;&gt;namespace:&lt;/span&gt; &lt;span class=&#34;string&#34;&gt;default&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;attr&#34;&gt;labels:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;attr&#34;&gt;app:&lt;/span&gt; &lt;span class=&#34;string&#34;&gt;myapp&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;attr&#34;&gt;spec:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;attr&#34;&gt;containers:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;bullet&#34;&gt;-&lt;/span&gt;   &lt;span class=&#34;attr&#34;&gt;name:&lt;/span&gt; &lt;span class=&#34;string&#34;&gt;my-app&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;attr&#34;&gt;image:&lt;/span&gt; &lt;span class=&#34;string&#34;&gt;fangjiaxiaobai/my-app:v1&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;使用  &lt;code&gt;kubectl create -f 01-sample-yaml.yaml&lt;/code&gt;  创建&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;/images/k8s/03-02.png&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;p&gt;使用命令  &lt;code&gt;kubectl get pods -o wide&lt;/code&gt;  查看下 &lt;code&gt;pod&lt;/code&gt;  的 &lt;code&gt;ip&lt;/code&gt;  和 状态:&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;/images/k8s/03-03.png&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;p&gt;然后使用   &lt;code&gt;curl 10.244.154.195&lt;/code&gt;  可以看到&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;/images/k8s/03-04.png&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;p&gt;正常返回了  &lt;code&gt;Nginx&lt;/code&gt;  的首页信息。&lt;/p&gt;
&lt;h2 id=&#34;pod-的生命周期&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#pod-的生命周期&#34;&gt;#&lt;/a&gt;  &lt;code&gt;Pod&lt;/code&gt;  的生命周期&lt;/h2&gt;
&lt;p&gt;&lt;img data-src=&#34;/images/k8s/03-05.png&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;p&gt;如上图， &lt;code&gt;pod&lt;/code&gt;  的启动过程是:  &lt;code&gt;pod&lt;/code&gt;  创建时会首先创建一个  &lt;code&gt;pause&lt;/code&gt;  容器。然后执行创建多个  &lt;code&gt;Init&lt;/code&gt;  容器，然后再启动 主容器，也就是一般我们使用镜像创建起来的具有业务属性的容器，称为主容器。 主容器会经历  &lt;code&gt;Start-&amp;gt;Running-&amp;gt;Stop&lt;/code&gt; , 这些状态。&lt;/p&gt;
&lt;h3 id=&#34;pause-容器&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#pause-容器&#34;&gt;#&lt;/a&gt; Pause 容器&lt;/h3&gt;
&lt;p&gt;从名字上看， &lt;code&gt;pause&lt;/code&gt;  是一个 &amp;quot;暂停&amp;quot; 的容器，它的作用是：解决 &lt;code&gt;pod&lt;/code&gt;  的网络和存储的问题。 &lt;code&gt;pause&lt;/code&gt;  容器称为  &lt;code&gt;Infra Container&lt;/code&gt; , 其他的容器称为业务容器.   &lt;code&gt;Infra container&lt;/code&gt;  是一个非常小的镜像，大概  &lt;code&gt;700KB &lt;/code&gt; 左右，是一个 &lt;code&gt;C&lt;/code&gt;  语言写的、永远处于 “暂停” 状态的容器。由于有了这样一个  &lt;code&gt;Infra container&lt;/code&gt;  之后，其他所有容器都会通过  &lt;code&gt;Join Namespace&lt;/code&gt;  的方式加入到  &lt;code&gt;Infra container&lt;/code&gt;  的  &lt;code&gt;Network Namespace&lt;/code&gt;  中。&lt;/p&gt;
&lt;h3 id=&#34;init-容器&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#init-容器&#34;&gt;#&lt;/a&gt; Init 容器&lt;/h3&gt;
&lt;p&gt;&lt;code&gt;Pod&lt;/code&gt;  能够具有多个容器，应用运行在容器里面，但是它也可能有一个或多个先于应用容器启动的 &lt;code&gt;Init&lt;/code&gt;  容器。&lt;br&gt;
 &lt;code&gt;Init&lt;/code&gt;  容器与普通的容器非常像，除了如下两点：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;Init&lt;/code&gt;  容器总是运行到成功完成为止&lt;/li&gt;
&lt;li&gt;每个  &lt;code&gt;Init&lt;/code&gt;  容器都必须在下一个  &lt;code&gt;Init&lt;/code&gt;  容器启动之前成功完成&lt;br&gt;
如果  &lt;code&gt;Pod&lt;/code&gt;  的  &lt;code&gt;Init&lt;/code&gt;  容器失败， &lt;code&gt;Kubernetes&lt;/code&gt;    &lt;code&gt;Pod&lt;/code&gt; ，直到  &lt;code&gt;Init&lt;/code&gt;  容器成功为止。然而，如果  &lt;code&gt;Pod&lt;/code&gt;  对应的  &lt;code&gt;restartPolicy&lt;/code&gt;  为  &lt;code&gt;Never&lt;/code&gt; ，它不会重新启动&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;因为  &lt;code&gt;Init&lt;/code&gt;  容器具有与应用程序容器分离的单独镜像，所以它们的启动相关代码具有如下优势：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;它们可以包含并运行实用工具，但是出于安全考虑，是不建议在应用程序容器镜像中包含这&lt;br&gt;
些实用工具的&lt;/li&gt;
&lt;li&gt;它们可以包含使用工具和定制化代码来安装，但是不能出现在应用程序镜像中。例如，创建镜像没必要  &lt;code&gt;FROM&lt;/code&gt;  另一个镜像，只需要在安装过程中使用类似  &lt;code&gt;sed&lt;/code&gt; 、  &lt;code&gt;awk&lt;/code&gt; 、  &lt;code&gt;python&lt;/code&gt;  或  &lt;code&gt;dig&lt;/code&gt;  这样的工具。&lt;/li&gt;
&lt;li&gt;应用程序镜像可以分离出创建和部署的角色，而没有必要联合它们构建一个单独的镜像。&lt;/li&gt;
&lt;li&gt;&lt;code&gt;Init&lt;/code&gt;  容器使用  &lt;code&gt;Linux Namespace&lt;/code&gt; ，所以相对应用程序容器来说具有不同的文件系统视图。因此，它们能够具有访问  &lt;code&gt;Secret&lt;/code&gt;  的权限，而应用程序容器则不能。&lt;/li&gt;
&lt;li&gt;它们必须在应用程序容器启动之前运行完成，而应用程序容器是并行运行的，所以  &lt;code&gt;Init&lt;/code&gt;  容器能够提供了一种简单的阻塞或延迟应用容器的启动的方法，直到满足了一组先决条件。&lt;/li&gt;
&lt;/ul&gt;
&lt;h4 id=&#34;init小实验&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#init小实验&#34;&gt;#&lt;/a&gt;  &lt;code&gt;init&lt;/code&gt;  小实验。&lt;/h4&gt;
&lt;p&gt;实验目的:  &lt;code&gt;init&lt;/code&gt;  容器会依次启动，只有  &lt;code&gt;init&lt;/code&gt;  容器启动完成之后， 主容器才会启动.&lt;/p&gt;
&lt;h5 id=&#34;实验步骤&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#实验步骤&#34;&gt;#&lt;/a&gt; 实验步骤&lt;/h5&gt;
&lt;ul&gt;
&lt;li&gt;创建  &lt;code&gt;pod&lt;/code&gt; .&lt;/li&gt;
&lt;li&gt;查看  &lt;code&gt;pod&lt;/code&gt;  的状态变化&lt;/li&gt;
&lt;li&gt;查看  &lt;code&gt;pod&lt;/code&gt;  中  &lt;code&gt;initC&lt;/code&gt;  的日志&lt;/li&gt;
&lt;li&gt;创建  &lt;code&gt;Service-1&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;查看  &lt;code&gt;pod&lt;/code&gt;  的状态变化&lt;/li&gt;
&lt;li&gt;查看  &lt;code&gt;pod&lt;/code&gt;  中  &lt;code&gt;initC&lt;/code&gt;  的日志&lt;/li&gt;
&lt;li&gt;创建  &lt;code&gt;Service-2&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;查看  &lt;code&gt;pod&lt;/code&gt;  的状态变化&lt;/li&gt;
&lt;li&gt;查看  &lt;code&gt;pod&lt;/code&gt;  中  &lt;code&gt;initC&lt;/code&gt;  的日志&lt;/li&gt;
&lt;li&gt;查看  &lt;code&gt;pod&lt;/code&gt;  的日志&lt;/li&gt;
&lt;/ul&gt;
&lt;h6 id=&#34;创建-pod&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#创建-pod&#34;&gt;#&lt;/a&gt; 创建  &lt;code&gt;pod&lt;/code&gt; .&lt;/h6&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;02-init-demo.yaml&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;figure class=&#34;highlight yaml&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;18&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;attr&#34;&gt;apiVersion:&lt;/span&gt; &lt;span class=&#34;string&#34;&gt;v1&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;attr&#34;&gt;kind:&lt;/span&gt; &lt;span class=&#34;string&#34;&gt;Pod&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;attr&#34;&gt;metadata:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  &lt;span class=&#34;attr&#34;&gt;name:&lt;/span&gt; &lt;span class=&#34;string&#34;&gt;init-demo&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  &lt;span class=&#34;attr&#34;&gt;labels:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;attr&#34;&gt;app:&lt;/span&gt; &lt;span class=&#34;string&#34;&gt;init-app&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;attr&#34;&gt;spec:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  &lt;span class=&#34;attr&#34;&gt;containers:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  &lt;span class=&#34;bullet&#34;&gt;-&lt;/span&gt; &lt;span class=&#34;attr&#34;&gt;name:&lt;/span&gt; &lt;span class=&#34;string&#34;&gt;my-init-demo&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;attr&#34;&gt;image:&lt;/span&gt; &lt;span class=&#34;string&#34;&gt;fangjiaxiaobai/my-app:v1&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;attr&#34;&gt;command:&lt;/span&gt; [&lt;span class=&#34;string&#34;&gt;&amp;quot;sh&amp;quot;&lt;/span&gt;, &lt;span class=&#34;string&#34;&gt;&amp;quot;-c&amp;quot;&lt;/span&gt;, &lt;span class=&#34;string&#34;&gt;&amp;quot;echo the app is running! &amp;amp;&amp;amp; sleep 3600&amp;quot;&lt;/span&gt;]&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  &lt;span class=&#34;attr&#34;&gt;initContainers:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  &lt;span class=&#34;bullet&#34;&gt;-&lt;/span&gt; &lt;span class=&#34;attr&#34;&gt;name:&lt;/span&gt; &lt;span class=&#34;string&#34;&gt;init-myservice-1&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;attr&#34;&gt;image:&lt;/span&gt; &lt;span class=&#34;string&#34;&gt;busybox&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;attr&#34;&gt;command:&lt;/span&gt; [&lt;span class=&#34;string&#34;&gt;&amp;#x27;sh&amp;#x27;&lt;/span&gt;, &lt;span class=&#34;string&#34;&gt;&amp;#x27;-c&amp;#x27;&lt;/span&gt;, &lt;span class=&#34;string&#34;&gt;&amp;quot;until nslookup my-service-1; do echo &amp;#x27;waiting for my-service-1&amp;#x27;; sleep 2; done;&amp;quot;&lt;/span&gt;]&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  &lt;span class=&#34;bullet&#34;&gt;-&lt;/span&gt; &lt;span class=&#34;attr&#34;&gt;name:&lt;/span&gt; &lt;span class=&#34;string&#34;&gt;init-myservice-2&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;attr&#34;&gt;image:&lt;/span&gt; &lt;span class=&#34;string&#34;&gt;busybox&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;attr&#34;&gt;command:&lt;/span&gt; [&lt;span class=&#34;string&#34;&gt;&amp;#x27;sh&amp;#x27;&lt;/span&gt;, &lt;span class=&#34;string&#34;&gt;&amp;#x27;-c&amp;#x27;&lt;/span&gt;, &lt;span class=&#34;string&#34;&gt;&amp;quot;until nslookup my-service-2; do echo &amp;#x27;waiting for my-service-2&amp;#x27;; sleep 2; done;&amp;quot;&lt;/span&gt;]&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;使用命令  &lt;code&gt;kubectl create -f 02-init-demo.yaml&lt;/code&gt;  创建  &lt;code&gt;pod&lt;/code&gt; .&lt;/p&gt;
&lt;p&gt;新开一个窗口使用  &lt;code&gt;kubectl get pods -w -o wide&lt;/code&gt;  命令 查看 pod 的启动变化.&lt;br&gt;
&lt;img data-src=&#34;/images/k8s/03-07.jpg&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;h6 id=&#34;查看查看-pod-中init-c-1的日志&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#查看查看-pod-中init-c-1的日志&#34;&gt;#&lt;/a&gt; 查看查看  &lt;code&gt;pod&lt;/code&gt;  中 &lt;code&gt;init-c-1&lt;/code&gt;  的日志&lt;/h6&gt;
&lt;p&gt;&lt;img data-src=&#34;/images/k8s/03-08.jpg&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;p&gt;发现  &lt;code&gt;initC-1&lt;/code&gt;  一直在  &lt;code&gt;nslookup&lt;/code&gt;  查找  &lt;code&gt;my-service-1&lt;/code&gt; .&lt;/p&gt;
&lt;h6 id=&#34;创建-service-1&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#创建-service-1&#34;&gt;#&lt;/a&gt; 创建  &lt;code&gt;Service-1&lt;/code&gt;&lt;/h6&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;02-init-demo-my-service-01.yaml&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;figure class=&#34;highlight yaml&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;attr&#34;&gt;apiVersion:&lt;/span&gt; &lt;span class=&#34;string&#34;&gt;v1&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;attr&#34;&gt;kind:&lt;/span&gt; &lt;span class=&#34;string&#34;&gt;Service&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;attr&#34;&gt;metadata:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  &lt;span class=&#34;attr&#34;&gt;name:&lt;/span&gt; &lt;span class=&#34;string&#34;&gt;my-service-1&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;attr&#34;&gt;spec:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  &lt;span class=&#34;attr&#34;&gt;ports:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;   &lt;span class=&#34;bullet&#34;&gt;-&lt;/span&gt; &lt;span class=&#34;attr&#34;&gt;protocol:&lt;/span&gt; &lt;span class=&#34;string&#34;&gt;TCP&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;     &lt;span class=&#34;attr&#34;&gt;port:&lt;/span&gt; &lt;span class=&#34;number&#34;&gt;80&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;     &lt;span class=&#34;attr&#34;&gt;targetPort:&lt;/span&gt; &lt;span class=&#34;number&#34;&gt;8080&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;使用命令  &lt;code&gt;kubectl create -f 02-init-demo-my-service-01.yaml&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;查看  &lt;code&gt;pod&lt;/code&gt;  中第一个  &lt;code&gt;InitC&lt;/code&gt;  的日志&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;/images/k8s/03-08.jpg&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;p&gt;会出现&lt;/p&gt;
&lt;figure class=&#34;highlight shell&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;Server:		10.96.0.10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Address:	10.96.0.10:53&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Name:	my-service-1.default.svc.cluster.local&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Address: 10.108.140.48&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;然后查看  &lt;code&gt;pod&lt;/code&gt;  的状态。会出现一条：&lt;/p&gt;
&lt;figure class=&#34;highlight shell&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;init-demo   0/1     Init:1/2   0          4m1s   10.244.154.204   k8s-node-01   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h6 id=&#34;创建-service-2&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#创建-service-2&#34;&gt;#&lt;/a&gt; 创建  &lt;code&gt;Service-2&lt;/code&gt;&lt;/h6&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;02-init-demo-my-service-02.yaml&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;figure class=&#34;highlight yaml&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;attr&#34;&gt;apiVersion:&lt;/span&gt; &lt;span class=&#34;string&#34;&gt;v1&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;attr&#34;&gt;kind:&lt;/span&gt; &lt;span class=&#34;string&#34;&gt;Service&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;attr&#34;&gt;metadata:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  &lt;span class=&#34;attr&#34;&gt;name:&lt;/span&gt; &lt;span class=&#34;string&#34;&gt;my-service-2&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;attr&#34;&gt;spec:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  &lt;span class=&#34;attr&#34;&gt;ports:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;   &lt;span class=&#34;bullet&#34;&gt;-&lt;/span&gt; &lt;span class=&#34;attr&#34;&gt;protocol:&lt;/span&gt; &lt;span class=&#34;string&#34;&gt;TCP&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;     &lt;span class=&#34;attr&#34;&gt;port:&lt;/span&gt; &lt;span class=&#34;number&#34;&gt;80&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;     &lt;span class=&#34;attr&#34;&gt;targetPort:&lt;/span&gt; &lt;span class=&#34;number&#34;&gt;8080&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;使用命令  &lt;code&gt;kubectl create -f 02-init-demo-my-service-01.yaml&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;查看  &lt;code&gt;pod&lt;/code&gt;  中第二个 &lt;code&gt;InitC&lt;/code&gt;  的日志直到出现&lt;/p&gt;
&lt;figure class=&#34;highlight shell&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;Server:		10.96.0.10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Address:	10.96.0.10:53&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Name:	my-service-2.default.svc.cluster.local&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Address: 10.107.13.223&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;然后查看  &lt;code&gt;pod&lt;/code&gt;  的状态。会出现一条：&lt;/p&gt;
&lt;figure class=&#34;highlight shell&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;init-demo   0/1     PodInitializing   0          6m52s   10.244.154.204   k8s-node-01   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;然后就会启动  &lt;code&gt;pod&lt;/code&gt;  . 最终出现&lt;/p&gt;
&lt;figure class=&#34;highlight shell&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;init-demo   1/1     Running           0          6m53s   10.244.154.204   k8s-node-01   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;然后查看  &lt;code&gt;pod&lt;/code&gt;  的日志，会输出  &lt;code&gt;the app is running.&lt;/code&gt;&lt;/p&gt;
&lt;figure class=&#34;highlight shell&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;[root@k8s-master-01 k8s-yamls]# kubectl logs -f init-demo&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Defaulted container &amp;quot;my-init-demo&amp;quot; out of: my-init-demo, init-myservice-1 (init), init-myservice-2 (init)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;the app is running!&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h4 id=&#34;关于init容器的特殊说明&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#关于init容器的特殊说明&#34;&gt;#&lt;/a&gt; 关于 init 容器的特殊说明&lt;/h4&gt;
&lt;ul&gt;
&lt;li&gt;在  &lt;code&gt;Pod&lt;/code&gt;  启动过程中，  &lt;code&gt;Init&lt;/code&gt;  容器会按顺序在网络和数据卷初始化之后启动。每个容器必须在下一个容器启动之前成功退出&lt;/li&gt;
&lt;li&gt;如果由于运行时或失败退出，将导致容器启动失败，它会根据  &lt;code&gt;Pod&lt;/code&gt;  的  &lt;code&gt;restartPolicy&lt;/code&gt;  指定的策略 进行重试。然而，如果  &lt;code&gt;Pod&lt;/code&gt;  的  &lt;code&gt;restartPolicy&lt;/code&gt;  设置为  &lt;code&gt;Always&lt;/code&gt; ， &lt;code&gt;Init&lt;/code&gt;  容器失败时会使用  &lt;code&gt;RestartPolicy&lt;/code&gt;  策略&lt;/li&gt;
&lt;li&gt;在所有的  &lt;code&gt;Init&lt;/code&gt;  容器没有成功之前， &lt;code&gt;Pod&lt;/code&gt;  将不会变成  &lt;code&gt;Ready&lt;/code&gt;  状态。 &lt;code&gt;Init&lt;/code&gt;  容器的端口将不会在  &lt;code&gt;Service&lt;/code&gt;  中进行聚集。 正在初始化中的  &lt;code&gt;Pod&lt;/code&gt;  处于  &lt;code&gt;Pending&lt;/code&gt;  状态，但应该会将  &lt;code&gt;Initializing&lt;/code&gt;  状态设置为  &lt;code&gt;true&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;如果  &lt;code&gt;Pod&lt;/code&gt;  重启，所有  &lt;code&gt;Init&lt;/code&gt;  容器必须重新执行&lt;/li&gt;
&lt;li&gt;对  &lt;code&gt;Init&lt;/code&gt;  容器  &lt;code&gt;spec&lt;/code&gt;  的修改被限制在容器  &lt;code&gt;image&lt;/code&gt;  字段，修改其他字段都不会生效。更改  &lt;code&gt;Init&lt;/code&gt;  容器的  &lt;code&gt;image&lt;/code&gt;  字段，等价于重启该  &lt;code&gt;Pod&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;Init&lt;/code&gt;  容器具有应用容器的所有字段。除了  &lt;code&gt;readinessProbe&lt;/code&gt;  ，因为  &lt;code&gt;Init&lt;/code&gt;  容器无法定义不同于完成 ( &lt;code&gt;completion&lt;/code&gt; ) 的就绪（ &lt;code&gt;readiness&lt;/code&gt; ）之外的其他状态。这会在验证过程中强制执行&lt;/li&gt;
&lt;li&gt;在  &lt;code&gt;Pod&lt;/code&gt;  中的每个  &lt;code&gt;app&lt;/code&gt;  和  &lt;code&gt;Init&lt;/code&gt;  容器的名称必须唯一；与任何其它容器共享同一个名称，会在验证时抛出错误.&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&#34;探针检测&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#探针检测&#34;&gt;#&lt;/a&gt; 探针检测&lt;/h2&gt;
&lt;p&gt;探针是由  &lt;code&gt;kubelet&lt;/code&gt;  对容器执行的定期诊断。要执行诊断， &lt;code&gt;kubelet&lt;/code&gt;  调用由容器实现的  &lt;code&gt;Handler&lt;/code&gt; 。有三种类型的处理程序：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;ExecAction&lt;/code&gt; ：在容器内执行指定命令。如果命令退出时返回码为  &lt;code&gt;0&lt;/code&gt;  则认为诊断成功。&lt;/li&gt;
&lt;li&gt;&lt;code&gt;TCPSocketAction&lt;/code&gt; ：对指定端口上的容器的  &lt;code&gt;IP&lt;/code&gt;  地址进行  &lt;code&gt;TCP&lt;/code&gt;  检查。如果端口打开，则诊断被认为是成功的。&lt;/li&gt;
&lt;li&gt;&lt;code&gt;HTTPGetAction&lt;/code&gt; ：对指定的端口和路径上的容器的  &lt;code&gt;IP&lt;/code&gt;  地址执行  &lt;code&gt;HTTP Get&lt;/code&gt;  请求。如果响应的状态码大于等于  &lt;code&gt;200&lt;/code&gt;  且小于  &lt;code&gt;400&lt;/code&gt; ，则诊断被认为是成功的&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;每次探测都将获得以下三种结果之一：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;成功：容器通过了诊断。&lt;/li&gt;
&lt;li&gt;失败：容器未通过诊断。&lt;/li&gt;
&lt;li&gt;未知：诊断失败，因此不会采取任何行动&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&#34;探测的方式&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#探测的方式&#34;&gt;#&lt;/a&gt; 探测的方式&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;livenessProbe&lt;/code&gt; ：指示容器是否正在运行。如果存活探测失败，则  &lt;code&gt;kubelet&lt;/code&gt;  会杀死容器，并且容器将受到其 重启策略 的影响。如果容器不提供存活探针，则默认状态为  &lt;code&gt;Success&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;readinessProbe&lt;/code&gt; ：指示容器是否准备好服务请求。如果就绪探测失败，端点控制器将从与  &lt;code&gt;Pod&lt;/code&gt;  匹配的所有  &lt;code&gt;Service&lt;/code&gt;  的端点中删除该  &lt;code&gt;Pod&lt;/code&gt;  的  &lt;code&gt;IP&lt;/code&gt;  地址。初始延迟之前的就绪状态默认为  &lt;code&gt;Failure&lt;/code&gt; 。如果容器不提供就绪探针，则默认状态为  &lt;code&gt;Success&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h4 id=&#34;pod-hook&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#pod-hook&#34;&gt;#&lt;/a&gt; Pod Hook&lt;/h4&gt;
&lt;p&gt;&lt;code&gt;Pod hook&lt;/code&gt; （钩子）是由  &lt;code&gt;Kubernetes&lt;/code&gt;  管理的  &lt;code&gt;kubelet&lt;/code&gt;  发起的，当容器中的进程启动前或者容器中的进程终止之前运行，这是包含在容器的生命周期之中。可以同时为  &lt;code&gt;Pod&lt;/code&gt;  中的所有容器都配置  &lt;code&gt;hook&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;&lt;code&gt;Hook&lt;/code&gt;  的类型包括两种：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;exec&lt;/code&gt; ：执行一段命令&lt;/li&gt;
&lt;li&gt;&lt;code&gt;HTTP&lt;/code&gt; ：发送 &lt;code&gt;HTTP&lt;/code&gt;  请求&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;code&gt;PodSpec&lt;/code&gt;  中有一个  &lt;code&gt;restartPolicy&lt;/code&gt;  字段，可能的值为  &lt;code&gt;Always&lt;/code&gt; 、 &lt;code&gt;OnFailure&lt;/code&gt;  和  &lt;code&gt;Never&lt;/code&gt; 。默认为 &lt;code&gt;Always&lt;/code&gt; 。  &lt;code&gt;restartPolicy&lt;/code&gt;  适用于  &lt;code&gt;Pod&lt;/code&gt;  中的所有容器。 &lt;code&gt;restartPolicy&lt;/code&gt;  仅指通过同一节点上的  &lt;code&gt;kubelet&lt;/code&gt;  重新启动容器。失败的容器由  &lt;code&gt;kubelet&lt;/code&gt;  以五分钟为上限的指数退避延迟（ &lt;code&gt;10秒&lt;/code&gt; ， &lt;code&gt;20秒&lt;/code&gt; ， &lt;code&gt;40秒&lt;/code&gt; …）重新启动，并在成功执行十分钟后重置。如  &lt;code&gt;Pod&lt;/code&gt;  文档 中所述，一旦绑定到一个节点， &lt;code&gt;Pod&lt;/code&gt;  将永远不会重新绑定到另一个节点。&lt;/p&gt;
&lt;h4 id=&#34;pod-phase&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#pod-phase&#34;&gt;#&lt;/a&gt; Pod phase&lt;/h4&gt;
&lt;p&gt;&lt;code&gt;Pod&lt;/code&gt;  的  &lt;code&gt;status&lt;/code&gt;  字段是一个  &lt;code&gt;PodStatus&lt;/code&gt;  对象， &lt;code&gt;PodStatus&lt;/code&gt;  中有一个  &lt;code&gt;phase&lt;/code&gt;  字段。&lt;br&gt;
 &lt;code&gt;PodStatus&lt;/code&gt;  的相位（ &lt;code&gt;phase&lt;/code&gt; ）是  &lt;code&gt;Pod&lt;/code&gt;  在其生命周期中的简单宏观概述。该阶段并不是对容器或  &lt;code&gt;Pod&lt;/code&gt;  的综合汇总，也不是为了做为综合状态机 &lt;code&gt;Pod&lt;/code&gt;  相位的数量和含义是严格指定的。除了本文档中列举的状态外，不应该再假定  &lt;code&gt;Pod&lt;/code&gt;  有其他的  &lt;code&gt;phase&lt;/code&gt;  值&lt;/p&gt;
&lt;h5 id=&#34;phase的值&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#phase的值&#34;&gt;#&lt;/a&gt; phase 的值&lt;/h5&gt;
&lt;ul&gt;
&lt;li&gt;挂起（ &lt;code&gt;Pending&lt;/code&gt; ）： &lt;code&gt;Pod&lt;/code&gt;  已被  &lt;code&gt;Kubernetes&lt;/code&gt;  系统接受，但有一个或者多个容器镜像尚未创建。等待时间包括调度  &lt;code&gt;Pod&lt;/code&gt;  的时间和通过网络下载镜像的时间，这可能需要花点时间&lt;/li&gt;
&lt;li&gt;运行中（ &lt;code&gt;Running&lt;/code&gt; ）：该  &lt;code&gt;Pod&lt;/code&gt;  已经绑定到了一个节点上， &lt;code&gt;Pod&lt;/code&gt;  中所有的容器都已被创建。至少有一个容器正在运行，或者正处于启动或重启状态&lt;/li&gt;
&lt;li&gt;成功（ &lt;code&gt;Succeeded&lt;/code&gt; ）： &lt;code&gt;Pod&lt;/code&gt;  中的所有容器都被成功终止，并且不会再重启&lt;/li&gt;
&lt;li&gt;失败（ &lt;code&gt;Failed&lt;/code&gt; ）： &lt;code&gt;Pod&lt;/code&gt;  中的所有容器都已终止了，并且至少有一个容器是因为失败终止。也就是说，容器以非  &lt;code&gt;0&lt;/code&gt;  状态退出或者被系统终止&lt;/li&gt;
&lt;li&gt;未知（ &lt;code&gt;Unknown&lt;/code&gt; ）：因为某些原因无法取得  &lt;code&gt;Pod&lt;/code&gt;  的状态，通常是因为与  &lt;code&gt;Pod&lt;/code&gt;  所在主机通信失败&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&#34;两个小实验&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#两个小实验&#34;&gt;#&lt;/a&gt; 两个小实验&lt;/h3&gt;
&lt;h4 id=&#34;readiness&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#readiness&#34;&gt;#&lt;/a&gt; Readiness&lt;/h4&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;03-readness-demo.yaml&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;figure class=&#34;highlight yaml&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;15&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;attr&#34;&gt;apiVersion:&lt;/span&gt; &lt;span class=&#34;string&#34;&gt;v1&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;attr&#34;&gt;kind:&lt;/span&gt; &lt;span class=&#34;string&#34;&gt;Pod&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;attr&#34;&gt;metadata:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  &lt;span class=&#34;attr&#34;&gt;name:&lt;/span&gt; &lt;span class=&#34;string&#34;&gt;readness-demo&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;attr&#34;&gt;spec:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  &lt;span class=&#34;attr&#34;&gt;containers:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  &lt;span class=&#34;bullet&#34;&gt;-&lt;/span&gt; &lt;span class=&#34;attr&#34;&gt;name:&lt;/span&gt; &lt;span class=&#34;string&#34;&gt;readness-demo-container&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;attr&#34;&gt;image:&lt;/span&gt; &lt;span class=&#34;string&#34;&gt;fangjiaxiaobai/my-app:v1&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;attr&#34;&gt;imagePullPolicy:&lt;/span&gt; &lt;span class=&#34;string&#34;&gt;IfNotPresent&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;attr&#34;&gt;readinessProbe:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;      &lt;span class=&#34;attr&#34;&gt;httpGet:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;attr&#34;&gt;port:&lt;/span&gt; &lt;span class=&#34;number&#34;&gt;80&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;attr&#34;&gt;path:&lt;/span&gt; &lt;span class=&#34;string&#34;&gt;/index.html&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;      &lt;span class=&#34;attr&#34;&gt;initialDelaySeconds:&lt;/span&gt; &lt;span class=&#34;number&#34;&gt;1&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;      &lt;span class=&#34;attr&#34;&gt;periodSeconds:&lt;/span&gt; &lt;span class=&#34;number&#34;&gt;3&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;&lt;img data-src=&#34;/images/k8s/03-09.jpg&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;p&gt;可以看到  &lt;code&gt;readness-demo&lt;/code&gt;  正常启动成功，也已经 &lt;code&gt;ready&lt;/code&gt;  了。&lt;/p&gt;
&lt;p&gt;下面删掉  &lt;code&gt;readness-demo&lt;/code&gt;  这个 &lt;code&gt;pod&lt;/code&gt;  , 然后把  &lt;code&gt;path:/index.html&lt;/code&gt;  改成  &lt;code&gt;path:/index1.html&lt;/code&gt;  如下:&lt;/p&gt;
&lt;figure class=&#34;highlight yaml&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;15&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;attr&#34;&gt;apiVersion:&lt;/span&gt; &lt;span class=&#34;string&#34;&gt;v1&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;attr&#34;&gt;kind:&lt;/span&gt; &lt;span class=&#34;string&#34;&gt;Pod&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;attr&#34;&gt;metadata:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  &lt;span class=&#34;attr&#34;&gt;name:&lt;/span&gt; &lt;span class=&#34;string&#34;&gt;readness-demo&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;attr&#34;&gt;spec:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  &lt;span class=&#34;attr&#34;&gt;containers:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  &lt;span class=&#34;bullet&#34;&gt;-&lt;/span&gt; &lt;span class=&#34;attr&#34;&gt;name:&lt;/span&gt; &lt;span class=&#34;string&#34;&gt;readness-demo-container&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;attr&#34;&gt;image:&lt;/span&gt; &lt;span class=&#34;string&#34;&gt;fangjiaxiaobai/my-app:v1&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;attr&#34;&gt;imagePullPolicy:&lt;/span&gt; &lt;span class=&#34;string&#34;&gt;IfNotPresent&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;attr&#34;&gt;readinessProbe:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;      &lt;span class=&#34;attr&#34;&gt;httpGet:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;attr&#34;&gt;port:&lt;/span&gt; &lt;span class=&#34;number&#34;&gt;80&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;attr&#34;&gt;path:&lt;/span&gt; &lt;span class=&#34;string&#34;&gt;/index1.html&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;      &lt;span class=&#34;attr&#34;&gt;initialDelaySeconds:&lt;/span&gt; &lt;span class=&#34;number&#34;&gt;1&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;      &lt;span class=&#34;attr&#34;&gt;periodSeconds:&lt;/span&gt; &lt;span class=&#34;number&#34;&gt;3&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;&lt;img data-src=&#34;/images/k8s/03-10.png&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;p&gt;可以看到  &lt;code&gt;ready: 0/1&lt;/code&gt;  , 我们可以查看一下  &lt;code&gt;pod&lt;/code&gt;  的详细信息.&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;/images/k8s/03-11.png&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;p&gt;&lt;code&gt;Readiness Failed&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;这时，我们进入容器中，新建一个  &lt;code&gt;index1.html&lt;/code&gt;  页面.&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;/images/k8s/03-12.png&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;p&gt;然后查看一下  &lt;code&gt;pod&lt;/code&gt;  的状态。&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;/images/k8s/03-13.png&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;h4 id=&#34;liveness&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#liveness&#34;&gt;#&lt;/a&gt; Liveness&lt;/h4&gt;
&lt;h5 id=&#34;liveness-exec-demo&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#liveness-exec-demo&#34;&gt;#&lt;/a&gt; liveness-exec demo&lt;/h5&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;04-liveness-demo-exec.yaml&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;figure class=&#34;highlight yaml&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;attr&#34;&gt;apiVersion:&lt;/span&gt; &lt;span class=&#34;string&#34;&gt;v1&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;attr&#34;&gt;kind:&lt;/span&gt; &lt;span class=&#34;string&#34;&gt;Pod&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;attr&#34;&gt;metadata:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  &lt;span class=&#34;attr&#34;&gt;name:&lt;/span&gt; &lt;span class=&#34;string&#34;&gt;liveness-demo&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  &lt;span class=&#34;attr&#34;&gt;namespace:&lt;/span&gt; &lt;span class=&#34;string&#34;&gt;default&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;attr&#34;&gt;spec:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  &lt;span class=&#34;attr&#34;&gt;containers:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  &lt;span class=&#34;bullet&#34;&gt;-&lt;/span&gt; &lt;span class=&#34;attr&#34;&gt;name:&lt;/span&gt; &lt;span class=&#34;string&#34;&gt;liveness-demo-container&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;attr&#34;&gt;image:&lt;/span&gt; &lt;span class=&#34;string&#34;&gt;fangjiaxiaobai/my-app:v1&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;attr&#34;&gt;imagePullPolicy:&lt;/span&gt; &lt;span class=&#34;string&#34;&gt;IfNotPresent&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;attr&#34;&gt;command:&lt;/span&gt; [&lt;span class=&#34;string&#34;&gt;&amp;#x27;/bin/sh&amp;#x27;&lt;/span&gt;, &lt;span class=&#34;string&#34;&gt;&amp;#x27;-c&amp;#x27;&lt;/span&gt;, &lt;span class=&#34;string&#34;&gt;&amp;#x27;touch /tmp/live; sleep 20; rm -rf /tmp/live; sleep 3600;&amp;#x27;&lt;/span&gt;]&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;attr&#34;&gt;livenessProbe:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;      &lt;span class=&#34;attr&#34;&gt;exec:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;attr&#34;&gt;command:&lt;/span&gt; [&lt;span class=&#34;string&#34;&gt;&amp;#x27;test&amp;#x27;&lt;/span&gt;, &lt;span class=&#34;string&#34;&gt;&amp;#x27;-e&amp;#x27;&lt;/span&gt;, &lt;span class=&#34;string&#34;&gt;&amp;#x27;/tmp/live&amp;#x27;&lt;/span&gt;]&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;      &lt;span class=&#34;attr&#34;&gt;initialDelaySeconds:&lt;/span&gt; &lt;span class=&#34;number&#34;&gt;1&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;      &lt;span class=&#34;attr&#34;&gt;periodSeconds:&lt;/span&gt; &lt;span class=&#34;number&#34;&gt;1&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;然后查看 &lt;code&gt;pod&lt;/code&gt;  的状态&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;/images/k8s/03-14.png&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;h5 id=&#34;liveness-http-get-demo&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#liveness-http-get-demo&#34;&gt;#&lt;/a&gt; liveness-http-get demo&lt;/h5&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;04-liveness-httpGet-demo.yaml&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;figure class=&#34;highlight yaml&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;20&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;attr&#34;&gt;apiVersion:&lt;/span&gt; &lt;span class=&#34;string&#34;&gt;v1&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;attr&#34;&gt;kind:&lt;/span&gt; &lt;span class=&#34;string&#34;&gt;Pod&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;attr&#34;&gt;metadata:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  &lt;span class=&#34;attr&#34;&gt;name:&lt;/span&gt; &lt;span class=&#34;string&#34;&gt;liveness-http-get-demo&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  &lt;span class=&#34;attr&#34;&gt;namespace:&lt;/span&gt; &lt;span class=&#34;string&#34;&gt;default&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;attr&#34;&gt;spec:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  &lt;span class=&#34;attr&#34;&gt;containers:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  &lt;span class=&#34;bullet&#34;&gt;-&lt;/span&gt; &lt;span class=&#34;attr&#34;&gt;name:&lt;/span&gt; &lt;span class=&#34;string&#34;&gt;liveness-http-get-container&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;attr&#34;&gt;image:&lt;/span&gt; &lt;span class=&#34;string&#34;&gt;fangjiaxiaobai/my-app:v1&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;attr&#34;&gt;imagePullPolicy:&lt;/span&gt; &lt;span class=&#34;string&#34;&gt;IfNotPresent&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;attr&#34;&gt;ports:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;bullet&#34;&gt;-&lt;/span&gt; &lt;span class=&#34;attr&#34;&gt;name:&lt;/span&gt; &lt;span class=&#34;string&#34;&gt;http-port&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;      &lt;span class=&#34;attr&#34;&gt;containerPort:&lt;/span&gt; &lt;span class=&#34;number&#34;&gt;80&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;attr&#34;&gt;livenessProbe:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;      &lt;span class=&#34;attr&#34;&gt;httpGet:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;attr&#34;&gt;port:&lt;/span&gt; &lt;span class=&#34;string&#34;&gt;http-port&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;attr&#34;&gt;path:&lt;/span&gt; &lt;span class=&#34;string&#34;&gt;/index.html&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;      &lt;span class=&#34;attr&#34;&gt;initialDelaySeconds:&lt;/span&gt; &lt;span class=&#34;number&#34;&gt;1&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;      &lt;span class=&#34;attr&#34;&gt;periodSeconds:&lt;/span&gt; &lt;span class=&#34;number&#34;&gt;1&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;      &lt;span class=&#34;attr&#34;&gt;timeoutSeconds:&lt;/span&gt; &lt;span class=&#34;number&#34;&gt;10&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;&lt;img data-src=&#34;/images/k8s/03-15.png&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;p&gt;然后，我们删除 &lt;code&gt;index.html&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;&lt;code&gt;kubectl exec liveness-http-get-demo -it -- rm -rf /usr/share/nginx/html/index.html&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;可以发现 pod 进行了重启。如下图 (我删除了两次)&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;/images/k8s/03-16.png&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;h3 id=&#34;启动和停止&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#启动和停止&#34;&gt;#&lt;/a&gt; 启动和停止&lt;/h3&gt;
&lt;p&gt;&lt;img data-src=&#34;/images/k8s/03-05.png&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;p&gt;在 pod 的生命周期中，我们讲完了  &lt;code&gt;pause&lt;/code&gt; ,  &lt;code&gt;initC&lt;/code&gt; ,  &lt;code&gt;liveness&lt;/code&gt; ,  &lt;code&gt;readiness&lt;/code&gt; . 还剩下  &lt;code&gt;Starter&lt;/code&gt;  和  &lt;code&gt;Stop&lt;/code&gt; .&lt;/p&gt;
&lt;p&gt;这个也比较简单，我通过下面这个实验来演示一下 pod 的启动和停止。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;05-start-and-stop-demo.yaml&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;figure class=&#34;highlight yaml&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;attr&#34;&gt;apiVersion:&lt;/span&gt; &lt;span class=&#34;string&#34;&gt;v1&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;attr&#34;&gt;kind:&lt;/span&gt; &lt;span class=&#34;string&#34;&gt;Pod&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;attr&#34;&gt;metadata:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  &lt;span class=&#34;attr&#34;&gt;name:&lt;/span&gt; &lt;span class=&#34;string&#34;&gt;starter-stop-demo&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  &lt;span class=&#34;attr&#34;&gt;namespace:&lt;/span&gt; &lt;span class=&#34;string&#34;&gt;default&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;attr&#34;&gt;spec:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  &lt;span class=&#34;attr&#34;&gt;containers:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  &lt;span class=&#34;bullet&#34;&gt;-&lt;/span&gt; &lt;span class=&#34;attr&#34;&gt;name:&lt;/span&gt; &lt;span class=&#34;string&#34;&gt;stop-stop-demo-container&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;attr&#34;&gt;image:&lt;/span&gt; &lt;span class=&#34;string&#34;&gt;fangjiaxiaobai/my-app:v1&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;attr&#34;&gt;lifecycle:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;      &lt;span class=&#34;attr&#34;&gt;postStart:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;attr&#34;&gt;exec:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;          &lt;span class=&#34;attr&#34;&gt;command:&lt;/span&gt; [&lt;span class=&#34;string&#34;&gt;&amp;#x27;/bin/sh&amp;#x27;&lt;/span&gt;, &lt;span class=&#34;string&#34;&gt;&amp;#x27;-c&amp;#x27;&lt;/span&gt;, &lt;span class=&#34;string&#34;&gt;&amp;#x27;echo Hello from podStart handler &amp;gt; /usr/share/message&amp;#x27;&lt;/span&gt;]&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;      &lt;span class=&#34;attr&#34;&gt;preStop:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;attr&#34;&gt;exec:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;          &lt;span class=&#34;attr&#34;&gt;command:&lt;/span&gt; [&lt;span class=&#34;string&#34;&gt;&amp;#x27;/bin/sh&amp;#x27;&lt;/span&gt;, &lt;span class=&#34;string&#34;&gt;&amp;#x27;-c&amp;#x27;&lt;/span&gt;, &lt;span class=&#34;string&#34;&gt;&amp;#x27;echo Bye from podStop handler&amp;#x27;&lt;/span&gt;]&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;然后查看一下  &lt;code&gt;/usr/share/message&lt;/code&gt;  文件内容&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;/images/k8s/03-17.png&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;p&gt;当然，删除之后，这个容器我们就进不去了，但是我们知道了通过这种方式可以在  &lt;code&gt;pod&lt;/code&gt;  的生命周期的各个阶段中做些操作。&lt;/p&gt;
</content>
        <category term="k8s" />
        <category term="kubernetes" />
        <updated>2022-07-31T10:18:00.000Z</updated>
    </entry>
    <entry>
        <id>https://fangjiaxiaobai.github.io/2022/07/22/k8s/pit01.incompatible-CNI-versions/</id>
        <title>k8s-incompatible CNI versions</title>
        <link rel="alternate" href="https://fangjiaxiaobai.github.io/2022/07/22/k8s/pit01.incompatible-CNI-versions/"/>
        <content type="html">&lt;h3 id=&#34;报错内容&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#报错内容&#34;&gt;#&lt;/a&gt; 报错内容&lt;/h3&gt;
&lt;figure class=&#34;highlight sh&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;Warning  FailedCreatePodSandBox  5m17s kubelet Failed to create pod sandbox: rpc error: code = Unknown desc = failed to setup network &lt;span class=&#34;keyword&#34;&gt;for&lt;/span&gt; sandbox &lt;span class=&#34;string&#34;&gt;&amp;quot;1ded5da71b38996763e74f28f609d8d8f26a4cc1e4fdd3272312bf3e168e4111&amp;quot;&lt;/span&gt;: plugin &lt;span class=&#34;built_in&#34;&gt;type&lt;/span&gt;=&lt;span class=&#34;string&#34;&gt;&amp;quot;bridge&amp;quot;&lt;/span&gt; failed (add): incompatible CNI versions; config is &lt;span class=&#34;string&#34;&gt;&amp;quot;1.0.0&amp;quot;&lt;/span&gt;, plugin supports [&lt;span class=&#34;string&#34;&gt;&amp;quot;0.1.0&amp;quot;&lt;/span&gt; &lt;span class=&#34;string&#34;&gt;&amp;quot;0.2.0&amp;quot;&lt;/span&gt; &lt;span class=&#34;string&#34;&gt;&amp;quot;0.3.0&amp;quot;&lt;/span&gt; &lt;span class=&#34;string&#34;&gt;&amp;quot;0.3.1&amp;quot;&lt;/span&gt; &lt;span class=&#34;string&#34;&gt;&amp;quot;0.4.0&amp;quot;&lt;/span&gt;]&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h3 id=&#34;部署的环境&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#部署的环境&#34;&gt;#&lt;/a&gt; 部署的环境&lt;/h3&gt;
&lt;figure class=&#34;highlight sh&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;centos 8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;kubernetes 1.24.3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h3 id=&#34;解决问题&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#解决问题&#34;&gt;#&lt;/a&gt; 解决问题&lt;/h3&gt;
&lt;p&gt;这个问题的主要内容是:  &lt;code&gt;incompatible CNI versions&lt;/code&gt; . 当你去网上去搜索解决方案大都是 说 使用  &lt;code&gt;containerd&lt;/code&gt;  的版本不对，也就是说，确实是  &lt;code&gt;CNI&lt;/code&gt;  的版本是有问题的。&lt;/p&gt;
&lt;p&gt;具体的解决方案在官方网站中是这样说的：&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://fangjiaxiaobai.github.io/images/k8s/01-01.png&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;p&gt;具体内容可以看这里:&lt;span class=&#34;exturl&#34; data-url=&#34;aHR0cHM6Ly9rdWJlcm5ldGVzLmlvL3poLWNuL2RvY3MvdGFza3MvYWRtaW5pc3Rlci1jbHVzdGVyL21pZ3JhdGluZy1mcm9tLWRvY2tlcnNoaW0vdHJvdWJsZXNob290aW5nLWNuaS1wbHVnaW4tcmVsYXRlZC1lcnJvcnMvI3VwZGF0aW5nLXlvdXItY25pLXBsdWdpbnMtYW5kLWNuaS1jb25maWctZmlsZXM=&#34;&gt;https://kubernetes.io/zh-cn/docs/tasks/administer-cluster/migrating-from-dockershim/troubleshooting-cni-plugin-related-errors/#updating-your-cni-plugins-and-cni-config-files&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;首先可以查看 当前的  &lt;code&gt;containerd&lt;/code&gt;  的版本.&lt;/p&gt;
&lt;figure class=&#34;highlight sh&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;[root@k8s-master-01 ~]&lt;span class=&#34;comment&#34;&gt;# containerd -v&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;containerd github.com/containerd/containerd v1.6.4 212e8b6fa2f44b9c21b2798135fc6fb7c53efc16&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;不在  &lt;code&gt;v1.6.0-v1.6.3&lt;/code&gt;  中。 文档中说 在  &lt;code&gt;v1.6.4&lt;/code&gt;  版本中已经修复了这个问题.&lt;/p&gt;
&lt;p&gt;查看  &lt;code&gt;/etc/cni/net.d/10-containerd-net.conflist&lt;/code&gt;  这个文件， cni 版本  &lt;code&gt; &amp;quot;cniVersion&amp;quot;: &amp;quot;1.0.0&amp;quot;,&lt;/code&gt; , 也确实是 &lt;code&gt;1.0.0&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;继续搜索&lt;/p&gt;
&lt;p&gt;在 &lt;span class=&#34;exturl&#34; data-url=&#34;aHR0cHM6Ly9naXRodWIuY29tL2NvbnRhaW5lcmQvY29udGFpbmVyZC9pc3N1ZXMvNjg3Ng==&#34;&gt;https://github.com/containerd/containerd/issues/6876&lt;/span&gt; 中，有一个人遇到了  &lt;code&gt;v1.6.4&lt;/code&gt;  版本中出现了  &lt;code&gt;incompatible CNI versions&lt;/code&gt;  这个问题。&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://fangjiaxiaobai.github.io/images/k8s/01-02.jpg&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;p&gt;仔细看他的这个问题，是我遇到的这个问题是一样的  &lt;code&gt;plugins type=&#39;bridge&#39;&lt;/code&gt; . 而这个  &lt;code&gt;issure&lt;/code&gt;  中提到的问题，是当  &lt;code&gt;plugins type = &#39;loooback&#39;&lt;/code&gt; . 这也是上图中  &lt;code&gt;hakman&lt;/code&gt;  提到的。&lt;/p&gt;
&lt;p&gt;仔细看  &lt;code&gt;mikebrow&lt;/code&gt;  所说的，需要安装一个  &lt;code&gt;1.0.0&lt;/code&gt;  版本的  &lt;code&gt;bridge&lt;/code&gt; .&lt;/p&gt;
&lt;p&gt;那就在网络中搜索 :  &lt;code&gt;k8s 是安装 bridge&lt;/code&gt; ， 在  &lt;code&gt;https://blog.csdn.net/m0_48594855/article/details/107870839&lt;/code&gt;  看到 安装 bridge 的方法，他这里是使用 git 仓库 源码编译。其实直接打开 git 仓库  &lt;code&gt;https://github.com/containernetworking/plugins/releases/tag/v1.1.1&lt;/code&gt;  下载对应版本即可， 今天是  &lt;code&gt;2022&lt;/code&gt;  年 &lt;code&gt;7&lt;/code&gt;  月 &lt;code&gt;22&lt;/code&gt;  日，我就下载了最新的一版本。&lt;/p&gt;
&lt;p&gt;简单粗暴的  &lt;code&gt;/opt/cni/bin/&lt;/code&gt;  下的内容，全部替换掉，然后重启  &lt;code&gt;kubelet&lt;/code&gt;  服务就可以了。&lt;/p&gt;
&lt;figure class=&#34;highlight sh&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;comment&#34;&gt;# 下载包&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;wget https://github.com/containernetworking/plugins/releases/download/v1.1.1/cni-plugins-linux-amd64-v1.1.1.tgz&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;comment&#34;&gt;# 备份一下驱动&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;mv /opt/cni/bin /opt/cni/bin.bak&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;comment&#34;&gt;# 解压到指定目录&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;tar -zxvf cni-plugins-linux-amd64-v1.1.1.tgz -C /opt/cni/bin &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;comment&#34;&gt;# 重启 kubelet&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;systemctl restart kubelet&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;然后再所有的节点上都执行一遍上面的内容，然后就可以了。&lt;/p&gt;
&lt;p&gt;可以通过   &lt;code&gt;kubectl describe pod&lt;/code&gt;  查看下是否开始下载镜像了。&lt;/p&gt;
&lt;h3 id=&#34;问题解决思路&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#问题解决思路&#34;&gt;#&lt;/a&gt; 问题解决思路&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;先看下  &lt;code&gt;contrainerd&lt;/code&gt;  版本是否  &lt;code&gt;&amp;gt;=1.6.4&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;如果  &lt;code&gt;&amp;lt;=1.6.3&lt;/code&gt;  那么就需要升级  &lt;code&gt;contrainerd&lt;/code&gt;  运行环境.&lt;/li&gt;
&lt;li&gt;如果还有这样的问题，那就是要看下对应的插件类型是否满足版本要求了。&lt;/li&gt;
&lt;li&gt;如果不满足，那就重新安装下对应的插件就行了，比如我的问题中的  &lt;code&gt;bridge&lt;/code&gt;  插件。&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&#34;举一反三&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#举一反三&#34;&gt;#&lt;/a&gt; 举一反三&lt;/h3&gt;
&lt;p&gt;假设有一棵树，那个问题只是这棵树的一片叶子， 这里面还涉及到很多  &lt;code&gt;k8s&lt;/code&gt;  的概念性的东西。比如  &lt;code&gt;CNI&lt;/code&gt;  网络插件都有什么，每种插件的功能是什么，以及对应的网络驱动是什么，比如  &lt;code&gt;Calico&lt;/code&gt;  ,  &lt;code&gt;fannel&lt;/code&gt;  ,  &lt;code&gt;bridge&lt;/code&gt;  。  &lt;code&gt;CNI&lt;/code&gt;  和  &lt;code&gt;containerd&lt;/code&gt; ,  &lt;code&gt;cri-o&lt;/code&gt;  都是什么关系。所以，要从根儿上去理解这些概念。 废话不多说，下篇文章见。&lt;/p&gt;
&lt;h3 id=&#34;参考文档&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#参考文档&#34;&gt;#&lt;/a&gt; 参考文档&lt;/h3&gt;
&lt;p&gt;1、&lt;span class=&#34;exturl&#34; data-url=&#34;aHR0cHM6Ly9naXRodWIuY29tL2NvbnRhaW5lcmQvY29udGFpbmVyZC9pc3N1ZXMvNjg3Ng==&#34;&gt;https://github.com/containerd/containerd/issues/6876&lt;/span&gt;&lt;br&gt;
2、&lt;span class=&#34;exturl&#34; data-url=&#34;aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L20wXzQ4NTk0ODU1L2FydGljbGUvZGV0YWlscy8xMDc4NzA4Mzk=&#34;&gt;https://blog.csdn.net/m0_48594855/article/details/107870839&lt;/span&gt;&lt;br&gt;
3、&lt;span class=&#34;exturl&#34; data-url=&#34;aHR0cHM6Ly9naXRodWIuY29tL2NvbnRhaW5lcm5ldHdvcmtpbmcvcGx1Z2lucy9yZWxlYXNlcy90YWcvdjEuMS4x&#34;&gt;https://github.com/containernetworking/plugins/releases/tag/v1.1.1&lt;/span&gt;&lt;br&gt;
4、&lt;span class=&#34;exturl&#34; data-url=&#34;aHR0cHM6Ly9rdWJlcm5ldGVzLmlvL3poLWNuL2RvY3MvdGFza3MvYWRtaW5pc3Rlci1jbHVzdGVyL21pZ3JhdGluZy1mcm9tLWRvY2tlcnNoaW0vdHJvdWJsZXNob290aW5nLWNuaS1wbHVnaW4tcmVsYXRlZC1lcnJvcnMvI3VwZGF0aW5nLXlvdXItY25pLXBsdWdpbnMtYW5kLWNuaS1jb25maWctZmlsZXM=&#34;&gt;https://kubernetes.io/zh-cn/docs/tasks/administer-cluster/migrating-from-dockershim/troubleshooting-cni-plugin-related-errors/#updating-your-cni-plugins-and-cni-config-files&lt;/span&gt;&lt;/p&gt;
</content>
        <category term="k8s" />
        <category term="kubernetes" />
        <updated>2022-07-22T10:18:00.000Z</updated>
    </entry>
    <entry>
        <id>https://fangjiaxiaobai.github.io/2022/07/17/k8s/seris02-how-to-build/</id>
        <title>k8s-搭建K8s集群</title>
        <link rel="alternate" href="https://fangjiaxiaobai.github.io/2022/07/17/k8s/seris02-how-to-build/"/>
        <content type="html">&lt;p&gt;使用  &lt;code&gt;kubeadm 1.24.3&lt;/code&gt;  搭建  &lt;code&gt;k8s&lt;/code&gt;  集群&lt;/p&gt;
&lt;h2 id=&#34;环境准备&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#环境准备&#34;&gt;#&lt;/a&gt; 环境准备&lt;/h2&gt;
&lt;p&gt;&lt;code&gt;Centos8&lt;/code&gt;  三台.&lt;/p&gt;
&lt;figure class=&#34;highlight sh&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;k8s-master-01 192.168.0.10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;k8s-node-01   192.168.0.20&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;k8s-node-02   192.168.0.21&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;注意，这三台机器不要做任何配置，尤其不要安装  &lt;code&gt;docker&lt;/code&gt; , 因为从 &lt;code&gt;k8s&lt;/code&gt;   &lt;code&gt;1.20.x&lt;/code&gt;  开始，  &lt;code&gt;kubernetes&lt;/code&gt;  弃用了  &lt;code&gt;dockershim&lt;/code&gt; , 在  &lt;code&gt;1.20.4&lt;/code&gt;  正式移除了  &lt;code&gt;dockershim&lt;/code&gt; .&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;Docker support in the kubelet is now deprecated and will be removed in a future release. The kubelet uses a module called “dockershim” which implements CRI support for Docker and it has seen maintenance issues in the Kubernetes community.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;原文地址: &lt;span class=&#34;exturl&#34; data-url=&#34;aHR0cHM6Ly9naXRodWIuY29tL2t1YmVybmV0ZXMva3ViZXJuZXRlcy9ibG9iL21hc3Rlci9DSEFOR0VMT0cvQ0hBTkdFTE9HLTEuMjAubWQjZGVwcmVjYXRpb24=&#34;&gt;kubernetes 1.20 变更日志&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;但是  &lt;code&gt;kubernetes&lt;/code&gt;  是支持符合为  &lt;code&gt;Kubernetes&lt;/code&gt;  创建的容器运行接口  &lt;code&gt;Container Runtime Interface (CRI)&lt;/code&gt;  的运行时。  &lt;code&gt;Docker&lt;/code&gt;  构建的镜像，将在你的集群的所有运行时中继续工作，一如既往。&lt;/p&gt;
&lt;h3 id=&#34;设置系统主机名以及host文件的相互解析&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#设置系统主机名以及host文件的相互解析&#34;&gt;#&lt;/a&gt; 设置系统主机名以及 host 文件的相互解析&lt;/h3&gt;
&lt;figure class=&#34;highlight sh&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;hostnamectl set-hostname k8s-master-01&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h3 id=&#34;安装依赖包&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#安装依赖包&#34;&gt;#&lt;/a&gt; 安装依赖包&lt;/h3&gt;
&lt;figure class=&#34;highlight sh&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;yum install -y conntrack ipvsadm ipset jq iptables curl sysstat libseccomp wget vim net-tools git&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;yum install -y chony &lt;span class=&#34;comment&#34;&gt;# 配置时间同步&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h3 id=&#34;关闭防火墙&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#关闭防火墙&#34;&gt;#&lt;/a&gt; 关闭防火墙&lt;/h3&gt;
&lt;figure class=&#34;highlight sh&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;systemctl stop firewalld &amp;amp;&amp;amp; systemctl &lt;span class=&#34;built_in&#34;&gt;disable&lt;/span&gt; firewalld&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h3 id=&#34;关闭selinux&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#关闭selinux&#34;&gt;#&lt;/a&gt; 关闭 &lt;code&gt;SELinux&lt;/code&gt;&lt;/h3&gt;
&lt;figure class=&#34;highlight sh&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;swapoff -a &amp;amp;&amp;amp; sed -i &lt;span class=&#34;string&#34;&gt;&amp;#x27;/ swap / s/^\(.*\)$/#\1/g&amp;#x27;&lt;/span&gt; /etc/fstab&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;setenforce 0 &amp;amp;&amp;amp; sed -i &lt;span class=&#34;string&#34;&gt;&amp;#x27;s/^SELINUX=.*/SELINUX=disabled/&amp;#x27;&lt;/span&gt; /etc/selinux/config&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h3 id=&#34;调整内核参数&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#调整内核参数&#34;&gt;#&lt;/a&gt; 调整内核参数&lt;/h3&gt;
&lt;figure class=&#34;highlight sh&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;25&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;cat &amp;gt; kubernetes.conf &amp;lt;&amp;lt;&lt;span class=&#34;string&#34;&gt;EOF&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;string&#34;&gt;net.bridge.bridge-nf-call-iptables=1&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;string&#34;&gt;net.bridge.bridge-nf-call-ip6tables=1&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;string&#34;&gt;net.ipv4.ip_forward=1&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;string&#34;&gt;net.ipv4.tcp_tw_recycle=0&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;string&#34;&gt;vm.swappiness=0 # 禁止使用 swap 空间，只有当系统 OOM 时才允许使用它&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;string&#34;&gt;vm.overcommit&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;string&#34;&gt;_&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;string&#34;&gt;memory=1 # 不检查物理内存是否够用&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;string&#34;&gt;vm.panic_on_oom=0 # 开启 OOM&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;string&#34;&gt;fs.inotify.max_user_instances=8192&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;string&#34;&gt;fs.inotify.max_user_watches=1048576&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;string&#34;&gt;fs.file-max=52706963&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;string&#34;&gt;fs.nr&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;string&#34;&gt;_&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;string&#34;&gt;open=52706963&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;string&#34;&gt;net.ipv6.conf.all.disable_ipv6=1&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;string&#34;&gt;net.netfilter.nf&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;string&#34;&gt;_&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;string&#34;&gt;conntrack&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;string&#34;&gt;_&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;string&#34;&gt;max=2310720&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;string&#34;&gt;EOF&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;cp kubernetes.conf /etc/sysctl.d/kubernetes.conf&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;sysctl -p /etc/sysctl.d/kubernetes.conf&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h3 id=&#34;调整系统时区&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#调整系统时区&#34;&gt;#&lt;/a&gt; 调整系统时区&lt;/h3&gt;
&lt;figure class=&#34;highlight sh&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;comment&#34;&gt;# 设置系统时区为 中国/上海&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;timedatectl set-timezone Asia/Shanghai&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;comment&#34;&gt;# 将当前的 UTC 时间写入硬件时钟&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;timedatectl set-local-rtc 0&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;comment&#34;&gt;# 重启依赖于系统时间的服务&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;systemctl restart rsyslog&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;systemctl restart crond&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h3 id=&#34;关闭系统不需要服务&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#关闭系统不需要服务&#34;&gt;#&lt;/a&gt; 关闭系统不需要服务&lt;/h3&gt;
&lt;figure class=&#34;highlight sh&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;systemctl stop postfix &amp;amp;&amp;amp; systemctl &lt;span class=&#34;built_in&#34;&gt;disable&lt;/span&gt; postfix&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h3 id=&#34;设置-rsyslogd-和-systemd-journald&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#设置-rsyslogd-和-systemd-journald&#34;&gt;#&lt;/a&gt; 设置 rsyslogd 和 systemd journald&lt;/h3&gt;
&lt;figure class=&#34;highlight sh&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;21&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;mkdir /var/&lt;span class=&#34;built_in&#34;&gt;log&lt;/span&gt;/journal &lt;span class=&#34;comment&#34;&gt;# 持久化保存日志的目录&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;mkdir /etc/systemd/journald.conf.d&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;cat &amp;gt; /etc/systemd/journald.conf.d/99-prophet.conf &amp;lt;&amp;lt;&lt;span class=&#34;string&#34;&gt;EOF&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;string&#34;&gt;[Journal]&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;string&#34;&gt;# 持久化保存到磁盘&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;string&#34;&gt;Storage=persistent&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;string&#34;&gt;# 压缩历史日志&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;string&#34;&gt;Compress=yes&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;string&#34;&gt;SyncIntervalSec=5m&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;string&#34;&gt;RateLimitInterval=30s&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;string&#34;&gt;RateLimitBurst=1000&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;string&#34;&gt;# 最大占用空间 10G&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;string&#34;&gt;SystemMaxUse=10G&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;string&#34;&gt;# 单日志文件最大 200M&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;string&#34;&gt;SystemMaxFileSize=200M&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;string&#34;&gt;# 日志保存时间 2 周&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;string&#34;&gt;MaxRetentionSec=2week&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;string&#34;&gt;# 不将日志转发到 syslog&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;string&#34;&gt;ForwardToSyslog=no&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;string&#34;&gt;EOF&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;systemctl restart systemd-journald&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h3 id=&#34;安装-containerd&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#安装-containerd&#34;&gt;#&lt;/a&gt; 安装  &lt;code&gt;containerd&lt;/code&gt;&lt;/h3&gt;
&lt;h4 id=&#34;创建etcmodules-loaddcontainerdconf配置文件&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#创建etcmodules-loaddcontainerdconf配置文件&#34;&gt;#&lt;/a&gt; 创建 &lt;code&gt;/etc/modules-load.d/containerd.conf&lt;/code&gt;  配置文件:&lt;/h4&gt;
&lt;figure class=&#34;highlight sh&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;cat &amp;lt;&amp;lt; &lt;span class=&#34;string&#34;&gt;EOF &amp;gt; /etc/modules-load.d/containerd.conf&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;string&#34;&gt;overlay&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;string&#34;&gt;br_netfilter&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;string&#34;&gt;EOF&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;执行下面的命令，使其生效&lt;/p&gt;
&lt;figure class=&#34;highlight sh&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;modprobe overlay&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;modprobe br_netfilter&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;创建 &lt;code&gt;/etc/sysctl.d/99-kubernetes-cri.conf&lt;/code&gt;  配置文件：&lt;/p&gt;
&lt;figure class=&#34;highlight sh&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;cat &amp;lt;&amp;lt; &lt;span class=&#34;string&#34;&gt;EOF &amp;gt; /etc/sysctl.d/99-kubernetes-cri.conf&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;string&#34;&gt;net.bridge.bridge-nf-call-ip6tables = 1&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;string&#34;&gt;net.bridge.bridge-nf-call-iptables = 1&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;string&#34;&gt;net.ipv4.ip_forward = 1&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;string&#34;&gt;user.max_user_namespaces=28633&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;string&#34;&gt;EOF&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;执行以下命令使配置生效:&lt;/p&gt;
&lt;figure class=&#34;highlight sh&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;sysctl -p /etc/sysctl.d/99-kubernetes-cri.conf&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h3 id=&#34;关闭-swap&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#关闭-swap&#34;&gt;#&lt;/a&gt; 关闭  &lt;code&gt;swap&lt;/code&gt;&lt;/h3&gt;
&lt;p&gt;Kubernetes 1.8 开始要求关闭系统的 Swap，如果不关闭，默认配置下 kubelet 将无法启动。 关闭系统的 Swap 方法如下:&lt;/p&gt;
&lt;figure class=&#34;highlight sh&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;swapoff -a&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;修改  &lt;code&gt;/etc/fstab&lt;/code&gt;  文件，注释掉  &lt;code&gt;SWAP&lt;/code&gt;  的自动挂载，使用 &lt;code&gt;free -m&lt;/code&gt;  确认 &lt;code&gt;swap&lt;/code&gt;  已经关闭。&lt;/p&gt;
&lt;p&gt;&lt;code&gt;swappiness&lt;/code&gt;  参数调整，修改 &lt;code&gt;/etc/sysctl.d/99-kubernetes-cri.conf&lt;/code&gt;  添加下面一行：&lt;/p&gt;
&lt;figure class=&#34;highlight sh&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;vm.swappiness=0&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;执行 &lt;code&gt;sysctl -p /etc/sysctl.d/99-kubernetes-cri.conf&lt;/code&gt;  使修改生效。&lt;/p&gt;
&lt;h4 id=&#34;安装-containerd-2&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#安装-containerd-2&#34;&gt;#&lt;/a&gt; 安装  &lt;code&gt;containerd&lt;/code&gt;&lt;/h4&gt;
&lt;p&gt;在各个服务器节点上安装容器运行时  &lt;code&gt;Containerd&lt;/code&gt;  。&lt;/p&gt;
&lt;p&gt;下载  &lt;code&gt;Containerd&lt;/code&gt;  的二进制包:&lt;/p&gt;
&lt;figure class=&#34;highlight sh&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;wget https://github.com/containerd/containerd/releases/download/v1.6.4/cri-containerd-cni-1.6.4-linux-amd64.tar.gz&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;tar -zxvf cri-containerd-cni-1.6.4-linux-amd64.tar.gz -C /&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;生成  &lt;code&gt;containerd&lt;/code&gt;  的配置文件&lt;/p&gt;
&lt;figure class=&#34;highlight sh&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;mkdir -p /etc/containerd&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;containerd config default &amp;gt; /etc/containerd/config.toml&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;修改前面生成的配置文件  &lt;code&gt;/etc/containerd/config.toml&lt;/code&gt;&lt;/p&gt;
&lt;figure class=&#34;highlight sh&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;[plugins.&lt;span class=&#34;string&#34;&gt;&amp;quot;io.containerd.grpc.v1.cri&amp;quot;&lt;/span&gt;.containerd.runtimes.runc]&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  ...&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  [plugins.&lt;span class=&#34;string&#34;&gt;&amp;quot;io.containerd.grpc.v1.cri&amp;quot;&lt;/span&gt;.containerd.runtimes.runc.options]&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    SystemdCgroup = &lt;span class=&#34;literal&#34;&gt;true&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;再修改 /etc/containerd/config.toml 中的&lt;/p&gt;
&lt;figure class=&#34;highlight sh&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;[plugins.&lt;span class=&#34;string&#34;&gt;&amp;quot;io.containerd.grpc.v1.cri&amp;quot;&lt;/span&gt;]&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  ...&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  &lt;span class=&#34;comment&#34;&gt;# sandbox_image = &amp;quot;k8s.gcr.io/pause:3.6&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  sandbox_image = &lt;span class=&#34;string&#34;&gt;&amp;quot;registry.aliyuncs.com/google_containers/pause:3.7&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;配置  &lt;code&gt;containerd&lt;/code&gt;  开机启动，并启动  &lt;code&gt;containerd&lt;/code&gt;&lt;/p&gt;
&lt;figure class=&#34;highlight sh&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;systemctl &lt;span class=&#34;built_in&#34;&gt;enable&lt;/span&gt; containerd --now&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;使用 &lt;code&gt;crictl&lt;/code&gt;  测试一下，确保可以打印出版本信息并且没有错误信息输出:&lt;/p&gt;
&lt;figure class=&#34;highlight sh&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;crictl version&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;如下输出:&lt;/p&gt;
&lt;figure class=&#34;highlight sh&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;Version:  0.1.0&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;RuntimeName:  containerd&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;RuntimeVersion:  v1.6.4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;RuntimeApiVersion:  v1alpha2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h3 id=&#34;配置服务器支持开启ipvs&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#配置服务器支持开启ipvs&#34;&gt;#&lt;/a&gt; 配置服务器支持开启 ipvs&lt;/h3&gt;
&lt;p&gt;执行下面的脚本&lt;/p&gt;
&lt;figure class=&#34;highlight sh&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;cat &amp;gt; /etc/sysconfig/modules/ipvs.modules &amp;lt;&amp;lt;&lt;span class=&#34;string&#34;&gt;EOF&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;string&#34;&gt;#!/bin/bash&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;string&#34;&gt;modprobe -- ip_vs&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;string&#34;&gt;modprobe -- ip_vs_rr&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;string&#34;&gt;modprobe -- ip_vs_wrr&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;string&#34;&gt;modprobe -- ip_vs_sh&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;string&#34;&gt;modprobe -- nf_conntrack&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;string&#34;&gt;EOF&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;chmod 755 /etc/sysconfig/modules/ipvs.modules &amp;amp;&amp;amp; bash /etc/sysconfig/modules/ipvs.modules &amp;amp;&amp;amp; lsmod | grep -e ip_vs -e nf_conntrack&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;上面脚本创建了的 &lt;code&gt;/etc/sysconfig/modules/ipvs.modules&lt;/code&gt;  文件，保证在节点重启后能自动加载所需模块。 使用 &lt;code&gt;lsmod | grep -e ip_vs -e nf_conntrack&lt;/code&gt;  命令查看是否已经正确加载所需的内核模块。&lt;/p&gt;
&lt;p&gt;接下来，就可以使用  &lt;code&gt;kubeadm&lt;/code&gt;  部署  &lt;code&gt;k8s&lt;/code&gt;  集群了。&lt;/p&gt;
&lt;h2 id=&#34;安装k8s集群&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#安装k8s集群&#34;&gt;#&lt;/a&gt; 安装 k8s 集群&lt;/h2&gt;
&lt;p&gt;安装  &lt;code&gt;k8s&lt;/code&gt;  集群有很多种方式，这里使用  &lt;code&gt;kubeadm&lt;/code&gt;  安装&lt;/p&gt;
&lt;h3 id=&#34;安装kubeadm&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#安装kubeadm&#34;&gt;#&lt;/a&gt; 安装 kubeadm&lt;/h3&gt;
&lt;figure class=&#34;highlight sh&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;15&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;cat &amp;lt;&amp;lt;&lt;span class=&#34;string&#34;&gt;EOF &amp;gt; /etc/yum.repos.d/kubernetes.repo&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;string&#34;&gt;[kubernetes]&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;string&#34;&gt;name=Kubernetes&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;string&#34;&gt;baseurl=http://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;string&#34;&gt;enabled=1&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;string&#34;&gt;gpgcheck=0&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;string&#34;&gt;repo_gpgcheck=0&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;string&#34;&gt;gpgkey=http://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg http://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;string&#34;&gt;EOF&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;yum makecache&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;sudo yum install -y kubelet kubeadm kubectl --disableexcludes=kubernetes&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;systemctl &lt;span class=&#34;built_in&#34;&gt;enable&lt;/span&gt; --now kubelet&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h3 id=&#34;配置-kubeadm-配置文件&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#配置-kubeadm-配置文件&#34;&gt;#&lt;/a&gt; 配置  &lt;code&gt;kubeadm&lt;/code&gt;  配置文件&lt;/h3&gt;
&lt;p&gt;配置  &lt;code&gt;kubeadm&lt;/code&gt;  的配置文件.  &lt;code&gt;touch kubeadm-config.yaml&lt;/code&gt;&lt;/p&gt;
&lt;figure class=&#34;highlight yaml&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;26&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;attr&#34;&gt;apiVersion:&lt;/span&gt; &lt;span class=&#34;string&#34;&gt;kubeadm.k8s.io/v1beta3&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;attr&#34;&gt;kind:&lt;/span&gt; &lt;span class=&#34;string&#34;&gt;InitConfiguration&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;attr&#34;&gt;localAPIEndpoint:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  &lt;span class=&#34;attr&#34;&gt;advertiseAddress:&lt;/span&gt; &lt;span class=&#34;number&#34;&gt;192.168&lt;/span&gt;&lt;span class=&#34;number&#34;&gt;.96&lt;/span&gt;&lt;span class=&#34;number&#34;&gt;.151&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  &lt;span class=&#34;attr&#34;&gt;bindPort:&lt;/span&gt; &lt;span class=&#34;number&#34;&gt;6443&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;attr&#34;&gt;nodeRegistration:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  &lt;span class=&#34;attr&#34;&gt;criSocket:&lt;/span&gt; &lt;span class=&#34;string&#34;&gt;unix:///run/containerd/containerd.sock&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  &lt;span class=&#34;attr&#34;&gt;taints:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  &lt;span class=&#34;bullet&#34;&gt;-&lt;/span&gt; &lt;span class=&#34;attr&#34;&gt;effect:&lt;/span&gt; &lt;span class=&#34;string&#34;&gt;PreferNoSchedule&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;attr&#34;&gt;key:&lt;/span&gt; &lt;span class=&#34;string&#34;&gt;node-role.kubernetes.io/master&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;meta&#34;&gt;---&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;attr&#34;&gt;apiVersion:&lt;/span&gt; &lt;span class=&#34;string&#34;&gt;kubeadm.k8s.io/v1beta2&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;attr&#34;&gt;kind:&lt;/span&gt; &lt;span class=&#34;string&#34;&gt;ClusterConfiguration&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;attr&#34;&gt;kubernetesVersion:&lt;/span&gt; &lt;span class=&#34;string&#34;&gt;v1.24.0&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;attr&#34;&gt;imageRepository:&lt;/span&gt; &lt;span class=&#34;string&#34;&gt;registry.aliyuncs.com/google_containers&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;attr&#34;&gt;networking:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  &lt;span class=&#34;attr&#34;&gt;podSubnet:&lt;/span&gt; &lt;span class=&#34;number&#34;&gt;10.244&lt;/span&gt;&lt;span class=&#34;number&#34;&gt;.0&lt;/span&gt;&lt;span class=&#34;number&#34;&gt;.0&lt;/span&gt;&lt;span class=&#34;string&#34;&gt;/16&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;meta&#34;&gt;---&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;attr&#34;&gt;apiVersion:&lt;/span&gt; &lt;span class=&#34;string&#34;&gt;kubelet.config.k8s.io/v1beta1&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;attr&#34;&gt;kind:&lt;/span&gt; &lt;span class=&#34;string&#34;&gt;KubeletConfiguration&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;attr&#34;&gt;cgroupDriver:&lt;/span&gt; &lt;span class=&#34;string&#34;&gt;systemd&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;attr&#34;&gt;failSwapOn:&lt;/span&gt; &lt;span class=&#34;literal&#34;&gt;false&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;meta&#34;&gt;---&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;attr&#34;&gt;apiVersion:&lt;/span&gt; &lt;span class=&#34;string&#34;&gt;kubeproxy.config.k8s.io/v1alpha1&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;attr&#34;&gt;kind:&lt;/span&gt; &lt;span class=&#34;string&#34;&gt;KubeProxyConfiguration&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;attr&#34;&gt;mode:&lt;/span&gt; &lt;span class=&#34;string&#34;&gt;ipvs&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;这里定制了 &lt;code&gt;imageRepository&lt;/code&gt;  为阿里云的 &lt;code&gt;registry&lt;/code&gt; ，避免因 gcr 被墙，无法直接拉取镜像。 &lt;code&gt;criSocket&lt;/code&gt;  设置了容器运行时为 &lt;code&gt;containerd&lt;/code&gt; 。 同时设置 &lt;code&gt;kubelet&lt;/code&gt;  的 &lt;code&gt;cgroupDriver&lt;/code&gt;  为 &lt;code&gt;systemd&lt;/code&gt; ，设置 &lt;code&gt;kube-proxy&lt;/code&gt;  代理模式为 &lt;code&gt;ipvs&lt;/code&gt; 。&lt;/p&gt;
&lt;p&gt;可以通过  &lt;code&gt;kubeadm config print init-defaults --component-configs KubeletConfiguration&lt;/code&gt;  可以打印集群初始化默认的使用的配置.&lt;/p&gt;
&lt;p&gt;在开始初始化集群之前可以使用 &lt;code&gt;kubeadm config images pull --config kubeadm-config.yaml&lt;/code&gt;  预先在各个服务器节点上拉取所 &lt;code&gt;k8s&lt;/code&gt;  需要的容器镜像。&lt;/p&gt;
&lt;h3 id=&#34;初始化-k8s-master节点&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#初始化-k8s-master节点&#34;&gt;#&lt;/a&gt; 初始化  &lt;code&gt;k8s&lt;/code&gt;   &lt;code&gt;master&lt;/code&gt;  节点&lt;/h3&gt;
&lt;p&gt;在  &lt;code&gt;master&lt;/code&gt;  节点上执行  &lt;code&gt;kubeadm init --config kubeadm-config.yaml&lt;/code&gt; ,&lt;/p&gt;
&lt;p&gt;看到最后有打印：  &lt;code&gt;Your Kubernetes control-plane has initialized successfully!&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;就说明执行成功了。&lt;/p&gt;
&lt;p&gt;然后还有提示:&lt;/p&gt;
&lt;figure class=&#34;highlight sh&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;18&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;To start using your cluster, you need to run the following as a regular user:&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  mkdir -p &lt;span class=&#34;variable&#34;&gt;$HOME&lt;/span&gt;/.kube&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  sudo cp -i /etc/kubernetes/admin.conf &lt;span class=&#34;variable&#34;&gt;$HOME&lt;/span&gt;/.kube/config&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  sudo chown $(id -u):$(id -g) &lt;span class=&#34;variable&#34;&gt;$HOME&lt;/span&gt;/.kube/config&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Alternatively, &lt;span class=&#34;keyword&#34;&gt;if&lt;/span&gt; you are the root user, you can run:&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  &lt;span class=&#34;built_in&#34;&gt;export&lt;/span&gt; KUBECONFIG=/etc/kubernetes/admin.conf&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;You should now deploy a pod network to the cluster.&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Run &lt;span class=&#34;string&#34;&gt;&amp;quot;kubectl apply -f [podnetwork].yaml&amp;quot;&lt;/span&gt; with one of the options listed at:&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  https://kubernetes.io/docs/concepts/cluster-administration/addons/&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Then you can join any number of worker nodes by running the following on each as root:&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;kubeadm join 192.168.0.10:6443 --token e0nvot.l8sgzcgl07d5baq6 \&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;	--discovery-token-ca-cert-hash sha256:d07d9a5b919c23177881134e3ccf90e26fcb173133b8f6172cbf3d74f3c6a75d&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;所以，我们按照提示执行。&lt;/p&gt;
&lt;figure class=&#34;highlight sh&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;mkdir -p &lt;span class=&#34;variable&#34;&gt;$HOME&lt;/span&gt;/.kube&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;sudo cp -i /etc/kubernetes/admin.conf &lt;span class=&#34;variable&#34;&gt;$HOME&lt;/span&gt;/.kube/config&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;sudo chown $(id -u):$(id -g) &lt;span class=&#34;variable&#34;&gt;$HOME&lt;/span&gt;/.kube/config&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;然后再 两台 &lt;code&gt;node&lt;/code&gt;  节点上执行 如下命令来加入到集群中。&lt;/p&gt;
&lt;figure class=&#34;highlight sh&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;kubeadm join 192.168.0.10:6443 --token e0nvot.l8sgzcgl07d5baq6 \&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;	--discovery-token-ca-cert-hash sha256:d07d9a5b919c23177881134e3ccf90e26fcb173133b8f6172cbf3d74f3c6a75d&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;查看一下集群状态，确认个组件都处于 &lt;code&gt;healthy&lt;/code&gt;  状态，是否有错误:&lt;/p&gt;
&lt;figure class=&#34;highlight sh&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;kubectl get cs&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Warning: v1 ComponentStatus is deprecated &lt;span class=&#34;keyword&#34;&gt;in&lt;/span&gt; v1.19+&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;NAME                 STATUS    MESSAGE                         ERROR&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;scheduler            Healthy   ok&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;controller-manager   Healthy   ok&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;etcd-0               Healthy   &amp;#123;&lt;span class=&#34;string&#34;&gt;&amp;quot;health&amp;quot;&lt;/span&gt;:&lt;span class=&#34;string&#34;&gt;&amp;quot;true&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;reason&amp;quot;&lt;/span&gt;:&lt;span class=&#34;string&#34;&gt;&amp;quot;&amp;quot;&lt;/span&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;集群初始化如果遇到问题，可以使用 kubeadm reset 命令进行清理.&lt;/p&gt;
&lt;p&gt;这样 &lt;code&gt;k8s&lt;/code&gt;  集群就部署完成了。&lt;/p&gt;
&lt;h2 id=&#34;最后&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#最后&#34;&gt;#&lt;/a&gt; 最后&lt;/h2&gt;
&lt;p&gt;希望和你一起遇见更好的自己&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;/images/ml/qrcode.jpg&#34; alt=&#34;qrcode&#34;&gt;&lt;/p&gt;
</content>
        <category term="k8s" />
        <category term="kubernetes" />
        <updated>2022-07-17T10:18:00.000Z</updated>
    </entry>
</feed>
