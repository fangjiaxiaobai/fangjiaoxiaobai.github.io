{
    "version": "https://jsonfeed.org/version/1",
    "title": "方家小白",
    "description": "和你一起遇见更好的自己",
    "home_page_url": "https://fangjiaxiaobai.github.io",
    "items": [
        {
            "id": "https://fangjiaxiaobai.github.io/2021/08/31/es-series/04.ES%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5/",
            "url": "https://fangjiaxiaobai.github.io/2021/08/31/es-series/04.ES%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5/",
            "title": "Elastic Search基本概念",
            "date_published": "2021-08-31T08:28:55.000Z",
            "content_html": "<h1 id=\"文档\"><a class=\"markdownIt-Anchor\" href=\"#文档\">#</a> 文档</h1>\n<p><code>es</code>  是面向文档的，文档是 <code>es</code>  中可搜索的最小单位， <code>es</code>  的文档由一个或多个字段组成，类似于关系型数据库中的一行记录，但 <code>es</code>  的文档是以 <code>JSON</code>  进行序列化并保存的，每个 <code>JSON</code>  对象由一个或多个字段组成，字段类型可以是布尔，数值，字符串、二进制、日期等数据类型。<br>\n <code>es</code>  每个文档都有唯一的 <code>id</code> , 这个 <code>id</code>  可以由我们自己指定，也可以由 <code>es</code>  自动生成。</p>\n<p><code>es</code>  每一个文档，除了保存我们写入进行的文档原始数据外，也有文档自己的元数据，这些元数据，用于标识文档的相关信息。</p>\n<figure class=\"highlight json\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"attr\">&quot;_index&quot;</span> : <span class=\"string\">&quot;fxb_test&quot;</span>,</span><br><span class=\"line\">  <span class=\"attr\">&quot;_type&quot;</span> : <span class=\"string\">&quot;_doc&quot;</span>,</span><br><span class=\"line\">  <span class=\"attr\">&quot;_id&quot;</span> : <span class=\"string\">&quot;1&quot;</span>,</span><br><span class=\"line\">  <span class=\"attr\">&quot;_version&quot;</span> : <span class=\"number\">1</span>,</span><br><span class=\"line\">  <span class=\"attr\">&quot;_seq_no&quot;</span> : <span class=\"number\">0</span>,</span><br><span class=\"line\">  <span class=\"attr\">&quot;_primary_term&quot;</span> : <span class=\"number\">1</span>,</span><br><span class=\"line\">  <span class=\"attr\">&quot;found&quot;</span> : <span class=\"literal\">true</span>,</span><br><span class=\"line\">  <span class=\"attr\">&quot;_source&quot;</span> : &#123;</span><br><span class=\"line\">    <span class=\"attr\">&quot;username&quot;</span> : <span class=\"string\">&quot;fxb&quot;</span></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>从上面的文档中，我们可以看文档的元数据字段如下：</p>\n<p><code>_index</code> ：文档所在索引名称<br>\n <code>_source</code> ：原始 <code>json</code>  数据<br>\n <code>_type</code> ：文档所属类型， <code>es7.0</code>  以后只有为  <code>_doc</code> <br>\n <code>_version</code> ：文档版本，如果对文档进行修改，则该字段会增加<br>\n <code>_score</code> ：相关性打分<br>\n <code>id</code> ：文档唯一 id</p>\n<h1 id=\"索引\"><a class=\"markdownIt-Anchor\" href=\"#索引\">#</a> 索引</h1>\n<p><code>es</code>  索引，是 <code>es</code>  组织文档的方式，是拥有相结构文档的集合，可以把 <code>es</code>  的索引类比为关系型数据库的一张数据表。<br>\n索引是 <code>ES</code>  中非常重要的一种数据结构。后面我们会着重的学习其原理。</p>\n<p>比如，我们想创建一个索引，可以在 kibana 使用下面的命令:</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 创建索引</span></span><br><span class=\"line\">PUT /fxb_test</span><br></pre></td></tr></table></figure>\n<p>右侧就会输出：</p>\n<figure class=\"highlight json\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"attr\">&quot;acknowledged&quot;</span> : <span class=\"literal\">true</span>,</span><br><span class=\"line\">  <span class=\"attr\">&quot;shards_acknowledged&quot;</span> : <span class=\"literal\">true</span>,</span><br><span class=\"line\">  <span class=\"attr\">&quot;index&quot;</span> : <span class=\"string\">&quot;fxb_test&quot;</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>如图:</p>\n<p><img data-src=\"/images/es-series/create-index.png\" alt=\"\"></p>\n<h2 id=\"mapping\"><a class=\"markdownIt-Anchor\" href=\"#mapping\">#</a> Mapping</h2>\n<p><code>Mapping</code>  是对 索引的定义。 类似的 <code>MySQL</code>  中表结构定义， ES 中支持手动定义 <code>Mapping</code>  ， 动态映射这两种方式。</p>\n<p>比如，我们上面创建的  <code>fxb_test</code>  索引，就可以使用动态映射方式生成的 Mapping。</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 添加一个文档到 fxb_test 索引中</span></span><br><span class=\"line\">POST /fxb_test/_create/1</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;username&quot;</span>:<span class=\"string\">&quot;黄岛主&quot;</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;age&quot;</span>:57,</span><br><span class=\"line\">  <span class=\"string\">&quot;sex&quot;</span>: <span class=\"string\">&quot;男&quot;</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>输出结果：</p>\n<figure class=\"highlight json\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"attr\">&quot;_index&quot;</span> : <span class=\"string\">&quot;fxb_test&quot;</span>,</span><br><span class=\"line\">  <span class=\"attr\">&quot;_type&quot;</span> : <span class=\"string\">&quot;_doc&quot;</span>,</span><br><span class=\"line\">  <span class=\"attr\">&quot;_id&quot;</span> : <span class=\"string\">&quot;1&quot;</span>,</span><br><span class=\"line\">  <span class=\"attr\">&quot;_version&quot;</span> : <span class=\"number\">1</span>,</span><br><span class=\"line\">  <span class=\"attr\">&quot;result&quot;</span> : <span class=\"string\">&quot;created&quot;</span>,</span><br><span class=\"line\">  <span class=\"attr\">&quot;_shards&quot;</span> : &#123;</span><br><span class=\"line\">    <span class=\"attr\">&quot;total&quot;</span> : <span class=\"number\">2</span>,</span><br><span class=\"line\">    <span class=\"attr\">&quot;successful&quot;</span> : <span class=\"number\">1</span>,</span><br><span class=\"line\">    <span class=\"attr\">&quot;failed&quot;</span> : <span class=\"number\">0</span></span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  <span class=\"attr\">&quot;_seq_no&quot;</span> : <span class=\"number\">0</span>,</span><br><span class=\"line\">  <span class=\"attr\">&quot;_primary_term&quot;</span> : <span class=\"number\">1</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>然后，我们看下自动映射出来的 Mapping</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 查看索引的Mapping</span></span><br><span class=\"line\">GET /fxb_test</span><br></pre></td></tr></table></figure>\n<p>输出结果:</p>\n<figure class=\"highlight json\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"attr\">&quot;fxb_test&quot;</span> : &#123;</span><br><span class=\"line\">    <span class=\"attr\">&quot;mappings&quot;</span> : &#123;</span><br><span class=\"line\">      <span class=\"attr\">&quot;properties&quot;</span> : &#123;</span><br><span class=\"line\">        <span class=\"attr\">&quot;age&quot;</span> : &#123;</span><br><span class=\"line\">          <span class=\"attr\">&quot;type&quot;</span> : <span class=\"string\">&quot;long&quot;</span></span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        <span class=\"attr\">&quot;sex&quot;</span> : &#123;</span><br><span class=\"line\">          <span class=\"attr\">&quot;type&quot;</span> : <span class=\"string\">&quot;text&quot;</span>,</span><br><span class=\"line\">          <span class=\"attr\">&quot;fields&quot;</span> : &#123;</span><br><span class=\"line\">            <span class=\"attr\">&quot;keyword&quot;</span> : &#123;</span><br><span class=\"line\">              <span class=\"attr\">&quot;type&quot;</span> : <span class=\"string\">&quot;keyword&quot;</span>,</span><br><span class=\"line\">              <span class=\"attr\">&quot;ignore_above&quot;</span> : <span class=\"number\">256</span></span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        <span class=\"attr\">&quot;username&quot;</span> : &#123;</span><br><span class=\"line\">          <span class=\"attr\">&quot;type&quot;</span> : <span class=\"string\">&quot;text&quot;</span>,</span><br><span class=\"line\">          <span class=\"attr\">&quot;fields&quot;</span> : &#123;</span><br><span class=\"line\">            <span class=\"attr\">&quot;keyword&quot;</span> : &#123;</span><br><span class=\"line\">              <span class=\"attr\">&quot;type&quot;</span> : <span class=\"string\">&quot;keyword&quot;</span>,</span><br><span class=\"line\">              <span class=\"attr\">&quot;ignore_above&quot;</span> : <span class=\"number\">256</span></span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>这里就先简单了解一下，相关的命令。 至于上面每个字段的含义以及作用，我们后面详细介绍。</p>\n<h1 id=\"集群\"><a class=\"markdownIt-Anchor\" href=\"#集群\">#</a> 集群</h1>\n<p>ES 的集群搭建很简单，不需要依赖第三方协调管理组件，自身内部就实现了集群的管理功能。 <code>ES</code>  集群由一个或多个 <code>Elasticsearch</code>  节点组成，每个节点配置相同的  <code>cluster.name</code>  即可加入集群，默认值为 “ <code>elasticsearch</code> ”。确保不同的环境中使用不同的集群名称，否则最终会导致节点加入错误的集群。</p>\n<p>一个 <code>Elasticsearch</code>  服务启动实例就是一个节点（ <code>Node</code> ）。节点通过  <code>node.name</code>  来设置节点名称，如果不设置则在启动时给节点分配一个随机通用唯一标识符作为名称。</p>\n<h1 id=\"分片\"><a class=\"markdownIt-Anchor\" href=\"#分片\">#</a> 分片</h1>\n<p><code>ES</code>  支持 <code>PB</code>  级全文搜索，当索引上的数据量太大的时候， <code>ES</code>  通过水平拆分的方式将一个索引上的数据拆分出来分配到不同的数据块上，拆分出来的数据库块称之为一个分片。</p>\n<p>这类似于 <code>MySQL</code>  的分库分表，只不过 <code>MySQL</code>  分库分表需要借助第三方组件而 ES 内部自身实现了此功能。</p>\n<p>在一个多分片的索引中写入数据时，通过路由来确定具体写入哪一个分片中，所以在创建索引的时候需要指定分片的数量，并且分片的数量一旦确定就不能修改。</p>\n<p>分片的数量和下面介绍的副本数量都是可以通过创建索引时的 <code>settings</code>  来配置， <code>ES</code>  默认为一个索引创建 <code>1</code>  个主分片 ( <code>ES 7.x</code> ), 并分别为每个分片创建一个副本。</p>\n<p><code>ES</code>  通过分片的功能使得索引在规模上和性能上都得到提升，每个分片都是 <code>Lucene</code>  中的一个索引文件，每个分片必须有一个主分片和零到多个副本。</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 创建2个副本，5个分片的索引</span></span><br><span class=\"line\">PUT /fxb_test2</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;settings&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;number_of_replicas&quot;</span>: 2,</span><br><span class=\"line\">    <span class=\"string\">&quot;number_of_shards&quot;</span>: 5</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>返回结果:</p>\n<figure class=\"highlight json\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"attr\">&quot;acknowledged&quot;</span> : <span class=\"literal\">true</span>,</span><br><span class=\"line\">  <span class=\"attr\">&quot;shards_acknowledged&quot;</span> : <span class=\"literal\">true</span>,</span><br><span class=\"line\">  <span class=\"attr\">&quot;index&quot;</span> : <span class=\"string\">&quot;fxb_test2&quot;</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h1 id=\"副本\"><a class=\"markdownIt-Anchor\" href=\"#副本\">#</a> 副本</h1>\n<p>副本就是对分片的 <code>Copy</code> ，每个主分片都有一个或多个副本分片，当主分片异常时，副本可以提供数据的查询等操作。主分片和对应的副本分片是不会在同一个节点上的，所以副本分片数的最大值是  <code>n-1</code> （其中 n 为节点数）。</p>\n<p>对文档的新建、索引和删除请求都是写操作，必须在主分片上面完成之后才能被复制到相关的副本分片， <code>ES</code>  为了提高写入的能力这个过程是并发写的，同时为了解决并发写的过程中数据冲突的问题， <code>ES</code>  通过乐观锁的方式控制，每个文档都有一个  <code>_version</code>  （版本）号，当文档被修改时版本号递增。一旦所有的副本分片都报告写成功才会向协调节点报告成功，协调节点向客户端报告成功。</p>\n<p>关于， <code>ES</code>  的基本概念，就介绍到这里。<br>\n下一篇: 《 <code>ES</code>  索引管理》</p>\n<h1 id=\"最后\"><a class=\"markdownIt-Anchor\" href=\"#最后\">#</a> 最后</h1>\n<p>期望与你一起遇见更好的自己</p>\n<p><img data-src=\"/images/qrcode.jpg\" alt=\"期望与你一起遇见更好的自己\"></p>\n",
            "tags": [
                "Elastic Search",
                "搜索"
            ]
        },
        {
            "id": "https://fangjiaxiaobai.github.io/2021/08/31/es-series/03.ES%E9%85%8D%E7%BD%AE/",
            "url": "https://fangjiaxiaobai.github.io/2021/08/31/es-series/03.ES%E9%85%8D%E7%BD%AE/",
            "title": "Elastic Search配置",
            "date_published": "2021-08-31T07:28:55.000Z",
            "content_html": "<h1 id=\"elastic-search配置\"><a class=\"markdownIt-Anchor\" href=\"#elastic-search配置\">#</a> Elastic Search 配置</h1>\n<p><code>ES</code>  提供了很多默认的参数设置，使我们不用添加任何参数就可以成功的启动 <code>ES</code> 。 作为一个认真的学习者。我们还是来一起看看 如何更好的自定义  <code>ES</code>  配置。 详细的配置内容，可以参考 <span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuZWxhc3RpYy5jby9ndWlkZS9lbi9lbGFzdGljc2VhcmNoL3JlZmVyZW5jZS9jdXJyZW50L3NldHRpbmdzLmh0bWw=\">https://www.elastic.co/guide/en/elasticsearch/reference/current/settings.html</span>.</p>\n<p><code>ES</code>  的属性，分为 静态属性 和 动态属性。<br>\n所有的静态属性，都必须重启后才能生效。<br>\n对于动态属性可以通过调用</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">POST _nodes/reload_secure_settings</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;secure_settings_password&quot;</span>: <span class=\"string\">&quot;s3cr3t&quot;</span> </span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p><code>”s3cr3t“</code> , 是 <code>ES-keystore</code>  生成的秘钥。调用时需要替换为自己设置的秘钥.</p>\n<p>支持热加载的属性有:  <code> Azure repository plugin</code> , <code> EC2 discovery plugin</code> , <code>GCS repository plugin</code> , <code>S3 repository plugin</code> ,  <code>Monitoring settings</code> , <code>Watcher settings</code> 。如果想了解更多，可以在  <code>https://www.elastic.co/guide/en/elasticsearch/reference/current/secure-settings.html</code>  查询。</p>\n<p>在 ES 的安装目录，很明显的有一个  <code>config</code>  目录。进入之后，可以看到</p>\n<p><img data-src=\"./images/es-series/ES-config%E7%9B%AE%E5%BD%95.png\" alt=\"\"></p>\n<ul>\n<li><code>elasticsearch.keystore</code> :  <code>Elasticsearch</code>  提供了密钥库和 <code>elasticsearch-keystore</code>  用于管理密钥库设置的工具。</li>\n</ul>\n<p>接下来，我们重点来看下和配置相关的三个文件</p>\n<ul>\n<li><code>elasticsearch.yml</code> :</li>\n<li><code>jvm.options</code> :</li>\n<li><code>log4j2.properties</code> :</li>\n</ul>\n<p>和权限相关的。</p>\n<ul>\n<li><code>role_mapping.yml</code></li>\n<li><code>roles.yml</code></li>\n<li><code>users</code></li>\n<li><code>users_roles</code></li>\n</ul>\n<p>这里我们先不深入了解。</p>\n<h1 id=\"elasticsearch-设置介绍\"><a class=\"markdownIt-Anchor\" href=\"#elasticsearch-设置介绍\">#</a> elasticsearch 设置介绍</h1>\n<p>有些设置是非常敏感的，仅依靠文件系统权限来保护它们的值是不够的。对于这个用例， <code>Elasticsearch</code>  提供了一个密钥存储库和 <code>Elasticsearch-keystore</code>  工具来管理密钥存储库中的设置。设计仅从密钥库中读取某些设置。 但是，密钥库没有验证来阻止不支持的设置。 将不支持的设置添加到密钥库中会导致 <code>Elasticsearch</code>  无法启动。</p>\n<p><b>对密钥库的所有修改仅在重新启动 <code>Elasticsearch</code>  之后生效。</b><br>\n这些设置与  <code>elasticsearch.yml</code>  配置文件中的常规设置一样，需要在集群的每个节点上指定。 当前，所有安全设置都是特定于节点的设置，在每个节点上必须具有相同的值。</p>\n<h2 id=\"elasticserche-keystore-使用\"><a class=\"markdownIt-Anchor\" href=\"#elasticserche-keystore-使用\">#</a> elasticserche-keystore 使用</h2>\n<p>来看一下  <code>elasticsearch-keystore</code>  命令</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">bin/elasticsearch-keystore</span><br><span class=\"line\">* [add &lt;settings&gt;] [-f] [--stdin] :添加一个String的配置到keystore中</span><br><span class=\"line\">* [add-file (&lt;setting&gt; &lt;path&gt;)+] : 添加一个文件配置到keystore中</span><br><span class=\"line\">* [create] [-p]: 创建一个新的Es keyStore</span><br><span class=\"line\">* [list] : 展示keystore的项</span><br><span class=\"line\">* [passwd] : 修改 keystore的密码</span><br><span class=\"line\">* [remove &lt;setting&gt;] : 移除某些配置</span><br><span class=\"line\">* [upgrade] : 升级密钥库的内部格式。</span><br><span class=\"line\">* [has-passwd] - 验证是否有keystore并且有密码保护</span><br></pre></td></tr></table></figure>\n<p>简单使用:</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 创建一个keystore</span></span><br><span class=\"line\">&gt; ./elasticsearch-keystore create -p</span><br><span class=\"line\"><span class=\"comment\">## //输入密码</span></span><br><span class=\"line\">Enter new password <span class=\"keyword\">for</span> the elasticsearch keystore (empty <span class=\"keyword\">for</span> no password):</span><br><span class=\"line\"><span class=\"comment\">## // 确认密码</span></span><br><span class=\"line\">Enter same password again:</span><br><span class=\"line\"><span class=\"comment\">## // 已经有keystore文件了，是否要覆盖</span></span><br><span class=\"line\">An elasticsearch keystore already exists. Overwrite? [y/N]y</span><br><span class=\"line\">Created elasticsearch keystore <span class=\"keyword\">in</span> /Users/bjhl/fxb_applicaton/fxb_program/elasticsearch-7.10.1/config/elasticsearch.keystore</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 查看秘钥库</span></span><br><span class=\"line\">&gt; ./elasticsearch-keystore list</span><br><span class=\"line\"><span class=\"comment\">## // 输入密码</span></span><br><span class=\"line\">Enter password <span class=\"keyword\">for</span> the elasticsearch keystore :</span><br><span class=\"line\">keystore.seed <span class=\"comment\"># 秘钥库</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 添加设置到秘钥库中</span></span><br><span class=\"line\">&gt; ./elasticsearch-keystore add settings.name</span><br><span class=\"line\"><span class=\"comment\">## // 输入密码</span></span><br><span class=\"line\">Enter password <span class=\"keyword\">for</span> the elasticsearch keystore :</span><br><span class=\"line\"><span class=\"comment\">## 输入添加的设置的value</span></span><br><span class=\"line\">Enter value <span class=\"keyword\">for</span> settings.name:</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 添加文件到秘钥库</span></span><br><span class=\"line\">&gt; ./elasticsearch-keystore add-file file.name xxx.xx</span><br><span class=\"line\">Enter password <span class=\"keyword\">for</span> the elasticsearch keystore :</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 删除配置</span></span><br><span class=\"line\">&gt; ./elasticsearch-keystore remove settings.name</span><br><span class=\"line\">Enter password <span class=\"keyword\">for</span> the elasticsearch keystore :</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 更新keystore</span></span><br><span class=\"line\">&gt; ./elasticsearch-keystore upgrade</span><br><span class=\"line\">Enter password <span class=\"keyword\">for</span> the elasticsearch keystore :</span><br></pre></td></tr></table></figure>\n<h2 id=\"elasticsearchyml\"><a class=\"markdownIt-Anchor\" href=\"#elasticsearchyml\">#</a>  <code>elasticsearch.yml</code></h2>\n<figure class=\"highlight yml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># - 集群相关配置 -</span></span><br><span class=\"line\"><span class=\"comment\"># 集群的名称</span></span><br><span class=\"line\"><span class=\"attr\">cluster.name:</span> <span class=\"string\">my-application</span></span><br><span class=\"line\"><span class=\"comment\"># 更多关于集群的配置，参考：https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-cluster.html</span></span><br><span class=\"line\"><span class=\"comment\"># 跨集群配置:参考:https://www.elastic.co/guide/en/elasticsearch/reference/current/ccr-settings.html</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 节点的名称</span></span><br><span class=\"line\"><span class=\"attr\">node.name:</span> <span class=\"string\">fxb-cluster-node-1</span></span><br><span class=\"line\"><span class=\"comment\"># 可以为集群添加一些自定义的属性配置</span></span><br><span class=\"line\"><span class=\"attr\">node.attr.zhName:</span> <span class=\"string\">方小白</span></span><br><span class=\"line\"><span class=\"comment\"># 更多节点相关的配置,参考</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># - 路径相关配置 -</span></span><br><span class=\"line\"><span class=\"comment\"># 指定存储数据的位置,多个路径的话，使用`,`分割 (separate multiple locations by comma)</span></span><br><span class=\"line\"><span class=\"attr\">path.data:</span> <span class=\"string\">/path/to/data</span></span><br><span class=\"line\"><span class=\"comment\"># 日志文件存储地址</span></span><br><span class=\"line\"><span class=\"attr\">path.logs:</span> <span class=\"string\">/path/to/logs</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># - 内存相关 -</span></span><br><span class=\"line\"><span class=\"comment\"># Lock the memory on startup:</span></span><br><span class=\"line\"><span class=\"attr\">bootstrap.memory_lock:</span> <span class=\"literal\">true</span></span><br><span class=\"line\"><span class=\"comment\"># 确保将堆大小设置为系统上可用内存的一半左右，并确保进程的所有者可以使用此限制。系统交换内存时，Elasticsearch的性能较差。</span></span><br><span class=\"line\"><span class=\"comment\"># ---------------------------------- Network -----------------------------------</span></span><br><span class=\"line\"><span class=\"comment\"># Set the bind address to a specific IP (IPv4 or IPv6):</span></span><br><span class=\"line\"><span class=\"attr\">network.host:</span> <span class=\"number\">192.168</span><span class=\"number\">.0</span><span class=\"number\">.1</span></span><br><span class=\"line\"><span class=\"comment\"># 启动端口</span></span><br><span class=\"line\"><span class=\"attr\">http.port:</span> <span class=\"number\">9200</span></span><br><span class=\"line\"><span class=\"comment\"># 更多可以参考: https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-network.html</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># --------------------------------- Discovery ----------------------------------</span></span><br><span class=\"line\"><span class=\"comment\"># 提供群集中符合主机资格的节点的地址列表。</span></span><br><span class=\"line\"><span class=\"comment\"># The default list of hosts is [&quot;127.0.0.1&quot;, &quot;[::1]&quot;]</span></span><br><span class=\"line\"><span class=\"attr\">discovery.seed_hosts:</span> [<span class=\"string\">&quot;host1&quot;</span>, <span class=\"string\">&quot;host2&quot;</span>]</span><br><span class=\"line\"><span class=\"comment\"># 设置初始的符合主机资格的节点集,【静态属性】</span></span><br><span class=\"line\"><span class=\"attr\">cluster.initial_master_nodes:</span> [<span class=\"string\">&quot;node-1&quot;</span>, <span class=\"string\">&quot;node-2&quot;</span>]</span><br><span class=\"line\"><span class=\"comment\"># 更多关于发现相关的配置,参考:https://www.elastic.co/guide/en/elasticsearch/reference/current/ccr-settings.html</span></span><br><span class=\"line\"><span class=\"comment\"># ---------------------------------- Gateway -----------------------------------</span></span><br><span class=\"line\"><span class=\"comment\"># Block initial recovery after a full cluster restart until N nodes are started:</span></span><br><span class=\"line\"><span class=\"attr\">gateway.recover_after_nodes:</span> <span class=\"number\">3</span></span><br><span class=\"line\"><span class=\"comment\">#</span></span><br><span class=\"line\"><span class=\"comment\"># 更多内容，参考https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-gateway.html</span></span><br><span class=\"line\"><span class=\"comment\">#</span></span><br><span class=\"line\"><span class=\"comment\"># ---------------------------------- Various -----------------------------------</span></span><br><span class=\"line\"><span class=\"comment\"># Require explicit names when deleting indices:</span></span><br><span class=\"line\"><span class=\"attr\">action.destructive_requires_name:</span> <span class=\"literal\">true</span></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h2 id=\"jvm-参数-jvmoptions\"><a class=\"markdownIt-Anchor\" href=\"#jvm-参数-jvmoptions\">#</a> JVM 参数 =&gt; jvm.options</h2>\n<p><code>jvm.options</code>  包含使用特殊语法的以行分隔的 <code>JVM</code>  参数列表：</p>\n<ul>\n<li><code>#</code>  表示注释</li>\n<li>以 <code>-</code>  开头的行被视为独立于 <code>JVM</code>  版本而应用的 JVM 选项</li>\n<li>以 <code>&lt;数字&gt;:-</code>  开头的行被视为 <code>JVM</code>  选项，只有当 <code>JVM</code>  的版本与该数字匹配时才适用，比如: <code>8:-Xmx2g</code></li>\n<li>以  <code>&lt;数字&gt;-：</code> 开头 的行被视为 <code>JVM</code>  选项，仅在 <code>JVM</code>  版本大于或等于该数字时才适用。比如: <code>8-:-Xmx2g</code></li>\n<li>以 <code>&lt;数字&gt;-&lt;数字&gt;：</code> 开头的行被视为仅在 <code>JVM</code>  版本落在两个数字范围内时才适用的 <code>JVM</code>  选项。比如： <code>8-9:-Xmx2g</code></li>\n</ul>\n<p>Elasticsearch 默认配置 JVM 使用最小和最大大小为 1 GB 的堆。</p>\n<figure class=\"highlight yml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">## JVM configuration</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">################################################################</span></span><br><span class=\"line\"><span class=\"comment\">## IMPORTANT: JVM heap size</span></span><br><span class=\"line\"><span class=\"comment\">################################################################</span></span><br><span class=\"line\"><span class=\"comment\">## 参考 https://www.elastic.co/guide/en/elasticsearch/reference/current/important-settings.html#heap-size-settings</span></span><br><span class=\"line\"><span class=\"comment\"># Xms represents the initial size of total heap space</span></span><br><span class=\"line\"><span class=\"comment\"># Xmx represents the maximum size of total heap space</span></span><br><span class=\"line\"><span class=\"string\">-Xms1g</span></span><br><span class=\"line\"><span class=\"string\">-Xmx1g</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">################################################################</span></span><br><span class=\"line\"><span class=\"comment\">## Expert settings: 高级设置</span></span><br><span class=\"line\"><span class=\"comment\">################################################################</span></span><br><span class=\"line\"><span class=\"comment\">## 不理解下面的属性，不建议修改</span></span><br><span class=\"line\"><span class=\"comment\">################################################################</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">## GC configuration</span></span><br><span class=\"line\"><span class=\"number\">8</span><span class=\"number\">-13</span><span class=\"string\">:-XX:+UseConcMarkSweepGC</span></span><br><span class=\"line\"><span class=\"number\">8</span><span class=\"number\">-13</span><span class=\"string\">:-XX:CMSInitiatingOccupancyFraction=75</span></span><br><span class=\"line\"><span class=\"number\">8</span><span class=\"number\">-13</span><span class=\"string\">:-XX:+UseCMSInitiatingOccupancyOnly</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">## G1GC Configuration</span></span><br><span class=\"line\"><span class=\"comment\"># <span class=\"doctag\">NOTE:</span> G1 GC is only supported on JDK version 10 or later</span></span><br><span class=\"line\"><span class=\"comment\"># to use G1GC, uncomment the next two lines and update the version on the</span></span><br><span class=\"line\"><span class=\"comment\"># following three lines to your version of the JDK</span></span><br><span class=\"line\"><span class=\"comment\"># 10-13:-XX:-UseConcMarkSweepGC</span></span><br><span class=\"line\"><span class=\"comment\"># 10-13:-XX:-UseCMSInitiatingOccupancyOnly</span></span><br><span class=\"line\"><span class=\"number\">14</span><span class=\"string\">-:-XX:+UseG1GC</span></span><br><span class=\"line\"><span class=\"number\">14</span><span class=\"string\">-:-XX:G1ReservePercent=25</span></span><br><span class=\"line\"><span class=\"number\">14</span><span class=\"string\">-:-XX:InitiatingHeapOccupancyPercent=30</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">## JVM temporary directory</span></span><br><span class=\"line\"><span class=\"string\">-Djava.io.tmpdir=$&#123;ES_TMPDIR&#125;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">## heap dumps</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># generate a heap dump when an allocation from the Java heap fails</span></span><br><span class=\"line\"><span class=\"comment\"># heap dumps are created in the working directory of the JVM</span></span><br><span class=\"line\"><span class=\"string\">-XX:+HeapDumpOnOutOfMemoryError</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># specify an alternative path for heap dumps; ensure the directory exists and</span></span><br><span class=\"line\"><span class=\"comment\"># has sufficient space</span></span><br><span class=\"line\"><span class=\"string\">-XX:HeapDumpPath=data</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># specify an alternative path for JVM fatal error logs</span></span><br><span class=\"line\"><span class=\"string\">-XX:ErrorFile=logs/hs_err_pid%p.log</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">## JDK 8 GC logging</span></span><br><span class=\"line\"><span class=\"number\">8</span><span class=\"string\">:-XX:+PrintGCDetails</span></span><br><span class=\"line\"><span class=\"number\">8</span><span class=\"string\">:-XX:+PrintGCDateStamps</span></span><br><span class=\"line\"><span class=\"number\">8</span><span class=\"string\">:-XX:+PrintTenuringDistribution</span></span><br><span class=\"line\"><span class=\"number\">8</span><span class=\"string\">:-XX:+PrintGCApplicationStoppedTime</span></span><br><span class=\"line\"><span class=\"number\">8</span><span class=\"string\">:-Xloggc:logs/gc.log</span></span><br><span class=\"line\"><span class=\"number\">8</span><span class=\"string\">:-XX:+UseGCLogFileRotation</span></span><br><span class=\"line\"><span class=\"number\">8</span><span class=\"string\">:-XX:NumberOfGCLogFiles=32</span></span><br><span class=\"line\"><span class=\"number\">8</span><span class=\"string\">:-XX:GCLogFileSize=64m</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># JDK 9+ GC logging</span></span><br><span class=\"line\"><span class=\"number\">9</span><span class=\"string\">-:-Xlog:gc*,gc+age=trace,safepoint:file=logs/gc.log:utctime,pid,tags:filecount=32,filesize=64m</span></span><br></pre></td></tr></table></figure>\n<h1 id=\"日志参数\"><a class=\"markdownIt-Anchor\" href=\"#日志参数\">#</a> 日志参数</h1>\n<p>可以看到  <code>ElasticSearch</code>  使用 <code>log4j2</code>  日志，关于此日志的配置，这里就不多赘述了。</p>\n<h1 id=\"系统配置\"><a class=\"markdownIt-Anchor\" href=\"#系统配置\">#</a> 系统配置</h1>\n<p>除了对  <code>ES</code>  的配置之外，如果想要更好的提升 ES 性能，还需对  <code>ES</code>  所依赖的宿主机进行一些属性配置。<br>\n比如：比如禁止 <code>swap</code>  等。更多内容，参考:<span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuZWxhc3RpYy5jby9ndWlkZS9lbi9lbGFzdGljc2VhcmNoL3JlZmVyZW5jZS9jdXJyZW50L3N5c3RlbS1jb25maWcuaHRtbA==\">https://www.elastic.co/guide/en/elasticsearch/reference/current/system-config.html</span>.</p>\n<h1 id=\"最后\"><a class=\"markdownIt-Anchor\" href=\"#最后\">#</a> 最后</h1>\n<p>期望与你一起遇见更好的自己</p>\n<p><img data-src=\"/images/qrcode.jpg\" alt=\"期望与你一起遇见更好的自己\"></p>\n",
            "tags": [
                "Elastic Search",
                "搜索"
            ]
        },
        {
            "id": "https://fangjiaxiaobai.github.io/2021/08/31/es-series/02.ES%E5%AE%89%E8%A3%85/",
            "url": "https://fangjiaxiaobai.github.io/2021/08/31/es-series/02.ES%E5%AE%89%E8%A3%85/",
            "title": "ES栈安装",
            "date_published": "2021-08-31T07:20:55.000Z",
            "content_html": "<h2 id=\"安装-elasticsearch-7101\"><a class=\"markdownIt-Anchor\" href=\"#安装-elasticsearch-7101\">#</a> 安装 ElasticSearch 7.10.1</h2>\n<h3 id=\"下载安装包\"><a class=\"markdownIt-Anchor\" href=\"#下载安装包\">#</a> 下载安装包</h3>\n<p>我们在 <code>es</code>  的<span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuZWxhc3RpYy5jby9ndWlkZS9lbi9lbGFzdGljc2VhcmNoL3JlZmVyZW5jZS83LjEwL2dldHRpbmctc3RhcnRlZC1pbnN0YWxsLmh0bWw=\">官网</span>上可以找到 ES 软件的下载地址，我放到下面:</p>\n<p><code>LINUX</code> : <span class=\"exturl\" data-url=\"aHR0cHM6Ly9hcnRpZmFjdHMuZWxhc3RpYy5jby9kb3dubG9hZHMvZWxhc3RpY3NlYXJjaC9lbGFzdGljc2VhcmNoLTcuMTAuMS1saW51eC14ODZfNjQudGFyLmd6\">elasticsearch-7.10.1-linux-x86_64.tar.gz</span><br>\n <code>MACOS</code> : <span class=\"exturl\" data-url=\"aHR0cHM6Ly9hcnRpZmFjdHMuZWxhc3RpYy5jby9kb3dubG9hZHMvZWxhc3RpY3NlYXJjaC9lbGFzdGljc2VhcmNoLTcuMTAuMS1kYXJ3aW4teDg2XzY0LnRhci5neg==\">elasticsearch-7.10.1-darwin-x86_64.tar.gz</span><br>\n <code>Windows</code> : <span class=\"exturl\" data-url=\"aHR0cHM6Ly9hcnRpZmFjdHMuZWxhc3RpYy5jby9kb3dubG9hZHMvZWxhc3RpY3NlYXJjaC9lbGFzdGljc2VhcmNoLTcuMTAuMS13aW5kb3dzLXg4Nl82NC56aXA=\">elasticsearch-7.10.1-windows-x86_64.zip</span></p>\n<p><code>ps</code> : 我试了下好像需要 科学上网 。 你可以可以通过公众号中 回复  <code>es-系统名称</code>  就可以获取到对应的下载连接了。下拉到底哦～</p>\n<h3 id=\"解压安装包\"><a class=\"markdownIt-Anchor\" href=\"#解压安装包\">#</a> 解压安装包</h3>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"><span class=\"comment\"># Linux:</span></span></span><br><span class=\"line\">tar -xvf elasticsearch-7.10.1-linux-x86_64.tar.gz</span><br><span class=\"line\"><span class=\"meta\"></span></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"><span class=\"comment\"># macOS:</span></span></span><br><span class=\"line\">tar -xvf elasticsearch-7.10.1-darwin-x86_64.tar.gz</span><br><span class=\"line\"><span class=\"meta\"></span></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"><span class=\"comment\"># Windows PowerShell:</span></span></span><br><span class=\"line\">Expand-Archive elasticsearch-7.10.1-windows-x86_64.zip</span><br></pre></td></tr></table></figure>\n<h3 id=\"启动-elasticsearch\"><a class=\"markdownIt-Anchor\" href=\"#启动-elasticsearch\">#</a> 启动  <code>ElasticSearch</code></h3>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">## Linux and macOS:</span></span><br><span class=\"line\"><span class=\"built_in\">cd</span> elasticsearch-7.10.1/bin</span><br><span class=\"line\">./elasticsearch</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">## Windows:</span></span><br><span class=\"line\"><span class=\"built_in\">cd</span> elasticsearch-7.10.1\\bin</span><br><span class=\"line\">.\\elasticsearch.bat</span><br></pre></td></tr></table></figure>\n<p>这样就启动了单实例的 <code>ElasticSearch</code>  了。默认端口是 9200。</p>\n<p>我们可以在浏览器上访问 :  <code>http://localhost:9200</code>  查看  <code>ES</code>  情况。</p>\n<figure class=\"highlight json\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;</span><br><span class=\"line\">name: <span class=\"string\">&quot;bjhldeMacBook-Pro.local&quot;</span>,</span><br><span class=\"line\">cluster_name: <span class=\"string\">&quot;elasticsearch&quot;</span>,</span><br><span class=\"line\">cluster_uuid: <span class=\"string\">&quot;nAay2-T3STS8BVc3-OkOaw&quot;</span>,</span><br><span class=\"line\">version: &#123;</span><br><span class=\"line\">number: <span class=\"string\">&quot;7.10.1&quot;</span>,</span><br><span class=\"line\">build_flavor: <span class=\"string\">&quot;default&quot;</span>,</span><br><span class=\"line\">build_type: <span class=\"string\">&quot;tar&quot;</span>,</span><br><span class=\"line\">build_hash: <span class=\"string\">&quot;1c34507e66d7db1211f66f3513706fdf548736aa&quot;</span>,</span><br><span class=\"line\">build_date: <span class=\"string\">&quot;2020-12-05T01:00:33.671820Z&quot;</span>,</span><br><span class=\"line\">build_snapshot: <span class=\"literal\">false</span>,</span><br><span class=\"line\">lucene_version: <span class=\"string\">&quot;8.7.0&quot;</span>,</span><br><span class=\"line\">minimum_wire_compatibility_version: <span class=\"string\">&quot;6.8.0&quot;</span>,</span><br><span class=\"line\">minimum_index_compatibility_version: <span class=\"string\">&quot;6.0.0-beta1&quot;</span></span><br><span class=\"line\">&#125;,</span><br><span class=\"line\">tagline: <span class=\"string\">&quot;You Know, for Search&quot;</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>也可以通过  <code>http://localhost:9200/_cat/health?v</code>  查看集群运行情况。</p>\n<p>如果想启动多个 <code>ElasticSearch</code>  实例，搭建起 ES 集群，就需要每个实例指定单独的数据文件地址和日志文件地址。</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">## Linux and macOS:</span></span><br><span class=\"line\">./elasticsearch -Epath.data=data2 -Epath.logs=log2</span><br><span class=\"line\">./elasticsearch -Epath.data=data3 -Epath.logs=log3</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">## Windows:</span></span><br><span class=\"line\">.\\elasticsearch.bat -E path.data=data2 -E path.logs=log2</span><br><span class=\"line\">.\\elasticsearch.bat -E path.data=data3 -E path.logs=log3</span><br></pre></td></tr></table></figure>\n<h2 id=\"安装-kibana\"><a class=\"markdownIt-Anchor\" href=\"#安装-kibana\">#</a> 安装  <code>Kibana</code></h2>\n<p><code>Kibana</code>  是一个开源的分析和可视化平台。使用 <code>Kibana</code>  来探索你的 <code>Elasticsearch</code>  数据，然后建立漂亮的可视化和仪表板。<br>\n <code>Kibana</code>  具有管理弹性栈的 UI。管理您的安全设置，分配用户角色，拍摄快照，卷起您的数据，以及更多，都从一个 <code>Kibana UI</code>  的便利。<br>\n <code>Elastic</code>  栈解决方案的集中式中心。从日志分析到文档发现.</p>\n<h3 id=\"mac-or-linux\"><a class=\"markdownIt-Anchor\" href=\"#mac-or-linux\">#</a>  <code>Mac or linux</code></h3>\n<h4 id=\"下载-kibana-安装包\"><a class=\"markdownIt-Anchor\" href=\"#下载-kibana-安装包\">#</a> 下载  <code>kibana</code>  安装包</h4>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">curl -O https://artifacts.elastic.co/downloads/kibana/kibana-7.10.1-darwin-x86_64.tar.gz</span><br><span class=\"line\">curl https://artifacts.elastic.co/downloads/kibana/kibana-7.10.1-darwin-x86_64.tar.gz.sha512 | shasum -a 512 -c - </span><br><span class=\"line\">tar -xzf kibana-7.10.1-darwin-x86_64.tar.gz</span><br><span class=\"line\"><span class=\"built_in\">cd</span> kibana-7.10.1-darwin-x86_64/ </span><br></pre></td></tr></table></figure>\n<h4 id=\"启动-kibana\"><a class=\"markdownIt-Anchor\" href=\"#启动-kibana\">#</a> 启动  <code>kibana</code></h4>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">./bin/kibana</span><br></pre></td></tr></table></figure>\n<h3 id=\"windows\"><a class=\"markdownIt-Anchor\" href=\"#windows\">#</a>  <code>Windows</code></h3>\n<h4 id=\"下载\"><a class=\"markdownIt-Anchor\" href=\"#下载\">#</a> 下载</h4>\n<p>点击链接 <span class=\"exturl\" data-url=\"aHR0cHM6Ly9hcnRpZmFjdHMuZWxhc3RpYy5jby9kb3dubG9hZHMva2liYW5hL2tpYmFuYS03LjEwLjEtd2luZG93cy14ODZfNjQuemlw\">https://artifacts.elastic.co/downloads/kibana/kibana-7.10.1-windows-x86_64.zip</span>  下载 kibana 后，解压文件。</p>\n<h4 id=\"启动\"><a class=\"markdownIt-Anchor\" href=\"#启动\">#</a> 启动</h4>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">.\\bin\\kibana.bat</span><br></pre></td></tr></table></figure>\n<h3 id=\"验证\"><a class=\"markdownIt-Anchor\" href=\"#验证\">#</a> 验证</h3>\n<p>访问  <code>localhost:5601</code>  页面，就可以访问 kibana 的页面了.</p>\n<p><img data-src=\"/images/es-series/WX20210108-190528.png\" alt=\"WX20210108-190528.png\"></p>\n<p>我们接下来的学习，主要是依赖 kibana 的 devTool 功能。因为 devTools 给我们提供建非常方便的 Rest API 调用方式。</p>\n<p><img data-src=\"/images/es-series/kibana-devTool.png\" alt=\"kibana-devTool\"></p>\n<h2 id=\"安装-logstash\"><a class=\"markdownIt-Anchor\" href=\"#安装-logstash\">#</a> 安装  <code>logstash</code></h2>\n<p><code>Logstash</code>  是一个具有实时管道功能的开源数据收集引擎。 <code>Logstash</code>  可以动态地统一来自不同数据源的数据，并将数据规范化到您选择的目的地。为各种高级下游分析和可视化用例清理和民主化所有数据。虽然 <code>Logstash</code>  最初推动了日志收集方面的创新，但它的功能远远超出了这个用例。任何类型的事件都可以通过大量的输入、过滤和输出插件来丰富和转换，并且使用许多本地编解码器进一步简化了吸收过程。</p>\n<h3 id=\"下载-2\"><a class=\"markdownIt-Anchor\" href=\"#下载-2\">#</a> 下载</h3>\n<p>可以在  <code>https://www.elastic.co/cn/downloads/logstash</code>  页面上下载所需的 安装包。进行解压。</p>\n<p>后面我们会专门介绍 logStash 的使用。 这里就不过多介绍了。</p>\n<p>至此，我们了解了著名的  <code>ELK</code>  日志收集处理套装。</p>\n<h2 id=\"beats\"><a class=\"markdownIt-Anchor\" href=\"#beats\">#</a> Beats</h2>\n<p><code>Beats</code>  是您作为代理安装在服务器上的开源数据发送者，用于将运营数据发送到 <code>Elasticsearch</code> 。其提供了数据审核，日志文件，云数据，可用性，系统日志，指标，网络流量， <code>Windows</code>  事件记录等功能。 <code>Beats</code>  可以将数据直接发送到 <code>Elasticsearch</code>  或通过 <code>Logstash</code>  发送，您可以在此处进一步处理和增强数据，然后再在 <code>Kibana</code>  中进行可视化。<br>\n <code>beats</code>  为不同的功能，提供了不同的组件，可以根据自己的需求，安装特定的产品，这里不多介绍。</p>\n<h2 id=\"其他\"><a class=\"markdownIt-Anchor\" href=\"#其他\">#</a> 其他</h2>\n<p>除了  <code>ElasticSearch</code> ,  <code>logStash</code> ,  <code>kibana</code> ,  <code>Beats</code>  之外， <code>Elastic</code>  还提供了其他的产品，比如： <code>APM Server</code> ,  <code>ElasticSearch Hoop</code> 。 可以根据自己的兴趣进行学习。</p>\n<p>在后面的一段时间里，我们常用到的是  <code>ElasticSearch</code>  和  <code>Kibana</code>  . 所以将这两个软件安装好就可以啦。</p>\n<h2 id=\"最后\"><a class=\"markdownIt-Anchor\" href=\"#最后\">#</a> 最后</h2>\n<p>期望与你一起遇见更好的自己</p>\n<p><img data-src=\"/images/qrcode.jpg\" alt=\"期望与你一起遇见更好的自己\"></p>\n",
            "tags": [
                "Elastic Search",
                "搜索"
            ]
        },
        {
            "id": "https://fangjiaxiaobai.github.io/2021/08/31/es-series/01.ES%E7%AE%80%E4%BB%8B/",
            "url": "https://fangjiaxiaobai.github.io/2021/08/31/es-series/01.ES%E7%AE%80%E4%BB%8B/",
            "title": "Elastic Search简介",
            "date_published": "2021-08-31T06:28:55.000Z",
            "content_html": "<h1 id=\"elasticsearch简介\"><a class=\"markdownIt-Anchor\" href=\"#elasticsearch简介\">#</a> Elasticsearch 简介</h1>\n<p><code>Elasticsearch</code>  是一个开源的分布式  <code>RESTful</code>  <b>搜索</b>和<b>分析</b>引擎，能够解决越来越多不同的应用场景。<br>\n <code>Elasticsearch</code>  是一个高度可扩展的开源分布式全文本搜索和分析引擎。 它使您可以快速，近乎实时地存储，搜索和分析大量数据。 它通常用作支持具有复杂搜索功能和要求的应用程序的基础引擎 / 技术。提供了丰富的  <code>RESTful</code>  API.</p>\n<p>这里 特别记住 <b>搜索</b>  和 <b>分析</b> 这两个词，后面我们花大量篇幅去学习  <code>ES</code>  的这两个功能，体验  <code>ES</code>  的强大之处。</p>\n<h1 id=\"es发展历史\"><a class=\"markdownIt-Anchor\" href=\"#es发展历史\">#</a> ES 发展历史</h1>\n<h2 id=\"2010年2月-第一次发布\"><a class=\"markdownIt-Anchor\" href=\"#2010年2月-第一次发布\">#</a> 2010 年 2 月 第一次发布</h2>\n<h2 id=\"2014年1月-发布了10版本\"><a class=\"markdownIt-Anchor\" href=\"#2014年1月-发布了10版本\">#</a> 2014 年 1 月 发布了 1.0 版本</h2>\n<h2 id=\"2015年10月发布20版本\"><a class=\"markdownIt-Anchor\" href=\"#2015年10月发布20版本\">#</a> 2015 年 10 月，发布 2.0 版本</h2>\n<h2 id=\"2016年10月发布50版本\"><a class=\"markdownIt-Anchor\" href=\"#2016年10月发布50版本\">#</a> 2016 年 10 月，发布 5.0 版本</h2>\n<ul>\n<li>支持 lucene 6.x. 性能提升。默认打分机制从 TF-IDF 改为 BM25</li>\n<li>支持 Ingest 节点 / Painless Scripting / Completion Suggested 支持 / 原生的 Java Rest 客户端</li>\n<li>Type 标记为 deprecated , 支持 keyword 的类型</li>\n<li>性能优化\n<ul>\n<li>内部引擎移除了避免同一文档并发更新的竞争锁，带来了 15%-20% 的性能提升</li>\n<li>Instant Aggregation ，支持分片上聚合的缓存</li>\n<li>新增了 Profile API</li>\n</ul>\n</li>\n</ul>\n<h2 id=\"2017年10月-发布60版本\"><a class=\"markdownIt-Anchor\" href=\"#2017年10月-发布60版本\">#</a> 2017 年 10 月， 发布 6.0 版本</h2>\n<ul>\n<li>支持 Lucence 7.x 版本</li>\n<li>新增功能：跨集群复制，索引生命周期管理，SQL 的支持</li>\n<li>更友好的升级和数据迁移：在主要版本之间的迁移更为简化，体验升级。 全新的基于操作的数据复制框架，可以加快数据恢复。</li>\n<li>性能优化：有效存储稀疏字段的新方法，降低了存储成本。 在索引时进行排序，可以加快排序的查询性能。</li>\n</ul>\n<h2 id=\"2019年4月发布70版本\"><a class=\"markdownIt-Anchor\" href=\"#2019年4月发布70版本\">#</a> 2019 年 4 月，发布 7.0 版本</h2>\n<ul>\n<li>支持  <code>Lucene 8.0</code>  版本</li>\n<li>重大改进 - 正式废除单个索引下多个 Type 的支持</li>\n<li><code>7.1</code>  开始， <code>Security</code>  功能免费使用</li>\n<li><code>ECK</code>  - 支持 <code>Elasticsearch operator on kubernetes</code></li>\n<li>新功能:  <code>New Cluster Coordination</code> ,  <code>Feature-Complete High Level Rest Client</code> ,  <code>Script Score Query</code></li>\n<li>性能优化：默认的 <code>Primary Shard</code>  数从 <code>5</code>  改为 <code>1</code> ，避免 <code>Over Sharding</code> . 性能优化，更快的 <code>Top K</code></li>\n</ul>\n<h2 id=\"2020年12月-发布了710版本\"><a class=\"markdownIt-Anchor\" href=\"#2020年12月-发布了710版本\">#</a> 2020 年 12 月 发布了 7.10 版本</h2>\n<ol>\n<li><code>ES</code>  的索引速度提升了 <code>20%</code> 。</li>\n<li>我们重新引入了时间点 ( <code>pit</code> )，这是一种保存搜索索引状态的轻量级方法。凹坑通过使 ui 更具反应性来改善最终用户体验。</li>\n<li>默认情况下，我们使大多数 EQL 运算符和函数区分大小写。 我们还添加了：，一个新的不区分大小写的 <code>equal</code>  运算符。 专为安全用例而设计</li>\n<li><code>REST API</code>  对系统索引的访问已弃用</li>\n<li>系统索引的新线程池。添加了两个新的线程池： <code>system_read和system_write</code> 。 这些线程池可确保对 <code>Elastic Stack</code>  至关重要的系统索引（例如安全性或 Kibana 所使用的系统索引）在集群承受沉重的查询或索引负载时保持响应能力。 <code>system_read</code>  是固定线程池，用于管理针对系统索引的读取操作的资源。 同样， <code>system_write</code>  是一个固定线程池，用于管理用于针对系统索引的写操作的资源。 两者的最大线程数等于可用处理器的 5 或一半，以较小者为准。</li>\n</ol>\n<h1 id=\"es的生态圈\"><a class=\"markdownIt-Anchor\" href=\"#es的生态圈\">#</a> ES 的生态圈</h1>\n<h2 id=\"elastic-search\"><a class=\"markdownIt-Anchor\" href=\"#elastic-search\">#</a> elastic search</h2>\n<p><code>Elasticsearch</code>  是 <code>Elastic Stack</code>  核心的分布式搜索和分析引擎。  <code>Logstash</code>  和   有助于收集，聚合和丰富您的数据并将其存储在 <code>Elasticsearch</code>  中。 使用  ，您可以交互式地探索，可视化和共享对数据的见解，并管理和监视堆栈。  <code>Elasticsearch</code>  是发生索引，搜索和分析 魔力的地方。</p>\n<p><code>Elasticsearch</code>  为所有类型的数据提供近乎实时的搜索和分析。 无论您是结构化文本还是非结构化文本，数字数据或地理空间数据， <code>Elasticsearch</code>  都能以支持快速搜索的方式有效地对其进行存储和索引。 您不仅可以进行简单的数据检索，还可以聚合信息来发现数据中的趋势和模式。 随着数据和查询量的增长， <code>Elasticsearch</code>  的分布式特性使您的部署可以随之无缝地增长。</p>\n<h2 id=\"kibana\"><a class=\"markdownIt-Anchor\" href=\"#kibana\">#</a> kibana</h2>\n<p><code>Kibana</code>  是一个开源的分析和可视化平台。使用 <code>Kibana</code>  来探索你的 <code>Elasticsearch</code>  数据，然后建立漂亮的可视化和仪表板。<br>\n <code>Kibana</code>  具有管理弹性栈的 UI。管理您的安全设置，分配用户角色，拍摄快照，卷起您的数据，以及更多，都从一个 <code>Kibana UI</code>  的便利。<br>\n <code>Elastic</code>  栈解决方案的集中式中心。从日志分析到文档发现.</p>\n<h2 id=\"beats\"><a class=\"markdownIt-Anchor\" href=\"#beats\">#</a> beats</h2>\n<p><code>Beats</code>  是您作为代理安装在服务器上的开源数据发送者，用于将运营数据发送到 <code>Elasticsearch</code> 。其提供了数据审核，日志文件，云数据，可用性，系统日志，指标，网络流量， <code>Windows</code>  事件记录等功能。 <code>Beats</code>  可以将数据直接发送到 <code>Elasticsearch</code>  或通过 <code>Logstash</code>  发送，您可以在此处进一步处理和增强数据，然后再在 Kibana 中进行可视化。<br>\n <code>beats</code>  为不同的功能，提供了不同的组件，可以根据自己的需求，安装特定的产品.</p>\n<h2 id=\"logstash\"><a class=\"markdownIt-Anchor\" href=\"#logstash\">#</a> logstash</h2>\n<p><code>Logstash</code>  是一个具有实时管道功能的开源数据收集引擎。 <code>Logstash</code>  可以动态地统一来自不同数据源的数据，并将数据规范化到您选择的目的地。为各种高级下游分析和可视化用例清理和民主化所有数据。虽然 <code>Logstash</code>  最初推动了日志收集方面的创新，但它的功能远远超出了这个用例。任何类型的事件都可以通过大量的输入、过滤和输出插件来丰富和转换，并且使用许多本地编解码器进一步简化了吸收过程。</p>\n<h2 id=\"x-pack\"><a class=\"markdownIt-Anchor\" href=\"#x-pack\">#</a> x-pack</h2>\n<p><code>x-pack</code>  是 <code>elasticsearch</code>  的一个扩展包，将安全，警告，监视，图形和报告功能捆绑在一个易于安装的软件包中，可以轻松的启用或者关闭一些功能</p>\n<h1 id=\"es的应用场景\"><a class=\"markdownIt-Anchor\" href=\"#es的应用场景\">#</a> ES 的应用场景</h1>\n<ul>\n<li>将搜索框添加到应用或网站</li>\n<li>存储和分析日志，指标和安全事件数据</li>\n<li>使用机器学习来实时自动建模数据行为</li>\n<li>使用 <code>Elasticsearch</code>  作为存储引擎自动化业务工作流程</li>\n<li>使用 <code>Elasticsearch</code>  作为地理信息系统（ <code>GIS</code> ）管理，集成和分析空间信息</li>\n<li>使用 <code>Elasticsearch</code>  作为生物信息学研究工具来存储和处理遗传数据<br>\n…</li>\n</ul>\n<h2 id=\"最后\"><a class=\"markdownIt-Anchor\" href=\"#最后\">#</a> 最后</h2>\n<p>期望与你一起遇见更好的自己</p>\n<p><img data-src=\"/images/qrcode.jpg\" alt=\"期望与你一起遇见更好的自己\"></p>\n",
            "tags": [
                "Elastic Search",
                "搜索"
            ]
        },
        {
            "id": "https://fangjiaxiaobai.github.io/2021/08/31/es-series/README/",
            "url": "https://fangjiaxiaobai.github.io/2021/08/31/es-series/README/",
            "title": "Elastic Search 目录",
            "date_published": "2021-08-31T06:20:55.000Z",
            "content_html": "<h2 id=\"搜索之es系列\"><a class=\"markdownIt-Anchor\" href=\"#搜索之es系列\">#</a> 搜索之 ES 系列</h2>\n<p>本系列基于版本 7.10</p>\n<h2 id=\"目录\"><a class=\"markdownIt-Anchor\" href=\"#目录\">#</a> 目录</h2>\n<ul class=\"task-list\">\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"cbx_0\" checked=\"true\" disabled=\"true\"><label for=\"cbx_0\"> <a href=\"/2021/08/31/es-series/01.ES%E7%AE%80%E4%BB%8B/\">ES 简介</a></label>\n<ul class=\"task-list\">\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"cbx_1\" checked=\"true\" disabled=\"true\"><label for=\"cbx_1\"> ES 发展历史</label></li>\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"cbx_2\" checked=\"true\" disabled=\"true\"><label for=\"cbx_2\"> ES 的生态圈</label></li>\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"cbx_3\" checked=\"true\" disabled=\"true\"><label for=\"cbx_3\"> ES 的应用场景</label></li>\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"cbx_4\" checked=\"true\" disabled=\"true\"><label for=\"cbx_4\"> 使用架构</label></li>\n</ul>\n</li>\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"cbx_5\" checked=\"true\" disabled=\"true\"><label for=\"cbx_5\"> <a href=\"/2021/08/31/es-series/02.ES%E5%AE%89%E8%A3%85/\">ES 栈安装</a></label>\n<ul class=\"task-list\">\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"cbx_6\" checked=\"true\" disabled=\"true\"><label for=\"cbx_6\"> ElasticSearch 安装</label>\n<ul class=\"task-list\">\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"cbx_7\" checked=\"true\" disabled=\"true\"><label for=\"cbx_7\"> 下载</label></li>\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"cbx_8\" checked=\"true\" disabled=\"true\"><label for=\"cbx_8\"> 文件目录结构，JVM 配置，</label></li>\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"cbx_9\" checked=\"true\" disabled=\"true\"><label for=\"cbx_9\"> 多实例运行</label></li>\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"cbx_10\" checked=\"true\" disabled=\"true\"><label for=\"cbx_10\"> 常用命令</label></li>\n</ul>\n</li>\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"cbx_11\" checked=\"true\" disabled=\"true\"><label for=\"cbx_11\"> kibana 安装</label>\n<ul class=\"task-list\">\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"cbx_12\" checked=\"true\" disabled=\"true\"><label for=\"cbx_12\"> 安装</label></li>\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"cbx_13\" checked=\"true\" disabled=\"true\"><label for=\"cbx_13\"> 页面浏览 devTool</label></li>\n</ul>\n</li>\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"cbx_14\" checked=\"true\" disabled=\"true\"><label for=\"cbx_14\"> logstash 安装</label></li>\n</ul>\n</li>\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"cbx_15\" checked=\"true\" disabled=\"true\"><label for=\"cbx_15\"> <a href=\"/2021/08/31/es-series/03.ES%E9%85%8D%E7%BD%AE/\">ElasticSearch 配置</a></label></li>\n</ul>\n<h3 id=\"入门\"><a class=\"markdownIt-Anchor\" href=\"#入门\">#</a> 入门</h3>\n<ul class=\"task-list\">\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"cbx_16\" checked=\"true\" disabled=\"true\"><label for=\"cbx_16\"> <a href=\"/2021/08/31/es-series/04.ES%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5/\">基本概念</a></label>\n<ul class=\"task-list\">\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"cbx_17\" checked=\"true\" disabled=\"true\"><label for=\"cbx_17\"> 文档</label>\n<ul class=\"task-list\">\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"cbx_18\" checked=\"true\" disabled=\"true\"><label for=\"cbx_18\"> 元数据 (mapping)</label></li>\n</ul>\n</li>\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"cbx_19\" checked=\"true\" disabled=\"true\"><label for=\"cbx_19\"> 索引</label>\n<ul class=\"task-list\">\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"cbx_20\" checked=\"true\" disabled=\"true\"><label for=\"cbx_20\"> 概念</label></li>\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"cbx_21\" checked=\"true\" disabled=\"true\"><label for=\"cbx_21\"> 语意</label></li>\n</ul>\n</li>\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"cbx_22\" checked=\"true\" disabled=\"true\"><label for=\"cbx_22\"> <del>Type</del></label></li>\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"cbx_23\" disabled=\"true\"><label for=\"cbx_23\"> 节点</label>\n<ul class=\"task-list\">\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"cbx_24\" disabled=\"true\"><label for=\"cbx_24\"> master 节点</label></li>\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"cbx_25\" disabled=\"true\"><label for=\"cbx_25\"> data 节点</label></li>\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"cbx_26\" disabled=\"true\"><label for=\"cbx_26\"> ingist 节点</label></li>\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"cbx_27\" disabled=\"true\"><label for=\"cbx_27\"> coordinating 节点</label></li>\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"cbx_28\" disabled=\"true\"><label for=\"cbx_28\"> 其他类型节点: hot&amp;warm 节点，Machine Learning Node , Tribe 节点 (未来版本会被移除)</label></li>\n</ul>\n</li>\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"cbx_29\" checked=\"true\" disabled=\"true\"><label for=\"cbx_29\"> 分片</label></li>\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"cbx_30\" checked=\"true\" disabled=\"true\"><label for=\"cbx_30\"> 集群</label></li>\n</ul>\n</li>\n</ul>\n<h3 id=\"进阶\"><a class=\"markdownIt-Anchor\" href=\"#进阶\">#</a> 进阶</h3>\n<ul class=\"task-list\">\n<li class=\"task-list-item\">\n<p><input type=\"checkbox\" id=\"cbx_31\" disabled=\"true\"><label for=\"cbx_31\"> 索引</label></p>\n<ul class=\"task-list\">\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"cbx_32\" disabled=\"true\"><label for=\"cbx_32\"> 常用 api (索引管理)</label></li>\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"cbx_33\" disabled=\"true\"><label for=\"cbx_33\"> 基本原理</label></li>\n</ul>\n</li>\n<li class=\"task-list-item\">\n<p><input type=\"checkbox\" id=\"cbx_34\" disabled=\"true\"><label for=\"cbx_34\"> 文档</label></p>\n<ul class=\"task-list\">\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"cbx_35\" disabled=\"true\"><label for=\"cbx_35\"> 文档管理</label>\n<ul class=\"task-list\">\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"cbx_36\" disabled=\"true\"><label for=\"cbx_36\"> 简单 CURD</label></li>\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"cbx_37\" disabled=\"true\"><label for=\"cbx_37\"> bulk api</label></li>\n</ul>\n</li>\n</ul>\n</li>\n<li>\n<p>分词器</p>\n<ul class=\"task-list\">\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"cbx_38\" disabled=\"true\"><label for=\"cbx_38\"> 分词器类型</label></li>\n</ul>\n</li>\n<li class=\"task-list-item\">\n<p><input type=\"checkbox\" id=\"cbx_39\" disabled=\"true\"><label for=\"cbx_39\"> 其他 api</label></p>\n<ul class=\"task-list\">\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"cbx_40\" disabled=\"true\"><label for=\"cbx_40\"> 查看集群，分片，索引</label></li>\n</ul>\n</li>\n</ul>\n<h3 id=\"高手\"><a class=\"markdownIt-Anchor\" href=\"#高手\">#</a> 高手</h3>\n<ul class=\"task-list\">\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"cbx_41\" disabled=\"true\"><label for=\"cbx_41\"> 聚合分析搜索</label></li>\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"cbx_42\" disabled=\"true\"><label for=\"cbx_42\"> cat API</label></li>\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"cbx_43\" disabled=\"true\"><label for=\"cbx_43\"> cluster API</label></li>\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"cbx_44\" disabled=\"true\"><label for=\"cbx_44\"> ccr API</label></li>\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"cbx_45\" disabled=\"true\"><label for=\"cbx_45\"> data Stream API</label></li>\n</ul>\n<h3 id=\"宗师\"><a class=\"markdownIt-Anchor\" href=\"#宗师\">#</a> 宗师</h3>\n<ul class=\"task-list\">\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"cbx_46\" disabled=\"true\"><label for=\"cbx_46\"> 补货中…</label></li>\n</ul>\n<h3 id=\"运维\"><a class=\"markdownIt-Anchor\" href=\"#运维\">#</a> 运维</h3>\n<ul class=\"task-list\">\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"cbx_47\" disabled=\"true\"><label for=\"cbx_47\"> 补货中…</label></li>\n</ul>\n",
            "tags": [
                "Elastic Search",
                "搜索"
            ]
        },
        {
            "id": "https://fangjiaxiaobai.github.io/2021/08/29/LeetCode/002-%E5%8F%8D%E8%BD%AC%E9%93%BE%E8%A1%A8/",
            "url": "https://fangjiaxiaobai.github.io/2021/08/29/LeetCode/002-%E5%8F%8D%E8%BD%AC%E9%93%BE%E8%A1%A8/",
            "title": "LC:反转链表I",
            "date_published": "2021-08-29T09:25:55.000Z",
            "content_html": "<h2 id=\"题目\"><a class=\"markdownIt-Anchor\" href=\"#题目\">#</a> 题目</h2>\n<p>给你单链表的头节点  <code>head</code>  ，请你反转链表，并返回反转后的链表。</p>\n<blockquote>\n<p>示例一</p>\n</blockquote>\n<p><img data-src=\"/images/ac-code/reverseLinkedList1/reverseLinkedListCase1.jpeg\" alt=\"\"></p>\n<p>输入：head = [1,2,3,4,5]<br>\n 输出：[5,4,3,2,1]</p>\n<blockquote>\n<p>示例二</p>\n</blockquote>\n<p><img data-src=\"/images/ac-code/reverseLinkedList1/reverseLinkedListCase2.jpeg\" alt=\"\"></p>\n<p>输入：head = [1,2]<br>\n 输出：[2,1]</p>\n<blockquote>\n<p>示例三</p>\n</blockquote>\n<p>输入：head = []<br>\n 输出：[]</p>\n<p>提示：</p>\n<p>链表中节点的数目范围是 [0, 5000]<br>\n-5000 &lt;= Node.val &lt;= 5000</p>\n<p>进阶：链表可以选用迭代或递归方式完成反转。你能否用两种方法解决这道题？</p>\n<div class=\"links\"><div class=\"item\" title=\"力扣（LeetCode）206.反转链表\" style=\"--block-color:#ffa015;\"><span class=\"exturl image\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvcmV2ZXJzZS1saW5rZWQtbGlzdA==\" data-background-image=\"https://static.leetcode-cn.com/cn-frontendx-assets/production/_next/static/images/lccn-logo-ce3d56eeedaae618e59e2ec5089e4834.svg\"></span>\n          <div class=\"info\">\n          <span class=\"exturl title\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvcmV2ZXJzZS1saW5rZWQtbGlzdA==\">力扣（LeetCode）206.反转链表</span>\n          <p class=\"desc\">https://leetcode-cn.com/</p>\n          </div></div></div>\n<h2 id=\"分析\"><a class=\"markdownIt-Anchor\" href=\"#分析\">#</a> 分析</h2>\n<p>这是一道非常简单的题目。也是很容易出现<span class=\"exturl\" data-url=\"aHR0cHM6Ly9iYWlrZS5iYWlkdS5jb20vaXRlbS8lRTglQkUlQkUlRTUlODUlOEIlRTYlOTUlODglRTUlQkElOTQvNTYzOTE3OA==\">达克效应</span>的一道题目。 为什么呢？应为这道题太简单了啊。 <b>思路</b> 太简单了啊。 但是真正去写的话，可不见得真有那么简单。</p>\n<p>简单的题目，我们还是 以图的形式来展示。</p>\n<h3 id=\"思路一-迭代链表-创建新节点重组成新链表\"><a class=\"markdownIt-Anchor\" href=\"#思路一-迭代链表-创建新节点重组成新链表\">#</a> 思路一：迭代链表，创建新节点，重组成新链表</h3>\n<h4 id=\"思路解析\"><a class=\"markdownIt-Anchor\" href=\"#思路解析\">#</a> 思路解析</h4>\n<p><img data-src=\"/images/ac-code/reverseLinkedList1/solution1.png\" alt=\"一图胜千言\"></p>\n<p>核心思路如标题。 首先将遍历的原链表中的节点值复制到新建的节点中 (a 步骤), 节点 next 指针指向是上一个节点，没有则为 null (b 步骤). 遍历链表的所有节点。</p>\n<p>这样其实会生成一个新的链表。也就说会同时存在两条链表。</p>\n<p><span class=\"label success\">✊时间复杂度为 O (n)， 空间复杂度为 O (n)</span></p>\n<h4 id=\"代码实现\"><a class=\"markdownIt-Anchor\" href=\"#代码实现\">#</a> 代码实现</h4>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Solution</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> ListNode <span class=\"title\">reverseList</span><span class=\"params\">(ListNode head)</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// 非空判断</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (<span class=\"keyword\">null</span> == head || <span class=\"keyword\">null</span> == head.next) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> head;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// 遍历旧链表,新建节点，并且拼接成新链表。</span></span><br><span class=\"line\">        ListNode pre = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">        <span class=\"keyword\">while</span> (<span class=\"keyword\">null</span> != head) &#123;</span><br><span class=\"line\">            ListNode curr = <span class=\"keyword\">new</span> ListNode(head.val);</span><br><span class=\"line\">            curr.next = pre;</span><br><span class=\"line\">            pre = curr;</span><br><span class=\"line\">            head = head.next;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> pre;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"思路二-迭代变更链表的指针指向\"><a class=\"markdownIt-Anchor\" href=\"#思路二-迭代变更链表的指针指向\">#</a> 思路二：迭代变更链表的指针指向</h3>\n<h4 id=\"思路解析-2\"><a class=\"markdownIt-Anchor\" href=\"#思路解析-2\">#</a> 思路解析</h4>\n<p>这种思路也是比较简单的，但是一定要想好喽之后，再看开始编码，要不然很容易思绪错乱。</p>\n<p>图解:</p>\n<p><img data-src=\"/images/ac-code/reverseLinkedList1/solution2.png\" alt=\"一图胜千言\"></p>\n<p>这种解法需要两个指针， pre 代表其前一个节点， cur 代表后一个节点。进行遍历，从而实现 指针指向的变更。 当然，还需要一个临时节点去帮忙 pre 和 cur 指针，向后移动。</p>\n<p><span class=\"label success\">✊时间复杂度是 O (n); 空间复杂度是 O (3);</span></p>\n<h4 id=\"代码实现-2\"><a class=\"markdownIt-Anchor\" href=\"#代码实现-2\">#</a> 代码实现</h4>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Solution2</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> ListNode <span class=\"title\">reverseList</span><span class=\"params\">(ListNode head)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"comment\">// 非空判断</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (<span class=\"keyword\">null</span> == head || <span class=\"keyword\">null</span> == head.next) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> head;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        ListNode pre = head, cur = head.next;</span><br><span class=\"line\">        <span class=\"comment\">// !!注意:断开头节点的next指针，避免产生环型链表。</span></span><br><span class=\"line\">        pre.next = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">        <span class=\"keyword\">while</span> (<span class=\"keyword\">null</span> != cur) &#123;</span><br><span class=\"line\">            ListNode tempNode = cur.next;</span><br><span class=\"line\">            cur.next = pre;</span><br><span class=\"line\">            pre = cur;</span><br><span class=\"line\">            cur = tempNode;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> pre;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"思路三-递归方式-变更指针\"><a class=\"markdownIt-Anchor\" href=\"#思路三-递归方式-变更指针\">#</a> 思路三：递归方式， 变更指针</h3>\n<h4 id=\"思路解析-3\"><a class=\"markdownIt-Anchor\" href=\"#思路解析-3\">#</a> 思路解析</h4>\n<p>这思路三，其实是思路二的不同写法。 这种实现方法首先就需要将 链表 “递” 到底，然后在归的时候，把 节点链接到一起。如下图</p>\n<p><img data-src=\"/images/ac-code/reverseLinkedList1/solution3.png\" alt=\"一图胜千言\"></p>\n<p>这样说起来，递归这种方式来解决反转类的问题好像会有一种与生俱来的优势。  <code>首先递进去，然后归出来</code> 。</p>\n<h4 id=\"代码实现-3\"><a class=\"markdownIt-Anchor\" href=\"#代码实现-3\">#</a> 代码实现</h4>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Solution3</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> ListNode <span class=\"title\">reverseList</span><span class=\"params\">(ListNode head)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"comment\">// 非空判断</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (<span class=\"keyword\">null</span> == head || <span class=\"keyword\">null</span> == head.next) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> head;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// 递归入口</span></span><br><span class=\"line\">        <span class=\"keyword\">return</span> reverse(head, <span class=\"keyword\">null</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> ListNode <span class=\"title\">reverse</span><span class=\"params\">(ListNode currNode, ListNode preNode)</span> </span>&#123;</span><br><span class=\"line\">        ListNode headNode = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (<span class=\"keyword\">null</span> == currNode) &#123;</span><br><span class=\"line\">            headNode = preNode;</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">            headNode = reverse(currNode.next, currNode);</span><br><span class=\"line\">            currNode.next = preNode;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> headNode;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"思考\"><a class=\"markdownIt-Anchor\" href=\"#思考\">#</a> 思考</h2>\n<p>这一道题考的是简单的逻辑问题，实属简单至极的题目。要注意 陷入 “达克效应”。</p>\n<p>勿以题小而不做。</p>\n<p>使用头递归来做反转类似的题目，好像是一种天然支持的特性。但是在实际的开发过程中，不建议过多的使用递归的方式，一方面不具备可读性。另一方面，递归方式对性能不太优化，还有重要的是要考虑栈溢出的风险。</p>\n<h2 id=\"相关题目\"><a class=\"markdownIt-Anchor\" href=\"#相关题目\">#</a> 相关题目</h2>\n<div class=\"links\"><div class=\"item\" title=\"力扣（LeetCode）189.反转数组\" style=\"--block-color:#ffa015;\"><span class=\"exturl image\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvcm90YXRlLWFycmF5\" data-background-image=\"https://static.leetcode-cn.com/cn-frontendx-assets/production/_next/static/images/lccn-logo-ce3d56eeedaae618e59e2ec5089e4834.svg\"></span>\n          <div class=\"info\">\n          <span class=\"exturl title\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvcm90YXRlLWFycmF5\">力扣（LeetCode）189.反转数组</span>\n          <p class=\"desc\">https://leetcode-cn.com/</p>\n          </div></div><div class=\"item\" title=\"力扣（LeetCode）92.反转链表II\" style=\"--block-color:#ffa015;\"><span class=\"exturl image\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvcmV2ZXJzZS1saW5rZWQtbGlzdC1paS8=\" data-background-image=\"https://static.leetcode-cn.com/cn-frontendx-assets/production/_next/static/images/lccn-logo-ce3d56eeedaae618e59e2ec5089e4834.svg\"></span>\n          <div class=\"info\">\n          <span class=\"exturl title\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvcmV2ZXJzZS1saW5rZWQtbGlzdC1paS8=\">力扣（LeetCode）92.反转链表II</span>\n          <p class=\"desc\">https://leetcode-cn.com/</p>\n          </div></div><div class=\"item\" title=\"力扣（LeetCode）7.整数反转\" style=\"--block-color:#ffa015;\"><span class=\"exturl image\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvcmV2ZXJzZS1pbnRlZ2VyLw==\" data-background-image=\"https://static.leetcode-cn.com/cn-frontendx-assets/production/_next/static/images/lccn-logo-ce3d56eeedaae618e59e2ec5089e4834.svg\"></span>\n          <div class=\"info\">\n          <span class=\"exturl title\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvcmV2ZXJzZS1pbnRlZ2VyLw==\">力扣（LeetCode）7.整数反转</span>\n          <p class=\"desc\">https://leetcode-cn.com/</p>\n          </div></div><div class=\"item\" title=\"力扣（LeetCode）344.反转字符串\" style=\"--block-color:#ffa015;\"><span class=\"exturl image\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvcmV2ZXJzZS1zdHJpbmcv\" data-background-image=\"https://static.leetcode-cn.com/cn-frontendx-assets/production/_next/static/images/lccn-logo-ce3d56eeedaae618e59e2ec5089e4834.svg\"></span>\n          <div class=\"info\">\n          <span class=\"exturl title\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvcmV2ZXJzZS1zdHJpbmcv\">力扣（LeetCode）344.反转字符串</span>\n          <p class=\"desc\">https://leetcode-cn.com/</p>\n          </div></div></div>\n<h2 id=\"最后\"><a class=\"markdownIt-Anchor\" href=\"#最后\">#</a> 最后</h2>\n<p>期望与你一起遇见更好的自己</p>\n<p><img data-src=\"/images/qrcode.jpg\" alt=\"期望与你一起遇见更好的自己\"></p>\n",
            "tags": [
                "leetCode",
                "数据结构",
                "链表",
                "面经之算法题"
            ]
        },
        {
            "id": "https://fangjiaxiaobai.github.io/2021/08/23/java%E7%B3%BB%E5%88%97/JDK/stream/Stream-basic/",
            "url": "https://fangjiaxiaobai.github.io/2021/08/23/java%E7%B3%BB%E5%88%97/JDK/stream/Stream-basic/",
            "title": "JDK的Stream之系列一 初窥流原理",
            "date_published": "2021-08-23T15:13:55.000Z",
            "content_html": "<p>学东西的时候最好是理论先行，为什么？没有理论，想当然的去干，干好了是 瞎猫碰上死耗子，干不好就瞎干，浪费时间，只会弄得身心俱疲。<br>\n可是在真正的工作中，很少工作会允许你先弄清原理再去实操。但是不管怎么说，欠下的债终究是需要还的。</p>\n<p>今天咱们的主题是  <code>stream</code> . 咱们就从 <code>Stream</code>  的 &quot;道，术，法，器&quot; 四个阶段来聊好好的聊聊这个  <code>Stream</code> .</p>\n<h2 id=\"以器始从使用开始\"><a class=\"markdownIt-Anchor\" href=\"#以器始从使用开始\">#</a> 以 &quot;器&quot; 始：从使用开始</h2>\n<blockquote>\n<p>你平时是怎么使用  <code>Stream</code>  的？</p>\n</blockquote>\n<p>比如我会使用 <code>Stream</code>  创建一个流。</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Stream&lt;Integer&gt; integerStream = Stream.of(<span class=\"number\">1</span>, <span class=\"number\">2</span>, <span class=\"number\">3</span>);</span><br><span class=\"line\"><span class=\"comment\">// do somethings ..</span></span><br></pre></td></tr></table></figure>\n<p>或者把一种集合类型转成 <code>stream</code> ，然后做一些聚合操作</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">List&lt;Integer&gt; collect = list.stream()</span><br><span class=\"line\">        .map(item -&gt; item + <span class=\"number\">5</span>)</span><br><span class=\"line\">        .filter(item -&gt; item &gt; <span class=\"number\">10</span>)</span><br><span class=\"line\">        .sorted()</span><br><span class=\"line\">        .limit(<span class=\"number\">10</span>)</span><br><span class=\"line\">        .collect(Collectors.toList());</span><br></pre></td></tr></table></figure>\n<p>那在 <code>jdk1.7</code>  及以前的时候，我们是怎么处理的呢？</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// 遍历list，所有元素+5</span></span><br><span class=\"line\"><span class=\"keyword\">for</span> (<span class=\"keyword\">int</span> i = <span class=\"number\">0</span>; i &lt; list.size(); i++) &#123;</span><br><span class=\"line\">    Integer integer = list.get(i);</span><br><span class=\"line\">    integer += <span class=\"number\">5</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 正序排序</span></span><br><span class=\"line\">sort(list);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 创建新List.存储10个元素</span></span><br><span class=\"line\">List&lt;Integer&gt; newList = <span class=\"keyword\">new</span> ArrayList&lt;&gt;();</span><br><span class=\"line\"><span class=\"keyword\">if</span> (list.size() &gt; <span class=\"number\">10</span>) &#123;</span><br><span class=\"line\">    System.arraycopy(list, list.size() - <span class=\"number\">11</span>, newList, <span class=\"number\">0</span>, <span class=\"number\">10</span>);</span><br><span class=\"line\">&#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">    System.arraycopy(list, <span class=\"number\">0</span>, newList, <span class=\"number\">0</span>, list.size());</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>根据上面的对比，我们很明显的就能对比出来：<br>\n <code>stream</code>  的编码方式，使代码更加简洁，可读性也比较强。而且 <code>Stream</code>  提供了集合的常用操作，比如 <code>sort</code> , <code>过滤</code> ， <code>去重</code> ， <code>计数</code> ， <code>limit</code> , <code>skip</code>  等等，直接可以用，可以大大的提高开发效率。</p>\n<p>那  <code>Stream</code>  为我们提供了多少功能呢？</p>\n<p>从全局来看，所有和  <code>stream</code>  相关的类，都在  <code>java.lang.stream</code>  这包下。</p>\n<p>这个包下有很多的类。总体来说，</p>\n<p>流处理相关的操作分为两类:</p>\n<ul>\n<li>中间操作 ( <code>Intermediate Operations</code> )\n<ul>\n<li>无状态的中间操作 ( <code>Stateless</code> ): 使用  <code>StatelessOp</code>  表示。每个操作都是互不影响，不依赖的。这类的操作有:  <code>filter()</code> 、 <code>flatMap()</code> 、 <code>flatMapToDouble()</code> 、 <code>flatMapToInt()</code> 、 <code>flatMapToLong()</code> 、 <code>map()</code> 、 <code>mapToDouble()</code> 、 <code>mapToInt()</code> 、 <code>mapToLong()</code> 、 <code>peek()</code> 、 <code>unordered()</code>  等</li>\n<li>有状态操作（ <code>Stateful</code> ）：使用  <code>StatefulOp</code>  表示。处理时会记录状态，比如处理了几个。后面元素的处理会依赖前面记录的状态，或者拿到所有元素才能继续下去。如 <code>distinct()</code> 、 <code>sorted()</code> 、 <code>sorted(comparator)</code> 、 <code>limit()</code> 、 <code>skip()</code>  等</li>\n</ul>\n</li>\n<li>终止操作 ( <code>Terminal Operations</code> )：使用  <code>TerminalOp</code>  表示。\n<ul>\n<li>非短路操作：处理完所有数据才能得到结果。如 <code>collect()</code> 、 <code>count()</code> 、 <code>forEach()</code> 、 <code>forEachOrdered()</code> 、 <code>max()</code> 、 <code>min()</code> 、 <code>reduce()</code> 、 <code>toArray()</code>  等。</li>\n<li>短路（ <code>short-circuiting</code> ）操作：拿到符合预期的结果就会停下来，不一定会处理完所有数据。如 <code>anyMatch()</code> 、 <code>allMatch()</code> 、 <code>noneMatch()</code> 、 <code>findFirst()</code> 、 <code>findAny()</code>  等。</li>\n</ul>\n</li>\n</ul>\n<p>在深入探讨 <code>stream</code>  之前，我们需要储备些知识点。</p>\n<ul>\n<li>\n<p>函数式接口  <code>FunctionInterface</code></p>\n<p><code>JDK</code>  提供了很多的函数式接口，包路径是： <code>java.util.function</code> . 函数式接口的作用是 Java8 对一类特定类型接口的称呼。这类接口只有一个抽象方法，并且使用  <code>@FunctionInterface</code>  注解进行注明。在 <code>Java Lambda</code>  的实现中， 开发组不想再为 <code>Lambda</code>  表达式单独定义一种特殊的 <code>Structural</code>  函数类型，称之为箭头类型（ <code>arrow type</code> ）， 依然想采用 Java 既有的类型系统 ( <code>class</code> ,  <code>interface</code> ,  <code>method</code>  等)， 原因是增加一个结构化的函数类型会增加函数类型的复杂性，破坏既有的 <code>Java</code>  类型，并对成千上万的 <code>Java</code>  类库造成严重的影响。 权衡利弊， 因此最终还是利用 <code>SAM</code>  接口 ( <code>Single Abstract Method</code> ) 作为  <code>Lambda</code>  表达式的目标类型。</p>\n<p>函数式接口其实在 <code>Jdk8</code>  之前就已存在了，比如 <code>java.lang.Runnable</code> , <code>java.util.concurrent.Callable</code> , <code>java.util.Comparator</code>  等等。只是没有使用  <code>@FunctionInterface</code>  注解而已。在 <code>JDK1.8</code>  之后加上了这个注解，并且在 <code>java.util.function</code>  包下新增很多个函数式接口。 其中，我们需要知道的只有六个:</p>\n<ul>\n<li><code>Predicate</code> : 传入一个参数，返回一个 <code>bool</code>  结果， 方法为 <code>boolean test(T t)</code></li>\n<li><code>Consumer</code> : 传入一个参数，无返回值，纯消费。 方法为 <code>void accept(T t)</code></li>\n<li><code>Function&lt;T,R&gt;</code> : 传入一个参数，返回一个结果，方法为 <code>R apply(T t)</code></li>\n<li><code>Supplier</code> : 无参数传入，返回一个结果，方法为 <code>T get()</code></li>\n<li><code>UnaryOperator</code> : 一元操作符， 继承 <code>Function&lt;T,T&gt;</code> , 传入参数的类型和返回类型相同。</li>\n<li><code>BinaryOperator</code> : 二元操作符， 传入的两个参数的类型和返回类型相同， 继承 <code>BiFunction&lt;T,T,T&gt;</code></li>\n</ul>\n</li>\n</ul>\n<p>为什么要了解这个 函数式接口呢？</p>\n<p>因为 在 <code>Stream</code>  的方法中，大部分的参数都是使用 函数式接口 接受参数的。所以，如果要探究其实现原理和设计原则的话，这个是必须要知道的。</p>\n<blockquote>\n<p>注意:<br>\n <code>lambda</code>  表达式，是一种语法的表现形式，使代码表现更加整洁  <code>lambda</code>  和  <code>stream</code>  是两个不相关的概念。</p>\n</blockquote>\n<h2 id=\"查术理-查看源码明晰基本的类结构\"><a class=\"markdownIt-Anchor\" href=\"#查术理-查看源码明晰基本的类结构\">#</a> 查 &quot;术&quot; 理: (查看源码，明晰基本的类结构)</h2>\n<p>先来看下 和  <code>Stream</code>  直接相关的类。</p>\n<p><img data-src=\"/images/java/jdk/stream/Stream%E7%B1%BB%E5%9B%BE%E8%B0%B1.png\" alt=\"\"></p>\n<p><code>Stream</code>  接口继承了 <code>BaseStream</code>  接口.</p>\n<p><span class=\"label success\">✔️ BaseStream 接口表示流的基本接口，而流是支持顺序和并行聚合操作的元素序列。</span><br>\n <code>Stream</code>  接口有很多实现类。其主要的一个实现类是  <code>ReferencePipeline</code>  类。除此之外 <code>ReferencePipeline</code>  类还继承了 <code>AbstractPipeline</code>  抽象类. <span class=\"label success\">✔️ AbstractPipeline 表示 “管道” 类的抽象基类，它们是 Stream 接口及其原始特化的核心实现。</span>再看 <code>AbstractPipeline</code>  类的父类 <code>PipelineHelper</code> ,<span class=\"label success\">✔️ AbstractPipeline 的作用是：用于执行流管道的辅助类，将有关流管道的所有信息（输出形状、中间操作、流标志、并行度等）集中在一个地方。</span></p>\n<p><code>ReferencePipeline</code>  类有三个子类:  <code>StatefulOp</code>  表示有状态的操作， <code>StatelessOp</code>  表示无状态的操作，  <code>Head</code>  表示  <code>ReferencePipeline</code>  的起始阶段。 当然了，这三个子类也是 流。</p>\n<h3 id=\"从创建流开始\"><a class=\"markdownIt-Anchor\" href=\"#从创建流开始\">#</a> 从创建流开始</h3>\n<p>不管是使用  <code>Stream.of(T t)</code>  还是  <code>Collection.stream()</code> ，还是 <code>Arrays.stream()</code> , 底层的实现都是通过  <code>StreamSupport.stream()</code>  来实现的。</p>\n<p><img data-src=\"/images/java/jdk/stream/Stream.of%E6%96%B9%E6%B3%95%E5%AE%9E%E7%8E%B0.png\" alt=\"\"></p>\n<p><span class=\"label success\">✔️ StreamSupport 类的作用是：用于创建和操作流的底层实用方法。</span></p>\n<p><img data-src=\"/images/java/jdk/stream/StreamSupport.stream%E6%96%B9%E6%B3%95%E5%AE%9E%E7%8E%B0.png\" alt=\"\"></p>\n<p>可以看到 直接返回的是  <code>ReferencePipeline.Head</code>  对象。 首先  <code>Head</code>  是一种 <code>Stream</code>  的实现。 接着去看  <code>Head</code>  的构造方法，可以看到其实调用的是： <code>AbstractPipeline</code>  的构造方法.</p>\n<h3 id=\"流的中间操作\"><a class=\"markdownIt-Anchor\" href=\"#流的中间操作\">#</a> 流的中间操作</h3>\n<p>文中已经谈及了 中间操作分为有状态的中间操作和无状态的中间操作。那我们以一个案例来说明操作与操作之间执行的。</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">List&lt;Integer&gt; numbers = Stream.of(<span class=\"number\">1</span>, <span class=\"number\">2</span>, <span class=\"number\">3</span>, <span class=\"number\">4</span>)</span><br><span class=\"line\">          .map(item -&gt; item + <span class=\"number\">5</span>)</span><br><span class=\"line\">          .sorted((n1, n2) -&gt; n2 - n1)</span><br><span class=\"line\">          .limit(<span class=\"number\">3</span>)</span><br><span class=\"line\">          .collect(Collectors.toList());</span><br></pre></td></tr></table></figure>\n<p><code>Stream.of()</code>  方法上文已经简单的说明了，接下来我们来看  <code>map()</code>  方法。</p>\n<p><img data-src=\"/images/java/jdk/stream/Stream.map%E6%96%B9%E6%B3%95%E5%AE%9E%E7%8E%B0.png\" alt=\"\"></p>\n<p>可以看到， <code>map()</code>  返回了一个 <code>StatelessOp</code>  对象，并且重写了 <code>AbstractPipeline</code>  的 <code>opWrapSink</code>  方法。 之前也说过：它表示流的无状态中间阶段的基类。 还有一个 <code>Sink</code>  类型.  <code>Sink</code>  类表示  <code>Consumer</code>  接口的扩展，用于在流管道的各个阶段传递值，以及管理大小信息、控制流等的附加方法。</p>\n<p>我们再仔细看一下这个方法。首先这个方法并没有进行任何的计算，只是将  <code>item -&gt; item + 5</code>  这个操作进行三层的封装， 1. 将 <code>map</code>  方法的返回值重新封装成了流对象，2. 把我们的 <code>item -&gt; item + 5</code>  这个操作封装成了  <code>StatelessOp</code> ， 并重写了 <code>opWrapSink</code>  这个方法，并在终止操作时进行调用。 3. 使用 <code>sink</code> ( <code>Sink.ChainedReference)</code>  将管道的各个阶段连接起来。即赋值 <code>downStream</code> . 使用 <code>downstream</code>  这个 <code>Consumer</code>  完成 <code>accept</code>  调用。</p>\n<p>这里需要注意一下:  <code>StatelessOp</code>  类的构造方法的实体参传输了一个  <code>this</code>  字段。仔细翻看源码就会返现它一直调用到  <code>AbstractPipeline</code>  的构造方法中。</p>\n<p><img data-src=\"/images/java/jdk/stream/AbstractPipeline.png\" alt=\"\"></p>\n<p>可以看到  <code>AbstractPipeline</code>  中有两个字段  <code>nextStage</code>  和  <code>previousStage</code>  字段，分别表示的是上一阶段和下一阶段。其中  <code>nextStage</code>  是 当前阶段。  <code>previousStage</code>  则应该 当前阶段的上一个阶段，其实就是调用当前方法的对象。</p>\n<p>不知道你是否发现 通过这种方法， <code>stream</code>  组成了一个 流各个阶段的双向链表。节点就是流操作的各个阶段。</p>\n<p>ps: 这样一次流操作会创建两个链表:  <code>Stream</code>  阶段的双向链表，和 在终止操作时，根据双向链表生成的  <code>Sink</code>  链表。</p>\n<p>再次说明：到目前为止， <code>map()</code>  方法里只是进行了封装，没有进行任何计算！</p>\n<p>接着来看  <code>sorted()</code>  方法。</p>\n<p><img data-src=\"/images/java/jdk/stream/stream.sorted%E6%96%B9%E6%B3%95.png\" alt=\"\"></p>\n<p><code>sorted</code>  方法比较简单，通过调用 <code>SortedOps</code>  类的 <code>makeRef</code>  方法，创建了 <code>OfRef</code>  对象。  <code>OfRef</code>  类的作用是：用于对流进行排序的专用子类型。  <code>OfRef</code>  类继承了  <code>ReferencePipeline.StatefulOp</code>  ，所以 <code>OfRef</code>  是一个有状态操作。那自然它也会有  <code>opWrapSink</code>  方法。也就是说它也会返回一个 Sink 对象，只是这个 <code>Sink</code>  对象的实现类不一样的。</p>\n<blockquote>\n<p>说明：到目前为止， <code>sorted()</code>  方法里只是进行了封装，没有进行任何计算！</p>\n</blockquote>\n<p>同理去看 <code>limit</code>  方法。</p>\n<p><img data-src=\"/images/java/jdk/stream/Stream.limit%E6%96%B9%E6%B3%95.png\" alt=\"\"></p>\n<p>这个方法的内部是直接创建了一个  <code>ReferencePipeline.StatefulOp</code>  对象，也是重写了其中的方法:  <code>opWrapSink</code> .</p>\n<p>不知道你是否有好奇，我为什么每次都会提到  <code>opWrapSink</code>  这个方法呢？因为这个方法非常的重要！其重要性我们在 <a href=\"#%E6%8E%A2%E2%80%9D%E6%B3%95%E2%80%9C%E6%8B%A9\">探” 法 “择</a> 这部分会完整的说明。</p>\n<blockquote>\n<p>再三说明：到目前为止， <code>limit()</code>  方法里只是进行了封装，没有进行任何计算！</p>\n</blockquote>\n<p>书行至此，案例中的中间操作都已经简单的分析完成了。我们就知道这里  <code>jdk</code>  为了完成 流操作为每个中间操作都封装了很多的对象，而这些对象只是散列在了内存中。接下来，就要看  <code>jdk</code>  是如何把他们组装到一起的。</p>\n<h3 id=\"终止操作\"><a class=\"markdownIt-Anchor\" href=\"#终止操作\">#</a> 终止操作</h3>\n<p>以 <code>Collect</code>  方法为例，去探究一下终止操作的流程。</p>\n<p><img data-src=\"/images/java/jdk/stream/Stream.collect%E6%96%B9%E6%B3%95.png\" alt=\"\"><br>\n可以看到在 <code>collect</code>  方法中，分为并行执行方式和串行执行方法，我们看串行执行时，会创建  <code>ReduceOps</code>  终止操作对象。<br>\n<img data-src=\"/images/java/jdk/stream/AbstractPipeline.evaluate%E6%96%B9%E6%B3%95.png\" alt=\"\"></p>\n<p>将 终止操作 传递给 evaluate 方法，然后调用终止操作的 evaluate 方法，当然这个方法也分成了串行执行和并行执行两种。</p>\n<p><img data-src=\"/images/java/jdk/stream/ReduceOps.evaluateSequential%E6%96%B9%E6%B3%95.png\" alt=\"\"></p>\n<p><code>helper</code>  其实是  <code>limit(3)</code>  中间操作返回的对象。这其实中间操作的最后一个 <code>Stage</code>  (阶段)。返回的对象是 <code>AbstractPipeline</code>  和  <code>Stream</code>  的子类实例。</p>\n<p><img data-src=\"/images/java/jdk/stream/AbstractPipeline.wrapAndCopyInfo%E6%96%B9%E6%B3%95.png\" alt=\"\"></p>\n<p>这里包含两个方法:  <code>wrapSink()</code>  和  <code>copyInfo()</code> .</p>\n<p>这是两个非常重要的方法.  <code>wrapSink()</code>  是将中间的操作组成  <code>SinkChain</code>  。  <code>copyInfo()</code>  这是执行真正的计算逻辑。</p>\n<p><img data-src=\"/images/java/jdk/stream/AbstractPipeline.wrapSink%E6%96%B9%E6%B3%95.png\" alt=\"\"></p>\n<p>方法中的形参  <code>sink</code>  就是最后的阶段的终止操作。方法通过循环将  <code>sink</code>  分装到 <code>Sink</code>  中。  <code>Sink</code>  接口 的一个实现类是  <code>ChainedReference</code>  ， 类中定义了一个  <code>downStream</code>  字段。 会将 <code>sink = p.opWrapSink(p.previousStage.combinedFlags, sink);</code>   中的  <code>sink</code>  赋值给  <code>downStream</code> . 这样就形成了 <b>套娃</b>。 最后返回一个  <code>wrapSink</code>  , 即整个流操作中所有的操作的 封装 <code>Sink</code> .</p>\n<p><img data-src=\"/images/java/jdk/stream/AbstractPipeline.copyInfo%E6%96%B9%E6%B3%95.png\" alt=\"\"></p>\n<p>图中所示的即为上面提及的 封装 <code>Sink</code> . 可中断和不可中断的区别是：可中断如果获取值，就不必再取所有的结果了。反之，就需要计算出所有阶段的结果。</p>\n<p>非可中断的终止操作时，会执行  <code>begin()</code> , <code>forEachRemaining()</code> , <code>end()</code> , 三个方法。  这个三个方法对应的是： <code>Sink</code>  接口中提供的三个方法。</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// 每个Sink开始之前调用该方法，通知sink做好准备</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">default</span> <span class=\"keyword\">void</span> <span class=\"title\">begin</span><span class=\"params\">(<span class=\"keyword\">long</span> size)</span> </span>&#123;&#125;</span><br><span class=\"line\"><span class=\"comment\">// 遍历元素时使用，接受一个待处理元素，并对元素进行处理。</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">default</span> <span class=\"keyword\">void</span> <span class=\"title\">accept</span><span class=\"params\">(Double i)</span></span>;</span><br><span class=\"line\"><span class=\"comment\">// 通知sink没有元素进行处理了。</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">default</span> <span class=\"keyword\">void</span> <span class=\"title\">end</span><span class=\"params\">()</span> </span>&#123;&#125;</span><br></pre></td></tr></table></figure>\n<p>其中，</p>\n<ul>\n<li><code>begin()</code>  方法，会调用每个 <code>Sink</code>  子类的 <code>begin</code>  方法。</li>\n<li><code>forEachRemaining()</code>  方法对应的执行内容如下图:<br>\n<img data-src=\"/images/java/jdk/stream/forEachRemaining%E6%96%B9%E6%B3%95.png\" alt=\"\"></li>\n<li><code>end()</code>  方法，会调用每个 <code>Sink</code>  字段的 <code>end</code>  方法。</li>\n</ul>\n<p>书行至此。或许你会对  <code>forEachRemaining</code>  方法感到好奇。后面我会写一篇文章来专门分享: 《 <code>Stream</code>  的高级迭代器》, 希望你能继续关注支持我～</p>\n<h2 id=\"探法择\"><a class=\"markdownIt-Anchor\" href=\"#探法择\">#</a> 探” 法 “择</h2>\n<p>我们从一个案例出发，在细节之处分析了一个 <code>Stream</code>  的执行过程。现在我们需要从全局来看一下  <code>Stream</code>  的执行过程是什么样子的.</p>\n<p>上文中我们知道了  <code>Stream</code>  的 所有计算都是在 终止操作时 触发的。 所有的中间操作都是封装了一些对象。我们用一张图来描述下 <code>Stream</code>  的执行过程。</p>\n<p><img data-src=\"/images/java/jdk/stream/Stream%E9%80%BB%E8%BE%91%E6%B5%81%E7%A8%8B%E5%9B%BE.png\" alt=\"\"></p>\n<ul>\n<li><code>stream</code>  将创建的流做为第一个  <code>Stage</code>  , 用来代表流的开始， 每个 <code>Stage</code>  都是 <code>AbstractPipeline</code>  的子类。 第一个 <code>Stage</code>  是 <code>AbstractPipeline.Head</code>  对象。</li>\n<li>然后将中间操作封装成后面的 n 个  <code>stage</code> . 并组成 双向链表的形式，并且存储了 <code>stage0</code> . 每个 <code>Stage</code>  都是 <code>StatelessOp</code>  或者  <code>statefulOp</code> .</li>\n<li>终止操作通过 <code>wrapSink()</code>  方法 会触发将 每个阶段的操作封装成  <code>Sink</code> . 并且 <code>sink</code>  都会做为参数传递到上一个阶段的 <code>opWrapSink()</code>  方法中，从而组成一个  <code>sink</code>  链表。</li>\n<li>然后，通过  <code>copyInfo()</code>  方法将，交于 <code>Spilterator</code>  进行迭代。计算的结果可以分为四种\n<ul>\n<li>返回 <code>boolean</code>  类型的结果：比如 <code>anyMatch()</code>   <code>allMatch()</code>   <code>noneMatch()</code>  方法。</li>\n<li>返回 <code>Optional</code>  类型的结果： 比如 <code>findFirst()</code>   <code>findAny()</code>  方法</li>\n<li>还有归约操作:\t <code>reduce()</code>   <code>collect()</code></li>\n<li>返回数组的： <code>toArray()</code> <br>\n 对于表中返回 <code>boolean</code>  或者 <code>Optional</code>  的操作（ <code>Optional</code>  是存放 一个 值的容器）的操作，由于值返回一个值，只需要在对应的 <code>Sink</code>  中记录这个值，等到执行结束时返回就可以了。<br>\n对于归约操作，最终结果放在用户调用时指定的容器中（容器类型通过收集器指定）。 <code>collect()</code> ,  <code>reduce()</code> ,  <code>max()</code> ,  <code>min()</code>  都是归约操作，虽然 <code>max()</code>  和 <code>min()</code>  也是返回一个 <code>Optional</code> ，但事实上底层是通过调用 <code>reduce()</code>  方法实现的。<br>\n对于返回是数组的情况，毫无疑问的结果会放在数组当中。这么说当然是对的，但在最终返回数组之前，结果其实是存储在一种叫做 <code>Node</code>  的数据结构中的。 <code>Node</code>  是一种多叉树结构，元素存储在树的叶子当中，并且一个叶子节点可以存放多个元素。这样做是为了并行执行方便。关于  <code>Stream</code>  的并行计算，我后面会继续分享。</li>\n</ul>\n</li>\n</ul>\n<h2 id=\"明道义\"><a class=\"markdownIt-Anchor\" href=\"#明道义\">#</a> 明 &quot;道&quot; 义</h2>\n<p><code>JDK</code>  提供的  <code>Stream</code>  具有如下特点:</p>\n<ul>\n<li>无存储。 <code>stream</code>  不是一种数据结构，它只是某种数据源的一个视图，数据源可以是一个数组， <code>Java</code>  容器或 <code>I/O channel</code>  等。</li>\n<li>为函数式编程而生。对 <code>stream</code>  的任何修改都不会修改背后的数据源，比如对 <code>stream</code>  执行过滤操作并不会删除被过滤的元素，而是会产生一个不包含被过滤元素的新 <code>stream</code> 。</li>\n<li>惰式执行。 <code>stream</code>  上的操作并不会立即执行，只有等到用户真正需要结果的时候才会执行。</li>\n<li>可消费性。 <code>stream</code>  只能被 “消费” 一次，一旦遍历过就会失效，就像容器的迭代器那样，想要再次遍历必须重新生成。</li>\n</ul>\n<blockquote>\n<p>在这一趴，我就围绕两个点来简单的聊聊。</p>\n</blockquote>\n<ul>\n<li><code>JDK8</code>  为什么要加入  <code>Stream</code> .</li>\n</ul>\n<p>除了上面四个特点之外， <code>Java8</code>  中的 <code>Stream</code>  是对集合对象的增强，当然不仅仅是集合对象。 <code>Stream</code>  为开发者提供了简洁的编码方式和编码风格，极大的提高了开发的效率。</p>\n<p>另外一个更重要的点在于  <code>Stream</code>  为我们下篇文章要分享的 <b> <code>Stream</code>  并行计算流</b> 提供了实现，请期待。</p>\n<ul>\n<li><code>Stream</code>  为什么要这么设计？</li>\n</ul>\n<p>我这里给一份我的回答，这个问题也留给看文章的你，也希望能看到你的回答。</p>\n<p>根据上文所说的内容， <code>Stream</code>  体系是一组接口家族， <code>AbstractPipeline </code> 是接口的实现， <code>PipelineHelper</code>  是管道的辅助类， <code>StreamSupport</code>  是流的底层工具类</p>\n<p><code>Stream</code>  使用 <code>stage</code>  来抽象流水线上的每个操作，其实每个 <code>stage</code>  就是一个 <code>stream</code>  子类的实例， 也就是 <code>AbstractPipeline</code>  几个子类的内部子类即 <code>Head</code>   <code>StatelessOp</code>   <code>statefulOp</code> ;</p>\n<p><code>StreamSupport</code>  用于创建生成 <code>Stream</code>  对应的是 <code>Head</code>  类，其他的中间操作分为有状态和无状态的，中间操作通过方法比如  <code>filter</code>   <code>map</code>  等返回的是 <code>StatelessOp</code>  或者  <code>statefulOp</code> .  多个 <code>stage</code>  组合称为双向链表的形式 从而成了整个流水线</p>\n<p>有了流水线，相邻两个操作阶段之间如何协调运算？</p>\n<p>于是又有了 <code>Sink</code>  的概念，又来协调相邻的 <code>stage</code>  之间计算运行</p>\n<p>他的模式是 <code>begin</code>    <code>accept</code>   <code>end</code>  还有短路标记</p>\n<p>他的 <code>accept</code>  就是封装了回调方法，所以说每个操作 <code>stage</code> ,  <code>StatelessOp</code>   或者  <code>statefulOp</code>  中又封装了 <code>Sink</code> . 通过 <code>AbstractPipeline</code>  提供的 <code>opWrapSink</code>  方法可以获取这个 <code>Sink</code></p>\n<p>调用这个 <code>sink</code>  的 <code>accept</code>  方法就可以调用当前操作的方法</p>\n<p>那么如何串联起来呢？</p>\n<p>关键点在于 <code>opWrapSink</code>  方法，他接收一个 <code>Sink</code>  作为参数，在调用 <code>accept</code>  方法中。可以调用这个入参 <code>Sink</code>  的 <code>accept</code>  方法</p>\n<p>这样子从当前就能调用下一个，也就是说有了推动的动作。那么只需要找到开始，每个处理了之后都推动下一个，就顺序完成了所欲的操作了。</p>\n<h2 id=\"结语\"><a class=\"markdownIt-Anchor\" href=\"#结语\">#</a> 结语</h2>\n<p>通过看  <code>Stream</code>  相关的知识点，发现一篇文章是没法讲清楚的。</p>\n<p>这一次，我又果不其然的留下了两篇文章</p>\n<ul class=\"task-list\">\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"cbx_0\" disabled=\"true\"><label for=\"cbx_0\">  <code>Stream</code>  并行计算流</label></li>\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"cbx_1\" disabled=\"true\"><label for=\"cbx_1\">  <code>Stream</code>  的高级迭代器</label></li>\n</ul>\n<p>请给我记代办～</p>\n<p>在分享 <code>并行计算流</code> 的时候，我们需要以  <code>JDK1.7</code>  中的  <code>forkJoin</code>  框架为前提，来分析  <code>Stream</code>  的  <code>parallelStream</code> .</p>\n<p>在分享 <code>迭代器</code> 的时候，我们也会分析一下 <code>JDK</code>  中提供的 普通迭代器，比如  <code>ForEach</code> ,  <code>iterator</code> , 以及 <code>Stream</code>  的高级迭代器  <code>spliterator</code> . 也会由浅入深的分析一下，各种迭代器的优缺点。 也会自定义实现一个迭代器。</p>\n<p>敬请期待，防止走丢见文末。关注我，期望和你一起遇见更好的自己.</p>\n<h2 id=\"最后\"><a class=\"markdownIt-Anchor\" href=\"#最后\">#</a> 最后</h2>\n<p>期望和你一起遇见更好的自己</p>\n<p><img data-src=\"/images/java/jdk/stream/qrcode.jpg\" alt=\"\"></p>\n",
            "tags": [
                "JDK",
                "Java",
                "Stream"
            ]
        },
        {
            "id": "https://fangjiaxiaobai.github.io/2021/08/19/java%E7%B3%BB%E5%88%97/JVM/OOM/",
            "url": "https://fangjiaxiaobai.github.io/2021/08/19/java%E7%B3%BB%E5%88%97/JVM/OOM/",
            "title": "JVM之你没见过的OOM",
            "date_published": "2021-08-19T09:13:55.000Z",
            "content_html": "<p>一文搞懂内存溢出，保内存平安，防止你被祭天:[手动滑稽]:</p>\n<h2 id=\"释义\"><a class=\"markdownIt-Anchor\" href=\"#释义\">#</a> 释义</h2>\n<p><code>OOM</code>  的含义，到底是什么意思？<br>\n 是 JVM 独有的吗？  <code>linux</code>  是否也会存在，那又是怎么肥事？</p>\n<p><code>OOM</code>  :  <code>Out Of Memory</code>  .  内存溢出。内存溢出来了，也就是说内存不够用了，就会发生这个问题了。</p>\n<h3 id=\"内存又是什么呢\"><a class=\"markdownIt-Anchor\" href=\"#内存又是什么呢\">#</a> 内存又是什么呢？</h3>\n<p>1、 内存 是计算机的重要部件之一。它用于暂时存放 CPU 中的运算数据，与硬盘等外部存储交换数据。是外存与 <code>CPU</code>  进行沟通的桥梁。</p>\n<p>2、 <code>Java</code>  内存。说到这里我们就不得说一下 java 的内存模型 (JMM) 了。如下图。</p>\n<p><img data-src=\"/images/java/jvm/JMM.png\" alt=\"JMM\"></p>\n<p>就这个一个图就很不下几十个面试考点：比如 <code>votitle</code>  关键字，内存栅栏，指令重排，5 项 <code>Happen-Before</code>  原则，内存原子操作，数据 <code>IO</code>  操作等等。</p>\n<p>闲话少扯，抛个问题， <code>OOM</code>  发生区域会上图中那个部分发生呢？</p>\n<h2 id=\"前言\"><a class=\"markdownIt-Anchor\" href=\"#前言\">#</a> 前言</h2>\n<p><code>java</code>  运行时内存区域  <code>JAVA RUNTIME MEMEORY AREA</code> , 注意区分 <code>JMM</code> .</p>\n<p>大家都知道的， <code>java</code>  运行时内存区域，分为程序计数器 (PC 寄存器)，java 虚拟机栈，本地方法栈，堆，方法区，运行时常量池，堆外内存 (直接内存)</p>\n<p>1、程序计数器是一块较小的内存空间，是当前线程正在执行的那条字节码指令的地址。若当前线程正在执行的是一个本地方法，那么此时程序计数器为 <code>Undefined</code> 。</p>\n<p>2、 <code>Java</code>  虚拟机栈是描述  <code>Java</code>  方法运行过程的内存模型。 <code>Java</code>  虚拟机栈会为每一个即将运行的  <code>Java</code>  方法创建一块叫做 “栈帧” 的区域，用于存放该方法运行过程中的一些信息，比如：局部变量表，操作数栈，动态链接，方法出口信息等，方法执行的过程即为栈帧压栈出栈的过程。</p>\n<p>3、本地方法栈是为  <code>JVM</code>  运行  <code>Native</code>  方法准备的空间，由于很多  <code>Native</code>  方法都是用  <code>C</code>  语言实现的，所以它通常又叫  <code>C</code>  栈。它与  <code>Java</code>  虚拟机栈实现的功能类似，只不过本地方法栈是描述本地方法运行过程的内存模型。</p>\n<p>4、堆是用来存放对象的内存空间，几乎所有的对象都存储在堆中。这一区域是线程共享，整个  <code>Java</code>  虚拟机只有一个堆，所有的线程都访问同一个堆。堆又可划分为年轻代和老年代，年轻代内存又可以分为 <code>Eden</code> ,  <code>from Surivor</code> , <code>to Surivor</code> , 并且默认以 8:1:1 的比例进行分配。</p>\n<p>5、方法区： <code>Java</code>  虚拟机规范中定义方法区是堆的一个逻辑部分。方法区存放以下信息：已经被虚拟机加载的类信息，常亮，静态变量，即时编译编译器编译后的代码。线程共享的区域。为了与堆区分，方法还有一个别名： <code>Non-Heap</code>  (非堆)。</p>\n<p>5.1 、运行时常量池：存放常量的区域。 在运行期间，可以向常量池中添加新的变量，如  <code>String</code>  类的 <code>intern()</code>  方法。</p>\n<p>6、堆外内存是 <code>java</code>  虚拟机之外的内容，但也可能被 <code>java</code>  使用。需要注意的是，这部分内容也会因内存不足而抛出  <code>OutOfMemoryError</code> 、</p>\n<p>知道了 <code>Java</code>  运行内存区域，那么可能发生  <code>OOM</code>  的区域有哪些呢？</p>\n<p>我们都知道 <code>OOM</code>  只的是内存溢出，所以 堆，非堆即方法区，本地方法栈，以及堆外内存 都是会发生  <code>OOM</code>  的。</p>\n<p>那 <code>java</code>  虚拟机栈呢？不会发生内容溢出吗？   会！但是 栈发生内容溢出的时候，报的错误是  <code>StackOverflowError</code> .</p>\n<p>那程序计数器呢？  程序计数器，是不会发送内容溢出的。 因为 存储的是：当前线程正在执行的那条字节码指令的地址啊。</p>\n<p>如下图：</p>\n<p><img data-src=\"/images/java/jvm/OOM%E5%8C%BA%E5%9F%9F%E5%9B%BE.png\" alt=\"OOM区域图\"></p>\n<p>在上图中还指定了各区域大小的参数配置：</p>\n<ul>\n<li>\n<p><code>-Xms</code>  设置堆的最小空间大小。</p>\n</li>\n<li>\n<p><code>-Xmx</code>  设置堆的最大空间大小。</p>\n</li>\n<li>\n<p><code>-XX:NewSize</code>  设置新生代最小空间大小。</p>\n</li>\n<li>\n<p><code>-XX:MaxNewSize</code>  设置新生代最大空间大小。</p>\n</li>\n<li>\n<p><code>-XX:PermSize</code>  设置永久代最小空间大小。</p>\n</li>\n<li>\n<p><code>-XX:MaxPermSize</code>  设置永久代最大空间大小。</p>\n</li>\n<li>\n<p><code>-Xss</code>  设置每个线程的堆栈大小。</p>\n</li>\n</ul>\n<p>没有直接设置老年代的参数，但是可以设置堆空间大小和新生代空间大小两个参数来间接控制。  <code>老年代空间大小=堆空间大小-年轻代大空间大小</code></p>\n<h2 id=\"场景分析\"><a class=\"markdownIt-Anchor\" href=\"#场景分析\">#</a> 场景分析</h2>\n<p>我们挨个分析下发生 <code>OOM</code>  的 9 种场景</p>\n<p>什么时候会发生 <code>OOM</code>  呢？  当内存严重不够用的时候就会发生   <code>java.lang.OutOfMemoryError</code>  。</p>\n<p>我们来看下每个区域都有可能出现内存溢出问题.</p>\n<h3 id=\"javaheap-space\"><a class=\"markdownIt-Anchor\" href=\"#javaheap-space\">#</a>  <code>JavaHeap space</code></h3>\n<p>当堆内存（ <code>Heap Space</code> ）没有足够空间存放新创建的对象时，就会抛出  <code>java.lang.OutOfMemoryError:Javaheap space</code>  错误。</p>\n<p><code>Javaheap space</code>  错误产生的常见原因可以分为以下几类：</p>\n<p>1. 请求创建一个超大对象，通常是一个大数组。<br>\n2. 超出预期的访问量 / 数据量，通常是上游系统请求流量飙升，常见于各类促销 / 秒杀活动，可以结合业务流量指标排查是否有尖状峰值。<br>\n3. 过度使用终结器（ <code>Finalizer</code> ），该对象没有立即被  <code>GC</code> 。<br>\n4. 内存泄漏（ <code>Memory Leak</code> ），大量对象引用没有释放， <code>JVM</code>  无法对其自动回收，常见于使用了  <code>File</code>  等资源没有回收。</p>\n<h4 id=\"解决方案\"><a class=\"markdownIt-Anchor\" href=\"#解决方案\">#</a> 解决方案</h4>\n<p>针对大部分情况，通常只需要通过  <code>-Xmx</code>  参数调高  <code>JVM</code>  堆内存空间即可。如果仍然没有解决，可以参考以下情况做进一步处理：</p>\n<p>1、如果是超大对象，可以检查其合理性，比如是否一次性查询了数据库全部结果，而没有做结果数限制。<br>\n2、如果是业务峰值压力，可以考虑添加机器资源，或者做限流降级。<br>\n3、如果是内存泄漏，需要找到持有的对象，修改代码设计，比如关闭没有释放的连接。</p>\n<h4 id=\"代码案例\"><a class=\"markdownIt-Anchor\" href=\"#代码案例\">#</a> 代码案例</h4>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * 演示大对象</span></span><br><span class=\"line\"><span class=\"comment\"> * -Xms128M -Xmx128M</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">bigObject</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"comment\">// 21 可以，22就会OOM</span></span><br><span class=\"line\">    <span class=\"comment\">// 4* 1024 * 1024 = 4M * 32 = 128M</span></span><br><span class=\"line\">    <span class=\"keyword\">int</span>[] integers = <span class=\"keyword\">new</span> <span class=\"keyword\">int</span>[<span class=\"number\">1024</span>*<span class=\"number\">1024</span>*<span class=\"number\">32</span>];</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>报错内容<br>\n<img data-src=\"/images/java/jvm/heapSpaceError.png\" alt=\"\"></p>\n<h3 id=\"gc-overhead-limit-exceeded\"><a class=\"markdownIt-Anchor\" href=\"#gc-overhead-limit-exceeded\">#</a>  <code>GC overhead limit exceeded</code></h3>\n<p>当  <code>Java</code>  进程花费  <code>98%</code>  以上的时间执行  <code>GC</code> ，但只恢复了不到  <code>2%</code>  的内存，且该动作连续重复了  <code>5</code>  次，就会抛出  <code>java.lang.OutOfMemoryError:GC overhead limit exceeded</code>  错误。简单地说，就是应用程序已经基本耗尽了所有可用内存，  <code>GC</code>  也无法回收。</p>\n<h4 id=\"解决方案-2\"><a class=\"markdownIt-Anchor\" href=\"#解决方案-2\">#</a> 解决方案</h4>\n<p>同  <code>JavaHeap space</code>  部分的异常解决方案。</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * 演示 频繁GC</span></span><br><span class=\"line\"><span class=\"comment\"> * -Xms128M -Xmx128M</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">overHead</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">    Map map = <span class=\"keyword\">new</span> HashMap();</span><br><span class=\"line\">    Random r = <span class=\"keyword\">new</span> Random();</span><br><span class=\"line\">    <span class=\"keyword\">while</span> (<span class=\"keyword\">true</span>) &#123;</span><br><span class=\"line\">        map.put(r.nextInt(), <span class=\"string\">&quot;value&quot;</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>报错内容:<br>\n<img data-src=\"/images/java/jvm/gcOverHead.png\" alt=\"\"></p>\n<h3 id=\"permgen-spacejdk8-已废弃-see-元空间\"><a class=\"markdownIt-Anchor\" href=\"#permgen-spacejdk8-已废弃-see-元空间\">#</a>  <code>Permgen space</code> ( <code>JDK8</code>  已废弃， <code>see</code>  元空间。)</h3>\n<div class=\"note info\">\n<p>为什么会废弃 永久代？     <code>see</code> ： <span class=\"exturl\" data-url=\"aHR0cDovL29wZW5qZGsuamF2YS5uZXQvamVwcy8xMjI=\">http://openjdk.java.net/jeps/122</span></p>\n</div>\n<p>该错误表示永久代（ <code>Permanent Generation</code> ）已用满，通常是因为加载的  <code>class</code>  数目太多或体积太大。</p>\n<p>永久代存储对象主要包括以下几类：</p>\n<p>加载 / 缓存到内存中的  <code>class</code>  定义，包括类的名称，字段，方法和字节码；<br>\n常量池；<br>\n对象数组 / 类型数组所关联的  <code>class</code> ；<br>\n <code>JIT</code>  编译器优化后的  <code>class</code>  信息。<br>\n <code>PermGen</code>  的使用量与加载到内存的  <code>class</code>  的数量 / 大小正相关。</p>\n<h4 id=\"解决方案-3\"><a class=\"markdownIt-Anchor\" href=\"#解决方案-3\">#</a> 解决方案</h4>\n<p>根据  <code>Permgen space</code>  报错的时机，可以采用不同的解决方案，如下所示：</p>\n<ul>\n<li>程序启动报错，修改  <code>-XX:MaxPermSize</code>  启动参数，调大永久代空间。</li>\n<li>应用重新部署时报错，很可能是没有应用没有重启，导致加载了多份  <code>class</code>  信息，只需重启 JVM 即可解决。</li>\n<li>运行时报错，应用程序可能会动态创建大量  <code>class</code> ，而这些  <code>class</code>  的生命周期很短暂，但是 JVM 默认不会卸载  <code>class</code> ，可以设置  <code>-XX:+CMSClassUnloadingEnabled</code>  和  <code>-XX:+UseConcMarkSweepGC</code>  这两个参数允许  <code>JVM</code>  卸载  <code>class</code> 。</li>\n<li>如果上述方法无法解决，可以通过  <code>jmap</code>  命令  <code>dump</code>  内存对象  <code>jmap-dump:format=b,file=dump.hprof</code>  ，然后利用  <code>Eclipse MAT https://www.eclipse.org/mat</code>  功能逐一分析开销最大的  <code>classloader</code>  和重复  <code>class</code> 。</li>\n</ul>\n<h3 id=\"metaspace\"><a class=\"markdownIt-Anchor\" href=\"#metaspace\">#</a>  <code>Metaspace</code></h3>\n<p><code>JDK 1.8</code>  使用  <code>Metaspace</code>  替换了永久代（ <code>Permanent Generation</code> ）</p>\n<p>该错误表示  <code>Metaspace</code>  已被用满，通常是因为加载的  <code>class</code>  数目太多或体积太大。</p>\n<p>此类问题的原因与解决方法跟  <code>PermGenspace</code>  非常类似，可以参考上文。</p>\n<p>需要特别注意的是调整  <code>Metaspace</code>  空间大小的启动参数为  <code>-XX:MaxMetaspaceSize</code> 。</p>\n<h4 id=\"代码案例-2\"><a class=\"markdownIt-Anchor\" href=\"#代码案例-2\">#</a> 代码案例</h4>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * 演示  元数据区</span></span><br><span class=\"line\"><span class=\"comment\"> * &lt;p&gt;</span></span><br><span class=\"line\"><span class=\"comment\"> * 在 `for` 循环中, 动态生成很多class, 最终将这些class加载到 Metaspace 中</span></span><br><span class=\"line\"><span class=\"comment\"> *</span></span><br><span class=\"line\"><span class=\"comment\"> * 注意配置: -XX:MaxMetaspaceSize=64m</span></span><br><span class=\"line\"><span class=\"comment\"> *</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@throws</span> Exception</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">metaSpace</span><span class=\"params\">()</span> <span class=\"keyword\">throws</span> Exception </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">for</span> (<span class=\"keyword\">int</span> i = <span class=\"number\">0</span>; ; i++) &#123;</span><br><span class=\"line\">        Class c = cp.makeClass(<span class=\"string\">&quot;eu.plumbr.demo.Generated&quot;</span> + i).toClass();</span><br><span class=\"line\">        System.out.println(i);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>报错内容:</p>\n<p><img data-src=\"/images/java/jvm/metaSpace.png\" alt=\"\"></p>\n<h3 id=\"unable-to-create-new-native-thread\"><a class=\"markdownIt-Anchor\" href=\"#unable-to-create-new-native-thread\">#</a>  <code>Unable to create new native thread</code></h3>\n<p>每个  <code>Java</code>  线程都需要占用一定的内存空间，当  <code>JVM</code>  向底层操作系统请求创建一个新的  <code>native</code>  线程时，如果没有足够的资源分配就会报此类错误。</p>\n<h4 id=\"原因分析\"><a class=\"markdownIt-Anchor\" href=\"#原因分析\">#</a> 原因分析</h4>\n<p><code>JVM</code>  向  <code>OS</code>  请求创建  <code>native</code>  线程失败，就会抛出  <code>Unable to create new native thread</code> ，常见的原因包括以下几类：</p>\n<p>线程数超过操作系统最大线程数  <code>ulimit</code>  限制；<br>\n线程数超过  <code>kernel.pid_max</code> （只能重启）；<br>\n <code>native</code>  内存不足；</p>\n<p>该问题发生的常见过程主要包括以下几步：</p>\n<p><code>JVM</code>  内部的应用程序请求创建一个新的  <code>Java</code>  线程；<br>\n <code>JVM native</code>  方法代理了该次请求，并向操作系统请求创建一个  <code>native</code>  线程；<br>\n操作系统尝试创建一个新的  <code>native</code>  线程，并为其分配内存；<br>\n如果操作系统的虚拟内存已耗尽，或是受到 32 位进程的地址空间限制，操作系统就会拒绝本次  <code>native</code>  内存分配；<br>\n <code>JVM</code>  将抛出  <code>java.lang.OutOfMemoryError:Unableto createnewnativethread</code>  错误。</p>\n<h4 id=\"解决方案-4\"><a class=\"markdownIt-Anchor\" href=\"#解决方案-4\">#</a> 解决方案</h4>\n<ul>\n<li>升级配置，为机器提供更多的内存；</li>\n<li>降低  <code>Java Heap Space</code>  大小；</li>\n<li>修复应用程序的线程泄漏问题；</li>\n<li>限制线程池大小；</li>\n<li>使用  <code>-Xss</code>  参数减少线程栈的大小；</li>\n<li>调高  <code>OS</code>  层面的线程最大数：执行  <code>ulimit -a</code>  查看最大线程数限制，使用  <code>ulimit -u xxx</code>  调整最大线程数限制。</li>\n</ul>\n<h4 id=\"代码案例-3\"><a class=\"markdownIt-Anchor\" href=\"#代码案例-3\">#</a> 代码案例</h4>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * 演示: Unable to create new native thread</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">nativeThread</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">while</span> (<span class=\"keyword\">true</span>) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">new</span> Thread(<span class=\"keyword\">new</span> Runnable() &#123;</span><br><span class=\"line\">            <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">run</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">                <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">                    Thread.sleep(<span class=\"number\">10000000</span>);</span><br><span class=\"line\">                &#125; <span class=\"keyword\">catch</span> (InterruptedException e) &#123;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;).start();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>报错内容:</p>\n<p><img data-src=\"/images/java/jvm/unableCreateNative.png\" alt=\"\"></p>\n<h3 id=\"out-of-swap-space\"><a class=\"markdownIt-Anchor\" href=\"#out-of-swap-space\">#</a>  <code>Out of swap space</code></h3>\n<p>该错误表示所有可用的虚拟内存已被耗尽。虚拟内存（ <code>Virtual Memory</code> ）由物理内存（ <code>Physical Memory</code> ）和交换空间（ <code>Swap Space</code> ）两部分组成。当运行时程序请求的虚拟内存溢出时就会报  <code>Outof swap space</code>  错误。</p>\n<p>这个错误通常是操作系统层面的原因。</p>\n<h4 id=\"原因分析-2\"><a class=\"markdownIt-Anchor\" href=\"#原因分析-2\">#</a> 原因分析</h4>\n<p>该错误出现的常见原因包括以下几类：</p>\n<ul>\n<li>\n<ol>\n<li>地址空间不足；</li>\n</ol>\n</li>\n<li>2. 物理内存已耗光；</li>\n<li>3. 应用程序的本地内存泄漏（ <code>native leak</code> ），例如不断申请本地内存，却不释放。</li>\n<li>4. 执行  <code>jmap-histo:live</code>  命令，强制执行  <code>Full GC</code> ；如果几次执行后内存明显下降，则基本确认为  <code>Direct ByteBuffer</code>  问题。</li>\n</ul>\n<h4 id=\"解决方案-5\"><a class=\"markdownIt-Anchor\" href=\"#解决方案-5\">#</a> 解决方案</h4>\n<p>根据错误原因可以采取如下解决方案：</p>\n<ul>\n<li>\n<ol>\n<li>升级地址空间为  <code>64 bit</code> ；</li>\n</ol>\n</li>\n<li>\n<ol start=\"2\">\n<li>使用  <code>Arthas</code>  检查是否为  <code>Inflater/Deflater</code>  解压缩问题，如果是，则显式调用  <code>end</code>  方法。</li>\n</ol>\n</li>\n<li>\n<ol start=\"3\">\n<li><code>Direct ByteBuffer</code>  问题可以通过启动参数  <code>-XX:MaxDirectMemorySize</code>  调低阈值。</li>\n</ol>\n</li>\n<li>\n<ol start=\"4\">\n<li>升级服务器配置 / 隔离部署，避免争用。</li>\n</ol>\n</li>\n</ul>\n<h3 id=\"kill-process-or-sacrifice-child\"><a class=\"markdownIt-Anchor\" href=\"#kill-process-or-sacrifice-child\">#</a>  <code>Kill process or sacrifice child</code></h3>\n<p>有一种内核作业（ <code>Kernel Job</code> ）名为  <code>Out of Memory Killer</code> ，它会在可用内存极低的情况下 “杀死”（ <code>kill</code> ）某些进程。 <code>OOM Killer</code>  会对所有进程进行打分，然后将评分较低的进程 “杀死”，具体的评分规则可以参考  <code>Surviving the Linux OOM Killer</code> 。</p>\n<p>不同于其他的  <code>OOM</code>  错误，  <code>Killprocessorsacrifice child</code>  错误不是由  <code>JVM</code>  层面触发的，而是由操作系统层面触发的。</p>\n<h4 id=\"原因分析-3\"><a class=\"markdownIt-Anchor\" href=\"#原因分析-3\">#</a> 原因分析</h4>\n<p>默认情况下， <code>Linux</code>  内核允许进程申请的内存总量大于系统可用内存，通过这种 “错峰复用” 的方式可以更有效的利用系统资源。</p>\n<p>然而，这种方式也会无可避免地带来一定的 “超卖” 风险。例如某些进程持续占用系统内存，然后导致其他进程没有可用内存。此时，系统将自动激活  <code>OOM Killer</code> ，寻找评分低的进程，并将其 “杀死”，释放内存资源。</p>\n<h4 id=\"解决方案-6\"><a class=\"markdownIt-Anchor\" href=\"#解决方案-6\">#</a> 解决方案</h4>\n<ul>\n<li>升级服务器配置 / 隔离部署，避免争用。</li>\n<li><code>OOM Killer</code>  调优。</li>\n</ul>\n<h4 id=\"代码案例-4\"><a class=\"markdownIt-Anchor\" href=\"#代码案例-4\">#</a> 代码案例</h4>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * 演示:Kill process or sacrifice child</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">error</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">    java.util.List&lt;<span class=\"keyword\">int</span>[]&gt; l = <span class=\"keyword\">new</span> java.util.ArrayList();</span><br><span class=\"line\">    <span class=\"keyword\">for</span> (<span class=\"keyword\">int</span> i = <span class=\"number\">10000</span>; i &lt; <span class=\"number\">100000</span>; i++) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">            l.add(<span class=\"keyword\">new</span> <span class=\"keyword\">int</span>[<span class=\"number\">100000000</span>]);</span><br><span class=\"line\">        &#125; <span class=\"keyword\">catch</span> (Throwable t) &#123;</span><br><span class=\"line\">            t.printStackTrace();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>报错内容<br>\n<img data-src=\"/images/java/jvm/killprocess.png\" alt=\"\"></p>\n<h3 id=\"requested-array-size-exceeds-vm-limit\"><a class=\"markdownIt-Anchor\" href=\"#requested-array-size-exceeds-vm-limit\">#</a>  <code>Requested array size exceeds VM limit</code></h3>\n<p>JVM 限制了数组的最大长度，该错误表示程序请求创建的数组超过最大长度限制。</p>\n<p>JVM 在为数组分配内存前，会检查要分配的数据结构在系统中是否可寻址，通常为  <code>Integer.MAX_VALUE-2</code> 。</p>\n<p>此类问题比较罕见，通常需要检查代码，确认业务是否需要创建如此大的数组，是否可以拆分为多个块，分批执行。</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">error</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">for</span> (<span class=\"keyword\">int</span> i = <span class=\"number\">3</span>; i &gt;= <span class=\"number\">0</span>; i--) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">            <span class=\"keyword\">int</span>[] arr = <span class=\"keyword\">new</span> <span class=\"keyword\">int</span>[Integer.MAX_VALUE-i];</span><br><span class=\"line\">            System.out.format(<span class=\"string\">&quot;Successfully initialized an array with %,d elements.\\n&quot;</span>, Integer.MAX_VALUE-i);</span><br><span class=\"line\">        &#125; <span class=\"keyword\">catch</span> (Throwable t) &#123;</span><br><span class=\"line\">            t.printStackTrace();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>报错内容</p>\n<p><img data-src=\"/images/java/jvm/requestArraySize.png\" alt=\"\"></p>\n<h3 id=\"direct-buffer-memory\"><a class=\"markdownIt-Anchor\" href=\"#direct-buffer-memory\">#</a>  <code>Direct buffer memory</code></h3>\n<p><code>java</code>  允许应用程序通过  <code>Direct ByteBuffer</code>  直接访问堆外内存，许多高性能程序通过  <code>Direct ByteBuffer</code>  结合内存映射文件（ <code>Memory Mapped File</code> ）实现高速  <code>IO</code> 。</p>\n<h4 id=\"原因分析-4\"><a class=\"markdownIt-Anchor\" href=\"#原因分析-4\">#</a> 原因分析</h4>\n<p><code>Direct ByteBuffer</code>  的默认大小为  <code>64 MB</code> ，一旦使用超出限制，就会抛出  <code>Directbuffer memory</code>  错误。</p>\n<h4 id=\"解决方案-7\"><a class=\"markdownIt-Anchor\" href=\"#解决方案-7\">#</a> 解决方案</h4>\n<ul>\n<li><code>Java</code>  只能通过  <code>ByteBuffer</code> . <code>allocateDirect</code>  方法使用  <code>Direct ByteBuffer</code> ，因此，可以通过  <code>Arthas</code>  等在线诊断工具拦截该方法进行排查。</li>\n<li>检查是否直接或间接使用了  <code>NIO</code> ，如  <code>netty</code> ， <code>jetty</code>  等。</li>\n<li>通过启动参数  <code>-XX:MaxDirectMemorySize</code>  调整  <code>Direct ByteBuffer</code>  的上限值。</li>\n<li>检查  <code>JVM</code>  参数是否有  <code>-XX:+DisableExplicitGC</code>  选项，如果有就去掉，因为该参数会使  <code>System.gc()</code>  失效。</li>\n<li>检查堆外内存使用代码，确认是否存在内存泄漏；或者通过反射调用  <code>sun.misc.Cleaner</code>  的  <code>clean()</code>  方法来主动释放被  <code>Direct ByteBuffer</code>  持有的内存空间。</li>\n<li>内存容量确实不足，升级配置。</li>\n</ul>\n<h4 id=\"代码案例-5\"><a class=\"markdownIt-Anchor\" href=\"#代码案例-5\">#</a> 代码案例</h4>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * 演示对外内存溢出</span></span><br><span class=\"line\"><span class=\"comment\"> * -Xms10m -Xmx10m -XX:+PrintGCDetails -XX:MaxDirectMemorySize=5m</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">error</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">    System.out.println(<span class=\"string\">&quot;maxDirectMemory : &quot;</span> + (sun.misc.VM.maxDirectMemory() / (<span class=\"keyword\">double</span>) (<span class=\"number\">1024</span> * <span class=\"number\">1024</span>)) + <span class=\"string\">&quot;MB&quot;</span>);</span><br><span class=\"line\">    ByteBuffer byteBuffer = ByteBuffer.allocateDirect(<span class=\"number\">6</span> * <span class=\"number\">1024</span> * <span class=\"number\">1024</span>);</span><br><span class=\"line\">    System.out.println(byteBuffer);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>报错内容<br>\n<img data-src=\"/images/java/jvm/directBuffer.png\" alt=\"\"></p>\n<h2 id=\"排查思路\"><a class=\"markdownIt-Anchor\" href=\"#排查思路\">#</a> 排查思路</h2>\n<p>分享遇到 <code>OOM</code>  类问题如何快速定位问题，具体哪行代码发生了问题</p>\n<p>什么表现会发生 <code>OOM</code>  呢？</p>\n<p>最直接的～，有报错， <code>outOfMemoryError</code> 。 就是发生了。<br>\n有频繁 <code>GC</code>  的事件发生的时候，也要注意下，可能是在  <code>OOM</code>  的边缘疯狂试探。 比如  <code>FullGC</code> ，  <code>Young GC</code> , 等。<br>\n <code>CPU</code>  占用率较高。<br>\n先说一个思路哈～</p>\n<h3 id=\"止损\"><a class=\"markdownIt-Anchor\" href=\"#止损\">#</a> 止损。</h3>\n<p>如果你在线上遇到了这个问题， 请，务必！ 先将服务重启！立刻，马上。 及时止损。  <code>ps</code> : 可以留一台机器做案发现场，记得下掉该机器，不对外提供服务。</p>\n<h3 id=\"问题排查\"><a class=\"markdownIt-Anchor\" href=\"#问题排查\">#</a> 问题排查</h3>\n<p>注意观察线上服务情况，如果再次出现 <code>OOM</code> , 影响业务，再问题没有解决完成之前，还是采用重启的方式解决。<br>\n可以通过  <code>glowroot</code>  等可视化的监控工具，观察。<br>\n也可以通过在机器上 使用   <code>jstat -gc pid</code>  来查看 <code>GC</code>  情况。<br>\n分析造成 <code>OOM</code>  的问题。(具体如何排查，可参考案例模块)</p>\n<p>查到对应 <code>JVM</code>  进程 =&gt;  排查到占用内存打的 <code>jvm</code>  线程 =&gt; 查看对应线程栈信息 =&gt; 使用 <code>Jmap</code>  来生成线程堆栈信息文件 =&gt; 分析大对象 <code>or</code>  占用内存大的原因 =&gt;  基本上改代码或者 <code>jvm</code>  配置。</p>\n<p>其他排查问题思路和这个也是大差不差，使用的命令不同而已。</p>\n<h3 id=\"案例\"><a class=\"markdownIt-Anchor\" href=\"#案例\">#</a> 案例</h3>\n<details class=\"warning\"><summary>举个栗子🌰吧</summary><div>\n<p>比较常见的应该是：  <code>java.lang. outOfMemoryError: Java heap Space</code></p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * 演示OOM 排查过程</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">heapSpaceError</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">    Thread thread = <span class=\"keyword\">new</span> Thread(() -&gt; bigObject());</span><br><span class=\"line\">    thread.start();</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * 演示大对象</span></span><br><span class=\"line\"><span class=\"comment\"> * -Xms128M -Xmx128M</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">bigObject</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"comment\">// 21 可以，22就会OOM</span></span><br><span class=\"line\">    <span class=\"comment\">// 4* 1024 * 1024 = 4M * 32 = 128M</span></span><br><span class=\"line\">    <span class=\"keyword\">int</span>[] integers = <span class=\"keyword\">new</span> <span class=\"keyword\">int</span>[<span class=\"number\">1024</span> * <span class=\"number\">1024</span> * <span class=\"number\">22</span>];</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>执行后发现控制台打印出了 <code>OOM</code>  :  <code>java heap space</code> .  好吧，就装作看不见吧</p>\n<p>1、使用  <code>jps</code>  命令获取到  <code>jvm</code>  进程号</p>\n<p><img data-src=\"/images/java/jvm/oom%E6%A1%88%E4%BE%8Bjps.png\" alt=\"\"></p>\n<p>2、使用  <code>jmap</code>  命令 <code>dump</code>  出 堆栈信息。<br>\n<img data-src=\"/images/java/jvm/jdump.png\" alt=\"\"></p>\n<p>3、使用  <code>mat</code>  工具，分析 <code>dump</code>  文件内容。  (下载地址:  <code>https://www.eclipse.org/mat/downloads.php</code>    下载是真特🐴的慢啊，<span class=\"label success\">❤️一般人我不告诉他：公众号回复 <code>MAT</code>  就能直接获取</span>)</p>\n<blockquote>\n<p>如果下载之后无法启动的话，提示 无法创建虚拟机。需要简单配置下：<br>\n <code>-vm /Library/Java/JavaVirtualMachines/jdk1.8.0_251.jdk/Contents/Home/bin</code></p>\n</blockquote>\n<p>3.1、下载下 <code>dump</code>  文件，使用本地分析 <code>mat</code>  工具进行分析。</p>\n<p>启动 <code>mat</code> .<br>\n<img data-src=\"/images/java/jvm/mat.png\" alt=\"\"></p>\n<p><code>Open a  heap Dump</code>  之后，就可以愉快的分析了。</p>\n<p>具体分析方法请自行百度吧。</p>\n<p>3.2、如果 <code>dump</code>  文件较小，也可以 <code>java</code>  自带的工具 jhat 命令进行分析。<br>\n<img data-src=\"/images/java/jvm/jmap.png\" alt=\"\"></p>\n<p>然后访问本机的  <code>7000</code>  端口，就可以到看到分析的内容了。<br>\n<img data-src=\"/images/java/jvm/image2021-4-15_19-8-56.png\" alt=\"\"><br>\n进入之后，就可以看到堆内存占用情况的柱状图了。<br>\n<img data-src=\"/images/java/jvm/heapHistogram.png\" alt=\"\"><br>\n发现有  <code>Class[I</code>  占用最多，     <code>Class[I</code>  表示的是  <code>int</code>  数组。 那我们就查下代码里用到 <code>Class[I</code>  中的地方，</p>\n<p>哇，果然是在  <code>new</code>  了一个大的数据，撑爆了内存。</p>\n<p>补充下：</p>\n<p>先查看 jvm 进程号 <br>\n <code> jps </code>   注意：只能查看属于当前用户 <code>java</code>  进程<br>\n  <code>ps -ef| grep java</code>  找到对应服务的进程编号<br>\n <code>ps -ef| grep 服务名</code></p>\n<p>如下图:<br>\n<img data-src=\"/images/java/jvm/%E8%A1%A5%E5%85%85.png\" alt=\"\"><br>\n 需要注意下:</p>\n<p>1) 查看当前应用运行情况信息，查看是否配置了 <code>gc log：-Xloggc:/apps/srv/instance/damai.gaotu100.com/logs/damai.gaotu100.com-gc.log</code>   , 可以从 <code>gc</code>  日志中查到很多信息。</p>\n<p>2）查看是否有 <code>oom</code>  自动打印二进制 <code>dump</code>  文件：  <code>-XX:+HeapDumpOnOutOfMemoryError -XX:HeapDumpPath=/apps/srv/instance/damai.gaotu100.com/logs/heapdump.hprof</code>   。</p>\n<blockquote>\n<p>如果没有配置，可以通过命令自行打印:   <code>jmap -dump:format=b,file=/apps/srv/instance/test-kefu-web.baijiahulian.com/logs/22316.1.hprof pid</code></p>\n</blockquote>\n<p>这里推荐下，阿里开源的 jvm 排查工具  arthas（阿尔萨斯）  <code>https://arthas.aliyun.com/doc/</code> 。文档很全，需要的自行阅读吧～～</p>\n</div></details>\n<h2 id=\"解决方案-8\"><a class=\"markdownIt-Anchor\" href=\"#解决方案-8\">#</a> 解决方案</h2>\n<p>分享遇到 <code>OOM</code>  问题时怎样解决？</p>\n<blockquote>\n<p>长兄于病视神，未有形而除之，故名不出于家。中兄治病，其在毫毛，故名不出于闾。若扁鹊者，镵血脉，投毒药，副肌肤，闲而名出闻于诸侯。 所以才有凡此者不病病，治之无名，使之无形，至功之成，其下谓之自然。<br>\n这句话，用在我们这里就是  系统的整个生命周期中，不出现任何 <code>OOM</code> , 其 谓之自然。</p>\n</blockquote>\n<p>根据上述的排查过程，找到了问题根源之后，那就<br>\n 1. 改代码<br>\n 2. 调整内存配置</p>\n<p>大刀阔斧的干吧！</p>\n<div class=\"note success no-icon\">\n<p>大家有什么建议呢？</p>\n</div>\n<h2 id=\"总结\"><a class=\"markdownIt-Anchor\" href=\"#总结\">#</a> 总结</h2>\n<p>我们看待 <code>OOM</code>  应该从全面来看，有可能是  <code>jvm</code>  内存确实盛不下要分配的对象，也有可能是 频繁 <code>GC</code> ，且收效甚低导致的，还有可能是宿主机上内存不够杀死 <code>jvm</code>  导致的，加载的类过大过多造成的，虚拟内存不够用等等。最后也不要忽略 堆外内存的内存溢出。</p>\n<p>线上遇到这类问题，第一要及时止损，方式很简单，重启就能解决。   保证线上可用之后，再去查问题，根治问题。  同时不用忘了监控线上服务是否有内存要溢出的情况，及时重启，为处理 <code>OOM</code>  问题争取时间。</p>\n<p>排查问题时，首先找到对应 <code>jvm</code>  进程，然后使用 <code>jmap</code>  打印出 内存映射文件，然后使用 <code>jhat</code>  或者  <code>mat</code>  工具进行分析，定位原因。解决问题。</p>\n<p>最后，我们在 <code>coding</code>  的时候，要注意下，不要编写导致 <code>OOM</code>  代码。“未有形而除之～”</p>\n<h2 id=\"抛个问题~\"><a class=\"markdownIt-Anchor\" href=\"#抛个问题~\">#</a> 抛个问题～</h2>\n<p>发生 OOM，程序会退出吗？</p>\n<blockquote>\n<p>下期见</p>\n</blockquote>\n<h4 id=\"最后\"><a class=\"markdownIt-Anchor\" href=\"#最后\">#</a> 最后</h4>\n<p>希望和你一起遇见更好的自己<br>\n<img data-src=\"/images/qrcode.jpg\" alt=\"\"></p>\n",
            "tags": [
                "Java",
                "OOM",
                "JVM"
            ]
        },
        {
            "id": "https://fangjiaxiaobai.github.io/2021/08/19/LeetCode/001-%E5%8F%8D%E8%BD%AC%E6%95%B0%E7%BB%84/",
            "url": "https://fangjiaxiaobai.github.io/2021/08/19/LeetCode/001-%E5%8F%8D%E8%BD%AC%E6%95%B0%E7%BB%84/",
            "title": "LC:反转数组",
            "date_published": "2021-08-19T06:48:55.000Z",
            "content_html": "<h2 id=\"题目\"><a class=\"markdownIt-Anchor\" href=\"#题目\">#</a> 题目</h2>\n<blockquote>\n<p>给定一个数组，将数组中的元素向右移动 k 个位置，其中 k 是非负数。</p>\n</blockquote>\n<p>进阶：</p>\n<p>尽可能想出更多的解决方案，至少有三种不同的方法可以解决这个问题。<br>\n你可以使用空间复杂度为 O (1) 的 原地 算法解决这个问题吗？</p>\n<p>示例 1:</p>\n<p>输入: nums = [1,2,3,4,5,6,7], k = 3<br>\n 输出: [5,6,7,1,2,3,4]<br>\n 解释:<br>\n 向右旋转 1 步: [7,1,2,3,4,5,6]<br>\n 向右旋转 2 步: [6,7,1,2,3,4,5]<br>\n 向右旋转 3 步: [5,6,7,1,2,3,4]</p>\n<p>示例 2:</p>\n<p>输入：nums = [-1,-100,3,99], k = 2<br>\n 输出：[3,99,-1,-100]<br>\n 解释:<br>\n 向右旋转 1 步: [99,-1,-100,3]<br>\n 向右旋转 2 步: [3,99,-1,-100]</p>\n<div class=\"note warning\">\n<p>提示</p>\n</div>\n<p>1 &lt;= nums.length &lt;= 2 * 104<br>\n-231 &lt;= nums[i] &lt;= 231 - 1<br>\n0 &lt;= k &lt;= 105</p>\n<hr>\n<div class=\"links\"><div class=\"item\" title=\"力扣（LeetCode）\" style=\"--block-color:#ffa015;\"><span class=\"exturl image\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvcm90YXRlLWFycmF5\" data-background-image=\"https://static.leetcode-cn.com/cn-frontendx-assets/production/_next/static/images/lccn-logo-ce3d56eeedaae618e59e2ec5089e4834.svg\"></span>\n          <div class=\"info\">\n          <span class=\"exturl title\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvcm90YXRlLWFycmF5\">力扣（LeetCode）</span>\n          <p class=\"desc\">https://leetcode-cn.com/</p>\n          </div></div></div>\n<h2 id=\"分析\"><a class=\"markdownIt-Anchor\" href=\"#分析\">#</a> 分析</h2>\n<h3 id=\"解法1顺序后移法\"><a class=\"markdownIt-Anchor\" href=\"#解法1顺序后移法\">#</a> 解法 1: 顺序后移法</h3>\n<p>将最后一个元素赋值给临时变量，然后将其他元素顺序后移一个位置。重复此操作 k 次。</p>\n<p>但是需要注意的是:</p>\n<ul>\n<li>时间复杂度。这种算法在最优时时间复杂度是 O (n). 最差情况下是 O (n^2). 在 LeetCode 上是没法 AC 的。</li>\n<li>k 是会大于数组长度的。</li>\n</ul>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">rotate</span><span class=\"params\">(<span class=\"keyword\">int</span>[] nums, <span class=\"keyword\">int</span> k)</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (nums == <span class=\"keyword\">null</span> || k &lt; <span class=\"number\">1</span>) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (nums.length &lt; k) &#123;</span><br><span class=\"line\">        <span class=\"comment\">// 解决k&gt;nums.length问题</span></span><br><span class=\"line\">        k = k % nums.length;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">int</span> length = nums.length;</span><br><span class=\"line\">    <span class=\"keyword\">for</span> (<span class=\"keyword\">int</span> i = <span class=\"number\">0</span>; i &lt; k; i++) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">int</span> temp = nums[length - <span class=\"number\">1</span>];</span><br><span class=\"line\">        <span class=\"keyword\">for</span> (<span class=\"keyword\">int</span> j = length - <span class=\"number\">1</span>; j &gt; <span class=\"number\">0</span>; j--) &#123;</span><br><span class=\"line\">            nums[j] = nums[j - <span class=\"number\">1</span>];</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        nums[<span class=\"number\">0</span>] = temp;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>这种解决方法在数据量较大的情况下就会报错 <code>超出时间限制了</code> 。<br>\n即使 你在循环修改使用  <code>System.arraycopy(nums, 0, nums, 1, length - 1);</code>  来替换掉内层循环，也是不可以 <code>AC</code>  的。</p>\n<h3 id=\"解法2-优化解法1空间换时间\"><a class=\"markdownIt-Anchor\" href=\"#解法2-优化解法1空间换时间\">#</a> 解法 2: 优化解法 1, 空间换时间</h3>\n<p>按照规律将 nums 数组中的值，赋值到新数组中。然后使用新数组覆盖原数组。<br>\n那规律是什么呢？<br>\n 设：<br>\n <code>i</code>  为数组的的下标。  <code>newArr</code>  为新的数组， <code>n</code>  为数组总长度，<br>\n 那么</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">newArr[(i+k)%n] = nums[i]</span><br></pre></td></tr></table></figure>\n<p><code>AC</code>  代码如下:</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">rotate</span><span class=\"params\">(<span class=\"keyword\">int</span>[] nums, <span class=\"keyword\">int</span> k)</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (nums == <span class=\"keyword\">null</span> || k &lt; <span class=\"number\">1</span>) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">int</span> n = nums.length;</span><br><span class=\"line\">    <span class=\"comment\">// 新数组</span></span><br><span class=\"line\">    <span class=\"keyword\">int</span>[] newArr = <span class=\"keyword\">new</span> <span class=\"keyword\">int</span>[n];</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">for</span> (<span class=\"keyword\">int</span> i = <span class=\"number\">0</span>; i &lt; k; i++) &#123;</span><br><span class=\"line\">        newArr[(i + k) % n] = nums[i];</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    System.arraycopy(newArr, <span class=\"number\">0</span>, nums, <span class=\"number\">0</span>, n);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>AC 之后显示：<br>\n执行用时  <code>1 ms</code> <br>\n 内存消耗： <code>55.1 MB</code></p>\n<p>这种方式，时间复杂度得到显著的提升，但是带来了额外的空间消耗。而且这种空间消耗是等于原来占用的数据大小。</p>\n<p>那是否还有其他方式呢？</p>\n<h3 id=\"解法3-反转\"><a class=\"markdownIt-Anchor\" href=\"#解法3-反转\">#</a> 解法 3: 反转</h3>\n<p>这种方式是一种比较简单的方式，有点类似于脑筋急转弯的意思。抛开之前的环装思路。将这个数组看成具有方向的一组数据。将这组数据分成三组： <code>[0,k-1]</code> , <code>k</code> , <code>[k+1,length]</code> . 先将  <code>[0,k-1]</code>  反转，再把  <code>[k+1,length]</code>  反转，最后把这个数组反转。这样操作之后，就是最后结果了。</p>\n<p>比如，数组： <code>[1,2,3,4,5,6,7]</code> ,  <code>k=3</code></p>\n<p>第一步：把整体数组进行反转:  <code>[1,2,3,4,5,6,7]</code>  =&gt;  <code>[7,6,5,4,3,2,1]</code> <br>\n 第二步：把 <code>[0,k-1=2]</code>  的元素进行反转:  <code>[7,6,5,4,3,2,1]</code>  =&gt; <code>[5,6,7,4,3,2,1]</code> <br>\n 第三步：把 <code>[k,n-1]</code>  的元素进行反转:  <code>[5,6,7,4,3,2,1]</code>  =&gt; <code>[5,6,7,1,2,3,4]</code></p>\n<p>实现代码如下:</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">rotate</span><span class=\"params\">(<span class=\"keyword\">int</span>[] nums, <span class=\"keyword\">int</span> k)</span> </span>&#123;</span><br><span class=\"line\">    k %= nums.length;</span><br><span class=\"line\">    reverse(nums, <span class=\"number\">0</span>, nums.length - <span class=\"number\">1</span>);</span><br><span class=\"line\">    reverse(nums, <span class=\"number\">0</span>, k - <span class=\"number\">1</span>);</span><br><span class=\"line\">    reverse(nums, k, nums.length - <span class=\"number\">1</span>);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">reverse</span><span class=\"params\">(<span class=\"keyword\">int</span>[] nums, <span class=\"keyword\">int</span> start, <span class=\"keyword\">int</span> end)</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">while</span> (start &lt; end) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">int</span> temp = nums[start];</span><br><span class=\"line\">        nums[start] = nums[end];</span><br><span class=\"line\">        nums[end] = temp;</span><br><span class=\"line\">        start += <span class=\"number\">1</span>;</span><br><span class=\"line\">        end -= <span class=\"number\">1</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"思考\"><a class=\"markdownIt-Anchor\" href=\"#思考\">#</a> 思考</h2>\n<p>关于这道题目的一点小思考:</p>\n<ul>\n<li>这道题其实还有另外一种解法，就是通过公式去推导出元素应该最终所在的位置，直接进行位置交换。这种思路也是可行的。具体解决可以参照下官网的解题方法。</li>\n<li>这是一道很简单的题目，最后出奇的解法也是颇感意外的，总有一种豁然开朗的感觉。我一直在想此法的解题人是怎么想到的呢。<span class=\"label warning\">这里面一定是蕴含一定的逻辑的。这种多次反转的逻辑，或许是一种规律？</span> 我一直没有想通。</li>\n<li>当你想到这个可以用一个环去解决问题的时候，可能永远就想不出 &quot;利用方向&quot; 去解决这个问题了。反观题目来讲，一直都是说的数组，而 “环” 是我们自己强加的一个思维方式。确实，当我们从环的角度出发，看到的就不是题目本身了，看到的是你的题目。<span class=\"label success\">✔️ 反观现实，你理解的现实就真正的是现实吗？你有没有陷入自己的 “环” 中去呢？不妨，重新看看你身边的人和事吧，尝试发现他们最真实的样子.</span></li>\n</ul>\n<h2 id=\"最后\"><a class=\"markdownIt-Anchor\" href=\"#最后\">#</a> 最后</h2>\n<p>希望与你一起遇见更好的自己</p>\n<p><img data-src=\"/images/qrcode.jpg\" alt=\"期望与你一起遇见更好的自己\"></p>\n",
            "tags": [
                "leetCode",
                "数据结构",
                "面经之算法题",
                "数组"
            ]
        },
        {
            "id": "https://fangjiaxiaobai.github.io/2021/08/18/git%E7%B3%BB%E5%88%97/%E7%B3%BB%E5%88%97%E5%BC%80%E7%AF%87/",
            "url": "https://fangjiaxiaobai.github.io/2021/08/18/git%E7%B3%BB%E5%88%97/%E7%B3%BB%E5%88%97%E5%BC%80%E7%AF%87/",
            "title": "git系列开篇",
            "date_published": "2021-08-18T06:48:55.000Z",
            "content_html": "<p>这个是继  <code>Redis</code>  ,  <code>MySQL</code>  之后的第三个系列了。<br>\n然而，前两个系列还都没有写完。<br>\n <code>so</code> ,  <code>Redis</code>  和  <code>MySQL</code>  pause.</p>\n<p>只是暂停～，我会在未来的三年内，将它们全部完成。</p>\n<p>叮～</p>\n<p><code>git</code> ！</p>\n<p>说到 <code>git</code> ，我们先了解一个人， <code>linus Torvalds</code>  （林纳斯・托瓦兹）</p>\n<p><img data-src=\"/images/git%E7%B3%BB%E5%88%97/images/LinusTorvalds01.jpg\" alt=\"linus·Torvalds\"></p>\n<p>林纳斯・托瓦兹 是当今世界最著名的电脑程序员、黑客之一。他是 linux 内核的最早作者，随后发起了这个开源项目，担任 linux 内核的首要架构师和项目协调者。并于 2005 年 7 月 11 日，发布了仅用 10 天时间开发出的最早版本的 git 0.99。到今天 (2020 年 7 月 13 日)，最新的版本号是 2.27. 这个系列就以该版本进行分享。</p>\n<p>关于更多内容，查看这里 -&gt; <span class=\"exturl\" data-url=\"aHR0cHM6Ly96aC53aWtpcGVkaWEub3JnL3dpa2kvJUU2JTlFJTk3JUU3JUJBJUIzJUU2JTk2JUFGJUMyJUI3JUU2JTg5JTk4JUU3JTkzJUE2JUU1JTg1JUI5\">林纳斯・托瓦兹</span></p>\n<h2 id=\"git\"><a class=\"markdownIt-Anchor\" href=\"#git\">#</a> git</h2>\n<p><code>2002</code>  年开始，林纳斯・托瓦斯 决定使用  <code>BitKeeper</code>  作为主要的版本控制系统来维护代码。但是社区中很多人认为，应该使用开源的版本控制软件来维护代码 林纳斯・托瓦斯也考虑使用 <code>monotone</code> ，但是 林纳斯・托瓦斯 嫌弃其性能不佳。在 <code>2005</code>  年，林纳斯决定自行开发一套版本控制系统。</p>\n<p>为什么称为 <code>git</code>  呢？</p>\n<p><code>git</code>  在英氏俚语中表示 不愉快的人。</p>\n<p>下面是 林纳斯・托瓦兹 对 <code>git</code>  的描述</p>\n<blockquote>\n<p>The name “git” was given by Linus Torvalds when he wrote the very first version. He described the tool as “the stupid content tracker” and the name as (depending on your way):<br>\nrandom three-letter combination that is pronounceable, and not actually used by any common UNIX command. The fact that it is a mispronunciation of “get” may or may not be relevant.<br>\n“global information tracker”: you’re in a good mood, and it actually works for you. Angels sing, and a light suddenly fills the room.<br>\nstupid. contemptible and despicable. simple. Take your pick from the dictionary of slang.</p>\n</blockquote>\n<p>林纳斯・托瓦兹在编写第一个版本时就使用了 <code>“git”</code>  这个名称。 他将工具描述为 “愚蠢的内容跟踪器”，并将其描述为（取决于您的方式）：</p>\n<ul>\n<li>可以发音念出的随机三个字母组合，而且并未被实际用在任何  <code>UNIX</code>  指令上。它是 <code>“get”</code>  的错误发音，这点可能相关也可能无关。</li>\n<li>“全局的信息跟踪器”：您的心情不错，对你而言它也确实说得通。天使唱歌，房间突然充满光明。( <code>Global Information tracker</code> )</li>\n<li>愚蠢的。鄙视和卑鄙的。简单。从俚语字典中选择。</li>\n</ul>\n<h3 id=\"git的实现原理\"><a class=\"markdownIt-Anchor\" href=\"#git的实现原理\">#</a> git 的实现原理</h3>\n<p><code>git</code>  更像是一个文件系统，直接从本机上获取数据，不用连接服务端，每个开发者都可有全部开发历史的本地副本， <code>changes</code>  从这种本地 <code>repository</code>  复制给其他开发者。这些 <code>changes</code>  作为新增的开发分支被导入，可以与本地开发分支合并。</p>\n<p>而且，分支是轻量的，一个分支是对一个 <code>commit</code>  的引用。</p>\n<p><code>git</code>  使用 C 语言进行开发的，以追求更高的性能。 <code>git</code>  自动完成了垃圾回收，也可以通过  <code>git gc --prune</code></p>\n<p><code>git</code>  存储每个新创建的 <code>object</code>  作为一个单独文件。为了压缩存储空间占用，  <code>packs</code>  操作把很多文件（启发式类似名字的文件往往具有类似内容）使用差分压缩入一个文件中（ <code>packfile</code> ），并创建一个对应的索引文件，指明 <code>object</code>  在 <code>packfile</code>  中的偏移值。新创建的对象仍然作为单独文件存在。 <code>repacks</code>  操作非常费时间， <code>git</code>  会在空闲时间自动做此操作。也可用命令 <code>git gc</code>  来直接启动 <code>repack</code> 。 <code>packfile</code>  与索引文件都用 SHA-1 作为校验和并作为文件名。 <code>git fsck</code>  命令做校验和的完整性验证。</p>\n<p>Git 服务器典型的 TCP 监听端口为 <code>9418</code> 。</p>\n<p><code>git</code>  和其他版本控制系统（如 <code>CVS</code> ）有不小的差别， <code>git</code>  本身关心文件的整体性是否有改变，但多数的版本控制系统如 <code>CVS</code>  或 <code>Subversion</code>  系统则在乎文件内容的差异。 <code>git</code>  拒绝保持每个文件的版本修订关系。因此查看一个文件的历史需要遍历各个 <code>history</code>  快照； <code>git</code>  隐式处理文件更名，即同名文件默认为其前身，如果没有同名文件则在前一个版本中搜索具有类似内容的文件.</p>\n<p>以上简要介绍，先到这里，我们来看下， <code>git</code>  这一系列文章的目录。</p>\n<ul class=\"task-list\">\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"cbx_0\" checked=\"true\" disabled=\"true\"><label for=\"cbx_0\"> git 介绍</label></li>\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"cbx_1\" checked=\"true\" disabled=\"true\"><label for=\"cbx_1\"> git 安装</label></li>\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"cbx_2\" disabled=\"true\"><label for=\"cbx_2\"> git 简单使用<br>\n介绍 git add、commit、merge、checkout、reset… 等基础命令的使用。</label></li>\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"cbx_3\" disabled=\"true\"><label for=\"cbx_3\"> git 使用进阶<br>\n介绍：git diff、log、reflog，cherry-pick 等命令的使用</label></li>\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"cbx_4\" disabled=\"true\"><label for=\"cbx_4\"> git 高级命令</label></li>\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"cbx_5\" disabled=\"true\"><label for=\"cbx_5\"> git 底层命令</label></li>\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"cbx_6\" disabled=\"true\"><label for=\"cbx_6\"> git 分支</label></li>\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"cbx_7\" disabled=\"true\"><label for=\"cbx_7\"> git 远程仓库</label></li>\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"cbx_8\" disabled=\"true\"><label for=\"cbx_8\"> git 工作流</label></li>\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"cbx_9\" disabled=\"true\"><label for=\"cbx_9\"> git 搜索</label></li>\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"cbx_10\" disabled=\"true\"><label for=\"cbx_10\"> git 再谈重置</label></li>\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"cbx_11\" disabled=\"true\"><label for=\"cbx_11\"> git 安全性验证</label></li>\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"cbx_12\" disabled=\"true\"><label for=\"cbx_12\"> git 钩子</label></li>\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"cbx_13\" disabled=\"true\"><label for=\"cbx_13\"> git 传输协议</label></li>\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"cbx_14\" disabled=\"true\"><label for=\"cbx_14\"> git 数据维护和修复</label></li>\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"cbx_15\" disabled=\"true\"><label for=\"cbx_15\"> git 工作原理</label></li>\n</ul>\n<h3 id=\"推荐书籍\"><a class=\"markdownIt-Anchor\" href=\"#推荐书籍\">#</a> 推荐书籍</h3>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXQtc2NtLmNvbS9ib29rL3poL3Yy\">git-doc</span><br>\n<span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cubGlhb3h1ZWZlbmcuY29tL3dpa2kvODk2MDQzNDg4MDI5NjAw\"> 廖雪峰 Git 教程</span></p>\n<p><b>一个不错的 Github 仓库：</b> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL3Bjb3R0bGUvbGVhcm5HaXRCcmFuY2hpbmc=\">游戏中学 git</span></p>\n<h3 id=\"最后\"><a class=\"markdownIt-Anchor\" href=\"#最后\">#</a> 最后</h3>\n<p>期望与你一起遇见更好的自己</p>\n<p><img data-src=\"/images/qrcode.jpg\" alt=\"期望与你一起遇见更好的自己\"></p>\n",
            "tags": [
                "目录",
                "git"
            ]
        },
        {
            "id": "https://fangjiaxiaobai.github.io/2021/08/04/%E9%9D%A2%E7%BB%8F/%E7%BA%BF%E7%A8%8B%E6%B1%A0/",
            "url": "https://fangjiaxiaobai.github.io/2021/08/04/%E9%9D%A2%E7%BB%8F/%E7%BA%BF%E7%A8%8B%E6%B1%A0/",
            "title": "JDK的内置线程池",
            "date_published": "2021-08-04T06:14:00.000Z",
            "content_html": "<h1 id=\"线程池是什么\"><a class=\"markdownIt-Anchor\" href=\"#线程池是什么\">#</a> 线程池是什么？</h1>\n<p>线程池可以控制线程运行的数量，处理过程中将任务放到队列中，然后在线程创建后启动这些任务，如果线程数量超过了最大数量，那么超出数量的线程就会排队等候，等其他线程执行完毕，再从队列中取出任务来执行。</p>\n<p>主要特点为：<br>\n1、降低资源消耗，通过重复利用已创建的线程创建和销毁造成的消耗。<br>\n2、提供响应速度。当任务到达时，任务可以不需要等待线程创建，能够立即执行。<br>\n3、提高线程的可管理性。线程是稀缺资源，如果无限制的创建，不仅会消耗系统资源，还会降低系统的稳定性。使用线程池可以进行统一的分配，调优和监控。</p>\n<h1 id=\"线程池参数\"><a class=\"markdownIt-Anchor\" href=\"#线程池参数\">#</a> 线程池参数：</h1>\n<ul>\n<li><code>corePoolSize</code> : 线程池中常驻的线程数。</li>\n<li><code>maximumPoolSize</code> : 线程池中能够容纳同时执行的最大线程数，此值必须大于 1.</li>\n<li><code>keepAliveTime</code> : 多余的空闲线程的存活时间。当前线程池数量超过 <code>corePoolSize</code>  时，当空闲时间达 <code>keepAliveTime</code>  值时，多余的空闲线程会被销毁直到剩下 <code>corePoolSize</code>  个线程为止。</li>\n<li><code>unit</code> :  <code>keepAliveTime</code>  的单位.</li>\n<li><code>workQueue</code> : 任务队列，被提交但尚未执行的任务.</li>\n<li><code>threadFactory</code> : 表示生成线程池中工作线程的线程工厂，用于创建线程。</li>\n<li><code>headler</code> : 拒绝策略，表示当队列满了并且工作线程大于等于线程池的最大线程数 ( <code>maximumPoolSize</code> ) 时采取的措施。</li>\n</ul>\n<h1 id=\"线程池运行原理\"><a class=\"markdownIt-Anchor\" href=\"#线程池运行原理\">#</a> 线程池运行原理：</h1>\n<ul>\n<li><code>1</code> . 在创建线程之后，等待提交过来的任务请求。</li>\n<li><code>2</code> . 当调用 <code>execute()</code>  方法添加一个请求任务时，线程池会做如下判断：\n<ul>\n<li><code>2.1</code> 、如果正在运行的线程数量小于 <code>corePoolSize</code> ，那么马上创建线程执行这个任务。</li>\n<li><code>2.2</code> 、如果正在运行的线程数量大于或等于 <code>corePoolSize</code> ，那么将这个任务放入队列。</li>\n<li><code>2.3</code> 、如果这时候队列满了且正在运行的线程数量还小于 <code>maximumPoolSize</code> , 那么创建非核心线程 l 立刻执行这个任务。</li>\n<li><code>2.4</code> 、如果队列满了且正在运行的线程数量大于或者等于这个 <code>maximumPoolSize</code> , 那么线程池会启动饱和拒绝策略来执行。</li>\n</ul>\n</li>\n<li><code>3</code> 、当线程执行完成任务时，它会从队列中取下一个任务来执行。</li>\n<li><code>4</code> 、当线程无事可做超过一定的时间 ( <code>keepAliveTime</code> ) 时，线程池会判断：<br>\n如果当前运行的线程数大于 <code>corePoolSize</code> ，那么这个线程就会被停掉。<br>\n所以线程池的所有任务完成后它最终会收缩到 <code>corePoolSize</code>  的大小。</li>\n</ul>\n<h1 id=\"线程池拒绝策略\"><a class=\"markdownIt-Anchor\" href=\"#线程池拒绝策略\">#</a> 线程池拒绝策略</h1>\n<p>拒绝策略实现了  <code>RejectedExecutionHandler</code>  接口。</p>\n<h2 id=\"jdk内置的四种\"><a class=\"markdownIt-Anchor\" href=\"#jdk内置的四种\">#</a> JDK 内置的四种:</h2>\n<ul>\n<li><code>AbortPolicy</code>  (默认): 直接抛出 <code>RejectedExecutionException</code>  异常阻止系统正常运行。</li>\n<li><code>CallerRunsPolicy</code> : “调用者运行” 一种运行机制，该策略既不会 抛弃任务，也不会抛出异常，而是返回给调用者，从而减轻新任务流量。</li>\n<li><code>DiscardOldestPolicy</code> : 抛弃队列中等待最久的任务，然后把当前任务加入队列中尝试再次提交当前任务。</li>\n<li><code>DiscardPolicy</code> : 直接丢弃任务，不予任何处理也不会抛出异常。如果允许任务丢失，这是最好的</li>\n</ul>\n<h1 id=\"如何配置线程池参数\"><a class=\"markdownIt-Anchor\" href=\"#如何配置线程池参数\">#</a> 如何配置线程池参数</h1>\n<ul>\n<li>\n<p>CPU 密集型:<br>\n 需要大量的运算，没有阻塞。CPU 一直在全速运行。<br>\nCPU 密集型任务只有在真正的多核 CPU 上才可以得到加速</p>\n<p><b>参考公式： CPU 核心数 + 1 个线程</b></p>\n</li>\n<li>\n<p>IO 密集型：<br>\n即该任务需要大量的 IO，即大量的阻塞。<br>\n在单线程上运行 IO 密集型的任务会导致浪费大量的 CPU 运算能力浪费等待。所以在 IO 秘籍型任务重使用多线程可以大大的加速程序运行，即使在单核 CPU 上，这种加速主要就是利用了被浪费掉的阻塞时间。<br>\nIO 密集型，大部分线程都会阻塞。所以需要多配置线程。配置方案有两种：</p>\n<p><b>1、参考公式: CPU 核数 / 1 - 阻塞系数。 阻塞系数在 0.8-0.9 之间。</b><br>\n比如 8 核 CPU:</p>\n<p><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mfrac><mn>8</mn><mrow><mn>1</mn><mo>−</mo><mn>0.9</mn></mrow></mfrac><mo>=</mo><mn>80</mn></mrow><annotation encoding=\"application/x-tex\">\\frac{8}{1-0.9}=80</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1.2484389999999999em;vertical-align:-0.403331em;\"></span><span class=\"mord\"><span class=\"mopen nulldelimiter\"></span><span class=\"mfrac\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.845108em;\"><span style=\"top:-2.655em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">1</span><span class=\"mbin mtight\">−</span><span class=\"mord mtight\">0</span><span class=\"mord mtight\">.</span><span class=\"mord mtight\">9</span></span></span></span><span style=\"top:-3.23em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"frac-line\" style=\"border-bottom-width:0.04em;\"></span></span><span style=\"top:-3.394em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">8</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.403331em;\"><span></span></span></span></span></span><span class=\"mclose nulldelimiter\"></span></span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.64444em;vertical-align:0em;\"></span><span class=\"mord\">8</span><span class=\"mord\">0</span></span></span></span></p>\n<p>个线程<br>\n<b>2、参考公式: CPU 核数 * 2</b></p>\n</li>\n</ul>\n",
            "tags": [
                "线程池",
                "面经"
            ]
        },
        {
            "id": "https://fangjiaxiaobai.github.io/2021/08/02/Redis%E7%B3%BB%E5%88%97/C-1-Redis%E7%9A%84%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B9%8Bziplist/",
            "url": "https://fangjiaxiaobai.github.io/2021/08/02/Redis%E7%B3%BB%E5%88%97/C-1-Redis%E7%9A%84%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B9%8Bziplist/",
            "title": "Redis数据结构之详解 ziplist",
            "date_published": "2021-08-02T10:18:55.000Z",
            "content_html": "<h2 id=\"解密-ziplist\"><a class=\"markdownIt-Anchor\" href=\"#解密-ziplist\">#</a> 解密 ziplist.</h2>\n<p>为什么叫解密  <code>ziplist</code>  呢？因为从 ziplist 中取到我们预期的值，真的和解密一样！烧脑，但是极其有趣！！</p>\n<h3 id=\"引题\"><a class=\"markdownIt-Anchor\" href=\"#引题\">#</a> 引题</h3>\n<p>在介绍  <code>Redis</code>  的数据类型  <code>list</code>  的时候，是我们第一次接触  <code>ziplist</code>  这一数据结构。</p>\n<p>不知道是否还记得  <code>ziplist</code>  这种数据结构的特性。如果不记得也没有关系，今天我们来详细的看下这个数据结构。</p>\n<h3 id=\"重读-ziplist-数据结构\"><a class=\"markdownIt-Anchor\" href=\"#重读-ziplist-数据结构\">#</a> 重读 ziplist 数据结构</h3>\n<p><code>ziplist</code>  是经过特殊编码的双向链接列表，旨在提高内存效率。 它同时存储字符串和整数值，其中整数被编码为实际整数，而不是一系列字符。它允许在  <code>O(1)</code>  时间在列表的任一侧进行推和弹出操作。</p>\n<p>但是，由于每个操作都需要重新分配 <code>ziplist</code>  使用的内存，因此实际的复杂性与 <code>ziplist</code>  使用的内存量有关。</p>\n<p><code>ziplist</code>  的数据结构总览。如下图</p>\n<p><img data-src=\"/images/Redis%E7%B3%BB%E5%88%97/images/ziplist-01-Ziplist%E7%9A%84%E7%BB%93%E6%9E%84.png\" alt=\"\"></p>\n<p>我来依次解释下这  <code>5</code>  个部分.</p>\n<ul>\n<li>\n<p><code>&lt;uint32_t zlbytes&gt;</code>  : 存储的  <code>ziplist</code>  占用的字节数 (包含  <code>zlbytes</code>  字段本身的  <code>4</code>  个字节)。因此：无需遍历就能直接知道这个数据结构的大小。</p>\n</li>\n<li>\n<p><code>&lt;uint32_t zltail&gt;</code>  是列表中最后一个条目的偏移量。 这允许在列表的另一端进行弹出操作，而无需完全遍历。在任意一端进行  <code>pop</code>  和  <code>push</code>  操作的时间复杂度都是  <code>O(1)</code>  .</p>\n</li>\n<li>\n<p><code>&lt;uint16_t zllen&gt;</code>  是条目数。当条目数超过 <code>2 ^ 16-2</code>  时，此值将设置为 <code>2 ^ 16-1</code> ，这时，我们需要遍历整个列表以了解其包含多少项了。</p>\n</li>\n<li>\n<p><code>&lt;uint8_t zlend&gt;</code>  是代表 <code>ziplist</code>  末尾的特殊条目。编码为等于 <code>255</code>  的单个字节。</p>\n</li>\n<li>\n<p><code>&lt;entry&gt;</code>  : 往下看.</p>\n</li>\n</ul>\n<h4 id=\"entry\"><a class=\"markdownIt-Anchor\" href=\"#entry\">#</a>  <code>Entry</code></h4>\n<p><code>ziplist</code>  中的每个条目都以包含两个信息的元数据作为前缀。首先，存储前一个  <code>entry</code>  的长度，以便能够从后到前遍历列表。第二，提供  <code>entry</code>  编码。 它表示条目类型，整数或字符串，对于字符串，还表示字符串有效负载的长度。因此，能够像下面这样存储一个完整的  <code>entry</code> .</p>\n<p><img data-src=\"/images/Redis%E7%B3%BB%E5%88%97/images/ziplist-01-entry%E7%9A%84%E7%BB%93%E6%9E%84.png\" alt=\"\"></p>\n<p>有时， <code>encoding</code>  也可以代表 <code>entry</code>  本身，就像后面将要看到的小整数一样。在这种情况下， <code>&lt;entry-data&gt;</code>  部分丢失了，我们的 <code>Entry</code>  结构是这样的：</p>\n<p><img data-src=\"/images/Redis%E7%B3%BB%E5%88%97/images/ziplist-01-entry%E7%9A%84%E7%BB%93%E6%9E%842.png\" alt=\"\"></p>\n<p>我们来具体看下  <code>Entry</code>  的编码方式.</p>\n<h5 id=\"prevlen\"><a class=\"markdownIt-Anchor\" href=\"#prevlen\">#</a>  <code>prevlen</code></h5>\n<p><code>&lt;prevlen&gt;</code>  表示 前一个  <code>entry</code>  的长度。</p>\n<ul>\n<li>\n<p>如果 前一个  <code>entry</code>  的长度小于 254 个字节，那么这个  <code>Entry</code>  只会消耗一个字节来表示该长度。一个无符号的  <code>8</code>  位整数。</p>\n</li>\n<li>\n<p>如果前一个  <code>entry</code>  长度大于或等于 <code>254</code>  字节的时候，它将占用 5 个字节。第一个字节设置为  <code>254</code> ( <code>FE</code> ), 以指示随后的值更大。 其他的四个字节将作为前一个 entry 的长度的值。</p>\n</li>\n</ul>\n<p>所以，我们就能知道了 下面这种编码方式.</p>\n<p><code>&lt;prevlen form 9 to 253&gt; &lt;encoding&gt; &lt;entry-data&gt;</code></p>\n<p>或者</p>\n<p><code>&lt;prevlen 4 bytes unsigned little endian prevlen&gt; &lt;encoding&gt; &lt;entry-data&gt;</code></p>\n<h5 id=\"encoding\"><a class=\"markdownIt-Anchor\" href=\"#encoding\">#</a>  <code>encoding</code></h5>\n<p><code>entry</code>  中的  <code>encoding</code>  字段取决于  <code>entry-data</code>  的内容。</p>\n<ul>\n<li>\n<p>如果  <code>entry-data</code>  是字符串的时候， <code>encoding</code>  第一个字节的前两位用于存储字符串长度的编码类型。然后是字符串的实际长度。</p>\n</li>\n<li>\n<p>如果  <code>entry</code>  是整数时，前 <code>2</code>  位都是 <code>1</code> ,。 接下来的两位用于指定在此标头之后将存储哪种类型.</p>\n</li>\n</ul>\n<p>由上面的两点，就足以确定  <code>entry-data</code>  的类型.</p>\n<p>不同的类型和编码的概述如下:</p>\n<h6 id=\"字符串类型\"><a class=\"markdownIt-Anchor\" href=\"#字符串类型\">#</a> 字符串类型</h6>\n<ul>\n<li>\n<p><code>a</code> .  <code>| 00pppppp |</code>  : 含义是占用 <code>1</code>  个字节来表示长度小于或等于 <code>63</code>  个字节（ <code>6</code>  位）的字符串值。   <code>pppppp</code>  表示无符号的 6 位长度。</p>\n</li>\n<li>\n<p><code>b</code> . <code>|01pppppp|qqqqqqqq|</code>  含义是用 <code>2</code>  个字节来表示小于等于  <code>16383(2^14)</code>  个字节的字符串的长度. (<b>这里使用大端法计数</b>)</p>\n</li>\n<li>\n<p><code>c</code> . <code>|10000000|qqqqqqqq|rrrrrrrr|ssssssss|tttttttt|</code>  含义是 使用 5 个字节来表示大于等于 16384 个字节长度的字符串，只有 4 个字节表示其最大长度为  <code>2^32-1</code> . 低位的 6 位被设置成  <code>0</code> .(<b>这里使用大端法计数</b>)</p>\n</li>\n</ul>\n<h6 id=\"整数类型\"><a class=\"markdownIt-Anchor\" href=\"#整数类型\">#</a> 整数类型</h6>\n<ul>\n<li><code>d</code> . <code>|11000000|</code> : 含义是用 <code>3</code>  个字节表示一个 <code>16</code>  位的有符号的短整形数 ( <code>short</code> )。</li>\n<li><code>e</code> . <code>|11010000|</code>  : 含义是用 <code>5</code>  个字节 表示一个 <code>32</code>  位的有符合整数型 ( <code>int</code> ).</li>\n<li><code>f</code> . <code>|11100000|</code>  : 含义是用 <code>9</code>  个字节，表示一个 <code>64</code>  位的有符合长整数 ( <code>long</code> )</li>\n<li><code>g</code> . <code>|11110000|</code>  : 含义是用 <code>4</code>  个字节表示 <code>24</code>  位有符号整数 (只占用 3 个字节)。PS: 有什么作用呢？前面说的小整形数。节约空间。即如图</li>\n<li><code>h</code> . <code>|11111110|</code>  :  含义是用 <code>2</code>  个字节表示一个 <code>8</code>  位的有符号小整形数。 <code>1</code>  个字节。</li>\n<li><code>i</code> . <code>|1111xxxx|</code>  :<br>\n 除去上面列举的几类编码标识，还有 <code>|1111xxxx|</code>  的类别。<br>\n( <code>xxxx</code>  在 <code>0000</code>  和 <code>1101</code>  之间) 立即 <code>4</code>  位整数。  <code>0</code>  到 <code>12</code>  之间的无符号整数。编码值实际上是 <code>1</code>  到 <code>13</code> ，因为不能使用 <code>0000</code>  和 <code>1111</code> ，因此应从编码的 <code>4</code>  位值中减去 <code>1</code>  以获得正确的值。</li>\n<li><code>j</code> . <code>|11111111| </code> - 表示  <code>ziplist</code>  的特殊  <code>entry</code></li>\n</ul>\n<p>这样，整个 <code>Entry</code>  的编码方式我们就搞明白了。<br>\n这些都是  <code>Redis</code>  中定义的规定， 所以我们记住就行了。如果让我们自己去设计一套编码方案的时候，我们就可以参考这种思路去设计。</p>\n<h3 id=\"那我们来举两个例子来试试身手吧\"><a class=\"markdownIt-Anchor\" href=\"#那我们来举两个例子来试试身手吧\">#</a> 那我们来举两个例子来试试身手吧。</h3>\n<h4 id=\"例子1-25\"><a class=\"markdownIt-Anchor\" href=\"#例子1-25\">#</a> 例子 1:  <code>25</code></h4>\n<h5 id=\"编码方式\"><a class=\"markdownIt-Anchor\" href=\"#编码方式\">#</a> 编码方式</h5>\n<p><code>[0f 00 00 00] [0c 00 00 00] [02 00] [00 f3] [02 f6] [ff]</code></p>\n<h5 id=\"解析过程\"><a class=\"markdownIt-Anchor\" href=\"#解析过程\">#</a> 解析过程</h5>\n<p><img data-src=\"/images/Redis%E7%B3%BB%E5%88%97/images/ziplist-01-Ziplist%E4%BE%8B%E5%AD%90%E7%9A%84%E7%BB%93%E6%9E%841.png\" alt=\"ziplist-01-Ziplist例子的结构1.png\"></p>\n<p><img data-src=\"/images/Redis%E7%B3%BB%E5%88%97/images/ziplist-%E8%A7%A3%E6%9E%90%E6%95%B0%E6%8D%AE.png\" alt=\"\"></p>\n<h4 id=\"例子2-hello-world\"><a class=\"markdownIt-Anchor\" href=\"#例子2-hello-world\">#</a> 例子 2:  <code>Hello World</code></h4>\n<p>这里我们还是接着上面例子来讲，我们再设置一个 字符串  <code>Hello World</code>  。</p>\n<h5 id=\"编码格式\"><a class=\"markdownIt-Anchor\" href=\"#编码格式\">#</a> 编码格式</h5>\n<p><code>[02] [0b] [48 65 6c 6c 6f 20 57 6f 72 6c 64]</code></p>\n<h5 id=\"解析过程-2\"><a class=\"markdownIt-Anchor\" href=\"#解析过程-2\">#</a> 解析过程</h5>\n<p><img data-src=\"/images/Redis%E7%B3%BB%E5%88%97/images/ziplist-01-Ziplist%E4%BE%8B%E5%AD%90%E7%9A%84%E7%BB%93%E6%9E%842.png\" alt=\"ziplist-01-Ziplist例子的结构2.png\"></p>\n<h5 id=\"附录-ascii码表可展示字符\"><a class=\"markdownIt-Anchor\" href=\"#附录-ascii码表可展示字符\">#</a> 附录，ASCII 码表 (可展示字符)</h5>\n<p><img data-src=\"/images/Redis%E7%B3%BB%E5%88%97/images/ziplist-ASCII%E7%A0%81%E5%AD%97%E7%AC%A6%E8%A1%A8.png\" alt=\"\"></p>\n<p>以上内容，就是 <code>Redis</code>  的 <code>ziplist</code>  结构的内容了。</p>\n<h3 id=\"总结\"><a class=\"markdownIt-Anchor\" href=\"#总结\">#</a> 总结</h3>\n<p>本篇文章的内容主要是更加详细的分享了 <code>ziplist</code>  的这种数据结构的内部结构以及编码方式.</p>\n<ul>\n<li><code>ziplist</code>  由 <code>5</code>  部分组成。存储了相关信息:  <code>&lt;整个ziplist的长度&gt;&lt;最后一个entry的偏移量&gt;&lt;entry的总数&gt;&lt;entries&gt;&lt;表示结束的特殊entry&gt;</code></li>\n<li>一个 <code>entry</code>  由 <code>3</code>  部分组成， <code>&lt;前一个entry的长度&gt;&lt;编码方式&gt;&lt;entry的内容&gt;</code></li>\n<li>其中 编码方式 是由 entry 的内容 决定的。有 10 条标准 (规定 / 协议)</li>\n<li>引用了两个示例 ( <code>25</code>  和 <code>Hello World</code> )，根据 <code>Redis</code>  的方式来解码.</li>\n</ul>\n<h3 id=\"最后\"><a class=\"markdownIt-Anchor\" href=\"#最后\">#</a> 最后</h3>\n<p>期待您的关注，希望和你一起遇见更好的自己</p>\n<p><img data-src=\"/images/Redis%E7%B3%BB%E5%88%97/images/qrcode.jpg\" alt=\"二维码\"></p>\n",
            "tags": [
                "Redis"
            ]
        },
        {
            "id": "https://fangjiaxiaobai.github.io/2021/08/02/Redis%E7%B3%BB%E5%88%97/C-4-%E8%B7%B3%E8%A1%A8/",
            "url": "https://fangjiaxiaobai.github.io/2021/08/02/Redis%E7%B3%BB%E5%88%97/C-4-%E8%B7%B3%E8%A1%A8/",
            "title": "Redis中的数据结构之跳表及其原理",
            "date_published": "2021-08-01T16:00:00.000Z",
            "content_html": "<h2 id=\"前言\"><a class=\"markdownIt-Anchor\" href=\"#前言\">#</a> 前言</h2>\n<p>文中附代码实现. <a href=\"#%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0\">电梯直达</a></p>\n<p>在公众号回复 【跳表】 也可以获取哦。</p>\n<h3 id=\"什么是跳表\"><a class=\"markdownIt-Anchor\" href=\"#什么是跳表\">#</a> 什么是跳表</h3>\n<blockquote>\n<p>跳表是一种数据结构。它允许快速查询一个有序连续元素的数据链表。跳跃列表的平均查找和插入时间复杂度都是 O (log n)，优于普通队列的 O (n)。</p>\n</blockquote>\n <p align=right> from. 维基百科</p>\n<h3 id=\"引题\"><a class=\"markdownIt-Anchor\" href=\"#引题\">#</a> 引题</h3>\n<p>线性表这种数据有两种具体实现，数组和链表。具体的内容之前的文章里也有说过，可以翻翻看哇～。在这里两种数据结构中，数组的优点是查找速度快，而链表的优点是增删的效率高，这也是我们常说的。其实，非也。</p>\n<p>数组是一种内存连续的数据结构，其优点是可以通过 <code>首地址+N*(sizeOf(Node))</code>  来快速获取指定位置上的元素。假如我们不知道指定元素的位置呢？</p>\n<p>链表是一种非内存连续的数据，其优点是通过改变指针地址来快速增减元素。很明显的问题，你首先要知道你要增加 / 删除的目标元素是哪个！所以会浪费  <code>O(n)</code>  的查询时间。</p>\n<p>要论效率，那就要说平衡树 ( <code>AVL</code> ) 了。增删查的效率都是  <code>O(logN)</code> 。 但是这种数据结构，原理比较复杂，实现起来那不是比较复杂了，那是相当复杂。增删操作，都需要其依靠平衡操作引发子树的调整。</p>\n<p>那么，掌声有请我们今天的主角: <b>跳表</b>。</p>\n<h2 id=\"跳表\"><a class=\"markdownIt-Anchor\" href=\"#跳表\">#</a> 跳表</h2>\n<h3 id=\"概念\"><a class=\"markdownIt-Anchor\" href=\"#概念\">#</a> 概念</h3>\n<p>跳表 ( <code>skip list</code> ) 全称 跳跃链表。 是一种类链表的数据结构。</p>\n<p>跳表的性能和平衡树的性能是一样的，在插入，删除，搜索的时间复杂度都是  <code>O(n)</code> , 是一种利用空间换时间的数据结构。</p>\n<p>跳表是一种随机化的数据结构，目前开源软件 Redis 和 LevelDB 都有用到它。</p>\n<p>这里，先给大家看一个<b>可能</b>的跳表结构。</p>\n<p><img data-src=\"/images/Redis%E7%B3%BB%E5%88%97/images/%E8%B7%B3%E8%A1%A8-02-%E5%8F%AF%E8%83%BD%E7%9A%84%E8%B7%B3%E8%A1%A8%E7%BB%93%E6%9E%841.png\" alt=\"跳表-02-可能的跳表结构1.png\"></p>\n<p>现在我要告诉你，上面的跳表是由下面的跳表经过层层优化得来的。</p>\n<p><img data-src=\"/images/Redis%E7%B3%BB%E5%88%97/images/%E8%B7%B3%E8%A1%A8-01-%E6%9C%89%E5%BA%8F%E7%9A%84%E9%93%BE%E8%A1%A8.png\" alt=\"跳表-01-有序的链表\"></p>\n<p>下面我们针对上面的跳表结构来分析一下。</p>\n<p>刚才说过了，链表增删性能罪魁祸首就是查找操作！对于查找操作，效率最高的莫过于二分查找了。但是对于第一个有序链表中是无法使用二分查找的。但是呢，我们可以随机抽选中其中的几个元素，组成一个新的链表。就像下面这样。</p>\n<p><img data-src=\"/images/Redis%E7%B3%BB%E5%88%97/images/%E8%B7%B3%E8%A1%A8-03-%E6%8A%BD%E8%B1%A1%E5%87%BA%E6%96%B0%E7%9A%84%E4%B8%80%E5%B1%82.png\" alt=\"跳表-03-抽象出新的一层.png\"></p>\n<p>假设我们要找 <code>5</code>  这个元素，在单独的有序链表中，我们必须从头结点依次遍历到  <code>5</code>  这个节点。路径为 <code>1-&gt;2-&gt;3-&gt;4-&gt;5</code> , 下图中黄色线路径。, 现在，我们只需要从  <code>1-&gt;2-&gt;4-&gt;5</code> . 下图中紫色线路径。既然我们可以原来的链表抽象出一个新的链表，那我们还可以从新的链表中再抽象出一个新的链表。这样的话，就直接可以  <code>1-&gt;4-&gt;5</code> , 就可以查到一个我们的目标节点了。</p>\n<p><img data-src=\"/images/Redis%E7%B3%BB%E5%88%97/images/%E8%B7%B3%E8%A1%A8-04-%E5%86%8D%E6%8A%BD%E8%B1%A1%E5%87%BA%E6%96%B0%E7%9A%84%E4%B8%80%E5%B1%82.png\" alt=\"跳表-04-再抽象出新的一层.png\"></p>\n<p>如果你看到这里，我要告诉你一个重要的概念了。</p>\n<p><strong>层：就是我们假设的抽象出来的新链表。</strong></p>\n<p>可能你很好奇，层我们应该怎么存储呢？很简单啊！</p>\n<p>以后我们每个链表的元素是怎么定义的？？</p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">typedef</span> <span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">NODE</span> &#123;</span></span><br><span class=\"line\">    T data;</span><br><span class=\"line\">    Node *next;</span><br><span class=\"line\">&#125; node;</span><br></pre></td></tr></table></figure>\n<p>我们只需要将 指向下一个元素的指针改成一个指针数组就可以了！</p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">typedef</span> <span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">NODE</span> &#123;</span></span><br><span class=\"line\">    T data;</span><br><span class=\"line\">    <span class=\"comment\">/// 指向后继元素的指针数组</span></span><br><span class=\"line\">    <span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">Node</span> *<span class=\"title\">next</span>[<span class=\"title\">i</span>];</span></span><br><span class=\"line\">&#125; node;</span><br></pre></td></tr></table></figure>\n<p>了解了怎么存储之后，那怎样确定某个节点有几层呢？这里我告诉你吧，随机的！怎么随机的呢？就是通过随机数来确定的，也就是我们常说的 抛硬币的形式。 比如下面的这段代码.</p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * 生成一个随机数</span></span><br><span class=\"line\"><span class=\"comment\"> * @return 一个随机数</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">int</span> <span class=\"title\">random_level</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">int</span> level = <span class=\"number\">1</span>;</span><br><span class=\"line\">    <span class=\"keyword\">while</span> (<span class=\"built_in\">rand</span>() % <span class=\"number\">2</span>) &#123;</span><br><span class=\"line\">        level++;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    level = (level &lt; MAX_LEVEL) ? level : MAX_LEVEL;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> level;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>那我们就尝试着实现一个跳表。</p>\n<h3 id=\"跳表的实现\"><a class=\"markdownIt-Anchor\" href=\"#跳表的实现\">#</a> 跳表的实现</h3>\n<ul>\n<li>定义跳表的结构</li>\n</ul>\n<p>经过上面的分析，每个节点指向下一个节点的指针是一个数组，所以我们得出下面的结构。(当然也有其他方式的实现，欢迎交流～)</p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/// 节点</span></span><br><span class=\"line\">NODE &#123;</span><br><span class=\"line\">    T data,</span><br><span class=\"line\">    <span class=\"comment\">/// 指向下一个节点的数组，从1开始。</span></span><br><span class=\"line\">    <span class=\"comment\">/// 数组中的每个元素对应该层的下一个节点</span></span><br><span class=\"line\">    <span class=\"comment\">/// next[1],是第一层的下一个节点的地址。</span></span><br><span class=\"line\">    <span class=\"comment\">/// next[2] 是第二层的下一个节点的地址。</span></span><br><span class=\"line\">    NODE []next;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/// 跳表</span></span><br><span class=\"line\">SKIP_LIST&#123;</span><br><span class=\"line\">    NODE head;</span><br><span class=\"line\">    <span class=\"comment\">/// 该跳表的层数</span></span><br><span class=\"line\">    <span class=\"keyword\">int</span> level;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<ul>\n<li>查找指定的元素</li>\n</ul>\n<p>上面说过了 查找过程，我这里就直接给出伪代码了。</p>\n<p>主要逻辑是：从高层开始查找直到找到等于指定元素的节点 E 或者第一个大于指定元素的节点 G。如果是节点 E，那么直接返回就好了。如果是 G 节点，那么就以 G 节点的前一个节点 L, 在下一层进行查找，重复上面的逻辑，直到找到节点 E，或者到达跳表的结尾。</p>\n<p>比如下图中查找  <code>5</code>  的过程为:</p>\n<p><img data-src=\"/images/Redis%E7%B3%BB%E5%88%97/images/%E8%B7%B3%E8%A1%A8-08-%E6%9F%A5%E6%89%BE.png\" alt=\"跳表-08-查找\"></p>\n<ul>\n<li><code>head-&gt;8</code> ,  <code>8&gt;5</code> , 从 <code>head</code>  开始，去下一层查找。</li>\n<li><code>head-&gt;4-&gt;8</code> ,  <code>8&gt;5</code> , 从  <code>4</code>  元素开始查找。去下一层查找</li>\n<li><code>head-&gt;4-&gt;8</code> ,  <code>8&gt;5</code> , 从  <code>4</code>  元素开始查找。去下一层查找.</li>\n<li><code>head-&gt;4-&gt;6</code> ,  <code>6&gt;5</code> , 从  <code>4</code>  元素开始查找。去下一层查找.</li>\n<li><code>head-&gt;4-&gt;5</code> ,  <code>5==5</code> , 返回节点 <code>5</code> .</li>\n</ul>\n<p>如下面的伪代码。</p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">search</span>() &#123;</span><br><span class=\"line\">    <span class=\"comment\">/// i 表示层数，从最高层开始查找 。</span></span><br><span class=\"line\">    <span class=\"keyword\">for</span> (; i &gt;= <span class=\"number\">0</span>; i--) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">while</span> ((q = p-&gt;next[i]) &amp;&amp; q-&gt;k &lt; k) &#123;</span><br><span class=\"line\">            p = q;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (q &amp;&amp; k == q-&gt;data) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> &amp;(q-&gt;data);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<ul>\n<li>构建一个跳表。</li>\n</ul>\n<p>上面分析可以得出来，跳表是一个多层的有序链表。所以我们对于每一层都像操作普通链表一样就可以了。就像下面的这样:</p>\n<p><img data-src=\"/images/Redis%E7%B3%BB%E5%88%97/images/%E8%B7%B3%E8%A1%A8-06-%E6%8F%92%E5%85%A5.png\" alt=\"跳表-06-插入\"></p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">insert</span> () &#123;</span><br><span class=\"line\">    <span class=\"comment\">// 找到要插入的节点位置。</span></span><br><span class=\"line\">    <span class=\"comment\">// level是本跳表的层数</span></span><br><span class=\"line\">    <span class=\"keyword\">for</span> (i = level<span class=\"number\">-1</span>; i &gt;= <span class=\"number\">0</span>; i--) &#123;</span><br><span class=\"line\">        <span class=\"comment\">///遍历该层小于指定值的前一个元素</span></span><br><span class=\"line\">        <span class=\"keyword\">while</span> ((q = p-&gt;next[i]) &amp;&amp; q-&gt;k &lt; k) &#123;</span><br><span class=\"line\">            p = q;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"comment\">/// 新节点的前一个节点的层指针。</span></span><br><span class=\"line\">        update[i] = p;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// 随机生成该节点的层数,如果生成的层数大于当前层，需要更新跳表中记录的level值。</span></span><br><span class=\"line\">    new_level = <span class=\"built_in\">rand_level</span>();</span><br><span class=\"line\">    <span class=\"keyword\">if</span>(new_level &gt; level) &#123;</span><br><span class=\"line\">        level = new_level;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">// 生成新的节点，并针对每一层执行普通链表的插入操作。</span></span><br><span class=\"line\">    new_node = <span class=\"built_in\">create_new_node</span>();</span><br><span class=\"line\">    <span class=\"keyword\">for</span> (i = level - <span class=\"number\">1</span>; i &gt;= <span class=\"number\">0</span>; i--) &#123;</span><br><span class=\"line\">        <span class=\"comment\">/// 下面两行代码就是普通连接的增加方法。</span></span><br><span class=\"line\">        <span class=\"comment\">/// 新节点的前一个节点的第i层的节点。</span></span><br><span class=\"line\">        new_node-&gt;next[i] = update[i]-&gt;next[i];</span><br><span class=\"line\">        update[i]-&gt;next[i] = q;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<ul>\n<li>删除跳表的元素</li>\n</ul>\n<p>主要逻辑是该节点的每一层都要删除.</p>\n<p>即对每一层，都要 要删除节点的上一个节点指向要删除节点的下一个节点。</p>\n<p><img data-src=\"/images/Redis%E7%B3%BB%E5%88%97/images/%E8%B7%B3%E8%A1%A8-07-%E5%88%A0%E9%99%A4.png\" alt=\"跳表-07-删除.png\"></p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">del</span>() &#123;</span><br><span class=\"line\">    <span class=\"comment\">/// 找到要删除的节点</span></span><br><span class=\"line\">    <span class=\"keyword\">for</span> (; i &gt;= <span class=\"number\">0</span>; --i) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">while</span> ((q = p-&gt;next[i]) &amp;&amp; q-&gt;k &lt; k) &#123;</span><br><span class=\"line\">            p = q;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        update[i] = p;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"代码实现\"><a class=\"markdownIt-Anchor\" href=\"#代码实现\">#</a> 代码实现</h3>\n<p>👉 <a href=\"https://github.com/fangjiaxiaobai/data_structures_and_algorithms/tree/master/01_data_structures/skiplist/c/01_fangjiaxiaobai\">跳表 <code>C</code>  语言版本</a><br>\n👉 <a href=\"https://github.com/fangjiaxiaobai/data_structures_and_algorithms/tree/master/01_data_structures/skiplist/java/fangjiaxiaobai\">跳表 <code>JAVA</code>  版本</a></p>\n<p>其他语言，比如  <code>python</code> ,  <code>golang</code> ,  <code>c++</code> ,  <code>js</code> ,  <code>php</code> ,  <code>kotlin</code>  版本的代码，你有没有兴趣搞一波呢？👉 <span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL2ZhbmdqaWF4aWFvYmFpL2RhdGFfc3RydWN0dXJlc19hbmRfYWxnb3JpdGhtcw==\">赐教地址</span></p>\n<p>各位看官可以选择自己熟悉的语言查看。实现代码仅供参考。如有高见，欢迎交流哇～，还请不吝赐教！</p>\n<p>也欢迎大侠提交自己擅长语言的代码到仓库～，集思广益，一起交流！期待～～</p>\n<p>(仓库中的数据结构与算法持续更新哦，欢迎 <code>star</code> )</p>\n<h3 id=\"时间复杂度的分析\"><a class=\"markdownIt-Anchor\" href=\"#时间复杂度的分析\">#</a> 时间复杂度的分析</h3>\n<p>因为跳表的时间复杂度和跳表的层数以及该层上的节点数和节点分布的位置有关，而这些因素都是随机的。 此中涉及了很多复杂的概率统计学知识。所以我就摘自维基百科中的说明，如下:</p>\n<p><img data-src=\"/images/Redis%E7%B3%BB%E5%88%97/images/%E8%B7%B3%E8%A1%A8-05-%E7%9A%84%E6%97%B6%E9%97%B4%E5%A4%8D%E6%9D%82%E5%BA%A6.png\" alt=\"跳表-05-的时间复杂度png\"></p>\n<p>如果看的不是很清晰，也可以这么想：</p>\n<p>如果每两个节点抽出一个节点作为上一级索引的节点，那第一级索引的节点个数大约就是  <code>n/2</code>  , 第二级索引是  <code>n/4</code> , 第三级就是  <code>n/8</code> 。 也就是说 第  <code>k</code>  级索引节点个数是  <code>n/(2^k)</code> ;</p>\n<p>假设，我们有  <code>h</code>  层，最高层索引有 <code>2</code>  个节点，那么， 就是  <code>n/(2^k)=2</code> , 那么 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>k</mi><mo>=</mo><mi>l</mi><mi>o</mi><msub><mi>g</mi><mn>2</mn></msub><mi>N</mi><mo>−</mo><mn>1</mn></mrow><annotation encoding=\"application/x-tex\">k=log_2N-1</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.69444em;vertical-align:0em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.03148em;\">k</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.8888799999999999em;vertical-align:-0.19444em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.01968em;\">l</span><span class=\"mord mathnormal\">o</span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">g</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.30110799999999993em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">2</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mord mathnormal\" style=\"margin-right:0.10903em;\">N</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">−</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.64444em;vertical-align:0em;\"></span><span class=\"mord\">1</span></span></span></span>，这个链表的高度就是 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>l</mi><mi>o</mi><msub><mi>g</mi><mn>2</mn></msub><mi>N</mi></mrow><annotation encoding=\"application/x-tex\">log_2N</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.8888799999999999em;vertical-align:-0.19444em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.01968em;\">l</span><span class=\"mord mathnormal\">o</span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">g</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.30110799999999993em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">2</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mord mathnormal\" style=\"margin-right:0.10903em;\">N</span></span></span></span>. 如果每一层要遍历  <code>m</code>  个节点，那么在跳表中查询一个数据的时间复杂度就是 <code>O(m*logN)</code> .</p>\n<p>由于随机分布的存在，我们可以把 m 当做一个常数，所以，时间复杂度大致可以认为是  <code>O(logN)</code></p>\n<h3 id=\"空间复杂度的分析\"><a class=\"markdownIt-Anchor\" href=\"#空间复杂度的分析\">#</a> 空间复杂度的分析</h3>\n<p>根据整体代码实现来看，我们使用了链表的形式来实现。其中， <code>next</code>  改成了数组用来存储下一节点的指针，并没有真正的存储对象，. 也就是说，其实我们并没有使用很多的内存，当然，比一般的链表还是要多一些的。对于我们存储的对象来讲，用于存储指针的内存直接就可以忽略了。时间复杂度为  <code>O(N+m)</code> , 其中  <code>N&gt;&gt;m</code> ( <code>N</code>  远远大于 <code>m</code> ).</p>\n<h3 id=\"比较\"><a class=\"markdownIt-Anchor\" href=\"#比较\">#</a> 比较</h3>\n<h4 id=\"跳表-与平衡树-哈希表的比较\"><a class=\"markdownIt-Anchor\" href=\"#跳表-与平衡树-哈希表的比较\">#</a> 跳表 与平衡树、哈希表的比较</h4>\n<table>\n<thead>\n<tr>\n<th style=\"text-align:center\"></th>\n<th style=\"text-align:center\">跳表</th>\n<th style=\"text-align:center\">平衡树</th>\n<th style=\"text-align:center\">哈希表</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:center\">有序性</td>\n<td style=\"text-align:center\">有序</td>\n<td style=\"text-align:center\">有序</td>\n<td style=\"text-align:center\">无序</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">查找性能</td>\n<td style=\"text-align:center\">O(logN)</td>\n<td style=\"text-align:center\">O(logN)</td>\n<td style=\"text-align:center\">O(N)</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">实现逻辑</td>\n<td style=\"text-align:center\">简单</td>\n<td style=\"text-align:center\">复杂</td>\n<td style=\"text-align:center\">简单</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">是否支持范围查找</td>\n<td style=\"text-align:center\">支持</td>\n<td style=\"text-align:center\">支持</td>\n<td style=\"text-align:center\">不支持 (无序)</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">时间复杂度</td>\n<td style=\"text-align:center\">较少，取决 p 参数</td>\n<td style=\"text-align:center\">较大 (和跳表比，占用左右子树的两个指针)</td>\n<td style=\"text-align:center\">一般</td>\n</tr>\n</tbody>\n</table>\n<h4 id=\"解释如下\"><a class=\"markdownIt-Anchor\" href=\"#解释如下\">#</a> 解释如下:</h4>\n<ul>\n<li>在做范围查找的时候，平衡树比跳表操作要复杂。在平衡树上，我们找到指定范围的小值之后，还需要以中序遍历的顺序继续寻找其它不超过大值的节点。如果不对平衡树进行一定的改造，这里的中序遍历并不容易实现。而在跳表上进行范围查找就非常简单，只需要在找到小值之后，对第 <code>1</code>  层链表进行若干步的遍历就可以实现。</li>\n<li>平衡树的增删操作可能引发子树的平衡调整，而跳表的插入和删除只需要修改相邻节点的指针，操作简单又快速。</li>\n<li>从内存占用上来说，跳表比平衡树更灵活一些。一般来说，平衡树每个节点包含 <code>2</code>  个指针（分别指向左右子树），而跳表每个节点包含的指针数目平均为 <code>1/(1-p)</code> ，具体取决于参数 <code>p</code>  的大小。如果像 <code>Redis</code>  里的实现一样，取 <code>p=1/4</code> ，那么平均每个节点包含 <code>1.33</code>  个指针，比平衡树更有优势。</li>\n<li>查找单个 <code>key</code> ，跳表和平衡树的时间复杂度都为 <code>O(log n)</code> ，大体相当；而哈希表在保持较低的哈希值冲突概率的前提下，查找时间复杂度接近 <code>O(1)</code> ，性能更高一些。</li>\n</ul>\n<p>我还从网上看到了 <code>Redis</code>  的作者选择 跳表做为 <code>zset</code>  底层数据结构的原因，贴在下面。</p>\n<h4 id=\"redis中作者选择skiplist的原因\"><a class=\"markdownIt-Anchor\" href=\"#redis中作者选择skiplist的原因\">#</a>  <code>Redis</code>  中作者选择 SkipList 的原因:</h4>\n<blockquote>\n<p>There are a few reasons:</p>\n<ol>\n<li>They are not very memory intensive. It’s up to you basically. Changing parameters about the probability of a node to have a given number of levels will make then less memory intensive than btrees.</li>\n<li>A sorted set is often target of many ZRANGE or ZREVRANGE operations, that is, traversing the skip list as a linked list. With this operation the cache locality of skip lists is at least as good as with other kind of balanced trees.</li>\n<li>They are simpler to implement, debug, and so forth. For instance thanks to the skip list simplicity I received a patch (already in Redis master) with augmented skip lists implementing ZRANK in O(log(N)). It required little changes to the code.</li>\n</ol>\n</blockquote>\n<h2 id=\"总结\"><a class=\"markdownIt-Anchor\" href=\"#总结\">#</a> 总结</h2>\n<ul>\n<li>简单的从性能角度分析了数组和链表在性能方面的障碍，引出了我们今天的主角： 跳表。</li>\n<li>画了一个可能出现的跳表结构。这是与跳表的初次见面。并介绍了二分查找的变相应用。当前，这都是基于有序链表为前提的。</li>\n<li>介绍了链表的层的概念，这是跳表相对于链表最重要且唯一的概念，有了它才有了时间复杂度为 <code>O(logN)</code>  的查询效率，从而实现了增删操作的时间复杂度也是 <code>O(logN)</code> 。</li>\n<li>接下来，我们一起完成了跳表的实现逻辑。并且提供了多种语言的跳表实现版本。希望你也提交代码到仓库中，大家一起交流，期待。</li>\n<li>跳表在发展的过程中也出现几个变种，我们的这个只是一个最简答的实现。甚至我们都没有考虑过元素个数与层数的最优解等等问题。后面会有一篇文章分享的是 <code>Redis</code>  中 <code>skiplist</code>  的实现。敬请期待吧～</li>\n</ul>\n<h2 id=\"推荐\"><a class=\"markdownIt-Anchor\" href=\"#推荐\">#</a> 推荐</h2>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cueW91dHViZS5jb20vd2F0Y2g/dj0yZzlPU1JLSnV6TQ==\">某高校跳表公开课 (需科学上网)</span></p>\n<h2 id=\"最后\"><a class=\"markdownIt-Anchor\" href=\"#最后\">#</a> 最后</h2>\n<p>期望与你一起遇见更好的自己</p>\n<p><img data-src=\"/images/qrcode.jpg\" alt=\"期望与你一起遇见更好的自己\"></p>\n",
            "tags": [
                "数据结构",
                "Redis"
            ]
        },
        {
            "id": "https://fangjiaxiaobai.github.io/2021/08/01/Redis%E7%B3%BB%E5%88%97/B-7-Redis%E7%9A%84%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B%E4%B9%8BHyperLogLogs/",
            "url": "https://fangjiaxiaobai.github.io/2021/08/01/Redis%E7%B3%BB%E5%88%97/B-7-Redis%E7%9A%84%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B%E4%B9%8BHyperLogLogs/",
            "title": "Redis数据结构之 `HyperLogLogs`",
            "date_published": "2021-08-01T10:58:55.000Z",
            "content_html": "<h2 id=\"书接上回\"><a class=\"markdownIt-Anchor\" href=\"#书接上回\">#</a> 书接上回</h2>\n<p>上一篇我们学习的  <code>bitmap</code>  这一 <code>“数据类型”</code> 。其内部是由 <code>sds</code>  这种种数据结构编码的。<br>\n如果不记得了，那就来坐穿梭机回去看看吧。 <a href=\"./010-Redis%E7%9A%84%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B9%8B%E4%BD%8D%E5%9B%BEbitmap.md\">开始穿梭</a></p>\n<p>接下来，我们继续学习一个新的 <code>&quot;数据类型&quot;</code> , 位图， <code>HyperLogLogs</code> .（注意啦，数据类型，我又加了引号！！）</p>\n<h2 id=\"hyperloglogs简介\"><a class=\"markdownIt-Anchor\" href=\"#hyperloglogs简介\">#</a>  <code>HyperLogLogs</code>  简介</h2>\n<p><code>HyperLogLog</code>  是一种<b>概率数据结构</b>，用于对唯一事物进行计数（从技术上讲，这是指估计集合的基数）。</p>\n<p>注意哦，  <code>HyperlogLog</code>  其实是一种基数计数算法，并非 <code>Redis</code>  独有的。</p>\n<p>通常，对唯一项目进行计数需要使用与要计数的项目数量成比例的内存量，因为您需要记住过去已经看到的元素，以避免多次对其进行计数。但是，有一组算法会以内存换取精度：以 <code>Redis</code>  实施为例，您得出的带有标准误差的估计度量最终会小于 <code>1％</code> 。</p>\n<p>该算法的神奇之处在于，您不再需要使用与所计数项目数量成比例的内存量，而可以使用恒定数量的内存！在最坏的情况下为 <code>12k</code>  字节，如果您的 <code>HyperLogLogs</code>  看到的元素很少，而且少得多。</p>\n<p><code>Redis</code>  中的 <code>HyperLogLog</code>  尽管在技术上是不同的数据结构，但被编码为 <code>Redis字符串</code>  ( <code>sds</code> )，因此您可以调用 <code>GET</code>  来序列化 <code>HyperLogLogs</code> ，然后调用 <code>SET</code>  来将其反序列化回服务器。这里我们在文末会大体翻一下源码。</p>\n<p>接下来我们先看一下 HyperLogLog 有什么应用场景。</p>\n<h3 id=\"hyperloglog-的应用场景\"><a class=\"markdownIt-Anchor\" href=\"#hyperloglog-的应用场景\">#</a>  <code>HyperLogLog</code>  的应用场景</h3>\n<p>根据 <code>HyperLogLog</code>  的特性来看，使用了一种概率性计数的功能，这样的功能有一个特点就是当数据特别大的时候，其统计的值是不准确的。什么意思呢？</p>\n<p>就是比如统计一个网站的 <code>PV</code> ， <code>PV</code>  数值是  <code>123456789</code>  或者  <code>123456000</code>  这两者的值对于管理者来讲是一样的。对于一些<b>对精度要求不准确而且数据量很大</b>的场景是非常适合的。</p>\n<p>比如以下场景：计算网站的 PV，UV，统计日活，月活，统计用户每天搜索的词条数等等。</p>\n<h3 id=\"hyperloglog-的常用命令\"><a class=\"markdownIt-Anchor\" href=\"#hyperloglog-的常用命令\">#</a>  <code>HyperLogLog</code>  的常用命令</h3>\n<p><code>HyperLogLog</code>  应该是 <code>Redis</code>  所有结构中命令最少的了，只有三个命令。</p>\n<ul>\n<li><code>PFADD key element [element ...]</code></li>\n</ul>\n<p>添加元素。<br>\n如果一个 <code>HyperLogLog</code>  的估计的近似基数在执行命令过程中发了变化，  <code>PFADD</code>  返回 <code>1</code> ，否则返回 <code>0</code> ，如果指定的 <code>key</code>  不存在，这个命令会自动创建一个空的 <code>HyperLogLog</code>  结构（指定长度和编码的字符串）.</p>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">127.0.0.1:<span class=\"number\">6379</span>&gt; pfadd k96 v1 v2 v3</span><br><span class=\"line\">(integer) <span class=\"number\">1</span></span><br><span class=\"line\"><span class=\"number\">127.0</span>.0.1:<span class=\"number\">6379</span>&gt; pfadd k96 v4</span><br><span class=\"line\">(integer) <span class=\"number\">1</span></span><br><span class=\"line\"><span class=\"number\">127.0</span>.0.1:<span class=\"number\">6379</span>&gt; pfadd k96 v1</span><br><span class=\"line\">(integer) <span class=\"number\">0</span></span><br><span class=\"line\"><span class=\"number\">127.0</span>.0.1:<span class=\"number\">6379</span>&gt; pfadd k96 v2 v3 v4</span><br><span class=\"line\">(integer) <span class=\"number\">0</span></span><br><span class=\"line\"><span class=\"number\">127.0</span>.0.1:<span class=\"number\">6379</span>&gt; </span><br></pre></td></tr></table></figure>\n<ul>\n<li><code>PFCOUNT key [key ...]</code></li>\n</ul>\n<p>当参数为一个 <code>key</code>  时，返回存储在 <code>HyperLogLog</code>  结构体的该变量的近似基数，如果该变量不存在，则返回 <code>0</code> .</p>\n<p>当参数为多个 <code>key</code>  时，返回这些 <code>HyperLogLog</code>  并集的近似基数，这个值是将所给定的所有 <code>key</code>  的 <code>HyperLoglog</code>  结构合并到一个临时的 <code>HyperLogLog</code>  结构中计算而得到的.</p>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">127.0.0.1:<span class=\"number\">6379</span>&gt; pfadd k97 v1 v2 v3 v4</span><br><span class=\"line\">(integer) <span class=\"number\">1</span></span><br><span class=\"line\"><span class=\"number\">127.0</span>.0.1:<span class=\"number\">6379</span>&gt; PFCOUNT k97</span><br><span class=\"line\">(integer) <span class=\"number\">4</span></span><br><span class=\"line\"><span class=\"comment\"># 测试多个key</span></span><br><span class=\"line\"><span class=\"number\">127.0</span>.0.1:<span class=\"number\">6379</span>&gt; PFCOUNT k97 k96</span><br><span class=\"line\">(integer) <span class=\"number\">4</span></span><br><span class=\"line\"><span class=\"number\">127.0</span>.0.1:<span class=\"number\">6379</span>&gt; PFADD k97 v5 v6</span><br><span class=\"line\">(integer) <span class=\"number\">1</span></span><br><span class=\"line\"><span class=\"number\">127.0</span>.0.1:<span class=\"number\">6379</span>&gt; PFCOUNT k97 k96</span><br><span class=\"line\">(integer) <span class=\"number\">6</span></span><br></pre></td></tr></table></figure>\n<p>刚才说了， <code>HyperLogLog</code>  只是存储总数的一种结构，而且其值也会和实际值有偏差。我们一起来验证一下这个结果</p>\n<p>我们往 <code>Redis</code>  中插入 <code>10000</code>  条数据，查看其  <code>pfcount</code>  的值是多少。</p>\n<p>使用下面这个脚本去插入 ( <code>java</code>  实现)。公众号回复  <code>RedisClient</code>  可以获取完整源码。</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">String host = <span class=\"string\">&quot;10.1.14.159&quot;</span>;</span><br><span class=\"line\"><span class=\"keyword\">int</span> port = <span class=\"number\">6379</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">SocketRedisClient client = <span class=\"keyword\">new</span> SocketRedisClient(host, port);</span><br><span class=\"line\">String authCmd = client.exec(<span class=\"string\">&quot;auth moyang&quot;</span>);</span><br><span class=\"line\">System.out.println(<span class=\"string\">&quot;登录验证结果:&quot;</span> + authCmd);</span><br><span class=\"line\">System.out.println(<span class=\"string\">&quot;删除已经存在的key :&quot;</span> + client.exec(<span class=\"string\">&quot;del k97&quot;</span>));</span><br><span class=\"line\"><span class=\"keyword\">for</span> (<span class=\"keyword\">int</span> i = <span class=\"number\">1</span>; i &lt;= <span class=\"number\">10000</span>; i++) &#123;</span><br><span class=\"line\">    String cmd = <span class=\"string\">&quot;pfadd k97 &quot;</span> + i;</span><br><span class=\"line\">    client.exec(cmd);</span><br><span class=\"line\"></span><br><span class=\"line\">    String cmd2 = <span class=\"string\">&quot;pfcount k97 &quot;</span>;</span><br><span class=\"line\">    String exec = client.exec(cmd2);</span><br><span class=\"line\">    System.out.println(<span class=\"string\">&quot;执行命令:&quot;</span> + cmd + <span class=\"string\">&quot; 返回结果:&quot;</span> + exec); <span class=\"comment\">// 返回的结果是未解析Redis协议的。</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\">client.releases();</span><br></pre></td></tr></table></figure>\n<p>插入完成之后，如下图，我们可以看到  <code>pfCount</code>  的结果是  <code>9988</code> .</p>\n<p><img data-src=\"/images/Redis%E7%B3%BB%E5%88%97/images/pf-%E6%89%A7%E8%A1%8C10000%E6%AC%A1%E6%8F%92%E5%85%A5%E7%BB%93%E6%9E%9C.png\" alt=\"\"></p>\n<p>如果不相信我们可以 在 <code>shell</code>  里看看。</p>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">127.0.0.1:<span class=\"number\">6379</span>&gt; pfcount k97</span><br><span class=\"line\">(integer) <span class=\"number\">9988</span></span><br></pre></td></tr></table></figure>\n<p>我这次测试正好相等，其实由于脚本的问题呢，从程序里获取的值和 <code>shell</code>  里获取的值，可能不一样，这种怎么解决呢？ 使用脚本单独再执行一次，就会一样了。具体原因，不赘述了。</p>\n<p>好了，我们插入了 <code>10000</code>  次，但是得出的值却是  <code>9988</code> ， 这也就验证了其不精确性。</p>\n<ul>\n<li><code>PFMERGE destkey sourcekey [sourcekey ...]</code></li>\n</ul>\n<p>将多个  <code>HyperLogLog</code>  合并（ <code>merge</code> ）为一个  <code>HyperLogLog</code>  ， 合并后的  <code>HyperLogLog</code>  的基数接近于所有输入  <code>HyperLogLog</code>  的可见集合（ <code>observed set</code> ）的并集.</p>\n<p>合并得出的  <code>HyperLogLog</code>  会被储存在目标变量（第一个参数）里面， 如果该键并不存在， 那么命令在执行之前， 会先为该键创建一个空的  <code>HyperLogLog</code> .</p>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">127.0.0.1:<span class=\"number\">6379</span>&gt; pfadd k98 v1 v2 v3</span><br><span class=\"line\">(integer) <span class=\"number\">1</span></span><br><span class=\"line\"><span class=\"number\">127.0</span>.0.1:<span class=\"number\">6379</span>&gt; pfadd k98_1 v2 v3 v4</span><br><span class=\"line\">(integer) <span class=\"number\">1</span></span><br><span class=\"line\"><span class=\"number\">127.0</span>.0.1:<span class=\"number\">6379</span>&gt; pfadd k98_2 v3 v4 v5</span><br><span class=\"line\">(integer) <span class=\"number\">1</span></span><br><span class=\"line\"><span class=\"number\">127.0</span>.0.1:<span class=\"number\">6379</span>&gt; pfmerge k98 k98_1 k98_2</span><br><span class=\"line\">OK</span><br><span class=\"line\"><span class=\"number\">127.0</span>.0.1:<span class=\"number\">6379</span>&gt; pfcount k98</span><br><span class=\"line\">(integer) <span class=\"number\">5</span></span><br><span class=\"line\"><span class=\"number\">127.0</span>.0.1:<span class=\"number\">6379</span>&gt; pfcount k98_1</span><br><span class=\"line\">(integer) <span class=\"number\">3</span></span><br><span class=\"line\"><span class=\"number\">127.0</span>.0.1:<span class=\"number\">6379</span>&gt; pfcount k98_2</span><br><span class=\"line\">(integer) <span class=\"number\">3</span></span><br></pre></td></tr></table></figure>\n<p>以上就是  <code>HyperLogLog</code>  的命令，老规矩我们下一步来看看  <code>HyperLogLog</code>  在 Redis 中是怎么实现的。</p>\n<h3 id=\"hyperloglog的结构\"><a class=\"markdownIt-Anchor\" href=\"#hyperloglog的结构\">#</a>  <code>HyperLogLog</code>  的结构</h3>\n<p>在  <code>Clion</code>  中直接查找 <code>hyperloglog</code>  ，就是  <code>hyperloglog</code>  的实现了。</p>\n<p><img data-src=\"/images/Redis%E7%B3%BB%E5%88%97/images/hyperloglog-%E6%9F%A5%E6%89%BE%E7%9B%AE%E5%BD%95.png\" alt=\"hyperloglog-查找目录.png\"></p>\n<p>我们可以看到有一个  <code>struct</code></p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">hllhdr</span> &#123;</span></span><br><span class=\"line\">    <span class=\"keyword\">char</span> magic[<span class=\"number\">4</span>];      <span class=\"comment\">/* 魔数: &quot;HYLL&quot; */</span></span><br><span class=\"line\">    <span class=\"keyword\">uint8_t</span> encoding;   <span class=\"comment\">/* HLL_DENSE或HLL_SPARSE */</span></span><br><span class=\"line\">    <span class=\"keyword\">uint8_t</span> notused[<span class=\"number\">3</span>]; <span class=\"comment\">/* 保留以供将来使用，必须为零。 */</span></span><br><span class=\"line\">    <span class=\"keyword\">uint8_t</span> card[<span class=\"number\">8</span>];    <span class=\"comment\">/* 缓存基数，小端。 */</span></span><br><span class=\"line\">    <span class=\"keyword\">uint8_t</span> registers[]; <span class=\"comment\">/* 数据字节。 */</span></span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure>\n<p>这个就是  <code>HyperLogLog</code>  的存储结构了。这里大家大体有个印象就可以了。HyperLogLog 是一种基数估算算法的实现。后面我们会介绍这种<b>基数估算法</b>。</p>\n<h2 id=\"预告\"><a class=\"markdownIt-Anchor\" href=\"#预告\">#</a> 预告</h2>\n<p>最后一个 数据类型  <code>geohash</code>  (多维空间点索引算法)！！！</p>\n<h2 id=\"最后\"><a class=\"markdownIt-Anchor\" href=\"#最后\">#</a> 最后</h2>\n<p>希望与你一起遇见更好的自己</p>\n<p><img data-src=\"/images/Redis%E7%B3%BB%E5%88%97/images/qrcode.jpg\" alt=\"微信二维码\"></p>\n",
            "tags": [
                "Redis"
            ]
        },
        {
            "id": "https://fangjiaxiaobai.github.io/2021/08/01/Redis%E7%B3%BB%E5%88%97/B-6-Redis%E7%9A%84%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B%E4%B9%8B%E4%BD%8D%E5%9B%BEbitmap/",
            "url": "https://fangjiaxiaobai.github.io/2021/08/01/Redis%E7%B3%BB%E5%88%97/B-6-Redis%E7%9A%84%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B%E4%B9%8B%E4%BD%8D%E5%9B%BEbitmap/",
            "title": "Redis数据结构之位图 BitMap",
            "date_published": "2021-08-01T10:48:55.000Z",
            "content_html": "<h2 id=\"书接上回\"><a class=\"markdownIt-Anchor\" href=\"#书接上回\">#</a> 书接上回</h2>\n<p>上一篇我们学习的  <code>zset</code>  集合这一数据类型。其内部是由 <code>skiplist</code>  和 <code>hashtable</code>  这种两种数据结构编码的。<br>\n如果不记得了，那就来坐穿梭机回去看看吧。 <a href=\"/2021/08/01/Redis%E7%B3%BB%E5%88%97/B-5-Redis%E7%9A%84%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B%E4%B9%8B%E6%9C%89%E5%BA%8F%E9%9B%86%E5%90%88zset/\">开始穿梭</a></p>\n<p>接下来，我们继续学习一个新的 <code>&quot;数据类型&quot;</code> , 位图， <code>bitmap</code> .（注意啦，数据类型，我加了引号！！）</p>\n<h2 id=\"bitmap简介\"><a class=\"markdownIt-Anchor\" href=\"#bitmap简介\">#</a>  <code>bitmap</code>  简介</h2>\n<p>那么什么是 <code>bitmap</code> , 我们先从名字上来说， <code>bit</code> ，计算机中最小的单位，一个 <code>bit</code>  表示一个二进制位。 <code>map</code> ，映射，图。所以， <code>bitmap</code>  就是表示对二进制位的映射。那具体是怎么回事呢？ <code>bitmap</code>  其实就是以字符串的形式对二进制位进行操作，从而达到节约空间占用的作用。</p>\n<p>而且， <code>bitmap</code> ，中文的意思就是位图。 不知道你用没用过 <code>C</code>  语言的位图结构，他们的目的都是一样。</p>\n<p>可能你还是不理解，别急，往下看。</p>\n<p><code>bitmap</code>  怎么用呢？</p>\n<p>恰巧，前几天小编在面试中被问到过这个问题。</p>\n<p>面试官说： <b>有个业务场景：我们这边有 10000 家线下门店，我们要对部分门店进行广告投放，怎么记录某条广告投放给哪家门店里了呢？我们的门店 <code>id</code>  是递增的。</b></p>\n<p>首先我们可以有三张表，广告表 ( <code>G</code>  表)，门店表（ <code>M</code>  表），广告门店关联表（ <code>GM</code>  表）。</p>\n<p>如果我们投放广告的时候，把每条广告和每个门店的关联作为一条数据插入到 <code>GM</code>  表中，那么这个表中的数据量增长还是非常快的。如果有 <code>10</code>  万家门店呢？广告的投放和撤销比较频繁。也就是说数据的修改也是比较频繁的。那怎么搞呢？</p>\n<p>门店的 <code>id</code>  是递增的，那么我们可以这么搞，用 <code>10001</code>  个二进制位表示 <code>10000</code>  家门店的 id，如果该门店投放了该广告，就把该位置上的数字置为 <code>1</code> 。并且每四个字节转换成一个整数型数，将（ <code>10000/8/4</code> ） <code>313</code>  个整形数按照一定的规则转换成字符串存储到 <code>GM</code>  表中。表示一条广告已经投放的门店。这样我们就使用了 <code>0.1kb</code>  左右的空间记录了某条广告投放门店的情况。</p>\n<p>其实呢，这就是使用 <code>bitmap</code>  进行存储的。</p>\n<p>接下来，我们看下如何使用 位图。</p>\n<h2 id=\"bitmap的基本命令\"><a class=\"markdownIt-Anchor\" href=\"#bitmap的基本命令\">#</a>  <code>bitmap</code>  的基本命令</h2>\n<ul>\n<li><code>SETBIT</code></li>\n</ul>\n<p><code>setbit key offset value</code></p>\n<p>对  <code>key</code>  所储存的字符串值，设置或清除指定偏移量上的位 ( <code>bit</code> )。<br>\n位的设置或清除取决于  <code>value</code>  参数，可以是  <code>0</code>  也可以是  <code>1</code>  。<br>\n当  <code>key</code>  不存在时，自动生成一个新的字符串值。<br>\n字符串会进行伸展 ( <code>grown</code> ) 以确保它可以将  <code>value</code>  保存在指定的偏移量上。当字符串值进行伸展时，空白位置以  <code>0</code>  填充。<br>\n <code>offset</code>  参数必须大于或等于  <code>0</code>  ，小于  <code>2^32</code>  ( <code>bit</code>  映射被限制在  <code>512 MB</code>  之内)。</p>\n<p>假设我们使用 位图来存储 <code>Redis</code>  这个字符串。</p>\n<p>在演示这个命令之前，我们首先来看下 如何使用二进制来表示字符串。</p>\n<p><code>Redis</code>  中的  <code>R</code>  对应  <code>ASCII</code>  码是:  <code>82</code> . 转化成二进制就是:  <code>0b01010010</code> , 其他字符依次如下所示：<br>\n <code>Redis</code>  中的  <code>e</code>  对应  <code>ASCII</code>  码是:  <code>101</code> . 转化成二进制就是:  <code>0b01100101</code> ，<br>\n <code>Redis</code>  中的  <code>d</code>  对应  <code>ASCII</code>  码是:  <code>100</code> . 转化成二进制就是:  <code>0b01100100</code> ，<br>\n <code>Redis</code>  中的  <code>i</code>  对应  <code>ASCII</code>  码是:  <code>105</code> . 转化成二进制就是:  <code>0b01101001</code> ，<br>\n <code>Redis</code>  中的  <code>s</code>  对应  <code>ASCII</code>  码是:  <code>115</code> . 转化成二进制就是:  <code>0b01110011</code> 。</p>\n<p>看到这里，我要告诉你一个知识点：对于位图的操作，我们可以实现 <b>  <code>零存整取</code>  </b>。 什么意思呢？</p>\n<p>我来给你演示一下</p>\n<p><img data-src=\"/images/Redis%E7%B3%BB%E5%88%97/images/bitmap-R%E7%9A%84%E4%BA%8C%E8%BF%9B%E5%88%B6.png\" alt=\"R对应的位图\"></p>\n<p>如上图， <code>R</code>  这个字符，对应的每个二进制上的数。由于位图会自动填充空位为 0，所以我们只需要设置二进制位上为 <code>1</code>  的就可以了。具体命令如下</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">127.0.0.1:6379&gt; setbit k87 1 1</span><br><span class=\"line\">(integer) 0</span><br><span class=\"line\">127.0.0.1:6379&gt; setbit k87 3 1</span><br><span class=\"line\">(integer) 0</span><br><span class=\"line\">127.0.0.1:6379&gt; setbit k87 6 1</span><br><span class=\"line\">(integer) 0</span><br><span class=\"line\">127.0.0.1:6379&gt; get k87</span><br><span class=\"line\">&quot;R&quot;</span><br></pre></td></tr></table></figure>\n<p>解释一下，我们根据  <code>R</code>  每个二进制位上数值设置到 k87 中，然后通过 <code>get k87</code>  这个命令，返回了  <code>R</code> 。 这就是所谓的  <code>零存整取</code> 。如果我继续设置剩下的  <code>edis</code>  字符串呢？</p>\n<p><img data-src=\"/images/Redis%E7%B3%BB%E5%88%97/images/bitmap-Redis%E7%9A%84%E4%BA%8C%E8%BF%9B%E5%88%B6.png\" alt=\"Redis完整的位图\"></p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">127.0.0.1:6379&gt; setbit k87 9 1</span><br><span class=\"line\">(integer) 0</span><br><span class=\"line\">127.0.0.1:6379&gt; setbit k87 10 1</span><br><span class=\"line\">(integer) 0</span><br><span class=\"line\">127.0.0.1:6379&gt; setbit k87 13 1</span><br><span class=\"line\">(integer) 0</span><br><span class=\"line\">127.0.0.1:6379&gt; setbit k87 15 1</span><br><span class=\"line\">(integer) 0</span><br><span class=\"line\">127.0.0.1:6379&gt; setbit k87 17 1</span><br><span class=\"line\">(integer) 0</span><br><span class=\"line\">127.0.0.1:6379&gt; setbit k87 18 1</span><br><span class=\"line\">(integer) 0</span><br><span class=\"line\">127.0.0.1:6379&gt; setbit k87 21 1</span><br><span class=\"line\">(integer) 0</span><br><span class=\"line\">127.0.0.1:6379&gt; setbit k87 25 1</span><br><span class=\"line\">(integer) 0</span><br><span class=\"line\">127.0.0.1:6379&gt; setbit k87 26 1</span><br><span class=\"line\">(integer) 0</span><br><span class=\"line\">127.0.0.1:6379&gt; setbit k87 28 1</span><br><span class=\"line\">(integer) 0</span><br><span class=\"line\">127.0.0.1:6379&gt; setbit k87 31 1</span><br><span class=\"line\">(integer) 0</span><br><span class=\"line\">127.0.0.1:6379&gt; setbit k87 33 1</span><br><span class=\"line\">(integer) 0</span><br><span class=\"line\">127.0.0.1:6379&gt; setbit k87 34 1</span><br><span class=\"line\">(integer) 0</span><br><span class=\"line\">127.0.0.1:6379&gt; setbit k87 35 1</span><br><span class=\"line\">(integer) 0</span><br><span class=\"line\">127.0.0.1:6379&gt; setbit k87 38 1</span><br><span class=\"line\">(integer) 0</span><br><span class=\"line\">127.0.0.1:6379&gt; setbit k87 39 1</span><br><span class=\"line\">(integer) 0</span><br><span class=\"line\">127.0.0.1:6379&gt; get k87</span><br><span class=\"line\">&quot;Redis&quot;</span><br></pre></td></tr></table></figure>\n<p>这里你就可能说，有谁会这样使用，自己计算出每个位，然后去获取完整的？ 是啊，不过这里只是一个例子，来说明 位图  <code>零存整取</code>  功能，接下来，我们接着看 位图  <code>整存零取</code> 的功能。</p>\n<p>这里呢，就要介绍  <code>gitbit</code>  这个命令。</p>\n<ul>\n<li><code>GETBIT</code></li>\n</ul>\n<p><code>GETBIT key offset</code></p>\n<p>对  <code>key</code>  所储存的字符串值，获取指定 <code>offset</code>  上的位 ( <code>bit</code> ).</p>\n<p>如果 <code>key</code>  不存在，获取 <code>offset</code>  超出范围，返回 <code>0</code> .</p>\n<p>首先我们设置 一个  <code>string</code>  类型的字符串到 <code>Redis</code>  中，然后依次获取每一位上的值。</p>\n<p>可以和下图进行比对。</p>\n<p><img data-src=\"/images/Redis%E7%B3%BB%E5%88%97/images/bitmap-Redis%E7%9A%84%E4%BA%8C%E8%BF%9B%E5%88%B6.png\" alt=\"Redis完整的位图\"></p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">127.0.0.1:6379&gt; set k88 Redis</span><br><span class=\"line\">OK</span><br><span class=\"line\">127.0.0.1:6379&gt; getbit k88 0</span><br><span class=\"line\">(integer) 0</span><br><span class=\"line\">127.0.0.1:6379&gt; getbit k88 1</span><br><span class=\"line\">(integer) 1</span><br><span class=\"line\">127.0.0.1:6379&gt; getbit k88 2</span><br><span class=\"line\">(integer) 0</span><br><span class=\"line\">127.0.0.1:6379&gt; getbit k88 3</span><br><span class=\"line\">(integer) 1</span><br><span class=\"line\">127.0.0.1:6379&gt; getbit k88 4</span><br><span class=\"line\">(integer) 0</span><br><span class=\"line\">127.0.0.1:6379&gt; getbit k88 5</span><br><span class=\"line\">(integer) 0</span><br><span class=\"line\">127.0.0.1:6379&gt; getbit k88 6</span><br><span class=\"line\">(integer) 1</span><br><span class=\"line\">127.0.0.1:6379&gt; getbit k88 7</span><br><span class=\"line\">(integer) 0</span><br><span class=\"line\">127.0.0.1:6379&gt; getbit k88 8</span><br><span class=\"line\">(integer) 0</span><br><span class=\"line\">127.0.0.1:6379&gt; getbit k88 9</span><br><span class=\"line\">(integer) 1</span><br><span class=\"line\">127.0.0.1:6379&gt; getbit k88 10</span><br><span class=\"line\">(integer) 1</span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> ....</span></span><br><span class=\"line\">127.0.0.1:6379&gt; getbit k88 38</span><br><span class=\"line\">(integer) 1</span><br><span class=\"line\">127.0.0.1:6379&gt; getbit k88 39</span><br><span class=\"line\">(integer) 1</span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"><span class=\"comment\"># 演示超出范围</span></span></span><br><span class=\"line\">127.0.0.1:6379&gt; getbit k88 40</span><br><span class=\"line\">(integer) 0</span><br><span class=\"line\">127.0.0.1:6379&gt; getbit k88 41</span><br><span class=\"line\">(integer) 0</span><br><span class=\"line\">127.0.0.1:6379&gt; getbit k88 42</span><br><span class=\"line\">(integer) 0</span><br><span class=\"line\">127.0.0.1:6379&gt; </span><br></pre></td></tr></table></figure>\n<p>这个就是 位图提供的   <code>整存零取</code> 的功能了。综合上面的两项功能，我们轻而易举的就可以得出 Redis 的位图是可以  <code>零存零取</code> 的。就是使用  <code>setbit</code>  和  <code>gitbit</code>  命令了。这里就不演示了。</p>\n<ul>\n<li><code>BITCOUNT</code></li>\n</ul>\n<p><code>bitCount key [start] [end]</code></p>\n<p>计算指定 <code>key</code>  的对应字符串，被设置为 <code>1</code>  的比特位的数量。</p>\n<p>还是以上面的 <code>Redis</code>  为例，一共是 <code>19</code>  位 <code>1</code> . 我们来演示一下</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"><span class=\"comment\"># 不存在的时候，返回0</span></span></span><br><span class=\"line\">127.0.0.1:6379&gt; bitcount k89</span><br><span class=\"line\">(integer) 0</span><br><span class=\"line\">127.0.0.1:6379&gt; set k89 Redis</span><br><span class=\"line\">OK</span><br><span class=\"line\">127.0.0.1:6379&gt; bitcount k89 </span><br><span class=\"line\">(integer) 19</span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> 注意这里start end 都是表示字节。</span></span><br><span class=\"line\">127.0.0.1:6379&gt; bitcount k89 0 1 </span><br><span class=\"line\">(integer) 7</span><br></pre></td></tr></table></figure>\n<p>这个适合什么场景下使用呢？ 比如，我们要计算某个用户登录天数。第一天登录的时候，我们 可以设置  <code>setbit user1 1 1</code> , 第二天设置  <code>setbit use1 2 1</code> , 那么使用  <code>bitcount user1</code>  就能知道该用户总共的登录天数了，也能够计算出该用户在哪天登录了。</p>\n<ul>\n<li><code>BITPOS</code></li>\n</ul>\n<p><code>bitpos key  bit [start] [end]</code></p>\n<p>返回 key 的指定区段内容，第一个 bit 的位置。</p>\n<p>比如我们以  <code>Redis</code>  为例，如下图</p>\n<p><img data-src=\"./images/bitmap-Redis%E7%9A%84%E4%BA%8C%E8%BF%9B%E5%88%B6.png\" alt=\"\"></p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">127.0.0.1:6379&gt; set key90 Redis</span><br><span class=\"line\">OK</span><br><span class=\"line\">127.0.0.1:6379&gt; bitops key90 1</span><br><span class=\"line\">(error) ERR unknown command `bitops`, with args beginning with: `key90`, `1`, </span><br><span class=\"line\">127.0.0.1:6379&gt; bitpos key90 1</span><br><span class=\"line\">(integer) 1</span><br><span class=\"line\">127.0.0.1:6379&gt; bitpos key90 0</span><br><span class=\"line\">(integer) 0</span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> 这里的start和end也指的是字节</span></span><br><span class=\"line\">127.0.0.1:6379&gt; bitpos key90 0 2 10</span><br><span class=\"line\">(integer) 16</span><br><span class=\"line\">127.0.0.1:6379&gt; bitpos key90 1 2 10</span><br><span class=\"line\">(integer) 17</span><br></pre></td></tr></table></figure>\n<ul>\n<li><code>BITOP</code></li>\n</ul>\n<p><code>BITOP operation destkey key [key …]</code></p>\n<p>对一个或多个保存二进制位的字符串 key 进行位元操作，并将结果保存到 destkey 上。</p>\n<p><code>operation</code>  可以是  <code>AND</code>  、  <code>OR</code>  、  <code>NOT</code>  、  <code>XOR</code>  这四种操作中的任意一种：</p>\n<p><code>BITOP AND destkey key [key ...]</code>  ，对一个或多个  <code>key</code>  求逻辑并，并将结果保存到  <code>destkey</code>  。</p>\n<p><code>BITOP OR destkey key [key ...]</code>  ，对一个或多个  <code>key</code>  求逻辑或，并将结果保存到  <code>destkey</code>  。</p>\n<p><code>BITOP XOR destkey key [key ...]</code>  ，对一个或多个  <code>key</code>  求逻辑异或，并将结果保存到  <code>destkey</code>  。</p>\n<p><code>BITOP NOT destkey key</code>  ，对给定  <code>key</code>  求逻辑非，并将结果保存到  <code>destkey</code>  。</p>\n<p>除了  <code>NOT</code>  操作之外，其他操作都可以接受一个或多个  <code>key</code>  作为输入。</p>\n<p>这里我们做一个简单例子。</p>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">127.0.0.1:<span class=\"number\">6379</span>&gt; setbit k91_1 <span class=\"number\">0</span> <span class=\"number\">1</span></span><br><span class=\"line\">(integer) <span class=\"number\">0</span></span><br><span class=\"line\"><span class=\"number\">127.0</span>.0.1:<span class=\"number\">6379</span>&gt; setbit k91_1 <span class=\"number\">1</span> <span class=\"number\">1</span></span><br><span class=\"line\">(integer) <span class=\"number\">0</span></span><br><span class=\"line\"><span class=\"number\">127.0</span>.0.1:<span class=\"number\">6379</span>&gt; setbit k91_1 <span class=\"number\">2</span> <span class=\"number\">1</span></span><br><span class=\"line\">(integer) <span class=\"number\">0</span></span><br><span class=\"line\"><span class=\"number\">127.0</span>.0.1:<span class=\"number\">6379</span>&gt; setbit k91_1 <span class=\"number\">3</span> <span class=\"number\">1</span></span><br><span class=\"line\">(integer) <span class=\"number\">0</span></span><br><span class=\"line\"><span class=\"number\">127.0</span>.0.1:<span class=\"number\">6379</span>&gt; get k91_1 <span class=\"comment\"># 1111 (低位-&gt;高位)</span></span><br><span class=\"line\"><span class=\"string\">&quot;\\xf0&quot;</span></span><br><span class=\"line\"><span class=\"number\">127.0</span>.0.1:<span class=\"number\">6379</span>&gt; setbit k91_2 <span class=\"number\">3</span> <span class=\"number\">1</span></span><br><span class=\"line\">(integer) <span class=\"number\">0</span></span><br><span class=\"line\"><span class=\"number\">127.0</span>.0.1:<span class=\"number\">6379</span>&gt; setbit k91_2 <span class=\"number\">4</span> <span class=\"number\">1</span></span><br><span class=\"line\">(integer) <span class=\"number\">0</span></span><br><span class=\"line\"><span class=\"number\">127.0</span>.0.1:<span class=\"number\">6379</span>&gt; setbit k91_2 <span class=\"number\">5</span> <span class=\"number\">1</span></span><br><span class=\"line\">(integer) <span class=\"number\">0</span></span><br><span class=\"line\"><span class=\"number\">127.0</span>.0.1:<span class=\"number\">6379</span>&gt; get k91_2 <span class=\"comment\"># 000111 (低位-&gt;高位)</span></span><br><span class=\"line\"><span class=\"string\">&quot;\\x1c&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">## and 操作</span></span><br><span class=\"line\"><span class=\"number\">127.0</span>.0.1:<span class=\"number\">6379</span>&gt; bitop AND k91_d_1 k91_1 k91_2</span><br><span class=\"line\">(integer) <span class=\"number\">1</span></span><br><span class=\"line\"><span class=\"number\">127.0</span>.0.1:<span class=\"number\">6379</span>&gt; get k91_d_1 <span class=\"comment\"># 000100 (低位-&gt;高位)</span></span><br><span class=\"line\"><span class=\"string\">&quot;\\x10&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">## OR 操作</span></span><br><span class=\"line\"><span class=\"number\">127.0</span>.0.1:<span class=\"number\">6379</span>&gt; bitop OR k91_d_2 k91_1 k91_2</span><br><span class=\"line\">(integer) <span class=\"number\">1</span></span><br><span class=\"line\"><span class=\"number\">127.0</span>.0.1:<span class=\"number\">6379</span>&gt; get k91_d_2 <span class=\"comment\"># 111111 (低位-&gt;高位)</span></span><br><span class=\"line\"><span class=\"string\">&quot;\\xfc&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">## XOR 亦或操作</span></span><br><span class=\"line\"><span class=\"number\">127.0</span>.0.1:<span class=\"number\">6379</span>&gt; bitop XOR k91_d_3 k91_1 k92_2</span><br><span class=\"line\">(integer) <span class=\"number\">1</span></span><br><span class=\"line\"><span class=\"number\">127.0</span>.0.1:<span class=\"number\">6379</span>&gt; get k91_d_3 <span class=\"comment\"># 111011 (低位-&gt;高位)</span></span><br><span class=\"line\"><span class=\"string\">&quot;\\xf0&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">## NOT 操作</span></span><br><span class=\"line\"><span class=\"number\">127.0</span>.0.1:<span class=\"number\">6379</span>&gt; bitop NOT k91_d_4 k91_1</span><br><span class=\"line\">(integer) <span class=\"number\">1</span></span><br><span class=\"line\"><span class=\"number\">127.0</span>.0.1:<span class=\"number\">6379</span>&gt; get k91_d_4 <span class=\"comment\"># 00001111 (低位-&gt;高位)</span></span><br><span class=\"line\"><span class=\"string\">&quot;\\x0f&quot;</span></span><br><span class=\"line\"><span class=\"number\">127.0</span>.0.1:<span class=\"number\">6379</span>&gt; bitop NOT k91_d_5 k91_2</span><br><span class=\"line\">(integer) <span class=\"number\">1</span></span><br><span class=\"line\"><span class=\"number\">127.0</span>.0.1:<span class=\"number\">6379</span>&gt; get k91_d_5 <span class=\"comment\"># 111011 (低位-&gt;高位)</span></span><br><span class=\"line\"><span class=\"string\">&quot;\\xe3&quot;</span></span><br></pre></td></tr></table></figure>\n<ul>\n<li><code>BITFIELD</code></li>\n</ul>\n<p><code>BITFIELD key [GET type offset] [SET type offset value] [INCRBY type offset increment] [OVERFLOW WRAP|SAT|FAIL]</code></p>\n<p><code>BITFIELD</code>  命令可以将一个  <code>Redis</code>  字符串看作是一个由二进制位组成的数组， 并对这个数组中储存的长度不同的整数进行访问 （被储存的整数无需进行对齐）。 换句话说， 通过这个命令， 用户可以执行诸如 “对偏移量  <code>1234</code>  上的  <code>5</code>  位长有符号整数进行设置”、 “获取偏移量  <code>4567</code>  上的  <code>31</code>  位长无符号整数” 等操作。 此外，  <code>BITFIELD</code>  命令还可以对指定的整数执行加法操作和减法操作， 并且这些操作可以通过设置妥善地处理计算时出现的溢出情况。<br>\n这是一个比较复杂的命令了。我们依次来看看。</p>\n<ul>\n<li><code>GET type offset</code></li>\n</ul>\n<p><code>type</code>  是什么呢？  <code>type</code>  是返回的数值类型。可选值有： <code>i8</code> （有符号 <code>8</code>  个 <code>bit</code>  位）, <code>i16</code> （有符号 <code>16</code>  个 <code>bi</code> t 位）, <code>u8</code> （无符号 <code>8</code>  个 <code>bit</code>  位）, <code>u16</code> （无符号 <code>16</code>  个 <code>bit</code>  位）,…</p>\n<p>这个的命令的功能就是返回执行的二进制的范围，<b>offset 是指第几个二进制位</b>。<br>\n注意：<br>\n <code>BITFIELD</code>  命令最大支持 <code>64</code>  位长的有符号整数以及  <code>63</code>  位长的无符号整数， 其中无符号整数的  <code>63</code>  位长度限制是由于  <code>Redis</code>  协议目前还无法返回  <code>64</code>  位长的无符号整数而导致的。</p>\n<p>用下面这个例子来演示一下。</p>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">127.0.0.1:<span class=\"number\">6379</span>&gt; set k92 Redis</span><br><span class=\"line\">OK</span><br><span class=\"line\"><span class=\"number\">127.0</span>.0.1:<span class=\"number\">6379</span>&gt; bitfield k92 get i8 <span class=\"number\">0</span></span><br><span class=\"line\"><span class=\"number\">1</span>) (integer) <span class=\"number\">82</span></span><br><span class=\"line\"><span class=\"number\">127.0</span>.0.1:<span class=\"number\">6379</span>&gt; bitfield k92 get u8 <span class=\"number\">0</span></span><br><span class=\"line\"><span class=\"number\">1</span>) (integer) <span class=\"number\">82</span></span><br><span class=\"line\"><span class=\"number\">127.0</span>.0.1:<span class=\"number\">6379</span>&gt; bitfield k92 get i16 <span class=\"number\">0</span></span><br><span class=\"line\"><span class=\"number\">1</span>) (integer) <span class=\"number\">21093</span></span><br><span class=\"line\"><span class=\"number\">127.0</span>.0.1:<span class=\"number\">6379</span>&gt; bitfield k92 get u16 <span class=\"number\">0</span></span><br><span class=\"line\"><span class=\"number\">1</span>) (integer) <span class=\"number\">21093</span></span><br></pre></td></tr></table></figure>\n<p>结合上面的那张图，我们看下</p>\n<p><img data-src=\"/images/Redis%E7%B3%BB%E5%88%97/images/bitmap-Redis%E7%9A%84%E4%BA%8C%E8%BF%9B%E5%88%B6.png\" alt=\"Redis的bitmap图\"></p>\n<p>我们手动的将前 <code>8</code>  个 <code>bit</code>  位装换成 <code>10</code>  进制，就是 <code>82</code> 。高位为 <code>0</code> ，所以此时， <code>u8</code>  和 <code>i8</code>  的值是一样的。同样的  <code>u16</code> , <code>i16</code> , <code>u24</code> , <code>u48</code> , 大家可以自行验证一下。</p>\n<ul>\n<li><code>SET type offset value</code></li>\n</ul>\n<p>这个命令是和 <code>GET</code>  命令相反的一个命令。</p>\n<p>直接用一个例子来演示一下。</p>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">127.0.0.1:<span class=\"number\">6379</span>&gt; bitfield k93 SET u8 <span class=\"number\">0</span> <span class=\"number\">82</span></span><br><span class=\"line\"><span class=\"number\">1</span>) (integer) <span class=\"number\">0</span></span><br><span class=\"line\"><span class=\"number\">127.0</span>.0.1:<span class=\"number\">6379</span>&gt; get k93</span><br><span class=\"line\"><span class=\"string\">&quot;R&quot;</span></span><br><span class=\"line\"><span class=\"number\">127.0</span>.0.1:<span class=\"number\">6379</span>&gt; bitfield k93 SET u8 <span class=\"number\">8</span> <span class=\"number\">101</span></span><br><span class=\"line\"><span class=\"number\">1</span>) (integer) <span class=\"number\">0</span></span><br><span class=\"line\"><span class=\"number\">127.0</span>.0.1:<span class=\"number\">6379</span>&gt; get k93</span><br><span class=\"line\"><span class=\"string\">&quot;Re&quot;</span></span><br><span class=\"line\"><span class=\"number\">127.0</span>.0.1:<span class=\"number\">6379</span>&gt; bitfield k93 SET u8 <span class=\"number\">16</span> <span class=\"number\">100</span></span><br><span class=\"line\"><span class=\"number\">1</span>) (integer) <span class=\"number\">0</span></span><br><span class=\"line\"><span class=\"number\">127.0</span>.0.1:<span class=\"number\">6379</span>&gt; get k93</span><br><span class=\"line\"><span class=\"string\">&quot;Red&quot;</span></span><br><span class=\"line\"><span class=\"comment\"># ... </span></span><br><span class=\"line\"><span class=\"comment\"># 剩下的i和s，大家自己试一下吧</span></span><br></pre></td></tr></table></figure>\n<ul>\n<li><code>INCRBY type offset increment</code></li>\n</ul>\n<p>从制定的偏移位开始，增加 <code>increment</code> 。</p>\n<p>什么意思呢？</p>\n<p>来演示一下:</p>\n<p>字符 <code>A</code>  的 <code>ASCII</code>  码是 <code>65</code> ， <code>R</code>  是 <code>82</code> ，如果从 <code>A</code>  变成 <code>R</code> ，需要增加 <code>17</code> 。</p>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">127.0.0.1:<span class=\"number\">6379</span>&gt; set k94 A</span><br><span class=\"line\">OK</span><br><span class=\"line\"><span class=\"number\">127.0</span>.0.1:<span class=\"number\">6379</span>&gt; bitfield k94 INCRBY u8 <span class=\"number\">0</span> <span class=\"number\">17</span></span><br><span class=\"line\"><span class=\"number\">1</span>) (integer) <span class=\"number\">82</span></span><br><span class=\"line\"><span class=\"number\">127.0</span>.0.1:<span class=\"number\">6379</span>&gt; get k94</span><br><span class=\"line\"><span class=\"string\">&quot;R&quot;</span></span><br><span class=\"line\"><span class=\"number\">127.0</span>.0.1:<span class=\"number\">6379</span>&gt; bitfield k94 INCRBY u8 <span class=\"number\">8</span> <span class=\"number\">101</span></span><br><span class=\"line\"><span class=\"number\">1</span>) (integer) <span class=\"number\">101</span>get</span><br><span class=\"line\"><span class=\"number\">127.0</span>.0.1:<span class=\"number\">6379</span>&gt; get k94</span><br><span class=\"line\"><span class=\"string\">&quot;Re&quot;</span></span><br></pre></td></tr></table></figure>\n<ul>\n<li><code>OVERFLOW WRAP|SAT|FAIL</code></li>\n</ul>\n<p>这是 <code>bitmap</code>  对  <code>INCRBY</code>  命令执行时，发生异常行为的控制。</p>\n<p>用户可以通过  <code>OVERFLOW</code>  命令以及以下展示的三个参数， 指定  <code>BITFIELD</code>  命令在执行自增或者自减操作时， 碰上向上溢出（ <code>overflow</code> ）或者向下溢出（ <code>underflow</code> ）情况时的行为：</p>\n<p><code>WRAP</code>  ： 使用回绕（ <code>wrap around</code> ）方法处理有符号整数和无符号整数的溢出情况。 对于无符号整数来说， 回绕就像使用数值本身与能够被储存的最大无符号整数执行取模计算， 这也是  <code>C</code>  语言的标准行为。 对于有符号整数来说， 上溢将导致数字重新从最小的负数开始计算， 而下溢将导致数字重新从最大的正数开始计算。 比如说， 如果我们对一个值为  <code>127</code>  的  <code>i8</code>  整数执行加一操作， 那么将得到结果  <code>-128</code>  。</p>\n<p><code>SAT</code>  ： 使用饱和计算（ <code>saturation arithmetic</code> ）方法处理溢出， 也即是说， 下溢计算的结果为最小的整数值， 而上溢计算的结果为最大的整数值。 举个例子， 如果我们对一个值为  <code>120</code>  的  <code>i8</code>  整数执行加  <code>10</code>  计算， 那么命令的结果将为  <code>i8</code>  类型所能储存的最大整数值  <code>127</code>  。 与此相反， 如果一个针对  <code>i8</code>  值的计算造成了下溢， 那么这个 i8 值将被设置为  <code>-127</code>  。</p>\n<p><code>FAIL</code>  ： 在这一模式下， 命令将拒绝执行那些会导致上溢或者下溢情况出现的计算， 并向用户返回空值表示计算未被执行。</p>\n<p>我们演示一下这几种情况</p>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 使用 WRAP 方式，重复执行相同的命令，在一个2bit上，从 0,1,2,3 来回折返。</span></span><br><span class=\"line\"><span class=\"number\">127.0</span>.0.1:<span class=\"number\">6379</span>&gt; bitfield k95_1 OVERFLOW WRAP incrby u2 <span class=\"number\">1</span> <span class=\"number\">1</span></span><br><span class=\"line\"><span class=\"number\">1</span>) (integer) <span class=\"number\">1</span></span><br><span class=\"line\"><span class=\"number\">127.0</span>.0.1:<span class=\"number\">6379</span>&gt; bitfield k95_1 OVERFLOW WRAP incrby u2 <span class=\"number\">1</span> <span class=\"number\">1</span></span><br><span class=\"line\"><span class=\"number\">1</span>) (integer) <span class=\"number\">2</span></span><br><span class=\"line\"><span class=\"number\">127.0</span>.0.1:<span class=\"number\">6379</span>&gt; bitfield k95_1 OVERFLOW WRAP incrby u2 <span class=\"number\">1</span> <span class=\"number\">1</span></span><br><span class=\"line\"><span class=\"number\">1</span>) (integer) <span class=\"number\">3</span></span><br><span class=\"line\"><span class=\"number\">127.0</span>.0.1:<span class=\"number\">6379</span>&gt; bitfield k95_1 OVERFLOW WRAP incrby u2 <span class=\"number\">1</span> <span class=\"number\">1</span></span><br><span class=\"line\"><span class=\"number\">1</span>) (integer) <span class=\"number\">0</span></span><br><span class=\"line\"><span class=\"number\">127.0</span>.0.1:<span class=\"number\">6379</span>&gt; bitfield k95_1 OVERFLOW WRAP incrby u2 <span class=\"number\">1</span> <span class=\"number\">1</span></span><br><span class=\"line\"><span class=\"number\">1</span>) (integer) <span class=\"number\">1</span></span><br><span class=\"line\"><span class=\"number\">127.0</span>.0.1:<span class=\"number\">6379</span>&gt; bitfield k95_1 OVERFLOW WRAP incrby u2 <span class=\"number\">1</span> <span class=\"number\">1</span></span><br><span class=\"line\"><span class=\"number\">1</span>) (integer) <span class=\"number\">2</span></span><br><span class=\"line\"><span class=\"number\">127.0</span>.0.1:<span class=\"number\">6379</span>&gt; bitfield k95_1 OVERFLOW WRAP incrby u2 <span class=\"number\">1</span> <span class=\"number\">1</span></span><br><span class=\"line\"><span class=\"number\">1</span>) (integer) <span class=\"number\">3</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 使用 SAT 方式，当要发生溢出的时候，不再执行。</span></span><br><span class=\"line\"><span class=\"number\">127.0</span>.0.1:<span class=\"number\">6379</span>&gt; bitfield k95_2 OVERFLOW SAT incrby u2 <span class=\"number\">1</span> <span class=\"number\">1</span></span><br><span class=\"line\"><span class=\"number\">1</span>) (integer) <span class=\"number\">1</span></span><br><span class=\"line\"><span class=\"number\">127.0</span>.0.1:<span class=\"number\">6379</span>&gt; bitfield k95_2 OVERFLOW SAT incrby u2 <span class=\"number\">1</span> <span class=\"number\">1</span></span><br><span class=\"line\"><span class=\"number\">1</span>) (integer) <span class=\"number\">2</span></span><br><span class=\"line\"><span class=\"number\">127.0</span>.0.1:<span class=\"number\">6379</span>&gt; bitfield k95_2 OVERFLOW SAT incrby u2 <span class=\"number\">1</span> <span class=\"number\">1</span></span><br><span class=\"line\"><span class=\"number\">1</span>) (integer) <span class=\"number\">3</span></span><br><span class=\"line\"><span class=\"number\">127.0</span>.0.1:<span class=\"number\">6379</span>&gt; bitfield k95_2 OVERFLOW SAT incrby u2 <span class=\"number\">1</span> <span class=\"number\">1</span></span><br><span class=\"line\"><span class=\"number\">1</span>) (integer) <span class=\"number\">3</span></span><br><span class=\"line\"><span class=\"number\">127.0</span>.0.1:<span class=\"number\">6379</span>&gt; bitfield k95_2 OVERFLOW SAT incrby u2 <span class=\"number\">1</span> <span class=\"number\">1</span></span><br><span class=\"line\"><span class=\"number\">1</span>) (integer) <span class=\"number\">3</span></span><br><span class=\"line\"><span class=\"number\">127.0</span>.0.1:<span class=\"number\">6379</span>&gt; bitfield k95_2 OVERFLOW SAT incrby u2 <span class=\"number\">1</span> <span class=\"number\">1</span></span><br><span class=\"line\"><span class=\"number\">1</span>) (integer) <span class=\"number\">3</span></span><br><span class=\"line\"><span class=\"number\">127.0</span>.0.1:<span class=\"number\">6379</span>&gt; bitfield k95_2 OVERFLOW SAT incrby u2 <span class=\"number\">1</span> <span class=\"number\">1</span></span><br><span class=\"line\"><span class=\"number\">1</span>) (integer) <span class=\"number\">3</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 使用FAIL模式，则返回(nil)，不执行且返回nil</span></span><br><span class=\"line\"><span class=\"number\">127.0</span>.0.1:<span class=\"number\">6379</span>&gt; bitfield k95 OVERFLOW FAIL incrby u2 <span class=\"number\">102</span> <span class=\"number\">1</span></span><br><span class=\"line\"><span class=\"number\">1</span>) (nil)</span><br></pre></td></tr></table></figure>\n<p><code>BITFIELD</code>  命令的作用在于它能够将很多小的整数储存到一个长度较大的位图中， 又或者将一个非常庞大的键分割为多个较小的键来进行储存， 从而非常高效地使用内存， 使得 Redis 能够得到更多不同的应用 —— 特别是在实时分析领域：  <code>BITFIELD</code>  能够以指定的方式对计算溢出进行控制的能力， 使得它可以被应用于这一领域。</p>\n<p>以上就是 <code>Redis</code>  中 <code>bitmap</code>  相关的命令了。下面我简单的来看下 bitmap 这种 <code>&quot;数据结构&quot;</code>  是如何实现的。</p>\n<p>注意，这里的数据结构我还是加上了引号。具体为什么呢？</p>\n<h3 id=\"bitmap-的实现\"><a class=\"markdownIt-Anchor\" href=\"#bitmap-的实现\">#</a>  <code>bitmap</code>  的实现</h3>\n<p>话不多说，我们直接去看看源码中是怎么实现的。直接搜文件  <code>bit</code></p>\n<p><img data-src=\"/images/Redis%E7%B3%BB%E5%88%97/images/bitmap-%E6%9F%A5%E6%89%BE%E7%9B%AE%E5%BD%95.png\" alt=\"bitmap-查找目录\"></p>\n<p>我们要看 <code>src</code>  目录下的，所以，直接看 <code>bitops.c</code></p>\n<p>这里我们就是以一个命令 <code>setbit</code>  为例简单的来看看 <code>bitmap</code>  的运行过程。</p>\n<figure class=\"highlight c\"><figcaption><span>&#123;.line-numbers&#125;</span></figcaption><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * SETBIT 命令的实现</span></span><br><span class=\"line\"><span class=\"comment\"> * @param c 客户端对象</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">setbitCommand</span><span class=\"params\">(client *c)</span> </span>&#123;</span><br><span class=\"line\">    robj *o; <span class=\"comment\">///  setbit key offset value 中的 key对应的Redis Object。</span></span><br><span class=\"line\">    <span class=\"keyword\">char</span> *err = <span class=\"string\">&quot;bit is not an integer or out of range&quot;</span>;</span><br><span class=\"line\">    <span class=\"keyword\">size_t</span> bitoffset; <span class=\"comment\">/// 指定要修改的位的偏移量</span></span><br><span class=\"line\">    <span class=\"keyword\">ssize_t</span> byte, bit;  <span class=\"comment\">/// byte: 要修改的位 所占的字节。第byte个字节上。 bit，在所占字节中的第bit位上。</span></span><br><span class=\"line\">    <span class=\"keyword\">int</span> byteval, bitval; <span class=\"comment\">/// byteval: 要修改的位所占的字节的值。十进制数。  bitVal 是原来的指定bit上的值</span></span><br><span class=\"line\">    <span class=\"keyword\">long</span> on; <span class=\"comment\">/// 修改的值。就是 setbit key offset value 中的value。</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/// 解析 offset 参数，是否符合规范(是否位负数，是否超过512M)</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (getBitOffsetFromArgument(c, c-&gt;argv[<span class=\"number\">2</span>], &amp;bitoffset, <span class=\"number\">0</span>, <span class=\"number\">0</span>) != C_OK)</span><br><span class=\"line\">        <span class=\"keyword\">return</span>;</span><br><span class=\"line\">    <span class=\"comment\">/// 解析 value 参数 =&gt; 赋值给on变量</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (getLongFromObjectOrReply(c, c-&gt;argv[<span class=\"number\">3</span>], &amp;on, err) != C_OK)</span><br><span class=\"line\">        <span class=\"keyword\">return</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/// 验证on(value)只能是0或者1</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (on &amp; ~<span class=\"number\">1</span>) &#123;</span><br><span class=\"line\">        addReplyError(c, err);</span><br><span class=\"line\">        <span class=\"keyword\">return</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"comment\">/// 返回key对应的对象</span></span><br><span class=\"line\">    <span class=\"comment\">/// 该对象是一个OBJ_STRING类型</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> ((o = lookupStringForBitCommand(c, bitoffset)) == <span class=\"literal\">NULL</span>) <span class=\"keyword\">return</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/// 获取当前位置上的值</span></span><br><span class=\"line\">    byte = bitoffset &gt;&gt; <span class=\"number\">3</span>; <span class=\"comment\">/// 计算出字节，确定offset所在的字节。</span></span><br><span class=\"line\">    byteval = ((<span class=\"keyword\">uint8_t</span> *) o-&gt;ptr)[byte]; <span class=\"comment\">/// 将指定字节上的数转换成无符号整型数。</span></span><br><span class=\"line\">    bit = <span class=\"number\">7</span> - (bitoffset &amp; <span class=\"number\">0x7</span>); <span class=\"comment\">/// 计算要修改的位，是当前字节中的第几位。</span></span><br><span class=\"line\">    bitval = byteval &amp; (<span class=\"number\">1</span> &lt;&lt; bit); <span class=\"comment\">/// 计算出修改后的值。(bitVal是修改后的整个字节上值)</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/* Update byte with new bit value and return original value */</span></span><br><span class=\"line\">    <span class=\"comment\">/// 更新 String 的值为 bitVal，并且返回原来的值。</span></span><br><span class=\"line\">    byteval &amp;= ~(<span class=\"number\">1</span> &lt;&lt; bit); <span class=\"comment\">/// 将字节上原来的值，指定位上置为0.(即要赋值的位，bit为当前字节中的位。)</span></span><br><span class=\"line\">    byteval |= ((on &amp; <span class=\"number\">0x1</span>) &lt;&lt; bit); <span class=\"comment\">/// 将on的值复制给byteVal,取或运算，如果on为1，则1，若on为0，则0，上一行代码已经将指定位置置为了0.</span></span><br><span class=\"line\">    ((<span class=\"keyword\">uint8_t</span> *) o-&gt;ptr)[byte] = byteval; <span class=\"comment\">/// 修改对象中指定字节的值。</span></span><br><span class=\"line\">    signalModifiedKey(c-&gt;db, c-&gt;argv[<span class=\"number\">1</span>]); <span class=\"comment\">/// 通知修改了key。</span></span><br><span class=\"line\">    notifyKeyspaceEvent(NOTIFY_STRING, <span class=\"string\">&quot;setbit&quot;</span>, c-&gt;argv[<span class=\"number\">1</span>], c-&gt;db-&gt;id);</span><br><span class=\"line\">    server.dirty++; <span class=\"comment\">// 从上次保存到数据库的更改次数</span></span><br><span class=\"line\">    addReply(c, bitval ? shared.cone : shared.czero); <span class=\"comment\">/// 返回原来的值</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>上面代码就是  <code>setBit</code>  命令的实现过程了，这篇文章中我们不做研究<b>我们只看第 <code>27</code>  行</b>. 这一行中有一个  <code>lookupStringForBitCommand</code>  方法。在这里我们猜测一下，<b> <code>bitmap</code>  其实就是一个  <code>OBJ_STRING</code>  类型的结构</b>。</p>\n<p>到底是不是呢？</p>\n<p>看一下源码。</p>\n<figure class=\"highlight c\"><figcaption><span>&#123;.line-numbers&#125;</span></figcaption><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * 这是用于需要将位写入字符串对象的命令实现的辅助函数。</span></span><br><span class=\"line\"><span class=\"comment\"> *</span></span><br><span class=\"line\"><span class=\"comment\"> * 否则，如果密钥持有错误的类型，则返回NULL，并且*向客户端发送错误。</span></span><br><span class=\"line\"><span class=\"comment\"> * 该命令创建或填充字符串零，以便可以寻址“ maxbit”位。</span></span><br><span class=\"line\"><span class=\"comment\"> * 该对象最终返回。</span></span><br><span class=\"line\"><span class=\"comment\"> * 否则，如果密钥持有错误的类型，则返回NULL并将错误发送给客户端。</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"function\">robj *<span class=\"title\">lookupStringForBitCommand</span><span class=\"params\">(client *c, <span class=\"keyword\">size_t</span> maxbit)</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">size_t</span> byte = maxbit &gt;&gt; <span class=\"number\">3</span>; <span class=\"comment\">// 计算字节</span></span><br><span class=\"line\">    <span class=\"comment\">/// 为写操作找出一个key。 【setbit key offset value】中argv[1] 即为key</span></span><br><span class=\"line\">    robj *o = lookupKeyWrite(c-&gt;db, c-&gt;argv[<span class=\"number\">1</span>]);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/// 是否找到了key</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (o == <span class=\"literal\">NULL</span>) &#123;</span><br><span class=\"line\">        <span class=\"comment\">/// 没有找到。 创建一个对象写入。对象为OBJ_STRING类型。</span></span><br><span class=\"line\">        o = createObject(OBJ_STRING, sdsnewlen(<span class=\"literal\">NULL</span>, byte + <span class=\"number\">1</span>));</span><br><span class=\"line\">        dbAdd(c-&gt;db, c-&gt;argv[<span class=\"number\">1</span>], o);</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">        <span class=\"comment\">/// 找到了key对象，如果不是 OBJ_STRING 类型直接返回。</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (checkType(c, o, OBJ_STRING)) <span class=\"keyword\">return</span> <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">        <span class=\"comment\">/// 获取要修改的对象。上一行代码已经进行了判断，确定其为 OBJ_STRING 类型。</span></span><br><span class=\"line\">        o = dbUnshareStringValue(c-&gt;db, c-&gt;argv[<span class=\"number\">1</span>], o);</span><br><span class=\"line\">        <span class=\"comment\">/// 增加 STRING类型的长度</span></span><br><span class=\"line\">        o-&gt;ptr = sdsgrowzero(o-&gt;ptr, byte + <span class=\"number\">1</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> o;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>在第 <code>17</code>  行和第 <code>23</code>  行。就很清楚了。</p>\n<p>所以，在文章一开始加上引号的 数据结构 ，谜题就解开了。</p>\n<p><b> <code>bitmap</code>  并不是一个新的数据结构，本质上是用  <code>STRING</code>  这个数据结构来实现的。</b></p>\n<p>如果你想看 <code>bitmap</code>  的全部源码，那么满足你！！👉👉 <span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRlZS5jb20vZmFuZ2ppYXhpYW9iYWkvcmVkaXMuZ2l0\">点击这里</span>👈👈</p>\n<p><b>公众号里回复  <code>redis源码</code> ，即可获取完整路径哦</b></p>\n<p>虽然 redis 源码不是我写的，但是我看过的都加上注释啦～</p>\n<p>除此之外，小白还自己实现了一个  <code>bitmap</code> 。感兴趣的朋友欢迎  <code>star</code> .👉👉 <span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL2ZhbmdqaWF4aWFvYmFpL2NvZGVfcmVwby9ibG9iL21hc3Rlci8wMV9kYXRhX3N0cnVjdHVyZXMvYml0bWFwL2JpdG1hcC9CaXRNYXAuamF2YQ==\">bitMap 源码，点击这里</span> 👈👈</p>\n<p><b>公众号里回复  <code>bitmap</code> , 即可获取完整路径哦</b></p>\n<p>当然: JDK 也提供了一个 <code>BitMap</code>  的实现，叫 <code>BitSet</code> ，位于 <code>java.util</code>  包下。其底层使用的是一个 <code>long</code>  类型的数组，一个 <code>long</code>  代表一个 <code>word</code> 。但 <code>BitSet</code>  没有解决上面提到的输入稀疏的问题。谷歌开源的 <code>EWAHCompressedBitMap</code>  解决了输入稀疏的问题。</p>\n<p>这里我们总结一下。</p>\n<table>\n<thead>\n<tr>\n<th><code>Redis</code>  的数据类型</th>\n<th style=\"text-align:center\">底层实现结构</th>\n<th style=\"text-align:center\">文章参考</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>STRING</code></td>\n<td style=\"text-align:center\"><code>sds</code></td>\n<td style=\"text-align:center\"><a href=\"https://mp.weixin.qq.com/s/0sGGSYe5zYNiLUrK5XTsWQ\">数据类型之 <code>String</code> </a></td>\n</tr>\n<tr>\n<td><code>list</code></td>\n<td style=\"text-align:center\"><code>quicklist</code> ,  <code>ziplist</code></td>\n<td style=\"text-align:center\"><a href=\"https://mp.weixin.qq.com/s/n9fzELpKXR1d02yn0usyvg\">数据类型之 <code>list</code> </a></td>\n</tr>\n<tr>\n<td><code>hash</code></td>\n<td style=\"text-align:center\"><code>ziplist</code> ,  <code>dict</code></td>\n<td style=\"text-align:center\"><a href=\"https://mp.weixin.qq.com/s/bQ-jnUuHKLC8-M4G8HpZ9w\">数据类型之 <code>hash</code> </a></td>\n</tr>\n<tr>\n<td><code>set</code></td>\n<td style=\"text-align:center\"><code>dict</code>  , <code>intset</code></td>\n<td style=\"text-align:center\"><a href=\"https://mp.weixin.qq.com/s/qK-CujsG43kAjGpgXYhQWg\">数据类型之 <code>set</code> </a></td>\n</tr>\n<tr>\n<td><code>zset</code></td>\n<td style=\"text-align:center\"><code>dict</code> ,  <code>skipList</code></td>\n<td style=\"text-align:center\"><a href=\"https://mp.weixin.qq.com/s/4fyT9XCLv2MYCtB1WH0Jvg\">数据类型之 <code>zset</code> </a></td>\n</tr>\n<tr>\n<td><code>bitmap</code></td>\n<td style=\"text-align:center\"><code>sds</code></td>\n<td style=\"text-align:center\"><a href=\"#\">数据类型之 <code>bitmap</code> </a></td>\n</tr>\n</tbody>\n</table>\n<h2 id=\"最后\"><a class=\"markdownIt-Anchor\" href=\"#最后\">#</a> 最后</h2>\n<p>希望与你一起遇见更好的自己</p>\n<p><img data-src=\"/images/Redis%E7%B3%BB%E5%88%97/images/qrcode.jpg\" alt=\"微信二维码\"></p>\n",
            "tags": [
                "Redis"
            ]
        },
        {
            "id": "https://fangjiaxiaobai.github.io/2021/08/01/Redis%E7%B3%BB%E5%88%97/B-5-Redis%E7%9A%84%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B%E4%B9%8B%E6%9C%89%E5%BA%8F%E9%9B%86%E5%90%88zset/",
            "url": "https://fangjiaxiaobai.github.io/2021/08/01/Redis%E7%B3%BB%E5%88%97/B-5-Redis%E7%9A%84%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B%E4%B9%8B%E6%9C%89%E5%BA%8F%E9%9B%86%E5%90%88zset/",
            "title": "Redis数据结构之有序集合 zset",
            "date_published": "2021-08-01T10:38:55.000Z",
            "content_html": "<h2 id=\"书接上回\"><a class=\"markdownIt-Anchor\" href=\"#书接上回\">#</a> 书接上回</h2>\n<p>上一篇我们学习的  <code>set</code>  集合这一数据类型。其内部是由 <code>inset</code>  和 <code>hashtable</code>  这种两种数据结构编码的。<br>\n如果不记得了，那就来坐穿梭机回去看看吧。 <a href=\"/2021/08/01/Redis%E7%B3%BB%E5%88%97/B-4-Redis%E7%9A%84%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B%E4%B9%8B%E9%9B%86%E5%90%88set/\">开始穿梭</a></p>\n<p>接下来，我们继续学习一个新的数据类型，有序集合.  <code>zset</code> .</p>\n<h2 id=\"zset简介\"><a class=\"markdownIt-Anchor\" href=\"#zset简介\">#</a>  <code>zset</code>  简介</h2>\n<p><code>zset</code>  , 中文名字叫 有序集合。序这个字，在 <code>Redis</code>  的实现是  <code>score</code>  字段。我们先不急这个字段，后面会介绍。</p>\n<p>在 <code>Redis</code>  中有序的数据类型，还有一个就是我们前面学习的  <code>list</code>  了。 它们还都可以获得某一定范围内的元素。</p>\n<p>而  <code>zset</code>  的优点是：  <code>list</code>  通过链表实现，在两端操作数据都很方便。但是操作中间的数据就比较慢了。  <code>zset</code>  是用  <code>hashtable</code>  和  <code>skiplist</code>  来实现的。即使是操作中间数据，速度也很快。时间复杂度为:  <code>O(logN)</code></p>\n<p><code>zset</code>  的缺点就是：就是比较耗费内存。</p>\n<h2 id=\"zset类型的应用场景\"><a class=\"markdownIt-Anchor\" href=\"#zset类型的应用场景\">#</a>  <code>zset</code>  类型的应用场景</h2>\n<ul>\n<li>存储学生成绩快速做成绩排名功能。</li>\n<li>排行榜，比如：列出某用户当前的全球排名，比赛中胜场数排名。</li>\n<li>带权重的消息队列功能</li>\n</ul>\n<h2 id=\"zset的基本命令\"><a class=\"markdownIt-Anchor\" href=\"#zset的基本命令\">#</a>  <code>zset</code>  的基本命令</h2>\n<h3 id=\"zadd\"><a class=\"markdownIt-Anchor\" href=\"#zadd\">#</a>  <code>zadd</code></h3>\n<ul>\n<li>语法</li>\n</ul>\n<p><code>ZADD key [NX|XX] [CH] [INCR] score member [score member ...]</code></p>\n<ul>\n<li>解释</li>\n</ul>\n<p>将 <code>member</code>  添加有序集合中.</p>\n<p>如果 <code>member</code>  存在，会更新 <code>member</code>  的 <code>score</code>  值。</p>\n<ul>\n<li>\n<p><code>NX</code>  表示存在相同的 <code>member</code>  就会设置失败，NX 的作用就是 新增 <code>member</code> ，不会修改 <code>Member</code></p>\n</li>\n<li>\n<p><code>XX</code>  表示不存在相同的 <code>member</code>  就会设置失败。所以:  <code>XX</code>  总是更新元素。不会新增元素</p>\n</li>\n<li>\n<p><code>CH</code> ( <code>change</code> ): 返回修改的元素个数。更改的元素是添加的新元素以及已为其更新分数的现有元素。因此，命令行中指定的具有与过去相同分数的元素将不计算在内。注意：通常， <code>ZADD</code>  的返回值仅计算添加的新元素的数量。</p>\n</li>\n<li>\n<p><code>INCR</code> : 指定此选项后， <code>ZADD</code>  的行为类似于<a href=\"#ZINCRBY\"> <code>ZINCRBY</code> </a>。在此模式下只能指定一对得分元素。</p>\n</li>\n<li>\n<p>演示</p>\n</li>\n</ul>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"><span class=\"comment\"># 设置一个元素</span></span></span><br><span class=\"line\">127.0.0.1:6379&gt; ZADD k67 1 m1</span><br><span class=\"line\">(integer) 1</span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"><span class=\"comment\"># 设置多个元素</span></span></span><br><span class=\"line\">127.0.0.1:6379&gt; ZADD k67 2 m2 3 m3 4 m4 5 m5</span><br><span class=\"line\">(integer) 4</span><br><span class=\"line\"><span class=\"meta\"></span></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"><span class=\"comment\"># 演示 NX 语义,只能新增.</span></span></span><br><span class=\"line\">127.0.0.1:6379&gt; ZADD k67 NX 5 m5</span><br><span class=\"line\">(integer) 0</span><br><span class=\"line\">127.0.0.1:6379&gt; ZADD k67 NX 6 m6</span><br><span class=\"line\">(integer) 1</span><br><span class=\"line\">127.0.0.1:6379&gt; ZADD k67 NX 6 m6</span><br><span class=\"line\">(integer) 0</span><br><span class=\"line\"><span class=\"meta\"></span></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"><span class=\"comment\"># 演示 XX 语言,只能修改</span></span></span><br><span class=\"line\">127.0.0.1:6379&gt; ZADD k67 XX 7 m7</span><br><span class=\"line\">(integer) 0</span><br><span class=\"line\">127.0.0.1:6379&gt; ZADD k67 7 m7</span><br><span class=\"line\">(integer) 1</span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"><span class=\"comment\"># 进行修改，注意返回值. 如果要返回个数，则加 CH</span></span></span><br><span class=\"line\">127.0.0.1:6379&gt; ZADD k67 XX 7 m7</span><br><span class=\"line\">(integer) 0</span><br><span class=\"line\">127.0.0.1:6379&gt; ZADD k67 XX 77 m7</span><br><span class=\"line\">(integer) 0</span><br><span class=\"line\"><span class=\"meta\"></span></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"><span class=\"comment\"># 演示CH, 返回修改的个数</span></span></span><br><span class=\"line\">127.0.0.1:6379&gt; ZADD k67 CH 8 m8 9 m9 10 m10</span><br><span class=\"line\">(integer) 3</span><br><span class=\"line\">127.0.0.1:6379&gt; ZADD k67 CH 8 m8 999 m9 10 m10</span><br><span class=\"line\">(integer) 1</span><br><span class=\"line\"><span class=\"meta\"></span></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"><span class=\"comment\"># 演示INCR, 增长</span></span></span><br><span class=\"line\">127.0.0.1:6379&gt; ZADD k67 11 m11</span><br><span class=\"line\">(integer) 1</span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"><span class=\"comment\"># 此时 score 表示的是步长</span></span></span><br><span class=\"line\">127.0.0.1:6379&gt; ZADD k67 INCR 10 m11</span><br><span class=\"line\">&quot;21&quot;</span><br><span class=\"line\"><span class=\"meta\"></span></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"><span class=\"comment\"># 查看设置的值。</span></span></span><br><span class=\"line\">127.0.0.1:6379&gt; ZRANGE k67 0 -1 WITHSCORES</span><br><span class=\"line\"> 1) &quot;m1&quot;</span><br><span class=\"line\"> 2) &quot;1&quot;</span><br><span class=\"line\"> 3) &quot;m2&quot;</span><br><span class=\"line\"> 4) &quot;2&quot;</span><br><span class=\"line\"> 5) &quot;m3&quot;</span><br><span class=\"line\"> 6) &quot;3&quot;</span><br><span class=\"line\"> 7) &quot;m4&quot;</span><br><span class=\"line\"> 8) &quot;4&quot;</span><br><span class=\"line\"> 9) &quot;m5&quot;</span><br><span class=\"line\">10) &quot;5&quot;</span><br><span class=\"line\">11) &quot;m6&quot;</span><br><span class=\"line\">12) &quot;6&quot;</span><br><span class=\"line\">13) &quot;m8&quot;</span><br><span class=\"line\">14) &quot;8&quot;</span><br><span class=\"line\">15) &quot;m10&quot;</span><br><span class=\"line\">16) &quot;10&quot;</span><br><span class=\"line\">17) &quot;m11&quot;</span><br><span class=\"line\">18) &quot;21&quot;</span><br><span class=\"line\">19) &quot;m7&quot;</span><br><span class=\"line\">20) &quot;77&quot;</span><br><span class=\"line\">21) &quot;m9&quot;</span><br><span class=\"line\">22) &quot;999&quot;</span><br></pre></td></tr></table></figure>\n<h3 id=\"zscore\"><a class=\"markdownIt-Anchor\" href=\"#zscore\">#</a>  <code>zscore</code></h3>\n<ul>\n<li>语法</li>\n</ul>\n<p><code>ZSCORE key member</code></p>\n<ul>\n<li>解释</li>\n</ul>\n<p><code>zset score</code></p>\n<p>查看对应元素的 <code>score</code>  值</p>\n<pre><code>* 当`key`不存在或者`member`不存在的时候,返回`(nil)`\n</code></pre>\n<p>返回 <code>score</code>  的值。</p>\n<ul>\n<li>演示</li>\n</ul>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 验证k68不存在的时候，返回nil</span></span><br><span class=\"line\">127.0.0.1:6379&gt; ZSCORE k68 m1</span><br><span class=\"line\">(nil)</span><br><span class=\"line\">127.0.0.1:6379&gt; ZADD k68 1 m1</span><br><span class=\"line\">(<span class=\"built_in\">integer</span>) 1</span><br><span class=\"line\"><span class=\"comment\"># 返回元素的score值</span></span><br><span class=\"line\">127.0.0.1:6379&gt; ZSCORE k68 m1</span><br><span class=\"line\"><span class=\"string\">&quot;1&quot;</span></span><br><span class=\"line\"><span class=\"comment\"># 验证 member 不存在的时候，返回</span></span><br><span class=\"line\">127.0.0.1:6379&gt; ZSCORE k68 m2</span><br><span class=\"line\">(nil)</span><br></pre></td></tr></table></figure>\n<h3 id=\"zincrby\"><a class=\"markdownIt-Anchor\" href=\"#zincrby\">#</a>  <code>zincrby</code></h3>\n<ul>\n<li>语法</li>\n</ul>\n<p><code>ZINCRBY key increment member</code></p>\n<ul>\n<li>解释</li>\n</ul>\n<p><code>zset increment by</code> <br>\n*  <code>increment</code> : 步长。<br>\n*  <code>member</code> : 指定的成员</p>\n<p>为有序集合 <code>key</code>  的成员 <code>member</code>  的 <code>score</code>  值加上  <code>increment</code> 。</p>\n<p>如果 <code>key</code>  或者 <code>member</code>  不存在，则新增一个元素。相当于  <code>zadd</code> .</p>\n<ul>\n<li>演示</li>\n</ul>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 插入一个不存在的key。</span></span><br><span class=\"line\">127.0.0.1:6379&gt; ZINCRBY k69 10 m1</span><br><span class=\"line\"><span class=\"string\">&quot;10&quot;</span></span><br><span class=\"line\">127.0.0.1:6379&gt; ZRANGE k69 0 -1 WITHSCORES</span><br><span class=\"line\">1) <span class=\"string\">&quot;m1&quot;</span></span><br><span class=\"line\">2) <span class=\"string\">&quot;10&quot;</span></span><br><span class=\"line\"><span class=\"comment\">#累加</span></span><br><span class=\"line\">127.0.0.1:6379&gt; ZINCRBY k69 10 m1</span><br><span class=\"line\"><span class=\"string\">&quot;20&quot;</span></span><br><span class=\"line\">127.0.0.1:6379&gt; ZRANGE k69 0 -1 WITHSCORES</span><br><span class=\"line\">1) <span class=\"string\">&quot;m1&quot;</span></span><br><span class=\"line\">2) <span class=\"string\">&quot;20&quot;</span></span><br><span class=\"line\"><span class=\"comment\"># 累加一个负数</span></span><br><span class=\"line\">127.0.0.1:6379&gt; ZINCRBY k69 -30 m1</span><br><span class=\"line\"><span class=\"string\">&quot;-10&quot;</span></span><br><span class=\"line\">127.0.0.1:6379&gt; ZRANGE k69 0 -1 WITHSCORES</span><br><span class=\"line\">1) <span class=\"string\">&quot;m1&quot;</span></span><br><span class=\"line\">2) <span class=\"string\">&quot;-10&quot;</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"zcard\"><a class=\"markdownIt-Anchor\" href=\"#zcard\">#</a>  <code>zcard</code></h3>\n<ul>\n<li>语法</li>\n</ul>\n<p><code>ZCARD key</code></p>\n<ul>\n<li>解释</li>\n</ul>\n<p>返回 有序集合的 <code>key</code>  中的元素个数。即 <code>member</code>  的个数。<br>\n不存在的时候，返回 <code>0</code> .</p>\n<ul>\n<li>演示</li>\n</ul>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> 返回member的个数</span></span><br><span class=\"line\">127.0.0.1:6379&gt; ZADD k70 1 m1 2 m2 3 m3</span><br><span class=\"line\">(integer) 3</span><br><span class=\"line\">127.0.0.1:6379&gt; ZCARD k70</span><br><span class=\"line\">(integer) 3</span><br><span class=\"line\">127.0.0.1:6379&gt; ZADD k70 4 m4 5 m5</span><br><span class=\"line\">(integer) 2</span><br><span class=\"line\">127.0.0.1:6379&gt; ZCARD k70</span><br><span class=\"line\">(integer) 5</span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> 不存在的时候，返回0</span></span><br><span class=\"line\">127.0.0.1:6379&gt; EXISTS k70_1</span><br><span class=\"line\">(integer) 0</span><br><span class=\"line\">127.0.0.1:6379&gt; ZCARD k70_1</span><br><span class=\"line\">(integer) 0</span><br></pre></td></tr></table></figure>\n<h3 id=\"zcount\"><a class=\"markdownIt-Anchor\" href=\"#zcount\">#</a>  <code>zcount</code></h3>\n<ul>\n<li>语法</li>\n</ul>\n<p><code>ZCOUNT key min max</code></p>\n<ul>\n<li>解释</li>\n</ul>\n<p>返回  <code>score</code>  值在 <code>min</code>  和  <code>max</code>  之间的元素的个数。包括等于  <code>min</code>  和  <code>max</code></p>\n<ul>\n<li>演示</li>\n</ul>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">127.0.0.1:6379&gt; ZADD k71 1 m1 2 m2 3 m3 4 m4 5 m5 6 m6 7 m7 8 m8 9 m9 10 m10</span><br><span class=\"line\">(<span class=\"built_in\">integer</span>) 10</span><br><span class=\"line\">127.0.0.1:6379&gt; ZCOUNT k71 2 5</span><br><span class=\"line\">(<span class=\"built_in\">integer</span>) 4</span><br><span class=\"line\"><span class=\"comment\">#不存在的key或者不在区间内时，返回0</span></span><br><span class=\"line\">127.0.0.1:6379&gt; zcount k71_1 0 10</span><br><span class=\"line\">(<span class=\"built_in\">integer</span>) 0</span><br><span class=\"line\">127.0.0.1:6379&gt; zcount k71 11 12</span><br><span class=\"line\">(<span class=\"built_in\">integer</span>) 0</span><br><span class=\"line\">127.0.0.1:6379&gt; zcount k71 12 11</span><br><span class=\"line\">(<span class=\"built_in\">integer</span>) 0</span><br><span class=\"line\">127.0.0.1:6379&gt; </span><br></pre></td></tr></table></figure>\n<h3 id=\"zrange\"><a class=\"markdownIt-Anchor\" href=\"#zrange\">#</a>  <code>zrange</code></h3>\n<ul>\n<li>语法</li>\n</ul>\n<p><code>ZRANGE key start stop [WITHSCORES]</code></p>\n<ul>\n<li>解释</li>\n</ul>\n<p>这个命令我们已经用过，就是返回指定开始结束位置上的元素。从  <code>0</code>  开始。</p>\n<ul>\n<li>演示</li>\n</ul>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">127.0.0.1:6379&gt; ZRANGE k72 1 3</span><br><span class=\"line\">1) <span class=\"string\">&quot;m2&quot;</span></span><br><span class=\"line\">2) <span class=\"string\">&quot;m3&quot;</span></span><br><span class=\"line\">3) <span class=\"string\">&quot;m4&quot;</span></span><br><span class=\"line\">127.0.0.1:6379&gt; ZRANGE k72 1 3 WITHSCORES</span><br><span class=\"line\">1) <span class=\"string\">&quot;m2&quot;</span></span><br><span class=\"line\">2) <span class=\"string\">&quot;2&quot;</span></span><br><span class=\"line\">3) <span class=\"string\">&quot;m3&quot;</span></span><br><span class=\"line\">4) <span class=\"string\">&quot;3&quot;</span></span><br><span class=\"line\">5) <span class=\"string\">&quot;m4&quot;</span></span><br><span class=\"line\">6) <span class=\"string\">&quot;4&quot;</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"zrevrange\"><a class=\"markdownIt-Anchor\" href=\"#zrevrange\">#</a>  <code>zrevrange</code></h3>\n<ul>\n<li>语法</li>\n</ul>\n<p><code>ZREVRANGE key start stop [WITHSCORES]</code></p>\n<ul>\n<li>解释</li>\n</ul>\n<p>返回有序集合中指定区间的成员。<br>\n其中成员的位置按  <code>score</code>  值递减 (从大到小) 来排列。 具有相同  <code>score</code>  值的成员按字典序的逆序 ( <code>reverse lexicographical order</code> ) 排列。</p>\n<ul>\n<li>演示</li>\n</ul>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">127.0.0.1:6379&gt; ZADD k73 1 m1 2 m2 3 m3 4 m4 5 m5 6 m6 7 m7 8 m8 9 m9 10 m10</span><br><span class=\"line\">(<span class=\"built_in\">integer</span>) 10</span><br><span class=\"line\"><span class=\"comment\"># 使用 zrange 正序返回数据</span></span><br><span class=\"line\">127.0.0.1:6379&gt; ZRANGE k73 0 3 WITHSCORES</span><br><span class=\"line\">1) <span class=\"string\">&quot;m1&quot;</span></span><br><span class=\"line\">2) <span class=\"string\">&quot;1&quot;</span></span><br><span class=\"line\">3) <span class=\"string\">&quot;m2&quot;</span></span><br><span class=\"line\">4) <span class=\"string\">&quot;2&quot;</span></span><br><span class=\"line\">5) <span class=\"string\">&quot;m3&quot;</span></span><br><span class=\"line\">6) <span class=\"string\">&quot;3&quot;</span></span><br><span class=\"line\">7) <span class=\"string\">&quot;m4&quot;</span></span><br><span class=\"line\">8) <span class=\"string\">&quot;4&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 使用 zrevrange 倒序返回数据</span></span><br><span class=\"line\">127.0.0.1:6379&gt; ZREVRANGE k73 0 3 WITHSCORES</span><br><span class=\"line\">1) <span class=\"string\">&quot;m10\\x11&quot;</span></span><br><span class=\"line\">2) <span class=\"string\">&quot;10&quot;</span></span><br><span class=\"line\">3) <span class=\"string\">&quot;m9&quot;</span></span><br><span class=\"line\">4) <span class=\"string\">&quot;9&quot;</span></span><br><span class=\"line\">5) <span class=\"string\">&quot;m8&quot;</span></span><br><span class=\"line\">6) <span class=\"string\">&quot;8&quot;</span></span><br><span class=\"line\">7) <span class=\"string\">&quot;m7&quot;</span></span><br><span class=\"line\">8) <span class=\"string\">&quot;7&quot;</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"zrangebyscore\"><a class=\"markdownIt-Anchor\" href=\"#zrangebyscore\">#</a>  <code>zrangebyscore</code></h3>\n<ul>\n<li>语法</li>\n</ul>\n<p><code>ZRANGEBYSCORE key min max [WITHSCORES] [LIMIT offset count]</code></p>\n<ul>\n<li>解释</li>\n</ul>\n<p><code>zset range by score</code></p>\n<p>类似  <code>zrange</code> , 不过是按照  <code>score</code>  的值进行排序的。</p>\n<p><code>[LIMIT offset count]</code> , 是从 offset 开始，返回 <code>count</code>  个。</p>\n<ul>\n<li>演示</li>\n</ul>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 返回 score值在 [9,10]之间的member。</span></span><br><span class=\"line\">127.0.0.1:6379&gt; ZADD k74 1 m1 2 m2 3 m3 4 m4 5 m5 6 m6 7 m7 8 m8 9 m9 10 m10</span><br><span class=\"line\">(<span class=\"built_in\">integer</span>) 10</span><br><span class=\"line\">127.0.0.1:6379&gt; ZRANGEBYSCORE k74 9 10 WITHSCORES</span><br><span class=\"line\">1) <span class=\"string\">&quot;m9&quot;</span></span><br><span class=\"line\">2) <span class=\"string\">&quot;9&quot;</span></span><br><span class=\"line\">3) <span class=\"string\">&quot;m10\\x11&quot;</span></span><br><span class=\"line\">4) <span class=\"string\">&quot;10&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 从第2个(区间内索引为1)开始，返回1个元素</span></span><br><span class=\"line\">127.0.0.1:6379&gt; ZRANGEBYSCORE k74 9 10 WITHSCORES LIMIT 1 1</span><br><span class=\"line\">1) <span class=\"string\">&quot;m10\\x11&quot;</span></span><br><span class=\"line\">2) <span class=\"string\">&quot;10&quot;</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"zrevrangebyscore\"><a class=\"markdownIt-Anchor\" href=\"#zrevrangebyscore\">#</a>  <code>zrevrangebyscore</code></h3>\n<ul>\n<li>语法</li>\n</ul>\n<p><code>ZREVRANGEBYSCORE key max min [WITHSCORES] [LIMIT offset count]</code></p>\n<ul>\n<li>解释</li>\n</ul>\n<p>返回有序集  <code>key</code>  中，  <code>score</code>  值介于  <code>max</code>  和  <code>min</code>  之间 (默认包括等于  <code>max</code>  或  <code>min</code>  ) 的所有的成员。有序集成员按  <code>score</code>  值递减 (从大到小) 的次序排列。</p>\n<p>注意各个参数的位置哦。这里和  <code>zrevrange</code>  的参数不一样。</p>\n<ul>\n<li>演示</li>\n</ul>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">127.0.0.1:6379&gt; ZADD k75 1 m1 2 m2 3 m3 4 m4 5 m5 6 m6 7 m7 8 m8 9 m9 10 m10</span><br><span class=\"line\">(<span class=\"built_in\">integer</span>) 10</span><br><span class=\"line\">127.0.0.1:6379&gt; ZREVRANGEBYSCORE k75 8 6 WITHSCORES </span><br><span class=\"line\">1) <span class=\"string\">&quot;m8&quot;</span></span><br><span class=\"line\">2) <span class=\"string\">&quot;8&quot;</span></span><br><span class=\"line\">3) <span class=\"string\">&quot;m7&quot;</span></span><br><span class=\"line\">4) <span class=\"string\">&quot;7&quot;</span></span><br><span class=\"line\">5) <span class=\"string\">&quot;m6&quot;</span></span><br><span class=\"line\">6) <span class=\"string\">&quot;6&quot;</span></span><br><span class=\"line\">127.0.0.1:6379&gt; ZREVRANGEBYSCORE k75 8 6 WITHSCORES  LIMIT 1  1</span><br><span class=\"line\">1) <span class=\"string\">&quot;m7&quot;</span></span><br><span class=\"line\">2) <span class=\"string\">&quot;7&quot;</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"zrank\"><a class=\"markdownIt-Anchor\" href=\"#zrank\">#</a>  <code>zrank</code></h3>\n<ul>\n<li>语法</li>\n</ul>\n<p><code>ZRANK key member</code></p>\n<ul>\n<li>解释</li>\n</ul>\n<p>返回有序集  <code>key</code>  中成员  <code>member</code>  的排名。其中有序集成员按  <code>score</code>  值递增 (从小到大) 顺序排列</p>\n<ul>\n<li>演示</li>\n</ul>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">127.0.0.1:6379&gt; ZADD k76 1 m1 2 m2 3 m3 4 m4 5 m5 6 m6 7 m7 8 m8 9 m9 10 m10</span><br><span class=\"line\">(<span class=\"built_in\">integer</span>) 10</span><br><span class=\"line\">127.0.0.1:6379&gt; zrank k76 m4</span><br><span class=\"line\">(<span class=\"built_in\">integer</span>) 3</span><br><span class=\"line\">127.0.0.1:6379&gt; zrank k76 m10</span><br><span class=\"line\">(<span class=\"built_in\">integer</span>) 9</span><br></pre></td></tr></table></figure>\n<h3 id=\"zrevrank\"><a class=\"markdownIt-Anchor\" href=\"#zrevrank\">#</a>  <code>zrevrank</code></h3>\n<ul>\n<li>语法</li>\n</ul>\n<p><code>ZREVRANK key member</code></p>\n<ul>\n<li>解释</li>\n</ul>\n<p>返回有序集  <code>key</code>  中成员  <code>member</code>  的排名。其中有序集成员按  <code>score</code>  值递减 (从大到小) 排序。</p>\n<p>排名以  <code>0</code>  为底，也就是说，  <code>score</code>  值最大的成员排名为  <code>0</code>  。</p>\n<ul>\n<li>演示</li>\n</ul>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">127.0.0.1:6379&gt; ZADD k77 1 m1 2 m2 3 m3 4 m4 5 m5 6 m6 7 m7 8 m8 9 m9 10 m10</span><br><span class=\"line\">(<span class=\"built_in\">integer</span>) 10</span><br><span class=\"line\">127.0.0.1:6379&gt; ZREVRANK k77 m10</span><br><span class=\"line\">(<span class=\"built_in\">integer</span>) 0</span><br><span class=\"line\">127.0.0.1:6379&gt; ZREVRANK k77 m4</span><br><span class=\"line\">(<span class=\"built_in\">integer</span>) 6</span><br></pre></td></tr></table></figure>\n<h3 id=\"zrem\"><a class=\"markdownIt-Anchor\" href=\"#zrem\">#</a>  <code>zrem</code></h3>\n<ul>\n<li>语法</li>\n</ul>\n<p><code>ZREM key member [member ...]</code></p>\n<ul>\n<li>解释</li>\n</ul>\n<p><code>zset remove</code></p>\n<p>移除有序集  <code>key</code>  中的一个或多个成员，不存在的成员将被忽略。</p>\n<p>当  <code>key</code>  存在但不是有序集类型时，返回一个错误。</p>\n<ul>\n<li>演示</li>\n</ul>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">127.0.0.1:6379&gt; ZADD k78 1 m1 2 m2 3 m3 4 m4 5 m5 6 m6 7 m7 8 m8 9 m9 10 m10</span><br><span class=\"line\">(<span class=\"built_in\">integer</span>) 10</span><br><span class=\"line\"><span class=\"comment\"># 删除m2,m3,m4</span></span><br><span class=\"line\">127.0.0.1:6379&gt; ZREM k78 m2 m3 m4</span><br><span class=\"line\">(<span class=\"built_in\">integer</span>) 3</span><br><span class=\"line\">127.0.0.1:6379&gt; ZRANGE k78 0 -1 WITHSCORES</span><br><span class=\"line\"> 1) <span class=\"string\">&quot;m1&quot;</span></span><br><span class=\"line\"> 2) <span class=\"string\">&quot;1&quot;</span></span><br><span class=\"line\"> 3) <span class=\"string\">&quot;m5&quot;</span></span><br><span class=\"line\"> 4) <span class=\"string\">&quot;5&quot;</span></span><br><span class=\"line\"> 5) <span class=\"string\">&quot;m6&quot;</span></span><br><span class=\"line\"> 6) <span class=\"string\">&quot;6&quot;</span></span><br><span class=\"line\"> 7) <span class=\"string\">&quot;m7&quot;</span></span><br><span class=\"line\"> 8) <span class=\"string\">&quot;7&quot;</span></span><br><span class=\"line\"> 9) <span class=\"string\">&quot;m8&quot;</span></span><br><span class=\"line\">10) <span class=\"string\">&quot;8&quot;</span></span><br><span class=\"line\">11) <span class=\"string\">&quot;m9&quot;</span></span><br><span class=\"line\">12) <span class=\"string\">&quot;9&quot;</span></span><br><span class=\"line\">13) <span class=\"string\">&quot;m10&quot;</span></span><br><span class=\"line\">14) <span class=\"string\">&quot;10&quot;</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"zremrangebyrank\"><a class=\"markdownIt-Anchor\" href=\"#zremrangebyrank\">#</a>  <code>zremrangebyrank</code></h3>\n<ul>\n<li>语法</li>\n</ul>\n<p><code>ZREMRANGEBYRANK key start stop</code></p>\n<ul>\n<li>解释</li>\n</ul>\n<p>移除有序集  <code>key</code>  中，指定排名 ( <code>rank</code> ) 区间内的所有成员。</p>\n<p>区间分别以下标参数  <code>start</code>  和  <code>stop</code>  指出，包含  <code>start</code>  和  <code>stop</code>  在内。</p>\n<ul>\n<li>演示</li>\n</ul>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">127.0.0.1:6379&gt; ZADD k79 1 m1 2 m2 3 m3 4 m4 5 m5 6 m6 7 m7 8 m8 9 m9 10 m10</span><br><span class=\"line\">(<span class=\"built_in\">integer</span>) 10</span><br><span class=\"line\"><span class=\"comment\"># 删除排名第2到排名第4的member</span></span><br><span class=\"line\">127.0.0.1:6379&gt; ZREMRANGEBYRANK k79 1 3</span><br><span class=\"line\">(<span class=\"built_in\">integer</span>) 3</span><br><span class=\"line\">127.0.0.1:6379&gt; ZRANGE k79 0 -1 WITHSCORES</span><br><span class=\"line\"> 1) <span class=\"string\">&quot;m1&quot;</span></span><br><span class=\"line\"> 2) <span class=\"string\">&quot;1&quot;</span></span><br><span class=\"line\"> 3) <span class=\"string\">&quot;m5&quot;</span></span><br><span class=\"line\"> 4) <span class=\"string\">&quot;5&quot;</span></span><br><span class=\"line\"> 5) <span class=\"string\">&quot;m6&quot;</span></span><br><span class=\"line\"> 6) <span class=\"string\">&quot;6&quot;</span></span><br><span class=\"line\"> 7) <span class=\"string\">&quot;m7&quot;</span></span><br><span class=\"line\"> 8) <span class=\"string\">&quot;7&quot;</span></span><br><span class=\"line\"> 9) <span class=\"string\">&quot;m8&quot;</span></span><br><span class=\"line\">10) <span class=\"string\">&quot;8&quot;</span></span><br><span class=\"line\">11) <span class=\"string\">&quot;m9&quot;</span></span><br><span class=\"line\">12) <span class=\"string\">&quot;9&quot;</span></span><br><span class=\"line\">13) <span class=\"string\">&quot;m10&quot;</span></span><br><span class=\"line\">14) <span class=\"string\">&quot;10&quot;</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"zremrangebyscore\"><a class=\"markdownIt-Anchor\" href=\"#zremrangebyscore\">#</a> zremrangebyscore</h3>\n<ul>\n<li>语法</li>\n</ul>\n<p><code>ZREMRANGEBYSCORE key min max</code></p>\n<ul>\n<li>解释</li>\n</ul>\n<p>移除有序集  <code>key</code>  中，所有  <code>score</code>  值介于  <code>min</code>  和  <code>max</code>  之间 (包括等于  <code>min</code>  或  <code>max</code>  ) 的成员。</p>\n<ul>\n<li>演示</li>\n</ul>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">127.0.0.1:6379&gt; ZADD k80 1 m1 2 m2 3 m3 4 m4 5 m5 6 m6 7 m7 8 m8 9 m9 10 m10</span><br><span class=\"line\">(<span class=\"built_in\">integer</span>) 10</span><br><span class=\"line\"><span class=\"comment\"># 删除 score&gt;=1 and score &lt;=9 的元素</span></span><br><span class=\"line\">127.0.0.1:6379&gt; ZREMRANGEBYSCORE k80 1 9</span><br><span class=\"line\">(<span class=\"built_in\">integer</span>) 9</span><br><span class=\"line\">127.0.0.1:6379&gt; zrange k80 0 -1  WITHSCORES</span><br><span class=\"line\">1) <span class=\"string\">&quot;m10&quot;</span></span><br><span class=\"line\">2) <span class=\"string\">&quot;10&quot;</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"zrangebylex\"><a class=\"markdownIt-Anchor\" href=\"#zrangebylex\">#</a> zrangebylex</h3>\n<ul>\n<li>语法</li>\n</ul>\n<p><code>ZRANGEBYLEX key min max [LIMIT offset count]</code></p>\n<ul>\n<li>解释</li>\n</ul>\n<p>当有序集合的所有成员都具有相同的分值时， 有序集合的元素会根据成员的字典序（ <code>lexicographical ordering</code> ）来进行排序， 而这个命令则可以返回给定的有序集合键  <code>key</code>  中， 值介于  <code>min</code>  和  <code>max</code>  之间的成员。</p>\n<p>注意:</p>\n<p>合法的  <code>min</code>  和  <code>max</code>  参数必须包含 ( 或者  <code>[</code>  ， 其中  <code>(</code>  表示开区间（指定的值不会被包含在范围之内）， 而  <code>[</code>  则表示闭区间（指定的值会被包含在范围之内）。</p>\n<p>特殊值  <code>+</code>  和  <code>-</code>  在  <code>min</code>  参数以及  <code>max</code>  参数中具有特殊的意义， 其中  <code>+</code>  表示正无限， 而  <code>-</code>  表示负无限。 因此， 向一个所有成员的分值都相同的有序集合发送命令  <code>ZRANGEBYLEX &lt;zset&gt; - + </code> ， 命令将返回有序集合中的所有元素</p>\n<blockquote>\n<p><code>lex</code> :<br>\n 表示如果 <code>score</code>  相等，则按照 <code>member</code>  的字典顺序排序。<br>\n此外这个命令，比如 <code>ZRANGBYSCORE</code>  稍微强大一点儿。可以指定区间范围，当只知道 <code>member</code> ，不知道 score 的时候，可以是使用带有  <code>lex</code>  的命令。</p>\n</blockquote>\n<ul>\n<li>演示</li>\n</ul>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">127.0.0.1:6379&gt; zadd k81 1 a 2 b 3 c 4 d 5 f 6 g</span><br><span class=\"line\">(<span class=\"built_in\">integer</span>) 6</span><br><span class=\"line\"><span class=\"comment\"># 返回 score值在a的score值和c的score值之间的member</span></span><br><span class=\"line\"><span class=\"comment\"># 即: score&gt; Score(a) &amp;&amp; score &lt;= Score(c)</span></span><br><span class=\"line\">127.0.0.1:6379&gt; ZRANGEBYLEX k81 (a  [c </span><br><span class=\"line\">1) <span class=\"string\">&quot;b&quot;</span></span><br><span class=\"line\">2) <span class=\"string\">&quot;c&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 返回 小于等于c的Score值的元素</span></span><br><span class=\"line\">127.0.0.1:6379&gt; ZRANGEBYLEX k81 -  [c </span><br><span class=\"line\">1) <span class=\"string\">&quot;a&quot;</span></span><br><span class=\"line\">2) <span class=\"string\">&quot;b&quot;</span></span><br><span class=\"line\">3) <span class=\"string\">&quot;c&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 返回所有元素</span></span><br><span class=\"line\">127.0.0.1:6379&gt; ZRANGEBYLEX k81 - + </span><br><span class=\"line\">1) <span class=\"string\">&quot;a&quot;</span></span><br><span class=\"line\">2) <span class=\"string\">&quot;b&quot;</span></span><br><span class=\"line\">3) <span class=\"string\">&quot;c&quot;</span></span><br><span class=\"line\">4) <span class=\"string\">&quot;d&quot;</span></span><br><span class=\"line\">5) <span class=\"string\">&quot;f&quot;</span></span><br><span class=\"line\">6) <span class=\"string\">&quot;g&quot;</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"zlexcount\"><a class=\"markdownIt-Anchor\" href=\"#zlexcount\">#</a>  <code>zlexcount</code></h3>\n<ul>\n<li>语法</li>\n</ul>\n<p><code>ZLEXCOUNT key min max</code></p>\n<ul>\n<li>解释</li>\n</ul>\n<p>对于一个所有成员的分值都相同的有序集合键  <code>key</code>  来说， 这个命令会返回该集合中， 成员介于  <code>min</code>  和  <code>max</code>  范围内的元素数量。</p>\n<ul>\n<li>演示</li>\n</ul>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">127.0.0.1:6379&gt; zadd k82 1 a 2 b 3 c 4 d 5 f 6 g</span><br><span class=\"line\">(<span class=\"built_in\">integer</span>) 6</span><br><span class=\"line\">127.0.0.1:6379&gt; ZLEXCOUNT k82 2 5</span><br><span class=\"line\">(error) ERR min or max not valid string range item</span><br><span class=\"line\">127.0.0.1:6379&gt; ZLEXCOUNT k82 a b</span><br><span class=\"line\"><span class=\"comment\"># 大于Score(a),小于等于Score(b)的member,只有b.</span></span><br><span class=\"line\">127.0.0.1:6379&gt; ZLEXCOUNT k82 (a [b</span><br><span class=\"line\">(<span class=\"built_in\">integer</span>) 1</span><br><span class=\"line\"><span class=\"comment\"># 大于Score(a),小于等于Score(d)的member,有b.c.d，三个</span></span><br><span class=\"line\">127.0.0.1:6379&gt; ZLEXCOUNT k82 (a [d</span><br><span class=\"line\">(<span class=\"built_in\">integer</span>) 3</span><br></pre></td></tr></table></figure>\n<h3 id=\"zremrangebylex\"><a class=\"markdownIt-Anchor\" href=\"#zremrangebylex\">#</a>  <code>zremrangebylex</code></h3>\n<ul>\n<li>语法</li>\n</ul>\n<p><code>ZREMRANGEBYLEX key min max</code></p>\n<ul>\n<li>解释</li>\n</ul>\n<p>对于一个所有成员的分值都相同的有序集合键  <code>key</code>  来说， 这个命令会移除该集合中， 成员介于  <code>min</code>  和  <code>max</code>  范围内的所有元素。</p>\n<ul>\n<li>演示</li>\n</ul>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">127.0.0.1:6379&gt; zadd k83 1 a 2 b 3 c 4 d 5 f 6 g</span><br><span class=\"line\">(<span class=\"built_in\">integer</span>) 6</span><br><span class=\"line\"><span class=\"comment\"># 删除 score值在 (Score(a),Score(c)] 之间的member</span></span><br><span class=\"line\">127.0.0.1:6379&gt; ZREMRANGEBYLEX k83 (a [c</span><br><span class=\"line\">(<span class=\"built_in\">integer</span>) 2</span><br><span class=\"line\"><span class=\"comment\"># 删除了，b,c</span></span><br><span class=\"line\">127.0.0.1:6379&gt; zrange k83 0 -1</span><br><span class=\"line\">1) <span class=\"string\">&quot;a&quot;</span></span><br><span class=\"line\">2) <span class=\"string\">&quot;d&quot;</span></span><br><span class=\"line\">3) <span class=\"string\">&quot;f&quot;</span></span><br><span class=\"line\">4) <span class=\"string\">&quot;g&quot;</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"zscan\"><a class=\"markdownIt-Anchor\" href=\"#zscan\">#</a> zscan</h3>\n<ul>\n<li>语法</li>\n</ul>\n<p><code>ZSCAN key cursor [MATCH pattern] [COUNT count]</code></p>\n<ul>\n<li>解释</li>\n</ul>\n<p>这是一个查询命令。 同  <code>SCAN</code>  命令。可以参考这篇文章 <a href=\"./010-%E5%85%B6%E4%BB%96%E5%91%BD%E4%BB%A4.md\">010 - 其他命令</a></p>\n<p><code>SCAN</code>  命令是一个基于游标的迭代器（ <code>cursor based iterator</code> ）：  <code>SCAN</code>  命令每次被调用之后， 都会向用户返回一个新的游标， 用户在下次迭代时需要使用这个新游标作为  <code>SCAN</code>  命令的游标参数， 以此来延续之前的迭代过程。</p>\n<ul>\n<li>演示</li>\n</ul>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">127.0.0.1:6379&gt; ZADD k84 1 m1 2 m2 3 m3 4 m4 5 m5 6 m6 7 m7 8 m8 9 m9 10 m10</span><br><span class=\"line\">(<span class=\"built_in\">integer</span>) 10</span><br><span class=\"line\">127.0.0.1:6379&gt; zscan k84 0 MATCH m* COUNT 3</span><br><span class=\"line\">1) <span class=\"string\">&quot;0&quot;</span></span><br><span class=\"line\">2)  1) <span class=\"string\">&quot;m1&quot;</span></span><br><span class=\"line\">    2) <span class=\"string\">&quot;1&quot;</span></span><br><span class=\"line\">    3) <span class=\"string\">&quot;m2&quot;</span></span><br><span class=\"line\">    4) <span class=\"string\">&quot;2&quot;</span></span><br><span class=\"line\">    5) <span class=\"string\">&quot;m3&quot;</span></span><br><span class=\"line\">    6) <span class=\"string\">&quot;3&quot;</span></span><br><span class=\"line\">    7) <span class=\"string\">&quot;m4&quot;</span></span><br><span class=\"line\">    8) <span class=\"string\">&quot;4&quot;</span></span><br><span class=\"line\">    9) <span class=\"string\">&quot;m5&quot;</span></span><br><span class=\"line\">   10) <span class=\"string\">&quot;5&quot;</span></span><br><span class=\"line\">   11) <span class=\"string\">&quot;m6&quot;</span></span><br><span class=\"line\">   12) <span class=\"string\">&quot;6&quot;</span></span><br><span class=\"line\">   13) <span class=\"string\">&quot;m7&quot;</span></span><br><span class=\"line\">   14) <span class=\"string\">&quot;7&quot;</span></span><br><span class=\"line\">   15) <span class=\"string\">&quot;m8&quot;</span></span><br><span class=\"line\">   16) <span class=\"string\">&quot;8&quot;</span></span><br><span class=\"line\">   17) <span class=\"string\">&quot;m9&quot;</span></span><br><span class=\"line\">   18) <span class=\"string\">&quot;9&quot;</span></span><br><span class=\"line\">   19) <span class=\"string\">&quot;m10&quot;</span></span><br><span class=\"line\">   20) <span class=\"string\">&quot;10&quot;</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"zunionstore\"><a class=\"markdownIt-Anchor\" href=\"#zunionstore\">#</a>  <code>zunionstore</code></h3>\n<ul>\n<li>语法</li>\n</ul>\n<p><code>ZUNIONSTORE destination numkeys key [key ...] [WEIGHTS weight] [AGGREGATE SUM|MIN|MAX]</code></p>\n<ul>\n<li>\n<p>解释<br>\n计算给定的一个或多个有序集合的并集，其中给定 key 的数量必须以 numkeys 参数指定，并将该并集 (结果集) 储存到 destination 。<br>\n如果 key 相同的时候，对应的 score 值会相加。</p>\n<ul>\n<li><code>WEIGHTS</code> : 使用  <code>WEIGHTS</code>  选项，你可以为 每个 给定有序集 分别 指定一个乘法因子 ( <code>multiplication factor</code> )，每个给定有序集的所有成员的  <code>score</code>  值在传递给聚合函数 ( <code>aggregation function</code> ) 之前都要先乘以该有序集的因子。</li>\n<li><code>AGGREGATE</code> : 使用  <code>AGGREGATE</code>  选项，你可以指定并集的结果集的聚合方式。<br>\n默认使用的参数  <code>SUM</code>  ，可以将所有集合中某个成员的  <code>score</code>  值之 和 作为结果集中该成员的  <code>score</code>  值；使用参数  <code>MIN</code>  ，可以将所有集合中某个成员的 最小  <code>score</code>  值作为结果集中该成员的  <code>score</code>  值；而参数  <code>MAX</code>  则是将所有集合中某个成员的 最大  <code>score</code>  值作为结果集中该成员的  <code>score</code>  值。</li>\n</ul>\n</li>\n<li>\n<p>演示</p>\n</li>\n</ul>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">127.0.0.1:6379&gt; ZADD k85_1 1 m1 2 m2 3 m3</span><br><span class=\"line\">(<span class=\"built_in\">integer</span>) 3</span><br><span class=\"line\">127.0.0.1:6379&gt; ZADD k85_2 1 m1 4 m4 5 m5</span><br><span class=\"line\">(<span class=\"built_in\">integer</span>) 3</span><br><span class=\"line\">127.0.0.1:6379&gt; ZUNIONSTORE k85 2 k85_1 k85_2</span><br><span class=\"line\">(<span class=\"built_in\">integer</span>) 5</span><br><span class=\"line\">127.0.0.1:6379&gt; zrange k85 0 -1 WITHSCORES</span><br><span class=\"line\"> 1) <span class=\"string\">&quot;m1&quot;</span></span><br><span class=\"line\"> 2) <span class=\"string\">&quot;2&quot;</span></span><br><span class=\"line\"> 3) <span class=\"string\">&quot;m2&quot;</span></span><br><span class=\"line\"> 4) <span class=\"string\">&quot;2&quot;</span></span><br><span class=\"line\"> 5) <span class=\"string\">&quot;m3&quot;</span></span><br><span class=\"line\"> 6) <span class=\"string\">&quot;3&quot;</span></span><br><span class=\"line\"> 7) <span class=\"string\">&quot;m4&quot;</span></span><br><span class=\"line\"> 8) <span class=\"string\">&quot;4&quot;</span></span><br><span class=\"line\"> 9) <span class=\"string\">&quot;m5&quot;</span></span><br><span class=\"line\">10) <span class=\"string\">&quot;5&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 演示 Weights参数： WEIGHTS 2 3</span></span><br><span class=\"line\"><span class=\"comment\"># 指: 第一个zset的所有元素 *2 ，第二个有序集合中的元素 *3</span></span><br><span class=\"line\">127.0.0.1:6379&gt; ZUNIONSTORE k85 2 k85_1 k85_2 WEIGHTS 2 3</span><br><span class=\"line\">(<span class=\"built_in\">integer</span>) 5</span><br><span class=\"line\">127.0.0.1:6379&gt; ZRANGE k85 0 -1 WITHSCORES</span><br><span class=\"line\"> 1) <span class=\"string\">&quot;m2&quot;</span></span><br><span class=\"line\"> 2) <span class=\"string\">&quot;4&quot;</span></span><br><span class=\"line\"> 3) <span class=\"string\">&quot;m1&quot;</span></span><br><span class=\"line\"> 4) <span class=\"string\">&quot;5&quot;</span></span><br><span class=\"line\"> 5) <span class=\"string\">&quot;m3&quot;</span></span><br><span class=\"line\"> 6) <span class=\"string\">&quot;6&quot;</span></span><br><span class=\"line\"> 7) <span class=\"string\">&quot;m4&quot;</span></span><br><span class=\"line\"> 8) <span class=\"string\">&quot;12&quot;</span></span><br><span class=\"line\"> 9) <span class=\"string\">&quot;m5&quot;</span></span><br><span class=\"line\">10) <span class=\"string\">&quot;15&quot;</span></span><br><span class=\"line\"><span class=\"comment\"># 演示 Weights参数： WEIGHTS 2 4</span></span><br><span class=\"line\"><span class=\"comment\"># 指: 第一个zset的所有元素 *2 ，第二个有序集合中的元素 *3</span></span><br><span class=\"line\">127.0.0.1:6379&gt; ZUNIONSTORE k85 2 k85_1 k85_2 WEIGHTS 2 4</span><br><span class=\"line\">(<span class=\"built_in\">integer</span>) 5</span><br><span class=\"line\">127.0.0.1:6379&gt; ZRANGE k85 0 -1 WITHSCORES</span><br><span class=\"line\"> 1) <span class=\"string\">&quot;m2&quot;</span></span><br><span class=\"line\"> 2) <span class=\"string\">&quot;4&quot;</span></span><br><span class=\"line\"> 3) <span class=\"string\">&quot;m1&quot;</span></span><br><span class=\"line\"> 4) <span class=\"string\">&quot;6&quot;</span></span><br><span class=\"line\"> 5) <span class=\"string\">&quot;m3&quot;</span></span><br><span class=\"line\"> 6) <span class=\"string\">&quot;6&quot;</span></span><br><span class=\"line\"> 7) <span class=\"string\">&quot;m4&quot;</span></span><br><span class=\"line\"> 8) <span class=\"string\">&quot;16&quot;</span></span><br><span class=\"line\"> 9) <span class=\"string\">&quot;m5&quot;</span></span><br><span class=\"line\">10) <span class=\"string\">&quot;20&quot;</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"zinterstore\"><a class=\"markdownIt-Anchor\" href=\"#zinterstore\">#</a> zinterstore</h3>\n<ul>\n<li>语法</li>\n</ul>\n<p><code>ZINTERSTORE destination numkeys key [key …] [WEIGHTS weight [weight …]] [AGGREGATE SUM|MIN|MAX]</code></p>\n<ul>\n<li>解释</li>\n</ul>\n<p>计算给定的一个或多个有序集的交集，其中给定  <code>key</code>  的数量必须以  <code>numkeys</code>  参数指定，并将该交集 (结果集) 储存到  <code>destination</code>  。</p>\n<p>默认情况下，结果集中某个成员的  <code>score</code>  值是所有给定集下该成员  <code>score</code>  值之和.</p>\n<ul>\n<li>演示</li>\n</ul>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">127.0.0.1:6379&gt; zadd k86_1 1 m1 2 m2 3 m3 4 m4</span><br><span class=\"line\">(<span class=\"built_in\">integer</span>) 4</span><br><span class=\"line\">127.0.0.1:6379&gt; ZADD k86_2 20 m2 30 m3 50 m5</span><br><span class=\"line\">(<span class=\"built_in\">integer</span>) 3</span><br><span class=\"line\">127.0.0.1:6379&gt; ZINTERSTORE k86 2 k86_1 k86_2 </span><br><span class=\"line\">(<span class=\"built_in\">integer</span>) 2</span><br><span class=\"line\"><span class=\"comment\"># 取交集(默认相加)</span></span><br><span class=\"line\">127.0.0.1:6379&gt; zrange k86 0 -1 WITHSCORES</span><br><span class=\"line\">1) <span class=\"string\">&quot;m2&quot;</span></span><br><span class=\"line\">2) <span class=\"string\">&quot;22&quot;</span></span><br><span class=\"line\">3) <span class=\"string\">&quot;m3&quot;</span></span><br><span class=\"line\">4) <span class=\"string\">&quot;33&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># WEIGTHS 参数和上面的 ZUNIONSTORE命令一样.</span></span><br><span class=\"line\"><span class=\"comment\"># 这里演示一下, AGGREGATE参数</span></span><br><span class=\"line\"><span class=\"comment\"># 默认使用的是SUM. 就是本命令中上面的例子了.</span></span><br><span class=\"line\"><span class=\"comment\"># 下面演示MIN 和 MAX</span></span><br><span class=\"line\">127.0.0.1:6379&gt; ZINTERSTORE k86 2 k86_1 k86_2 AGGREGATE MIN</span><br><span class=\"line\">(<span class=\"built_in\">integer</span>) 2</span><br><span class=\"line\">127.0.0.1:6379&gt; ZRANGE k86 0 -1 WITHSCORES</span><br><span class=\"line\">1) <span class=\"string\">&quot;m2&quot;</span></span><br><span class=\"line\">2) <span class=\"string\">&quot;2&quot;</span></span><br><span class=\"line\">3) <span class=\"string\">&quot;m3&quot;</span></span><br><span class=\"line\">4) <span class=\"string\">&quot;3&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\">127.0.0.1:6379&gt; ZINTERSTORE k86 2 k86_1 k86_2 AGGREGATE MAX</span><br><span class=\"line\">(<span class=\"built_in\">integer</span>) 2</span><br><span class=\"line\">127.0.0.1:6379&gt; ZRANGE k86 0 -1 WITHSCORES</span><br><span class=\"line\">1) <span class=\"string\">&quot;m2&quot;</span></span><br><span class=\"line\">2) <span class=\"string\">&quot;20&quot;</span></span><br><span class=\"line\">3) <span class=\"string\">&quot;m3&quot;</span></span><br><span class=\"line\">4) <span class=\"string\">&quot;30&quot;</span></span><br></pre></td></tr></table></figure>\n<h2 id=\"zset的内部结构\"><a class=\"markdownIt-Anchor\" href=\"#zset的内部结构\">#</a>  <code>zset</code>  的内部结构</h2>\n<p>这里我们主要看 <code>skiplist</code> ，如果忘记了 <code>hashtable</code> ，就看着<a href=\"2021/08/01/Redis%E7%B3%BB%E5%88%97/C-8-Redis%E4%B8%AD%E7%9A%84%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B9%8B%E5%AD%97%E5%85%B8Dict/\">这篇文章</a></p>\n<p>我们从命令 <code>zadd</code>  入手，找到 <code>zset</code>  的 <code>add</code>  通用方法 <code>zaddGenericCommand(c,ZADD_NONE);</code>  来看一下。省略了部分代码。</p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">...</span><br><span class=\"line\"><span class=\"keyword\">if</span> (server.zset_max_ziplist_entries == <span class=\"number\">0</span> ||</span><br><span class=\"line\">            server.zset_max_ziplist_value &lt; <span class=\"built_in\">sdslen</span>(c-&gt;argv[scoreidx+<span class=\"number\">1</span>]-&gt;ptr))</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"comment\">/// 创建 OBJ_ENCODING_SKIPLIST 编码的结构</span></span><br><span class=\"line\">    zobj = <span class=\"built_in\">createZsetObject</span>();</span><br><span class=\"line\">&#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">    <span class=\"comment\">/// 创建 OBJ_ZSET 编码的结构</span></span><br><span class=\"line\">    zobj = <span class=\"built_in\">createZsetZiplistObject</span>();</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">....</span><br></pre></td></tr></table></figure>\n<p>来看一下  <code>createZsetObject()</code>  方法的实现，就再清晰不过了。</p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/// 创建 Zset 对象。</span></span><br><span class=\"line\"><span class=\"function\">robj *<span class=\"title\">createZsetObject</span><span class=\"params\">(<span class=\"keyword\">void</span>)</span> </span>&#123;</span><br><span class=\"line\">    zset *zs = <span class=\"built_in\">zmalloc</span>(<span class=\"built_in\"><span class=\"keyword\">sizeof</span></span>(*zs));</span><br><span class=\"line\">    robj *o;</span><br><span class=\"line\"></span><br><span class=\"line\">    zs-&gt;dict = <span class=\"built_in\">dictCreate</span>(&amp;zsetDictType, <span class=\"literal\">NULL</span>);</span><br><span class=\"line\">    zs-&gt;zsl = <span class=\"built_in\">zslCreate</span>();</span><br><span class=\"line\">    o = <span class=\"built_in\">createObject</span>(OBJ_ZSET, zs);</span><br><span class=\"line\">    o-&gt;encoding = OBJ_ENCODING_SKIPLIST;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> o;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>到这里，就是我们和  <code>zset</code>  这种数据类型的初次深入见面了。 我们先看下  <code>zset</code>  这种结构体的定义。</p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/// 有序集合的结构定义</span></span><br><span class=\"line\"><span class=\"keyword\">typedef</span> <span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">zset</span> &#123;</span></span><br><span class=\"line\">    <span class=\"comment\">/// 字典，键为成员,值为score</span></span><br><span class=\"line\">    <span class=\"comment\">/// 用于支持 O(1) 复杂度的按成员分值操作。</span></span><br><span class=\"line\">    dict *dict;</span><br><span class=\"line\">    <span class=\"comment\">/// 跳跃表,按分值排序成员</span></span><br><span class=\"line\">    <span class=\"comment\">/// 用于支持平均复杂度为 O(logN)的按分值定位成员以及范围的操作。</span></span><br><span class=\"line\">    zskiplist *zsl;</span><br><span class=\"line\">&#125; zset;</span><br></pre></td></tr></table></figure>\n<p><code>dict</code>  前面已经看过了，这里来看下 <code>zskiplist</code> 。</p>\n<h3 id=\"skiplist\"><a class=\"markdownIt-Anchor\" href=\"#skiplist\">#</a>  <code>skiplist</code></h3>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/// 跳跃表</span></span><br><span class=\"line\"><span class=\"keyword\">typedef</span> <span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">zskiplist</span> &#123;</span></span><br><span class=\"line\">    <span class=\"comment\">/// 表头，表尾</span></span><br><span class=\"line\">    <span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">zskiplistNode</span> *<span class=\"title\">header</span>, *<span class=\"title\">tail</span>;</span></span><br><span class=\"line\">    <span class=\"comment\">/// 表中节点的数量</span></span><br><span class=\"line\">    <span class=\"keyword\">unsigned</span> <span class=\"keyword\">long</span> length;</span><br><span class=\"line\">    <span class=\"comment\">/// 表中层数最大的节点的层数</span></span><br><span class=\"line\">    <span class=\"keyword\">int</span> level;</span><br><span class=\"line\">&#125; zskiplist;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">typedef</span> <span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">zskiplistNode</span> &#123;</span></span><br><span class=\"line\">    sds ele;</span><br><span class=\"line\">    <span class=\"comment\">/// 分数</span></span><br><span class=\"line\">    <span class=\"keyword\">double</span> score;</span><br><span class=\"line\">    <span class=\"comment\">/// 后退的指针</span></span><br><span class=\"line\">    <span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">zskiplistNode</span> *<span class=\"title\">backward</span>;</span></span><br><span class=\"line\">    <span class=\"comment\">/// 层</span></span><br><span class=\"line\">    <span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">zskiplistLevel</span> &#123;</span></span><br><span class=\"line\">        <span class=\"comment\">/// 前进指针</span></span><br><span class=\"line\">        <span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">zskiplistNode</span> *<span class=\"title\">forward</span>;</span></span><br><span class=\"line\">        <span class=\"comment\">/// 跨度</span></span><br><span class=\"line\">        <span class=\"keyword\">unsigned</span> <span class=\"keyword\">long</span> span;</span><br><span class=\"line\">    &#125; level[];</span><br><span class=\"line\">&#125; zskiplistNode;</span><br></pre></td></tr></table></figure>\n<h2 id=\"总结\"><a class=\"markdownIt-Anchor\" href=\"#总结\">#</a> 总结</h2>\n<ul>\n<li>本章是一个新的常用数据类型， <code>ZSET</code>  有序集合。底层的数据结构是使用的是  <code>skipList</code>  和  <code>hashtable</code>  . 关于 <code>Skiplist</code>  的初步了解文章<a href=\"#\">穿梭机</a> 和  <code>Redis</code>  中  <code>skiplist</code>  的实现源码解读<a href=\"\">穿梭机</a></li>\n<li>然后简单介绍了  <code>Redis ZSET</code>  数据类型的基础使用场景。关键字有  <code>有序</code> ， <code>排名</code> ， <code>权重</code> 等.</li>\n<li><code>ZSET</code>  的  <code>20</code>  个常有命令。 后面我会针对这  <code>20</code>  个命令的实现进行简单的分享.</li>\n<li>然后简单的看了一下 <code>Redis</code>  中的数据结构的实现，还是那句话， <code>Redis</code>  的数据结构是动态编码的，  <code>ZSET</code>  是有 <code>hashtable</code>  和  <code>skiplist</code>  实现的。 skiplist 是一个非常高效的数据结构，增删查的效率都是  <code>O(logN)</code> . 实现原理可以参考这篇文章<a href=\"#\">直通车</a>，里面有几种流行的语言的实现，可以针对自己擅长的语言进行查看。</li>\n</ul>\n<h2 id=\"最后\"><a class=\"markdownIt-Anchor\" href=\"#最后\">#</a> 最后</h2>\n<p>期望与你一起遇见更好的自己</p>\n<p><img data-src=\"/images/qrcode.jpg\" alt=\"期望与你一起遇见更好的自己\"></p>\n",
            "tags": [
                "Redis"
            ]
        },
        {
            "id": "https://fangjiaxiaobai.github.io/2021/08/01/Redis%E7%B3%BB%E5%88%97/B-4-Redis%E7%9A%84%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B%E4%B9%8B%E9%9B%86%E5%90%88set/",
            "url": "https://fangjiaxiaobai.github.io/2021/08/01/Redis%E7%B3%BB%E5%88%97/B-4-Redis%E7%9A%84%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B%E4%B9%8B%E9%9B%86%E5%90%88set/",
            "title": "Redis数据结构之集合 Set",
            "date_published": "2021-08-01T10:28:55.000Z",
            "content_html": "<h2 id=\"书接上回\"><a class=\"markdownIt-Anchor\" href=\"#书接上回\">#</a> 书接上回</h2>\n<p>前一篇文章，我们学习的是 <a href=\"/2021/08/01/Redis%E7%B3%BB%E5%88%97/B-3-Redis%E7%9A%84%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B%E4%B9%8Bhash/\">Redis 的数据结构之 hash</a>， 学习了其基本的操作和使用内部数据结构是 <code>hashtable</code>  和 <code>ziplist</code> ，其中 <code>Redis</code>  中的 <code>hashtable</code>  是用  <code>dict</code>  表示的。如果不记得了其内部构成，就再看看看着<a href=\"/2021/08/01/Redis%E7%B3%BB%E5%88%97/B-3-Redis%E7%9A%84%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B%E4%B9%8Bhash/\">上篇文章</a>吧。现在我们继续学习下一个数据类型  <code>set</code> 。</p>\n<h2 id=\"set简介\"><a class=\"markdownIt-Anchor\" href=\"#set简介\">#</a>  <code>set</code>  简介</h2>\n<p><code>Redis</code>  的  <code>set</code>  数据类型表示 一堆不重复值的集合。</p>\n<p><code>Redis</code>  的 <code>set</code>  数据类型有两种编码方式.  <code>OBJ_ENCODING_INTSET</code>  和  <code>OBJ_ENCODING_HT</code> .</p>\n<ul>\n<li>\n<p><code>OBJ_ENCODING_HT</code>  这种编码方式在上一篇文章 <a href=\"/2021/08/01/Redis%E7%B3%BB%E5%88%97/B-3-Redis%E7%9A%84%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B%E4%B9%8Bhash/\">07-Redis 的数据类型之 hash</a> 中已经简单的介绍过了。其实现的数据结构为  <code>dict</code> 。</p>\n</li>\n<li>\n<p><code>OBJ_ENCODING_INTSET</code> , 这种编码方式是我们要新学习的编码方式。 <a href=\"#intset\">电梯直达</a></p>\n</li>\n</ul>\n<p>如果你看到这句话，那就说明你是一个特别认真的人。哈哈哈，我们还是先遵循惯例。先学习 <code>set</code>  类型相关的命令。</p>\n<h2 id=\"set类型的应用场景\"><a class=\"markdownIt-Anchor\" href=\"#set类型的应用场景\">#</a>  <code>set</code>  类型的应用场景</h2>\n<ul>\n<li>社交系统中存储关注信息，点赞信息，利用交并差运算，计算共同好友等业务中。比如 <code>qq</code>  的好友推荐逻辑，就可以使用差集运算。</li>\n<li>需要去重的业务逻辑中。某一时间端内系统的增长人数。</li>\n<li>统计访问网站的独立 <code>IP</code> 。</li>\n</ul>\n<h2 id=\"set的基本命令\"><a class=\"markdownIt-Anchor\" href=\"#set的基本命令\">#</a>  <code>set</code>  的基本命令</h2>\n<h3 id=\"sadd\"><a class=\"markdownIt-Anchor\" href=\"#sadd\">#</a>  <code>sadd</code></h3>\n<ul>\n<li>语法</li>\n</ul>\n<p><code>SADD key member [member ...]</code></p>\n<ul>\n<li>解释</li>\n</ul>\n<p><code>set add</code></p>\n<p>将一个或多个  <code>member</code>  元素加入到集合  <code>key</code>  当中，已经存在于集合的  <code>member</code>  元素将被忽略。</p>\n<p>假如  <code>key</code>  不存在，则创建一个只包含  <code>member</code>  元素作成员的集合。</p>\n<p>当  <code>key</code>  不是集合类型时，返回一个错误。</p>\n<ul>\n<li>演示</li>\n</ul>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">127.0.0.1:6379&gt; sadd k52 mem1 mem2 </span><br><span class=\"line\">(<span class=\"built_in\">integer</span>) 2</span><br><span class=\"line\">127.0.0.1:6379&gt; sadd k52 mem1 </span><br><span class=\"line\">(<span class=\"built_in\">integer</span>) 0</span><br><span class=\"line\">127.0.0.1:6379&gt; sadd k52 mem1 mem3</span><br><span class=\"line\">(<span class=\"built_in\">integer</span>) 1</span><br></pre></td></tr></table></figure>\n<h3 id=\"smembers\"><a class=\"markdownIt-Anchor\" href=\"#smembers\">#</a>  <code>smembers</code></h3>\n<ul>\n<li>语法</li>\n</ul>\n<p><code>SMEMBERS key</code></p>\n<ul>\n<li>解释</li>\n</ul>\n<p><code>set members</code></p>\n<p>返回集合  <code>key</code>  中的所有成员。</p>\n<p>不存在的  <code>key</code>  被视为空集合</p>\n<ul>\n<li>演示</li>\n</ul>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 查询元素， 注意保存是无序的.</span></span><br><span class=\"line\">127.0.0.1:6379&gt; SADD k53 m1 m2 m3 m4 m5</span><br><span class=\"line\">(<span class=\"built_in\">integer</span>) 5</span><br><span class=\"line\">127.0.0.1:6379&gt; SMEMBERS k53</span><br><span class=\"line\">1) <span class=\"string\">&quot;m4&quot;</span></span><br><span class=\"line\">2) <span class=\"string\">&quot;m3&quot;</span></span><br><span class=\"line\">3) <span class=\"string\">&quot;m2&quot;</span></span><br><span class=\"line\">4) <span class=\"string\">&quot;m1&quot;</span></span><br><span class=\"line\">5) <span class=\"string\">&quot;m5&quot;</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"sismember\"><a class=\"markdownIt-Anchor\" href=\"#sismember\">#</a>  <code>sismember</code></h3>\n<ul>\n<li>语法</li>\n</ul>\n<p><code>SISMEMBER key member</code></p>\n<ul>\n<li>解释</li>\n</ul>\n<p><code>set is members</code></p>\n<p>判断  <code>member</code>  元素是否集合  <code>key</code>  的成员。</p>\n<p>如果  <code>member</code>  元素是集合的成员，返回  <code>1</code>  。 如果  <code>member</code>  元素不是集合的成员，或  <code>key</code>  不存在，返回  <code>0</code></p>\n<ul>\n<li>演示</li>\n</ul>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">127.0.0.1:6379&gt; SADD k54 m1 m2 m3 m4</span><br><span class=\"line\">(<span class=\"built_in\">integer</span>) 4</span><br><span class=\"line\">127.0.0.1:6379&gt; SISMEMBER k54 m2</span><br><span class=\"line\">(<span class=\"built_in\">integer</span>) 1</span><br><span class=\"line\">127.0.0.1:6379&gt; SISMEMBER k54 m5</span><br><span class=\"line\">(<span class=\"built_in\">integer</span>) 0</span><br></pre></td></tr></table></figure>\n<h3 id=\"spop\"><a class=\"markdownIt-Anchor\" href=\"#spop\">#</a>  <code>spop</code></h3>\n<ul>\n<li>语法</li>\n</ul>\n<p><code>SPOP key [count]</code></p>\n<ul>\n<li>解释</li>\n</ul>\n<p><code>set pop</code></p>\n<p>移除并返回集合中的 <b>随机一个</b> 元素。</p>\n<ul>\n<li>演示</li>\n</ul>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">127.0.0.1:6379&gt; SADD k55 m1 m2 m3 m4 m5 m6 m7 m8 m9 m10</span><br><span class=\"line\">(<span class=\"built_in\">integer</span>) 10</span><br><span class=\"line\"><span class=\"comment\"># 随机移除一个元素</span></span><br><span class=\"line\">127.0.0.1:6379&gt; spop k55</span><br><span class=\"line\"><span class=\"string\">&quot;m9&quot;</span></span><br><span class=\"line\">127.0.0.1:6379&gt; spop k55</span><br><span class=\"line\"><span class=\"string\">&quot;m2&quot;</span></span><br><span class=\"line\">127.0.0.1:6379&gt; spop k55</span><br><span class=\"line\"><span class=\"string\">&quot;m3&quot;</span></span><br><span class=\"line\"><span class=\"comment\"># 随机移除3个元素</span></span><br><span class=\"line\">127.0.0.1:6379&gt; spop k55 3</span><br><span class=\"line\">1) <span class=\"string\">&quot;m5&quot;</span></span><br><span class=\"line\">2) <span class=\"string\">&quot;m4&quot;</span></span><br><span class=\"line\">3) <span class=\"string\">&quot;m10&quot;</span></span><br><span class=\"line\"><span class=\"comment\"># 查看所有元素</span></span><br><span class=\"line\">127.0.0.1:6379&gt; SMEMBERS k55</span><br><span class=\"line\">1) <span class=\"string\">&quot;m1&quot;</span></span><br><span class=\"line\">2) <span class=\"string\">&quot;m7&quot;</span></span><br><span class=\"line\">3) <span class=\"string\">&quot;m8&quot;</span></span><br><span class=\"line\">4) <span class=\"string\">&quot;m6&quot;</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"srandmemeber\"><a class=\"markdownIt-Anchor\" href=\"#srandmemeber\">#</a>  <code>srandmemeber</code></h3>\n<ul>\n<li>语法</li>\n</ul>\n<p><code>SRANDMEMBER key [count]</code></p>\n<ul>\n<li>解释</li>\n</ul>\n<p><code>set rand member</code></p>\n<p>返回集合中的 随机  <code>count</code>  个元素 (不会删除元素)</p>\n<p>如果  <code>count</code>  为正数，且小于集合基数，那么命令返回一个包含  <code>count</code>  个元素的数组，数组中的元素各不相同。如果  <code>count</code>  大于等于集合基数，那么返回整个集合。</p>\n<p>如果  <code>count</code>  为负数，那么命令返回一个数组，数组中的元素可能会重复出现多次，而数组的长度为  <code>count</code>  的绝对值。</p>\n<ul>\n<li>演示</li>\n</ul>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">127.0.0.1:6379&gt; SADD k56 m1 m2 m3 m4 m5 m6 m7 m8 m9 m10</span><br><span class=\"line\">(<span class=\"built_in\">integer</span>) 10</span><br><span class=\"line\"><span class=\"comment\"># 随机返回一个元素</span></span><br><span class=\"line\">127.0.0.1:6379&gt; SRANDMEMBER k56 </span><br><span class=\"line\"><span class=\"string\">&quot;m1&quot;</span></span><br><span class=\"line\">127.0.0.1:6379&gt; SRANDMEMBER k56 </span><br><span class=\"line\"><span class=\"string\">&quot;m9&quot;</span></span><br><span class=\"line\">127.0.0.1:6379&gt; SRANDMEMBER k56 </span><br><span class=\"line\"><span class=\"string\">&quot;m5&quot;</span></span><br><span class=\"line\"><span class=\"comment\"># count是正数，小于集合的元素数,返回count个元素，无重复元素</span></span><br><span class=\"line\">127.0.0.1:6379&gt; SRANDMEMBER k56 5</span><br><span class=\"line\">1) <span class=\"string\">&quot;m7&quot;</span></span><br><span class=\"line\">2) <span class=\"string\">&quot;m1&quot;</span></span><br><span class=\"line\">3) <span class=\"string\">&quot;m5&quot;</span></span><br><span class=\"line\">4) <span class=\"string\">&quot;m6&quot;</span></span><br><span class=\"line\">5) <span class=\"string\">&quot;m3&quot;</span></span><br><span class=\"line\"><span class=\"comment\"># count是正数，大于集合的元素数,返回整个集合</span></span><br><span class=\"line\">127.0.0.1:6379&gt; SRANDMEMBER k56 20</span><br><span class=\"line\"> 1) <span class=\"string\">&quot;m5&quot;</span></span><br><span class=\"line\"> 2) <span class=\"string\">&quot;m6&quot;</span></span><br><span class=\"line\"> 3) <span class=\"string\">&quot;m4&quot;</span></span><br><span class=\"line\"> 4) <span class=\"string\">&quot;m8&quot;</span></span><br><span class=\"line\"> 5) <span class=\"string\">&quot;m7&quot;</span></span><br><span class=\"line\"> 6) <span class=\"string\">&quot;m1&quot;</span></span><br><span class=\"line\"> 7) <span class=\"string\">&quot;m10&quot;</span></span><br><span class=\"line\"> 8) <span class=\"string\">&quot;m3&quot;</span></span><br><span class=\"line\"> 9) <span class=\"string\">&quot;m2&quot;</span></span><br><span class=\"line\">10) <span class=\"string\">&quot;m9&quot;</span></span><br><span class=\"line\"><span class=\"comment\"># count为负数， 返回20个集合中的元素，元素会重复</span></span><br><span class=\"line\">127.0.0.1:6379&gt; SRANDMEMBER k56 -20</span><br><span class=\"line\"> 1) <span class=\"string\">&quot;m6&quot;</span></span><br><span class=\"line\"> 2) <span class=\"string\">&quot;m6&quot;</span></span><br><span class=\"line\"> 3) <span class=\"string\">&quot;m9&quot;</span></span><br><span class=\"line\"> 4) <span class=\"string\">&quot;m7&quot;</span></span><br><span class=\"line\"> 5) <span class=\"string\">&quot;m6&quot;</span></span><br><span class=\"line\"> 6) <span class=\"string\">&quot;m5&quot;</span></span><br><span class=\"line\"> 7) <span class=\"string\">&quot;m6&quot;</span></span><br><span class=\"line\"> 8) <span class=\"string\">&quot;m9&quot;</span></span><br><span class=\"line\"> 9) <span class=\"string\">&quot;m1&quot;</span></span><br><span class=\"line\">10) <span class=\"string\">&quot;m6&quot;</span></span><br><span class=\"line\">11) <span class=\"string\">&quot;m1&quot;</span></span><br><span class=\"line\">12) <span class=\"string\">&quot;m9&quot;</span></span><br><span class=\"line\">13) <span class=\"string\">&quot;m2&quot;</span></span><br><span class=\"line\">14) <span class=\"string\">&quot;m1&quot;</span></span><br><span class=\"line\">15) <span class=\"string\">&quot;m2&quot;</span></span><br><span class=\"line\">16) <span class=\"string\">&quot;m5&quot;</span></span><br><span class=\"line\">17) <span class=\"string\">&quot;m9&quot;</span></span><br><span class=\"line\">18) <span class=\"string\">&quot;m2&quot;</span></span><br><span class=\"line\">19) <span class=\"string\">&quot;m4&quot;</span></span><br><span class=\"line\">20) <span class=\"string\">&quot;m6&quot;</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"srem\"><a class=\"markdownIt-Anchor\" href=\"#srem\">#</a>  <code>srem</code></h3>\n<ul>\n<li>语法</li>\n</ul>\n<p><code>SREM key member [member ...]</code></p>\n<ul>\n<li>解释</li>\n</ul>\n<p><code>set remove</code></p>\n<p>移除集合  <code>key</code>  中的一个或多个  <code>member</code>  元素，不存在的  <code>member</code>  元素会被忽略。</p>\n<p>当  <code>key</code>  不是集合类型，返回一个错误。</p>\n<ul>\n<li>演示</li>\n</ul>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">127.0.0.1:6379&gt; SADD k57 m1 m2 m3 m4 m5 m6 m7 m8 m9 m10</span><br><span class=\"line\">(<span class=\"built_in\">integer</span>) 10</span><br><span class=\"line\">127.0.0.1:6379&gt; SREM k57 m1 m2 m3 </span><br><span class=\"line\">(<span class=\"built_in\">integer</span>) 3</span><br><span class=\"line\">127.0.0.1:6379&gt; SMEMBERS k57</span><br><span class=\"line\">1) <span class=\"string\">&quot;m7&quot;</span></span><br><span class=\"line\">2) <span class=\"string\">&quot;m8&quot;</span></span><br><span class=\"line\">3) <span class=\"string\">&quot;m5&quot;</span></span><br><span class=\"line\">4) <span class=\"string\">&quot;m6&quot;</span></span><br><span class=\"line\">5) <span class=\"string\">&quot;m4&quot;</span></span><br><span class=\"line\">6) <span class=\"string\">&quot;m10&quot;</span></span><br><span class=\"line\">7) <span class=\"string\">&quot;m9&quot;</span></span><br><span class=\"line\">127.0.0.1:6379&gt; SREM k57 m11 m12</span><br><span class=\"line\">(<span class=\"built_in\">integer</span>) 0</span><br></pre></td></tr></table></figure>\n<h3 id=\"smove\"><a class=\"markdownIt-Anchor\" href=\"#smove\">#</a>  <code>smove</code></h3>\n<ul>\n<li>语法</li>\n</ul>\n<p><code>SMOVE source destination member</code></p>\n<ul>\n<li>解释</li>\n</ul>\n<p><code>set move</code></p>\n<p>将  <code>member</code>  元素从  <code>source</code>  集合移动到  <code>destination</code>  集合。</p>\n<p><b> <code>SMOVE</code>  是原子性操作</b>。</p>\n<p>如果  <code>source</code>  集合不存在或不包含指定的  <code>member</code>  元素，则  <code>SMOVE</code>  命令不执行任何操作，仅返回  <code>0</code>  。否则，  <code>member</code>  元素从  <code>source</code>  集合中被移除，并添加到  <code>destination</code>  集合中去。</p>\n<p>当  <code>destination</code>  集合已经包含  <code>member</code>  元素时，  <code>SMOVE</code>  命令只是简单地将  <code>source</code>  集合中的  <code>member</code>  元素删除。</p>\n<p>当  <code>source</code>  或  <code>destination</code>  不是集合类型时，返回一个错误。</p>\n<ul>\n<li>演示</li>\n</ul>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">127.0.0.1:6379&gt; SADD k58 m1 m2 m3 m4 m5 m6 m7 m8 m9 m10</span><br><span class=\"line\">(<span class=\"built_in\">integer</span>) 10</span><br><span class=\"line\"><span class=\"comment\"># 移动两个元素到k58_dis</span></span><br><span class=\"line\">127.0.0.1:6379&gt; SMOVE k58 k58_dis m1</span><br><span class=\"line\">(<span class=\"built_in\">integer</span>) 1</span><br><span class=\"line\">127.0.0.1:6379&gt; SMOVE k58 k58_dis m2</span><br><span class=\"line\">(<span class=\"built_in\">integer</span>) 1</span><br><span class=\"line\">127.0.0.1:6379&gt; SMOVE k58 k58_dis m1</span><br><span class=\"line\">(<span class=\"built_in\">integer</span>) 0</span><br><span class=\"line\"><span class=\"comment\"># k58中的m1，m2 已被移除。</span></span><br><span class=\"line\">127.0.0.1:6379&gt; SMEMBERS k58</span><br><span class=\"line\">1) <span class=\"string\">&quot;m7&quot;</span></span><br><span class=\"line\">2) <span class=\"string\">&quot;m8&quot;</span></span><br><span class=\"line\">3) <span class=\"string\">&quot;m5&quot;</span></span><br><span class=\"line\">4) <span class=\"string\">&quot;m6&quot;</span></span><br><span class=\"line\">5) <span class=\"string\">&quot;m4&quot;</span></span><br><span class=\"line\">6) <span class=\"string\">&quot;m10&quot;</span></span><br><span class=\"line\">7) <span class=\"string\">&quot;m3&quot;</span></span><br><span class=\"line\">8) <span class=\"string\">&quot;m9&quot;</span></span><br><span class=\"line\"><span class=\"comment\"># k58_dis中的m1,m2</span></span><br><span class=\"line\">127.0.0.1:6379&gt; SMEMBERS k58_dis</span><br><span class=\"line\">1) <span class=\"string\">&quot;m2&quot;</span></span><br><span class=\"line\">2) <span class=\"string\">&quot;m1&quot;</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"scard\"><a class=\"markdownIt-Anchor\" href=\"#scard\">#</a>  <code>scard</code></h3>\n<ul>\n<li>语法</li>\n</ul>\n<p><code>SCARD key</code></p>\n<ul>\n<li>解释</li>\n</ul>\n<p>返回集合  <code>key</code>  的基数 (集合中元素的数量)。<br>\n集合的基数。 当  <code>key</code>  不存在时，返回  <code>0</code></p>\n<ul>\n<li>演示</li>\n</ul>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">127.0.0.1:6379&gt; SADD k59 m1 m2 m3 m4 m5 m6 m7 m8 m9 m10</span><br><span class=\"line\">(<span class=\"built_in\">integer</span>) 10</span><br><span class=\"line\"><span class=\"comment\"># 获取元素个数</span></span><br><span class=\"line\">127.0.0.1:6379&gt; SCARD k59</span><br><span class=\"line\">(<span class=\"built_in\">integer</span>) 10</span><br></pre></td></tr></table></figure>\n<h3 id=\"sinter\"><a class=\"markdownIt-Anchor\" href=\"#sinter\">#</a>  <code>sinter</code></h3>\n<ul>\n<li>语法</li>\n</ul>\n<p><code> SINTER key [key ...]</code></p>\n<ul>\n<li>解释</li>\n</ul>\n<p><code>set intersection</code>  :  <code>set</code>  的交集</p>\n<p>返回一个集合的全部成员，该集合是所有给定集合的交集。</p>\n<p>不存在的  <code>key</code>  被视为空集。</p>\n<p>当给定集合当中有一个空集时，结果也为空集 (根据集合运算定律)。</p>\n<ul>\n<li>演示</li>\n</ul>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">127.0.0.1:6379&gt; SADD k60_1 m1 m2 m3 m4 m5 </span><br><span class=\"line\">(<span class=\"built_in\">integer</span>) 5</span><br><span class=\"line\">127.0.0.1:6379&gt; SADD k60_2 m2 m3 m4 m5 m6</span><br><span class=\"line\">(<span class=\"built_in\">integer</span>) 5</span><br><span class=\"line\">127.0.0.1:6379&gt; SADD k60_3 m4 m5 m6 m7 m8</span><br><span class=\"line\">(<span class=\"built_in\">integer</span>) 5</span><br><span class=\"line\"><span class=\"comment\"># 指定了一个key，返回集合的所有元素</span></span><br><span class=\"line\">127.0.0.1:6379&gt; SINTER k60_1</span><br><span class=\"line\">1) <span class=\"string\">&quot;m4&quot;</span></span><br><span class=\"line\">2) <span class=\"string\">&quot;m3&quot;</span></span><br><span class=\"line\">3) <span class=\"string\">&quot;m2&quot;</span></span><br><span class=\"line\">4) <span class=\"string\">&quot;m1&quot;</span></span><br><span class=\"line\">5) <span class=\"string\">&quot;m5&quot;</span></span><br><span class=\"line\"><span class=\"comment\"># 多个key的时候，返回集合的交集。</span></span><br><span class=\"line\">127.0.0.1:6379&gt; SINTER k60_1 k60_2</span><br><span class=\"line\">1) <span class=\"string\">&quot;m4&quot;</span></span><br><span class=\"line\">2) <span class=\"string\">&quot;m3&quot;</span></span><br><span class=\"line\">3) <span class=\"string\">&quot;m2&quot;</span></span><br><span class=\"line\">4) <span class=\"string\">&quot;m5&quot;</span></span><br><span class=\"line\"><span class=\"comment\"># 多个key的时候，返回集合的交集。</span></span><br><span class=\"line\">127.0.0.1:6379&gt; SINTER k60_1 k60_2 k60_3</span><br><span class=\"line\">1) <span class=\"string\">&quot;m4&quot;</span></span><br><span class=\"line\">2) <span class=\"string\">&quot;m5&quot;</span></span><br><span class=\"line\"><span class=\"comment\"># k60_4不存在，为空集</span></span><br><span class=\"line\">127.0.0.1:6379&gt; SINTER k60_1 k60_4</span><br><span class=\"line\">(empty list or <span class=\"built_in\">set</span>)</span><br></pre></td></tr></table></figure>\n<h3 id=\"sinterstore\"><a class=\"markdownIt-Anchor\" href=\"#sinterstore\">#</a>  <code>sinterstore</code></h3>\n<ul>\n<li>语法</li>\n</ul>\n<p><code>SINTERSTORE destination key [key ...]</code></p>\n<ul>\n<li>解释</li>\n</ul>\n<p><code>set intersection and store</code></p>\n<p>这个命令类似于 SINTER key [key …] 命令，返回集合的交集。但它将结果保存到 destination 集合，而不是简单地返回结果集。</p>\n<p>如果 destination 集合已经存在，则将其覆盖。</p>\n<p>destination 可以是 key 本身。</p>\n<ul>\n<li>演示</li>\n</ul>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">127.0.0.1:6379&gt; SADD k61_1 m1 m2 m3 m4 m5</span><br><span class=\"line\">(<span class=\"built_in\">integer</span>) 5</span><br><span class=\"line\">127.0.0.1:6379&gt; SADD k61_2 m4 m5 m6 m7 m8</span><br><span class=\"line\">(<span class=\"built_in\">integer</span>) 5</span><br><span class=\"line\"><span class=\"comment\"># 将k61_1 和 k61_2 集合的交集存储到k61_dis中</span></span><br><span class=\"line\">127.0.0.1:6379&gt; SINTERSTORE k61_dis k61_1 k61_2</span><br><span class=\"line\">(<span class=\"built_in\">integer</span>) 2</span><br><span class=\"line\"><span class=\"comment\"># 查看 k61_dis</span></span><br><span class=\"line\">127.0.0.1:6379&gt; SMEMBERS k61_dis</span><br><span class=\"line\">1) <span class=\"string\">&quot;m4&quot;</span></span><br><span class=\"line\">2) <span class=\"string\">&quot;m5&quot;</span></span><br><span class=\"line\"><span class=\"comment\"># k61_1 和 k61_2 没有变化</span></span><br><span class=\"line\">127.0.0.1:6379&gt; SMEMBERS k61_1</span><br><span class=\"line\">1) <span class=\"string\">&quot;m4&quot;</span></span><br><span class=\"line\">2) <span class=\"string\">&quot;m3&quot;</span></span><br><span class=\"line\">3) <span class=\"string\">&quot;m2&quot;</span></span><br><span class=\"line\">4) <span class=\"string\">&quot;m1&quot;</span></span><br><span class=\"line\">5) <span class=\"string\">&quot;m5&quot;</span></span><br><span class=\"line\">127.0.0.1:6379&gt; SMEMBERS k61_2</span><br><span class=\"line\">1) <span class=\"string\">&quot;m7&quot;</span></span><br><span class=\"line\">2) <span class=\"string\">&quot;m8&quot;</span></span><br><span class=\"line\">3) <span class=\"string\">&quot;m5&quot;</span></span><br><span class=\"line\">4) <span class=\"string\">&quot;m6&quot;</span></span><br><span class=\"line\">5) <span class=\"string\">&quot;m4&quot;</span></span><br><span class=\"line\"><span class=\"comment\"># 如果目标集合(k61_dis)存在，元素会被覆盖掉。</span></span><br><span class=\"line\">127.0.0.1:6379&gt; SADD k61_3 m1 m2 m3 </span><br><span class=\"line\">(<span class=\"built_in\">integer</span>) 3</span><br><span class=\"line\">127.0.0.1:6379&gt; SINTERSTORE k61_dis k61_1 k61_3</span><br><span class=\"line\">(<span class=\"built_in\">integer</span>) 3</span><br><span class=\"line\">127.0.0.1:6379&gt; SMEMBERS k61_dis</span><br><span class=\"line\">1) <span class=\"string\">&quot;m1&quot;</span></span><br><span class=\"line\">2) <span class=\"string\">&quot;m2&quot;</span></span><br><span class=\"line\">3) <span class=\"string\">&quot;m3&quot;</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"sunion\"><a class=\"markdownIt-Anchor\" href=\"#sunion\">#</a>  <code>sunion</code></h3>\n<ul>\n<li>语法</li>\n</ul>\n<p><code>SUNION key [key ...]</code></p>\n<ul>\n<li>解释</li>\n</ul>\n<p><code>set union</code></p>\n<p>返回一个集合的全部成员，如果是多个集合 (key), 返回所有给定集合的并集。</p>\n<p>不存在的 key 被视为空集。</p>\n<ul>\n<li>演示</li>\n</ul>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">127.0.0.1:6379&gt; SADD k62_1 m1 m2 m3 </span><br><span class=\"line\">(<span class=\"built_in\">integer</span>) 3</span><br><span class=\"line\">127.0.0.1:6379&gt; SADD k62_2 m2 m3 m4 m5 m6 </span><br><span class=\"line\">(<span class=\"built_in\">integer</span>) 5</span><br><span class=\"line\"><span class=\"comment\"># 一个key，返回整个集合。</span></span><br><span class=\"line\">127.0.0.1:6379&gt; SUNION k62_1</span><br><span class=\"line\">1) <span class=\"string\">&quot;m1&quot;</span></span><br><span class=\"line\">2) <span class=\"string\">&quot;m2&quot;</span></span><br><span class=\"line\">3) <span class=\"string\">&quot;m3&quot;</span></span><br><span class=\"line\"><span class=\"comment\"># 多个key，返回并集</span></span><br><span class=\"line\">127.0.0.1:6379&gt; SUNION k62_1 k62_2</span><br><span class=\"line\">1) <span class=\"string\">&quot;m3&quot;</span></span><br><span class=\"line\">2) <span class=\"string\">&quot;m1&quot;</span></span><br><span class=\"line\">3) <span class=\"string\">&quot;m5&quot;</span></span><br><span class=\"line\">4) <span class=\"string\">&quot;m6&quot;</span></span><br><span class=\"line\">5) <span class=\"string\">&quot;m2&quot;</span></span><br><span class=\"line\">6) <span class=\"string\">&quot;m4&quot;</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"sunionstore\"><a class=\"markdownIt-Anchor\" href=\"#sunionstore\">#</a>  <code>sunionstore</code></h3>\n<ul>\n<li>语法</li>\n</ul>\n<p><code>SUNIONSTORE destination key [key ...]</code></p>\n<ul>\n<li>解释</li>\n</ul>\n<p><code>set union and store</code></p>\n<p>同 SINTERSTORE , 只不过存储的是并集的结果。 将多个集合的并集存储到 distination 中。</p>\n<ul>\n<li>演示</li>\n</ul>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">127.0.0.1:6379&gt; SADD k63_1 m1 m2 m3 </span><br><span class=\"line\">(<span class=\"built_in\">integer</span>) 3</span><br><span class=\"line\">127.0.0.1:6379&gt; SADD k63_2 m2 m3 m4 m5 m6 </span><br><span class=\"line\">(<span class=\"built_in\">integer</span>) 5</span><br><span class=\"line\">127.0.0.1:6379&gt; SUNIONSTORE k63_dis k62_1 k62_2</span><br><span class=\"line\">(<span class=\"built_in\">integer</span>) 6</span><br><span class=\"line\">127.0.0.1:6379&gt; SMEMBERS k63_dis</span><br><span class=\"line\">1) <span class=\"string\">&quot;m3&quot;</span></span><br><span class=\"line\">2) <span class=\"string\">&quot;m1&quot;</span></span><br><span class=\"line\">3) <span class=\"string\">&quot;m5&quot;</span></span><br><span class=\"line\">4) <span class=\"string\">&quot;m6&quot;</span></span><br><span class=\"line\">5) <span class=\"string\">&quot;m2&quot;</span></span><br><span class=\"line\">6) <span class=\"string\">&quot;m4&quot;</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"sdiff\"><a class=\"markdownIt-Anchor\" href=\"#sdiff\">#</a>  <code>sdiff</code></h3>\n<ul>\n<li>语法</li>\n</ul>\n<p><code>SDIFF key [key ...]</code></p>\n<ul>\n<li>解释</li>\n</ul>\n<p><code>set difference</code></p>\n<p>如果指定一个集合， <code>key</code> ，返回一个集合的全部成员，</p>\n<p>如果指定了多个集合 ( <code>key</code> ), 则返回 所有给定集合之间的差集。</p>\n<p>不存在的  <code>key</code>  被视为空集。</p>\n<ul>\n<li>演示</li>\n</ul>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">127.0.0.1:6379&gt; SADD k64_1 m1 m2 m3 </span><br><span class=\"line\">(<span class=\"built_in\">integer</span>) 3</span><br><span class=\"line\">127.0.0.1:6379&gt; SADD k64_2 m2 m3 m4 m5 m6 </span><br><span class=\"line\">(<span class=\"built_in\">integer</span>) 5</span><br><span class=\"line\"><span class=\"comment\"># 返回 k64_1 - k64_2</span></span><br><span class=\"line\">127.0.0.1:6379&gt; SDIFF k64_1 k64_2</span><br><span class=\"line\">1) <span class=\"string\">&quot;m1&quot;</span></span><br><span class=\"line\"><span class=\"comment\"># 返回 k64_2 - k64_1</span></span><br><span class=\"line\">127.0.0.1:6379&gt; SDIFF k64_2 k64_1</span><br><span class=\"line\">1) <span class=\"string\">&quot;m6&quot;</span></span><br><span class=\"line\">2) <span class=\"string\">&quot;m4&quot;</span></span><br><span class=\"line\">3) <span class=\"string\">&quot;m5&quot;</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"sdiffstore\"><a class=\"markdownIt-Anchor\" href=\"#sdiffstore\">#</a>  <code>sdiffstore</code></h3>\n<ul>\n<li>语法</li>\n</ul>\n<p><code>SDIFFSTORE destination key [key ...]</code></p>\n<ul>\n<li>解释</li>\n</ul>\n<p>将集合的差集存储到  <code>destination</code>  集合中.</p>\n<ul>\n<li>演示</li>\n</ul>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">127.0.0.1:6379&gt; SADD k65_1 m1 m2 m3 </span><br><span class=\"line\">(<span class=\"built_in\">integer</span>) 3</span><br><span class=\"line\">127.0.0.1:6379&gt; SADD k65_2 m2 m3 m4 m5 m6 </span><br><span class=\"line\">(<span class=\"built_in\">integer</span>) 5</span><br><span class=\"line\">127.0.0.1:6379&gt; SDIFFSTORE k65_dis_1 k65_1 k65_2</span><br><span class=\"line\">(<span class=\"built_in\">integer</span>) 1</span><br><span class=\"line\">127.0.0.1:6379&gt; SMEMBERS k65_dis_1</span><br><span class=\"line\">1) <span class=\"string\">&quot;m1&quot;</span></span><br><span class=\"line\">127.0.0.1:6379&gt; SDIFFSTORE k65_dis_2 k65_2 k65_1</span><br><span class=\"line\">(<span class=\"built_in\">integer</span>) 3</span><br><span class=\"line\">127.0.0.1:6379&gt; SMEMBERS k65_dis_2</span><br><span class=\"line\">1) <span class=\"string\">&quot;m6&quot;</span></span><br><span class=\"line\">2) <span class=\"string\">&quot;m4&quot;</span></span><br><span class=\"line\">3) <span class=\"string\">&quot;m5&quot;</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"sscan\"><a class=\"markdownIt-Anchor\" href=\"#sscan\">#</a>  <code>sscan</code></h3>\n<ul>\n<li>语法</li>\n</ul>\n<p><code>SSCAN key cursor [MATCH pattern] [COUNT count]</code></p>\n<ul>\n<li>解释</li>\n</ul>\n<p><code>set scan</code></p>\n<p>这是一个查询命令。 同  <code>SCAN</code>  命令。可以参考这篇文章 <a href=\"./010-%E5%85%B6%E4%BB%96%E5%91%BD%E4%BB%A4.md\">010 - 其他命令</a></p>\n<p><code>SCAN</code>  命令是一个基于游标的迭代器（ <code>cursor based iterator</code> ）：  <code>SCAN</code>  命令每次被调用之后， 都会向用户返回一个新的游标， 用户在下次迭代时需要使用这个新游标作为  <code>SCAN</code>  命令的游标参数， 以此来延续之前的迭代过程。</p>\n<ul>\n<li>演示</li>\n</ul>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">127.0.0.1:6379&gt; SSCAN k66 1</span><br><span class=\"line\">1) <span class=\"string\">&quot;0&quot;</span></span><br><span class=\"line\">2) 1) <span class=\"string\">&quot;m1&quot;</span></span><br><span class=\"line\">   2) <span class=\"string\">&quot;m3&quot;</span></span><br><span class=\"line\">   3) <span class=\"string\">&quot;m2&quot;</span></span><br><span class=\"line\">   4) <span class=\"string\">&quot;m4&quot;</span></span><br><span class=\"line\">   5) <span class=\"string\">&quot;m5&quot;</span></span><br><span class=\"line\">127.0.0.1:6379&gt; SSCAN k66 0</span><br><span class=\"line\">1) <span class=\"string\">&quot;0&quot;</span></span><br><span class=\"line\">2) 1) <span class=\"string\">&quot;m6&quot;</span></span><br><span class=\"line\">   2) <span class=\"string\">&quot;m1&quot;</span></span><br><span class=\"line\">   3) <span class=\"string\">&quot;m3&quot;</span></span><br><span class=\"line\">   4) <span class=\"string\">&quot;m2&quot;</span></span><br><span class=\"line\">   5) <span class=\"string\">&quot;m4&quot;</span></span><br><span class=\"line\">   6) <span class=\"string\">&quot;m5&quot;</span></span><br><span class=\"line\">127.0.0.1:6379&gt; SSCAN k66 1 MATCH m2 Count 10</span><br><span class=\"line\">1) <span class=\"string\">&quot;0&quot;</span></span><br><span class=\"line\">2) 1) <span class=\"string\">&quot;m2&quot;</span></span><br><span class=\"line\">127.0.0.1:6379&gt; </span><br></pre></td></tr></table></figure>\n<h2 id=\"set的内部结构\"><a class=\"markdownIt-Anchor\" href=\"#set的内部结构\">#</a>  <code>set</code>  的内部结构</h2>\n<p>在 t_set.c 这个文件中。</p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\">robj *<span class=\"title\">setTypeCreate</span><span class=\"params\">(sds value)</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (<span class=\"built_in\">isSdsRepresentableAsLongLong</span>(value,<span class=\"literal\">NULL</span>) == C_OK)</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"built_in\">createIntsetObject</span>();</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"built_in\">createSetObject</span>();</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>表明， <code>set</code>  数据类型是由两种数据结构来实现的。</p>\n<p>而在  <code>createSetObject()</code> ，指明了其编码方式是  <code>OBJ_ENCODING_HT</code> , 即哈希表的方式，也就是使用 dict 这种数据结构来存储的。</p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\">robj *<span class=\"title\">createSetObject</span><span class=\"params\">(<span class=\"keyword\">void</span>)</span> </span>&#123;</span><br><span class=\"line\">    dict *d = <span class=\"built_in\">dictCreate</span>(&amp;setDictType, <span class=\"literal\">NULL</span>);</span><br><span class=\"line\">    robj *o = <span class=\"built_in\">createObject</span>(OBJ_SET, d);</span><br><span class=\"line\">    o-&gt;encoding = OBJ_ENCODING_HT;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> o;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"hashtable\"><a class=\"markdownIt-Anchor\" href=\"#hashtable\">#</a>  <code>hashtable</code></h3>\n<p>这里就不赘述了。直接上<a href=\"/2021/08/01/Redis%E7%B3%BB%E5%88%97/B-3-Redis%E7%9A%84%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B%E4%B9%8Bhash/\">穿梭机</a>吧。</p>\n<h3 id=\"intset\"><a class=\"markdownIt-Anchor\" href=\"#intset\">#</a> intset</h3>\n<p>在 <code>createIntsetObject()</code>  中指明了使用的编码方式是  <code>OBJ_ENCODING_INTSET</code> . 如下。</p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\">robj *<span class=\"title\">createIntsetObject</span><span class=\"params\">(<span class=\"keyword\">void</span>)</span> </span>&#123;</span><br><span class=\"line\">    intset *is = <span class=\"built_in\">intsetNew</span>();</span><br><span class=\"line\">    robj *o = <span class=\"built_in\">createObject</span>(OBJ_SET, is);</span><br><span class=\"line\">    o-&gt;encoding = OBJ_ENCODING_INTSET;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> o;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>我们来看看  <code>intset</code>  到底什么何方利器.</p>\n<p>我直接全项目搜索:  <code>intset</code>  ，就找到了  <code>intset.h</code> .</p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">typedef</span> <span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">intset</span> &#123;</span></span><br><span class=\"line\">    <span class=\"keyword\">uint32_t</span> encoding; </span><br><span class=\"line\">    <span class=\"keyword\">uint32_t</span> length;</span><br><span class=\"line\">    <span class=\"keyword\">int8_t</span> contents[];</span><br><span class=\"line\">&#125; intset;</span><br></pre></td></tr></table></figure>\n<h4 id=\"字段解释\"><a class=\"markdownIt-Anchor\" href=\"#字段解释\">#</a> 字段解释:</h4>\n<ul>\n<li><code>encoding</code> : 数据编码，表示 <code>intset</code>  中的每个数据元素用几个字节来存储。它有三种可能的取值： <code>INTSET_ENC_INT16</code>  表示每个元素用 <code>2</code>  个字节存储， <code>INTSET_ENC_INT32</code>  表示每个元素用 <code>4</code>  个字节存储， <code>INTSET_ENC_INT64</code>  表示每个元素用 <code>8</code>  个字节存储。因此， <code>intset</code>  中存储的整数最多只能占用 <code>64bit</code> 。</li>\n<li><code>length</code> : 表示 <code>intset</code>  中的元素个数。 <code>encoding</code>  和 <code>length</code>  两个字段构成了 <code>intset</code>  的头部（ <code>header</code> ）。</li>\n<li><code>contents</code> : 是一个柔性数组（ <code>flexible array member</code> ），表示 <code>intset</code>  的 <code>header</code>  后面紧跟着数据元素。这个数组的总长度（即总字节数）等于 <code>encoding * length</code> 。柔性数组在 <code>Redis</code>  的很多数据结构的定义中都出现过（例如 <code>sds</code> ,  <code>quicklist</code> ,  <code>skiplist</code> ），用于表达一个偏移量。 <code>contents</code>  需要单独为其分配空间，这部分内存不包含在 <code>intset</code>  结构当中。</li>\n</ul>\n<p>这里有个问题.</p>\n<p>Redis 是如何决定一个 set 使用哪种编码方式的呢？</p>\n<p>set 的编码是由第一个元素决定的。</p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\">robj *<span class=\"title\">setTypeCreate</span><span class=\"params\">(sds value)</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (<span class=\"built_in\">isSdsRepresentableAsLongLong</span>(value,<span class=\"literal\">NULL</span>) == C_OK)</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"built_in\">createIntsetObject</span>();</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"built_in\">createSetObject</span>();</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">int</span> <span class=\"title\">isSdsRepresentableAsLongLong</span><span class=\"params\">(sds s, <span class=\"keyword\">long</span> <span class=\"keyword\">long</span> *llval)</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"built_in\">string2ll</span>(s, <span class=\"built_in\">sdslen</span>(s), llval) ? C_OK : C_ERR;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>如果  <code>value</code>  可以转换成  <code>long long</code>  类型的话，就使用  <code>inset</code>  编码方式。</p>\n<p>通过看源码发现:</p>\n<p>当 <code>intset</code>  的元素个数超过  <code>set_max_intset_entries</code>  这个配置的时候，就会从 <code>intset</code>  编码 ( <code>OBJ_ENCODING_INTSET</code> ) 转换成  <code>ht</code>  编码 ( <code>OBJ_ENCODING_HT</code> )。</p>\n<p>这个我们会在后续文章中说明这里的方案。</p>\n<p>好了，关于 set 类型的介绍就到这里了。</p>\n<h2 id=\"总结\"><a class=\"markdownIt-Anchor\" href=\"#总结\">#</a> 总结</h2>\n<ul>\n<li><code>set</code>  这种类型是一种无重复元素的集合。</li>\n<li><code>set</code>  的业务场景关键字：去重，交并差运算。但是一定是无序的。如果要求有序的话，那就 <a href=\"./09-Redis%E7%9A%84%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B%E4%B9%8B%E6%9C%89%E5%BA%8F%E9%9B%86%E5%90%88zset.md\">下一篇文章  zset</a> ~</li>\n<li><code>set</code>  的  <code>15</code>  个命令，务必熟记！！！</li>\n<li><code>set</code>  的内部编码方式。哈希表编码和 <code>intset</code>  编码。后面会有 关于  <code>intset</code>  数据结构的详细介绍的文章～</li>\n</ul>\n<h2 id=\"最后\"><a class=\"markdownIt-Anchor\" href=\"#最后\">#</a> 最后</h2>\n<p>期望与你一起遇见更好的自己</p>\n<p><img data-src=\"/images/qrcode.jpg\" alt=\"期望与你一起遇见更好的自己\"></p>\n",
            "tags": [
                "Redis"
            ]
        },
        {
            "id": "https://fangjiaxiaobai.github.io/2021/08/01/Redis%E7%B3%BB%E5%88%97/B-3-Redis%E7%9A%84%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B%E4%B9%8Bhash/",
            "url": "https://fangjiaxiaobai.github.io/2021/08/01/Redis%E7%B3%BB%E5%88%97/B-3-Redis%E7%9A%84%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B%E4%B9%8Bhash/",
            "title": "Redis数据结构之 Hash",
            "date_published": "2021-08-01T07:18:55.000Z",
            "content_html": "<h2 id=\"书接上回\"><a class=\"markdownIt-Anchor\" href=\"#书接上回\">#</a> 书接上回</h2>\n<p>前一篇文章，我们学习的是 <a href=\"/2021/08/01/Redis%E7%B3%BB%E5%88%97/B-2-Redis%E7%9A%84%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B%E4%B9%8Blist/\">Redis 的数据结构 list</a>， 学习了其基本的操作和使用内部数据结构是 <code>quicklist</code>  和 <code>ziplist</code> ，这两种数据结构虽然起得名字是 <code>list</code> ，但是其内部结构却是链表。如果不记得了其内部构成，就再看看看着<a href=\"/2021/08/01/Redis%E7%B3%BB%E5%88%97/B-2-Redis%E7%9A%84%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B%E4%B9%8Blist/\">上篇文章</a>吧。现在我们继续学习下一个数据类型  <code>hash</code></p>\n<h2 id=\"hash简介\"><a class=\"markdownIt-Anchor\" href=\"#hash简介\">#</a>  <code>hash</code>  简介</h2>\n<p><code>hash</code>  是一个键值对集合。是  <code>string</code>  类型的  <code>key</code>  和  <code>value</code>  的映射表，hash 特别适合用于存储对象，每个 <code>hash</code>  类型可以存储  <code>2^32-1</code>  个键值对。</p>\n<p><code>hash</code>  实际上就是一个 哈希表。类似于  <code>Java</code>  里的 <code>HashTable</code> 。</p>\n<p>但是  <code>Redis</code>  的哈希是有两种数据结构 (内部编码) 来表示的。</p>\n<ul>\n<li>\n<p>一种是  <code>ziplist</code>  , 上篇文章中我们简单的介绍了 <code>ziplist</code>  的内部构成，见 <a href=\"./06-Redis%E7%9A%84%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B%E4%B9%8Blist.md\">Redis 的数据结构 list</a>, 以及 <code>ziplist</code>  的编码方式，可以看这篇文章 <a href=\"/2021/08/01/Redis%E7%B3%BB%E5%88%97/C-1-Redis%E7%9A%84%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B9%8Bziplist/\">10-Redis 的数据结构之 ziplist.md</a>. 那么  <code>Redis</code>  什么时候会使用 <code>ziplist</code>  这种编码方式呢？</p>\n<ul>\n<li>当  <code>hash</code>  类型的元素的个数小于  <code>hash-max-ziplist-enties</code>  配置，默认 <code>512</code> .</li>\n<li>所有的值都小于 <code>hash-max-ziplist-value</code>  的值，默认是 <code>64</code>  个字节的时候。<br>\n当同时满足以上两个条件的时候， 就会使用  <code>ziplist</code>  这种结构。</li>\n</ul>\n</li>\n</ul>\n<p>这种方式最大的优点就是节约空间。</p>\n<ul>\n<li>另一种就是使用  <code>hashtable</code>  来编码了。当不满足上面提及的两个条件时，就会使用  <code>hashtable</code>  来编码。实际上是  <code>dict</code>  这种数据结构。这里我们又可以学习到一个新的数据结构  <code>dict</code></li>\n</ul>\n<h2 id=\"hash的应用场景\"><a class=\"markdownIt-Anchor\" href=\"#hash的应用场景\">#</a> hash 的应用场景</h2>\n<ul>\n<li>缓存对象信息：对象的每个属性对应着 <code>hash</code>  的一个键值对。改变的时候，只需要改变对应的某个 <code>filed-value</code>  即可。</li>\n<li>缓存购物车的信息：用户的 <code>id</code>  为 <code>key</code> ， 商品的 <code>id</code>  为  <code>field</code> . 商品的数量为 <code>value</code> 。 比如:  <code>hset userId productId productCount</code></li>\n</ul>\n<h2 id=\"hash的基本命令\"><a class=\"markdownIt-Anchor\" href=\"#hash的基本命令\">#</a>  <code>hash</code>  的基本命令</h2>\n<h3 id=\"hset\"><a class=\"markdownIt-Anchor\" href=\"#hset\">#</a>  <code>hset</code></h3>\n<ul>\n<li>语法</li>\n</ul>\n<p><code>hset key field value</code></p>\n<ul>\n<li>解释</li>\n</ul>\n<p>将哈希表  <code>hash</code>  中域  <code>field</code>  的值设置为  <code>value</code>  。</p>\n<p>如果给定的哈希表并不存在， 那么一个新的哈希表将被创建并执行  <code>HSET</code>  操作。</p>\n<p>如果域  <code>field</code>  已经存在于哈希表中， 那么它的旧值将被新值  <code>value</code>  覆盖。</p>\n<ul>\n<li>演示</li>\n</ul>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">## 设置一个hash结构</span></span><br><span class=\"line\">127.0.0.1:6379&gt; HSET k38 f1 v38</span><br><span class=\"line\">(<span class=\"built_in\">integer</span>) 1</span><br><span class=\"line\"><span class=\"comment\"># 获取一个字段</span></span><br><span class=\"line\">127.0.0.1:6379&gt; HGET k38 f1</span><br><span class=\"line\"><span class=\"string\">&quot;v38&quot;</span></span><br><span class=\"line\"><span class=\"comment\"># 设置一个已经存在的值, 注意返回的值。</span></span><br><span class=\"line\">127.0.0.1:6379&gt; HSET k38 f1 v38v38</span><br><span class=\"line\">(<span class=\"built_in\">integer</span>) 0</span><br><span class=\"line\">127.0.0.1:6379&gt; HGET k38 f1</span><br><span class=\"line\"><span class=\"string\">&quot;v38v38&quot;</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"hsetnx\"><a class=\"markdownIt-Anchor\" href=\"#hsetnx\">#</a>  <code>hsetnx</code></h3>\n<ul>\n<li>语法</li>\n</ul>\n<p><code>HSETNX key field value</code></p>\n<ul>\n<li>解释</li>\n</ul>\n<p>当且仅当域  <code>field</code>  尚未存在于哈希表的情况下， 将它的值设置为  <code>value</code>  。</p>\n<p>如果给定域已经存在于哈希表当中， 那么命令将放弃执行设置操作。</p>\n<p>如果哈希表  <code>hash</code>  不存在， 那么一个新的哈希表将被创建并执行  <code>HSETNX</code>  命令。</p>\n<ul>\n<li>演示</li>\n</ul>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 设置一个不存在的 key</span></span><br><span class=\"line\">127.0.0.1:6379&gt; HSETNX k39 f1 v39</span><br><span class=\"line\">(<span class=\"built_in\">integer</span>) 1</span><br><span class=\"line\">127.0.0.1:6379&gt; HGET k39 f1</span><br><span class=\"line\"><span class=\"string\">&quot;v39&quot;</span></span><br><span class=\"line\"><span class=\"comment\"># 再次设置</span></span><br><span class=\"line\">127.0.0.1:6379&gt; HSETNX k39 f1 v39v39</span><br><span class=\"line\">(<span class=\"built_in\">integer</span>) 0</span><br><span class=\"line\">127.0.0.1:6379&gt; HGET k39 f1</span><br><span class=\"line\"><span class=\"string\">&quot;v39&quot;</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"hget\"><a class=\"markdownIt-Anchor\" href=\"#hget\">#</a>  <code>hget</code></h3>\n<p>这个命令上面已经用到了。这里就不浪费时间了。</p>\n<ul>\n<li>语法</li>\n</ul>\n<p><code>HGET key field</code></p>\n<ul>\n<li>解释</li>\n</ul>\n<p>获取对应的  <code>key</code>  下的域  <code>field</code>  的值。不存在的时候，返回  <code>nil</code></p>\n<h3 id=\"hgetall\"><a class=\"markdownIt-Anchor\" href=\"#hgetall\">#</a>  <code>hgetall</code></h3>\n<ul>\n<li>语法</li>\n</ul>\n<p><code>HGETALL key</code></p>\n<ul>\n<li>解释</li>\n</ul>\n<p>返回哈希表  <code>key</code>  中，所有的域和值。</p>\n<p>在返回值里，紧跟每个域名 ( <code>field name</code> ) 之后是域的值 ( <code>value</code> )，所以返回值的长度是哈希表大小的两倍。</p>\n<ul>\n<li>演示</li>\n</ul>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">127.0.0.1:6379&gt; HGETALL k39 </span><br><span class=\"line\">1) <span class=\"string\">&quot;f1&quot;</span></span><br><span class=\"line\">2) <span class=\"string\">&quot;v39&quot;</span></span><br><span class=\"line\">127.0.0.1:6379&gt; hset k39 f2 v39_2</span><br><span class=\"line\">(<span class=\"built_in\">integer</span>) 1</span><br><span class=\"line\">127.0.0.1:6379&gt; HGETALL k39 </span><br><span class=\"line\">1) <span class=\"string\">&quot;f1&quot;</span></span><br><span class=\"line\">2) <span class=\"string\">&quot;v39&quot;</span></span><br><span class=\"line\">3) <span class=\"string\">&quot;f2&quot;</span></span><br><span class=\"line\">4) <span class=\"string\">&quot;v39_2&quot;</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"hexists\"><a class=\"markdownIt-Anchor\" href=\"#hexists\">#</a>  <code>hexists</code></h3>\n<ul>\n<li>语法</li>\n</ul>\n<p><code> HEXISTS key field</code></p>\n<ul>\n<li>解释</li>\n</ul>\n<p>检查给定域  <code>field</code>  是否存在于哈希表  <code>hash</code>  当中。</p>\n<p>存在返回 <code>1</code> , 不存在返回 <code>0</code> 。</p>\n<ul>\n<li>演示</li>\n</ul>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">127.0.0.1:6379&gt; HEXISTS k40 f1</span><br><span class=\"line\">(<span class=\"built_in\">integer</span>) 0</span><br><span class=\"line\">127.0.0.1:6379&gt; HSET k40 f1 v40</span><br><span class=\"line\">(<span class=\"built_in\">integer</span>) 1</span><br><span class=\"line\">127.0.0.1:6379&gt; HEXISTS k40 f1</span><br><span class=\"line\">(<span class=\"built_in\">integer</span>) 1</span><br></pre></td></tr></table></figure>\n<h3 id=\"del\"><a class=\"markdownIt-Anchor\" href=\"#del\">#</a>  <code>del</code></h3>\n<ul>\n<li>语法</li>\n</ul>\n<p><code>HDEL key field [field ...]</code></p>\n<ul>\n<li>解释</li>\n</ul>\n<p>删除哈希表 key 中的一个或多个指定域，不存在的域将被忽略。</p>\n<ul>\n<li>演示</li>\n</ul>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">127.0.0.1:6379&gt; HSET k41 f1 v41_1</span><br><span class=\"line\">(<span class=\"built_in\">integer</span>) 1</span><br><span class=\"line\">127.0.0.1:6379&gt; HSET k41 f2 v41_2</span><br><span class=\"line\">(<span class=\"built_in\">integer</span>) 1</span><br><span class=\"line\">127.0.0.1:6379&gt; HSET k41 f3 v41_3</span><br><span class=\"line\">(<span class=\"built_in\">integer</span>) 1</span><br><span class=\"line\">127.0.0.1:6379&gt; HGETALL k41</span><br><span class=\"line\">1) <span class=\"string\">&quot;f1&quot;</span></span><br><span class=\"line\">2) <span class=\"string\">&quot;v41_1&quot;</span></span><br><span class=\"line\">3) <span class=\"string\">&quot;f2&quot;</span></span><br><span class=\"line\">4) <span class=\"string\">&quot;v41_2&quot;</span></span><br><span class=\"line\">5) <span class=\"string\">&quot;f3&quot;</span></span><br><span class=\"line\">6) <span class=\"string\">&quot;v41_3&quot;</span></span><br><span class=\"line\">127.0.0.1:6379&gt; HDEL k41 f1 f3 f4 </span><br><span class=\"line\">(<span class=\"built_in\">integer</span>) 2</span><br><span class=\"line\">127.0.0.1:6379&gt; HGETALL k41</span><br><span class=\"line\">1) <span class=\"string\">&quot;f2&quot;</span></span><br><span class=\"line\">2) <span class=\"string\">&quot;v41_2&quot;</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"hlen\"><a class=\"markdownIt-Anchor\" href=\"#hlen\">#</a>  <code>hlen</code></h3>\n<ul>\n<li>语法</li>\n</ul>\n<p><code>HLEN key</code></p>\n<ul>\n<li>解释</li>\n</ul>\n<p>返回哈希表  <code>key</code>  中域的数量。</p>\n<ul>\n<li>演示</li>\n</ul>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">127.0.0.1:6379&gt; HSET k42 f1 v42_1</span><br><span class=\"line\">(<span class=\"built_in\">integer</span>) 1</span><br><span class=\"line\">127.0.0.1:6379&gt; HSET k42 f2 v42_2</span><br><span class=\"line\">(<span class=\"built_in\">integer</span>) 1</span><br><span class=\"line\">127.0.0.1:6379&gt; HSET k42 f3 v42_3</span><br><span class=\"line\">(<span class=\"built_in\">integer</span>) 1</span><br><span class=\"line\">127.0.0.1:6379&gt; hlen k42</span><br><span class=\"line\">(<span class=\"built_in\">integer</span>) 3</span><br></pre></td></tr></table></figure>\n<h3 id=\"hstrlen\"><a class=\"markdownIt-Anchor\" href=\"#hstrlen\">#</a>  <code>hstrlen</code></h3>\n<ul>\n<li>语法</li>\n</ul>\n<p><code>HSTRLEN key field</code></p>\n<ul>\n<li>解释</li>\n</ul>\n<p>返回哈希表  <code>key</code>  中， 与给定域  <code>field</code>  相关联的值的字符串长度（ <code>string length</code> ）。</p>\n<p>如果给定的键或者域不存在， 那么命令返回  <code>0</code>  。</p>\n<ul>\n<li>演示</li>\n</ul>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">127.0.0.1:6379&gt; HSET k43 f1 <span class=\"string\">&quot;Hello World&quot;</span></span><br><span class=\"line\">(<span class=\"built_in\">integer</span>) 1</span><br><span class=\"line\">127.0.0.1:6379&gt; HSTRLEN k43 f1</span><br><span class=\"line\">(<span class=\"built_in\">integer</span>) 11</span><br><span class=\"line\">127.0.0.1:6379&gt; HSTRLEN k43 f2</span><br><span class=\"line\">(<span class=\"built_in\">integer</span>) 0</span><br></pre></td></tr></table></figure>\n<h3 id=\"hincrby\"><a class=\"markdownIt-Anchor\" href=\"#hincrby\">#</a> hincrby</h3>\n<ul>\n<li>语法</li>\n</ul>\n<p><code>HINCRBY key field increment</code></p>\n<ul>\n<li>解释</li>\n</ul>\n<p>为哈希表  <code>key</code>  中的域  <code>field</code>  的值加上增量  <code>increment</code>  。</p>\n<p>增量也可以为负数，相当于对给定域进行减法操作。</p>\n<p>如果  <code>key</code>  不存在，一个新的哈希表被创建并执行  <code>HINCRBY</code>  命令。</p>\n<p>如果域  <code>field</code>  不存在，那么在执行命令前，域的值被初始化为  <code>0</code>  。</p>\n<p>对一个储存字符串值的域  <code>field</code>  执行  <code>HINCRBY</code>  命令将造成一个错误。</p>\n<p>本操作的值被限制在  <code>64</code>  位 ( <code>bit</code> ) 有符号数字表示之内。</p>\n<ul>\n<li>演示</li>\n</ul>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 不存在的key与域 field</span></span><br><span class=\"line\">127.0.0.1:6379&gt; HINCRBY k45 f1 100</span><br><span class=\"line\">(<span class=\"built_in\">integer</span>) 100</span><br><span class=\"line\">127.0.0.1:6379&gt; HINCRBY k45 f1 -200</span><br><span class=\"line\">(<span class=\"built_in\">integer</span>) -100</span><br><span class=\"line\">127.0.0.1:6379&gt; HINCRBY k45 f1 200</span><br><span class=\"line\">(<span class=\"built_in\">integer</span>) 100</span><br><span class=\"line\"><span class=\"comment\"># 错误的类型</span></span><br><span class=\"line\">127.0.0.1:6379&gt; HSET k45 f2 v45</span><br><span class=\"line\">(<span class=\"built_in\">integer</span>) 1</span><br><span class=\"line\">127.0.0.1:6379&gt; HINCRBY k45 f2 100</span><br><span class=\"line\">(error) ERR <span class=\"built_in\">hash</span> value is not an <span class=\"built_in\">integer</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"hincrbyfloat\"><a class=\"markdownIt-Anchor\" href=\"#hincrbyfloat\">#</a>  <code>hincrbyfloat</code></h3>\n<ul>\n<li>语法</li>\n</ul>\n<p><code>HINCRBYFLOAT  key field increment</code></p>\n<ul>\n<li>解释</li>\n</ul>\n<p>为哈希表  <code>key</code>  中的域  <code>field</code>  加上浮点数增量  <code>increment</code>  。</p>\n<p>如果哈希表中没有域  <code>field</code>  ，那么  <code>HINCRBYFLOAT</code>  会先将域  <code>field</code>  的值设为  <code>0</code>  ，然后再执行加法操作。</p>\n<p>如果键  <code>key</code>  不存在，那么  <code>HINCRBYFLOAT</code>  会先创建一个哈希表，再创建域  <code>field</code>  ，最后再执行加法操作。</p>\n<ul>\n<li>演示</li>\n</ul>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">127.0.0.1:6379&gt; HINCRBYFLOAT  k46 f1 100.5</span><br><span class=\"line\"><span class=\"string\">&quot;100.5&quot;</span></span><br><span class=\"line\">127.0.0.1:6379&gt; HINCRBYFLOAT  k46 f1 100.5</span><br><span class=\"line\"><span class=\"string\">&quot;201&quot;</span></span><br><span class=\"line\">127.0.0.1:6379&gt; HINCRBYFLOAT  k46 f1 -100.5</span><br><span class=\"line\"><span class=\"string\">&quot;100.5&quot;</span></span><br><span class=\"line\">127.0.0.1:6379&gt; HSET k46 f2 v46_2</span><br><span class=\"line\">(<span class=\"built_in\">integer</span>) 1</span><br></pre></td></tr></table></figure>\n<h3 id=\"hmset\"><a class=\"markdownIt-Anchor\" href=\"#hmset\">#</a>  <code>hmset</code></h3>\n<ul>\n<li>语法</li>\n</ul>\n<p><code>HMSET key field value [field value ...]</code></p>\n<ul>\n<li>解释</li>\n</ul>\n<p>同时将多个  <code>field-value</code>  (域 - 值) 对设置到哈希表  <code>key</code>  中。</p>\n<p>此命令会覆盖哈希表中已存在的域。</p>\n<p>如果  <code>key</code>  不存在，一个空哈希表被创建并执行  <code>HMSET</code>  操作。</p>\n<ul>\n<li>演示</li>\n</ul>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">127.0.0.1:6379&gt; HMSET k47  f1 v47_1 f2 v47_2 f3 v47_3</span><br><span class=\"line\">OK</span><br><span class=\"line\">127.0.0.1:6379&gt; HGETALL k47</span><br><span class=\"line\">1) <span class=\"string\">&quot;f1&quot;</span></span><br><span class=\"line\">2) <span class=\"string\">&quot;v47_1&quot;</span></span><br><span class=\"line\">3) <span class=\"string\">&quot;f2&quot;</span></span><br><span class=\"line\">4) <span class=\"string\">&quot;v47_2&quot;</span></span><br><span class=\"line\">5) <span class=\"string\">&quot;f3&quot;</span></span><br><span class=\"line\">6) <span class=\"string\">&quot;v47_3&quot;</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"hmget\"><a class=\"markdownIt-Anchor\" href=\"#hmget\">#</a>  <code>hmget</code></h3>\n<ul>\n<li>语法</li>\n</ul>\n<p><code>HMGET key field [field ...]</code></p>\n<ul>\n<li>解释</li>\n</ul>\n<p>返回哈希表  <code>key</code>  中，一个或多个给定域的值。</p>\n<p>如果给定的域不存在于哈希表，那么返回一个  <code>nil</code>  值。</p>\n<p>因为不存在的  <code>key</code>  被当作一个空哈希表来处理，所以对一个不存在的  <code>key</code>  进行  <code>HMGET</code>  操作将返回一个只带有  <code>nil</code>  值的表。</p>\n<ul>\n<li>演示</li>\n</ul>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">127.0.0.1:6379&gt; HMSET k48 f1 v1 f2 v2 f3 v3 f4 v4</span><br><span class=\"line\">OK</span><br><span class=\"line\">127.0.0.1:6379&gt; hmget k48 f1 f3 f4</span><br><span class=\"line\">1) <span class=\"string\">&quot;v1&quot;</span></span><br><span class=\"line\">2) <span class=\"string\">&quot;v3&quot;</span></span><br><span class=\"line\">3) <span class=\"string\">&quot;v4&quot;</span></span><br><span class=\"line\">127.0.0.1:6379&gt; </span><br></pre></td></tr></table></figure>\n<h3 id=\"hkeys\"><a class=\"markdownIt-Anchor\" href=\"#hkeys\">#</a>  <code>hkeys</code></h3>\n<ul>\n<li>语法</li>\n</ul>\n<p><code>HKEYS key</code></p>\n<ul>\n<li>解释</li>\n</ul>\n<p>返回哈希表  <code>key</code>  中的所有域。</p>\n<p>当  <code>key</code>  不存在时，返回一个空表。</p>\n<ul>\n<li>演示</li>\n</ul>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">127.0.0.1:6379&gt; HMSET k49 f1 v1 f2 v2 f3 v3 f4 v4</span><br><span class=\"line\">OK</span><br><span class=\"line\">127.0.0.1:6379&gt; HKEYS k49</span><br><span class=\"line\">1) <span class=\"string\">&quot;f1&quot;</span></span><br><span class=\"line\">2) <span class=\"string\">&quot;f2&quot;</span></span><br><span class=\"line\">3) <span class=\"string\">&quot;f3&quot;</span></span><br><span class=\"line\">4) <span class=\"string\">&quot;f4&quot;</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"hvals\"><a class=\"markdownIt-Anchor\" href=\"#hvals\">#</a>  <code>hvals</code></h3>\n<ul>\n<li>语法</li>\n</ul>\n<p><code>HVALS key</code></p>\n<ul>\n<li>解释</li>\n</ul>\n<p>返回  <code>key</code>  对应的所有的 <code>value</code></p>\n<ul>\n<li>演示</li>\n</ul>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">127.0.0.1:6379&gt; HMSET k50 f1 v1 f2 v2 f3 v3 f4 v4 </span><br><span class=\"line\">OK</span><br><span class=\"line\">127.0.0.1:6379&gt; HVALS k50</span><br><span class=\"line\">1) <span class=\"string\">&quot;v1&quot;</span></span><br><span class=\"line\">2) <span class=\"string\">&quot;v2&quot;</span></span><br><span class=\"line\">3) <span class=\"string\">&quot;v3&quot;</span></span><br><span class=\"line\">4) <span class=\"string\">&quot;v4&quot;</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"hscan\"><a class=\"markdownIt-Anchor\" href=\"#hscan\">#</a>  <code>hscan</code></h3>\n<ul>\n<li>语法</li>\n</ul>\n<p><code>HSCAN key cursor [MATCH pattern] [COUNT count]</code></p>\n<ul>\n<li>解释</li>\n</ul>\n<p>这是一个查询命令。 同 SCAN 命令。可以参考这篇文章 <a href=\"./010-%E5%85%B6%E4%BB%96%E5%91%BD%E4%BB%A4.md\">010 - 其他命令</a></p>\n<p><code>SCAN</code>  命令是一个基于游标的迭代器（ <code>cursor based iterator</code> ）：  <code>SCAN</code>  命令每次被调用之后， 都会向用户返回一个新的游标， 用户在下次迭代时需要使用这个新游标作为  <code>SCAN</code>  命令的游标参数， 以此来延续之前的迭代过程。</p>\n<ul>\n<li>演示</li>\n</ul>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">127.0.0.1:6379&gt; HMSET k51  f1 v1 f2 v2 f3 v3 f4 v4 f5 v5 f6 v6 f7 v7 f8 v8</span><br><span class=\"line\">OK</span><br><span class=\"line\">127.0.0.1:6379&gt; hscan k51 0 </span><br><span class=\"line\">1) <span class=\"string\">&quot;0&quot;</span></span><br><span class=\"line\">2)  1) <span class=\"string\">&quot;f1&quot;</span></span><br><span class=\"line\">    2) <span class=\"string\">&quot;v1&quot;</span></span><br><span class=\"line\">    3) <span class=\"string\">&quot;f2&quot;</span></span><br><span class=\"line\">    4) <span class=\"string\">&quot;v2&quot;</span></span><br><span class=\"line\">    5) <span class=\"string\">&quot;f3&quot;</span></span><br><span class=\"line\">    6) <span class=\"string\">&quot;v3&quot;</span></span><br><span class=\"line\">    7) <span class=\"string\">&quot;f4&quot;</span></span><br><span class=\"line\">    8) <span class=\"string\">&quot;v4&quot;</span></span><br><span class=\"line\">    9) <span class=\"string\">&quot;f5&quot;</span></span><br><span class=\"line\">   10) <span class=\"string\">&quot;v5&quot;</span></span><br><span class=\"line\">   11) <span class=\"string\">&quot;f6&quot;</span></span><br><span class=\"line\">   12) <span class=\"string\">&quot;v6&quot;</span></span><br><span class=\"line\">   13) <span class=\"string\">&quot;f7&quot;</span></span><br><span class=\"line\">   14) <span class=\"string\">&quot;v7&quot;</span></span><br><span class=\"line\">   15) <span class=\"string\">&quot;f8&quot;</span></span><br><span class=\"line\">   16) <span class=\"string\">&quot;v8&quot;</span></span><br></pre></td></tr></table></figure>\n<p>以上，就是  <code>Redis</code>  中 <code>hash</code>  类型相关的 <code>15</code>  个命令了。务必熟记～</p>\n<h2 id=\"hash的内部结构\"><a class=\"markdownIt-Anchor\" href=\"#hash的内部结构\">#</a>  <code>hash</code>  的内部结构</h2>\n<p>在  <code>hash</code>  类型简介的时候，我们就说过  <code>hash</code>  是用两种数据结构来编码的。</p>\n<ul>\n<li>\n<p><code>ziplist</code></p>\n</li>\n<li>\n<p><code>hashtable</code> ( <code>dict</code> )</p>\n</li>\n</ul>\n<p><code>ziplist</code>  之前已经分享过了。具体参考之前的文章吧。 <a href=\"./06-Redis%E7%9A%84%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B%E4%B9%8Blist.md\">链接</a></p>\n<p>这里我们就简单的来看下  <code>hashtable</code> .</p>\n<p>我们直接搜索  <code>hash</code>  , 可以发现  <code>t_hash.c</code>  这个文件，引入了  <code>server.h</code>  . 大体看了一下，都是函数的实现。那我们看下  <code>server.h</code>  ，应该存在对  <code>hastable</code>  的定义吧。然而，并没有。</p>\n<p>那我们来看下 <code>t_hash.c</code>  中添加方法的实现吧.  <code>int hashTypeSet(robj *o, sds field, sds value, int flags)</code></p>\n<p>源码太长了，这里就不粘了， 可以看<span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRlZS5jb20vZmFuZ2ppYXhpYW9iYWkvcmVkaXMvYmxvYi9yZWRpczUuMF9jaGluZXNlX3RyYW5zbGF0ZS9zcmMvdF9oYXNoLmM=\">源码</span></p>\n<p>通过查看源码可以得出:</p>\n<ul>\n<li><code>hash</code>  类型的默认编码是  <code>OBJ_ZIPLIST</code> . 即默认是使用  <code>ziplist</code>  这种数据结构进行编码存储的。</li>\n</ul>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\">robj *<span class=\"title\">createHashObject</span><span class=\"params\">(<span class=\"keyword\">void</span>)</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">unsigned</span> <span class=\"keyword\">char</span> *zl = <span class=\"built_in\">ziplistNew</span>();</span><br><span class=\"line\">    robj *o = <span class=\"built_in\">createObject</span>(OBJ_HASH, zl);</span><br><span class=\"line\">    o-&gt;encoding = OBJ_ENCODING_ZIPLIST;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> o;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<ul>\n<li>当 <code>hash</code>  元素的个数大于  <code>hash_max_ziplist_entries</code>  时会，转换成  <code>hashTable</code> ( <code>OBJ_ENCODING_HT</code> ),</li>\n</ul>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">...</span><br><span class=\"line\"> <span class=\"keyword\">if</span> (<span class=\"built_in\">hashTypeLength</span>(o) &gt; server.hash_max_ziplist_entries)</span><br><span class=\"line\">            <span class=\"built_in\">hashTypeConvert</span>(o, OBJ_ENCODING_HT);</span><br><span class=\"line\">...</span><br></pre></td></tr></table></figure>\n<p>但是在  <code>redis 5.0.7</code>  中暂时不支持这种方式，还没有实现。(<b>没有实现从 <code>ziplist</code>  编码转化成 <code>hash</code>  编码。</b>)</p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">hashTypeConvert</span><span class=\"params\">(robj *o, <span class=\"keyword\">int</span> enc)</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (o-&gt;encoding == OBJ_ENCODING_ZIPLIST) &#123;</span><br><span class=\"line\">        <span class=\"built_in\">hashTypeConvertZiplist</span>(o, enc);</span><br><span class=\"line\">    &#125; </span><br><span class=\"line\">    <span class=\"comment\">/// 这里！！！</span></span><br><span class=\"line\">    <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (o-&gt;encoding == OBJ_ENCODING_HT) &#123;</span><br><span class=\"line\">        <span class=\"built_in\">serverPanic</span>(<span class=\"string\">&quot;Not implemented&quot;</span>);</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">        <span class=\"built_in\">serverPanic</span>(<span class=\"string\">&quot;Unknown hash encoding&quot;</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<ul>\n<li>当创建的 <code>hash</code>  类型是  <code>hashtable</code>  编码 ( <code>OBJ_ENCODING_HT</code> ) 时，是使用 <code>dict</code>  这种类型存储的.</li>\n</ul>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/// dict类型</span></span><br><span class=\"line\"><span class=\"keyword\">typedef</span> <span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">dict</span> &#123;</span></span><br><span class=\"line\">    dictType *type;</span><br><span class=\"line\">    <span class=\"keyword\">void</span> *privdata;</span><br><span class=\"line\">    <span class=\"comment\">/// 2个哈希表来实现</span></span><br><span class=\"line\">    dictht ht[<span class=\"number\">2</span>];</span><br><span class=\"line\">    <span class=\"keyword\">long</span> rehashidx; <span class=\"comment\">/* rehashing not in progress if rehashidx == -1 */</span></span><br><span class=\"line\">    <span class=\"keyword\">unsigned</span> <span class=\"keyword\">long</span> iterators; <span class=\"comment\">/* number of iterators currently running */</span></span><br><span class=\"line\">&#125; dict;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/// 哈希表实现</span></span><br><span class=\"line\"><span class=\"keyword\">typedef</span> <span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">dictht</span> &#123;</span></span><br><span class=\"line\">    dictEntry **table; <span class=\"comment\">/// 哈希表节点指针数据(java源码中的桶的概念)</span></span><br><span class=\"line\">    <span class=\"keyword\">unsigned</span> <span class=\"keyword\">long</span> size; <span class=\"comment\">/// 指针数组的大小</span></span><br><span class=\"line\">    <span class=\"keyword\">unsigned</span> <span class=\"keyword\">long</span> sizemask; <span class=\"comment\">/// 指针数据的长度掩码,用于计算索引值</span></span><br><span class=\"line\">    <span class=\"keyword\">unsigned</span> <span class=\"keyword\">long</span> used; <span class=\"comment\">/// 哈希表现有的节点数量</span></span><br><span class=\"line\">&#125; dictht;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">///哈希表的节点</span></span><br><span class=\"line\"><span class=\"keyword\">typedef</span> <span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">dictEntry</span> &#123;</span></span><br><span class=\"line\">    <span class=\"comment\">/// 键</span></span><br><span class=\"line\">    <span class=\"keyword\">void</span> *key;</span><br><span class=\"line\">    <span class=\"comment\">/// 值</span></span><br><span class=\"line\">    <span class=\"class\"><span class=\"keyword\">union</span> &#123;</span></span><br><span class=\"line\">        <span class=\"keyword\">void</span> *val;</span><br><span class=\"line\">        <span class=\"keyword\">uint64_t</span> u64;</span><br><span class=\"line\">        <span class=\"keyword\">int64_t</span> s64;</span><br><span class=\"line\">        <span class=\"keyword\">double</span> d;</span><br><span class=\"line\">    &#125; v;</span><br><span class=\"line\">    <span class=\"comment\">/// 下一个节点: dictht 是使用链地址法来处理hash冲突。</span></span><br><span class=\"line\">    <span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">dictEntry</span> *<span class=\"title\">next</span>;</span></span><br><span class=\"line\">&#125; dictEntry;</span><br></pre></td></tr></table></figure>\n<p>整个  <code>dict</code>  结构就可以这么表示:</p>\n<p><img data-src=\"/images/Redis%E7%B3%BB%E5%88%97/images/Redis-01-dict%E7%BB%93%E6%9E%84%E5%AD%98%E5%82%A8.png\" alt=\"Redis-01-dict结构存储\"></p>\n<p>到这里，我们就知道了  <code>hash</code>  这种类型，是如何存储的了。 如果你还想了解<br>\n <code>dict</code>  是如何  <code>rehash</code> , 扩容，缩容。以及  <code>dict api</code>  相关实现的话，移驾这篇文章吧。 <a href=\"./Redis%E4%B8%AD%E7%9A%84dict%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84.md\">起驾～</a></p>\n<h2 id=\"总结\"><a class=\"markdownIt-Anchor\" href=\"#总结\">#</a> 总结</h2>\n<ul>\n<li><code>hash</code>  结构，是一种哈希表结构。通过两种数据结构 <code>ziplist</code>  和  <code>hashtable</code> ( <code>dict</code> ) 实现。</li>\n<li>要熟练掌握的  <code>hash</code>  相关的 <code>15</code>  个命令。</li>\n<li><code>hashtable</code>  的编码格式，实际上就是使用的  <code>dict</code>  这种编码方式。我们简单的学习了 <code>Redis</code>  中 <code>dict</code>  结构的实现。还有一篇专门的文章，来介绍  <code>dict</code>  的详细内容。</li>\n</ul>\n<h2 id=\"最后\"><a class=\"markdownIt-Anchor\" href=\"#最后\">#</a> 最后</h2>\n<p>期望与你一起遇见更好的自己</p>\n<p><img data-src=\"/images/qrcode.jpg\" alt=\"期望与你一起遇见更好的自己\"></p>\n",
            "tags": [
                "Redis"
            ]
        },
        {
            "id": "https://fangjiaxiaobai.github.io/2021/08/01/Redis%E7%B3%BB%E5%88%97/B-2-Redis%E7%9A%84%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B%E4%B9%8Blist/",
            "url": "https://fangjiaxiaobai.github.io/2021/08/01/Redis%E7%B3%BB%E5%88%97/B-2-Redis%E7%9A%84%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B%E4%B9%8Blist/",
            "title": "Redis数据结构之 List",
            "date_published": "2021-08-01T07:08:55.000Z",
            "content_html": "<h2 id=\"书接上回\"><a class=\"markdownIt-Anchor\" href=\"#书接上回\">#</a> 书接上回</h2>\n<p>上一篇文章 <a href=\"/2021/08/01/Redis%E7%B3%BB%E5%88%97/B-1-Redis%E7%9A%84%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B%E4%B9%8BString/\">Redis 的数据结构 string</a> 我们一起学习了这种类型的常用命令，并且还学习了  <code>Redis</code>  中的字符串的结构表示以及好处，这里我们接着学习另外一种数据结构  <code>list</code> 。</p>\n<h2 id=\"list-简介\"><a class=\"markdownIt-Anchor\" href=\"#list-简介\">#</a>  <code>list</code>  简介</h2>\n<p><code>list</code> , 一般都会称为列表。在 <code>Redis</code>  中，这种数据结构是一种比较灵活的结构，由于其元素的是有序的，所以可以充当栈和队列这两种数据结构。实际在开发总也有很多应用场景。</p>\n<p>一个 <code>List</code>  最多可以包含  <code>2^32-1</code>  个元素。</p>\n<p>很多人都会以为 <code>list</code>  是用数组来实现的，非也，非也。它内部是 <code>quicklist</code>  这种数据结构。想要先睹为快的，那么坐<a href=\"##%60list%60%E5%86%85%E9%83%A8%E7%BB%93%E6%9E%84%E4%B9%8B%60quicklist%60\">电梯直达</a>吧。</p>\n<h2 id=\"list的相关命令\"><a class=\"markdownIt-Anchor\" href=\"#list的相关命令\">#</a>  <code>list</code>  的相关命令</h2>\n<h3 id=\"lpush命令\"><a class=\"markdownIt-Anchor\" href=\"#lpush命令\">#</a>  <code>LPUSH</code>  命令</h3>\n<ul>\n<li>语法</li>\n</ul>\n<p><code>LPUSH key value [value …]</code></p>\n<ul>\n<li>解释</li>\n</ul>\n<p><code>lpush</code>  :  <code>left push</code> 。</p>\n<p>将一个或者多个值插入到列表 <code>key</code>  的表头，返回列表的长度。元素可以是重复的。</p>\n<p>如果 <code>key</code>  不存在，那么会先穿件一个列表，然后再执行 <code>push</code>  操作.</p>\n<p>如果 <code>key</code>  值存在，但是 <code>value</code>  类型不是列表类型时，会返回一个错误。</p>\n<ul>\n<li>演示</li>\n</ul>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> 设置一个列表</span></span><br><span class=\"line\">127.0.0.1:6379&gt; LPUSH k22 v22</span><br><span class=\"line\">(integer) 1</span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> 查询指定区间内的数据,使用lrange命令</span></span><br><span class=\"line\">127.0.0.1:6379&gt; LRANGE k22 0 10</span><br><span class=\"line\">1) &quot;v22&quot;</span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> 一次插入多个值</span></span><br><span class=\"line\">127.0.0.1:6379&gt; LPUSH k22 v22_1 v22_2 v22_3 v22_4</span><br><span class=\"line\">(integer) 5</span><br><span class=\"line\">127.0.0.1:6379&gt; LRANGE k22 0 10</span><br><span class=\"line\">1) &quot;v22_4&quot;</span><br><span class=\"line\">2) &quot;v22_3&quot;</span><br><span class=\"line\">3) &quot;v22_2&quot;</span><br><span class=\"line\">4) &quot;v22_1&quot;</span><br><span class=\"line\">5) &quot;v22&quot;</span><br></pre></td></tr></table></figure>\n<h3 id=\"lpushx-命令\"><a class=\"markdownIt-Anchor\" href=\"#lpushx-命令\">#</a>  <code>lpushx</code>  命令</h3>\n<ul>\n<li>语法</li>\n</ul>\n<p><code>LPUSHX key value</code></p>\n<ul>\n<li>解释</li>\n</ul>\n<p>仅当  <code>key</code>  存在的时候，才将  <code>value</code>  插入列表的表头。返回列表中元素的个数。</p>\n<ul>\n<li>演示</li>\n</ul>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 当key值不存在的时候，不会放入列表中</span></span><br><span class=\"line\">127.0.0.1:6379&gt; LPUSHX k23 v23</span><br><span class=\"line\">(<span class=\"built_in\">integer</span>) 0</span><br><span class=\"line\"><span class=\"comment\"># 再次尝试放入，也不可以。</span></span><br><span class=\"line\">127.0.0.1:6379&gt; LPUSHX k23 v23</span><br><span class=\"line\">(<span class=\"built_in\">integer</span>) 0</span><br><span class=\"line\"><span class=\"comment\"># 先往数组放入一个元素</span></span><br><span class=\"line\">127.0.0.1:6379&gt; lpush k23 v23</span><br><span class=\"line\">(<span class=\"built_in\">integer</span>) 1</span><br><span class=\"line\"><span class=\"comment\"># 再次尝试使用lpushx放入数据</span></span><br><span class=\"line\">127.0.0.1:6379&gt; LPUSHX k23 v23_1</span><br><span class=\"line\">(<span class=\"built_in\">integer</span>) 2</span><br><span class=\"line\"><span class=\"comment\"># 再次尝试使用lpushx放入数据</span></span><br><span class=\"line\">127.0.0.1:6379&gt; LPUSHX k23 v23_2</span><br><span class=\"line\">(<span class=\"built_in\">integer</span>) 3</span><br><span class=\"line\"><span class=\"comment\"># 查看列表 k23 中的数据。注意：和插入的顺序是相反的。</span></span><br><span class=\"line\">127.0.0.1:6379&gt; Lrange k23 0 -1</span><br><span class=\"line\">1) <span class=\"string\">&quot;v23_2&quot;</span></span><br><span class=\"line\">2) <span class=\"string\">&quot;v23_1&quot;</span></span><br><span class=\"line\">3) <span class=\"string\">&quot;v23&quot;</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"rpush-命令\"><a class=\"markdownIt-Anchor\" href=\"#rpush-命令\">#</a>  <code>rpush</code>  命令</h3>\n<ul>\n<li>语法</li>\n</ul>\n<p><code>RPUSH key value [value ...]</code></p>\n<ul>\n<li>解释</li>\n</ul>\n<p><code>rpush</code>  就是 <code>right push</code> 。将一个或多个值  <code>value</code>  插入到列表  <code>key</code>  的表尾 (最右边)。返回列表的长度。</p>\n<p>如果  <code>key</code>  不存在的时候，会创建一个空列表，然后在执行  <code>rpush</code>  操作。</p>\n<p>如果  <code>key</code>  存在，但是不是一个列表类型时，返回一个错误。</p>\n<ul>\n<li>演示</li>\n</ul>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> 往列表中加入数据</span></span><br><span class=\"line\">127.0.0.1:6379&gt; RPUSH k24 v24</span><br><span class=\"line\">(integer) 1</span><br><span class=\"line\">127.0.0.1:6379&gt; RPUSH k24 v24_1 v25_2 v25_3</span><br><span class=\"line\">(integer) 4</span><br><span class=\"line\">127.0.0.1:6379&gt; lrange k24 0 -1</span><br><span class=\"line\">1) &quot;v24&quot;</span><br><span class=\"line\">2) &quot;v24_1&quot;</span><br><span class=\"line\">3) &quot;v25_2&quot;</span><br><span class=\"line\">4) &quot;v25_3&quot;</span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> 演示 key 存在，但是不是一个列表类型</span></span><br><span class=\"line\">127.0.0.1:6379&gt; set k24_1 v24_1</span><br><span class=\"line\">OK</span><br><span class=\"line\">127.0.0.1:6379&gt; rpush k24_1 v24_1</span><br><span class=\"line\">(error) WRONGTYPE Operation against a key holding the wrong kind of value</span><br></pre></td></tr></table></figure>\n<h3 id=\"rpushx-命令\"><a class=\"markdownIt-Anchor\" href=\"#rpushx-命令\">#</a>  <code>rpushx</code>  命令</h3>\n<ul>\n<li>语法</li>\n</ul>\n<p><code>rpushx key value</code></p>\n<ul>\n<li>解释</li>\n</ul>\n<p>与  <code>lpushx</code>  类似，如果 <code>key</code>  不存在时，什么都不会操作。如果 <code>key</code>  存在，才会将元素添加到表尾。</p>\n<ul>\n<li>演示</li>\n</ul>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> key不存在的时候，不会插入数据</span></span><br><span class=\"line\">127.0.0.1:6379&gt; rpushx k25 v25</span><br><span class=\"line\">(integer) 0</span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> 先设置一个列表</span></span><br><span class=\"line\">127.0.0.1:6379&gt; rpush k25 v25_1</span><br><span class=\"line\">(integer) 1</span><br><span class=\"line\">127.0.0.1:6379&gt; rpushx k25 v25_2</span><br><span class=\"line\">(integer) 2</span><br><span class=\"line\">127.0.0.1:6379&gt; rpushx k25 v25_3</span><br><span class=\"line\">(integer) 3</span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> 查看列表中的数据。注意和插入的顺序是一致的。</span></span><br><span class=\"line\">127.0.0.1:6379&gt; lrange k25 0 -1</span><br><span class=\"line\">1) &quot;v25_1&quot;</span><br><span class=\"line\">2) &quot;v25_2&quot;</span><br><span class=\"line\">3) &quot;v25_3&quot;</span><br></pre></td></tr></table></figure>\n<h3 id=\"lpop-命令\"><a class=\"markdownIt-Anchor\" href=\"#lpop-命令\">#</a>  <code>lpop</code>  命令</h3>\n<ul>\n<li>语法</li>\n</ul>\n<p><code>LPOP key</code></p>\n<ul>\n<li>解释</li>\n</ul>\n<p><code>left pop</code> ;</p>\n<p>移除并返回列表的头元素。当 <code>key</code>  不存在的时候，返回 <code>nil</code></p>\n<ul>\n<li>演示</li>\n</ul>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> key不存在的时候，返回nil</span></span><br><span class=\"line\">127.0.0.1:6379&gt; LPOP k26</span><br><span class=\"line\">(nil)</span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> 设置一个列表，有三个元素</span></span><br><span class=\"line\">127.0.0.1:6379&gt; lpush k26 v26_1 v26_2 v26_3</span><br><span class=\"line\">(integer) 3</span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> 查看列表中的元素</span></span><br><span class=\"line\">127.0.0.1:6379&gt; lrange k26 0 -1</span><br><span class=\"line\">1) &quot;v26_3&quot;</span><br><span class=\"line\">2) &quot;v26_2&quot;</span><br><span class=\"line\">3) &quot;v26_1&quot;</span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> 依次pop出元素</span></span><br><span class=\"line\">127.0.0.1:6379&gt; lpop k26</span><br><span class=\"line\">&quot;v26_3&quot;</span><br><span class=\"line\">127.0.0.1:6379&gt; lpop k26</span><br><span class=\"line\">&quot;v26_2&quot;</span><br><span class=\"line\">127.0.0.1:6379&gt; lpop k26</span><br><span class=\"line\">&quot;v26_1&quot;</span><br><span class=\"line\">127.0.0.1:6379&gt; lpop k26</span><br><span class=\"line\">(nil)</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>tip：  <code>lpush</code>  +  <code>lpop</code>  =&gt; 栈， <code>rpush</code>  +  <code>lpop</code>  =&gt; 队列。</p>\n</blockquote>\n<h3 id=\"rpop-命令\"><a class=\"markdownIt-Anchor\" href=\"#rpop-命令\">#</a>  <code>rpop</code>  命令</h3>\n<ul>\n<li>语法</li>\n</ul>\n<p><code>rpop key</code></p>\n<ul>\n<li>解释</li>\n</ul>\n<p><code>rpop</code>  ：  <code>right pop</code> ;</p>\n<p>和 lpop 相反。移除并返回列表的尾元素。如果 key 不存在返回 nil。</p>\n<ul>\n<li>演示</li>\n</ul>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># key 不存在，返回nil</span></span><br><span class=\"line\">127.0.0.1:6379&gt; rpop k27</span><br><span class=\"line\">(nil)</span><br><span class=\"line\"><span class=\"comment\"># 先设置一个列表</span></span><br><span class=\"line\">127.0.0.1:6379&gt; lpush k27 v27_1 v27_2 v27_3</span><br><span class=\"line\">(<span class=\"built_in\">integer</span>) 3</span><br><span class=\"line\">127.0.0.1:6379&gt; lrange k27 0 -1</span><br><span class=\"line\">1) <span class=\"string\">&quot;v27_3&quot;</span></span><br><span class=\"line\">2) <span class=\"string\">&quot;v27_2&quot;</span></span><br><span class=\"line\">3) <span class=\"string\">&quot;v27_1&quot;</span></span><br><span class=\"line\"><span class=\"comment\"># 一次pop每个值</span></span><br><span class=\"line\">127.0.0.1:6379&gt; rpop k27</span><br><span class=\"line\"><span class=\"string\">&quot;v27_1&quot;</span></span><br><span class=\"line\">127.0.0.1:6379&gt; rpop k27</span><br><span class=\"line\"><span class=\"string\">&quot;v27_2&quot;</span></span><br><span class=\"line\">127.0.0.1:6379&gt; rpop k27</span><br><span class=\"line\"><span class=\"string\">&quot;v27_3&quot;</span></span><br><span class=\"line\">127.0.0.1:6379&gt; rpop k27</span><br><span class=\"line\">(nil)</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>tip:  <code>lpush</code>  +  <code>rpop</code>  =&gt; 队列， <code>rpush</code>  +  <code>rpop</code>  =&gt; 栈。</p>\n</blockquote>\n<h3 id=\"lrange-命令\"><a class=\"markdownIt-Anchor\" href=\"#lrange-命令\">#</a>  <code>lrange</code>  命令</h3>\n<ul>\n<li>语法</li>\n</ul>\n<p><code>LRANGE key start stop</code></p>\n<ul>\n<li>解释</li>\n</ul>\n<p>获取指定区间内的元素。0 表示第一个元素。如果超过了实际范围就返回空数组。</p>\n<ul>\n<li>演示</li>\n</ul>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">127.0.0.1:6379&gt; LRANGE k22 0 10</span><br><span class=\"line\">1) <span class=\"string\">&quot;v22_4&quot;</span></span><br><span class=\"line\">2) <span class=\"string\">&quot;v22_3&quot;</span></span><br><span class=\"line\">3) <span class=\"string\">&quot;v22_2&quot;</span></span><br><span class=\"line\">4) <span class=\"string\">&quot;v22_1&quot;</span></span><br><span class=\"line\">5) <span class=\"string\">&quot;v22&quot;</span></span><br><span class=\"line\">127.0.0.1:6379&gt; LRANGE k22 0 1</span><br><span class=\"line\">1) <span class=\"string\">&quot;v22_4&quot;</span></span><br><span class=\"line\">2) <span class=\"string\">&quot;v22_3&quot;</span></span><br><span class=\"line\">127.0.0.1:6379&gt; LRANGE k22 10 100</span><br><span class=\"line\">(empty list or <span class=\"built_in\">set</span>)</span><br></pre></td></tr></table></figure>\n<h3 id=\"rpoplpush-命令\"><a class=\"markdownIt-Anchor\" href=\"#rpoplpush-命令\">#</a>  <code>rpoplpush</code>  命令</h3>\n<ul>\n<li>语法</li>\n</ul>\n<p><code>RPOPLPUSH source destination</code></p>\n<ul>\n<li>解释</li>\n</ul>\n<p>将  <code>source</code>  的尾元素插入到 <code>destination</code>  列表的头元素中，返回该元素。 注意，这是一个原子操作。</p>\n<p>比如:  <code>source</code> :  <code>a,b,c</code></p>\n<p><code>distination</code> :  <code>1,2,3</code></p>\n<p>使用  <code>RPOPLPUSH source distination</code>  , 则：</p>\n<p><code>source</code> :  <code>a,b</code></p>\n<p><code>distination</code> :  <code>c,1,2,3</code></p>\n<ul>\n<li>演示</li>\n</ul>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 设置列表1</span></span><br><span class=\"line\">127.0.0.1:6379&gt; lpush k28_1 v28_c v28_b v28_a</span><br><span class=\"line\">(<span class=\"built_in\">integer</span>) 3</span><br><span class=\"line\"><span class=\"comment\"># 设置列表2</span></span><br><span class=\"line\">127.0.0.1:6379&gt; lpush k28_2 v28_3 v28_2 v28_1</span><br><span class=\"line\">(<span class=\"built_in\">integer</span>) 3</span><br><span class=\"line\"><span class=\"comment\"># 使用 rpoppush命令</span></span><br><span class=\"line\">127.0.0.1:6379&gt; RPOPLPUSH k28_1 k28_2</span><br><span class=\"line\"><span class=\"string\">&quot;v28_c&quot;</span></span><br><span class=\"line\"><span class=\"comment\"># 查看列表1</span></span><br><span class=\"line\">127.0.0.1:6379&gt; lrange k28_1 0 -1</span><br><span class=\"line\">1) <span class=\"string\">&quot;v28_a&quot;</span></span><br><span class=\"line\">2) <span class=\"string\">&quot;v28_b&quot;</span></span><br><span class=\"line\"><span class=\"comment\"># 查看列表2</span></span><br><span class=\"line\">127.0.0.1:6379&gt; lrange k28_2 0 -1</span><br><span class=\"line\">1) <span class=\"string\">&quot;v28_c&quot;</span></span><br><span class=\"line\">2) <span class=\"string\">&quot;v28_1&quot;</span></span><br><span class=\"line\">3) <span class=\"string\">&quot;v28_2&quot;</span></span><br><span class=\"line\">4) <span class=\"string\">&quot;v28_3&quot;</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"lrem-命令\"><a class=\"markdownIt-Anchor\" href=\"#lrem-命令\">#</a>  <code>lrem</code>  命令</h3>\n<ul>\n<li>语法</li>\n</ul>\n<p><code>LREM key count value</code></p>\n<ul>\n<li>解释</li>\n</ul>\n<p>至多移除列表中  <code>count</code>  个与参数  <code>value</code>  相等的元素。</p>\n<p>有以下情況:</p>\n<p><code>count &gt; 0</code>  : 从表头开始向表尾搜索，移除与  <code>value</code>  相等的元素，最多移除 <code>count</code>  个 。</p>\n<p><code>count &lt; 0</code>  : 从表尾开始向表头搜索，移除与  <code>value</code>  相等的元素，最多移除 <code>|count|</code>  个。</p>\n<p><code>count = 0</code>  : 移除表中所有与  <code>value</code>  相等的值。</p>\n<ul>\n<li>演示</li>\n</ul>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> 演示 count&gt;0 时</span></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> 设置一个列表</span></span><br><span class=\"line\">127.0.0.1:6379&gt; lpush k29_1 v29_1  v29  v29_2 v29 v29_3 v29</span><br><span class=\"line\">(integer) 6</span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> 从表头开始，移除2个 v29</span></span><br><span class=\"line\">127.0.0.1:6379&gt; lrem k29_1 2 v29</span><br><span class=\"line\">(integer) 2</span><br><span class=\"line\">127.0.0.1:6379&gt; lrange k29_1 0 -1</span><br><span class=\"line\">1) &quot;v29_3&quot;</span><br><span class=\"line\">2) &quot;v29_2&quot;</span><br><span class=\"line\">3) &quot;v29&quot;</span><br><span class=\"line\">4) &quot;v29_1&quot;</span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> 演示count&lt;0 时</span></span><br><span class=\"line\">127.0.0.1:6379&gt; lpush k29_2 v29_1 v29  v29_2 v29 v29_3 v29</span><br><span class=\"line\">(integer) 6</span><br><span class=\"line\">127.0.0.1:6379&gt; lrem k29_2 -2 v29</span><br><span class=\"line\">(integer) 2</span><br><span class=\"line\">127.0.0.1:6379&gt; LRANGE k29_2 0 -1</span><br><span class=\"line\">1) &quot;v29&quot;</span><br><span class=\"line\">2) &quot;v29_3&quot;</span><br><span class=\"line\">3) &quot;v29_2&quot;</span><br><span class=\"line\">4) &quot;v29_1&quot;</span><br><span class=\"line\"><span class=\"meta\"></span></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> 演示count=0时</span></span><br><span class=\"line\">127.0.0.1:6379&gt; lpush k29_3 v29_1 v29  v29_2 v29 v29_3 v29</span><br><span class=\"line\">(integer) 6</span><br><span class=\"line\">127.0.0.1:6379&gt; lrem k29_3 0 v29</span><br><span class=\"line\">(integer) 3</span><br><span class=\"line\">127.0.0.1:6379&gt; LRANGE k29_3 0 -1</span><br><span class=\"line\">1) &quot;v29_3&quot;</span><br><span class=\"line\">2) &quot;v29_2&quot;</span><br><span class=\"line\">3) &quot;v29_1&quot;</span><br></pre></td></tr></table></figure>\n<h3 id=\"llen-命令\"><a class=\"markdownIt-Anchor\" href=\"#llen-命令\">#</a>  <code>llen</code>  命令</h3>\n<ul>\n<li>语法</li>\n</ul>\n<p><code>LLEN key</code></p>\n<ul>\n<li>解释</li>\n</ul>\n<p>获取列表的长度。</p>\n<p>如果  <code>key</code>  不存在的时候，返回 <code>0</code> .</p>\n<p>如果  <code>key</code>  对应类型不是  <code>list</code>  ，则返回一个错误。</p>\n<ul>\n<li>演示</li>\n</ul>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">127.0.0.1:6379&gt; llen k30</span><br><span class=\"line\">(<span class=\"built_in\">integer</span>) 0</span><br><span class=\"line\">127.0.0.1:6379&gt; lpush k30 v30_1 v30_2</span><br><span class=\"line\">(<span class=\"built_in\">integer</span>) 2</span><br><span class=\"line\">127.0.0.1:6379&gt; llen k30</span><br><span class=\"line\">(<span class=\"built_in\">integer</span>) 2</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 删掉k30，演示，类型不是list的时候，报错</span></span><br><span class=\"line\">127.0.0.1:6379&gt; del k30</span><br><span class=\"line\">(<span class=\"built_in\">integer</span>) 1</span><br><span class=\"line\">127.0.0.1:6379&gt; <span class=\"built_in\">set</span> k30 v30</span><br><span class=\"line\">OK</span><br><span class=\"line\">127.0.0.1:6379&gt; llen k30</span><br><span class=\"line\">(error) WRONGTYPE Operation against a key holding the wrong kind of value</span><br></pre></td></tr></table></figure>\n<h3 id=\"lindex-命令\"><a class=\"markdownIt-Anchor\" href=\"#lindex-命令\">#</a>  <code>lindex</code>  命令</h3>\n<ul>\n<li>语法</li>\n</ul>\n<p><code>lindex key index</code></p>\n<ul>\n<li>解释</li>\n</ul>\n<p>返回列表中，下标为  <code>index</code>  的元素.  <code>-1</code>  表示列表的最后一个元素，如果 <code>key</code>  不存在，或者 <code>index</code>  超出范围，返回 <code>nil</code> ， 如果 key 不是一个列表类型，返回一个错误。</p>\n<ul>\n<li>演示</li>\n</ul>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">127.0.0.1:6379&gt; lpush k31 v31_3 v31_2 v31_1</span><br><span class=\"line\">(integer) 3</span><br><span class=\"line\">127.0.0.1:6379&gt; LINDEX k31 2</span><br><span class=\"line\">&quot;v31_3&quot;</span><br><span class=\"line\">127.0.0.1:6379&gt; LINDEX k31 1</span><br><span class=\"line\">&quot;v31_2&quot;</span><br><span class=\"line\">127.0.0.1:6379&gt; LINDEX k31 0</span><br><span class=\"line\">&quot;v31_1&quot;</span><br></pre></td></tr></table></figure>\n<h3 id=\"linsert-命令\"><a class=\"markdownIt-Anchor\" href=\"#linsert-命令\">#</a>  <code>linsert</code>  命令</h3>\n<ul>\n<li>语法</li>\n</ul>\n<p><code>linsert key BEFORE|AFTER pivot value</code></p>\n<ul>\n<li>解释</li>\n</ul>\n<p>将 <code>value</code>  插入到 <code>key</code>  队列 <code>pivot</code>  值之前或者之后。返回插入完成之后列表的长度。</p>\n<p>如果  <code>pivot</code>  不存在 或者  <code>key</code>  不存在，不执行任何操作。</p>\n<p>如果  <code>key</code>  对应的不是一个列表类型，返回一个错误。</p>\n<ul>\n<li>演示</li>\n</ul>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">127.0.0.1:6379&gt; linsert k32 BEFORE k31_1 k31_0</span><br><span class=\"line\">(integer) 0</span><br><span class=\"line\">127.0.0.1:6379&gt; lpush k32 v32_1</span><br><span class=\"line\">(integer) 1</span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> k32_3 =&gt; pivot不存在</span></span><br><span class=\"line\">127.0.0.1:6379&gt; linsert k32 BEFORE v32_3 v31_2</span><br><span class=\"line\">(integer) -1</span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> pivot之前插入</span></span><br><span class=\"line\">127.0.0.1:6379&gt; linsert k32 BEFORE v32_1 v31_0</span><br><span class=\"line\">(integer) 2</span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> pivot之后插入</span></span><br><span class=\"line\">127.0.0.1:6379&gt; linsert k32 AFTER v32_1 v31_2</span><br><span class=\"line\">(integer) 3</span><br></pre></td></tr></table></figure>\n<h3 id=\"lset-命令\"><a class=\"markdownIt-Anchor\" href=\"#lset-命令\">#</a> lset 命令</h3>\n<ul>\n<li>语法</li>\n</ul>\n<p><code>lset key index value</code></p>\n<ul>\n<li>解释</li>\n</ul>\n<p>将列表中的 索引为 <code>index</code>  的值设置为 <code>value</code> 。 如果 <code>index</code>  超出范围，则返回一个错误</p>\n<ul>\n<li>演示</li>\n</ul>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">127.0.0.1:6379&gt; lpush k33 v33_3 v33_1</span><br><span class=\"line\">(<span class=\"built_in\">integer</span>) 2</span><br><span class=\"line\">127.0.0.1:6379&gt; lrange k33 0 -1</span><br><span class=\"line\">1) <span class=\"string\">&quot;v33_1&quot;</span></span><br><span class=\"line\">2) <span class=\"string\">&quot;v33_3&quot;</span></span><br><span class=\"line\"><span class=\"comment\">## 将第二个值，索引为1，设置为v33_2</span></span><br><span class=\"line\">127.0.0.1:6379&gt; lset k33 1 v33_2</span><br><span class=\"line\">OK</span><br><span class=\"line\">127.0.0.1:6379&gt; lrange k33 0 -1</span><br><span class=\"line\">1) <span class=\"string\">&quot;v33_1&quot;</span></span><br><span class=\"line\">2) <span class=\"string\">&quot;v33_2&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 超出范围返回错误</span></span><br><span class=\"line\">127.0.0.1:6379&gt; lset k33 2 v33_2</span><br><span class=\"line\">(error) ERR index out of range</span><br></pre></td></tr></table></figure>\n<h3 id=\"ltrim-命令\"><a class=\"markdownIt-Anchor\" href=\"#ltrim-命令\">#</a>  <code>ltrim</code>  命令</h3>\n<ul>\n<li>语法</li>\n</ul>\n<p><code>ltrim key start stop</code></p>\n<ul>\n<li>解释</li>\n</ul>\n<p>保留列表从 <code>start</code>  到 <code>stop</code>  之间的元素。其他元素都将被删除。 注意：包含 (不删除) <code>start</code>  和 <code>stop</code>  两个元素.</p>\n<p>如果 <code>key</code>  不存在，直接返回 <code>OK</code> , 如果 <code>key</code>  对应的不是列表，直接返回错误。</p>\n<ul>\n<li>演示</li>\n</ul>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">127.0.0.1:6379&gt; lpush k34 v34_1 v34_2 v34_3 v34_4 v34_5 v34_6</span><br><span class=\"line\">(<span class=\"built_in\">integer</span>) 6</span><br><span class=\"line\">127.0.0.1:6379&gt; ltrim k34 1 4</span><br><span class=\"line\">OK</span><br><span class=\"line\">127.0.0.1:6379&gt; lrange k34  0 -1</span><br><span class=\"line\">1) <span class=\"string\">&quot;v34_5&quot;</span></span><br><span class=\"line\">2) <span class=\"string\">&quot;v34_4&quot;</span></span><br><span class=\"line\">3) <span class=\"string\">&quot;v34_3&quot;</span></span><br><span class=\"line\">4) <span class=\"string\">&quot;v34_2&quot;</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"blpop-命令\"><a class=\"markdownIt-Anchor\" href=\"#blpop-命令\">#</a> blpop 命令</h3>\n<ul>\n<li>语法</li>\n</ul>\n<p><code>BLPOP key [key ...] timeout</code></p>\n<ul>\n<li>解释</li>\n</ul>\n<p><code>lpop</code>  的 阻塞版本。  <code>block left pop</code></p>\n<p>当给定列表内没有任何元素可供弹出的时候，连接将被 BLPOP 命令阻塞，直到等待超时或发现可弹出元素为止。<br>\n当给定多个 key 参数时，按参数 key 的先后顺序依次检查各个列表，弹出第一个非空列表的头元素。</p>\n<ul>\n<li>演示</li>\n</ul>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># push到三组列表，分别三个元素</span></span><br><span class=\"line\">127.0.0.1:6379&gt; lpush k35 v35_1 v35_2 v35_3</span><br><span class=\"line\">(<span class=\"built_in\">integer</span>) 3</span><br><span class=\"line\">127.0.0.1:6379&gt; lrange k35 0 -1</span><br><span class=\"line\">1) <span class=\"string\">&quot;v35_3&quot;</span></span><br><span class=\"line\">2) <span class=\"string\">&quot;v35_2&quot;</span></span><br><span class=\"line\">3) <span class=\"string\">&quot;v35_1&quot;</span></span><br><span class=\"line\">127.0.0.1:6379&gt; lpush k35_1 v35_1 v35_2 v35_3</span><br><span class=\"line\">(<span class=\"built_in\">integer</span>) 3</span><br><span class=\"line\">127.0.0.1:6379&gt; lpush k35_2 v35_1 v35_2 v35_3</span><br><span class=\"line\">(<span class=\"built_in\">integer</span>) 3</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 阻塞调用lpop, 从左到右 依次pop元素，直到有一个元素可以pop。</span></span><br><span class=\"line\">127.0.0.1:6379&gt; blpop k35 k35_1 k35_2 10</span><br><span class=\"line\">1) <span class=\"string\">&quot;k35&quot;</span></span><br><span class=\"line\">2) <span class=\"string\">&quot;v35_3&quot;</span></span><br><span class=\"line\">127.0.0.1:6379&gt; blpop k35 k35_1 k35_2 10</span><br><span class=\"line\">1) <span class=\"string\">&quot;k35&quot;</span></span><br><span class=\"line\">2) <span class=\"string\">&quot;v35_2&quot;</span></span><br><span class=\"line\">127.0.0.1:6379&gt; blpop k35 k35_1 k35_2 10</span><br><span class=\"line\">1) <span class=\"string\">&quot;k35&quot;</span></span><br><span class=\"line\">2) <span class=\"string\">&quot;v35_1&quot;</span></span><br><span class=\"line\">127.0.0.1:6379&gt; blpop k35 k35_1 k35_2 10</span><br><span class=\"line\">1) <span class=\"string\">&quot;k35_1&quot;</span></span><br><span class=\"line\">2) <span class=\"string\">&quot;v35_3&quot;</span></span><br><span class=\"line\">127.0.0.1:6379&gt; blpop k35 k35_1 k35_2 10</span><br><span class=\"line\">1) <span class=\"string\">&quot;k35_1&quot;</span></span><br><span class=\"line\">2) <span class=\"string\">&quot;v35_2&quot;</span></span><br><span class=\"line\">127.0.0.1:6379&gt; blpop k35 k35_1 k35_2 10</span><br><span class=\"line\">1) <span class=\"string\">&quot;k35_1&quot;</span></span><br><span class=\"line\">2) <span class=\"string\">&quot;v35_1&quot;</span></span><br><span class=\"line\">127.0.0.1:6379&gt; blpop k35 k35_1 k35_2 10</span><br><span class=\"line\">1) <span class=\"string\">&quot;k35_2&quot;</span></span><br><span class=\"line\">2) <span class=\"string\">&quot;v35_3&quot;</span></span><br><span class=\"line\">127.0.0.1:6379&gt; blpop k35 k35_1 k35_2 10</span><br><span class=\"line\">1) <span class=\"string\">&quot;k35_2&quot;</span></span><br><span class=\"line\">2) <span class=\"string\">&quot;v35_2&quot;</span></span><br><span class=\"line\">127.0.0.1:6379&gt; blpop k35 k35_1 k35_2 10</span><br><span class=\"line\">1) <span class=\"string\">&quot;k35_2&quot;</span></span><br><span class=\"line\">2) <span class=\"string\">&quot;v35_1&quot;</span></span><br><span class=\"line\">127.0.0.1:6379&gt; blpop k35 k35_1 k35_2 10</span><br><span class=\"line\"><span class=\"comment\"># 没有元素的时候会阻塞一直到超时。</span></span><br><span class=\"line\">(nil)</span><br><span class=\"line\">(10.59s)</span><br></pre></td></tr></table></figure>\n<h3 id=\"brpop-命令\"><a class=\"markdownIt-Anchor\" href=\"#brpop-命令\">#</a>  <code>brpop</code>  命令</h3>\n<ul>\n<li>语法</li>\n</ul>\n<p><code>BRPOP key [key ...] timeout</code></p>\n<ul>\n<li>解释</li>\n</ul>\n<p><code>rpop</code>  的阻塞版本。  <code>block right pop</code> <br>\n 当给定多个 <code>key</code>  的时候，按照 <code>key</code>  的先后顺序依次检查各个列表。直到弹出一个元素或者超时。</p>\n<ul>\n<li>演示</li>\n</ul>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 设置两个列表</span></span><br><span class=\"line\">127.0.0.1:6379&gt; lpush k36 v36_1 v36_2 v36_3</span><br><span class=\"line\">(<span class=\"built_in\">integer</span>) 3</span><br><span class=\"line\">127.0.0.1:6379&gt; lpush k36_1 v36_1 v36_2 v36_3</span><br><span class=\"line\">(<span class=\"built_in\">integer</span>) 3</span><br><span class=\"line\"><span class=\"comment\"># 阻塞式的pop出每个值。</span></span><br><span class=\"line\">127.0.0.1:6379&gt; BRPOP k36 k36_1 10</span><br><span class=\"line\">1) <span class=\"string\">&quot;k36&quot;</span></span><br><span class=\"line\">2) <span class=\"string\">&quot;v36_1&quot;</span></span><br><span class=\"line\">127.0.0.1:6379&gt; BRPOP k36 k36_1 10</span><br><span class=\"line\">1) <span class=\"string\">&quot;k36&quot;</span></span><br><span class=\"line\">2) <span class=\"string\">&quot;v36_2&quot;</span></span><br><span class=\"line\">127.0.0.1:6379&gt; BRPOP k36 k36_1 10</span><br><span class=\"line\">1) <span class=\"string\">&quot;k36&quot;</span></span><br><span class=\"line\">2) <span class=\"string\">&quot;v36_3&quot;</span></span><br><span class=\"line\">127.0.0.1:6379&gt; BRPOP k36 k36_1 10</span><br><span class=\"line\">1) <span class=\"string\">&quot;k36_1&quot;</span></span><br><span class=\"line\">2) <span class=\"string\">&quot;v36_1&quot;</span></span><br><span class=\"line\">127.0.0.1:6379&gt; BRPOP k36 k36_1 10</span><br><span class=\"line\">1) <span class=\"string\">&quot;k36_1&quot;</span></span><br><span class=\"line\">2) <span class=\"string\">&quot;v36_2&quot;</span></span><br><span class=\"line\">127.0.0.1:6379&gt; BRPOP k36 k36_1 10</span><br><span class=\"line\">1) <span class=\"string\">&quot;k36_1&quot;</span></span><br><span class=\"line\">2) <span class=\"string\">&quot;v36_3&quot;</span></span><br><span class=\"line\">127.0.0.1:6379&gt; BRPOP k36 k36_1 10</span><br><span class=\"line\"><span class=\"comment\"># 阻塞10s</span></span><br><span class=\"line\">(nil)</span><br><span class=\"line\">(10.61s)</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>Tips:  <code>lpush</code>  +  <code>brpop</code>  =&gt; 阻塞队列。</p>\n</blockquote>\n<h3 id=\"brpoplpush-命令\"><a class=\"markdownIt-Anchor\" href=\"#brpoplpush-命令\">#</a>  <code>brpoplpush</code>  命令</h3>\n<ul>\n<li>语法</li>\n</ul>\n<p><code>BRPOPLPUSH source destination timeout</code></p>\n<ul>\n<li>解释</li>\n</ul>\n<p><code>rpoplpush</code>  的阻塞版本。  <code>block right left push</code> 。</p>\n<p>当列表  <code>source</code>  为空的时候，该命令将阻塞，直到超时，或者 source 中有一个元素可以 pop。</p>\n<ul>\n<li>演示</li>\n</ul>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 设置一个列表</span></span><br><span class=\"line\">127.0.0.1:6379&gt; lpush k37_source v37_1 v37_2 v37_3 v37_4</span><br><span class=\"line\">(<span class=\"built_in\">integer</span>) 4</span><br><span class=\"line\"><span class=\"comment\"># 将source移动到distination中。</span></span><br><span class=\"line\">127.0.0.1:6379&gt; BRPOPLPUSH k37_source k37_distination 10</span><br><span class=\"line\"><span class=\"string\">&quot;v37_1&quot;</span></span><br><span class=\"line\"><span class=\"comment\"># 查看下distination。</span></span><br><span class=\"line\">127.0.0.1:6379&gt; lrange k37_distination 0 -1</span><br><span class=\"line\">1) <span class=\"string\">&quot;v37_1&quot;</span></span><br><span class=\"line\">127.0.0.1:6379&gt; BRPOPLPUSH k37_source k37_distination 10</span><br><span class=\"line\"><span class=\"string\">&quot;v37_2&quot;</span></span><br><span class=\"line\">127.0.0.1:6379&gt; BRPOPLPUSH k37_source k37_distination 10</span><br><span class=\"line\"><span class=\"string\">&quot;v37_3&quot;</span></span><br><span class=\"line\">127.0.0.1:6379&gt; BRPOPLPUSH k37_source k37_distination 10</span><br><span class=\"line\"><span class=\"string\">&quot;v37_4&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 这时我们启动两个客户端,演示阻塞直到另一个客户端执行source列表中的插入操作。</span></span><br><span class=\"line\"><span class=\"comment\"># 客户端1中继续执行 BRPOPLPUSH, 然后马上在客户端2中，输入&quot;LPUSH k37_source v37_5&quot;.</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 客户端1</span></span><br><span class=\"line\">127.0.0.1:6379&gt; BRPOPLPUSH k37_source k37_distination 10</span><br><span class=\"line\"><span class=\"string\">&quot;v37_5&quot;</span></span><br><span class=\"line\">(3.02s)</span><br><span class=\"line\"><span class=\"comment\"># 客户端2</span></span><br><span class=\"line\">127.0.0.1:6379&gt; LPUSH k37_source v37_5</span><br><span class=\"line\">(<span class=\"built_in\">integer</span>) 1</span><br></pre></td></tr></table></figure>\n<h2 id=\"list内部结构之quicklist\"><a class=\"markdownIt-Anchor\" href=\"#list内部结构之quicklist\">#</a>  <code>list</code>  内部结构之 <code>quicklist</code></h2>\n<h3 id=\"quicklist\"><a class=\"markdownIt-Anchor\" href=\"#quicklist\">#</a>  <code>quicklist</code></h3>\n<p>我们来看一下 <code>list</code>  的内部实现  <code>quicklist</code>  结构.</p>\n<p>特别注明：  <code>quicklist</code>  是双向的链表结构。</p>\n<p>在 <code>Redis</code>  中使用如下结构体表示.</p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">typedef</span> <span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">quicklist</span> &#123;</span></span><br><span class=\"line\">    <span class=\"comment\">// 头结点</span></span><br><span class=\"line\">    quicklistNode *head;</span><br><span class=\"line\">    <span class=\"comment\">// 尾结点</span></span><br><span class=\"line\">    quicklistNode *tail;</span><br><span class=\"line\">    <span class=\"comment\">// 列表的元素个数</span></span><br><span class=\"line\">    <span class=\"keyword\">unsigned</span> <span class=\"keyword\">long</span> count;</span><br><span class=\"line\">    <span class=\"comment\">// 链表的长度</span></span><br><span class=\"line\">    <span class=\"keyword\">unsigned</span> <span class=\"keyword\">long</span> len;</span><br><span class=\"line\">    <span class=\"comment\">// 单个节点的填充因子</span></span><br><span class=\"line\">    <span class=\"keyword\">int</span> fill : <span class=\"number\">16</span>;</span><br><span class=\"line\">    <span class=\"comment\">// 不进行节点压缩的最大深度</span></span><br><span class=\"line\">    <span class=\"comment\">// 超过这个节点就会进行节点压缩</span></span><br><span class=\"line\">    <span class=\"keyword\">unsigned</span> <span class=\"keyword\">int</span> compress : <span class=\"number\">16</span>;</span><br><span class=\"line\">&#125; quicklist;</span><br></pre></td></tr></table></figure>\n<p><code>quicklist</code>  是回一个通用的双向链接快速列表实现。它的每个节点用  <code>quicklistNode</code>  表示。</p>\n<p>一起来看下  <code>qucklistNode</code>  是什么吧。</p>\n<h3 id=\"quicklistnode\"><a class=\"markdownIt-Anchor\" href=\"#quicklistnode\">#</a>  <code>quicklistNode</code></h3>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">typedef</span> <span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">quicklistNode</span> &#123;</span></span><br><span class=\"line\">    <span class=\"comment\">// 前一个节点</span></span><br><span class=\"line\">    <span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">quicklistNode</span> *<span class=\"title\">prev</span>;</span></span><br><span class=\"line\">    <span class=\"comment\">// 后一个节点</span></span><br><span class=\"line\">    <span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">quicklistNode</span> *<span class=\"title\">next</span>;</span></span><br><span class=\"line\">    <span class=\"comment\">// 数据指针。</span></span><br><span class=\"line\">    <span class=\"comment\">// 如果指向的数据没有被压缩,那么会指向zipList结构。</span></span><br><span class=\"line\">    <span class=\"comment\">// 如果进行了压缩，那么会指向 quickLZF结构。</span></span><br><span class=\"line\">    <span class=\"keyword\">unsigned</span> <span class=\"keyword\">char</span> *zl;</span><br><span class=\"line\">    <span class=\"comment\">// 当前节点的大小</span></span><br><span class=\"line\">    <span class=\"keyword\">unsigned</span> <span class=\"keyword\">int</span> sz;</span><br><span class=\"line\">    <span class=\"comment\">// 元素的个数</span></span><br><span class=\"line\">    <span class=\"keyword\">unsigned</span> <span class=\"keyword\">int</span> count : <span class=\"number\">16</span>;</span><br><span class=\"line\">    <span class=\"comment\">// 编码方式，1=RAW，2=LZF</span></span><br><span class=\"line\">    <span class=\"comment\">// 1 表示未被压缩</span></span><br><span class=\"line\">    <span class=\"comment\">// 2 表示使用LZF结构进行的压缩</span></span><br><span class=\"line\">    <span class=\"keyword\">unsigned</span> <span class=\"keyword\">int</span> encoding : <span class=\"number\">2</span>;   </span><br><span class=\"line\">    <span class=\"comment\">// 使用的容器是什么？1=NONE,2=ZIPLIST</span></span><br><span class=\"line\">    <span class=\"keyword\">unsigned</span> <span class=\"keyword\">int</span> container : <span class=\"number\">2</span>;</span><br><span class=\"line\">    <span class=\"comment\">// 前一个节点是否被压缩</span></span><br><span class=\"line\">    <span class=\"keyword\">unsigned</span> <span class=\"keyword\">int</span> recompress : <span class=\"number\">1</span>; </span><br><span class=\"line\">    <span class=\"comment\">// 是否压缩</span></span><br><span class=\"line\">    <span class=\"keyword\">unsigned</span> <span class=\"keyword\">int</span> attempted_compress : <span class=\"number\">1</span>; </span><br><span class=\"line\">    <span class=\"comment\">// 暂时留出来，以后使用。</span></span><br><span class=\"line\">    <span class=\"keyword\">unsigned</span> <span class=\"keyword\">int</span> extra : <span class=\"number\">10</span>;</span><br><span class=\"line\">&#125; quicklistNode;</span><br></pre></td></tr></table></figure>\n<p><code>quicklistNode</code>  是一个 <code>32byte</code>  的结构体，用于描述一个 <code>quicklist</code>  的一个节点。从代码中可看出，使用了位图来节约空间。在上面的代码中我们还提到两种数据结构，对应的是代码中  <code>zl</code>  指针，指向的位置，如果数据被压缩，指向 <code>quicklistLZF</code>  和 没有数据没有被压缩就是指向  <code>ziplist</code> .</p>\n<h3 id=\"ziplist\"><a class=\"markdownIt-Anchor\" href=\"#ziplist\">#</a>  <code>ziplist</code></h3>\n<p><code>ziplist</code>  这种结构比较复杂，而且在源码中也没有给出明确定义。那  <code>ziplist</code>  这么神秘的结构到底是什么样的呢？</p>\n<p>别着急，我们先大体熟悉下 <code>ziplist</code>  这种结构的设计意图。</p>\n<p><code>ziplist</code>  是一个经过特殊编码的双向链表，它的设计意图就是 提高存储效率，  <code>ziplist</code>  可以用于存储字符串或者整数，其中整数是按照真正的二进制进行编码的。 它能以 <code>O(1)</code>  的效率在表的两端进行 <code>pop</code>  和 <code>push</code>  操作。</p>\n<p>我们都知道，普通的链表每项都是一块独立的内存空间，各项之间都是通过指针连接起来的。这种方式，会带来大量的空间碎片，指针引用也会占用部分空间内存。所以 <code>ziplist</code>  是将表中每项放在连续的空间内存中 (类似数组)， <code>ziplist</code>  还对值采取了一个可变长度的存储方式，大的值就用大空间，小的值就用小空间。</p>\n<h4 id=\"ziplist结构的官方定义\"><a class=\"markdownIt-Anchor\" href=\"#ziplist结构的官方定义\">#</a> ziplist 结构的官方定义。</h4>\n<blockquote>\n<p>The general layout of the ziplist is as follows:<br>\n <code>&lt;zlbytes&gt; &lt;zltail&gt; &lt;zllen&gt; &lt;entry&gt; &lt;entry&gt; ... &lt;entry&gt; &lt;zlend&gt;</code> <br>\n <code>&lt;uint32_t zlbytes&gt;</code>  is an unsigned integer to hold the number of bytes that  the ziplist occupies, including the four bytes of the zlbytes field itself.  This value needs to be stored to be able to resize the entire structure  without the need to traverse it first.<br>\n <code>&lt;uint32_t zltail&gt;</code>  is the offset to the last entry in the list. This allows  a pop operation on the far side of the list without the need for full  traversal.<br>\n <code>&lt;uint16_t zllen&gt;</code>  is the number of entries. When there are more than  2^16-2 entries, this value is set to 2^16-1 and we need to traverse the entire list to know how many items it holds.<br>\n <code>&lt;uint8_t zlend&gt;</code>  is a special entry representing the end of the ziplist. Is encoded as a single byte equal to 255. No other normal entry starts with a byte set to the value of 255.</p>\n</blockquote>\n<p>根据上面中解释我们可以得出以下这种模型：</p>\n<p><img data-src=\"./images/ziplist-01-Ziplist%E7%9A%84%E7%BB%93%E6%9E%84.png\" alt=\"\"></p>\n<p>如果没有特殊指定的话，都是采用小尾数法存储的。</p>\n<ul>\n<li>\n<p><code>zlbytes</code> : 存储一个无符号整数，用于存储 ziplist 的所用的字节数，(包括 zlbytes 字段本身的四个字节)，当重新分配内容的时候，不需要遍历整个列表来计算内存大小。</p>\n</li>\n<li>\n<p><code>zltail</code> : 一个无符号整数，表示 ziplist 中最后一个元素的偏移字节数，这样可以方便的找到最后一个元素，从而可以以 O (1) 的复杂度在尾端进行 pop 和 push。</p>\n</li>\n<li>\n<p><code>zllen：压缩列表包含的结点的个数，即entry的个数。</code> <br>\n这里的 <code>zllen</code>  是占用 <code>16bit</code> , 也就是说最多存储  <code>2^16-2</code>  个。但是 <code>ziplist</code>  超了 <code>2^16-2</code>  个也是可以表示的。那种情况就是 <code>16</code>  个 <code>1</code>  的时候，只需要从头遍历到尾就好了。</p>\n</li>\n<li>\n<p><code>entry</code> : 真正存放数据的数据项，每个数据项都有自己的内部结构。</p>\n</li>\n<li>\n<p><code>zlend</code> :  <code>ziplist</code>  的最后一个字节，值固定等于 <code>255</code> ，就是一个结束标记。</p>\n</li>\n</ul>\n<h4 id=\"entry-结构\"><a class=\"markdownIt-Anchor\" href=\"#entry-结构\">#</a> entry 结构</h4>\n<p><code>entry</code>  是由三部分构成的。</p>\n<ul>\n<li>\n<p><code>previous length（pre_entry_length）</code> ： 表示前一个数据节点占用的总字节数，这个字段的用处是为了让 ziplist 能够从后向前遍历（从后一项的位置，只需向前偏移 <code>previous length</code>  个字节，就找到了前一项）。这个字段采用变长编码。</p>\n</li>\n<li>\n<p><code>encoding</code> （ <code>encoding&amp;cur_entry_length</code> ）：表示当前数据节点 content 的内容类型以及长度。也采用变长编码。</p>\n</li>\n<li>\n<p><code>entry-data</code> ：表示当前节点存储的数据， <code>entry-data</code>  的内容类型有整数类型和字节数组类型，且某些条件下 <code>entry-data</code>  的长度可能为 <code>0</code> 。</p>\n</li>\n</ul>\n<p>所以我们可以得出  <code>ziplist</code>  是一个这样的结构。</p>\n<p><img data-src=\"./images/ziplist-01-entry%E7%9A%84%E7%BB%93%E6%9E%84.png\" alt=\"\"></p>\n<p>有时，encoding 也可以代表 entry 本身，就像小整数一样。</p>\n<p><img data-src=\"./images/ziplist-01-entry%E7%9A%84%E7%BB%93%E6%9E%842.png\" alt=\"\"></p>\n<p>这里就是大体的了解下 ziplist 这种数据结构。</p>\n<blockquote>\n<p>这里是一篇关于 <a href=\"./10-Redis%E7%9A%84%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B9%8Bziplist.md\">ziplist</a> 详细解读的文章。</p>\n</blockquote>\n<h3 id=\"quicklistlzf\"><a class=\"markdownIt-Anchor\" href=\"#quicklistlzf\">#</a>  <code>quicklistLZF</code></h3>\n<p>看完了比较神秘的 <code>ziplist</code>  结构，我们来看一个比较简单的 <code>quicklist</code>  的压缩节点的结构  <code>quicklistLZF</code> 。</p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * quicklistLZF是一个4 + N字节的 struct。</span></span><br><span class=\"line\"><span class=\"comment\"> * sz 是 compressed 字段的字节长度。&#x27;compressed&#x27; 是长度为 sz的 LZF数据。</span></span><br><span class=\"line\"><span class=\"comment\"> *</span></span><br><span class=\"line\"><span class=\"comment\"> * 未被压缩的长度保存到 quicklistNode-&gt;sz中。</span></span><br><span class=\"line\"><span class=\"comment\"> *</span></span><br><span class=\"line\"><span class=\"comment\"> * 当压缩了quicklistNode-&gt;zl时，quicklistNode-&gt;zl指向的是一个 quicklistLZF类型的数据。</span></span><br><span class=\"line\"><span class=\"comment\"> * 未压缩的时候，指向的是ziplist.</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"keyword\">typedef</span> <span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">quicklistLZF</span> &#123;</span></span><br><span class=\"line\">    <span class=\"comment\">///compressed数组长度 </span></span><br><span class=\"line\">    <span class=\"keyword\">unsigned</span> <span class=\"keyword\">int</span> sz; </span><br><span class=\"line\">    <span class=\"keyword\">char</span> compressed[];</span><br><span class=\"line\">&#125; quicklistLZF;</span><br></pre></td></tr></table></figure>\n<h2 id=\"总结\"><a class=\"markdownIt-Anchor\" href=\"#总结\">#</a> 总结</h2>\n<ul>\n<li><code>list</code>  相关的命令。以及常见的应用场景。比如栈和队列等等。</li>\n<li><code>list</code>  其实是一种链表结构，但是不是一个普通的链表结构。</li>\n<li><code>list</code>  是由  <code>quicklist</code>  这种数据结构实现的。 <code>quicklist</code>  中的每个节点是 <code>quicklistNode</code> , 而 <code>quicklist</code>  中 <code>zl</code>  指针，指向的是 一个 <code>ziplist</code>  或者 <code>quickListLZF</code> 。</li>\n<li><code>ziplist</code>  是一个比较神秘的数据结构，有 <code>5</code>  部分构成，是连续存储的，可以实现 <code>O(1)</code>  的尾端 <code>pop</code>  和 <code>push</code>  操作。</li>\n</ul>\n<h2 id=\"最后\"><a class=\"markdownIt-Anchor\" href=\"#最后\">#</a> 最后</h2>\n<p>期望与你一起遇见更好的自己</p>\n<p><img data-src=\"/images/qrcode.jpg\" alt=\"期望与你一起遇见更好的自己\"></p>\n",
            "tags": [
                "Redis"
            ]
        },
        {
            "id": "https://fangjiaxiaobai.github.io/2021/08/01/Redis%E7%B3%BB%E5%88%97/B-1-Redis%E7%9A%84%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B%E4%B9%8BString/",
            "url": "https://fangjiaxiaobai.github.io/2021/08/01/Redis%E7%B3%BB%E5%88%97/B-1-Redis%E7%9A%84%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B%E4%B9%8BString/",
            "title": "Redis数据结构之 String",
            "date_published": "2021-08-01T06:58:55.000Z",
            "content_html": "<p>今天来聊聊  <code>Redis</code>  的 <code>string</code> ，这一数据结构。</p>\n<h3 id=\"string简介\"><a class=\"markdownIt-Anchor\" href=\"#string简介\">#</a>  <code>string</code>  简介</h3>\n<p><code>string</code>  是 <code>Redis</code>  中最基本，也是最简单的数据结构。一个键 ( <code>key</code> ) 对应着一个 <code>string</code>  类型的值 ( <code>value</code> ). 我们都知道 <code>redis</code>  是使用 <code>C</code>  语言来编写的，但是  <code>string</code>  这一个数据结构并非是使用 <code>C</code>  语言的  <code>string(char[])</code>  来实现的，要想先了解，那就做电梯吧 -&gt;( <a href=\"#%60Redis%60%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E8%BF%99%E4%B8%80%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84\">电梯直达</a> ).</p>\n<p>现在，先暂且抛开内部实现，我们先看看有怎么使用这一数据结构。</p>\n<h3 id=\"string相关常用命令\"><a class=\"markdownIt-Anchor\" href=\"#string相关常用命令\">#</a>  <code>string</code>  相关常用命令</h3>\n<h4 id=\"set命令\"><a class=\"markdownIt-Anchor\" href=\"#set命令\">#</a>  <code>set</code>  命令</h4>\n<p><code>SET key value [expiration EX seconds|PX milliseconds] [NX|XX]</code></p>\n<p>使用示例:</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 1.设置一个键值对 f1=&gt;f1</span></span><br><span class=\"line\">127.0.0.1:6379&gt; <span class=\"built_in\">set</span> k1 v1</span><br><span class=\"line\">OK</span><br><span class=\"line\"><span class=\"comment\"># 根据键查询值</span></span><br><span class=\"line\">127.0.0.1:6379&gt; get k1</span><br><span class=\"line\"><span class=\"string\">&quot;v1&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 2.设置一个键值对(f2=&gt;f2),设置超时时间为10s</span></span><br><span class=\"line\"><span class=\"comment\"># EX 表示秒</span></span><br><span class=\"line\">127.0.0.1:6379&gt; <span class=\"built_in\">set</span> k2 v2 EX 10</span><br><span class=\"line\">OK</span><br><span class=\"line\">127.0.0.1:6379&gt; get k2</span><br><span class=\"line\"><span class=\"string\">&quot;v2&quot;</span></span><br><span class=\"line\"><span class=\"comment\"># 等待10s之后去查询f2</span></span><br><span class=\"line\">127.0.0.1:6379&gt; get k2</span><br><span class=\"line\">(nil)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 3.设置一个键值对(f3=&gt;f3),设置超时时间为 10000毫秒</span></span><br><span class=\"line\"><span class=\"comment\"># PX 表示为毫秒</span></span><br><span class=\"line\">127.0.0.1:6379&gt; <span class=\"built_in\">set</span> k3 v3 PX 10000</span><br><span class=\"line\">OK</span><br><span class=\"line\">127.0.0.1:6379&gt; get k3</span><br><span class=\"line\"><span class=\"string\">&quot;v3&quot;</span></span><br><span class=\"line\">127.0.0.1:6379&gt; get k3</span><br><span class=\"line\">(nil)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 4.设置键值对k4=&gt;v4,验证&quot;存在相同的key就设置失败&quot;</span></span><br><span class=\"line\"><span class=\"comment\"># setnx 命令也可实现,注意返回值。</span></span><br><span class=\"line\">127.0.0.1:6379&gt; <span class=\"built_in\">set</span> k4 v4 NX</span><br><span class=\"line\">OK</span><br><span class=\"line\"><span class=\"comment\"># 如果存在相同的key就设置失败(与下面的注意对比)</span></span><br><span class=\"line\">127.0.0.1:6379&gt; <span class=\"built_in\">set</span> k4 v4 NX</span><br><span class=\"line\">(nil)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 5.验证&quot;不存在相同的key就设置失败&quot;</span></span><br><span class=\"line\">127.0.0.1:6379&gt; <span class=\"built_in\">set</span> k5 v5 XX</span><br><span class=\"line\">(nil)</span><br><span class=\"line\"><span class=\"comment\"># 先设置一个键值对,</span></span><br><span class=\"line\">127.0.0.1:6379&gt; <span class=\"built_in\">set</span> k5 v5 </span><br><span class=\"line\">OK</span><br><span class=\"line\"><span class=\"comment\"># 设置不存在相同的key就设置失败</span></span><br><span class=\"line\">127.0.0.1:6379&gt; <span class=\"built_in\">set</span> k5 v5 XX</span><br><span class=\"line\">OK</span><br></pre></td></tr></table></figure>\n<h4 id=\"setnx命令\"><a class=\"markdownIt-Anchor\" href=\"#setnx命令\">#</a>  <code>setnx</code>  命令</h4>\n<p><code>setnx key value</code></p>\n<p><code>set if not exists</code>  的缩写。如果已存在 key, 返回 0, 不存在返回 1. 常用于分布式锁。</p>\n<p>使用实例</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 设置一个不存在的键值对 k6=&gt;v6</span></span><br><span class=\"line\">127.0.0.1:6379&gt; setnx k6 v6</span><br><span class=\"line\">(<span class=\"built_in\">integer</span>) 1</span><br><span class=\"line\"><span class=\"comment\"># 如果key已经存在,则返回0。</span></span><br><span class=\"line\">127.0.0.1:6379&gt; setnx k6 v6</span><br><span class=\"line\">(<span class=\"built_in\">integer</span>) 0</span><br></pre></td></tr></table></figure>\n<h4 id=\"setex-命令\"><a class=\"markdownIt-Anchor\" href=\"#setex-命令\">#</a>  <code>setEx</code>  命令</h4>\n<p><code>setex key seconds value</code></p>\n<p>给键值对设置生存时间 (秒级别)。</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> 设置k7=&gt;v7这个键值对的生存时间为5s</span></span><br><span class=\"line\">127.0.0.1:6379&gt; setex k7 5 v7</span><br><span class=\"line\">OK</span><br><span class=\"line\">127.0.0.1:6379&gt; get k7</span><br><span class=\"line\">&quot;v7&quot;</span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> 过5s秒钟之后,再查看。</span></span><br><span class=\"line\">127.0.0.1:6379&gt; get k7</span><br><span class=\"line\">(nil)</span><br><span class=\"line\">127.0.0.1:6379&gt; </span><br></pre></td></tr></table></figure>\n<h4 id=\"psetex-命令\"><a class=\"markdownIt-Anchor\" href=\"#psetex-命令\">#</a>  <code>psetEx</code>  命令</h4>\n<p><code>psetex key milliseconds value</code></p>\n<blockquote>\n<p><code>tip</code> : 命令助记:  <code>psetex</code>  ,  <code>p</code>  直接的是毫秒。可以参考 <code>set</code>  命令的 <code>PX</code>  选项。</p>\n</blockquote>\n<p>给键值对设置生存时间 (毫秒级别)。</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 设置键值对</span></span><br><span class=\"line\">127.0.0.1:6379&gt; psetex k8 5000 v8</span><br><span class=\"line\">OK</span><br><span class=\"line\"><span class=\"comment\"># 获取k8的值</span></span><br><span class=\"line\">127.0.0.1:6379&gt; get k8</span><br><span class=\"line\"><span class=\"string\">&quot;v8&quot;</span></span><br><span class=\"line\"><span class=\"comment\"># 5s之后，获取k8的值</span></span><br><span class=\"line\">127.0.0.1:6379&gt; get k8</span><br><span class=\"line\">(nil)</span><br></pre></td></tr></table></figure>\n<h4 id=\"get命令\"><a class=\"markdownIt-Anchor\" href=\"#get命令\">#</a>  <code>get</code>  命令</h4>\n<p>这个命令不多说了，获取 <code>key</code>  相关联的 <code>value</code> .  <code>get key</code></p>\n<h4 id=\"getset命令\"><a class=\"markdownIt-Anchor\" href=\"#getset命令\">#</a>  <code>getset</code>  命令</h4>\n<p><code>getset key value</code></p>\n<p>设置键值对， <code>key=&gt;value</code> , 如果 <code>key</code>  已经存在，返回旧值。不存在返回  <code>nil</code></p>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 设置键值对</span></span><br><span class=\"line\">127.0.0.1:6379&gt; getset k9 v9</span><br><span class=\"line\">(nil)</span><br><span class=\"line\"><span class=\"comment\"># 获取值</span></span><br><span class=\"line\">127.0.0.1:6379&gt; get k9</span><br><span class=\"line\"><span class=\"string\">&quot;v9&quot;</span></span><br><span class=\"line\"><span class=\"comment\"># 在设置一次k9,值为vv9,返回旧值 v9</span></span><br><span class=\"line\">127.0.0.1:6379&gt; getset k9 vv9</span><br><span class=\"line\"><span class=\"string\">&quot;v9&quot;</span></span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>ps: 如果原来的存在 key，但是 value 的类型与新设置的类型不一致，会抛出命令错误。</p>\n</blockquote>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 设置一个list类型，key为k9_1, Value中只有一个元素v9_1</span></span><br><span class=\"line\">127.0.0.1:6379&gt; lpush k9_1 v9_1</span><br><span class=\"line\">(<span class=\"built_in\">integer</span>) 1</span><br><span class=\"line\"><span class=\"comment\"># 使用getset命令载设置一次,抛出命令错误。</span></span><br><span class=\"line\">127.0.0.1:6379&gt; getset k9_1 vv9_1</span><br><span class=\"line\">(error) WRONGTYPE Operation against a key holding the wrong kind of value</span><br></pre></td></tr></table></figure>\n<h4 id=\"strlen-命令\"><a class=\"markdownIt-Anchor\" href=\"#strlen-命令\">#</a>  <code>strlen</code>  命令</h4>\n<p><code>strlen key</code></p>\n<p>返回字符串的长度。如果 key 不存在的时候，返回 0, 如果 key 对应的不是一个字符串时，返回错误.</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">127.0.0.1:6379&gt; <span class=\"built_in\">set</span> k10 v10</span><br><span class=\"line\">OK</span><br><span class=\"line\">127.0.0.1:6379&gt; strlen k10</span><br><span class=\"line\">(<span class=\"built_in\">integer</span>) 3</span><br><span class=\"line\"><span class=\"comment\"># 演示报错</span></span><br><span class=\"line\">127.0.0.1:6379&gt; lpush k10_1 v10</span><br><span class=\"line\">(<span class=\"built_in\">integer</span>) 1</span><br><span class=\"line\">127.0.0.1:6379&gt; strlen k10_1</span><br><span class=\"line\">(error) WRONGTYPE Operation against a key holding the wrong kind of value</span><br></pre></td></tr></table></figure>\n<h4 id=\"append命令\"><a class=\"markdownIt-Anchor\" href=\"#append命令\">#</a>  <code>APPEND</code>  命令</h4>\n<p><code>APPEND key value</code>  命令</p>\n<p>根据 key，给 key 对应的值追加字符串。如果 key 不存在，就设置一对键值对。</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 如果key不存在则设置键值对</span></span><br><span class=\"line\">127.0.0.1:6379&gt; append k11 v11</span><br><span class=\"line\">(<span class=\"built_in\">integer</span>) 3</span><br><span class=\"line\">127.0.0.1:6379&gt; get k11</span><br><span class=\"line\"><span class=\"string\">&quot;v11&quot;</span></span><br><span class=\"line\"><span class=\"comment\"># 如果存在，则追加</span></span><br><span class=\"line\">127.0.0.1:6379&gt; append k11 v11</span><br><span class=\"line\">(<span class=\"built_in\">integer</span>) 6</span><br><span class=\"line\">127.0.0.1:6379&gt; get k11</span><br><span class=\"line\"><span class=\"string\">&quot;v11v11&quot;</span></span><br></pre></td></tr></table></figure>\n<h4 id=\"setrange命令\"><a class=\"markdownIt-Anchor\" href=\"#setrange命令\">#</a>  <code>setrange</code>  命令</h4>\n<p><code>setrange key offset value</code></p>\n<p>从偏移量  <code>offset</code>  开始覆写原来 <code>key</code>  的值。如果 <code>key</code>  不存的时候当作空字符串处理。返回被设置后 <code>Value</code>  的长度。</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 设置不存在的key</span></span><br><span class=\"line\">127.0.0.1:6379&gt; setrange k12 3 v12</span><br><span class=\"line\">(<span class=\"built_in\">integer</span>) 6</span><br><span class=\"line\"><span class=\"comment\"># 在offset前的空位置会用 \\x00 填充</span></span><br><span class=\"line\">127.0.0.1:6379&gt; get k12</span><br><span class=\"line\"><span class=\"string\">&quot;\\x00\\x00\\x00v12&quot;</span></span><br><span class=\"line\"><span class=\"comment\"># 设置已经存在的key</span></span><br><span class=\"line\">127.0.0.1:6379&gt; setrange k12 4 v12</span><br><span class=\"line\">(<span class=\"built_in\">integer</span>) 7</span><br><span class=\"line\">127.0.0.1:6379&gt; get k12</span><br><span class=\"line\"><span class=\"string\">&quot;\\x00\\x00\\x00vv12&quot;</span></span><br></pre></td></tr></table></figure>\n<h4 id=\"getrange命令\"><a class=\"markdownIt-Anchor\" href=\"#getrange命令\">#</a>  <code>getrange</code>  命令</h4>\n<p><code>getrange key start end</code></p>\n<p>获取指定区间的值。报错 start 和 end 位置。索引位置是从 0 开始的。</p>\n<p>负数偏移量表示从字符创的末位开始计数。</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">127.0.0.1:6379&gt; <span class=\"built_in\">set</span> k13 v13v13v13</span><br><span class=\"line\">OK</span><br><span class=\"line\">127.0.0.1:6379&gt; getrange k13 2 5</span><br><span class=\"line\"><span class=\"string\">&quot;3v13&quot;</span></span><br><span class=\"line\"><span class=\"comment\"># 从索引为2处，到倒数第4位。</span></span><br><span class=\"line\">127.0.0.1:6379&gt; getrange k13 2 -4</span><br><span class=\"line\"><span class=\"string\">&quot;3v13&quot;</span></span><br><span class=\"line\"><span class=\"comment\"># 如果end大于Value的长度，返回目前start到结束的部分</span></span><br><span class=\"line\">127.0.0.1:6379&gt; getrange k13 3 10</span><br><span class=\"line\"><span class=\"string\">&quot;v13v13&quot;</span></span><br><span class=\"line\"><span class=\"comment\"># 超过Value的长度返回为 &quot;&quot;</span></span><br><span class=\"line\">127.0.0.1:6379&gt; getrange k13 100 120</span><br><span class=\"line\"><span class=\"string\">&quot;&quot;</span></span><br></pre></td></tr></table></figure>\n<h4 id=\"incr-命令\"><a class=\"markdownIt-Anchor\" href=\"#incr-命令\">#</a>  <code>incr</code>  命令</h4>\n<p><code>incr key</code></p>\n<p>在 key 对应的 Value 上进行自增 1. 如果 Value 可以解释为数据，则自增，反之，返回错误。</p>\n<p>返回值为自增后的值。</p>\n<p>如果 ke 不存在，则先初始化 key 对应的 Value=0， 然后再自增。</p>\n<p>相对的是: <a href=\"#%60DECR%60%E5%91%BD%E4%BB%A4\"> <code>DECR</code>  命令</a></p>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">127.0.0.1:6379&gt; incr k14</span><br><span class=\"line\">(<span class=\"built_in\">integer</span>) 1</span><br><span class=\"line\">127.0.0.1:6379&gt; get k14</span><br><span class=\"line\"><span class=\"string\">&quot;1&quot;</span></span><br><span class=\"line\">127.0.0.1:6379&gt; incr k14</span><br><span class=\"line\">(<span class=\"built_in\">integer</span>) 2</span><br></pre></td></tr></table></figure>\n<h4 id=\"incrby命令\"><a class=\"markdownIt-Anchor\" href=\"#incrby命令\">#</a>  <code>incrby</code>  命令</h4>\n<p><code>incrby key increment</code></p>\n<p>带有步长的自增命令。</p>\n<p>相对的命令是: <a href=\"%60DECRBY%60%E5%91%BD%E4%BB%A4\"> <code>DECRBY</code>  命令</a></p>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">127.0.0.1:6379&gt; incrby k15 5</span><br><span class=\"line\">(<span class=\"built_in\">integer</span>) 5</span><br><span class=\"line\">127.0.0.1:6379&gt; INCRBY k15 5</span><br><span class=\"line\">(<span class=\"built_in\">integer</span>) 10</span><br><span class=\"line\">127.0.0.1:6379&gt; INCRBY k15 5</span><br><span class=\"line\">(<span class=\"built_in\">integer</span>) 15</span><br></pre></td></tr></table></figure>\n<h4 id=\"incrbyfloat命令\"><a class=\"markdownIt-Anchor\" href=\"#incrbyfloat命令\">#</a>  <code>INCRBYFLOAT</code>  命令</h4>\n<p><code>INCRBYFLOAT key increment</code></p>\n<p>带有步长的浮点数自增</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">127.0.0.1:6379&gt; INCRBYFLOAT k16 5.0</span><br><span class=\"line\"><span class=\"string\">&quot;5&quot;</span></span><br><span class=\"line\">127.0.0.1:6379&gt; INCRBYFLOAT k16 5.2</span><br><span class=\"line\"><span class=\"string\">&quot;10.2&quot;</span></span><br><span class=\"line\">127.0.0.1:6379&gt; INCRBYFLOAT k16 5.4</span><br><span class=\"line\"><span class=\"string\">&quot;15.6&quot;</span></span><br></pre></td></tr></table></figure>\n<h4 id=\"decr命令\"><a class=\"markdownIt-Anchor\" href=\"#decr命令\">#</a>  <code>DECR</code>  命令</h4>\n<p><code>DECR key</code></p>\n<p>自减 <code>1</code> .</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 如果key，不存在，同样会初始化为0，然后自减1</span></span><br><span class=\"line\">127.0.0.1:6379&gt; DECR k17</span><br><span class=\"line\">(<span class=\"built_in\">integer</span>) -1</span><br><span class=\"line\">127.0.0.1:6379&gt; DECR k17</span><br><span class=\"line\">(<span class=\"built_in\">integer</span>) -2</span><br><span class=\"line\">127.0.0.1:6379&gt; DECR k17</span><br><span class=\"line\">(<span class=\"built_in\">integer</span>) -3</span><br></pre></td></tr></table></figure>\n<h4 id=\"decrby命令\"><a class=\"markdownIt-Anchor\" href=\"#decrby命令\">#</a>  <code>DECRBY</code>  命令</h4>\n<p>带有步长的自减命令，与 <a href=\"%60INCRBY%60%E5%91%BD%E4%BB%A4\"> <code>INCRBY</code>  命令</a>相对。</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 如果key不存在，会初始化为0，在进行自减。</span></span><br><span class=\"line\">127.0.0.1:6379&gt; DECRBY k18 5</span><br><span class=\"line\">(<span class=\"built_in\">integer</span>) -5</span><br><span class=\"line\">127.0.0.1:6379&gt; DECRBY k18 5</span><br><span class=\"line\">(<span class=\"built_in\">integer</span>) -10</span><br></pre></td></tr></table></figure>\n<h4 id=\"mget命令\"><a class=\"markdownIt-Anchor\" href=\"#mget命令\">#</a>  <code>mget</code>  命令</h4>\n<p><code>mget key [key ...]</code></p>\n<p>一次性返回多个 <code>key</code>  的值。 如果 <code>key</code>  不存在，返回  <code>(nil)</code></p>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">127.0.0.1:6379&gt; <span class=\"built_in\">set</span> k19_0 v19_0</span><br><span class=\"line\">OK</span><br><span class=\"line\">127.0.0.1:6379&gt; <span class=\"built_in\">set</span> k19_1 v19_1</span><br><span class=\"line\">OK</span><br><span class=\"line\">127.0.0.1:6379&gt; mget k19_0 k19_1</span><br><span class=\"line\">1) <span class=\"string\">&quot;v19_0&quot;</span></span><br><span class=\"line\">2) <span class=\"string\">&quot;v19_1&quot;</span></span><br><span class=\"line\"><span class=\"comment\"># 如果key不存在的时候，返回 (nil)</span></span><br><span class=\"line\">127.0.0.1:6379&gt; mget k19_0 k19_1 k10_2</span><br><span class=\"line\">1) <span class=\"string\">&quot;v19_0&quot;</span></span><br><span class=\"line\">2) <span class=\"string\">&quot;v19_1&quot;</span></span><br><span class=\"line\">3) (nil)</span><br></pre></td></tr></table></figure>\n<h4 id=\"mset命令\"><a class=\"markdownIt-Anchor\" href=\"#mset命令\">#</a>  <code>mset</code>  命令</h4>\n<p>同时为设置多个键值对。 如果 key 已经存在，直接覆盖掉。</p>\n<p>注意： 这个原子性操作。所有给定的 key 都会在同一时间内被设置。</p>\n<blockquote>\n<p>tips: 如果希望，已经存在的 key 不被覆盖，可以参考 <a href=\"#%60msetnx%60%E5%91%BD%E4%BB%A4\"> <code>msetnx</code>  命令</a></p>\n</blockquote>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 一下设置三对</span></span><br><span class=\"line\">127.0.0.1:6379&gt; mset k20_0 v20_0 k20_1 v20_1 k20_2 v20_2</span><br><span class=\"line\">OK</span><br><span class=\"line\">127.0.0.1:6379&gt; mget k20_0 k20_1 k20_2</span><br><span class=\"line\">1) <span class=\"string\">&quot;v20_0&quot;</span></span><br><span class=\"line\">2) <span class=\"string\">&quot;v20_1&quot;</span></span><br><span class=\"line\">3) <span class=\"string\">&quot;v20_2&quot;</span></span><br><span class=\"line\"><span class=\"comment\"># 演示已有的key对应的值会被覆盖掉。</span></span><br><span class=\"line\">127.0.0.1:6379&gt; mset k20_2 vv20_2 k20_3 v20_3</span><br><span class=\"line\">OK</span><br><span class=\"line\">127.0.0.1:6379&gt; mget k20_2 k20_3</span><br><span class=\"line\">1) <span class=\"string\">&quot;vv20_2&quot;</span></span><br><span class=\"line\">2) <span class=\"string\">&quot;v20_3&quot;</span></span><br></pre></td></tr></table></figure>\n<h4 id=\"msetnx命令\"><a class=\"markdownIt-Anchor\" href=\"#msetnx命令\">#</a>  <code>msetnx</code>  命令</h4>\n<p><code>MSETNX key value [key value ...]</code></p>\n<p>当且仅当所有给定的 key 不存在的时候，才会设置键值对。即使有一个 key 存在，该命令也不会设置其他的 key 对应的键值对.</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 演示设置成功</span></span><br><span class=\"line\">127.0.0.1:6379&gt; MSETNX k21_0 v21_0 k21_1 v21_1</span><br><span class=\"line\">(<span class=\"built_in\">integer</span>) 1</span><br><span class=\"line\">127.0.0.1:6379&gt; MGET k21_0 k21_1</span><br><span class=\"line\">1) <span class=\"string\">&quot;v21_0&quot;</span></span><br><span class=\"line\">2) <span class=\"string\">&quot;v21_1&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 存在其中的一个给定key，就不能设置成功</span></span><br><span class=\"line\">127.0.0.1:6379&gt; msetnx k21_1 vv21_1 k21_2 v21_2</span><br><span class=\"line\">(<span class=\"built_in\">integer</span>) 0</span><br><span class=\"line\">127.0.0.1:6379&gt; MGET k21_1 k21_2</span><br><span class=\"line\">1) <span class=\"string\">&quot;v21_1&quot;</span></span><br><span class=\"line\">2) (nil)</span><br></pre></td></tr></table></figure>\n<h3 id=\"redis如何实现string这一数据结构\"><a class=\"markdownIt-Anchor\" href=\"#redis如何实现string这一数据结构\">#</a>  <code>Redis</code>  如何实现 <code>String</code>  这一数据结构</h3>\n<p>在  <code>string</code>  的相关命令介绍的时候，我其实使用一个错误的描述。就是将 <code>Redis</code>  的 <code>String</code>  类型称为字符串。这种说法其实不正确的。</p>\n<p>在  <code>redis</code>  中， <code>string</code>  这一数据结构使用 <code>sds</code>  来表示的。</p>\n<h4 id=\"sds\"><a class=\"markdownIt-Anchor\" href=\"#sds\">#</a>  <code>sds</code></h4>\n<p><code>sds</code>  是  <code>simple dynamic string</code>  的简称。 意思是  <code>简单的动态字符串</code> 。 这里面的 <code>string</code>  就是实打实的 <code>C</code>  语言中的字符串 ( <code>char[]</code> ).  <code>Redis</code>  也并非一点也没有使用  <code>C</code>  语言的字符串，像一些字面量常亮，日志都是使用 <code>C</code>  语言的字符串。</p>\n<p>那  <code>sds</code>  到底是一个什么样的结构呢？</p>\n<p>在源码的  <code>src</code>  目录下，我找到了  <code>sds.h</code>  这样一个文件。这里规定了  <code>sds</code>  结构。</p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"class\"><span class=\"keyword\">struct</span> __<span class=\"title\">attribute__</span> ((__<span class=\"title\">packed__</span>)) <span class=\"title\">sdshdr64</span> &#123;</span></span><br><span class=\"line\">    <span class=\"comment\">// 表示已使用的长度,即buf[]的长度。</span></span><br><span class=\"line\">    <span class=\"keyword\">uint64_t</span> len; </span><br><span class=\"line\">    <span class=\"comment\">// 已分配的长度(包括未使用的长度)</span></span><br><span class=\"line\">    <span class=\"comment\">// alloc-len,对应着之前版本的free</span></span><br><span class=\"line\">    <span class=\"keyword\">uint64_t</span> alloc; </span><br><span class=\"line\">    <span class=\"keyword\">unsigned</span> <span class=\"keyword\">char</span> flags; </span><br><span class=\"line\">    <span class=\"keyword\">char</span> buf[];</span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>tips: 如果你注意到了这个结构体的命名。那么来看下<a href=\"\">这篇文章</a>吧。</p>\n</blockquote>\n<p><code>sds</code>  保留了  <code>C</code>  字符串以空字符结尾的惯例。保留的这个空字符的长度不会保存在  <code>len</code>  字段中。保留这一惯例的好处就是可以使用 <code>C</code>  字符串函数库的一些方法。</p>\n<p>假设我们分配了 <code>10</code>  个字节空间，只保存了  <code>redis</code>  这个 <code>C</code>  字符串，那么 在 <code>sds</code>  中，是这么表示的：</p>\n<p><img data-src=\"/images/Redis%E7%B3%BB%E5%88%97/images/01-01-sds%E7%A4%BA%E6%84%8F%E5%9B%BE.png\" alt=\"01-01-sds示意图.png\"></p>\n<h4 id=\"使用sds比使用c字符串有什么好处呢\"><a class=\"markdownIt-Anchor\" href=\"#使用sds比使用c字符串有什么好处呢\">#</a> 使用 <code>sds</code>  比使用 <code>C</code>  字符串有什么好处呢？</h4>\n<h5 id=\"获取字符长度的时间复杂度为-o1\"><a class=\"markdownIt-Anchor\" href=\"#获取字符长度的时间复杂度为-o1\">#</a> 获取字符长度的时间复杂度为  <code>O(1)</code></h5>\n<p><code>C</code>  语言获取一个字符串的长度为  <code>O(N)</code> . 需要遍历字符串并累加，判断字符是否为  <code>'\\0'</code>  来获得字符串的长度。</p>\n<p><code>sds</code>  只需要根据  <code>len</code>  字段获取即可。怎么获取的呢？</p>\n<p>我们来看下源码。</p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// 定义char类型的指针类型。</span></span><br><span class=\"line\"><span class=\"keyword\">typedef</span> <span class=\"keyword\">char</span> *sds;</span><br><span class=\"line\"><span class=\"comment\">// 获取长度的结构体指针的宏.</span></span><br><span class=\"line\"><span class=\"comment\">// 可根据指向buf的指针返回指向sdshdr结构体首地址的宏</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">define</span> SDS_HDR(T,s) ((struct sdshdr##T *)((s)-(sizeof(struct sdshdr##T))))</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// sds 直接指向结构体里的buf</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">static</span> <span class=\"keyword\">inline</span> <span class=\"keyword\">size_t</span> <span class=\"title\">sdslen</span><span class=\"params\">(<span class=\"keyword\">const</span> sds s)</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"comment\">// sds是直接指向结构体里的buf数据, 当获取len等字段的信息,只需要减去结构体长度，回退一下指针就可以了。</span></span><br><span class=\"line\">    <span class=\"comment\">// 这里使用的尾指针法。</span></span><br><span class=\"line\">    <span class=\"keyword\">unsigned</span> <span class=\"keyword\">char</span> flags = s[<span class=\"number\">-1</span>];</span><br><span class=\"line\">    <span class=\"comment\">// 判断属于那种 sdshdr,对应减去不同的地址。</span></span><br><span class=\"line\">    <span class=\"built_in\"><span class=\"keyword\">switch</span></span>(flags&amp;SDS_TYPE_MASK) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">case</span> SDS_TYPE_5:</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"built_in\">SDS_TYPE_5_LEN</span>(flags);</span><br><span class=\"line\">        <span class=\"keyword\">case</span> SDS_TYPE_8:</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"built_in\">SDS_HDR</span>(<span class=\"number\">8</span>,s)-&gt;len;</span><br><span class=\"line\">        <span class=\"keyword\">case</span> SDS_TYPE_16:</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"built_in\">SDS_HDR</span>(<span class=\"number\">16</span>,s)-&gt;len;</span><br><span class=\"line\">        <span class=\"keyword\">case</span> SDS_TYPE_32:</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"built_in\">SDS_HDR</span>(<span class=\"number\">32</span>,s)-&gt;len;</span><br><span class=\"line\">        <span class=\"keyword\">case</span> SDS_TYPE_64:</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"built_in\">SDS_HDR</span>(<span class=\"number\">64</span>,s)-&gt;len;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h5 id=\"可以杜绝缓冲区溢出\"><a class=\"markdownIt-Anchor\" href=\"#可以杜绝缓冲区溢出\">#</a> 可以杜绝缓冲区溢出</h5>\n<p><code>C</code>  语言是不会判断数组是否越界的。比如  <code>strcat</code>  方法，如果当前的数据不能容纳拼接之后字符时，必然会发生缓存区溢出。<br>\n但是  <code>sds</code>  则不会。我们来看下  <code>sds</code>  的字符串拼接的方法  <code>sdscat</code> 。</p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// s 原来的字符串，t是要拼接的字符串</span></span><br><span class=\"line\"><span class=\"function\">sds <span class=\"title\">sdscat</span><span class=\"params\">(sds s, <span class=\"keyword\">const</span> <span class=\"keyword\">char</span> *t)</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"built_in\">sdscatlen</span>(s, t, <span class=\"built_in\">strlen</span>(t));</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\">sds <span class=\"title\">sdscatlen</span><span class=\"params\">(sds s, <span class=\"keyword\">const</span> <span class=\"keyword\">void</span> *t, <span class=\"keyword\">size_t</span> len)</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"comment\">// 获取原来字符串的长度。(见上面的方法)</span></span><br><span class=\"line\">    <span class=\"keyword\">size_t</span> curlen = <span class=\"built_in\">sdslen</span>(s);</span><br><span class=\"line\">    <span class=\"comment\">// 扩大sds字符串末尾的可用空间，</span></span><br><span class=\"line\">    <span class=\"comment\">//以便调用者确保在调用此函数后可以覆盖字符串末尾的addlen字节，</span></span><br><span class=\"line\">    <span class=\"comment\">//再为null项再加上一个字节。 具体实现，参考源码(sds.c:204)。</span></span><br><span class=\"line\">    s = <span class=\"built_in\">sdsMakeRoomFor</span>(s,len);</span><br><span class=\"line\">    <span class=\"comment\">// 如果内存分配失败，就会返回null</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (s == <span class=\"literal\">NULL</span>) <span class=\"keyword\">return</span> <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">    <span class=\"comment\">// 调用C语言的分配</span></span><br><span class=\"line\">    <span class=\"built_in\">memcpy</span>(s+curlen, t, len);</span><br><span class=\"line\">    <span class=\"comment\">// sds设置 sdshdr的len字段的值。</span></span><br><span class=\"line\">    <span class=\"built_in\">sdssetlen</span>(s, curlen+len);</span><br><span class=\"line\">    <span class=\"comment\">// 添加最后一个字符为: &#x27;\\0&#x27;</span></span><br><span class=\"line\">    s[curlen+len] = <span class=\"string\">&#x27;\\0&#x27;</span>;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> s;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h5 id=\"sds-优化了c语言的内存分配策略\"><a class=\"markdownIt-Anchor\" href=\"#sds-优化了c语言的内存分配策略\">#</a> sds 优化了 C 语言的内存分配策略</h5>\n<h6 id=\"空间预分配\"><a class=\"markdownIt-Anchor\" href=\"#空间预分配\">#</a> 空间预分配</h6>\n<p>空间预分配策略遵循下面的公式:</p>\n<ul>\n<li>如果 <code>SDS</code>  的长度小于最大的预分配空间 ( <code>1MB</code> ), 那么会分配两倍的新空间，再加上结尾的空字符 <code>'\\0'</code>  举个例子：原有的 <code>sds</code>  的 <code>len</code>  为 <code>5</code> , <code>alloc</code>  为 <code>5</code> , 要拼接的字符串长度为 <code>15</code> , 那么新分配的空间大小是:  <code>(5byte+15byte)*2 + 1byte = 41byte</code> .</li>\n<li>如果 <code>sds</code>  的长度大于等于默认的预分配空间，那么就在新分配的空间大小基础上，在分配 <code>1MB</code>  的空间。如果修改后的， <code>SDS</code>  的 <code>len</code>  是  <code>20M</code> ，那么 <code>alloc</code>  就是  <code>20M + 1M + 1byte</code></li>\n</ul>\n<p>具体分配过程见下面的源码</p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// SDS 默认最大的预分配空间为1M</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">define</span> SDS_MAX_PREALLOC (1024*1024)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// sds 预分配空间</span></span><br><span class=\"line\"><span class=\"function\">sds <span class=\"title\">sdsMakeRoomFor</span><span class=\"params\">(sds s, <span class=\"keyword\">size_t</span> addlen)</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">void</span> *sh, *newsh;</span><br><span class=\"line\">    <span class=\"keyword\">size_t</span> avail = <span class=\"built_in\">sdsavail</span>(s);</span><br><span class=\"line\">    <span class=\"keyword\">size_t</span> len, newlen;</span><br><span class=\"line\">    <span class=\"keyword\">char</span> type, oldtype = s[<span class=\"number\">-1</span>] &amp; SDS_TYPE_MASK;</span><br><span class=\"line\">    <span class=\"keyword\">int</span> hdrlen;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/* 如果空间足够，直接返回 */</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (avail &gt;= addlen) <span class=\"keyword\">return</span> s;</span><br><span class=\"line\"></span><br><span class=\"line\">    len = <span class=\"built_in\">sdslen</span>(s);</span><br><span class=\"line\">    sh = (<span class=\"keyword\">char</span>*)s-<span class=\"built_in\">sdsHdrSize</span>(oldtype);</span><br><span class=\"line\">    newlen = (len+addlen);</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (newlen &lt; SDS_MAX_PREALLOC)</span><br><span class=\"line\">        newlen *= <span class=\"number\">2</span>;</span><br><span class=\"line\">    <span class=\"keyword\">else</span></span><br><span class=\"line\">        newlen += SDS_MAX_PREALLOC;</span><br><span class=\"line\"></span><br><span class=\"line\">    type = <span class=\"built_in\">sdsReqType</span>(newlen);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/* Don&#x27;t use type 5: the user is appending to the string and type 5 is</span></span><br><span class=\"line\"><span class=\"comment\">     * not able to remember empty space, so sdsMakeRoomFor() must be called</span></span><br><span class=\"line\"><span class=\"comment\">     * at every appending operation. */</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (type == SDS_TYPE_5) type = SDS_TYPE_8;</span><br><span class=\"line\"></span><br><span class=\"line\">    hdrlen = <span class=\"built_in\">sdsHdrSize</span>(type);</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (oldtype==type) &#123;</span><br><span class=\"line\">        newsh = <span class=\"built_in\">s_realloc</span>(sh, hdrlen+newlen+<span class=\"number\">1</span>);</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (newsh == <span class=\"literal\">NULL</span>) <span class=\"keyword\">return</span> <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">        s = (<span class=\"keyword\">char</span>*)newsh+hdrlen;</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">        <span class=\"comment\">/* Since the header size changes, need to move the string forward,</span></span><br><span class=\"line\"><span class=\"comment\">         * and can&#x27;t use realloc */</span></span><br><span class=\"line\">        newsh = <span class=\"built_in\">s_malloc</span>(hdrlen+newlen+<span class=\"number\">1</span>);</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (newsh == <span class=\"literal\">NULL</span>) <span class=\"keyword\">return</span> <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">        <span class=\"built_in\">memcpy</span>((<span class=\"keyword\">char</span>*)newsh+hdrlen, s, len+<span class=\"number\">1</span>);</span><br><span class=\"line\">        <span class=\"built_in\">s_free</span>(sh);</span><br><span class=\"line\">        s = (<span class=\"keyword\">char</span>*)newsh+hdrlen;</span><br><span class=\"line\">        s[<span class=\"number\">-1</span>] = type;</span><br><span class=\"line\">        <span class=\"built_in\">sdssetlen</span>(s, len);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"built_in\">sdssetalloc</span>(s, newlen);</span><br><span class=\"line\">    <span class=\"keyword\">return</span> s;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h6 id=\"惰性空间释放\"><a class=\"markdownIt-Anchor\" href=\"#惰性空间释放\">#</a> 惰性空间释放</h6>\n<p>当对 sds 进行缩短操作时，程序并不会立马对内存重分配来回收收缩的空间，而是仅仅改变 <code>len</code>  属性，并且在队对应的位置上将字符设置为:  <code>'\\0'</code></p>\n<p>以 函数  <code>sdstrim</code>  为例。</p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\">sds <span class=\"title\">sdstrim</span><span class=\"params\">(sds s, <span class=\"keyword\">const</span> <span class=\"keyword\">char</span> *cset)</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">char</span> *start, *end, *sp, *ep;</span><br><span class=\"line\">    <span class=\"keyword\">size_t</span> len;</span><br><span class=\"line\"></span><br><span class=\"line\">    sp = start = s;</span><br><span class=\"line\">    ep = end = s+<span class=\"built_in\">sdslen</span>(s)<span class=\"number\">-1</span>;</span><br><span class=\"line\">    <span class=\"keyword\">while</span>(sp &lt;= end &amp;&amp; <span class=\"built_in\">strchr</span>(cset, *sp)) sp++;</span><br><span class=\"line\">    <span class=\"keyword\">while</span>(ep &gt; sp &amp;&amp; <span class=\"built_in\">strchr</span>(cset, *ep)) ep--;</span><br><span class=\"line\">    len = (sp &gt; ep) ? <span class=\"number\">0</span> : ((ep-sp)+<span class=\"number\">1</span>);</span><br><span class=\"line\">    <span class=\"comment\">// 进行移位</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (s != sp) <span class=\"built_in\">memmove</span>(s, sp, len);</span><br><span class=\"line\">    <span class=\"comment\">// 设置字符串结束符</span></span><br><span class=\"line\">    s[len] = <span class=\"string\">&#x27;\\0&#x27;</span>;</span><br><span class=\"line\">    <span class=\"comment\">// 设置len字段的值</span></span><br><span class=\"line\">    <span class=\"built_in\">sdssetlen</span>(s,len);</span><br><span class=\"line\">    <span class=\"keyword\">return</span> s;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>上述实现中，并没有进行内存回收。 <code>sds</code>  也提供了内存回收的函数 <code>sds_free</code> . 具体可以看 <code>Redis 5.0.7</code>  版源码.  <code>sds.c</code>  第 <code>1120</code>  行。这里不再深入学习了。</p>\n<h4 id=\"二进制安全\"><a class=\"markdownIt-Anchor\" href=\"#二进制安全\">#</a> 二进制安全</h4>\n<p><code>sds</code>  的 <code>API</code>  都是二进制安全的。因为 <code>Redis</code>  对  <code>sds</code>  结构中的 <code>buf</code>  数组中的数据都是以二进制的方式处理的。</p>\n<h4 id=\"兼容部分的c字符串函数\"><a class=\"markdownIt-Anchor\" href=\"#兼容部分的c字符串函数\">#</a> 兼容部分的 <code>C</code>  字符串函数</h4>\n<p><code>Redis</code>  还是遵循了 <code>C</code>  字符串以  <code>'\\0'</code>  结尾的习惯，所以保存了文本数据的 <code>sds</code>  是可以复用  <code>&lt;string.h&gt;</code>  库中的函数。</p>\n<h3 id=\"总结\"><a class=\"markdownIt-Anchor\" href=\"#总结\">#</a> 总结</h3>\n<ul>\n<li>\n<p><code>string</code>  是 <code>redis</code>  中最简单的数据结构.  <code>string</code>  不是 <code>C</code>  字符串，而是对 <code>C</code>  字符串进行了封装.</p>\n</li>\n<li>\n<p>学习了 <code>string</code>  类型相关的 <code>api</code> 。  <code>set</code> , <code>setnx</code> , <code>setex</code> ,  <code>get</code> ,  <code>getset</code> ,  <code>incr</code> ,  <code>decr</code> ,…</p>\n</li>\n<li>\n<p><code>sds</code>  这种设计的好处，提高了性能，优化内存分配，二进制安全，兼容 <code>C</code>  字符串。</p>\n</li>\n</ul>\n<h2 id=\"最后\"><a class=\"markdownIt-Anchor\" href=\"#最后\">#</a> 最后</h2>\n<p>期望与你一起遇见更好的自己</p>\n<p><img data-src=\"/images/qrcode.jpg\" alt=\"期望与你一起遇见更好的自己\"></p>\n",
            "tags": [
                "Redis"
            ]
        },
        {
            "id": "https://fangjiaxiaobai.github.io/2021/08/01/Redis%E7%B3%BB%E5%88%97/02-Redis%E7%9A%84%E5%A4%9A%E4%B8%AA%E6%95%B0%E6%8D%AE%E5%BA%93/",
            "url": "https://fangjiaxiaobai.github.io/2021/08/01/Redis%E7%B3%BB%E5%88%97/02-Redis%E7%9A%84%E5%A4%9A%E4%B8%AA%E6%95%B0%E6%8D%AE%E5%BA%93/",
            "title": "Redis 多个数据库",
            "date_published": "2021-08-01T06:48:55.000Z",
            "content_html": "<p><code>Redis</code>  默认提供了 <code>16</code>  个数据库。每个数据库都有一个 <code>id</code> , 从  <code>0</code>  开始，[0,15]。 不同的数据库中数据隔离保存。我们可以通过修改 redis 的配置文件进行修改数据库的数量。</p>\n<figure class=\"highlight properties\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">database</span> <span class=\"string\">32</span></span><br></pre></td></tr></table></figure>\n<ul>\n<li>使用  <code>select &lt;ID&gt;</code>  可以切换数据库.</li>\n</ul>\n<p>示例如下:</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">127.0.0.1:6379&gt; select 1</span><br><span class=\"line\">OK</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 演示数据隔离</span></span><br><span class=\"line\">127.0.0.1:6379[1]&gt; <span class=\"built_in\">set</span> <span class=\"built_in\">test</span> 1</span><br><span class=\"line\">OK</span><br><span class=\"line\">127.0.0.1:6379[1]&gt; select 2</span><br><span class=\"line\">Ok</span><br><span class=\"line\">127.0.0.1:6379[2]&gt; get <span class=\"built_in\">test</span></span><br><span class=\"line\">(nil)</span><br></pre></td></tr></table></figure>\n<p>可以通过命令之前的部分区分我们所在的数据库.<br>\n <code>127.0.0.1:6379[2]&gt; select 2</code>  执行这个命令的时候，我们是在数据库 <code>1</code>  中的。</p>\n<ul>\n<li>使用  <code>flushdb</code>  只能删除 <b>该数据库 (一个库)</b> 中的数据。</li>\n<li>使用  <code>flushall</code>  可以删除 <b>所有库</b> 中的数据。</li>\n</ul>\n<h2 id=\"redis使用分库的意义\"><a class=\"markdownIt-Anchor\" href=\"#redis使用分库的意义\">#</a> redis 使用分库的意义</h2>\n<ul>\n<li>避免不同应用相同 <code>key</code>  的影响。</li>\n<li>更便于管理。<br>\n一个实例上运行多个库，只运维这一个实例就可以了。</li>\n<li>也有不少文章说，redis 的作者曾说过，“多数据库的设计可能是最糟糕的决定.”. Redis 是单线程的，即使是多数据库也不会带来性能提升。但是这个并没有和前面的两个好处冲突。下面是作者的原话:</li>\n</ul>\n<blockquote>\n<p>I understand how this can be useful, but unfortunately I consider Redis multiple database errors my worst decision in Redis design at all… without any kind of real gain, it makes the internals a lot more complex. The reality is that databases don’t scale well for a number of reason, like active expire of keys and VM. If the DB selection can be performed with a string I can see this feature being used as a scalable O(1) dictionary layer, that instead it is not.</p>\n</blockquote>\n<blockquote>\n<p>With DB numbers, with a default of a few DBs, we are communication better what this feature is and how can be used I think. I hope that at some point we can drop the multiple DBs support at all, but I think it is probably too late as there is a number of people relying on this feature for their work.</p>\n</blockquote>\n<h3 id=\"redis的分库是怎么实现\"><a class=\"markdownIt-Anchor\" href=\"#redis的分库是怎么实现\">#</a> Redis 的分库是怎么实现？</h3>\n<p><code>Redis</code>  服务器间所有的数据库都保存在 服务器状态  <code>redis.h/redisServer</code>  结构的 db 数组中。 <code>db</code>  数组中的每个元素都是一个  <code>redis.h/redisDb</code>  结构。每个 <code>redisDb</code>  结构代表一个数据库.</p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">redisServer</span> &#123;</span></span><br><span class=\"line\">    <span class=\"comment\">// 保存所有数据库</span></span><br><span class=\"line\">    redisDb *db;</span><br><span class=\"line\">    <span class=\"comment\">// 数据库的数量(redis.conf文件中 database配置的)</span></span><br><span class=\"line\">    <span class=\"keyword\">int</span> dbnum;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>每个 <code>Redis</code>  客户端都有自己的目标数据库，每个客户端执行数据库写命令或者数据库读命令的时候，目标数据库都会成为这些命令的操作对象.<br>\n 每个客户端用  <code>RedisClient</code>  来描述。  <code>RedisClient</code>  结构的 <code>db</code>  属性记录了客户端当前的目标数据库，这个属性是一个指向  <code>redisDb</code>  的指针.</p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">typedef</span> <span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">redisClient</span> &#123;</span></span><br><span class=\"line\">    <span class=\"comment\">// 记录客户端端正在使用的数据库id</span></span><br><span class=\"line\">    redisDb *db;</span><br><span class=\"line\">&#125; redisClient;</span><br></pre></td></tr></table></figure>\n<h4 id=\"举个例子\"><a class=\"markdownIt-Anchor\" href=\"#举个例子\">#</a> 举个例子:</h4>\n<p>假设我们客户端连接的是数据库 <code>1</code> , 那么客户端与服务器端之间的关系是这样的:</p>\n<p><img data-src=\"./images/00-01%E5%A4%9A%E6%95%B0%E6%8D%AE%E5%BA%93%E7%A4%BA%E6%84%8F%E5%9B%BE.png\" alt=\"00-01多数据库示意图\"></p>\n<p>如果我们运行  <code>select 2</code> , 其实，就是改变的 db 的指针。让它指向了  <code>db(2)</code> , 这就是  <code>select</code>  命令的运行原理。如下图。</p>\n<p><img data-src=\"./images/00-02%E5%A4%9A%E6%95%B0%E6%8D%AE%E5%BA%93%E7%A4%BA%E6%84%8F%E5%9B%BE.png\" alt=\"00-02多数据库示意图\"></p>\n<p>以上就是 关于  <code>Redis</code>  多数据库的内容了。</p>\n<h2 id=\"最后\"><a class=\"markdownIt-Anchor\" href=\"#最后\">#</a> 最后</h2>\n<p>期望与你一起遇见更好的自己</p>\n<p><img data-src=\"/images/qrcode.jpg\" alt=\"期望与你一起遇见更好的自己\"></p>\n",
            "tags": [
                "Redis"
            ]
        },
        {
            "id": "https://fangjiaxiaobai.github.io/2021/08/01/Redis%E7%B3%BB%E5%88%97/01-Redis%E7%AE%80%E4%BB%8B%E4%BB%A5%E5%8F%8A%E4%B8%8E%E5%85%B6%E4%BB%96%E6%95%B0%E6%8D%AE%E5%BA%93%E7%9A%84%E5%AF%B9%E6%AF%94/",
            "url": "https://fangjiaxiaobai.github.io/2021/08/01/Redis%E7%B3%BB%E5%88%97/01-Redis%E7%AE%80%E4%BB%8B%E4%BB%A5%E5%8F%8A%E4%B8%8E%E5%85%B6%E4%BB%96%E6%95%B0%E6%8D%AE%E5%BA%93%E7%9A%84%E5%AF%B9%E6%AF%94/",
            "title": "Redis 简介",
            "date_published": "2021-08-01T06:40:55.000Z",
            "content_html": "<p><code>Redis</code>  是一个开放源代码（ <code>BSD</code>  许可）的内存中数据结构存储，用作数据库，缓存和消息代理。它支持数据结构，例如字符串，哈希，列表，集合，带范围查询的排序集合，位图 ( <code>bitMap</code> )，超日志 ( <code>hyperlog</code> )，带有半径查询和流的地理空间索引 ( <code>geohash</code> )。 <code>Redis</code>  还内置了副本， <code>Lua</code>  脚本， <code>LRU</code>  驱逐策略，事务和不同级别的磁盘持久性，并通过 <code>Redis Sentinel</code>  和 <code>Redis Cluster</code>  自动分区提供了高可用性。</p>\n<p><code>Redis</code>  还支持一下特性:</p>\n<ul>\n<li>事务</li>\n<li>发布 / 订阅模式</li>\n<li><code>lua</code>  脚本</li>\n<li>键值的允许生存时长.</li>\n<li><code>LRU</code>  驱逐</li>\n<li>故障自动转移</li>\n</ul>\n<h2 id=\"与其他数据库对比\"><a class=\"markdownIt-Anchor\" href=\"#与其他数据库对比\">#</a> 与其他数据库对比</h2>\n<p>与其他数据库的对比:</p>\n<table>\n<thead>\n<tr>\n<th>-</th>\n<th>Redis</th>\n<th>MongoDB</th>\n<th>Hbase</th>\n<th>Mysql</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>数据库类型</td>\n<td>NoSQL</td>\n<td>NOSQL</td>\n<td>NoSQL</td>\n<td>关系型数据库</td>\n</tr>\n<tr>\n<td>数据类型</td>\n<td>key-value, 提供 String,List,zet 等多种结构</td>\n<td>Collection.Document.BSON</td>\n<td>基于列模式的映射数据库，可表示简单的 key-value 的映射关系。</td>\n<td>DB.table.row/col</td>\n</tr>\n<tr>\n<td>持久化</td>\n<td>支持 (RDB/AOF)</td>\n<td>支持</td>\n<td>支持</td>\n<td>支持</td>\n</tr>\n<tr>\n<td>是否支持集群</td>\n<td>支持</td>\n<td>支持</td>\n<td>支持</td>\n<td>支持</td>\n</tr>\n<tr>\n<td>使用场景</td>\n<td>缓存 (内存稳定，读写性能极佳), 读多写少</td>\n<td>使用 Mysql 等关系型数据库，但是会遇到表结构不稳定的时候 (灵活)</td>\n<td>数据库大，特别大，列数据库，适合写多读少的场景</td>\n<td>常规的数据存储</td>\n</tr>\n<tr>\n<td>是否支持索引</td>\n<td>支持</td>\n<td>支持</td>\n<td>支持</td>\n<td>支持</td>\n</tr>\n<tr>\n<td>是否支持事务</td>\n<td>支持</td>\n<td>不支持</td>\n<td>支持</td>\n<td>支持</td>\n</tr>\n</tbody>\n</table>\n<h2 id=\"最后\"><a class=\"markdownIt-Anchor\" href=\"#最后\">#</a> 最后</h2>\n<p>期望与你一起遇见更好的自己</p>\n<p><img data-src=\"/images/qrcode.jpg\" alt=\"期望与你一起遇见更好的自己\"></p>\n",
            "tags": [
                "Redis"
            ]
        },
        {
            "id": "https://fangjiaxiaobai.github.io/2021/08/01/Redis%E7%B3%BB%E5%88%97/01-%E5%AE%89%E8%A3%85%E5%8D%95%E6%9C%BA%E7%89%88Redis/",
            "url": "https://fangjiaxiaobai.github.io/2021/08/01/Redis%E7%B3%BB%E5%88%97/01-%E5%AE%89%E8%A3%85%E5%8D%95%E6%9C%BA%E7%89%88Redis/",
            "title": "Redis的单机部署",
            "date_published": "2021-08-01T06:38:55.000Z",
            "content_html": "<h1 id=\"源码安装\"><a class=\"markdownIt-Anchor\" href=\"#源码安装\">#</a> 源码安装</h1>\n<h2 id=\"下载地址\"><a class=\"markdownIt-Anchor\" href=\"#下载地址\">#</a> 下载地址</h2>\n<p><span class=\"exturl\" data-url=\"aHR0cDovL2Rvd25sb2FkLnJlZGlzLmlvL3JlbGVhc2VzL3JlZGlzLTUuMC43LnRhci5neg==\">http://download.redis.io/releases/redis-5.0.7.tar.gz</span></p>\n<h2 id=\"安装步骤\"><a class=\"markdownIt-Anchor\" href=\"#安装步骤\">#</a> 安装步骤</h2>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">wget http://download.redis.io/releases/redis-5.0.7.tar.gz</span><br><span class=\"line\"></span><br><span class=\"line\">tar xvf redis-5.0.7.tar.gz</span><br><span class=\"line\"></span><br><span class=\"line\">[root@fangjiaxiaobai <span class=\"built_in\">local</span>]<span class=\"comment\"># cd ./redis-5.0.7/</span></span><br><span class=\"line\">[root@fangjiaxiaobai redis-5.0.7]<span class=\"comment\"># make &amp;&amp; make install</span></span><br><span class=\"line\"></span><br><span class=\"line\">Hint: It<span class=\"string\">&#x27;s a good idea to run &#x27;</span>make <span class=\"built_in\">test</span><span class=\"string\">&#x27; ;)</span></span><br><span class=\"line\"><span class=\"string\"># 出现上面的提示代表成功了</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"可能出现以下错误\"><a class=\"markdownIt-Anchor\" href=\"#可能出现以下错误\">#</a> 可能出现以下错误:</h3>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">/bin/sh: cc: <span class=\"built_in\">command</span> not found</span><br><span class=\"line\">解决方案: yum install gcc</span><br><span class=\"line\"></span><br><span class=\"line\">jemalloc/jemalloc.h: No such file or directory</span><br><span class=\"line\">原因是jemalloc重载了Linux下的ANSI C的malloc和free函数。解决办法：make时添加参数。</span><br><span class=\"line\"></span><br><span class=\"line\">解决方案: make MALLOC=libc</span><br></pre></td></tr></table></figure>\n<h3 id=\"启动\"><a class=\"markdownIt-Anchor\" href=\"#启动\">#</a> 启动</h3>\n<p>[root@fangjiaxiaobai ~]# cd /usr/local/redis-5.0.7/src/</p>\n<p>[root@fangjiaxiaobai init.d]# ./redis_6379 start</p>\n<h3 id=\"关闭\"><a class=\"markdownIt-Anchor\" href=\"#关闭\">#</a> 关闭</h3>\n<p>[root@fangjiaxiaobai src]# ./redis-cli -p 6379 shutdown</p>\n<h2 id=\"最后\"><a class=\"markdownIt-Anchor\" href=\"#最后\">#</a> 最后</h2>\n<p>期望与你一起遇见更好的自己</p>\n<p><img data-src=\"/images/qrcode.jpg\" alt=\"期望与你一起遇见更好的自己\"></p>\n",
            "tags": [
                "Redis"
            ]
        },
        {
            "id": "https://fangjiaxiaobai.github.io/2021/07/24/MySQL%E7%B3%BB%E5%88%97/%E6%95%B0%E6%8D%AE%E5%BA%931-01.%E6%95%B0%E6%8D%AE%E5%BA%93%E7%9A%84%E7%89%88%E6%9C%AC/",
            "url": "https://fangjiaxiaobai.github.io/2021/07/24/MySQL%E7%B3%BB%E5%88%97/%E6%95%B0%E6%8D%AE%E5%BA%931-01.%E6%95%B0%E6%8D%AE%E5%BA%93%E7%9A%84%E7%89%88%E6%9C%AC/",
            "title": "MySQL数据库的版本",
            "date_published": "2021-07-24T06:48:55.000Z",
            "content_html": "<h2 id=\"mysql数据库的版本\"><a class=\"markdownIt-Anchor\" href=\"#mysql数据库的版本\">#</a>  <code>MySQL</code>  数据库的版本</h2>\n<p><code>mysql-5.0</code>   :   <code>mysql-5.0</code>  版本之前， <code>myisam</code>  默认支持的表大小为 <code>4G</code> 。从 <code>mysql-5.0</code>  以后， <code>MyISAM</code>  默认支持 <code>256T</code>  的表单数据。 <code>myisam</code>  只缓存索引数据。  <code>2005</code>  年的 <code>5.0</code>  版本又添加了存储过程、服务端游标、触发器、查询优化以及分布式事务功能。</p>\n<p><code>MySQL5.1</code>   :   <code>2008</code>  年发布的 <code>MySQL 5.1</code>  的版本，基本上就是一个增加了崩溃恢复功能的 <code>MyISAM</code> ，使用表级锁，但可以做到读写不冲突，即在进行任何类型的更新操作的同时都可以进行读操作，但多个写操作不能并发。</p>\n<p><code>mysql5.5</code>  :   <code>2010</code>  年 <code>12</code>  月发布 <code>mysql5.5</code>  版本默认存储引擎更改为 <code>InnoDB</code>  多个回滚段（ <code>Multiple Rollback Segments</code> ）, 之前的 <code>innodb</code>  版本最大能处理 <code>1023</code>  个并发处理操作，现在 <code>mysql5.5</code>  可以处理高达 128K 的并发事务，改善事务处理中的元数据锁定。例如，事物中一个语句需要锁一个表，会在事物结束时释放这个表，而不是像以前在语句结束时释放表。 增加了 <code>INFORMATION_SCHEMA</code>  表，新的表提供了与 InnoDB 压缩和事务处理锁定有关的具体信息。</p>\n<h3 id=\"mysql56\"><a class=\"markdownIt-Anchor\" href=\"#mysql56\">#</a> mysql5.6</h3>\n<p><code>2013</code>  年 <code>2</code>  月发布。</p>\n<ul>\n<li>\n<p>安全性进行了加强。用户的账号和密码进行了更强的加密算法，使用 <code>sha256_passwordSHA-256</code>  密码哈希的身份验证插件来进行加密。 <code>mysql.user</code>  表中新增了 <code>password_expired</code>  字段，过期后，所有连接的执行都会报出异常。</p>\n</li>\n<li>\n<p><code>MySQL Server</code>  的参数默认值进行了更改。如下图所示:</p>\n</li>\n</ul>\n<p><img data-src=\"/images/MySQL%E7%B3%BB%E5%88%97/10101-MySQL5.6Server%E7%AB%AF%E5%8F%82%E6%95%B0%E4%BF%AE%E6%94%B9%E7%9A%84%E9%BB%98%E8%AE%A4%E5%80%BC.png\" alt=\"10101-MySQL5.6Server端参数修改的默认值.png\"></p>\n<ul>\n<li>\n<p><code>mysql5.6</code>  版本中 <code>InnoDB</code>  可以限制大量表打开的时候内存占用过多的问题 <code>InnoDB</code>  性能加强。如大内存优化等 <code>InnoDB</code>  死锁信息可以记录到  <code>error</code>  日志，<br>\n<b> <code>InnoDB</code>  引擎也支持了 <code>FULLTEXT</code>  索引</b>。并使用 <code>MATCH() ... AGAINST</code>  语法查询它们。 <code>ALTER TABLE </code> 在不复制表，不阻止对表的插入，更新和删除或两者都不进行的情况下，可以执行多种操作。<b> <code>InnoDB</code>  使用更快的新算法来检测 死锁</b></p>\n</li>\n<li>\n<p>分区功能</p>\n<ul>\n<li>分区的最大数量增加到 <code>8192</code> 。此数量包括表的所有分区和所有子分区。</li>\n</ul>\n</li>\n<li>\n<p>复制和日志记录</p>\n<ul>\n<li><code>MySQL</code>  现在支持使用全局事务标识符（也称为  <code>GTID</code> ）进行基于事务的复制 。这样，当每个事务在原始服务器上提交并被任何从属服务器应用时，就可以识别和跟踪每个事务。</li>\n<li><code>MySQL</code>  基于行的复制从该版本开始支持行图像控制</li>\n</ul>\n</li>\n<li>\n<p>优化器增强功能</p>\n<ul>\n<li><code>limit</code>  查询进行了优化，如果 <code>N</code>  行元素小于排序缓冲区，那么就使用内存排序而不是合并文件。</li>\n<li>优化器可以更有效地处理 <code>FROM</code>  子句中的子查询 （即派生表）。FROM 子句中子查询的实现 被推迟到查询执行期间需要其内容时为止，从而提高了性能。在查询执行期间，优化器可以将索引添加到派生表中，以加快从中获取行的速度。</li>\n</ul>\n</li>\n<li>\n<p>数据类型</p>\n<ul>\n<li><code>MySQL</code>  从 <code>5.6</code>  开始允许 <code>TIME</code> ， <code>DATETIME</code>  和 <code>TIMESTAMP</code>  值的小数秒，精度高达微秒（ <code>6</code>  位）。\n<ul>\n<li>取消了每个表最多可以自动将 <code>TIMESTAMP</code>  列初始化或更新为当前日期和时间的限制。任何 <code>TIMESTAMP</code>  列定义都可以具有 <code>DEFAULT CURRENT_TIMESTAMP</code>  和 <code>ON UPDATE CURRENT_TIMESTAMP</code>  子句的任意组合。此外，这些子句现在可以与 DATETIME 列定义一起使用。</li>\n</ul>\n</li>\n</ul>\n</li>\n<li>\n<p>主机缓存。<br>\n <code>MySQL</code>  现在提供有关客户端连接到服务器时发生错误的原因的更多信息，以及对主机缓存的改进访问，该缓存包含客户端 <code>IP</code>  地址和主机名信息，用于避免 <code>DNS</code>  查找。</p>\n</li>\n</ul>\n<h3 id=\"mysql57\"><a class=\"markdownIt-Anchor\" href=\"#mysql57\">#</a> mysql5.7</h3>\n<ul>\n<li>\n<p>将  <code>Undo</code>  从共享表空间  <code>ibdata</code>  文件中分离出来，可以在安装  <code>MySQL</code>  时由用户自行指定文件大小和数量。</p>\n</li>\n<li>\n<p>增加了  <code>temporary</code>  临时表空间，里面存储着临时表或临时查询结果集的数据。</p>\n</li>\n<li>\n<p><code>Buffer Pool</code>  大小可以动态修改，无需重启数据库实例，这是  <code>DBA</code>  的福音。</p>\n</li>\n</ul>\n<h3 id=\"mysql-80-版本新特性如下\"><a class=\"markdownIt-Anchor\" href=\"#mysql-80-版本新特性如下\">#</a> MySQL 8.0 版本新特性如下：</h3>\n<ul>\n<li>\n<p>将  <code>InnoDB</code>  表的数据字典和  <code>Undo</code>  都从共享表空间  <code>ibdata</code>  中彻底分离出来了，以前需要 <code>ibdata</code>  文件中数据字典与独立表空间  <code>ibd</code>  文件中数据字典一致才行， <code>8.0</code>  版本就不需要了。</p>\n</li>\n<li>\n<p><code>temporary</code>  临时表空间也可以配置多个物理文件，而且均为  <code>InnoDB</code>  存储引擎并能创建索引，这样加快了处理的速度。</p>\n</li>\n<li>\n<p>用户可以像  <code>Oracle</code>  数据库那样设置一些表空间，每个表空间对应多个物理文件，每个表空间可以给多个表使用，但一个表只能存储在一个表空间中。</p>\n</li>\n</ul>\n<h2 id=\"最后\"><a class=\"markdownIt-Anchor\" href=\"#最后\">#</a> 最后</h2>\n<p>期望与你一起遇见更好的自己</p>\n<p><img data-src=\"/images/qrcode.jpg\" alt=\"期望与你一起遇见更好的自己\"></p>\n",
            "tags": [
                "MySQL"
            ]
        },
        {
            "id": "https://fangjiaxiaobai.github.io/2021/07/23/MySQL%E7%B3%BB%E5%88%97/%E6%95%B0%E6%8D%AE%E5%BA%930-00.%E8%AF%B4%E6%98%8E/",
            "url": "https://fangjiaxiaobai.github.io/2021/07/23/MySQL%E7%B3%BB%E5%88%97/%E6%95%B0%E6%8D%AE%E5%BA%930-00.%E8%AF%B4%E6%98%8E/",
            "title": "MySQL 开篇 & 说明",
            "date_published": "2021-07-23T06:48:55.000Z",
            "content_html": "<h2 id=\"版本说明\"><a class=\"markdownIt-Anchor\" href=\"#版本说明\">#</a> 版本说明</h2>\n<p>本系列文章，以 MySQL 8.0.20 版本为实验背景进行编写。</p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9kZXYubXlzcWwuY29tL2RvYy9pbnRlcm5hbHMvZW4vYmluYXJ5LWxvZy1vdmVydmlldy5odG1s\">MySQL 手册</span></p>\n<h2 id=\"最后\"><a class=\"markdownIt-Anchor\" href=\"#最后\">#</a> 最后</h2>\n<p>期望与你一起遇见更好的自己</p>\n<p><img data-src=\"/images/qrcode.jpg\" alt=\"期望与你一起遇见更好的自己\"></p>\n",
            "tags": [
                "MySQL"
            ]
        },
        {
            "id": "https://fangjiaxiaobai.github.io/2021/07/23/Redis%E7%B3%BB%E5%88%97/00-%E5%89%8D%E8%A8%80/",
            "url": "https://fangjiaxiaobai.github.io/2021/07/23/Redis%E7%B3%BB%E5%88%97/00-%E5%89%8D%E8%A8%80/",
            "title": "Redis 开篇杂谈",
            "date_published": "2021-07-23T06:28:55.000Z",
            "content_html": "<h2 id=\"杂谈\"><a class=\"markdownIt-Anchor\" href=\"#杂谈\">#</a> 杂谈</h2>\n<p>这里说些杂谈吧。</p>\n<p>以下的文章中，同一个名词并非代表的是同一种对象。比如 list。</p>\n<p>在 t_list.c 中，list 的表示的 面向于用户的 Redis 数据结构 List (列表)。而在 adlsit.c 中表示的 Redis 数据结构的底层实现 list (其实是链表这种数据结构 - 此处的数据结构，表示真实的数据结构)。</p>\n<h2 id=\"最后\"><a class=\"markdownIt-Anchor\" href=\"#最后\">#</a> 最后</h2>\n<p>期望与你一起遇见更好的自己</p>\n<p><img data-src=\"/images/qrcode.jpg\" alt=\"期望与你一起遇见更好的自己\"></p>\n",
            "tags": [
                "Redis"
            ]
        },
        {
            "id": "https://fangjiaxiaobai.github.io/2021/07/23/Redis%E7%B3%BB%E5%88%97/00-%E7%9B%AE%E5%BD%95/",
            "url": "https://fangjiaxiaobai.github.io/2021/07/23/Redis%E7%B3%BB%E5%88%97/00-%E7%9B%AE%E5%BD%95/",
            "title": "Redis 开篇 & 说明",
            "date_published": "2021-07-23T06:18:55.000Z",
            "content_html": "<p>本系列学习笔记以  <code>redis5.0.7</code>  版本为基础进行学习.</p>\n<ul>\n<li><code>2021-07-21 Redis 6.0.6</code></li>\n<li><code>2019-12-19 Redis 6.x</code>  开始发布，具体内容: <span class=\"exturl\" data-url=\"aHR0cHM6Ly9yYXcuZ2l0aHVidXNlcmNvbnRlbnQuY29tL2FudGlyZXovcmVkaXMvNi4wLzAwLVJFTEVBU0VOT1RFUw==\">Redis 6.x 版本发布明细</span></li>\n</ul>\n<h2 id=\"开篇说明\"><a class=\"markdownIt-Anchor\" href=\"#开篇说明\">#</a> 开篇 &amp; 说明</h2>\n<ul>\n<li><a href=\"/2021/07/23/Redis%E7%B3%BB%E5%88%97/00-%E5%89%8D%E8%A8%80/\">Redis 开篇 &amp; 说明 </a></li>\n</ul>\n<h2 id=\"新手入门\"><a class=\"markdownIt-Anchor\" href=\"#新手入门\">#</a> 新手入门</h2>\n<h3 id=\"基础概念\"><a class=\"markdownIt-Anchor\" href=\"#基础概念\">#</a> 基础概念</h3>\n<ul class=\"task-list\">\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"cbx_0\" checked=\"true\" disabled=\"true\"><label for=\"cbx_0\"> <a href=\"/2021/08/01/Redis%E7%B3%BB%E5%88%97/01-Redis%E7%AE%80%E4%BB%8B%E4%BB%A5%E5%8F%8A%E4%B8%8E%E5%85%B6%E4%BB%96%E6%95%B0%E6%8D%AE%E5%BA%93%E7%9A%84%E5%AF%B9%E6%AF%94/\">Redis 简介及其他数据库对比</a></label></li>\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"cbx_1\" checked=\"true\" disabled=\"true\"><label for=\"cbx_1\"> <a href=\"/2021/08/01/Redis%E7%B3%BB%E5%88%97/02-Redis%E7%9A%84%E5%A4%9A%E4%B8%AA%E6%95%B0%E6%8D%AE%E5%BA%93/\">Redis 的多个数据库</a></label></li>\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"cbx_2\" checked=\"true\" disabled=\"true\"><label for=\"cbx_2\"> <a href=\"/2021/08/01/Redis%E7%B3%BB%E5%88%97/01-%E5%AE%89%E8%A3%85%E5%8D%95%E6%9C%BA%E7%89%88Redis/\">Redis 的单机部署</a></label></li>\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"cbx_3\" disabled=\"true\"><label for=\"cbx_3\"> Redis 的集群部署 (源码安装 /docker 安装)</label></li>\n</ul>\n<h3 id=\"五种常用的数据类型\"><a class=\"markdownIt-Anchor\" href=\"#五种常用的数据类型\">#</a> 五种常用的数据类型</h3>\n<blockquote>\n<p>常用的命令以及浅浅的了解内部结构。</p>\n</blockquote>\n<ul class=\"task-list\">\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"cbx_4\" checked=\"true\" disabled=\"true\"><label for=\"cbx_4\"> <a href=\"/2021/08/01/Redis%E7%B3%BB%E5%88%97/B-1-Redis%E7%9A%84%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B%E4%B9%8BString/\">Redis 数据结构之  <code>String</code> </a></label></li>\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"cbx_5\" checked=\"true\" disabled=\"true\"><label for=\"cbx_5\"> <a href=\"/2021/08/01/Redis%E7%B3%BB%E5%88%97/B-2-Redis%E7%9A%84%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B%E4%B9%8Blist/\">Redis 数据结构之  <code>List</code> </a></label></li>\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"cbx_6\" checked=\"true\" disabled=\"true\"><label for=\"cbx_6\"> <a href=\"/2021/08/01/Redis%E7%B3%BB%E5%88%97/B-3-Redis%E7%9A%84%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B%E4%B9%8Bhash/\">Redis 数据结构之  <code>Hash</code> </a></label></li>\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"cbx_7\" checked=\"true\" disabled=\"true\"><label for=\"cbx_7\"> <a href=\"/2021/08/01/Redis%E7%B3%BB%E5%88%97/B-4-Redis%E7%9A%84%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B%E4%B9%8B%E9%9B%86%E5%90%88set/\">Redis 数据结构之集合  <code>Set</code> </a></label></li>\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"cbx_8\" checked=\"true\" disabled=\"true\"><label for=\"cbx_8\"> <a href=\"/2021/08/01/Redis%E7%B3%BB%E5%88%97/B-5-Redis%E7%9A%84%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B%E4%B9%8B%E6%9C%89%E5%BA%8F%E9%9B%86%E5%90%88zset/\">Redis 数据结构之有序集合  <code>Zset</code> </a></label></li>\n</ul>\n<h3 id=\"知道会很牛逼的数据类型\"><a class=\"markdownIt-Anchor\" href=\"#知道会很牛逼的数据类型\">#</a> 知道会很牛逼的数据类型</h3>\n<blockquote>\n<p>常用的命令以及浅浅的了解内部结构。</p>\n</blockquote>\n<ul class=\"task-list\">\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"cbx_9\" checked=\"true\" disabled=\"true\"><label for=\"cbx_9\"> <a href=\"/2021/08/01/Redis%E7%B3%BB%E5%88%97/B-6-Redis%E7%9A%84%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B%E4%B9%8B%E4%BD%8D%E5%9B%BEbitmap/\">Redis 数据结构之位图  <code>BitMap</code> </a></label></li>\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"cbx_10\" checked=\"true\" disabled=\"true\"><label for=\"cbx_10\"> <a href=\"/2021/08/01/Redis%E7%B3%BB%E5%88%97/B-7-Redis%E7%9A%84%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B%E4%B9%8BHyperLogLogs/\">Redis 数据结构之  <code>HyperLogLogs</code> </a></label></li>\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"cbx_11\" disabled=\"true\"><label for=\"cbx_11\"> GeoHash</label></li>\n</ul>\n<h3 id=\"其他命令\"><a class=\"markdownIt-Anchor\" href=\"#其他命令\">#</a> 其他命令</h3>\n<blockquote>\n<p>除了基本的数据结构之外的 <code>Redis</code>  的命令。</p>\n</blockquote>\n<ul class=\"task-list\">\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"cbx_12\" disabled=\"true\"><label for=\"cbx_12\"> help</label></li>\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"cbx_13\" disabled=\"true\"><label for=\"cbx_13\"> auth</label></li>\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"cbx_14\" disabled=\"true\"><label for=\"cbx_14\"> scan</label></li>\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"cbx_15\" disabled=\"true\"><label for=\"cbx_15\"> keys</label></li>\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"cbx_16\" disabled=\"true\"><label for=\"cbx_16\"> select</label></li>\n</ul>\n<h2 id=\"内功心法\"><a class=\"markdownIt-Anchor\" href=\"#内功心法\">#</a> 内功心法</h2>\n<h3 id=\"redis中的数据结构\"><a class=\"markdownIt-Anchor\" href=\"#redis中的数据结构\">#</a> Redis 中的数据结构</h3>\n<blockquote>\n<p><code>Redis</code>  内部的数据结构详解</p>\n</blockquote>\n<ul class=\"task-list\">\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"cbx_17\" checked=\"true\" disabled=\"true\"><label for=\"cbx_17\"> <a href=\"/2021/08/02/Redis%E7%B3%BB%E5%88%97/C-4-%E8%B7%B3%E8%A1%A8/\">Redis 中的数据结构之跳表及其原理</a></label></li>\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"cbx_18\" checked=\"true\" disabled=\"true\"><label for=\"cbx_18\"> <a href=\"/2021/08/02/Redis%E7%B3%BB%E5%88%97/C-1-Redis%E7%9A%84%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B9%8Bziplist/\">Redis 数据结构之详解 <code>ziplist</code> </a></label></li>\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"cbx_19\" disabled=\"true\"><label for=\"cbx_19\"> intset</label></li>\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"cbx_20\" disabled=\"true\"><label for=\"cbx_20\"> dict</label></li>\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"cbx_21\" disabled=\"true\"><label for=\"cbx_21\"> skiplist</label></li>\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"cbx_22\" disabled=\"true\"><label for=\"cbx_22\"> module object</label></li>\n</ul>\n<blockquote>\n<p>高阶 <code>Redis</code>  使用，助力成为大牛</p>\n</blockquote>\n<ul class=\"task-list\">\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"cbx_23\" disabled=\"true\"><label for=\"cbx_23\"> Redis 的数据淘汰机制</label></li>\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"cbx_24\" disabled=\"true\"><label for=\"cbx_24\"> 持久化策略</label></li>\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"cbx_25\" disabled=\"true\"><label for=\"cbx_25\"> 主从复制</label></li>\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"cbx_26\" disabled=\"true\"><label for=\"cbx_26\"> 事务机制</label></li>\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"cbx_27\" disabled=\"true\"><label for=\"cbx_27\"> 哨兵机制</label></li>\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"cbx_28\" disabled=\"true\"><label for=\"cbx_28\"> 监察器</label></li>\n</ul>\n<h2 id=\"实战与应用\"><a class=\"markdownIt-Anchor\" href=\"#实战与应用\">#</a> 实战与应用</h2>\n<blockquote>\n<p>说的再多，不如动手练练</p>\n</blockquote>\n<ul class=\"task-list\">\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"cbx_29\" disabled=\"true\"><label for=\"cbx_29\"> Redis 实现分布式锁。</label></li>\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"cbx_30\" disabled=\"true\"><label for=\"cbx_30\"> Redis 实现发布订阅模式</label></li>\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"cbx_31\" disabled=\"true\"><label for=\"cbx_31\"> 布隆过滤器</label></li>\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"cbx_32\" disabled=\"true\"><label for=\"cbx_32\"> 限流实例</label></li>\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"cbx_33\" disabled=\"true\"><label for=\"cbx_33\"> 延时队列</label></li>\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"cbx_34\" disabled=\"true\"><label for=\"cbx_34\"> 统计 PV</label></li>\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"cbx_35\" disabled=\"true\"><label for=\"cbx_35\"> 限流</label></li>\n</ul>\n<h2 id=\"运维\"><a class=\"markdownIt-Anchor\" href=\"#运维\">#</a> 运维</h2>\n<blockquote>\n<p>不让别人擦屁股</p>\n</blockquote>\n<ul class=\"task-list\">\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"cbx_36\" disabled=\"true\"><label for=\"cbx_36\"> 配置文件详解</label></li>\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"cbx_37\" disabled=\"true\"><label for=\"cbx_37\"> 数据持久化</label></li>\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"cbx_38\" disabled=\"true\"><label for=\"cbx_38\"> 数据迁移</label></li>\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"cbx_39\" disabled=\"true\"><label for=\"cbx_39\"> 再谈集群</label></li>\n</ul>\n<h2 id=\"其他\"><a class=\"markdownIt-Anchor\" href=\"#其他\">#</a> 其他</h2>\n<blockquote>\n<p>不仅要有内涵，更要有颜值。</p>\n</blockquote>\n<ul class=\"task-list\">\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"cbx_40\" disabled=\"true\"><label for=\"cbx_40\">  <code>Redis</code>  面试题</label></li>\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"cbx_41\" disabled=\"true\"><label for=\"cbx_41\">  <code>Redis</code>  为什么这么快</label></li>\n</ul>\n<h2 id=\"学习路线图\"><a class=\"markdownIt-Anchor\" href=\"#学习路线图\">#</a> 学习路线图</h2>\n<blockquote>\n<p>这里是灯塔。</p>\n</blockquote>\n<ul class=\"task-list\">\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"cbx_42\" disabled=\"true\"><label for=\"cbx_42\"> 路线图</label></li>\n</ul>\n<h2 id=\"最后\"><a class=\"markdownIt-Anchor\" href=\"#最后\">#</a> 最后</h2>\n<p>期望与你一起遇见更好的自己</p>\n<p><img data-src=\"/images/qrcode.jpg\" alt=\"期望与你一起遇见更好的自己\"></p>\n",
            "tags": [
                "目录",
                "Redis"
            ]
        },
        {
            "id": "https://fangjiaxiaobai.github.io/2021/07/18/RoadMap/",
            "url": "https://fangjiaxiaobai.github.io/2021/07/18/RoadMap/",
            "title": "全站地图",
            "date_published": "2021-07-18T12:49:55.000Z",
            "content_html": "<details class=\"danger\"><summary>推荐&必看</summary><div>\n<div class=\"tab\" data-id=\"mustlook\" data-title=\"近日上新\">\n<ul class=\"task-list\">\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"cbx_0\" checked=\"true\" disabled=\"true\"><label for=\"cbx_0\"> <a href=\"/2021/08/29/LeetCode/002-%E5%8F%8D%E8%BD%AC%E9%93%BE%E8%A1%A8/\">🍺 LC: 反转链表 I</a></label></li>\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"cbx_1\" checked=\"true\" disabled=\"true\"><label for=\"cbx_1\"> <a href=\"/2021/08/23/java%E7%B3%BB%E5%88%97/JDK/stream/Stream-basic/\">🍺 JDK 的 Stream 之系列一 初窥流原理</a></label></li>\n</ul>\n</div>\n<div class=\"tab\" data-id=\"mustlook\" data-title=\"即将上架\">\n<ul class=\"task-list\">\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"cbx_2\" disabled=\"true\"><label for=\"cbx_2\"> <a href=\"\">👉 聊聊面试那点事儿 👈    🤙9 月初</a></label></li>\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"cbx_3\" disabled=\"true\"><label for=\"cbx_3\"> <a href=\"\">👉 JDK 的 Stream 之系列二 Stream 的并行流处理👈  🤙9 月初</a></label></li>\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"cbx_4\" disabled=\"true\"><label for=\"cbx_4\"> <a href=\"\">👉 JDK 的 Thread 系列👈  🤙9 月底</a></label></li>\n</ul>\n</div>\n<div class=\"tab\" data-id=\"mustlook\" data-title=\"极力推荐\">\n<ul class=\"task-list\">\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"cbx_5\" disabled=\"true\"><label for=\"cbx_5\"> <a href=\"/images/promotions/Redis%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90%E4%B8%8E%E5%AE%9E%E6%88%98.jpg\">Redis 源码剖析和解析</a></label></li>\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"cbx_6\" disabled=\"true\"><label for=\"cbx_6\"> <a href=\"/promotions/geekbang/\">全部课程</a></label></li>\n</ul>\n</div>\n</div></details>\n<details class=\"success\"><summary>Java系列</summary><div>\n<div class=\"tab\" data-id=\"java\" data-title=\"JDK原理&源码\">\n<ul class=\"task-list\">\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"cbx_7\" checked=\"true\" disabled=\"true\"><label for=\"cbx_7\"> <a href=\"/2021/07/15/JDK%E6%BA%90%E7%A0%81/README/\">JDK 原理 &amp; 源码 目录</a></label></li>\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"cbx_8\" checked=\"true\" disabled=\"true\"><label for=\"cbx_8\"> <a href=\"/2021/08/23/java%E7%B3%BB%E5%88%97/JDK/stream/Stream-basic/\">JDK 的 Stream 之系列一 初窥流原理</a></label></li>\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"cbx_9\" checked=\"true\" disabled=\"true\"><label for=\"cbx_9\"> <a href=\"/2021/07/15/JDK%E6%BA%90%E7%A0%81/HashMap/HashMap/\">【HashMap】全网最全的 HashMap 源码解读</a></label></li>\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"cbx_10\" checked=\"true\" disabled=\"true\"><label for=\"cbx_10\"> <a href=\"/2021/07/15/JDK%E6%BA%90%E7%A0%81/HashMap/HashMap%E7%9A%84Hash%E5%87%BD%E6%95%B0%E5%88%B0%E5%BA%95%E6%9C%89%E4%BB%80%E4%B9%88%E6%84%8F%E4%B9%89/\">【HashMap】HashMap 的 Hash 函数到底有什么意义</a></label></li>\n</ul>\n</div>\n<div class=\"tab\" data-id=\"java\" data-title=\"JVM原理\">\n<ul class=\"task-list\">\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"cbx_11\" checked=\"true\" disabled=\"true\"><label for=\"cbx_11\"> <a href=\"/2021/08/19/java%E7%B3%BB%E5%88%97/JVM/OOM/\">JVM 之你没见过的 OOM</a></label></li>\n</ul>\n</div>\n</div></details>\n<details class=\"info\"><summary>刷题</summary><div>\n<ul class=\"task-list\">\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"cbx_12\" checked=\"true\" disabled=\"true\"><label for=\"cbx_12\"> <a href=\"/2021/08/19/LeetCode/001-%E5%8F%8D%E8%BD%AC%E6%95%B0%E7%BB%84/\">LC: 反转数组</a></label></li>\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"cbx_13\" checked=\"true\" disabled=\"true\"><label for=\"cbx_13\"> <a href=\"/2021/08/29/LeetCode/002-%E5%8F%8D%E8%BD%AC%E9%93%BE%E8%A1%A8/\">LC: 反转链表 I</a></label></li>\n</ul>\n</div></details>\n<details class=\"warning\"><summary>数据库系列</summary><div>\n<div class=\"tab\" data-id=\"db\" data-title=\"MySQL\">\n<ul class=\"task-list\">\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"cbx_14\" checked=\"true\" disabled=\"true\"><label for=\"cbx_14\"> <a href=\"/series/MySQL/\">MySQL 系列目录</a></label></li>\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"cbx_15\" checked=\"true\" disabled=\"true\"><label for=\"cbx_15\"> <a href=\"/2021/07/23/MySQL%E7%B3%BB%E5%88%97/%E6%95%B0%E6%8D%AE%E5%BA%930-00.%E8%AF%B4%E6%98%8E/\">MySQL 开篇 &amp; 说明</a></label></li>\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"cbx_16\" checked=\"true\" disabled=\"true\"><label for=\"cbx_16\"> <a href=\"/2021/07/24/MySQL%E7%B3%BB%E5%88%97/%E6%95%B0%E6%8D%AE%E5%BA%931-01.%E6%95%B0%E6%8D%AE%E5%BA%93%E7%9A%84%E7%89%88%E6%9C%AC/\">MySQL 数据库的版本</a></label></li>\n</ul>\n</div>\n<div class=\"tab\" data-id=\"db\" data-title=\"Redis\">\n<ul class=\"task-list\">\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"cbx_17\" checked=\"true\" disabled=\"true\"><label for=\"cbx_17\"> <a href=\"/2021/07/23/Redis%E7%B3%BB%E5%88%97/00-%E7%9B%AE%E5%BD%95/\">Redis 开篇 &amp; 说明 &amp; 目录</a></label></li>\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"cbx_18\" checked=\"true\" disabled=\"true\"><label for=\"cbx_18\"> <a href=\"/2021/08/01/Redis%E7%B3%BB%E5%88%97/01-Redis%E7%AE%80%E4%BB%8B%E4%BB%A5%E5%8F%8A%E4%B8%8E%E5%85%B6%E4%BB%96%E6%95%B0%E6%8D%AE%E5%BA%93%E7%9A%84%E5%AF%B9%E6%AF%94/\">Redis 简介及其他数据库对比</a></label></li>\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"cbx_19\" checked=\"true\" disabled=\"true\"><label for=\"cbx_19\"> <a href=\"/2021/08/01/Redis%E7%B3%BB%E5%88%97/02-Redis%E7%9A%84%E5%A4%9A%E4%B8%AA%E6%95%B0%E6%8D%AE%E5%BA%93/\">Redis 的多个数据库</a></label></li>\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"cbx_20\" checked=\"true\" disabled=\"true\"><label for=\"cbx_20\"> <a href=\"/2021/08/01/Redis%E7%B3%BB%E5%88%97/01-%E5%AE%89%E8%A3%85%E5%8D%95%E6%9C%BA%E7%89%88Redis/\">Redis 的单机部署</a></label></li>\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"cbx_21\" checked=\"true\" disabled=\"true\"><label for=\"cbx_21\"> <a href=\"/2021/08/01/Redis%E7%B3%BB%E5%88%97/B-1-Redis%E7%9A%84%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B%E4%B9%8BString/\">Redis 数据结构之 <code>String</code> </a></label></li>\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"cbx_22\" checked=\"true\" disabled=\"true\"><label for=\"cbx_22\"> <a href=\"/2021/08/01/Redis%E7%B3%BB%E5%88%97/B-2-Redis%E7%9A%84%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B%E4%B9%8Blist/\">Redis 数据结构之 <code>List</code> </a></label></li>\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"cbx_23\" checked=\"true\" disabled=\"true\"><label for=\"cbx_23\"> <a href=\"/2021/08/01/Redis%E7%B3%BB%E5%88%97/B-3-Redis%E7%9A%84%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B%E4%B9%8Bhash/\">Redis 数据结构之 <code>Hash</code> </a></label></li>\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"cbx_24\" checked=\"true\" disabled=\"true\"><label for=\"cbx_24\"> <a href=\"/2021/08/01/Redis%E7%B3%BB%E5%88%97/B-4-Redis%E7%9A%84%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B%E4%B9%8B%E9%9B%86%E5%90%88set/\">Redis 数据结构之集合 <code>Set</code> </a></label></li>\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"cbx_25\" checked=\"true\" disabled=\"true\"><label for=\"cbx_25\"> <a href=\"/2021/08/01/Redis%E7%B3%BB%E5%88%97/B-5-Redis%E7%9A%84%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B%E4%B9%8B%E6%9C%89%E5%BA%8F%E9%9B%86%E5%90%88zset/\">Redis 数据结构之有序集合 <code>Zset</code> </a></label></li>\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"cbx_26\" checked=\"true\" disabled=\"true\"><label for=\"cbx_26\"> <a href=\"/2021/08/01/Redis%E7%B3%BB%E5%88%97/B-6-Redis%E7%9A%84%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B%E4%B9%8B%E4%BD%8D%E5%9B%BEbitmap/\">Redis 数据结构之位图 <code>BitMap</code> </a></label></li>\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"cbx_27\" checked=\"true\" disabled=\"true\"><label for=\"cbx_27\"> <a href=\"/2021/08/01/Redis%E7%B3%BB%E5%88%97/B-7-Redis%E7%9A%84%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B%E4%B9%8BHyperLogLogs/\">Redis 数据结构之 <code>HyperLogLogs</code> </a></label></li>\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"cbx_28\" checked=\"true\" disabled=\"true\"><label for=\"cbx_28\"> <a href=\"/2021/08/02/Redis%E7%B3%BB%E5%88%97/C-4-%E8%B7%B3%E8%A1%A8/\">Redis 中的数据结构之跳表及其原理</a></label></li>\n</ul>\n</div>\n</div></details>\n<details class=\"primary\"><summary>Git系列</summary><div>\n<ul class=\"task-list\">\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"cbx_29\" checked=\"true\" disabled=\"true\"><label for=\"cbx_29\"> <a href=\"/2021/07/18/git%E7%B3%BB%E5%88%97/02-Git%E4%BB%8B%E7%BB%8D/\">git 介绍</a></label></li>\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"cbx_30\" checked=\"true\" disabled=\"true\"><label for=\"cbx_30\"> <a href=\"/2021/07/18/git%E7%B3%BB%E5%88%97/01-GIt%E5%AE%89%E8%A3%85/\">git 安装</a></label></li>\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"cbx_31\" checked=\"true\" disabled=\"true\"><label for=\"cbx_31\"> <a href=\"/2021/07/18/git%E7%B3%BB%E5%88%97/03-git%E5%91%BD%E4%BB%A4%E4%B9%8B%E4%BB%8E%E5%88%9B%E5%BB%BA%E4%BB%93%E5%BA%93%E5%BC%80%E5%A7%8B/\">从创建仓库开始</a></label></li>\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"cbx_32\" checked=\"true\" disabled=\"true\"><label for=\"cbx_32\"> <a href=\"/2021/07/18/git%E7%B3%BB%E5%88%97/04-git%E5%9F%BA%E6%9C%AC%E5%91%BD%E4%BB%A41/\">git 基本命令一</a></label></li>\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"cbx_33\" checked=\"true\" disabled=\"true\"><label for=\"cbx_33\"> <a href=\"/2021/07/18/git%E7%B3%BB%E5%88%97/05-git%E5%9F%BA%E6%9C%AC%E5%91%BD%E4%BB%A42%20git%E6%97%B6%E5%85%89%E6%9C%BA1/\">git 基本命令二</a></label></li>\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"cbx_34\" checked=\"true\" disabled=\"true\"><label for=\"cbx_34\"> <a href=\"/2021/07/18/git%E7%B3%BB%E5%88%97/06-git%E5%9F%BA%E6%9C%AC%E5%91%BD%E4%BB%A43-%E8%BF%9C%E7%A8%8B%E4%BB%93%E5%BA%93/\">git 基本命令三</a></label></li>\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"cbx_35\" checked=\"true\" disabled=\"true\"><label for=\"cbx_35\"> <a href=\"/2021/07/18/git%E7%B3%BB%E5%88%97/07-git%E5%9F%BA%E6%9C%AC%E5%91%BD%E4%BB%A44-%E6%A0%87%E7%AD%BE%E5%92%8C%E5%88%AB%E5%90%8D/\">git 基本命令四</a></label></li>\n</ul>\n</div></details>\n<details class=\"success\"><summary>搜索相关</summary><div>\n<div class=\"tab\" data-id=\"seach\" data-title=\"ElasticSearch\">\n<ul class=\"task-list\">\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"cbx_36\" checked=\"true\" disabled=\"true\"><label for=\"cbx_36\"> <a href=\"/2021/08/31/es-series/01.ES%E7%AE%80%E4%BB%8B/\">1.ES 简介</a></label></li>\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"cbx_37\" checked=\"true\" disabled=\"true\"><label for=\"cbx_37\"> <a href=\"/2021/08/31/es-series/02.ES%E5%AE%89%E8%A3%85/\">2.ES 栈安装</a></label></li>\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"cbx_38\" checked=\"true\" disabled=\"true\"><label for=\"cbx_38\"> <a href=\"/2021/08/31/es-series/03.ES%E9%85%8D%E7%BD%AE/\">3.ElasticSearch 配置</a></label></li>\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"cbx_39\" checked=\"true\" disabled=\"true\"><label for=\"cbx_39\"> <a href=\"/2021/08/31/es-series/04.ES%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5/\">4. 基本概念</a></label></li>\n</ul>\n</div>\n</div></details>\n<details class=\"danger\"><summary>数据结构与算法</summary><div>\n<div class=\"tab\" data-id=\"dss\" data-title=\"数据结构\">\n<ul class=\"task-list\">\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"cbx_40\" checked=\"true\" disabled=\"true\"><label for=\"cbx_40\"> <a href=\"/2021/08/02/Redis%E7%B3%BB%E5%88%97/C-4-%E8%B7%B3%E8%A1%A8/\">跳表</a></label></li>\n</ul>\n</div>\n<div class=\"tab\" data-id=\"dss\" data-title=\"排序\">\n<ul class=\"task-list\">\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"cbx_41\" disabled=\"true\"><label for=\"cbx_41\"> 补货中…</label></li>\n</ul>\n</div>\n<div class=\"tab\" data-id=\"dss\" data-title=\"查找\">\n<ul class=\"task-list\">\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"cbx_42\" disabled=\"true\"><label for=\"cbx_42\"> 补货中…</label></li>\n</ul>\n</div>\n<div class=\"tab\" data-id=\"dss\" data-title=\"动态规划\">\n<ul class=\"task-list\">\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"cbx_43\" disabled=\"true\"><label for=\"cbx_43\"> 补货中…</label></li>\n</ul>\n</div>\n<div class=\"tab\" data-id=\"dss\" data-title=\"背包\">\n<ul class=\"task-list\">\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"cbx_44\" disabled=\"true\"><label for=\"cbx_44\"> 补货中…</label></li>\n</ul>\n</div>\n<div class=\"tab\" data-id=\"dss\" data-title=\"贪心\">\n<ul class=\"task-list\">\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"cbx_45\" disabled=\"true\"><label for=\"cbx_45\"> 补货中…</label></li>\n</ul>\n</div>\n</div></details>\n<details class=\"warning\"><summary>面经</summary><div>\n<ul class=\"task-list\">\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"cbx_46\" disabled=\"true\"><label for=\"cbx_46\"> <a href=\"\">聊聊面试那点事儿</a></label></li>\n</ul>\n</div></details>\n<details class=\"info\"><summary>推广&推荐</summary><div>\n<div class=\"tab\" data-id=\"promotion\" data-title=\"极客时间\">\n<ul class=\"task-list\">\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"cbx_47\" disabled=\"true\"><label for=\"cbx_47\"> <a href=\"/images/promotions/Redis%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90%E4%B8%8E%E5%AE%9E%E6%88%98.jpg\">Redis 原理</a></label></li>\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"cbx_48\" disabled=\"true\"><label for=\"cbx_48\"> <a href=\"/promotions/geekbang/\">全部课程</a></label></li>\n</ul>\n</div>\n<div class=\"tab\" data-id=\"promotion\" data-title=\"科学上网\">\n<ul class=\"task-list\">\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"cbx_49\" disabled=\"true\"><label for=\"cbx_49\"> 补货中…</label></li>\n</ul>\n</div>\n<div class=\"tab\" data-id=\"promotion\" data-title=\"书籍\">\n<ul class=\"task-list\">\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"cbx_50\" disabled=\"true\"><label for=\"cbx_50\"> 补货中…</label></li>\n</ul>\n</div>\n</div></details>\n",
            "tags": [
                "全站地图",
                "导航",
                "目录"
            ]
        },
        {
            "id": "https://fangjiaxiaobai.github.io/2021/07/18/%E7%AE%97%E6%B3%95/SnowFlake/",
            "url": "https://fangjiaxiaobai.github.io/2021/07/18/%E7%AE%97%E6%B3%95/SnowFlake/",
            "title": "雪花算法",
            "date_published": "2021-07-18T12:49:55.000Z",
            "content_html": "<h3 id=\"介绍\"><a class=\"markdownIt-Anchor\" href=\"#介绍\">#</a> 介绍</h3>\n<p>雪花算法是  <code>twitter</code>  开源的由  <code>64</code>  位整数组成的分布式 <code>id</code> 。目的是在分布式系统中产生全局唯一且趋势递增的 <code>ID</code> 。</p>\n<p>其核心思想就是：<b>使用一个  <code>64 bit</code>  的  <code>long</code>  型的数字作为全局唯一  <code>id</code> 。在分布式系统中的应用十分广泛，且 <code>ID</code>  引入了时间戳，保持自增性且不重复。</b></p>\n<h3 id=\"雪花算法的结构\"><a class=\"markdownIt-Anchor\" href=\"#雪花算法的结构\">#</a> 雪花算法的结构</h3>\n<p><img data-src=\"/images/%E7%AE%97%E6%B3%95/snowFlake%E7%AE%97%E6%B3%95%E7%BB%93%E6%9E%84%E5%9B%BE.png\" alt=\"\"></p>\n<ul>\n<li>标识： 没有实际意义。一般都是 0，都是正数。</li>\n<li>时间戳：  <code>41 bit</code>  可以表示的数字多达  <code>2^41 - 1</code> ，也就是可以标识  <code>2 ^ 41 - 1</code>  个毫秒值，换算成年就是表示  <code>69</code>  年的时间。</li>\n<li>机器 id: 这里标识的是机器的唯一标识，一般由两部分构成： <code>机房id+机器id</code> 。一共 <code>10</code>  位，可以表示 <code>1024</code>  台机器。</li>\n<li>序列号：可以用这个  <code>12 bit</code>  代表的数字来区分同一个毫秒内的  <code>4096</code>  个不同的  <code>id</code> 。也就是同一毫秒内同一台机器所生成的最大 ID 数量为 <code>4096</code></li>\n</ul>\n<h3 id=\"雪花算法的工作流程\"><a class=\"markdownIt-Anchor\" href=\"#雪花算法的工作流程\">#</a> 雪花算法的工作流程</h3>\n<p>以一个简单的雪花算法工作流程来说。假设有一个服务假设要生成一个全局唯一 <code>id</code> ，那么就可以发送一个请求给部署了  <code>SnowFlake</code>  算法的系统，由这个  <code>SnowFlake</code>  算法系统来生成唯一  <code>id</code> 。这个  <code>SnowFlake</code>  算法系统首先肯定是知道自己所在的机器号，（假设机器 id 为 10bit）接着  <code>SnowFlake</code>  算法系统接收到这个请求之后，首先就会用二进制位运算的方式生成一个  <code>64 bit</code>  的  <code>long</code>  型  <code>id</code> ， <code>64</code>  个  <code>bit</code>  中的第一个  <code>bit</code>  是无意义的。接着用当前时间戳（单位到毫秒）占用 <code>41</code>  个  <code>bit</code> ，然后接着  <code>10</code>  个  <code>bit</code>  设置机器  <code>id</code> 。最后再判断一下，当前这台机房的这台机器上这一毫秒内，这是第几个请求，给这次生成  <code>id</code>  的请求累加一个序号，作为最后的  <code>12</code>  个  <code>bit</code> 。</p>\n<h3 id=\"雪花算法实现\"><a class=\"markdownIt-Anchor\" href=\"#雪花算法实现\">#</a> 雪花算法实现</h3>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br><span class=\"line\">171</span><br><span class=\"line\">172</span><br><span class=\"line\">173</span><br><span class=\"line\">174</span><br><span class=\"line\">175</span><br><span class=\"line\">176</span><br><span class=\"line\">177</span><br><span class=\"line\">178</span><br><span class=\"line\">179</span><br><span class=\"line\">180</span><br><span class=\"line\">181</span><br><span class=\"line\">182</span><br><span class=\"line\">183</span><br><span class=\"line\">184</span><br><span class=\"line\">185</span><br><span class=\"line\">186</span><br><span class=\"line\">187</span><br><span class=\"line\">188</span><br><span class=\"line\">189</span><br><span class=\"line\">190</span><br><span class=\"line\">191</span><br><span class=\"line\">192</span><br><span class=\"line\">193</span><br><span class=\"line\">194</span><br><span class=\"line\">195</span><br><span class=\"line\">196</span><br><span class=\"line\">197</span><br><span class=\"line\">198</span><br><span class=\"line\">199</span><br><span class=\"line\">200</span><br><span class=\"line\">201</span><br><span class=\"line\">202</span><br><span class=\"line\">203</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">package</span> com.fxb.algorithm;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * 雪花算法生成器</span></span><br><span class=\"line\"><span class=\"comment\"> * &lt;p&gt;</span></span><br><span class=\"line\"><span class=\"comment\"> * 1.todo: 可以指定不同数据位数。</span></span><br><span class=\"line\"><span class=\"comment\"> * 2.todo: 单例</span></span><br><span class=\"line\"><span class=\"comment\"> *</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@author</span> fangjiaxiaobai</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@date</span> 2020-10-24 23:51</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@since</span> 1.0</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">SnowFlakeGenerator</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 开始时间戳 (2015-01-01)</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> <span class=\"keyword\">static</span> <span class=\"keyword\">long</span> DEFAULT_TIMESTAMP = <span class=\"number\">1603556068000L</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 总位数</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> <span class=\"keyword\">static</span> <span class=\"keyword\">long</span> BITS_COUNT = <span class=\"number\">64L</span>;</span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 机器id所占的位数,</span></span><br><span class=\"line\"><span class=\"comment\">     * 默认是5位。最多支持31台机器</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> <span class=\"keyword\">static</span> <span class=\"keyword\">long</span> DEFAULT_WORKER_ID_BITS = <span class=\"number\">5L</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 数据中心id所占的位数</span></span><br><span class=\"line\"><span class=\"comment\">     * 可以理解为机房。默认是5位。</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> <span class=\"keyword\">static</span> <span class=\"keyword\">long</span> DEFAULT_DATA_CENTER_ID_BITS = <span class=\"number\">5L</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 序列在id中占的位数</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> <span class=\"keyword\">static</span> <span class=\"keyword\">long</span> DEFAULT_SEQUENCE_BITS = <span class=\"number\">12L</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 支持的最大机器id，结果是31 (这个移位算法可以很快的计算出几位二进制数所能表示的最大十进制数)</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> <span class=\"keyword\">static</span> <span class=\"keyword\">long</span> DEFAULT_MAX_WORKER_ID = ~(-<span class=\"number\">1L</span> &lt;&lt; DEFAULT_WORKER_ID_BITS);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 支持的数据中心数量</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> <span class=\"keyword\">static</span> <span class=\"keyword\">long</span> DEFAULT_MAX_DATA_CENTER_ID_BITS = ~(-<span class=\"number\">1L</span> &lt;&lt; DEFAULT_DATA_CENTER_ID_BITS);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 生成序列的掩码，这里为4095 (0b111111111111=0xfff=4095)</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> <span class=\"keyword\">static</span> <span class=\"keyword\">long</span> DEFAULT_SEQUENCE_MASK = ~(-<span class=\"number\">1L</span> &lt;&lt; DEFAULT_SEQUENCE_BITS);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 时间戳向左移22位(5+5+12)</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> <span class=\"keyword\">static</span> <span class=\"keyword\">long</span> DEFAULT_TIMESTAMP_LEFT_SHIFT = DEFAULT_SEQUENCE_BITS + DEFAULT_WORKER_ID_BITS + DEFAULT_DATA_CENTER_ID_BITS;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 数据标识id向左移17位(12+5)</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> <span class=\"keyword\">static</span> <span class=\"keyword\">long</span> DEFAULT_DATA_CENTER_ID_SHIFT = DEFAULT_SEQUENCE_BITS + DEFAULT_WORKER_ID_BITS;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * workId的位移</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> <span class=\"keyword\">static</span> <span class=\"keyword\">long</span> DEFAULT_WORKER_ID_SHIFT = DEFAULT_SEQUENCE_BITS;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 工作机器ID</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">long</span> workerId;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 数据中心ID</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">long</span> dataCenterId;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 支持的最大数据中心数</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">long</span> maxDataCenterId;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 支持的最大workerid数</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">long</span> maxWorkerId;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 序列号的位数</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> Long sequenceBits;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 序列号的掩码</span></span><br><span class=\"line\"><span class=\"comment\">     * 即，2^sequenceBits</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> Long sequenceMask;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 毫秒内序列</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">long</span> sequence = <span class=\"number\">0L</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 上次生成ID的时间戳</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">long</span> lastTimestamp = -<span class=\"number\">1L</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">long</span> dataCenterIdShift;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">long</span> workerIdShift;</span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 时间戳的位数</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">long</span> timestampLeftShift;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 默认 每个数据中心可以容纳31台机器</span></span><br><span class=\"line\"><span class=\"comment\">     *</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> workerId     工作ID</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> dataCenterId 数据中心ID</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">SnowFlakeGenerator</span><span class=\"params\">(<span class=\"keyword\">long</span> workerId, <span class=\"keyword\">long</span> dataCenterId)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"comment\">//...</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 根据自己的配置决定容纳的机器数</span></span><br><span class=\"line\"><span class=\"comment\">     *</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> workerId         工作机器的id</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> dataCenterId     数据中心的id</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> workerIdBits     工作机占的位数</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> dataCenterIdBits 数据中心占的位数</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">SnowFlakeGenerator</span><span class=\"params\">(<span class=\"keyword\">long</span> workerId, <span class=\"keyword\">long</span> dataCenterId, <span class=\"keyword\">long</span> workerIdBits, <span class=\"keyword\">long</span> dataCenterIdBits)</span> </span>&#123;</span><br><span class=\"line\">      <span class=\"comment\">// ...</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 获得下一个ID (该方法是线程安全的)</span></span><br><span class=\"line\"><span class=\"comment\">     *</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@return</span> SnowflakeId</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">synchronized</span> <span class=\"keyword\">long</span> <span class=\"title\">nextId</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">long</span> currentTimestamp = getCurrentTimeStamp();</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">//如果当前时间小于上一次ID生成的时间戳，说明系统时钟回退过这个时候应当抛出异常</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span>(currentTimestamp &lt; lastTimestamp) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> RuntimeException(</span><br><span class=\"line\">                    String.format(<span class=\"string\">&quot;Clock moved backwards.  Refusing to generate id for %d milliseconds&quot;</span>, lastTimestamp - currentTimestamp));</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">//如果是同一时间生成的，则进行毫秒内序列</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span>(lastTimestamp == currentTimestamp) &#123;</span><br><span class=\"line\">            sequence = (sequence + <span class=\"number\">1</span>) &amp; sequenceMask;</span><br><span class=\"line\">            <span class=\"comment\">//毫秒内序列溢出</span></span><br><span class=\"line\">            <span class=\"keyword\">if</span>(sequence == <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">                <span class=\"comment\">//阻塞到下一个毫秒,获得新的时间戳</span></span><br><span class=\"line\">                currentTimestamp = tilNextMillis(lastTimestamp);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"comment\">//时间戳改变，毫秒内序列重置</span></span><br><span class=\"line\">        <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">            sequence = <span class=\"number\">0L</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">//上次生成ID的时间戳</span></span><br><span class=\"line\">        lastTimestamp = currentTimestamp;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">//移位并通过或运算拼到一起组成64位的ID</span></span><br><span class=\"line\">        <span class=\"keyword\">return</span> ((currentTimestamp - DEFAULT_TIMESTAMP) &lt;&lt; timestampLeftShift)</span><br><span class=\"line\">                | (dataCenterId &lt;&lt; dataCenterIdShift)</span><br><span class=\"line\">                | (workerId &lt;&lt; workerIdShift)</span><br><span class=\"line\">                | sequence;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 阻塞到下一个毫秒，直到获得新的时间戳</span></span><br><span class=\"line\"><span class=\"comment\">     *</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> lastTimestamp 上次生成ID的时间戳</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@return</span> 当前时间戳</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">protected</span> <span class=\"keyword\">long</span> <span class=\"title\">tilNextMillis</span><span class=\"params\">(<span class=\"keyword\">long</span> lastTimestamp)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">long</span> timestamp = getCurrentTimeStamp();</span><br><span class=\"line\">        <span class=\"keyword\">while</span> (timestamp &lt;= lastTimestamp) &#123;</span><br><span class=\"line\">            timestamp = getCurrentTimeStamp();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> timestamp;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 获取当前时间</span></span><br><span class=\"line\"><span class=\"comment\">     *</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@return</span> 当前时间戳。</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">long</span> <span class=\"title\">getCurrentTimeStamp</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> System.currentTimeMillis();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>完整代码: <span class=\"exturl\" data-url=\"aHR0cDovL2R3ei5kYXRlL2NXbVI=\">http://dwz.date/cWmR</span></p>\n<p>公众号中回复 【雪花算法】，可以直接获取源码文件。</p>\n<h3 id=\"最后\"><a class=\"markdownIt-Anchor\" href=\"#最后\">#</a> 最后</h3>\n<p>期望与你一起遇见更好的自己</p>\n<p><img data-src=\"/images/qrcode.jpg\" alt=\"期望与你一起遇见更好的自己\"></p>\n",
            "tags": [
                "雪花算法",
                "算法"
            ]
        },
        {
            "id": "https://fangjiaxiaobai.github.io/2021/07/18/git%E7%B3%BB%E5%88%97/02-Git%E4%BB%8B%E7%BB%8D/",
            "url": "https://fangjiaxiaobai.github.io/2021/07/18/git%E7%B3%BB%E5%88%97/02-Git%E4%BB%8B%E7%BB%8D/",
            "title": "Git介绍",
            "date_published": "2021-07-18T06:49:55.000Z",
            "content_html": "<h2 id=\"git是目前最先进的版本控制管理系统-b\"><a class=\"markdownIt-Anchor\" href=\"#git是目前最先进的版本控制管理系统-b\">#</a>  <code>Git</code>  是目前最先进的版本控制管理系统。</b></h2>\n<p>本质上讲， <code>git</code>  是一个内容寻址文件系统。其核心部分是一个简单的键值对数据库 ( <code>key-value data store</code> ). 你可以想像 <code>git</code>  仓库中插入任意类型的内容，它会返回一个唯一的键，通过该键可以在任意时刻再次取回该内容。</p>\n<h2 id=\"git先进在哪里\"><a class=\"markdownIt-Anchor\" href=\"#git先进在哪里\">#</a>  <code>git</code>  先进在哪里？</h2>\n<ul>\n<li>\n<p>直接记录快照，而不是比较差异。<br>\n这也是 <code>git</code>  和其他版本管理系统的主要差别。其他版本管理系统 ( <code>CVS</code> , <code>Subversion</code> , <code>Perforce</code> , <code>Bazaar</code>  等) 存储各个版本之间，每个文件随时间逐渐累积的差异。这类版本管理系统称为 基于差异的版本控制。如下图:<br>\n<img data-src=\"/images/git%E7%B3%BB%E5%88%97/images/git%E4%BB%8B%E7%BB%8D01.png\" alt=\"git介绍01.png\"></p>\n<p><code>git</code>  则不然，当你提交更新或者保存项目状态的时候，它基本上就会对当时的全部文件创建一个快照并保存这个快照的索引。为了效率，如果没有没有修改， <code>git</code>  不再重新存储该文 <code>git</code>  件，而是只保留一个连接指向之前存储的文件。 <code>Git</code>  对待所管理的数据更像是一个快照流。如下图:<br>\n<img data-src=\"/images/git%E7%B3%BB%E5%88%97/images/git%E4%BB%8B%E7%BB%8D02.png\" alt=\"git介绍02.png\"></p>\n<p><b> <code>git</code>  更像是一个小型的文件系统，而不只是一个简单的 CVS。</b></p>\n</li>\n<li>\n<p><code>git</code>  近乎所有操作都在本地执行<br>\n这意味着不管有无网络，你都可以工作。没有网络的时候，你照常可以提交代码，等到有网的时候，在进行上传到远程仓库。而使用 <code>Subversion</code> ， <code>CVS</code>  的话，只能修改文件，但是不能提交。</p>\n</li>\n<li>\n<p><code>git</code>  保证完整性<br>\n <code>Git</code>  中所有的数据在存储前都计算校验和，然后以校验和来引用。这就是说， <code>Git</code>  会知道你所有的更改任何文件内容或者目录内容，这个是构成 git 哲学不可或缺的部分。 <code>Git</code>  使用计算校验和的机制叫做  <code>SHA-1</code>  散列 ( <code>hash</code> , 哈希)。这是一个由 <code>40</code>  个十六进制字符 ( <code>0-9</code>  和 <code>a-f</code> ) 组成的字符串，基于 Git 中文件的内容和目录结构计算出来的。 <code>Git</code>  数据库中保存的信息都是以文件内容的哈希值来索引数据，而不是文件名。</p>\n</li>\n<li>\n<p><code>Git</code>  一般都只添加数据<br>\n执行的所有的 <code>git</code>  操作，几乎只往数据库中添加数据。一旦你提交了快照到 <code>git</code>  中，就难以再丢失数据，特别是定期的推送到了远程仓库。</p>\n</li>\n</ul>\n<h2 id=\"git的三种状态\"><a class=\"markdownIt-Anchor\" href=\"#git的三种状态\">#</a>  <code>git</code>  的三种状态</h2>\n<p><code>git</code>  对文件的管理，有三种状态。</p>\n<ul>\n<li>已修改：表示修改了文件，但还没有保存到数据库中。</li>\n<li>已暂存：表示对一个已修改文件的当前版本做了标记，使之在下次提交的快照中。</li>\n<li>已提交：表示数据已经安全的保存到了本地的 git 数据库中。</li>\n</ul>\n<p>这三种状态分别代表了 <code>git</code>  的三个工作区。工作区，暂存区以及 <code>git</code>  目录 (版本库)。如下图</p>\n<p><img data-src=\"/images/git%E7%B3%BB%E5%88%97/images/git%E4%BB%8B%E7%BB%8D03.png\" alt=\"git介绍03\"></p>\n<p>工作区是对项目的某个版本独立提取出来的内容。这些从 <code>git</code>  仓库的压缩数据库中提取出来的文件，放在磁盘上供你使用或修改。</p>\n<p>暂存区是一个文件，保存了下次将要提交的文件列表信息。 <code>git</code>  中称为索引，不过一般都是称为暂存区。<br>\n <code>Git</code>  仓库目录指的就是 .git 目录 (.git)。下节就从创建仓库开始学起。</p>\n<h2 id=\"最后\"><a class=\"markdownIt-Anchor\" href=\"#最后\">#</a> 最后</h2>\n<p>期望与你一起遇见更好的自己</p>\n<p><img data-src=\"/images/qrcode.jpg\" alt=\"期望与你一起遇见更好的自己\"></p>\n",
            "tags": [
                "git"
            ]
        },
        {
            "id": "https://fangjiaxiaobai.github.io/2021/07/18/git%E7%B3%BB%E5%88%97/01-GIt%E5%AE%89%E8%A3%85/",
            "url": "https://fangjiaxiaobai.github.io/2021/07/18/git%E7%B3%BB%E5%88%97/01-GIt%E5%AE%89%E8%A3%85/",
            "title": "安装git",
            "date_published": "2021-07-18T06:49:55.000Z",
            "content_html": "<h3 id=\"windows下安装\"><a class=\"markdownIt-Anchor\" href=\"#windows下安装\">#</a> windows 下安装</h3>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuZ29vZ2xlLmNvbS5oay8/Z3dzX3JkPXNzbA==\">here</span></p>\n<h3 id=\"linux下安装\"><a class=\"markdownIt-Anchor\" href=\"#linux下安装\">#</a> linux 下安装</h3>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuZ29vZ2xlLmNvbS5oay8/Z3dzX3JkPXNzbA==\">here</span></p>\n<h3 id=\"mac下安装\"><a class=\"markdownIt-Anchor\" href=\"#mac下安装\">#</a> mac 下安装</h3>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuZ29vZ2xlLmNvbS5oay8/Z3dzX3JkPXNzbA==\">here</span></p>\n<h3 id=\"最后\"><a class=\"markdownIt-Anchor\" href=\"#最后\">#</a> 最后</h3>\n<p>期望与你一起遇见更好的自己</p>\n<p><img data-src=\"/images/qrcode.jpg\" alt=\"期望与你一起遇见更好的自己\"></p>\n",
            "tags": [
                "git"
            ]
        },
        {
            "id": "https://fangjiaxiaobai.github.io/2021/07/18/git%E7%B3%BB%E5%88%97/04-git%E5%9F%BA%E6%9C%AC%E5%91%BD%E4%BB%A41/",
            "url": "https://fangjiaxiaobai.github.io/2021/07/18/git%E7%B3%BB%E5%88%97/04-git%E5%9F%BA%E6%9C%AC%E5%91%BD%E4%BB%A41/",
            "title": "git基本使用一",
            "date_published": "2021-07-18T06:49:55.000Z",
            "content_html": "<p>上一篇文章，我们学习了 使用 <code>git</code>  如何创建一个仓库。而且还详细的介绍了 <code>git</code>  各个工作目录的作用。</p>\n<p><code>git</code> :  <code>global information tracker</code></p>\n<p><code>git</code>  其实是内容寻址文件系统。本质是一个 <code>key-value</code>  的数据库。在上一篇文章了解了 <code>git</code>  的四种对象：提交对象，数据对象，树对象和标签对象。还学习了 <code>git</code>  的引用 ( <code>HEAD</code> , <code>Index</code> , <code>refs</code>  目录)，以及最后学习了 <code>git</code>  的压缩，( <code>git gc</code> ).</p>\n<p>今天我们从 简单的 git 使用流程说起。</p>\n<p>上一篇中，我们创建了一个仓库.</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">➜  gitlearn git init .</span><br><span class=\"line\">Initialized empty Git repository in /private/tmp/gitlearn/.git/</span><br><span class=\"line\">➜  gitlearn git:(master)</span><br></pre></td></tr></table></figure>\n<p>新建完仓库之后，我们一般会对仓库进行配置。</p>\n<h3 id=\"git-config\"><a class=\"markdownIt-Anchor\" href=\"#git-config\">#</a> git config</h3>\n<p><code>git</code>  自带了一个  <code>git config</code>  工具来帮助设置控制 Git 外观和行为的配置变量。这些变量存储在三个不同的位置。</p>\n<ul>\n<li><code>A</code> : <code>/etc/gitconfig</code>  文件：包含系统上每一个用户以及他们仓库的通用配置。 如果执行  <code>git config</code>  时，带上 --system 选项，就会读写该配置文件中的配置属性。</li>\n<li><code>B</code> : <code>~/.gitconfig</code>  或  <code>~/.config/git/config</code>  文件：只针对当前用户。使用  <code>--global</code>  选项会让 <code>git</code>  读写此文件，这会对你系统的上的<b>所有</b>仓库生效。</li>\n<li><code>C</code> : 当前使用仓库的 <code>git</code>  目录的 <code>config</code>  文件 ( <code>.git/config</code> ): 只针对当前仓库。 可以使用  <code>--local</code>  选项让 <code>git</code>  强制读写此文件，默认情况下也会使用它。</li>\n</ul>\n<p>读取顺序为：  <code>A</code> -&gt; <code>B</code> -&gt; <code>C</code> ,  <code>C</code>  会覆盖 <code>B</code>  中相同的配置， <code>B</code>  会覆盖 <code>A</code>  中相同的配置。</p>\n<blockquote>\n<p>可以通过 git config --list --show origin 命令查查文件位置以及命令所在的文件。</p>\n</blockquote>\n<p>一般我们新建了仓库，或者  <code>clone</code>  一个远程仓库到本地之后，<b>第一件事就是配置自己的用户名和邮件地址。</b></p>\n<p>刚才说过，三种配置方式的作用范围，这里<b>一般情况下</b>会使用  <code>--global</code> 。 当前登录的用户都会使用一样的配置。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ git config --global user.name &quot;fangjiaxiaobai&quot;</span><br><span class=\"line\">$ git config --global user.email &quot;fangjiaxiaobai@163.com&quot;</span><br></pre></td></tr></table></figure>\n<p>这一点非常重要！</p>\n<p>我们来查看一下配置的结果。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ git config --global --list</span><br><span class=\"line\">user.name=fangjiaxiaobai</span><br><span class=\"line\">user.email=fangjiaxiaobai@163.com</span><br></pre></td></tr></table></figure>\n<h4 id=\"修改-git-的默认文本编辑器\"><a class=\"markdownIt-Anchor\" href=\"#修改-git-的默认文本编辑器\">#</a> 修改 git 的默认文本编辑器</h4>\n<p><code>git</code>  的文本编辑器有什么作用呢？</p>\n<p>当我们的文件 在 提交代码，拉取远程代码或者切换分支出现冲突的时候， <code>git</code>  命令行窗口就会有一个处理冲突之后填写 <code>commit</code>  信息的命令行窗口，这里使用的编辑器就是 我们要说的 “文本编辑器了”。</p>\n<p><code>git</code>  中默认的文本编辑器是  <code>nano</code>  编辑器，我们使用进行配置，使用  <code>vim</code>  编辑器。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">➜  gitlearn git:(master) ✗ git config --global core.editor &quot;vim&quot;</span><br><span class=\"line\">➜  gitlearn git:(master) ✗ git config --global -l</span><br><span class=\"line\">user.name=fangjiaxiaobai</span><br><span class=\"line\">user.email=fangjiaxiaobai@163.com</span><br><span class=\"line\">core.editor=vim</span><br></pre></td></tr></table></figure>\n<p>配置完仓库，之后，我们就正式开始使用  <code>git</code>  了。</p>\n<h3 id=\"使用-git-进行工作\"><a class=\"markdownIt-Anchor\" href=\"#使用-git-进行工作\">#</a> 使用  <code>git</code>  进行工作</h3>\n<p>简单来讲，我们只需三步，两个命令就可以完成文件的版本控制。</p>\n<ul>\n<li>修改文件 (创建文件，修改文件内容，删除文件)</li>\n<li>使用  <code>git add .</code>  将文件纳入版本管理</li>\n<li>使用  <code>git commit -m &quot;xxx&quot;</code>  将文件提交到版本仓库。</li>\n</ul>\n<p>在我们的工作目录中 (比如  <code>gitlearn/</code> ), 所有的文件只有两种状态：  <code>已跟踪</code> 和 <code>未跟踪</code> 。</p>\n<p>已跟踪的文件是指被纳入版本控制的文件。在上一次快照中有他们的记录，在工作一段时间后，他们的状态可能是未修改，已修改，或者已经放入了 <code>暂存区</code>  $^❶ $。</p>\n<p>未跟踪的文件：就是 即不存在上次快照中，也没有被放入暂存区中。</p>\n<p>这里我们再次的介绍一下 <code>git</code>  的工作区域:</p>\n<p>工作区，暂存区，版本库。</p>\n<p>工作区，就是我们修改的文件。包括：新建文件，修改文件内容，删除文件。<br>\n暂存区，就是 <code>git</code>  将我们修改的文件记录起来起来。<br>\n版本库，就是 <code>git</code>  的记录的版本变更历史。就是  <code>.git</code>  目录下的 <code>objects/</code>  等目录下的所有文件。即我们 进行了 <code>commit</code>  操作之后就会进入了版本库。</p>\n<h3 id=\"让-git-跟踪我们的文件\"><a class=\"markdownIt-Anchor\" href=\"#让-git-跟踪我们的文件\">#</a> 让  <code>git</code>  跟踪我们的文件</h3>\n<p>使用  <code>git add</code>  命令，可以让 <code>git</code>  开始跟踪一个文件。</p>\n<p>使 <code>git</code>  跟踪文件  <code>README.md</code></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">➜  gitlearn git:(master) echo &#x27;test git跟踪文件&#x27; &gt; README.md</span><br><span class=\"line\"># 查看工作区中文件的状态</span><br><span class=\"line\">➜  gitlearn git:(master) ✗ git status</span><br><span class=\"line\">On branch master</span><br><span class=\"line\"></span><br><span class=\"line\">No commits yet</span><br><span class=\"line\"></span><br><span class=\"line\">Untracked files:</span><br><span class=\"line\">  (use &quot;git add &lt;file&gt;...&quot; to include in what will be committed)</span><br><span class=\"line\"></span><br><span class=\"line\">\tREADME.md</span><br><span class=\"line\"></span><br><span class=\"line\">nothing added to commit but untracked files present (use &quot;git add&quot; to track)</span><br></pre></td></tr></table></figure>\n<p>这里我们看到了，未跟踪的该文件：  <code>README.md</code> 。我们可以使用 <code>git add</code>  命令，将未跟踪的文件纳入跟踪范围。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">➜  gitlearn git:(master) ✗ git add README.md</span><br><span class=\"line\"># 查看文件的状态</span><br><span class=\"line\">➜  gitlearn git:(master) ✗ git status</span><br><span class=\"line\">On branch master</span><br><span class=\"line\"></span><br><span class=\"line\">No commits yet</span><br><span class=\"line\"></span><br><span class=\"line\">Changes to be committed:</span><br><span class=\"line\">  (use &quot;git rm --cached &lt;file&gt;...&quot; to unstage)</span><br><span class=\"line\"></span><br><span class=\"line\">\tnew file:   README.md</span><br></pre></td></tr></table></figure>\n<p><code>Changes to be committed</code> : 将要提交的变更。说明下面的文件已经是暂存状态了。使用  <code>git rm --cached &lt;file&gt;...</code>  命令可以取消暂存。此时 <code>README.md</code>  文件已经是 <code>git</code>  跟踪的了。我们再次修改一下  <code>README.md</code>  文件。查看一下工作区中文件的状态.</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">➜  gitlearn git:(master) ✗ echo &#x27;test 再次修改已经被跟踪的文件&#x27; &gt;&gt; README.md</span><br><span class=\"line\">➜  gitlearn git:(master) ✗ git status</span><br><span class=\"line\">On branch master</span><br><span class=\"line\"></span><br><span class=\"line\">No commits yet</span><br><span class=\"line\"></span><br><span class=\"line\">Changes to be committed:</span><br><span class=\"line\">  (use &quot;git rm --cached &lt;file&gt;...&quot; to unstage)</span><br><span class=\"line\"></span><br><span class=\"line\">\tnew file:   README.md</span><br><span class=\"line\"></span><br><span class=\"line\">Changes not staged for commit:</span><br><span class=\"line\">  (use &quot;git add &lt;file&gt;...&quot; to update what will be committed)</span><br><span class=\"line\">  (use &quot;git checkout -- &lt;file&gt;...&quot; to discard changes in working directory)</span><br><span class=\"line\"></span><br><span class=\"line\">\tmodified:   README.md</span><br></pre></td></tr></table></figure>\n<p>又看到了 <code>Changes not staged for commit</code> ： 还没有被暂存的提交去提交。说明第二次的变更还没有被 <code>git</code>  跟踪起来。这就需要我们在运行一次 <code>git add README.md</code>  命令了。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">➜  gitlearn git:(master) ✗ git add README.md</span><br><span class=\"line\">➜  gitlearn git:(master) ✗ git status</span><br><span class=\"line\">On branch master</span><br><span class=\"line\"></span><br><span class=\"line\">No commits yet</span><br><span class=\"line\"></span><br><span class=\"line\">Changes to be committed:</span><br><span class=\"line\">  (use &quot;git rm --cached &lt;file&gt;...&quot; to unstage)</span><br><span class=\"line\"></span><br><span class=\"line\">\tnew file:   README.md</span><br></pre></td></tr></table></figure>\n<p>我们可以看到，第二次更改也被 <code>git</code>  跟踪了起来。</p>\n<p><code>git status</code>  命令的输出十分详细，可以使用 <code>git status -s(--short)</code>  命令，输出非常简洁的结果.</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">➜  gitlearn git:(master) ✗ git status -s</span><br><span class=\"line\">A  README.md</span><br></pre></td></tr></table></figure>\n<p>输出结果的格式是这样的:</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">XX file1</span><br><span class=\"line\">XX file2</span><br></pre></td></tr></table></figure>\n<p>左列 XX: 第一个 X 表示，暂存区的状态，第二个 X 表示工作区的状态。</p>\n<p>XX 的规则如下：</p>\n<ul>\n<li>新添加的未跟踪文件前面有？？标记</li>\n<li>新添加到暂存区中的文件前面有 A 标记</li>\n<li>修改过的文件前面有 M 标记。</li>\n</ul>\n<h3 id=\"提交到版本库\"><a class=\"markdownIt-Anchor\" href=\"#提交到版本库\">#</a> 提交到版本库</h3>\n<p>现在我们就可以提交文件了。最好在每次提交之前都用  <code>git status</code>  看下，我们需要的文件是否都放入 暂存区了。然后再用  <code>git commit</code>  进行提交。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">➜  gitlearn git:(master) ✗ git status</span><br><span class=\"line\">On branch master</span><br><span class=\"line\"></span><br><span class=\"line\">No commits yet</span><br><span class=\"line\"></span><br><span class=\"line\">Changes to be committed:</span><br><span class=\"line\">  (use &quot;git rm --cached &lt;file&gt;...&quot; to unstage)</span><br><span class=\"line\"></span><br><span class=\"line\">\tnew file:   README.md</span><br><span class=\"line\"># 提交代码</span><br><span class=\"line\"></span><br><span class=\"line\">➜  gitlearn git:(master) ✗ git commit -m &quot;first commit&quot;</span><br><span class=\"line\">[master (root-commit) fb554b5] first commit</span><br><span class=\"line\"> 1 file changed, 2 insertions(+)</span><br><span class=\"line\"> create mode 100644 README.md</span><br></pre></td></tr></table></figure>\n<p>可以看到，提交后它会告诉你，当前是在哪个分支（ <code>master</code> ）提交的，本次提交的完整  <code>SHA-1</code>  校验和是什么（ <code>463dc4f</code> ），以及在本次提交中，有多少文件修订过，多少行添加和删改过。</p>\n<p>以上就是我们最简单的开发流程了。</p>\n<p>这时，如果我不想某个文件纳入版本管理，但是这个文件还必须要在工作区中呢？</p>\n<h4 id=\"忽略文件\"><a class=\"markdownIt-Anchor\" href=\"#忽略文件\">#</a> 忽略文件</h4>\n<p>在这种情况下，我们可以创建一个名为：  <code>.gitignore</code>  的文件，列出要忽略的文件的模式。</p>\n<p><code>.gitignore</code>  文件的格式规范如下：</p>\n<ul>\n<li>所有空行或者以 # 开头的行都会被 Git 忽略。</li>\n<li>可以使用标准的 glob 模式匹配，它会递归地应用在整个工作区中。</li>\n<li>匹配模式可以以（/）开头防止递归。</li>\n<li>匹配模式可以以（/）结尾指定目录。</li>\n<li>要忽略指定模式以外的文件或目录，可以在模式前加上叹号（!）取反。</li>\n</ul>\n<p>所谓的  <code>glob</code>  模式是指  <code>shell</code>  所使用的简化了的正则表达式。 星号 <code>（*）</code> 匹配零个或多个任意字符； <code>[abc]</code>  匹配任何一个列在方括号中的字符 （这个例子要么匹配一个  <code>a</code> ，要么匹配一个  <code>b</code> ，要么匹配一个  <code>c</code> ）； 问号 <code>（?）</code> 只匹配一个任意字符；如果在方括号中使用短划线分隔两个字符， 表示所有在这两个字符范围内的都可以匹配（比如  <code>[0-9]</code>  表示匹配所有  <code>0</code>  到  <code>9</code>  的数字）。 使用两个星号（ <code>**</code> ）表示匹配任意中间目录，比如  <code>a/**/z</code>  可以匹配  <code>a/z</code>  、  <code>a/b/z</code>  或  <code>a/b/c/z</code>  等。</p>\n<p>来看一个  <code>.gitignore</code>  文件的例子:</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 忽略所有的 .a 文件</span></span><br><span class=\"line\">*.a</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 但跟踪所有的 lib.a，即便你在前面忽略了 .a 文件</span></span><br><span class=\"line\">!lib.a</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 只忽略当前目录下的 TODO 文件，而不忽略 subdir/TODO</span></span><br><span class=\"line\">/TODO</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 忽略任何目录下名为 build 的文件夹</span></span><br><span class=\"line\">build/</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 忽略 doc/notes.txt，但不忽略 doc/server/arch.txt</span></span><br><span class=\"line\">doc/*.txt</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 忽略 doc/ 目录及其所有子目录下的 .pdf 文件</span></span><br><span class=\"line\">doc/**/*.pdf</span><br></pre></td></tr></table></figure>\n<p>假设：我们还有一个名叫：  <code>git.log</code>  的文件。在更早的一个快照中，已经把它纳入了版本库中。现在我们要把它移除掉。应该怎么办呢</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">### 准备工作</span><br><span class=\"line\">➜  gitlearn git:(master) echo &#x27;test remove logs files&#x27; &gt; git.log</span><br><span class=\"line\">➜  gitlearn git:(master) ✗ git add .</span><br><span class=\"line\">➜  gitlearn git:(master) ✗ git commit -m &quot;test remove logs files&quot;</span><br><span class=\"line\">[master b83b8f1] test remove logs files</span><br><span class=\"line\"> 1 file changed, 1 insertion(+)</span><br><span class=\"line\"> create mode 100644 git.log</span><br><span class=\"line\"></span><br><span class=\"line\"> ### 移除 git.log</span><br><span class=\"line\">➜  gitlearn git:(master) git rm git.log</span><br><span class=\"line\">rm &#x27;git.log&#x27;</span><br><span class=\"line\">➜  gitlearn git:(master) ✗ git status</span><br><span class=\"line\">On branch master</span><br><span class=\"line\">Changes to be committed:</span><br><span class=\"line\">  (use &quot;git reset HEAD &lt;file&gt;...&quot; to unstage)</span><br><span class=\"line\"></span><br><span class=\"line\">\tdeleted:    git.log</span><br><span class=\"line\"># 新建 .gitignore 文件</span><br><span class=\"line\">➜  gitlearn git:(master) ✗ echo &#x27;*.log&#x27; &gt; .gitignore</span><br><span class=\"line\">➜  gitlearn git:(master) ✗ git add .</span><br><span class=\"line\"># 查看文件的状态</span><br><span class=\"line\">➜  gitlearn git:(master) ✗ git status</span><br><span class=\"line\">On branch master</span><br><span class=\"line\">Changes to be committed:</span><br><span class=\"line\">  (use &quot;git reset HEAD &lt;file&gt;...&quot; to unstage)</span><br><span class=\"line\"></span><br><span class=\"line\">\tnew file:   .gitignore</span><br><span class=\"line\">\tdeleted:    git.log</span><br><span class=\"line\">➜  gitlearn git:(master) ✗ echo &#x27;*.log&#x27; &gt; .gitignore</span><br><span class=\"line\">➜  gitlearn git:(master) ✗ git add .</span><br><span class=\"line\">➜  gitlearn git:(master) ✗ git status</span><br><span class=\"line\">On branch master</span><br><span class=\"line\">Changes to be committed:</span><br><span class=\"line\">  (use &quot;git reset HEAD &lt;file&gt;...&quot; to unstage)</span><br><span class=\"line\"></span><br><span class=\"line\">\tnew file:   .gitignore</span><br><span class=\"line\">\tdeleted:    git.log</span><br><span class=\"line\"></span><br><span class=\"line\"># 提交文件</span><br><span class=\"line\">➜  gitlearn git:(master) ✗ git commit -m &quot;test remove logs files - remove git.log&quot;</span><br><span class=\"line\">[master 9118876] test remove logs files - remove git.log</span><br><span class=\"line\"> 2 files changed, 1 insertion(+), 1 deletion(-)</span><br><span class=\"line\"> create mode 100644 .gitignore</span><br><span class=\"line\"> delete mode 100644 git.log</span><br><span class=\"line\">➜  gitlearn git:(master) git status</span><br><span class=\"line\">On branch master</span><br><span class=\"line\">nothing to commit, working tree clean</span><br><span class=\"line\"># 验证一下git.log文件会不会被git跟踪</span><br><span class=\"line\"></span><br><span class=\"line\"># 修改了git.log文件之后，git不会跟踪其变更。</span><br><span class=\"line\">➜  gitlearn git:(master) echo &#x27;test track git.log??&#x27; &gt; git.log</span><br><span class=\"line\"></span><br><span class=\"line\">➜  gitlearn git:(master) git status</span><br><span class=\"line\">On branch master</span><br><span class=\"line\">nothing to commit, working tree clean</span><br></pre></td></tr></table></figure>\n<p>注意：</p>\n<p>运行  <code>git rm</code>  命令并不能删除文件！是从 <code>git</code>  中删除，使 <code>git</code>  不在跟踪其变化。</p>\n<p>有时候，使用  <code>git rm</code>  命令并不能使文件不被 <code>git</code>  跟踪，因为在缓存中还跟踪了文件。 这使，可以使用  <code>git rm -rf --cached</code>  命令使 <code>git</code>  不跟踪文件。</p>\n<p><code>git rm</code>  命令也可以使用  <code>glob</code>  模式。</p>\n<h3 id=\"查看文件的修改内容\"><a class=\"markdownIt-Anchor\" href=\"#查看文件的修改内容\">#</a> 查看文件的修改内容</h3>\n<p><code>git</code>  提供了一个命令 <code>git diff</code>  可以查看文件修改了那些地方.</p>\n<p>假设：我们修改了一个文件，我要看一下修改的内容 (此时还没有提交。)</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">➜  gitlearn git:(master) echo &#x27;test diff&#x27; &gt; README.md</span><br><span class=\"line\"></span><br><span class=\"line\">## 查看不同</span><br><span class=\"line\">### 比较的是： 工作目录中当前文件和暂存区域快照之间的差异。</span><br><span class=\"line\">➜  gitlearn git:(master) ✗ git diff</span><br><span class=\"line\">diff --git a/README.md b/README.md</span><br><span class=\"line\">index 2afbeed..b69a2df 100644</span><br><span class=\"line\">--- a/README.md</span><br><span class=\"line\">+++ b/README.md</span><br><span class=\"line\">@@ -1,2 +1 @@</span><br><span class=\"line\">-test git跟踪文件</span><br><span class=\"line\">-test 再次修改已经被跟踪的文件</span><br><span class=\"line\">+test diff</span><br></pre></td></tr></table></figure>\n<p>使用  <code>--staged</code>  选项可以比较 已暂存文件与最后一次提交的文件差异。<br>\n<b>请注意， <code>git diff</code>  本身只显示尚未暂存的改动，而不是自上次提交以来所做的所有改动。 所以有时候你一下子暂存了所有更新过的文件，运行  <code>git diff</code>  后却什么也没有，就是这个原因。</b></p>\n<h3 id=\"移动文件\"><a class=\"markdownIt-Anchor\" href=\"#移动文件\">#</a> 移动文件</h3>\n<p>可以使用  <code>git mv</code>  命令来移动文件。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">➜  gitlearn git:(master) ✗ git mv README.md README.md.md</span><br><span class=\"line\">➜  gitlearn git:(master) ✗ git status</span><br><span class=\"line\">On branch master</span><br><span class=\"line\">Changes to be committed:</span><br><span class=\"line\">  (use &quot;git reset HEAD &lt;file&gt;...&quot; to unstage)</span><br><span class=\"line\"></span><br><span class=\"line\">\trenamed:    README.md -&gt; README.md.md</span><br><span class=\"line\"></span><br><span class=\"line\">Changes not staged for commit:</span><br><span class=\"line\">  (use &quot;git add &lt;file&gt;...&quot; to update what will be committed)</span><br><span class=\"line\">  (use &quot;git checkout -- &lt;file&gt;...&quot; to discard changes in working directory)</span><br><span class=\"line\"></span><br><span class=\"line\">\tmodified:   README.md.md</span><br></pre></td></tr></table></figure>\n<p>这个命令就相当于：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ mv README.md README.md.md</span><br><span class=\"line\">$ git rm README.md</span><br><span class=\"line\">$ git add README.md.md</span><br></pre></td></tr></table></figure>\n<p>本篇文章就到这里啦，下一篇～<b>git 的时光机</b></p>\n<h3 id=\"最后\"><a class=\"markdownIt-Anchor\" href=\"#最后\">#</a> 最后</h3>\n<p>期望与你一起遇见更好的自己</p>\n<p><img data-src=\"/images/qrcode.jpg\" alt=\"期望与你一起遇见更好的自己\"></p>\n",
            "tags": [
                "git"
            ]
        },
        {
            "id": "https://fangjiaxiaobai.github.io/2021/07/18/git%E7%B3%BB%E5%88%97/05-git%E5%9F%BA%E6%9C%AC%E5%91%BD%E4%BB%A42%20git%E6%97%B6%E5%85%89%E6%9C%BA1/",
            "url": "https://fangjiaxiaobai.github.io/2021/07/18/git%E7%B3%BB%E5%88%97/05-git%E5%9F%BA%E6%9C%AC%E5%91%BD%E4%BB%A42%20git%E6%97%B6%E5%85%89%E6%9C%BA1/",
            "title": "git基本命令二",
            "date_published": "2021-07-18T06:49:55.000Z",
            "content_html": "<p><code>git</code>  的时光机 (简化版)</p>\n<ul>\n<li><code>git log</code> ：查看历史记录</li>\n<li><code>git commit -amend</code> ：重写上一次的提交历史</li>\n</ul>\n<h3 id=\"git-log\"><a class=\"markdownIt-Anchor\" href=\"#git-log\">#</a>  <code>git log</code></h3>\n<p><code>git</code>  有一个特别实用的功能，可以让我们看到所有的历史更改记录。这个命令就是  <code>git log</code> .</p>\n<p>首先我们新建一个仓库。随便进行 <code>5</code>  次更改， <code>5</code>  提交。</p>\n<p>执行如下的操作:</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">➜  gitlearn git init .</span><br><span class=\"line\">Initialized empty Git repository in /private/tmp/gitlearn/.git/</span><br><span class=\"line\">➜  gitlearn git:(master) ✗ echo &#x27;第一行&#x27; &gt; testGitLog</span><br><span class=\"line\">➜  gitlearn git:(master) ✗ git add .</span><br><span class=\"line\">➜  gitlearn git:(master) ✗ git commit -m &quot;test git-log 1 &quot;</span><br><span class=\"line\">[master (root-commit) 0718ac9] test git-log 1</span><br><span class=\"line\"> 2 files changed, 2 insertions(+)</span><br><span class=\"line\"> create mode 100644 .gitignore</span><br><span class=\"line\"> create mode 100644 testGitLog</span><br><span class=\"line\"></span><br><span class=\"line\">➜  gitlearn git:(master) echo &#x27;第二行&#x27; &gt;&gt; testGitLog</span><br><span class=\"line\">➜  gitlearn git:(master) ✗ git commit -a -m &quot;test git-log 2 &quot;</span><br><span class=\"line\">[master f8248a5] test git-log 2</span><br><span class=\"line\"> 1 file changed, 1 insertion(+)</span><br><span class=\"line\"></span><br><span class=\"line\">➜  gitlearn git:(master) echo &#x27;第三行&#x27; &gt;&gt; testGitLog</span><br><span class=\"line\">➜  gitlearn git:(master) ✗ git commit -a -m &quot;test git-log 3 &quot;</span><br><span class=\"line\">[master b282b88] test git-log 3</span><br><span class=\"line\"> 1 file changed, 1 insertion(+)</span><br><span class=\"line\"></span><br><span class=\"line\">➜  gitlearn git:(master) echo &#x27;第四行&#x27; &gt;&gt; testGitLog</span><br><span class=\"line\">➜  gitlearn git:(master) ✗ git commit -a -m &quot;test git-log 4 &quot;</span><br><span class=\"line\">[master b9df1bb] test git-log 4</span><br><span class=\"line\"> 1 file changed, 1 insertion(+)</span><br><span class=\"line\"></span><br><span class=\"line\">➜  gitlearn git:(master) echo &#x27;第五行&#x27; &gt;&gt; testGitLog</span><br><span class=\"line\">➜  gitlearn git:(master) ✗ git commit -a -m &quot;test git-log 5 &quot;</span><br><span class=\"line\">[master 769db1c] test git-log 5</span><br><span class=\"line\"> 1 file changed, 1 insertion(+)</span><br></pre></td></tr></table></figure>\n<p>运行一下  <code>git log</code>  我们查看一下输出的内容。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">commit 769db1cd5ba091162707a3e648d67ec8e6913d2b (HEAD -&gt; master)</span><br><span class=\"line\">Author: fangjiaxiaobai &lt;fangjiaxiaobai@163.com&gt;</span><br><span class=\"line\">Date:   Tue Jul 21 15:36:11 2020 +0800</span><br><span class=\"line\"></span><br><span class=\"line\">    test git-log 5</span><br><span class=\"line\"></span><br><span class=\"line\">commit b9df1bb5c10f6602f7fa889ca91759a2e45e69cb</span><br><span class=\"line\">Author: fangjiaxiaobai &lt;fangjiaxiaobai@163.com&gt;</span><br><span class=\"line\">Date:   Tue Jul 21 15:36:01 2020 +0800</span><br><span class=\"line\"></span><br><span class=\"line\">    test git-log 4</span><br><span class=\"line\"></span><br><span class=\"line\">commit b282b882317b118095eb921e707e449f45fdeef6</span><br><span class=\"line\">Author: fangjiaxiaobai &lt;fangjiaxiaobai@163.com&gt;</span><br><span class=\"line\">Date:   Tue Jul 21 15:35:48 2020 +0800</span><br><span class=\"line\"></span><br><span class=\"line\">    test git-log 3</span><br><span class=\"line\"></span><br><span class=\"line\">commit f8248a5fbc18a90710c95cee475b34797299bc61</span><br><span class=\"line\">Author: fangjiaxiaobai &lt;fangjiaxiaobai@163.com&gt;</span><br><span class=\"line\">Date:   Tue Jul 21 15:35:30 2020 +0800</span><br><span class=\"line\"></span><br><span class=\"line\">    test git-log 2</span><br><span class=\"line\"></span><br><span class=\"line\">commit 0718ac9a20021971d6f1a09a3ef72e36b6fd73c9</span><br><span class=\"line\">Author: fangjiaxiaobai &lt;fangjiaxiaobai@163.com&gt;</span><br><span class=\"line\">Date:   Tue Jul 21 15:34:39 2020 +0800</span><br><span class=\"line\"></span><br><span class=\"line\">    test git-log 1</span><br></pre></td></tr></table></figure>\n<p>可以看到，我们没有传入任何参数的情况下， <code>git log</code>  会按照先后顺序列出所有的提交，时间最近的更新排在最上面。</p>\n<p>该命令会列出每次提交的 SHA-1 校验和，作者的名字和电子邮箱，提交时间，以及提交说明。</p>\n<p><code>git log</code>  还有很多我们选项，我在后面有一篇文章写了 git 的命令大全，并且会保持更新哦。</p>\n<h4 id=\"git-log命令选项\"><a class=\"markdownIt-Anchor\" href=\"#git-log命令选项\">#</a>  <code>git log</code>  命令选项</h4>\n<p>这里我们就先介绍一写常用的命令选项。</p>\n<h5 id=\"显示每次提交所引入的差异-patch\"><a class=\"markdownIt-Anchor\" href=\"#显示每次提交所引入的差异-patch\">#</a> 显示每次提交所引入的差异  <code>--patch</code></h5>\n<p><code>git log --patch</code>  或者  <code>git log -p</code>  会显示每次提交所引入的差异，会按照补丁的方式展示。后面也可以加上数字来限制下面显示几次提交。比如： <code>git log -p -1</code></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">commit 769db1cd5ba091162707a3e648d67ec8e6913d2b (HEAD -&gt; master)</span><br><span class=\"line\">Author: fangjiaxiaobai &lt;fangjiaxiaobai@163.com&gt;</span><br><span class=\"line\">Date:   Tue Jul 21 15:36:11 2020 +0800</span><br><span class=\"line\"></span><br><span class=\"line\">    test git-log 5</span><br><span class=\"line\"></span><br><span class=\"line\">diff --git a/testGitLog b/testGitLog</span><br><span class=\"line\">index 11c20cd..844b7e8 100644</span><br><span class=\"line\">--- a/testGitLog</span><br><span class=\"line\">+++ b/testGitLog</span><br><span class=\"line\">@@ -2,3 +2,4 @@</span><br><span class=\"line\"> 第二行</span><br><span class=\"line\"> 第三行</span><br><span class=\"line\"> 第四行</span><br><span class=\"line\">+第五行</span><br><span class=\"line\"></span><br><span class=\"line\">commit b9df1bb5c10f6602f7fa889ca91759a2e45e69cb</span><br><span class=\"line\">Author: fangjiaxiaobai &lt;fangjiaxiaobai@163.com&gt;</span><br><span class=\"line\">Date:   Tue Jul 21 15:36:01 2020 +0800</span><br><span class=\"line\"></span><br><span class=\"line\">    test git-log 4</span><br><span class=\"line\"></span><br><span class=\"line\">diff --git a/testGitLog b/testGitLog</span><br><span class=\"line\">index f1c8e85..11c20cd 100644</span><br><span class=\"line\">--- a/testGitLog</span><br><span class=\"line\">+++ b/testGitLog</span><br><span class=\"line\">@@ -1,3 +1,4 @@</span><br><span class=\"line\"> 第一行</span><br><span class=\"line\"> 第二行</span><br><span class=\"line\"> 第三行</span><br><span class=\"line\">+第四行</span><br><span class=\"line\"></span><br><span class=\"line\">...</span><br></pre></td></tr></table></figure>\n<p>限制提交数演示：</p>\n<p><code>git log -p -1</code></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">commit 769db1cd5ba091162707a3e648d67ec8e6913d2b (HEAD -&gt; master)</span><br><span class=\"line\">Author: fangjiaxiaobai &lt;fangjiaxiaobai@163.com&gt;</span><br><span class=\"line\">Date:   Tue Jul 21 15:36:11 2020 +0800</span><br><span class=\"line\"></span><br><span class=\"line\">    test git-log 5</span><br><span class=\"line\"></span><br><span class=\"line\">diff --git a/testGitLog b/testGitLog</span><br><span class=\"line\">index 11c20cd..844b7e8 100644</span><br><span class=\"line\">--- a/testGitLog</span><br><span class=\"line\">+++ b/testGitLog</span><br><span class=\"line\">@@ -2,3 +2,4 @@</span><br><span class=\"line\"> 第二行</span><br><span class=\"line\"> 第三行</span><br><span class=\"line\"> 第四行</span><br><span class=\"line\">+第五行</span><br></pre></td></tr></table></figure>\n<p>这个选项可以在每次提交的下面列出所有修改过的文件，有多少文件被修改了以及被修改过的文件的哪些行被移除或是添加了。 在每次提交的最后还有一个总结。</p>\n<h5 id=\"查看每次提交的简略统计信息-git-log-stat\"><a class=\"markdownIt-Anchor\" href=\"#查看每次提交的简略统计信息-git-log-stat\">#</a> 查看每次提交的简略统计信息， <code>git log --stat</code></h5>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">commit 769db1cd5ba091162707a3e648d67ec8e6913d2b (HEAD -&gt; master)</span><br><span class=\"line\">Author: fangjiaxiaobai &lt;fangjiaxiaobai@163.com&gt;</span><br><span class=\"line\">Date:   Tue Jul 21 15:36:11 2020 +0800</span><br><span class=\"line\"></span><br><span class=\"line\">    test git-log 5</span><br><span class=\"line\"></span><br><span class=\"line\">## 什么文件被修改了，增加还是删除</span><br><span class=\"line\"> testGitLog | 1 +</span><br><span class=\"line\">## 一共修改了多少文件</span><br><span class=\"line\"> 1 file changed, 1 insertion(+)</span><br><span class=\"line\"></span><br><span class=\"line\">...</span><br></pre></td></tr></table></figure>\n<h4 id=\"格式化输出日志-pretty\"><a class=\"markdownIt-Anchor\" href=\"#格式化输出日志-pretty\">#</a> 格式化输出日志  <code>--pretty</code></h4>\n<p>这个选项可以使不同于默认格式化的方式展示提交历史。它提供了几种内建的格式化方式，除此之外使用者还可以自定义格式化方式。</p>\n<h6 id=\"内建一oneline\"><a class=\"markdownIt-Anchor\" href=\"#内建一oneline\">#</a> 内建一：oneline</h6>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ git log --pretty=oneline</span><br><span class=\"line\">769db1cd5ba091162707a3e648d67ec8e6913d2b (HEAD -&gt; master) test git-log 5</span><br><span class=\"line\">b9df1bb5c10f6602f7fa889ca91759a2e45e69cb test git-log 4</span><br><span class=\"line\">b282b882317b118095eb921e707e449f45fdeef6 test git-log 3</span><br><span class=\"line\">f8248a5fbc18a90710c95cee475b34797299bc61 test git-log 2</span><br><span class=\"line\">0718ac9a20021971d6f1a09a3ef72e36b6fd73c9 test git-log 1</span><br></pre></td></tr></table></figure>\n<h6 id=\"内建二-short\"><a class=\"markdownIt-Anchor\" href=\"#内建二-short\">#</a> 内建二： short</h6>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ git log --pretty=short</span><br><span class=\"line\">commit 769db1cd5ba091162707a3e648d67ec8e6913d2b (HEAD -&gt; master)</span><br><span class=\"line\">Author: fangjiaxiaobai &lt;fangjiaxiaobai@163.com&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">    test git-log 5</span><br><span class=\"line\"></span><br><span class=\"line\">commit b9df1bb5c10f6602f7fa889ca91759a2e45e69cb</span><br><span class=\"line\">Author: fangjiaxiaobai &lt;fangjiaxiaobai@163.com&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">    test git-log 4</span><br><span class=\"line\"></span><br><span class=\"line\">commit b282b882317b118095eb921e707e449f45fdeef6</span><br><span class=\"line\">Author: fangjiaxiaobai &lt;fangjiaxiaobai@163.com&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">    test git-log 3</span><br><span class=\"line\"></span><br><span class=\"line\">commit f8248a5fbc18a90710c95cee475b34797299bc61</span><br><span class=\"line\">Author: fangjiaxiaobai &lt;fangjiaxiaobai@163.com&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">    test git-log 2</span><br><span class=\"line\"></span><br><span class=\"line\">commit 0718ac9a20021971d6f1a09a3ef72e36b6fd73c9</span><br><span class=\"line\">Author: fangjiaxiaobai &lt;fangjiaxiaobai@163.com&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">    test git-log 1</span><br></pre></td></tr></table></figure>\n<h6 id=\"内建三full\"><a class=\"markdownIt-Anchor\" href=\"#内建三full\">#</a> 内建三：full</h6>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ git log --pretty=full</span><br><span class=\"line\">commit 769db1cd5ba091162707a3e648d67ec8e6913d2b (HEAD -&gt; master)</span><br><span class=\"line\">Author: fangjiaxiaobai &lt;fangjiaxiaobai@163.com&gt;</span><br><span class=\"line\">Commit: fangjiaxiaobai &lt;fangjiaxiaobai@163.com&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">    test git-log 5</span><br><span class=\"line\"></span><br><span class=\"line\">commit b9df1bb5c10f6602f7fa889ca91759a2e45e69cb</span><br><span class=\"line\">Author: fangjiaxiaobai &lt;fangjiaxiaobai@163.com&gt;</span><br><span class=\"line\">Commit: fangjiaxiaobai &lt;fangjiaxiaobai@163.com&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">    test git-log 4</span><br><span class=\"line\"></span><br><span class=\"line\">commit b282b882317b118095eb921e707e449f45fdeef6</span><br><span class=\"line\">Author: fangjiaxiaobai &lt;fangjiaxiaobai@163.com&gt;</span><br><span class=\"line\">Commit: fangjiaxiaobai &lt;fangjiaxiaobai@163.com&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">    test git-log 3</span><br><span class=\"line\"></span><br><span class=\"line\">commit f8248a5fbc18a90710c95cee475b34797299bc61</span><br><span class=\"line\">Author: fangjiaxiaobai &lt;fangjiaxiaobai@163.com&gt;</span><br><span class=\"line\">Commit: fangjiaxiaobai &lt;fangjiaxiaobai@163.com&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">    test git-log 2</span><br><span class=\"line\"></span><br><span class=\"line\">commit 0718ac9a20021971d6f1a09a3ef72e36b6fd73c9</span><br><span class=\"line\">Author: fangjiaxiaobai &lt;fangjiaxiaobai@163.com&gt;</span><br><span class=\"line\">Commit: fangjiaxiaobai &lt;fangjiaxiaobai@163.com&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">    test git-log 1</span><br></pre></td></tr></table></figure>\n<h6 id=\"内建四fuller\"><a class=\"markdownIt-Anchor\" href=\"#内建四fuller\">#</a> 内建四：fuller</h6>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ git log --pretty=fullter</span><br><span class=\"line\"></span><br><span class=\"line\">commit 769db1cd5ba091162707a3e648d67ec8e6913d2b (HEAD -&gt; master)</span><br><span class=\"line\">Author:     fangjiaxiaobai &lt;fangjiaxiaobai@163.com&gt;</span><br><span class=\"line\">AuthorDate: Tue Jul 21 15:36:11 2020 +0800</span><br><span class=\"line\">Commit:     fangjiaxiaobai &lt;fangjiaxiaobai@163.com&gt;</span><br><span class=\"line\">CommitDate: Tue Jul 21 15:36:11 2020 +0800</span><br><span class=\"line\"></span><br><span class=\"line\">    test git-log 5</span><br><span class=\"line\"></span><br><span class=\"line\">commit b9df1bb5c10f6602f7fa889ca91759a2e45e69cb</span><br><span class=\"line\">Author:     fangjiaxiaobai &lt;fangjiaxiaobai@163.com&gt;</span><br><span class=\"line\">AuthorDate: Tue Jul 21 15:36:01 2020 +0800</span><br><span class=\"line\">Commit:     fangjiaxiaobai &lt;fangjiaxiaobai@163.com&gt;</span><br><span class=\"line\">CommitDate: Tue Jul 21 15:36:01 2020 +0800</span><br><span class=\"line\"></span><br><span class=\"line\">    test git-log 4</span><br><span class=\"line\"></span><br><span class=\"line\">commit b282b882317b118095eb921e707e449f45fdeef6</span><br><span class=\"line\">Author:     fangjiaxiaobai &lt;fangjiaxiaobai@163.com&gt;</span><br><span class=\"line\">AuthorDate: Tue Jul 21 15:35:48 2020 +0800</span><br><span class=\"line\">Commit:     fangjiaxiaobai &lt;fangjiaxiaobai@163.com&gt;</span><br><span class=\"line\">CommitDate: Tue Jul 21 15:35:48 2020 +0800</span><br><span class=\"line\">...</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h6 id=\"最nb的format\"><a class=\"markdownIt-Anchor\" href=\"#最nb的format\">#</a> 最 NB 的：format</h6>\n<p>这个选项目可以让我们定制记录的显示格式，这种并不会随着 git 的更新而发生改变。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ git log --pretty=format:&quot;%h-%an,%ar:%s&quot;</span><br><span class=\"line\"></span><br><span class=\"line\">769db1c - fangjiaxiaobai, 27 minutes ago:test git-log 5</span><br><span class=\"line\">b9df1bb - fangjiaxiaobai, 27 minutes ago:test git-log 4</span><br><span class=\"line\">b282b88 - fangjiaxiaobai, 27 minutes ago:test git-log 3</span><br><span class=\"line\">f8248a5 - fangjiaxiaobai, 27 minutes ago:test git-log 2</span><br><span class=\"line\">0718ac9 - fangjiaxiaobai, 28 minutes ago:test git-log 1</span><br></pre></td></tr></table></figure>\n<p>format 后面的分别代表什么含义呢？<br>\n这里列出了 Format 的常用参数。</p>\n<table>\n<thead>\n<tr>\n<th style=\"text-align:center\">参数</th>\n<th style=\"text-align:left\">含义</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:center\">%H</td>\n<td style=\"text-align:left\">提交的完整哈希值</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">%h</td>\n<td style=\"text-align:left\">提交的简写哈希值</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">%T</td>\n<td style=\"text-align:left\">树的完整哈希值</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">%t</td>\n<td style=\"text-align:left\">树的简写哈希值</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">%P</td>\n<td style=\"text-align:left\">父提交的完整哈希值</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">%p</td>\n<td style=\"text-align:left\">父提交的简写哈希值</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">%an</td>\n<td style=\"text-align:left\">作者名字</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">%ae</td>\n<td style=\"text-align:left\">作者的电子邮件地址</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">%ad</td>\n<td style=\"text-align:left\">作者修订日期（可以用 --date = 选项 来定制格式）</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">%ar</td>\n<td style=\"text-align:left\">作者修订日期，按多久以前的方式显示</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">%cn</td>\n<td style=\"text-align:left\">提交者的名字</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">%ce</td>\n<td style=\"text-align:left\">提交者的电子邮件地址</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">%cd</td>\n<td style=\"text-align:left\">提交日期</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">%cr</td>\n<td style=\"text-align:left\">提交日期（距今多长时间）</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">%s</td>\n<td style=\"text-align:left\">提交说明</td>\n</tr>\n</tbody>\n</table>\n<p>咦～？作者和提交这有什么区别呢？<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msup><mrow></mrow><mtext>❷</mtext></msup></mrow><annotation encoding=\"application/x-tex\">^❷</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.363em;vertical-align:0em;\"></span><span class=\"mord\"><span></span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.363em;\"><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">❷</span></span></span></span></span></span></span></span></span></span></span><br>\n这里，小白就要卖一个关子了。不过答案就在这个系列里～。因为在目前这总单分支的本地开发环境里，提交者就是作者。<br>\n另外在多分支的开发过车中，使用  <code>format</code>  配合  <code>--graph</code>  选项就尤为有用。后面介绍～</p>\n<h5 id=\"限制输出性的选项\"><a class=\"markdownIt-Anchor\" href=\"#限制输出性的选项\">#</a> 限制输出性的选项</h5>\n<p>上面用过了  <code>-&lt;number&gt;</code>  的方式来显示 git log 输出日志的条数，git 还提供了 类似于：  <code>--since</code>  和  <code>--until</code> ,  <code>--before</code>  等时间限制的选项目。</p>\n<p>比如：  <code>git log --since=2.weeks</code>  输出 2 周之内的提交记录。</p>\n<p>该命令可用的格式十分丰富 —— 可以是类似 “2008-01-15” 的具体的某一天，也可以是类似 “2 years 1 day 3 minutes ago” 的相对日期。<br>\n还可以过滤出匹配指定条件的提交。 用  <code>--author</code>  选项显示指定作者的提交，用  <code>--grep</code>  选项搜索提交说明中的关键字。</p>\n<p>另一个非常有用的过滤器是 -S（俗称 <code>“pickaxe”</code>  选项，取 “用鹤嘴锄在土里捡石头” 之意）， 它接受一个字符串参数，并且只会显示那些添加或删除了该字符串的提交。 假设你想找出添加或删除了对某一个特定函数的引用的提交，可以调用：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ git log -S function_name</span><br></pre></td></tr></table></figure>\n<p>最后一个很实用的  <code>git log</code>  选项是路径（ <code>path</code> ）， 如果只关心某些文件或者目录的历史提交，可以在  <code>git log</code>  选项的最后指定它们的路径。 因为是放在最后位置上的选项，所以用两个短划线（ <code>--</code> ）隔开之前的选项和后面限定的路径名。</p>\n<h2 id=\"git-commit-amend\"><a class=\"markdownIt-Anchor\" href=\"#git-commit-amend\">#</a>  <code>git commit --amend</code></h2>\n<p>这个命令可以让我们重写上一次的提交记录。<br>\n比如有下面这样的场景：</p>\n<p>小白修改了一个文件，提交了之后发现写了一个错别字，小白又想保持 <code>git</code>  提交历史的整洁。这时  <code>git commit -amend</code>  就派上了用场了。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">➜  gitlearn git:(master) git log --pretty=oneline</span><br><span class=\"line\">➜  gitlearn git:(master) echo &#x27;第留行&#x27; &gt;&gt; testGitLog</span><br><span class=\"line\">➜  gitlearn git:(master) ✗ git commit -a -m &quot;test git-log 6 &quot;</span><br><span class=\"line\">[detached HEAD f65b589] test git-log 6</span><br><span class=\"line\"> 1 file changed, 1 insertion(+)</span><br><span class=\"line\">➜  gitlearn git:(master) vim testGitLog</span><br><span class=\"line\">➜  gitlearn git:(master) ✗ git commit -a --amend -m &quot;test git-log 6 &quot;</span><br><span class=\"line\">[detached HEAD 1afd020] test git-log 6</span><br><span class=\"line\"> Date: Tue Jul 21 16:36:43 2020 +0800</span><br><span class=\"line\"> 1 file changed, 1 insertion(+)</span><br><span class=\"line\"></span><br><span class=\"line\"> # 查看提交日志</span><br><span class=\"line\">➜  gitlearn git:(master) git log --pretty=oneline</span><br><span class=\"line\">1afd020466eb9b519cec80415cb1e9c587612511 (HEAD) test git-log 6</span><br><span class=\"line\">769db1cd5ba091162707a3e648d67ec8e6913d2b test git-log 5</span><br><span class=\"line\">b9df1bb5c10f6602f7fa889ca91759a2e45e69cb test git-log 4</span><br><span class=\"line\">b282b882317b118095eb921e707e449f45fdeef6 test git-log 3</span><br><span class=\"line\">f8248a5fbc18a90710c95cee475b34797299bc61 test git-log 2</span><br><span class=\"line\">0718ac9a20021971d6f1a09a3ef72e36b6fd73c9 test git-log 1</span><br><span class=\"line\">(END)</span><br></pre></td></tr></table></figure>\n<p>注意！ 这里第二次提交的结果会替换掉之前的一次提交。</p>\n<p>以上就是本次 简约版本时光机的所有内容了。下一篇 远程仓库</p>\n<h3 id=\"最后\"><a class=\"markdownIt-Anchor\" href=\"#最后\">#</a> 最后</h3>\n<p>期望与你一起遇见更好的自己</p>\n<p><img data-src=\"/images/qrcode.jpg\" alt=\"期望与你一起遇见更好的自己\"></p>\n",
            "tags": [
                "git"
            ]
        },
        {
            "id": "https://fangjiaxiaobai.github.io/2021/07/18/git%E7%B3%BB%E5%88%97/07-git%E5%9F%BA%E6%9C%AC%E5%91%BD%E4%BB%A44-%E6%A0%87%E7%AD%BE%E5%92%8C%E5%88%AB%E5%90%8D/",
            "url": "https://fangjiaxiaobai.github.io/2021/07/18/git%E7%B3%BB%E5%88%97/07-git%E5%9F%BA%E6%9C%AC%E5%91%BD%E4%BB%A44-%E6%A0%87%E7%AD%BE%E5%92%8C%E5%88%AB%E5%90%8D/",
            "title": "git 基础 - 标签 和 别名",
            "date_published": "2021-07-18T06:49:55.000Z",
            "content_html": "<h3 id=\"标签\"><a class=\"markdownIt-Anchor\" href=\"#标签\">#</a> 标签</h3>\n<p>标签最主要的作用是，人们会使用这个功能来发布节点，作为一个里程碑等特殊意义的标识。</p>\n<p><code>git</code>  中标签使用  <code>tag</code>  来表示。对应着  <code>git tag</code>  这个命令。</p>\n<p>先看一下  <code>git tag</code>  命令吧。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">git tag [-a | -s | -u &lt;keyid&gt;] [-f] [-m &lt;msg&gt; | -F &lt;file&gt;]</span><br><span class=\"line\">        &lt;tagname&gt; [&lt;commit&gt; | &lt;object&gt;]</span><br><span class=\"line\">git tag -d &lt;tagname&gt;...</span><br><span class=\"line\">git tag [-n[&lt;num&gt;]] -l [--contains &lt;commit&gt;] [--no-contains &lt;commit&gt;]</span><br><span class=\"line\">        [--points-at &lt;object&gt;] [--column[=&lt;options&gt;] | --no-column]</span><br><span class=\"line\">        [--create-reflog] [--sort=&lt;key&gt;] [--format=&lt;format&gt;]</span><br><span class=\"line\">        [--[no-]merged [&lt;commit&gt;]] [&lt;pattern&gt;...]</span><br><span class=\"line\">git tag -v [--format=&lt;format&gt;] &lt;tagname&gt;...</span><br></pre></td></tr></table></figure>\n<p>老规矩，这里我们介绍几个常用的命令。</p>\n<h4 id=\"标签命令\"><a class=\"markdownIt-Anchor\" href=\"#标签命令\">#</a> 标签命令</h4>\n<p><code>git</code>  支持两种标签， 轻量标签 和 附注标签。</p>\n<p>轻量标签 是一个 <code>不会改变的分支</code> ，它只是一个特定的提交引用。<br>\n而附注标签是存储在 Git 数据库中的一个完整对象， 它们是可以被校验的，其中包含打标签者的名字、电子邮件地址、日期时间， 此外还有一个标签信息，并且可以使用 GNU Privacy Guard （GPG）签名并验证。 通常会建议创建附注标签，这样你可以拥有以上所有信息。但是如果你只是想用一个临时的标签， 或者因为某些原因不想要保存这些信息，那么也可以用轻量标签。</p>\n<p>这里我以功能为点，同时介绍两种标签的使用的方式。</p>\n<h5 id=\"创建标签\"><a class=\"markdownIt-Anchor\" href=\"#创建标签\">#</a> 创建标签</h5>\n<h6 id=\"创建附注标签\"><a class=\"markdownIt-Anchor\" href=\"#创建附注标签\">#</a> 创建附注标签</h6>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">➜  git_learn git:(master) git log --pretty=oneline</span><br><span class=\"line\">cbfebb28dde6707bf9dcc95175506a5c4cd4bfb4 (HEAD -&gt; master) commit 3</span><br><span class=\"line\">76400568f6397322f7d57d13834fa5ff6fbed2d9 commit 2</span><br><span class=\"line\">5758ef102fd4924ffbcf4c0cfeddac503deb32a9 commit 1</span><br><span class=\"line\"></span><br><span class=\"line\">## 添加标签</span><br><span class=\"line\">➜  git_learn git:(master) git tag -a v1.0 cbfebb28dde6707bf9dcc95175506a5c4cd4bfb4 -m &quot;第一个tag&quot;</span><br><span class=\"line\">## 查看标签的内容</span><br><span class=\"line\">➜  git_learn git:(master) git show v1.0</span><br><span class=\"line\"># 输出显示了打标签者的信息、打标签的日期时间、附注信息，然后显示具体的提交信息。  2</span><br><span class=\"line\">tag v1.0</span><br><span class=\"line\">Tagger: fangjiaxiaobai &lt;fangjiaxiaobai@163.com&gt;</span><br><span class=\"line\">Date:   Fri Jul 31 08:51:24 2020 +0800</span><br><span class=\"line\"></span><br><span class=\"line\">第一个tag</span><br><span class=\"line\"></span><br><span class=\"line\">commit cbfebb28dde6707bf9dcc95175506a5c4cd4bfb4 (HEAD -&gt; master, tag: v1.0)</span><br><span class=\"line\">Author: fangjiaxiaobai &lt;fangjiaxiaobai@163.com&gt;</span><br><span class=\"line\">Date:   Fri Jul 31 08:45:24 2020 +0800</span><br><span class=\"line\"></span><br><span class=\"line\">    commit 3</span><br><span class=\"line\"></span><br><span class=\"line\">diff --git a/test3.txt b/test3.txt</span><br><span class=\"line\">new file mode 100644</span><br><span class=\"line\">index 0000000..e69de29</span><br></pre></td></tr></table></figure>\n<p><code>-m</code>  选项指定了一条将会存储在标签中的信息。 如果没有为附注标签指定一条信息，Git 会启动编辑器要求你输入信息</p>\n<h3 id=\"最后\"><a class=\"markdownIt-Anchor\" href=\"#最后\">#</a> 最后</h3>\n<p>期望与你一起遇见更好的自己</p>\n<p><img data-src=\"/images/qrcode.jpg\" alt=\"期望与你一起遇见更好的自己\"></p>\n",
            "tags": [
                "git"
            ]
        },
        {
            "id": "https://fangjiaxiaobai.github.io/2021/07/18/git%E7%B3%BB%E5%88%97/13-git%E5%91%BD%E4%BB%A4/",
            "url": "https://fangjiaxiaobai.github.io/2021/07/18/git%E7%B3%BB%E5%88%97/13-git%E5%91%BD%E4%BB%A4/",
            "title": "git命令",
            "date_published": "2021-07-18T06:49:55.000Z",
            "content_html": "<p>本章开始学习一些在开发中常用的 git 命令</p>\n<p>先看一下 git 有多少个命令。</p>\n<p>直接在 命令行中输入 git 即可。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">➜  / git</span><br><span class=\"line\">usage: git [--version] [--help] [-C &lt;path&gt;] [-c name=value]</span><br><span class=\"line\">           [--exec-path[=&lt;path&gt;]] [--html-path] [--man-path] [--info-path]</span><br><span class=\"line\">           [-p | --paginate | --no-pager] [--no-replace-objects] [--bare]</span><br><span class=\"line\">           [--git-dir=&lt;path&gt;] [--work-tree=&lt;path&gt;] [--namespace=&lt;name&gt;]</span><br><span class=\"line\">           &lt;command&gt; [&lt;args&gt;]</span><br><span class=\"line\"></span><br><span class=\"line\">These are common Git commands used in various situations:</span><br><span class=\"line\"></span><br><span class=\"line\">start a working area (see also: git help tutorial)</span><br><span class=\"line\">   clone      Clone a repository into a new directory</span><br><span class=\"line\">   init       Create an empty Git repository or reinitialize an existing one</span><br><span class=\"line\"></span><br><span class=\"line\">work on the current change (see also: git help everyday)</span><br><span class=\"line\">   add        Add file contents to the index</span><br><span class=\"line\">   mv         Move or rename a file, a directory, or a symlink</span><br><span class=\"line\">   reset      Reset current HEAD to the specified state</span><br><span class=\"line\">   rm         Remove files from the working tree and from the index</span><br><span class=\"line\"></span><br><span class=\"line\">examine the history and state (see also: git help revisions)</span><br><span class=\"line\">   bisect     Use binary search to find the commit that introduced a bug</span><br><span class=\"line\">   grep       Print lines matching a pattern</span><br><span class=\"line\">   log        Show commit logs</span><br><span class=\"line\">   show       Show various types of objects</span><br><span class=\"line\">   status     Show the working tree status</span><br><span class=\"line\"></span><br><span class=\"line\">grow, mark and tweak your common history</span><br><span class=\"line\">   branch     List, create, or delete branches</span><br><span class=\"line\">   checkout   Switch branches or restore working tree files</span><br><span class=\"line\">   commit     Record changes to the repository</span><br><span class=\"line\">   diff       Show changes between commits, commit and working tree, etc</span><br><span class=\"line\">   merge      Join two or more development histories together</span><br><span class=\"line\">   rebase     Reapply commits on top of another base tip</span><br><span class=\"line\">   tag        Create, list, delete or verify a tag object signed with GPG</span><br><span class=\"line\"></span><br><span class=\"line\">collaborate (see also: git help workflows)</span><br><span class=\"line\">   fetch      Download objects and refs from another repository</span><br><span class=\"line\">   pull       Fetch from and integrate with another repository or a local branch</span><br><span class=\"line\">   push       Update remote refs along with associated objects</span><br><span class=\"line\"></span><br><span class=\"line\">&#x27;git help -a&#x27; and &#x27;git help -g&#x27; list available subcommands and some</span><br><span class=\"line\">concept guides. See &#x27;git help &lt;command&gt;&#x27; or &#x27;git help &lt;concept&gt;&#x27;</span><br><span class=\"line\">to read about a specific subcommand or concept.</span><br></pre></td></tr></table></figure>\n<p>小朋友，你以为 git 就这几个命令吗？</p>\n<p>太单纯！！！<br>\n还有很多命令！！ 下篇分享（也分享不完）</p>\n<h3 id=\"git-clone\"><a class=\"markdownIt-Anchor\" href=\"#git-clone\">#</a> git clone</h3>\n<h3 id=\"git-init\"><a class=\"markdownIt-Anchor\" href=\"#git-init\">#</a> git init</h3>\n<h3 id=\"git-add\"><a class=\"markdownIt-Anchor\" href=\"#git-add\">#</a> git add</h3>\n<h3 id=\"git-commit\"><a class=\"markdownIt-Anchor\" href=\"#git-commit\">#</a> git commit</h3>\n<h3 id=\"git-checkout\"><a class=\"markdownIt-Anchor\" href=\"#git-checkout\">#</a> git checkout</h3>\n<h3 id=\"git-log\"><a class=\"markdownIt-Anchor\" href=\"#git-log\">#</a> git log</h3>\n<h3 id=\"git-tag\"><a class=\"markdownIt-Anchor\" href=\"#git-tag\">#</a> git tag</h3>\n<h3 id=\"git-diff\"><a class=\"markdownIt-Anchor\" href=\"#git-diff\">#</a> git diff</h3>\n<h3 id=\"最后\"><a class=\"markdownIt-Anchor\" href=\"#最后\">#</a> 最后</h3>\n<p>期望与你一起遇见更好的自己</p>\n<p><img data-src=\"/images/qrcode.jpg\" alt=\"期望与你一起遇见更好的自己\"></p>\n",
            "tags": [
                "git"
            ]
        },
        {
            "id": "https://fangjiaxiaobai.github.io/2021/07/18/git%E7%B3%BB%E5%88%97/14-git%E5%85%B6%E4%BB%96%E5%91%BD%E4%BB%A4/",
            "url": "https://fangjiaxiaobai.github.io/2021/07/18/git%E7%B3%BB%E5%88%97/14-git%E5%85%B6%E4%BB%96%E5%91%BD%E4%BB%A4/",
            "title": "其他命令",
            "date_published": "2021-07-18T06:49:55.000Z",
            "content_html": "<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">usage: git [--version] [--help] [-C &lt;path&gt;] [-c name=value]</span><br><span class=\"line\">           [--exec-path[=&lt;path&gt;]] [--html-path] [--man-path] [--info-path]</span><br><span class=\"line\">           [-p | --paginate | --no-pager] [--no-replace-objects] [--bare]</span><br><span class=\"line\">           [--git-dir=&lt;path&gt;] [--work-tree=&lt;path&gt;] [--namespace=&lt;name&gt;]</span><br><span class=\"line\">           &lt;command&gt; [&lt;args&gt;]</span><br><span class=\"line\"></span><br><span class=\"line\">available git commands in &#x27;/usr/local/git/libexec/git-core&#x27;</span><br><span class=\"line\"></span><br><span class=\"line\">  add                       diff-index                merge-octopus             reset</span><br><span class=\"line\">  add--interactive          diff-tree                 merge-one-file            rev-list</span><br><span class=\"line\">  am                        difftool                  merge-ours                rev-parse</span><br><span class=\"line\">  annotate                  difftool--helper          merge-recursive           revert</span><br><span class=\"line\">  apply                     fast-export               merge-resolve             rm</span><br><span class=\"line\">  archimport                fast-import               merge-subtree             send-email</span><br><span class=\"line\">  archive                   fetch                     merge-tree                send-pack</span><br><span class=\"line\">  bisect                    fetch-pack                mergetool                 sh-i18n--envsubst</span><br><span class=\"line\">  bisect--helper            filter-branch             mktag                     shell</span><br><span class=\"line\">  blame                     fmt-merge-msg             mktree                    shortlog</span><br><span class=\"line\">  branch                    for-each-ref              mv                        show</span><br><span class=\"line\">  bundle                    format-patch              name-rev                  show-branch</span><br><span class=\"line\">  cat-file                  fsck                      notes                     show-index</span><br><span class=\"line\">  check-attr                fsck-objects              p4                        show-ref</span><br><span class=\"line\">  check-ignore              gc                        pack-objects              stage</span><br><span class=\"line\">  check-mailmap             get-tar-commit-id         pack-redundant            stash</span><br><span class=\"line\">  check-ref-format          grep                      pack-refs                 status</span><br><span class=\"line\">  checkout                  gui                       patch-id                  stripspace</span><br><span class=\"line\">  checkout-index            gui--askpass              prune                     submodule</span><br><span class=\"line\">  cherry                    hash-object               prune-packed              submodule--helper</span><br><span class=\"line\">  cherry-pick               help                      pull                      subtree</span><br><span class=\"line\">  citool                    http-backend              push                      svn</span><br><span class=\"line\">  clean                     http-fetch                quiltimport               symbolic-ref</span><br><span class=\"line\">  clone                     http-push                 read-tree                 tag</span><br><span class=\"line\">  column                    imap-send                 rebase                    unpack-file</span><br><span class=\"line\">  commit                    index-pack                rebase--helper            unpack-objects</span><br><span class=\"line\">  commit-tree               init                      receive-pack              update-index</span><br><span class=\"line\">  config                    init-db                   reflog                    update-ref</span><br><span class=\"line\">  count-objects             instaweb                  remote                    update-server-info</span><br><span class=\"line\">  credential                interpret-trailers        remote-ext                upload-archive</span><br><span class=\"line\">  credential-cache          log                       remote-fd                 upload-pack</span><br><span class=\"line\">  credential-cache--daemon  ls-files                  remote-ftp                var</span><br><span class=\"line\">  credential-store          ls-remote                 remote-ftps               verify-commit</span><br><span class=\"line\">  cvsexportcommit           ls-tree                   remote-http               verify-pack</span><br><span class=\"line\">  cvsimport                 mailinfo                  remote-https              verify-tag</span><br><span class=\"line\">  cvsserver                 mailsplit                 remote-testsvn            web--browse</span><br><span class=\"line\">  daemon                    merge                     repack                    whatchanged</span><br><span class=\"line\">  describe                  merge-base                replace                   worktree</span><br><span class=\"line\">  diff                      merge-file                request-pull              write-tree</span><br><span class=\"line\">  diff-files                merge-index               rerere</span><br><span class=\"line\"></span><br><span class=\"line\">git commands available from elsewhere on your $PATH</span><br><span class=\"line\"></span><br><span class=\"line\">  credential-osxkeychain</span><br><span class=\"line\"></span><br><span class=\"line\">&#x27;git help -a&#x27; and &#x27;git help -g&#x27; list available subcommands and some</span><br><span class=\"line\">concept guides. See &#x27;git help &lt;command&gt;&#x27; or &#x27;git help &lt;concept&gt;&#x27;</span><br><span class=\"line\">to read about a specific subcommand or concept.</span><br></pre></td></tr></table></figure>\n<p>除去上篇文章中介绍的命令，这些命令就相对高端了～，我们还是挑一些可以用得到来分享。</p>\n<h3 id=\"命令解释\"><a class=\"markdownIt-Anchor\" href=\"#命令解释\">#</a> 命令解释</h3>\n<ul>\n<li>git hash-object</li>\n</ul>\n<h3 id=\"最后\"><a class=\"markdownIt-Anchor\" href=\"#最后\">#</a> 最后</h3>\n<p>期望与你一起遇见更好的自己</p>\n<p><img data-src=\"/images/qrcode.jpg\" alt=\"期望与你一起遇见更好的自己\"></p>\n",
            "tags": [
                "git"
            ]
        },
        {
            "id": "https://fangjiaxiaobai.github.io/2021/07/18/git%E7%B3%BB%E5%88%97/20-git%E5%BC%80%E5%8F%91%E6%A8%A1%E5%9E%8B/",
            "url": "https://fangjiaxiaobai.github.io/2021/07/18/git%E7%B3%BB%E5%88%97/20-git%E5%BC%80%E5%8F%91%E6%A8%A1%E5%9E%8B/",
            "title": "git开发模型 - github-flow",
            "date_published": "2021-07-18T06:49:55.000Z",
            "content_html": "<h3 id=\"github-flow\"><a class=\"markdownIt-Anchor\" href=\"#github-flow\">#</a>  <code>github flow</code></h3>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9ndWlkZXMuZ2l0aHViLmNvbS9pbnRyb2R1Y3Rpb24vZmxvdy8=\">参考地址</span></p>\n<p><code>GitHub flow</code>  是一个轻量级的，基于分支的工作流，它支持定期进行部署的团队和项目。</p>\n<p><code>gitHub flow</code>  主要分为以下步骤：</p>\n<h4 id=\"1创建分支\"><a class=\"markdownIt-Anchor\" href=\"#1创建分支\">#</a> 1. 创建分支</h4>\n<p><img data-src=\"./images/github-flow6.png\" alt=\"github-flow6.png\"></p>\n<p>在你准备进行开发的时候，或者突然有一个想法，想要马上去实现的时候，先创建一个分支。</p>\n<p>分支是 <code>Git</code>  中的核心概念，整个 <code>GitHub</code>  流程都以此为基础。只有一个规则： <code>master</code>  分支中的任何内容始终都是可部署的。因此，在处理功能或修订时，要在主分支之外创建新分支非常重要。您的分支名称应具有描述性（例如，重构身份验证，用户内容缓存密钥， <code>make-retina</code>  头像），以便其他人可以看到正在处理的内容。</p>\n<h4 id=\"2-添加提交\"><a class=\"markdownIt-Anchor\" href=\"#2-添加提交\">#</a> 2. 添加提交</h4>\n<p><img data-src=\"./images/github-flow6.png\" alt=\"github-flow6.png\"></p>\n<p>创建分支后，就该开始进行更改了。每当添加，编辑或删除文件时，您都在进行提交，并将其添加到分支中。添加提交的过程会使 git 跟踪您在功能分支上工作的进度。提交还会为您的工作创建透明的历史记录，其他人可以参考该历史记录来了解您的工作以及原因。每个提交都有一个关联的提交消息，该消息是说明为什么进行特定更改的说明。此外，每次提交都被视为一个单独的变更单元。如果发现错误或决定朝另一个方向前进，则可以回滚更改。</p>\n<h4 id=\"3打开拉取请求\"><a class=\"markdownIt-Anchor\" href=\"#3打开拉取请求\">#</a> 3. 打开拉取请求</h4>\n<p><img data-src=\"./images/github-flow6.png\" alt=\"github-flow6.png\"></p>\n<p>将我们本地开发的代码 <code>commit</code>  了之后，在 <code>push</code>  远程仓库之前，我们要 发起一次  <code>pull request</code> . 这最直接的效果就是如果存在冲突，我们就可以现在本地完成冲突的处理。其次，通过 <code>pull request</code>  我们还可以看到团队中其他成员的工作内容，获取该项目中最新的代码。</p>\n<h4 id=\"4讨论并检查您的代码\"><a class=\"markdownIt-Anchor\" href=\"#4讨论并检查您的代码\">#</a> 4. 讨论并检查您的代码</h4>\n<p><img data-src=\"./images/github-flow6.png\" alt=\"github-flow6.png\"></p>\n<p>打开 “拉取请求” 后，审阅您所做更改的人员或团队可能会有疑问或意见。也许编码风格与项目准则不匹配，更改缺少单元测试，或者一切看起来都很不错，并且道具井井有条。提取请求旨在鼓励和捕获这种类型的对话。您还可以根据有关提交的讨论和反馈继续推送到分支机构。如果有人评论您忘记做某事，或者代码中有错误，则可以在分支机构中对其进行修复，然后进行更改。 <code>GitHub</code>  将在统一的 “拉取请求” 视图中显示您的新提交以及您可能收到的任何其他反馈。</p>\n<h4 id=\"部署\"><a class=\"markdownIt-Anchor\" href=\"#部署\">#</a> 部署</h4>\n<p><img data-src=\"./images/github-flow5.png\" alt=\"github-flow5.png\"></p>\n<p>借助 <code>GitHub</code> ，您可以从分支机构进行部署，以在正式合并之前进行生产中的最终测试。审核拉取请求并且分支机构通过测试后，您可以部署更改以在生产中进行验证。如果您的分支机构引起问题，则可以通过将现有的主服务器部署到生产中来回滚它。</p>\n<h4 id=\"合并到master分支\"><a class=\"markdownIt-Anchor\" href=\"#合并到master分支\">#</a> 合并到 master 分支</h4>\n<p><img data-src=\"/images/git%E7%B3%BB%E5%88%97/images/github-flow6.png\" alt=\"github-flow6.png\"></p>\n<p>现在您的更改已在生产环境中得到验证，是时候将代码合并到 <code>master</code>  分支中了。合并后，拉取请求会保留代码历史更改的记录。因为它们是可搜索的，所以它们使任何人都能及时返回，以了解做出决定的原因和方式。</p>\n<h3 id=\"最后\"><a class=\"markdownIt-Anchor\" href=\"#最后\">#</a> 最后</h3>\n<p>期望与你一起遇见更好的自己</p>\n<p><img data-src=\"/images/qrcode.jpg\" alt=\"期望与你一起遇见更好的自己\"></p>\n",
            "tags": [
                "git"
            ]
        },
        {
            "id": "https://fangjiaxiaobai.github.io/2021/07/18/git%E7%B3%BB%E5%88%97/06-git%E5%9F%BA%E6%9C%AC%E5%91%BD%E4%BB%A43-%E8%BF%9C%E7%A8%8B%E4%BB%93%E5%BA%93/",
            "url": "https://fangjiaxiaobai.github.io/2021/07/18/git%E7%B3%BB%E5%88%97/06-git%E5%9F%BA%E6%9C%AC%E5%91%BD%E4%BB%A43-%E8%BF%9C%E7%A8%8B%E4%BB%93%E5%BA%93/",
            "title": "git命令3 - 远程仓库",
            "date_published": "2021-07-18T06:49:55.000Z",
            "content_html": "<h1 id=\"\"><a class=\"markdownIt-Anchor\" href=\"#\">#</a> </h1>\n<p>远程仓库指的是 托管到因特网或者其他网络中的项目的版本库。</p>\n<p>可以使用  <code>git remote</code>  命令来配置远程仓库。</p>\n<p>我们先看一下  <code>git remote</code>  命令都有什么子选项.</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">git remote [-v | --verbose]</span><br><span class=\"line\">git remote add [-t &lt;branch&gt;] [-m &lt;master&gt;] [-f] [--[no-]tags] [--mirror=&lt;fetch|push&gt;] &lt;name&gt; &lt;url&gt;</span><br><span class=\"line\">git remote rename &lt;old&gt; &lt;new&gt;</span><br><span class=\"line\">git remote remove &lt;name&gt;</span><br><span class=\"line\">git remote set-head &lt;name&gt; (-a | --auto | -d | --delete | &lt;branch&gt;)</span><br><span class=\"line\">git remote set-branches [--add] &lt;name&gt; &lt;branch&gt;...</span><br><span class=\"line\">git remote get-url [--push] [--all] &lt;name&gt;</span><br><span class=\"line\">git remote set-url [--push] &lt;name&gt; &lt;newurl&gt; [&lt;oldurl&gt;]</span><br><span class=\"line\">git remote set-url --add [--push] &lt;name&gt; &lt;newurl&gt;</span><br><span class=\"line\">git remote set-url --delete [--push] &lt;name&gt; &lt;url&gt;</span><br><span class=\"line\">git remote [-v | --verbose] show [-n] &lt;name&gt;...</span><br><span class=\"line\">git remote prune [-n | --dry-run] &lt;name&gt;...</span><br><span class=\"line\">git remote [-v | --verbose] update [-p | --prune] [(&lt;group&gt; | &lt;remote&gt;)...]</span><br></pre></td></tr></table></figure>\n<p>下面我们只介绍几个常用的远程仓库的命令</p>\n<h3 id=\"配置远程仓库-git-remote-add\"><a class=\"markdownIt-Anchor\" href=\"#配置远程仓库-git-remote-add\">#</a> 配置远程仓库 -  <code>git remote add</code></h3>\n<p><code>git remote add [-t &lt;branch&gt;] [-m &lt;master&gt;] [-f] [--[no-]tags] [--mirror=&lt;fetch|push&gt;] &lt;name&gt; &lt;url&gt;</code></p>\n<p>首先在页面上新建一个空的仓库备用。<br>\n<img data-src=\"/images/git%E7%B3%BB%E5%88%97/images/web%E9%A1%B5%E9%9D%A2%E4%B8%8A%E6%96%B0%E5%BB%BAgit%E8%BF%9C%E7%A8%8B%E4%BB%93%E5%BA%93.png\" alt=\"web页面上新建git远程仓库.png\"><br>\n 演示一下使用:</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">➜  gitlearn git init .</span><br><span class=\"line\">Initialized empty Git repository in /private/tmp/gitlearn/.git/</span><br><span class=\"line\">➜  gitlearn git:(master) echo &#x27;演示配置远程仓库&#x27; &gt; testRemoteGit</span><br><span class=\"line\">➜  gitlearn git:(master) ✗ git add .</span><br><span class=\"line\">➜  gitlearn git:(master) ✗ git commit -m &quot;新增一个文件，初始化项目&quot;</span><br><span class=\"line\">[master (root-commit) 5ed81fa] 新增一个文件，初始化项目</span><br><span class=\"line\"> 1 file changed, 1 insertion(+)</span><br><span class=\"line\"> create mode 100644 testRemoteGit</span><br><span class=\"line\"> # 配置远程仓库</span><br><span class=\"line\">➜  gitlearn git:(master) git remote add origin https://gitee.com/fangjiaxiaobai/gitlearn.git</span><br><span class=\"line\"># 查看远程仓库</span><br><span class=\"line\">➜  gitlearn git:(master) git remote -v</span><br><span class=\"line\">origin\thttps://gitee.com/fangjiaxiaobai/gitlearn.git (fetch)</span><br><span class=\"line\">origin\thttps://gitee.com/fangjiaxiaobai/gitlearn.git (push)</span><br><span class=\"line\"></span><br><span class=\"line\">## 在增加一个远程仓库</span><br><span class=\"line\">➜  gitlearn git:(master) git remote add origin2 http://git.baijiahulian.com/wangxiyue/gitlearn.git</span><br><span class=\"line\">➜  gitlearn git:(master) git remote -v</span><br><span class=\"line\">origin\thttps://gitee.com/fangjiaxiaobai/gitlearn.git (fetch)</span><br><span class=\"line\">origin\thttps://gitee.com/fangjiaxiaobai/gitlearn.git (push)</span><br><span class=\"line\">origin2\thttp://git.baijiahulian.com/wangxiyue/gitlearn.git (fetch)</span><br><span class=\"line\">origin2\thttp://git.baijiahulian.com/wangxiyue/gitlearn.git (push)</span><br></pre></td></tr></table></figure>\n<h3 id=\"将本地的文件推送到远程仓库中\"><a class=\"markdownIt-Anchor\" href=\"#将本地的文件推送到远程仓库中\">#</a> 将本地的文件推送到远程仓库中</h3>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">➜  gitlearn git:(master) git push origin master</span><br><span class=\"line\">Counting objects: 3, done.</span><br><span class=\"line\">Writing objects: 100% (3/3), 281 bytes | 281.00 KiB/s, done.</span><br><span class=\"line\">Total 3 (delta 0), reused 0 (delta 0)</span><br><span class=\"line\">remote: Powered by GITEE.COM [GNK-5.0]</span><br><span class=\"line\">To https://gitee.com/fangjiaxiaobai/gitlearn.git</span><br><span class=\"line\"> * [new branch]      master -&gt; master</span><br><span class=\"line\">➜  gitlearn git:(master)</span><br></pre></td></tr></table></figure>\n<h3 id=\"从git仓库中拉取数据\"><a class=\"markdownIt-Anchor\" href=\"#从git仓库中拉取数据\">#</a> 从 git 仓库中拉取数据</h3>\n<p>可以使用  <code>git fetch</code>  命令。 我们现在页面上的一个仓库中手动修改一个文件来演示一下 fetch 的功能。</p>\n<p>在页面就行点击编辑，然后加上  <code>这里是在远程仓库中加入的内容。</code> 这样一句话。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">➜  gitlearn git:(master) git fetch origin</span><br><span class=\"line\">remote: Enumerating objects: 5, done.</span><br><span class=\"line\">remote: Counting objects: 100% (5/5), done.</span><br><span class=\"line\">remote: Compressing objects: 100% (2/2), done.</span><br><span class=\"line\">remote: Total 3 (delta 0), reused 0 (delta 0), pack-reused 0</span><br><span class=\"line\">Unpacking objects: 100% (3/3), done.</span><br><span class=\"line\">From https://gitee.com/fangjiaxiaobai/gitlearn</span><br><span class=\"line\">   5ed81fa..62be3ab  master     -&gt; origin/master</span><br></pre></td></tr></table></figure>\n<p>使用  <code>git pull</code>  也可以得到相同的结果。</p>\n<h3 id=\"查看某个远程仓库\"><a class=\"markdownIt-Anchor\" href=\"#查看某个远程仓库\">#</a> 查看某个远程仓库</h3>\n<p><code>git remote show</code>  来查看远程仓库中的内容。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">➜  gitlearn git:(master) git remote show origin</span><br><span class=\"line\">* remote origin</span><br><span class=\"line\">  Fetch URL: https://gitee.com/fangjiaxiaobai/gitlearn.git</span><br><span class=\"line\">  Push  URL: https://gitee.com/fangjiaxiaobai/gitlearn.git</span><br><span class=\"line\">  HEAD branch: master</span><br><span class=\"line\">  Remote branch:</span><br><span class=\"line\">    master tracked</span><br><span class=\"line\">  Local ref configured for &#x27;git push&#x27;:</span><br><span class=\"line\">    master pushes to master (local out of date)</span><br></pre></td></tr></table></figure>\n<p>它会列出远程仓库的  <code>URL</code>  与跟踪分支的信息。因为我们这是一个新建的仓库，这里我粘贴一个很多次提交的项目来看一下。</p>\n<p><img data-src=\"/images/git%E7%B3%BB%E5%88%97/images/gitRemote%E5%88%86%E6%94%AF%E7%8A%B6%E6%80%81.png\" alt=\"gitRemote分支状态\"></p>\n<p>这个命令列出了当你在特定的分支上执行  <code>git push</code>  会自动地推送到哪一个远程分支。 它也同样地列出了哪些远程分支不在你的本地，哪些远程分支已经从服务器上移除了， 还有当你执行  <code>git pull</code>  时哪些本地分支可以与它跟踪的远程分支自动合并。</p>\n<h4 id=\"重命名远程仓库\"><a class=\"markdownIt-Anchor\" href=\"#重命名远程仓库\">#</a> 重命名远程仓库</h4>\n<p>使用  <code>git remote renam</code> e 命令可以来重命名仓库。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">➜  gitlearn git:(master) git remote rename origin giteeOrigin</span><br><span class=\"line\">➜  gitlearn git:(master) git remote -v</span><br><span class=\"line\">giteeOrigin\thttps://gitee.com/fangjiaxiaobai/gitlearn.git (fetch)</span><br><span class=\"line\">giteeOrigin\thttps://gitee.com/fangjiaxiaobai/gitlearn.git (push)</span><br><span class=\"line\">origin2\thttp://git.baijiahulian.com/wangxiyue/gitlearn.git (fetch)</span><br><span class=\"line\">origin2\thttp://git.baijiahulian.com/wangxiyue/gitlearn.git (push)</span><br></pre></td></tr></table></figure>\n<h4 id=\"删除远程分支\"><a class=\"markdownIt-Anchor\" href=\"#删除远程分支\">#</a> 删除远程分支</h4>\n<p>使用命令  <code>git remote remove</code>  命令可以删除远程仓库。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">➜  gitlearn git:(master) git remote remove giteeOrigin</span><br><span class=\"line\"></span><br><span class=\"line\">➜  gitlearn git:(master) git remote -v</span><br><span class=\"line\">origin2\thttp://git.baijiahulian.com/wangxiyue/gitlearn.git (fetch)</span><br><span class=\"line\">origin2\thttp://git.baijiahulian.com/wangxiyue/gitlearn.git (push)</span><br></pre></td></tr></table></figure>\n<p>一旦你使用这种方式删除了一个远程仓库，那么所有和这个远程仓库相关的远程跟踪分支以及配置信息也会一起被删除。</p>\n<h3 id=\"最后\"><a class=\"markdownIt-Anchor\" href=\"#最后\">#</a> 最后</h3>\n<p>期望与你一起遇见更好的自己</p>\n<p><img data-src=\"/images/qrcode.jpg\" alt=\"期望与你一起遇见更好的自己\"></p>\n",
            "tags": [
                "git"
            ]
        },
        {
            "id": "https://fangjiaxiaobai.github.io/2021/07/18/git%E7%B3%BB%E5%88%97/git%E5%91%BD%E4%BB%A4%E8%AF%A6%E8%A7%A3/README/",
            "url": "https://fangjiaxiaobai.github.io/2021/07/18/git%E7%B3%BB%E5%88%97/git%E5%91%BD%E4%BB%A4%E8%AF%A6%E8%A7%A3/README/",
            "title": "git命令详解",
            "date_published": "2021-07-18T06:49:55.000Z",
            "content_html": "<h2 id=\"\"><a class=\"markdownIt-Anchor\" href=\"#\">#</a> </h2>\n<h3 id=\"目录\"><a class=\"markdownIt-Anchor\" href=\"#目录\">#</a> 目录</h3>\n<ul class=\"task-list\">\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"cbx_0\" disabled=\"true\"><label for=\"cbx_0\"> <a href=\"./git_update-index.md\">git update-index</a></label></li>\n</ul>\n<h3 id=\"小技巧\"><a class=\"markdownIt-Anchor\" href=\"#小技巧\">#</a> 小技巧</h3>\n<ul>\n<li>某个文件需要被管理，但是要忽略其修改的内容。 <a href=\"./git_update-index.md\">git update-index</a><br>\ngit update-index --no-skip-worktree 同样可以。<br>\n<span class=\"exturl\" data-url=\"aHR0cHM6Ly9zZWdtZW50ZmF1bHQuY29tL3EvMTAxMDAwMDAwMDQzMDQyNg==\">参考文档</span>   <span class=\"exturl\" data-url=\"aHR0cHM6Ly9zZWdtZW50ZmF1bHQuY29tL3EvMTAxMDAwMDAwMDM1ODU4OA==\">参考文档 2</span></li>\n</ul>\n<h3 id=\"最后\"><a class=\"markdownIt-Anchor\" href=\"#最后\">#</a> 最后</h3>\n<p>期望与你一起遇见更好的自己</p>\n<p><img data-src=\"/images/qrcode.jpg\" alt=\"期望与你一起遇见更好的自己\"></p>\n",
            "tags": [
                "git"
            ]
        },
        {
            "id": "https://fangjiaxiaobai.github.io/2021/07/18/git%E7%B3%BB%E5%88%97/git%E5%91%BD%E4%BB%A4%E8%AF%A6%E8%A7%A3/git_update-index/",
            "url": "https://fangjiaxiaobai.github.io/2021/07/18/git%E7%B3%BB%E5%88%97/git%E5%91%BD%E4%BB%A4%E8%AF%A6%E8%A7%A3/git_update-index/",
            "title": "git命令详解之 git update-index",
            "date_published": "2021-07-18T06:49:55.000Z",
            "content_html": "<h3 id=\"官方\"><a class=\"markdownIt-Anchor\" href=\"#官方\">#</a> 官方</h3>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">usage: git update-index [&lt;options&gt;] [--] [&lt;file&gt;...]</span><br><span class=\"line\"></span><br><span class=\"line\">    -q                    continue refresh even when index needs update</span><br><span class=\"line\">    --ignore-submodules   refresh: ignore submodules</span><br><span class=\"line\">    --add                 do not ignore new files</span><br><span class=\"line\">    --replace             let files replace directories and vice-versa</span><br><span class=\"line\">    --remove              notice files missing from worktree</span><br><span class=\"line\">    --unmerged            refresh even if index contains unmerged entries</span><br><span class=\"line\">    --refresh             refresh stat information</span><br><span class=\"line\">    --really-refresh      like --refresh, but ignore assume-unchanged setting</span><br><span class=\"line\">    --cacheinfo &lt;mode&gt;,&lt;object&gt;,&lt;path&gt;</span><br><span class=\"line\">                          add the specified entry to the index</span><br><span class=\"line\">    --chmod (+/-)x        override the executable bit of the listed files</span><br><span class=\"line\">    --assume-unchanged    mark files as &quot;not changing&quot;</span><br><span class=\"line\">    --no-assume-unchanged</span><br><span class=\"line\">                          clear assumed-unchanged bit</span><br><span class=\"line\">    --skip-worktree       mark files as &quot;index-only&quot;</span><br><span class=\"line\">    --no-skip-worktree    clear skip-worktree bit</span><br><span class=\"line\">    --info-only           add to index only; do not add content to object database</span><br><span class=\"line\">    --force-remove        remove named paths even if present in worktree</span><br><span class=\"line\">    -z                    with --stdin: input lines are terminated by null bytes</span><br><span class=\"line\">    --stdin               read list of paths to be updated from standard input</span><br><span class=\"line\">    --index-info          add entries from standard input to the index</span><br><span class=\"line\">    --unresolve           repopulate stages #2 and #3 for the listed paths</span><br><span class=\"line\">    -g, --again           only update entries that differ from HEAD</span><br><span class=\"line\">    --ignore-missing      ignore files missing from worktree</span><br><span class=\"line\">    --verbose             report actions to standard output</span><br><span class=\"line\">    --clear-resolve-undo  (for porcelains) forget saved unresolved conflicts</span><br><span class=\"line\">    --index-version &lt;n&gt;   write index in this format</span><br><span class=\"line\">    --split-index         enable or disable split index</span><br><span class=\"line\">    --untracked-cache     enable/disable untracked cache</span><br><span class=\"line\">    --test-untracked-cache</span><br><span class=\"line\">                          test if the filesystem supports untracked cache</span><br><span class=\"line\">    --force-untracked-cache</span><br><span class=\"line\">                          enable untracked cache without testing the filesystem</span><br></pre></td></tr></table></figure>\n<h3 id=\"最后\"><a class=\"markdownIt-Anchor\" href=\"#最后\">#</a> 最后</h3>\n<p>期望与你一起遇见更好的自己</p>\n<p><img data-src=\"/images/qrcode.jpg\" alt=\"期望与你一起遇见更好的自己\"></p>\n",
            "tags": [
                "git"
            ]
        },
        {
            "id": "https://fangjiaxiaobai.github.io/2021/07/18/git%E7%B3%BB%E5%88%97/git%E5%91%BD%E4%BB%A4%E8%AF%A6%E8%A7%A3/git_ls-files/",
            "url": "https://fangjiaxiaobai.github.io/2021/07/18/git%E7%B3%BB%E5%88%97/git%E5%91%BD%E4%BB%A4%E8%AF%A6%E8%A7%A3/git_ls-files/",
            "title": "git命令详解之 git ls-files",
            "date_published": "2021-07-18T06:49:55.000Z",
            "content_html": "<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">usage: git ls-files [&lt;options&gt;] [&lt;file&gt;...]</span><br><span class=\"line\"></span><br><span class=\"line\">    -z                    paths are separated with NUL character</span><br><span class=\"line\">    -t                    identify the file status with tags</span><br><span class=\"line\">    -v                    use lowercase letters for &#x27;assume unchanged&#x27; files</span><br><span class=\"line\">    -c, --cached          show cached files in the output (default)</span><br><span class=\"line\">    -d, --deleted         show deleted files in the output</span><br><span class=\"line\">    -m, --modified        show modified files in the output</span><br><span class=\"line\">    -o, --others          show other files in the output</span><br><span class=\"line\">    -i, --ignored         show ignored files in the output</span><br><span class=\"line\">    -s, --stage           show staged contents&#x27; object name in the output</span><br><span class=\"line\">    -k, --killed          show files on the filesystem that need to be removed</span><br><span class=\"line\">    --directory           show &#x27;other&#x27; directories&#x27; names only</span><br><span class=\"line\">    --eol                 show line endings of files</span><br><span class=\"line\">    --empty-directory     don&#x27;t show empty directories</span><br><span class=\"line\">    -u, --unmerged        show unmerged files in the output</span><br><span class=\"line\">    --resolve-undo        show resolve-undo information</span><br><span class=\"line\">    -x, --exclude &lt;pattern&gt;</span><br><span class=\"line\">                          skip files matching pattern</span><br><span class=\"line\">    -X, --exclude-from &lt;file&gt;</span><br><span class=\"line\">                          exclude patterns are read from &lt;file&gt;</span><br><span class=\"line\">    --exclude-per-directory &lt;file&gt;</span><br><span class=\"line\">                          read additional per-directory exclude patterns in &lt;file&gt;</span><br><span class=\"line\">    --exclude-standard    add the standard git exclusions</span><br><span class=\"line\">    --full-name           make the output relative to the project top directory</span><br><span class=\"line\">    --recurse-submodules  recurse through submodules</span><br><span class=\"line\">    --error-unmatch       if any &lt;file&gt; is not in the index, treat this as an error</span><br><span class=\"line\">    --with-tree &lt;tree-ish&gt;</span><br><span class=\"line\">                          pretend that paths removed since &lt;tree-ish&gt; are still present</span><br><span class=\"line\">    --abbrev[=&lt;n&gt;]        use &lt;n&gt; digits to display SHA-1s</span><br><span class=\"line\">    --debug               show debugging data</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h3 id=\"最后\"><a class=\"markdownIt-Anchor\" href=\"#最后\">#</a> 最后</h3>\n<p>期望与你一起遇见更好的自己</p>\n<p><img data-src=\"/images/qrcode.jpg\" alt=\"期望与你一起遇见更好的自己\"></p>\n",
            "tags": [
                "git"
            ]
        },
        {
            "id": "https://fangjiaxiaobai.github.io/2021/07/18/git%E7%B3%BB%E5%88%97/03-git%E5%91%BD%E4%BB%A4%E4%B9%8B%E4%BB%8E%E5%88%9B%E5%BB%BA%E4%BB%93%E5%BA%93%E5%BC%80%E5%A7%8B/",
            "url": "https://fangjiaxiaobai.github.io/2021/07/18/git%E7%B3%BB%E5%88%97/03-git%E5%91%BD%E4%BB%A4%E4%B9%8B%E4%BB%8E%E5%88%9B%E5%BB%BA%E4%BB%93%E5%BA%93%E5%BC%80%E5%A7%8B/",
            "title": "从创建仓库开始",
            "date_published": "2021-07-18T06:49:55.000Z",
            "content_html": "<h2 id=\"从创建仓库开始\"><a class=\"markdownIt-Anchor\" href=\"#从创建仓库开始\">#</a> 从创建仓库开始</h2>\n<p>这篇文章分享一下我们在使用 git 进行版本管理时候的常用的操作！我们从创建仓库开始～</p>\n<p>获取代码仓库的方式有两种，一种是从零开始初始化一个 git 仓库，另一种是 clone 他人的仓库。</p>\n<p>首先我们创建一个空目录，然后初始化一个仓库。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">/ cd</span><br><span class=\"line\"># 创建空目录</span><br><span class=\"line\">~ mkdir gitlearn</span><br><span class=\"line\">~ cd gitlearn</span><br><span class=\"line\"># 初始化仓库</span><br><span class=\"line\">~ git init .</span><br></pre></td></tr></table></figure>\n<p>就这样我们创建一个了<b>本地仓库</b>, 团队合作的时候这样肯定不行的，不行，后面我们后介绍到。<br>\n或者 我们还可以克隆一个<b>远程仓库</b></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">git clone https://gitee.com/fangjiaxiaobai/gitlearn.git</span><br></pre></td></tr></table></figure>\n<p>我们来看一下新建的仓库目录下都有什么文件。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">➜  gitlearn git:(master) l</span><br><span class=\"line\">total 0</span><br><span class=\"line\">drwxr-xr-x   3 bjhl  wheel    96B  7 13 18:23 .</span><br><span class=\"line\">drwxr-xr-x   3 bjhl  wheel    96B  7 13 18:23 ..</span><br><span class=\"line\">drwxr-xr-x  10 bjhl  wheel   320B  7 13 18:25 .git</span><br><span class=\"line\">➜  gitlearn git:(master) cd .git</span><br><span class=\"line\">➜  .git git:(master) l</span><br><span class=\"line\">total 24</span><br><span class=\"line\">drwxr-xr-x  10 bjhl  wheel   320B  7 13 18:30 .</span><br><span class=\"line\">drwxr-xr-x   3 bjhl  wheel    96B  7 13 18:23 ..</span><br><span class=\"line\">-rw-r--r--   1 bjhl  wheel    16B  7 13 20:38 COMMIT_EDITMSG # 存储最新一次的commit信息</span><br><span class=\"line\">-rw-r--r--   1 bjhl  wheel    23B  7 13 18:23 HEAD ## 当前被检出的分支</span><br><span class=\"line\">drwxr-xr-x   2 bjhl  wheel    64B  7 13 18:23 branches # 所有分支</span><br><span class=\"line\">-rw-r--r--   1 bjhl  wheel   315B  7 13 18:23 config # 包含项目特有的配置选项</span><br><span class=\"line\">-rw-r--r--   1 bjhl  wheel    73B  7 13 18:23 description #Git web页面程序使用</span><br><span class=\"line\">drwxr-xr-x  12 bjhl  wheel   384B  7 13 18:23 hooks # 包含客户端或者服务器端的钩子脚本</span><br><span class=\"line\">drwxr-xr-x   3 bjhl  wheel    96B  7 13 18:23 info # 包含一个全局性排除文件，用以防止那些不希望被纳入版本管理的文件，.gitignore文件中记录的</span><br><span class=\"line\">-rw-r--r--   1 bjhl  wheel   126B  7 13 20:39 index ## 保存暂存区信息(进行stash操作之后出现的)</span><br><span class=\"line\">drwxr-xr-x   4 bjhl  wheel   128B  7 13 18:23 objects ## 存储所有数据的内容</span><br><span class=\"line\">drwxr-xr-x   4 bjhl  wheel   128B  7 13 18:23 refs ## 存储指向数据（分支，远程仓库和标签等）的提交对象的指针。</span><br></pre></td></tr></table></figure>\n<p>其中有四个条目非常重要，我用  <code>##</code>  进行了标注。 分别是： <code>HEAD</code>  文件， <code>index</code>  文件， <code>objects</code>  目录， <code>refs</code>  目录。</p>\n<p><b>如果你想只是想了解 git 的话，那么下面的内容就可以忽略了。</b></p>\n<p>我们来搞一点有趣的东西。</p>\n<h3 id=\"objects目录下存放的是什么东西-git对象\"><a class=\"markdownIt-Anchor\" href=\"#objects目录下存放的是什么东西-git对象\">#</a>  <code>objects/</code>  目录下存放的是什么东西？–  Git 对象</h3>\n<p>前面说过， <code>git</code>  是一个内容寻址文件系统。==&gt;  <code>git</code>  是一个简单的键值对数据库。</p>\n<p>即，你可以向 <code>git</code>  仓库中插入任务类型的内容，它会返回一个唯一的键。通过该键可以在任意时刻再次取回该内容。</p>\n<p>上面说过， <code>objects</code>  目录下存放的是所有数据的内容。在 <code>git</code>  中，数据是什么呢？是我们工作目录的所有文件的快照！</p>\n<p>这里我们使用两个还没有学习的命令。</p>\n<ul>\n<li><code>git add .</code> ： 将目录中的文件纳入版本库进行管理起来。此时的状态是： <code>已暂存(新建)</code> 。暂存区的目录树会被更新，同时工作区修改 (新增的) 文件内容被写入到对象库中的一个新文件中，而该对象的 id 会被记录在暂存区的文件索引中。</li>\n<li><code>git commit -m 'xxx'</code> ：将目录中的文件提交到本地版本库。此时的状态是： <code>已提交</code> 。这时，暂存区的目录树写到版本库中，对应的分支会进行相应的更新。</li>\n</ul>\n<p>那下面演示一下： <code>objects</code>  目录下存储的文件。</p>\n<p>首先，我们查看下 <code>object</code>  目录下的所有文件</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> 查看objects下的文件</span></span><br><span class=\"line\">~ l .git/objects </span><br><span class=\"line\">total 0</span><br><span class=\"line\">drwxr-xr-x   4 bjhl  wheel   128B  7 14 11:30 .</span><br><span class=\"line\">drwxr-xr-x  10 bjhl  wheel   320B  7 14 11:30 ..</span><br><span class=\"line\">drwxr-xr-x   2 bjhl  wheel    64B  7 14 11:30 info</span><br><span class=\"line\">drwxr-xr-x   2 bjhl  wheel    64B  7 14 11:30 pack</span><br><span class=\"line\"><span class=\"meta\"></span></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> 创建一个文件： test-objects-files-01.txt</span></span><br><span class=\"line\">➜  gitlearn git:(master) sudo touch test-objects-files-01.txt</span><br><span class=\"line\">➜  gitlearn git:(master) ✗ l .git/objects</span><br><span class=\"line\">total 0</span><br><span class=\"line\">drwxr-xr-x   4 root  wheel   128B  7 14 15:10 .</span><br><span class=\"line\">drwxr-xr-x  10 root  wheel   320B  7 14 15:10 ..</span><br><span class=\"line\">drwxr-xr-x   2 root  wheel    64B  7 14 15:10 info</span><br><span class=\"line\">drwxr-xr-x   2 root  wheel    64B  7 14 15:10 pack</span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> 修改文件</span></span><br><span class=\"line\">➜  gitlearn git:(master) ✗ sudo vim test-objects-files-01.txt</span><br><span class=\"line\">➜  gitlearn git:(master) ✗ l .git/objects</span><br><span class=\"line\">total 0</span><br><span class=\"line\">drwxr-xr-x   4 root  wheel   128B  7 14 15:10 .</span><br><span class=\"line\">drwxr-xr-x  10 root  wheel   320B  7 14 15:10 ..</span><br><span class=\"line\">drwxr-xr-x   2 root  wheel    64B  7 14 15:10 info</span><br><span class=\"line\">drwxr-xr-x   2 root  wheel    64B  7 14 15:10 pack</span><br><span class=\"line\">➜  gitlearn git:(master) ✗ git add .</span><br><span class=\"line\">➜  gitlearn git:(master) ✗ l .git/objects</span><br><span class=\"line\">total 0</span><br><span class=\"line\">drwxrwxrwx   5 root  wheel   160B  7 14 15:34 .</span><br><span class=\"line\">drwxrwxrwx  11 root  wheel   352B  7 14 15:34 ..</span><br><span class=\"line\">drwxr-xr-x   3 bjhl  wheel    96B  7 14 15:34 37</span><br><span class=\"line\">drwxrwxrwx   2 root  wheel    64B  7 14 15:10 info</span><br><span class=\"line\">drwxrwxrwx   2 root  wheel    64B  7 14 15:10 pack</span><br><span class=\"line\">➜  gitlearn git:(master) ✗ sh /opt/util/dirfile.sh ./.git/objects</span><br><span class=\"line\">./.git/objects/37/17929ecb3efabae427dbe3725654b3de1a114b # blob类型(文件)</span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> 使用git cat-file来看下一下文件的内容</span></span><br><span class=\"line\">➜  gitlearn git:(master) ✗ git cat-file -p 3717929ecb3efabae427dbe3725654b3de1a114b</span><br><span class=\"line\">test - objects - files - 第一行</span><br><span class=\"line\"><span class=\"meta\"></span></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> 我们进行commit</span></span><br><span class=\"line\">➜  gitlearn git:(master) ✗ git commit -m &quot;test-object-files add&quot;</span><br><span class=\"line\">[master (root-commit) 1883fd5] test-object-files add</span><br><span class=\"line\"> Committer: bjhl &lt;bjhl@bjhldeMacBook-Pro.local&gt;</span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> ..省略部分提示</span></span><br><span class=\"line\"> 1 file changed, 1 insertion(+)</span><br><span class=\"line\"> create mode 100755 test-objects-files-01.txt</span><br><span class=\"line\"><span class=\"meta\"></span></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> 来看一下objects目录下的文件。</span></span><br><span class=\"line\"></span><br><span class=\"line\">➜  gitlearn git:(master) sh /opt/util/dirfile.sh ./.git/objects</span><br><span class=\"line\">./.git/objects/18/83fd5aefeb430cb25150e531e92e38f0176f0d</span><br><span class=\"line\">./.git/objects/37/17929ecb3efabae427dbe3725654b3de1a114b</span><br><span class=\"line\">./.git/objects/54/500d5d74f828d1a3193fb685084b87aaf419c7</span><br><span class=\"line\"></span><br><span class=\"line\">➜  gitlearn git:(master) git cat-file -p 54500d5d74f828d1a3193fb685084b87aaf419c7</span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> 表示存储的事blob格式的文件，test-objects-files-01.txt</span></span><br><span class=\"line\">100755 blob 3717929ecb3efabae427dbe3725654b3de1a114b\ttest-objects-files-01.txt</span><br><span class=\"line\"></span><br><span class=\"line\">➜  gitlearn git:(master) git cat-file -p 1883fd5aefeb430cb25150e531e92e38f0176f0d</span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> 存储的是 树对象(后面有介绍)</span></span><br><span class=\"line\">tree 54500d5d74f828d1a3193fb685084b87aaf419c7</span><br><span class=\"line\">author bjhl &lt;bjhl@bjhldeMacBook-Pro.local&gt; 1594712728 +0800</span><br><span class=\"line\">committer bjhl &lt;bjhl@bjhldeMacBook-Pro.local&gt; 1594712728 +0800</span><br><span class=\"line\"></span><br><span class=\"line\">test-object-files add</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>git cat-file<br>\n 这个命令可以实现从 <code>git</code>  仓库中取回数据。-p 参数可以自动判断内容的类型。还有一个写入的命令。 <code>git hash-object</code>  . 下面简单演示一下。</p>\n</blockquote>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">➜  gitlearn git:(master) echo &#x27;test hash-object function&#x27; | git hash-object -w --stdin</span><br><span class=\"line\">11a5f11388c345846bbaa060a98d8e93a1114e99</span><br><span class=\"line\">➜  gitlearn git:(master) git cat-file -p 11a5f11388c345846bbaa060a98d8e93a1114e99</span><br><span class=\"line\">test hash-object function</span><br><span class=\"line\">➜  gitlearn git:(master) sh /opt/util/dirfile.sh ./.git/objects</span><br><span class=\"line\">./.git/objects/11/a5f11388c345846bbaa060a98d8e93a1114e99</span><br><span class=\"line\">./.git/objects/18/83fd5aefeb430cb25150e531e92e38f0176f0d # commit-id </span><br><span class=\"line\">./.git/objects/37/17929ecb3efabae427dbe3725654b3de1a114b # 文件</span><br><span class=\"line\">./.git/objects/54/500d5d74f828d1a3193fb685084b87aaf419c7 # 树对象</span><br></pre></td></tr></table></figure>\n<p>从上面的例子我们可以看到， <code>git</code>  中含有， <code>blob</code>   <code>commit-id</code> ， <code>tree</code> ，这三种对象。<br>\n这其实就是  <code>Git</code>  的对象：数据对象，提交对象，树对象。</p>\n<p>接下来我们来看一个 <code>git</code>  的对象 - 树对象</p>\n<h3 id=\"树对象\"><a class=\"markdownIt-Anchor\" href=\"#树对象\">#</a> 树对象</h3>\n<p>树对象能够解决文件名保存的问题，也允许多个文件组织到一起。所有内容均以树对象和数据独享的形式存储，其中树对象对应了 UNIX 中的目录项，数据对象则大致上对应了 <code>inodes</code>  或者文件内容。</p>\n<p>一个树对象包含了一条或多条树对象记录，每条记录含有一个指向数据对象或者子树对象的 <code>SHA-1</code>  指针，以及相应的模式，类型，文件名信息。</p>\n<p>我们再来看一下，刚才的三个 <code>objects</code>  下的校验和。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">➜  gitlearn git:(master) git cat-file -p 1883fd5aefeb430cb25150e531e92e38f0176f0d</span><br><span class=\"line\">tree 54500d5d74f828d1a3193fb685084b87aaf419c7</span><br><span class=\"line\">test-object-files add</span><br><span class=\"line\"></span><br><span class=\"line\">➜  gitlearn git:(master) git cat-file -p 54500d5d74f828d1a3193fb685084b87aaf419c7</span><br><span class=\"line\">100755 blob 3717929ecb3efabae427dbe3725654b3de1a114b\ttest-objects-files-01.txt</span><br><span class=\"line\"></span><br><span class=\"line\">➜  gitlearn git:(master) git cat-file -p 3717929ecb3efabae427dbe3725654b3de1a114b</span><br><span class=\"line\">test - objects - files - 第一行</span><br></pre></td></tr></table></figure>\n<p>我根据 数对象  <code>1883fd</code>  找到了  <code>54500d</code>  (表示对应的 txt 文件)，然后可以根据 txt 文件，看到这次提交的内容 <code>371792</code> . 如下图。</p>\n<p><img data-src=\"/images/git%E7%B3%BB%E5%88%97/images/git%E5%B7%A5%E4%BD%9C%E7%9B%AE%E5%BD%9501.png\" alt=\"git工作目录01.png\"></p>\n<p>这时，我们在尝试从修改一下这个文件，进行提交。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">➜  gitlearn git:(master) sudo vim test-objects-files-01.txt</span><br><span class=\"line\">Password:</span><br><span class=\"line\">➜  gitlearn git:(master) ✗ git add .</span><br><span class=\"line\">➜  gitlearn git:(master) ✗ sh /opt/util/dirfile.sh ./.git/objects</span><br><span class=\"line\">./.git/objects/18/83fd5aefeb430cb25150e531e92e38f0176f0d</span><br><span class=\"line\">./.git/objects/37/17929ecb3efabae427dbe3725654b3de1a114b # 文件</span><br><span class=\"line\">./.git/objects/54/500d5d74f828d1a3193fb685084b87aaf419c7 # 树对象</span><br><span class=\"line\">./.git/objects/11/a5f11388c345846bbaa060a98d8e93a1114e99 # test hash-object function (本次实验可以忽略)</span><br><span class=\"line\">## 下面两行是新增的，本次操作生成的。</span><br><span class=\"line\">./.git/objects/5b/22ea83f2e8555371b818a7e441d4156795af04 #内容: test - objects - files - 第一行 \\n test - objects - files - 第二行</span><br><span class=\"line\"></span><br><span class=\"line\">## 提交到版本库中。</span><br><span class=\"line\">➜  gitlearn git:(master) ✗ git commit -m &quot;test-object-files updated&quot;</span><br><span class=\"line\">[master 200e059] test-object-files updated</span><br><span class=\"line\"> 1 file changed, 1 insertion(+)</span><br><span class=\"line\">➜  gitlearn git:(master) sh /opt/util/dirfile.sh ./.git/objects</span><br><span class=\"line\">./.git/objects/18/83fd5aefeb430cb25150e531e92e38f0176f0d # commit - id</span><br><span class=\"line\">./.git/objects/37/17929ecb3efabae427dbe3725654b3de1a114b # 文件</span><br><span class=\"line\">./.git/objects/54/500d5d74f828d1a3193fb685084b87aaf419c7 # 树对象</span><br><span class=\"line\">./.git/objects/11/a5f11388c345846bbaa060a98d8e93a1114e99 # test hash-object function(本次实现忽略) </span><br><span class=\"line\">./.git/objects/5b/22ea83f2e8555371b818a7e441d4156795af04 # 文件</span><br><span class=\"line\"># 下面两行是新增的，本次操作生成的</span><br><span class=\"line\">./.git/objects/20/0e059f0c0b178378aecd6736f384a74d28df94 # commit-id</span><br><span class=\"line\">./.git/objects/20/db6c4af7677b7509d2b323b503733405e4987e # 树对象</span><br></pre></td></tr></table></figure>\n<p>我们的操作如下：</p>\n<ol>\n<li>在 git 仓库中创建了一个文件，并且将它纳入版本管理，提交到了版本库中</li>\n<li>修改了这个问题，并且再次提交到了版本库中。</li>\n</ol>\n<p>经过这个两个步骤之后，出现了如下图的  <code>git</code>  树对象。</p>\n<p><img data-src=\"/images/git%E7%B3%BB%E5%88%97/images/git%E5%B7%A5%E4%BD%9C%E7%9B%AE%E5%BD%95%E4%BB%8B%E7%BB%8D02.png\" alt=\"git工作目录介绍02.png\"></p>\n<p>这时，我们使用  <code>git log</code>  命令来查看日志。可以发现。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">commit 200e059f0c0b178378aecd6736f384a74d28df94 (HEAD -&gt; master)</span><br><span class=\"line\">Author: bjhl &lt;bjhl@bjhldeMacBook-Pro.local&gt;</span><br><span class=\"line\">Date:   Tue Jul 14 16:24:02 2020 +0800</span><br><span class=\"line\"></span><br><span class=\"line\">    test-object-files updated</span><br><span class=\"line\"></span><br><span class=\"line\">commit 1883fd5aefeb430cb25150e531e92e38f0176f0d</span><br><span class=\"line\">Author: bjhl &lt;bjhl@bjhldeMacBook-Pro.local&gt;</span><br><span class=\"line\">Date:   Tue Jul 14 15:45:28 2020 +0800</span><br><span class=\"line\"></span><br><span class=\"line\">    test-object-files add</span><br></pre></td></tr></table></figure>\n<p>为了便于大家理解，咱们继续修改这个文件，加上第三行数据:  <code>test - objects - files - 第三行</code> ：</p>\n<p>然后执行</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">git add .</span><br><span class=\"line\">git commit -m &quot;test-object-files updated 02&quot;</span><br></pre></td></tr></table></figure>\n<p>然后查看 <code>objects</code>  目录下的文件内容:</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">➜  gitlearn git:(master) sh /opt/util/dirfile.sh ./.git/objects</span><br><span class=\"line\">./.git/objects/11/a5f11388c345846bbaa060a98d8e93a1114e99</span><br><span class=\"line\">./.git/objects/18/83fd5aefeb430cb25150e531e92e38f0176f0d</span><br><span class=\"line\">./.git/objects/20/0e059f0c0b178378aecd6736f384a74d28df94</span><br><span class=\"line\">./.git/objects/20/db6c4af7677b7509d2b323b503733405e4987e</span><br><span class=\"line\">./.git/objects/37/17929ecb3efabae427dbe3725654b3de1a114b</span><br><span class=\"line\">./.git/objects/54/500d5d74f828d1a3193fb685084b87aaf419c7</span><br><span class=\"line\">./.git/objects/5b/22ea83f2e8555371b818a7e441d4156795af04</span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> 以下三行是本次commit产生的。</span></span><br><span class=\"line\">./.git/objects/a6/2a79d99b37bc5c44ca083cd40f9e4c00aae0bd # commit-id，提交对象</span><br><span class=\"line\">./.git/objects/ba/f6b0843a522f8e77f326d2615cb37ed290d06e # 文件，数据对象</span><br><span class=\"line\">./.git/objects/c4/3622f1e8e728f88eb11adfee1ea08d41c792a0 # 树对象</span><br><span class=\"line\"></span><br><span class=\"line\">➜  gitlearn git:(master) git cat-file -p a62a79d99b37bc5c44ca083cd40f9e4c00aae0bd</span><br><span class=\"line\">tree c43622f1e8e728f88eb11adfee1ea08d41c792a0</span><br><span class=\"line\">parent 200e059f0c0b178378aecd6736f384a74d28df94</span><br><span class=\"line\">test-object-files updated 02</span><br><span class=\"line\"></span><br><span class=\"line\">➜  gitlearn git:(master) git cat-file -p c43622f1e8e728f88eb11adfee1ea08d41c792a0</span><br><span class=\"line\">100755 blob baf6b0843a522f8e77f326d2615cb37ed290d06e\ttest-objects-files-01.txt</span><br><span class=\"line\">➜  gitlearn git:(master) git cat-file -p baf6b0843a522f8e77f326d2615cb37ed290d06e</span><br><span class=\"line\">test - objects - files - 第一行</span><br><span class=\"line\">test - objects - files - 第二行</span><br><span class=\"line\">test - objects - files - 第三行</span><br></pre></td></tr></table></figure>\n<p>做完上面的操作之后，我们来看一下 <code>objects</code>  目录下的树结构图。</p>\n<p><img data-src=\"/images/git%E7%B3%BB%E5%88%97/images/git%E5%B7%A5%E4%BD%9C%E7%9B%AE%E5%BD%95%E4%BB%8B%E7%BB%8D03.png\" alt=\"git工作目录介绍03.png\"></p>\n<h4 id=\"objects目录总结\"><a class=\"markdownIt-Anchor\" href=\"#objects目录总结\">#</a> objects 目录总结</h4>\n<ul>\n<li>作用： 存放所有数据的内容。</li>\n<li><code>git</code>  是一个内容存执文件管理系统。也就是一个 <code>KV</code>  数据库，对应的 <code>key-value</code>  放到了 <code>objects</code>  目录下，存储形式是一个 <code>40</code>  位十六机制的校验和。 <code>key</code>  是文件名， <code>value</code>  是文件内容。</li>\n<li>学习了两个底层命令：  <code>git cat-file</code>  和  <code>git hash-object</code> . 更多底层命令可以看下这篇文章。// TODO</li>\n<li><b>演示一个文件的三次更新时变化过程，以及各个版本之间的迭代过程，那么如果是多个文件呢？这里大家可以去试一下，就会更清晰的理解树对象了。（这里演示一个文件并不能完全的解释清树对象这个概念）</b></li>\n</ul>\n<h2 id=\"git引用-git工作目录下的refs目录\"><a class=\"markdownIt-Anchor\" href=\"#git引用-git工作目录下的refs目录\">#</a> Git 引用， git 工作目录下的 refs 目录！</h2>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">➜  gitlearn git:(master) l ./.git/refs/</span><br><span class=\"line\">drwxrwxrwx   3 root  wheel    96B  7 14 17:02 heads</span><br><span class=\"line\">drwxrwxrwx   2 root  wheel    64B  7 14 15:10 tags</span><br></pre></td></tr></table></figure>\n<ul>\n<li>heads 目录，存储各个分支的 HEAD 指针指向的版本。</li>\n<li>tags 目录，git tag 命令产生的结果。</li>\n</ul>\n<h4 id=\"heads目录\"><a class=\"markdownIt-Anchor\" href=\"#heads目录\">#</a> heads 目录</h4>\n<p>我们还是根据 objects 部门的操作来演示这部分的内容。<br>\n如下图。</p>\n<p><img data-src=\"/images/git%E7%B3%BB%E5%88%97/images/git%E5%B7%A5%E4%BD%9C%E7%9B%AE%E5%BD%95%E4%BB%8B%E7%BB%8D04-object%E7%9B%AE%E5%BD%95%E6%80%BB%E7%BB%93.png\" alt=\"git工作目录介绍04-object目录总结.png\"></p>\n<p>通过查看我们目前是在  <code>a62a79d99b37bc5c44ca083cd40f9e4c00aae0bd</code>  这个版本上。</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">➜  gitlearn git:(master) cat ./.git/refs/heads/master</span><br><span class=\"line\">a62a79d99b37bc5c44ca083cd40f9e4c00aae0bd</span><br></pre></td></tr></table></figure>\n<p>我们可以通过  <code>git update-ref</code>  命令来实现切换版本 (回退到制定的版本上)</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 我们先使用 git log 命令来查看一下提交记录</span></span><br><span class=\"line\"></span><br><span class=\"line\">commit a62a79d99b37bc5c44ca083cd40f9e4c00aae0bd (HEAD -&gt; master)</span><br><span class=\"line\">Author: bjhl &lt;bjhl@bjhldeMacBook-Pro.local&gt;</span><br><span class=\"line\">Date:   Tue Jul 14 17:02:46 2020 +0800</span><br><span class=\"line\"></span><br><span class=\"line\">    test-object-files updated 02</span><br><span class=\"line\"></span><br><span class=\"line\">commit 200e059f0c0b178378aecd6736f384a74d28df94</span><br><span class=\"line\">Author: bjhl &lt;bjhl@bjhldeMacBook-Pro.local&gt;</span><br><span class=\"line\">Date:   Tue Jul 14 16:24:02 2020 +0800</span><br><span class=\"line\"></span><br><span class=\"line\">    test-object-files updated</span><br><span class=\"line\"></span><br><span class=\"line\">commit 1883fd5aefeb430cb25150e531e92e38f0176f0d</span><br><span class=\"line\">Author: bjhl &lt;bjhl@bjhldeMacBook-Pro.local&gt;</span><br><span class=\"line\">Date:   Tue Jul 14 15:45:28 2020 +0800</span><br><span class=\"line\"></span><br><span class=\"line\">    test-object-files add</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 我们要回退到第二个版本上。使用 git update-ref,更新引用。</span></span><br><span class=\"line\">➜ .git git:(master) git update-ref refs/heads/master 200e059f0c0b178378aecd6736f384a74d28df94</span><br><span class=\"line\"><span class=\"comment\"># 再去查看git的Head目录下的版本号</span></span><br><span class=\"line\">➜  gitlearn git:(master) ✗ cat ./.git/refs/heads/master</span><br><span class=\"line\">200e059f0c0b178378aecd6736f384a74d28df94</span><br><span class=\"line\"><span class=\"comment\"># 这个时候再使用 git log 去看日志：</span></span><br><span class=\"line\">commit 200e059f0c0b178378aecd6736f384a74d28df94 (HEAD -&gt; master)</span><br><span class=\"line\">Author: bjhl &lt;bjhl@bjhldeMacBook-Pro.local&gt;</span><br><span class=\"line\">Date:   Tue Jul 14 16:24:02 2020 +0800</span><br><span class=\"line\"></span><br><span class=\"line\">    test-object-files updated</span><br><span class=\"line\"></span><br><span class=\"line\">commit 1883fd5aefeb430cb25150e531e92e38f0176f0d</span><br><span class=\"line\">Author: bjhl &lt;bjhl@bjhldeMacBook-Pro.local&gt;</span><br><span class=\"line\">Date:   Tue Jul 14 15:45:28 2020 +0800</span><br><span class=\"line\"></span><br><span class=\"line\">    test-object-files add</span><br><span class=\"line\"><span class=\"comment\"># 再去看我们的文件: 是不会更新工作区内容的。</span></span><br><span class=\"line\">➜  gitlearn git:(master) ✗ cat test-objects-files-01.txt</span><br><span class=\"line\"><span class=\"built_in\">test</span> - objects - files - 第一行</span><br><span class=\"line\"><span class=\"built_in\">test</span> - objects - files - 第二行</span><br><span class=\"line\"><span class=\"built_in\">test</span> - objects - files - 第三行</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 我们还可以使用 git update-ref 来创建新的分支。</span></span><br><span class=\"line\">➜  gitlearn git:(master) ✗ <span class=\"built_in\">cd</span> .git</span><br><span class=\"line\">➜  .git git:(master) git update-ref refs/heads/<span class=\"built_in\">test</span> 200e059f0c0b178378aecd6736f384a74d28df94</span><br><span class=\"line\"><span class=\"comment\"># 查看test分支的日志</span></span><br><span class=\"line\">➜  .git git:(master) git <span class=\"built_in\">log</span> --pretty=oneline <span class=\"built_in\">test</span></span><br><span class=\"line\">200e059f0c0b178378aecd6736f384a74d28df94 (HEAD -&gt; master, <span class=\"built_in\">test</span>) test-object-files updated</span><br><span class=\"line\">1883fd5aefeb430cb25150e531e92e38f0176f0d test-object-files add</span><br><span class=\"line\"><span class=\"comment\"># 这时我们去查看我们所处的分支, 发现我们仍然处在master上，并没有进行切换。</span></span><br><span class=\"line\">➜  .git git:(master) git branch</span><br><span class=\"line\">* master</span><br><span class=\"line\">  <span class=\"built_in\">test</span></span><br></pre></td></tr></table></figure>\n<p>上面的演示中，我们发现了，虽然只是修改的记录的文件，但是并没有对我们工作区的文件进行更新。怎么解决呢？</p>\n<h3 id=\"head文件\"><a class=\"markdownIt-Anchor\" href=\"#head文件\">#</a> HEAD 文件</h3>\n<p><code>HEAD</code>  文件通常是一个符号引用，指向目前所在的分支。所谓符号引用，表示它是一个指向其他引用的指针。</p>\n<p>我们查看一下  <code>HEAD</code>  文件中的内容</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">➜  gitlearn git:(master) ✗ cat .git/HEAD</span><br><span class=\"line\">ref: refs/heads/master</span><br></pre></td></tr></table></figure>\n<p>这里呢，有一个命令可以帮助我们实现修改  <code>HEAD</code>  文件的内容</p>\n<p><b>git symbolic-ref</b></p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> 查看当前所在的分支</span></span><br><span class=\"line\">➜  gitlearn git:(master) ✗ git symbolic-ref HEAD</span><br><span class=\"line\">refs/heads/master</span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> 设置当前所在的分支</span></span><br><span class=\"line\">➜  .git git:(master) git symbolic-ref HEAD refs/heads/test</span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> 已经可以看到我们已经把分支切换到了<span class=\"built_in\">test</span></span></span><br><span class=\"line\">➜  .git git:(test)</span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> 我们去看 工作区里的文件，发现并没有变化！</span></span><br><span class=\"line\">➜  .git git:(test) cat ../test-objects-files-01.txt</span><br><span class=\"line\">test - objects - files - 第一行</span><br><span class=\"line\">test - objects - files - 第二行</span><br><span class=\"line\">test - objects - files - 第三行</span><br></pre></td></tr></table></figure>\n<p>文件的内容的，修改就必须使用  <code>git checkout</code>  /  <code>git reset</code>  了。</p>\n<p>我们回来接着看 refs 目录的另一个目录：tags.</p>\n<p>tags 是 git tag 命令的产物。</p>\n<p>然后，在 git 中，tags 其实是标签对象，包含了一个标签创建者信息，一个日期，一段注释信息，以及一个指针。标签对象通常指向一个提交对象，而不是一个树对象。永远都会指向同一个提交对象。</p>\n<p>标签分为 附注标签 和 轻量标签。</p>\n<p>使用命令</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># 常见一个轻量标签 -&gt; 一个固定的引用</span><br><span class=\"line\">➜  .git git:(test) git update-ref refs/tags/v1.0 1883fd5aefeb430cb25150e531e92e38f0176f0d</span><br></pre></td></tr></table></figure>\n<p>创建一个附注标签的时候，git 会创建一个标签对象，并记录一个引用来指向该标签对象，而不是直接指向要提交的对象。</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">➜  .git git:(test) git tag -a v1.1 1883fd5aefeb430cb25150e531e92e38f0176f0d -m &#x27;附注标签&#x27;</span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> 查看标签对象。</span></span><br><span class=\"line\">➜  .git git:(test) cat refs/tags/v1.1</span><br><span class=\"line\">3f224b87d02aa196b0b8331aa28389a172e3f723</span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> 查看附注标签详细的内容</span></span><br><span class=\"line\">➜  .git git:(test) git cat-file -p 3f224b87d02aa196b0b8331aa28389a172e3f723</span><br><span class=\"line\">object 1883fd5aefeb430cb25150e531e92e38f0176f0d</span><br><span class=\"line\">type commit</span><br><span class=\"line\">tag v1.1</span><br><span class=\"line\">tagger bjhl &lt;bjhl@bjhldeMacBook-Pro.local&gt; 1594727545 +0800</span><br><span class=\"line\"></span><br><span class=\"line\">附注标签</span><br></pre></td></tr></table></figure>\n<h4 id=\"远程引用\"><a class=\"markdownIt-Anchor\" href=\"#远程引用\">#</a> 远程引用</h4>\n<p>在 git 的引用中，还有一个远程引用。</p>\n<p>这个目录会在我们配置远程仓库的时候出现，我们一起配置一下远程仓库</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> 配置远程仓库</span></span><br><span class=\"line\">➜  gitlearn git:(master) git remote add origin https://gitee.com/fangjiaxiaobai/gitlearn.git</span><br><span class=\"line\"><span class=\"meta\"></span></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> push 到远程分支。</span></span><br><span class=\"line\">➜  gitlearn git:(master) git push origin master</span><br><span class=\"line\">Counting objects: 6, done.</span><br><span class=\"line\">Delta compression using up to 8 threads.</span><br><span class=\"line\">Compressing objects: 100% (5/5), done.</span><br><span class=\"line\">Writing objects: 100% (6/6), 548 bytes | 548.00 KiB/s, done.</span><br><span class=\"line\">Total 6 (delta 0), reused 0 (delta 0)</span><br><span class=\"line\">remote: Powered by GITEE.COM [GNK-5.0]</span><br><span class=\"line\">To https://gitee.com/fangjiaxiaobai/gitlearn.git</span><br><span class=\"line\"> * [new branch]      master -&gt; master</span><br><span class=\"line\"><span class=\"meta\"></span></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> 查看 .git目录下，出现了remotes</span></span><br><span class=\"line\"> ➜  gitlearn git:(master) l ./.git/refs/</span><br><span class=\"line\">total 8</span><br><span class=\"line\">drwxrwxrwx   6 root  wheel   192B  7 14 19:58 .</span><br><span class=\"line\">drwxrwxrwx  16 root  wheel   512B  7 14 19:58 ..</span><br><span class=\"line\">drwxrwxrwx   4 root  wheel   128B  7 14 19:56 heads</span><br><span class=\"line\">drwxr-xr-x   3 bjhl  wheel    96B  7 14 19:58 remotes</span><br><span class=\"line\">-rw-r--r--   1 bjhl  wheel    41B  7 14 19:56 stash # 进行git stash命令后出现</span><br><span class=\"line\">drwxrwxrwx   4 root  wheel   128B  7 14 19:52 tags</span><br><span class=\"line\"><span class=\"meta\"></span></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> 查看对应remote配置文件</span></span><br><span class=\"line\">➜  gitlearn git:(master) cat .git/refs/remotes/origin/master</span><br><span class=\"line\">200e059f0c0b178378aecd6736f384a74d28df94</span><br></pre></td></tr></table></figure>\n<p>这个校验码表示 ，远程版本库中和本地的版本库中最新一次交互的 commit id 。</p>\n<p>远程引用和分支之间最主要的区别，就是远程引用是只读的。Git 永远不会讲 HEAD 引用指向该远程引用，因此，不可能通过 commit 来更新远程引用。</p>\n<h3 id=\"index文件\"><a class=\"markdownIt-Anchor\" href=\"#index文件\">#</a> Index 文件</h3>\n<p>这个文件是  <code>git stage</code>  的文件信息存放地，根据该文件中的内容，可以查看当前哪些文件，或者哪些文件发生了变化，而在 <code>commit</code>  之后，则会把相应的信息存入  <code>.git/objects</code>  文件夹下。通过  <code>git ls-files -s</code>  可以查 看  <code>index</code>  文件中的  <code>stage</code>  文件的信息。</p>\n<p><code>Index</code>  文件是用二进制存储的，包含有  <code>ctime</code>  和  <code>mtime</code>  时间信息，文件存储的设备信息，磁盘的 <code>inode</code>  信息，文件的  <code>mode</code>  信息， <code>UID</code> ， <code>GID</code> ，文件大小，文件的 <code>SHA-1</code>  码， <code>flag</code> ，文件的 <code>file path</code>  等信息。</p>\n<p>各个文件的信息按照一定的排列顺序进行排布。提交的时候，按照这种约定进行解析。</p>\n<h2 id=\"包文件\"><a class=\"markdownIt-Anchor\" href=\"#包文件\">#</a> 包文件</h2>\n<p>在文章一开始，我们就说过，git 是基于快照的方式来进行版本控制的。这就意味着，我们每进行一次 commit 操作，git 就是存储一份我们所有的文件。那么，一个大项目，那岂不是会占用很大的存储空间？？</p>\n<p>我们先做个实验。看看 git 会不会占用很大的存储空间？</p>\n<p><b>首先，我们新建一个仓库</b></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># 创建仓库</span><br><span class=\"line\">➜  gitlearn git init .</span><br><span class=\"line\">Initialized empty Git repository in /private/tmp/gitlearn/.git/</span><br><span class=\"line\"># 添加文件</span><br><span class=\"line\">➜  gitlearn git:(master) touch test-package-file</span><br><span class=\"line\">➜  gitlearn git:(master) ✗ vim test-package-file</span><br><span class=\"line\">➜  gitlearn git:(master) ✗ git add .</span><br><span class=\"line\">➜  gitlearn git:(master) ✗ git commit -m &quot;test package file 1&quot;</span><br><span class=\"line\">[master (root-commit) 12cbb50] test package file 1</span><br><span class=\"line\"> Committer: bjhl &lt;bjhl@bjhldeMacBook-Pro.local&gt;</span><br><span class=\"line\"> 1 file changed, 1 insertion(+)</span><br><span class=\"line\"> create mode 100644 test-package-file</span><br><span class=\"line\"># 查看数据对象的id</span><br><span class=\"line\">➜  gitlearn git:(master)  git cat-file -p master^&#123;tree&#125;</span><br><span class=\"line\">100644 blob c2e8644a8379ab0cf4f2bc5a14160d94608502f7\ttest-package-file</span><br><span class=\"line\"># 修改 test ,添加 test package file * 700</span><br><span class=\"line\">➜  gitlearn git:(master) vim test-package-file</span><br><span class=\"line\">➜  gitlearn git:(master) ✗ vim test-package-file</span><br><span class=\"line\">➜  gitlearn git:(master) ✗ git add .</span><br><span class=\"line\">➜  gitlearn git:(master) ✗ git commit -m &quot;test package file 2&quot;</span><br><span class=\"line\">[master 421177c] test package file 2</span><br><span class=\"line\"> Committer: bjhl &lt;bjhl@bjhldeMacBook-Pro.local&gt;</span><br><span class=\"line\"> 1 file changed, 740 insertions(+)</span><br><span class=\"line\"># 查看第二次提交的数据对象的id</span><br><span class=\"line\">➜  gitlearn git:(master) git cat-file -p master^&#123;tree&#125;</span><br><span class=\"line\">100644 blob 363980e2f742592594e01648888a661d2d0479b9\ttest-package-file</span><br><span class=\"line\">### 查看两次数据对象的大小</span><br><span class=\"line\">➜  gitlearn git:(master) git cat-file -s c2e8644a8379ab0cf4f2bc5a14160d94608502f7</span><br><span class=\"line\">18</span><br><span class=\"line\">➜  gitlearn git:(master) git cat-file -s 363980e2f742592594e01648888a661d2d0479b9</span><br><span class=\"line\">13338</span><br><span class=\"line\"></span><br><span class=\"line\">## 查看一下这两次文件存储的文件。</span><br><span class=\"line\">➜  gitlearn git:(master) sh /opt/util/dirfile.sh ./.git/objects</span><br><span class=\"line\">./.git/objects/12/cbb50359469eb29efe29945a3b18e262f6e862</span><br><span class=\"line\">./.git/objects/36/3980e2f742592594e01648888a661d2d0479b9</span><br><span class=\"line\">./.git/objects/42/1177c9026e757e7e123b6ee589bcffa067eb96</span><br><span class=\"line\">./.git/objects/8e/0703665933215a57787a3117b079d4c8cb1921</span><br><span class=\"line\">./.git/objects/c2/e8644a8379ab0cf4f2bc5a14160d94608502f7</span><br><span class=\"line\">./.git/objects/c3/1d0ebb18efdfc791a254ab58a01ff2ed0136e4</span><br></pre></td></tr></table></figure>\n<p>现在 <code>git</code>  中存储了两个文件，分别是我们第一次提交和第二次提交的内容。</p>\n<p>如果 <code>git</code>  像 <code>SVN</code>  一样记录变更的内容的话，是不是更好呢？</p>\n<p><code>git</code>  上本来可以那么做。  <code>git</code>  最初向磁盘中存储对象时所使用的格式称为 松散对象格式。 但是， <code>git</code>  会时不时的将多个对象打包成一个 称为 “包文件” 的二进制文件。来节省空间和效率。</p>\n<p>当仓库中有太多的 松散对象，或者手动执行  <code>git gc</code>  命令，或者向远程服务器执行推送时， <code>git</code>  都会这么做。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># 执行一下 git gc</span><br><span class=\"line\">➜  gitlearn git:(master) git gc</span><br><span class=\"line\">Counting objects: 6, done.</span><br><span class=\"line\">Delta compression using up to 8 threads.</span><br><span class=\"line\">Compressing objects: 100% (3/3), done.</span><br><span class=\"line\">Writing objects: 100% (6/6), done.</span><br><span class=\"line\">Total 6 (delta 0), reused 0 (delta 0)</span><br><span class=\"line\">➜  gitlearn git:(master) sh /opt/util/dirfile.sh ./.git/objects</span><br><span class=\"line\">./.git/objects/info/packs</span><br><span class=\"line\">./.git/objects/pack/pack-275c7b3d69b1acacc114c081d6ffa61d6683e8a1.idx</span><br><span class=\"line\">./.git/objects/pack/pack-275c7b3d69b1acacc114c081d6ffa61d6683e8a1.pack</span><br></pre></td></tr></table></figure>\n<p>这里生成了一个包文件 ( <code>.pack</code> ) 和一个索引文件 ( <code>.idx</code> )。包文件抱愧了刚才从一个文件系统中移除的所有对象的内容，索引文件包含了文件的偏移信息。我们可以通过偏移文件快速的定位任意一个指定对象。</p>\n<p><code>git</code>  打包对象时，会查找命名以及大小相近的文件，并只保存文件不同版本之间的差异内容。可以使用  <code>git verify-pack</code>  这个底层命令查看已经打包内容:</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">➜  gitlearn git:(master) git verify-pack -v .git/objects/pack/pack-275c7b3d69b1acacc114c081d6ffa61d6683e8a1.idx</span><br><span class=\"line\">421177c9026e757e7e123b6ee589bcffa067eb96 commit 238 160 12</span><br><span class=\"line\">12cbb50359469eb29efe29945a3b18e262f6e862 commit 190 131 172</span><br><span class=\"line\">363980e2f742592594e01648888a661d2d0479b9 blob   13338 80 303</span><br><span class=\"line\">c31d0ebb18efdfc791a254ab58a01ff2ed0136e4 tree   45 55 383</span><br><span class=\"line\">8e0703665933215a57787a3117b079d4c8cb1921 tree   45 56 438</span><br><span class=\"line\">c2e8644a8379ab0cf4f2bc5a14160d94608502f7 blob   18 28 494</span><br><span class=\"line\">non delta: 6 objects</span><br><span class=\"line\">.git/objects/pack/pack-275c7b3d69b1acacc114c081d6ffa61d6683e8a1.pack: ok</span><br></pre></td></tr></table></figure>\n<p>其中第三列是在包文件中各个对象的大小，可以看到，树对象是 <code>45</code>  字节，数据对象和提交对象，都是原来的大小。</p>\n<p>显然这次并没有进行压缩。 我们再次修改文件：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># 修改文件： 最后一行添加 test package file</span><br><span class=\"line\">➜  gitlearn git:(master) vim test-package-file</span><br><span class=\"line\">➜  gitlearn git:(master) ✗ git add .</span><br><span class=\"line\">➜  gitlearn git:(master) ✗ git commit -m &quot;test package file 3&quot;</span><br><span class=\"line\">[master 2ab3a27] test package file 3</span><br><span class=\"line\"> Committer: bjhl &lt;bjhl@bjhldeMacBook-Pro.local&gt;</span><br><span class=\"line\"> 1 file changed, 1 insertion(+)</span><br><span class=\"line\"> # 查看目录下的文件</span><br><span class=\"line\">➜  gitlearn git:(master) sh /opt/util/dirfile.sh ./.git/objects</span><br><span class=\"line\">./.git/objects/2a/b3a275bf16a86f77e632127ccf62bcecf98579</span><br><span class=\"line\">./.git/objects/84/003569b2725d79bc209821c9c3dbb5c2ef8a8d</span><br><span class=\"line\">./.git/objects/df/e088f704e98a835ed3ca2ce31919947d63f884</span><br><span class=\"line\">./.git/objects/info/packs</span><br><span class=\"line\">./.git/objects/pack/pack-275c7b3d69b1acacc114c081d6ffa61d6683e8a1.idx</span><br><span class=\"line\">./.git/objects/pack/pack-275c7b3d69b1acacc114c081d6ffa61d6683e8a1.pack</span><br><span class=\"line\"># 进行打包</span><br><span class=\"line\">➜  gitlearn git:(master) git gc</span><br><span class=\"line\">Counting objects: 9, done.</span><br><span class=\"line\">Delta compression using up to 8 threads.</span><br><span class=\"line\">Compressing objects: 100% (5/5), done.</span><br><span class=\"line\">Writing objects: 100% (9/9), done.</span><br><span class=\"line\">Total 9 (delta 1), reused 5 (delta 0)</span><br><span class=\"line\">➜  gitlearn git:(master) sh /opt/util/dirfile.sh ./.git/objects</span><br><span class=\"line\">./.git/objects/info/packs</span><br><span class=\"line\">./.git/objects/pack/pack-a30aa1dcd93c0fadc605cf3fb5828e8cf186ef29.idx</span><br><span class=\"line\">./.git/objects/pack/pack-a30aa1dcd93c0fadc605cf3fb5828e8cf186ef29.pack</span><br><span class=\"line\"># 查看打包的内容</span><br><span class=\"line\">➜  gitlearn git:(master) git verify-pack -v .git/objects/pack/pack-a30aa1dcd93c0fadc605cf3fb5828e8cf186ef29.idx</span><br><span class=\"line\">2ab3a275bf16a86f77e632127ccf62bcecf98579 commit 238 160 12</span><br><span class=\"line\">421177c9026e757e7e123b6ee589bcffa067eb96 commit 238 160 172</span><br><span class=\"line\">12cbb50359469eb29efe29945a3b18e262f6e862 commit 190 131 332</span><br><span class=\"line\">84003569b2725d79bc209821c9c3dbb5c2ef8a8d tree   45 56 555</span><br><span class=\"line\">c31d0ebb18efdfc791a254ab58a01ff2ed0136e4 tree   45 55 611</span><br><span class=\"line\">8e0703665933215a57787a3117b079d4c8cb1921 tree   45 56 684</span><br><span class=\"line\">dfe088f704e98a835ed3ca2ce31919947d63f884 blob   13356 92 463 # 第三次提交</span><br><span class=\"line\">363980e2f742592594e01648888a661d2d0479b9 blob   7 18 666 1 dfe088f704e98a835ed3ca2ce31919947d63f884 # 第二次提交</span><br><span class=\"line\">c2e8644a8379ab0cf4f2bc5a14160d94608502f7 blob   18 28 740 # 第一次提交</span><br><span class=\"line\">non delta: 8 objects</span><br><span class=\"line\">chain length = 1: 1 object</span><br><span class=\"line\">.git/objects/pack/pack-a30aa1dcd93c0fadc605cf3fb5828e8cf186ef29.pack: ok</span><br></pre></td></tr></table></figure>\n<p>我们可以到看到 第三次提交的内容是  <code>13356</code>  字节，而第二次提交的内容只有  <code>7</code>  个字节。显然， <code>git</code>  这次进行压缩。另外，第三个版本是保存了最新的文件内容，原始版本是以差异方式存在的 -- 这是因为大部分情况下，需要快速的访问文件的最新版本。</p>\n<h2 id=\"总结\"><a class=\"markdownIt-Anchor\" href=\"#总结\">#</a> 总结</h2>\n<ul>\n<li><code>git</code>  创建仓库两种方式：本地创建， <code>clone</code>  仓库</li>\n<li><code>git</code>  仓库的目录结构\n<ul>\n<li><code>objects</code>  目录<br>\n我们通过一个最简单的三次提交来看了一下 <code>git</code>  仓库是如何存储数据的。<br>\n这里，我贴上这张我们操作过程的图，加深一下印象.<br>\n<img data-src=\"/images/git%E7%B3%BB%E5%88%97/images/git%E5%B7%A5%E4%BD%9C%E7%9B%AE%E5%BD%95%E4%BB%8B%E7%BB%8D04-object%E7%9B%AE%E5%BD%95%E6%80%BB%E7%BB%93.png\" alt=\"git工作目录介绍04-object目录总结.png\"></li>\n<li><code>refs</code> : 引用\n<ul>\n<li>四种对象：提交对象，数据对象，树对象，标签对象。</li>\n<li>树对象:  <code>commit-&gt;tree-&gt;blob</code>  (文件)  <span class=\"spoiler\" title=\"...\">课后作业：多文件的提交记录</span></li>\n<li><code>heads/master</code> ,  <code>heads/test/</code> , <code>tags/</code> . 这几个文件的作用</li>\n<li><code>git symbolic</code>  命令，</li>\n</ul>\n</li>\n<li><code>Index</code>  文件。记录当前哪些文件被修改，新增。</li>\n<li>包文件： 解决 git 工作目录过大的问题。压缩。</li>\n</ul>\n</li>\n</ul>\n<h3 id=\"最后\"><a class=\"markdownIt-Anchor\" href=\"#最后\">#</a> 最后</h3>\n<p>期望与你一起遇见更好的自己</p>\n<p><img data-src=\"/images/qrcode.jpg\" alt=\"期望与你一起遇见更好的自己\"></p>\n",
            "tags": [
                "git"
            ]
        },
        {
            "id": "https://fangjiaxiaobai.github.io/2021/07/15/JDK%E6%BA%90%E7%A0%81/README/",
            "url": "https://fangjiaxiaobai.github.io/2021/07/15/JDK%E6%BA%90%E7%A0%81/README/",
            "title": "【目录】JDK源码解读目录",
            "date_published": "2021-07-15T06:48:55.000Z",
            "content_html": "<h2 id=\"目录\"><a class=\"markdownIt-Anchor\" href=\"#目录\">#</a> 目录</h2>\n<h4 id=\"javautil\"><a class=\"markdownIt-Anchor\" href=\"#javautil\">#</a> java.util</h4>\n<ul class=\"task-list\">\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"cbx_0\" checked=\"true\" disabled=\"true\"><label for=\"cbx_0\"> <a href=\"/2021/07/15/source%20code/HashMap/HashMap/\">HashMap</a></label>\n<ul class=\"task-list\">\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"cbx_1\" checked=\"true\" disabled=\"true\"><label for=\"cbx_1\"> <a href=\"/2021/07/15/source%20code/HashMap/HashMap%E7%9A%84Hash%E5%87%BD%E6%95%B0%E5%88%B0%E5%BA%95%E6%9C%89%E4%BB%80%E4%B9%88%E6%84%8F%E4%B9%89/\">HashMap 的 Hash 函数到底有什么意义.md</a></label></li>\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"cbx_2\" disabled=\"true\"><label for=\"cbx_2\"> <a href=\"./HashMap/HashMap%E5%88%B0%E5%BA%95%E4%B8%BA%E4%BB%80%E4%B9%88%E6%98%AF%E4%B8%8D%E5%AE%89%E5%85%A8%E7%9A%84.md\">HashMap 到底为什么是不安全的.md</a></label></li>\n</ul>\n</li>\n</ul>\n<h4 id=\"javautilconcurrency\"><a class=\"markdownIt-Anchor\" href=\"#javautilconcurrency\">#</a> java.util.concurrency</h4>\n<ul class=\"task-list\">\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"cbx_3\" disabled=\"true\"><label for=\"cbx_3\"> ConcurrentHashMap</label></li>\n</ul>\n<h4 id=\"javalang\"><a class=\"markdownIt-Anchor\" href=\"#javalang\">#</a> java.lang</h4>\n<ul class=\"task-list\">\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"cbx_4\" checked=\"true\" disabled=\"true\"><label for=\"cbx_4\"> <a href=\"2021/07/15/source%20code/String/String/\">String.md</a></label></li>\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"cbx_5\" checked=\"true\" disabled=\"true\"><label for=\"cbx_5\"> <a href=\"./threadLocal/ThreadLocal%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90.md\">ThreadLocal 源码分析.md</a></label>\n<ul class=\"task-list\">\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"cbx_6\" checked=\"true\" disabled=\"true\"><label for=\"cbx_6\"> <a href=\"./threadLocal/ThreadLocal%E7%9A%84%E5%93%88%E5%B8%8C%E7%AE%97%E6%B3%95.md\">ThreadLocal 的哈希算法.md</a></label></li>\n</ul>\n</li>\n</ul>\n",
            "tags": [
                "目录",
                "源码"
            ]
        },
        {
            "id": "https://fangjiaxiaobai.github.io/2021/07/15/JDK%E6%BA%90%E7%A0%81/HashMap/HashMap%E7%9A%84Hash%E5%87%BD%E6%95%B0%E5%88%B0%E5%BA%95%E6%9C%89%E4%BB%80%E4%B9%88%E6%84%8F%E4%B9%89/",
            "url": "https://fangjiaxiaobai.github.io/2021/07/15/JDK%E6%BA%90%E7%A0%81/HashMap/HashMap%E7%9A%84Hash%E5%87%BD%E6%95%B0%E5%88%B0%E5%BA%95%E6%9C%89%E4%BB%80%E4%B9%88%E6%84%8F%E4%B9%89/",
            "title": "HashMap的Hash函数到底有什么意义",
            "date_published": "2021-07-15T06:48:55.000Z",
            "content_html": "<h2 id=\"jdk18-hashmap中hash值计算源码\"><a class=\"markdownIt-Anchor\" href=\"#jdk18-hashmap中hash值计算源码\">#</a> jdk1.8 HashMap 中 hash 值计算源码</h2>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * 扰动函数</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">static</span> <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> <span class=\"title\">hash</span><span class=\"params\">(Object key)</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">int</span> h;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> (key == <span class=\"keyword\">null</span>) ? <span class=\"number\">0</span> : (h = key.hashCode()) ^ (h &gt;&gt;&gt; <span class=\"number\">16</span>);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 其中的key.hashCode调用的是底层的native方法。</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">native</span> <span class=\"keyword\">int</span> <span class=\"title\">hashCode</span><span class=\"params\">()</span></span>;</span><br></pre></td></tr></table></figure>\n<ul>\n<li>Q: 为什么不直接使用 key 的 hashCode 值呢？</li>\n</ul>\n<p>如果直接使用 key 的 hashCode () 函数的时候，将 hash 值作下标访问 Map 的数组的话，由于 2 进制的取值范围是 [-2<sup>31,2</sup>31), 加起来大于有 40 亿的映射空间。只要 hash 函数散列的比较松散，那么久很难出现碰撞。当然，40 亿的数据，内存也是放不下的。所以不能直接拿 key 的 hashCode。</p>\n<ul>\n<li>Q: 为什么要进行  <code>h = key.hashCode()) ^ (h &gt;&gt;&gt; 16)</code>  这个运算呢？</li>\n</ul>\n<p>这个问题就要从计算出的 hash 值的作用上来切入了，hashMap 计算这个 hash 值就是为了什么？增删改查的时候确定元素在数组中的位置。那么 hashMap 是怎么确定位置的呢？我们知道 HashMap 中的数组是 tab 字段。根据 tab 找到，在 <code>final HashMap.Node&lt;K,V&gt; getNode(int hash, Object key)</code>  方法中，有这么 <code>tab[(n - 1) &amp; hash]</code>  使用。 n 是数组的长度.<br>\n 这里 n-1 相当于一个 <code>低位掩码</code> ，和 hash 进行与操作的结果就是散列值的高位全部归零，保留低位，用来做下标访问。这么看，就算我们的 hash 散列分布再松散，冲突也会很严重。以默认长度 16 为例。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">  11111111  11111111 11110000 11101010  # native方法 HashCode()</span><br><span class=\"line\">&amp; 00000000  00000000 00000000 00001111  # 默认初始长度 15 = 16 -1</span><br><span class=\"line\">  -------------------------------------</span><br><span class=\"line\">  00000000  00000000 00000000 00001010  # 进行&amp;操作，计算出的下标为10</span><br></pre></td></tr></table></figure>\n<p>我们看下使用扰动函数计算后的结果:</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># 扰动函数计算过程:</span><br><span class=\"line\">   h=hashCode():  11111111  11111111  11110000  11101010  # native方法 HashCode()</span><br><span class=\"line\">   -------------------------------------------------------------------------------</span><br><span class=\"line\">              h:  11111111  11111111  11110000  11101010  # native方法 HashCode()计算出的值。</span><br><span class=\"line\">   ^     h&gt;&gt;&gt;16:  00000000  00000000  11111111  11111111  # hashCode左移16位=&gt;高16位变低位</span><br><span class=\"line\">   -----------------------------------------------------------------------------------</span><br><span class=\"line\">hash=h^(h&gt;&gt;&gt;16):  11111111  11111111  00001111  00010101  # 扰动函数计算出的值</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"># 与掩码做&amp;运算=&gt;计算数组下标</span><br><span class=\"line\">hash=h^(h&gt;&gt;&gt;16):  11111111  11111111  00001111  00010101  # 扰动函数计算出的值</span><br><span class=\"line\">            &amp;  :  00000000  00000000  00000000  00001111  # 低位掩码=&gt; hashMap中数组的长度</span><br><span class=\"line\">    -----------------------------------------------------------------------------------</span><br><span class=\"line\">                             ....                  00101  # =&gt;计算出的下标为5.</span><br></pre></td></tr></table></figure>\n<h3 id=\"peter-lawley的一篇专栏文章an-introduction-to-optimising-a-hashing-strategy里的的一个实验\"><a class=\"markdownIt-Anchor\" href=\"#peter-lawley的一篇专栏文章an-introduction-to-optimising-a-hashing-strategy里的的一个实验\">#</a> Peter Lawley 的一篇专栏文章《An introduction to optimising a hashing strategy》里的的一个实验</h3>\n<p><img data-src=\"/images/JavaSourceCode/HashMap/hashMap%E6%89%B0%E5%8A%A8%E5%87%BD%E6%95%B0%E7%9A%84%E4%BD%9C%E7%94%A8.png\" alt=\"hashMap扰动函数的作用.png\"></p>\n<p>结果显示，当 HashMap 数组长度为 512 的时候，也就是用掩码取低 9 位的时候，在没有扰动函数的情况下，发生了 103 次碰撞，接近 30%。而在使用了扰动函数之后只有 92 次碰撞。碰撞减少了将近 10%。看来扰动函数确实还是有功效的。</p>\n<h2 id=\"jdk7中的hashmap计算hash的方式\"><a class=\"markdownIt-Anchor\" href=\"#jdk7中的hashmap计算hash的方式\">#</a> JDK7 中的 HashMap 计算 hash 的方式</h2>\n<h2 id=\"参考文章\"><a class=\"markdownIt-Anchor\" href=\"#参考文章\">#</a> 参考文章</h2>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuY25ibG9ncy5jb20vemhlbmd3YW5nL3AvODEzNjE2NC5odG1s\">HashMap 中的 hash 函数</span></p>\n<h3 id=\"最后\"><a class=\"markdownIt-Anchor\" href=\"#最后\">#</a> 最后</h3>\n<p>期望与你一起遇见更好的自己</p>\n<p><img data-src=\"/images/qrcode.jpg\" alt=\"期望与你一起遇见更好的自己\"></p>\n",
            "tags": [
                "源码",
                "HashMap"
            ]
        },
        {
            "id": "https://fangjiaxiaobai.github.io/2021/07/15/JDK%E6%BA%90%E7%A0%81/String/String/",
            "url": "https://fangjiaxiaobai.github.io/2021/07/15/JDK%E6%BA%90%E7%A0%81/String/String/",
            "title": "String类源码解析",
            "date_published": "2021-07-15T06:48:55.000Z",
            "content_html": "<p>一、签名：</p>\n<p><code>public final class String implements java.io.Serializable, Comparable&lt;String&gt;, CharSequence</code></p>\n<ul>\n<li>String 不能被继承，</li>\n<li>实现了 Serializable：可被序列化。</li>\n<li>实现了 Comparable：可以比较，排序，</li>\n<li>实现了 CharSequence：值是可读序列。</li>\n</ul>\n<p>二、成员变量：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">final</span> <span class=\"keyword\">char</span> value[];  <span class=\"comment\">// 存储字符。</span></span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">int</span> hash;     <span class=\"comment\">// 缓存字符串的hash值。</span></span><br><span class=\"line\">Private <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> ObjectStreamField[] serialPersistentFields = <span class=\"keyword\">new</span> ObjectStreamFiled[<span class=\"number\">0</span>];  <span class=\"comment\">// 字符串类被指定转化序列化流协议中。</span></span><br><span class=\"line\"><span class=\"comment\">/** use serialVersionUID from JDK 1.0.2 for interoperability */</span></span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> <span class=\"keyword\">long</span> serialVersionUID = -<span class=\"number\">6849794470754667710L</span>;</span><br></pre></td></tr></table></figure>\n<p>Value 是 final 的，所以 String 一旦定义之后，就不可变的。</p>\n<p>三、构造函数：</p>\n<p>四、常用方法：</p>\n<p>由于 String 中重载的方法太多了，所以就只写方法名了。</p>\n<p>1.   <code>getBytes</code> :</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">byte</span>[] getBytes() &#123;</span><br><span class=\"line\">   <span class=\"keyword\">return</span> StringCoding.encode(value, <span class=\"number\">0</span>, value.length);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>以上面的这个方法为例：它交给了 <code>StringCoding.encode</code>  去获取 <code>bytes</code> 。然而 <code>StringEncoder</code>  去调用了 <code>StringEncoder</code>  的相应方法获取 <code>bytes</code> 、</p>\n<p>2.  equals</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">boolean</span> <span class=\"title\">equals</span><span class=\"params\">(Object anObject)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span> == anObject) &#123;   <span class=\"comment\">// 如果地址都相同的话，那肯定就是同一个了</span></span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"keyword\">true</span>; </span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (anObject <span class=\"keyword\">instanceof</span> String) &#123;</span><br><span class=\"line\">            String anotherString = (String)anObject;</span><br><span class=\"line\">            <span class=\"keyword\">int</span> n = value.length;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (n == anotherString.value.length) &#123;</span><br><span class=\"line\">                <span class=\"keyword\">char</span> v1[] = value;</span><br><span class=\"line\">                <span class=\"keyword\">char</span> v2[] = anotherString.value;</span><br><span class=\"line\">                <span class=\"keyword\">int</span> i = <span class=\"number\">0</span>;</span><br><span class=\"line\">                <span class=\"keyword\">while</span> (n-- != <span class=\"number\">0</span>) &#123;  <span class=\"comment\">//不错的编码风格。比for要好一点？</span></span><br><span class=\"line\">                    <span class=\"keyword\">if</span> (v1[i] != v2[i])</span><br><span class=\"line\">                        <span class=\"keyword\">return</span> <span class=\"keyword\">false</span>;</span><br><span class=\"line\">                    i++;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">                <span class=\"keyword\">return</span> <span class=\"keyword\">true</span>;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">false</span>;</span><br><span class=\"line\">    &#125;</span><br></pre></td></tr></table></figure>\n<p>3.  equalsIgnoreCase:</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">boolean</span> <span class=\"title\">equalsIgnoreCase</span><span class=\"params\">(String anotherString)</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">return</span> (<span class=\"keyword\">this</span> == anotherString) ? <span class=\"keyword\">true</span></span><br><span class=\"line\"></span><br><span class=\"line\">          : (anotherString != <span class=\"keyword\">null</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">          &amp;&amp; (anotherString.value.length == value.length)</span><br><span class=\"line\"></span><br><span class=\"line\">          &amp;&amp; regionMatches(<span class=\"keyword\">true</span>, <span class=\"number\">0</span>, anotherString, <span class=\"number\">0</span>, value.length);</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">boolean</span> <span class=\"title\">regionMatches</span><span class=\"params\">(<span class=\"keyword\">boolean</span> ignoreCase, <span class=\"keyword\">int</span> toffset,</span></span></span><br><span class=\"line\"><span class=\"params\"><span class=\"function\"></span></span></span><br><span class=\"line\"><span class=\"params\"><span class=\"function\">            String other, <span class=\"keyword\">int</span> ooffset, <span class=\"keyword\">int</span> len)</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">char</span> ta[] = value;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">int</span> to = toffset;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">char</span> pa[] = other.value;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">int</span> po = ooffset;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// Note: toffset, ooffset, or len might be near -1&gt;&gt;&gt;1.</span></span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> ((ooffset &lt; <span class=\"number\">0</span>) || (toffset &lt; <span class=\"number\">0</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">                || (toffset &gt; (<span class=\"keyword\">long</span>)value.length - len)</span><br><span class=\"line\"></span><br><span class=\"line\">                || (ooffset &gt; (<span class=\"keyword\">long</span>)other.value.length - len)) &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"keyword\">false</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">while</span> (len-- &gt; <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"keyword\">char</span> c1 = ta[to++];</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"keyword\">char</span> c2 = pa[po++];</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"keyword\">if</span> (c1 == c2) &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">                <span class=\"keyword\">continue</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">            &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"keyword\">if</span> (ignoreCase) &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">                <span class=\"comment\">// If characters don&#x27;t match but case may be ignored,</span></span><br><span class=\"line\"></span><br><span class=\"line\">                <span class=\"comment\">// try converting both characters to uppercase.</span></span><br><span class=\"line\"></span><br><span class=\"line\">                <span class=\"comment\">// If the results match, then the comparison scan should</span></span><br><span class=\"line\"></span><br><span class=\"line\">                <span class=\"comment\">// continue.</span></span><br><span class=\"line\"></span><br><span class=\"line\">                <span class=\"keyword\">char</span> u1 = Character.toUpperCase(c1);</span><br><span class=\"line\"></span><br><span class=\"line\">                <span class=\"keyword\">char</span> u2 = Character.toUpperCase(c2);</span><br><span class=\"line\"></span><br><span class=\"line\">                <span class=\"keyword\">if</span> (u1 == u2) &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">                    <span class=\"keyword\">continue</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">                &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">                <span class=\"comment\">// Unfortunately, conversion to uppercase does not work properly</span></span><br><span class=\"line\"></span><br><span class=\"line\">                <span class=\"comment\">// for the Georgian alphabet, which has strange rules about case</span></span><br><span class=\"line\"></span><br><span class=\"line\">                <span class=\"comment\">// conversion.  So we need to make one last check before</span></span><br><span class=\"line\"></span><br><span class=\"line\">                <span class=\"comment\">// exiting.</span></span><br><span class=\"line\"></span><br><span class=\"line\">                <span class=\"keyword\">if</span> (Character.toLowerCase(u1) == Character.toLowerCase(u2)) &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">                    <span class=\"keyword\">continue</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">                &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">            &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"keyword\">false</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">true</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br></pre></td></tr></table></figure>\n<p>在 regionMatches 中首先对传入的参数，进行合法性判断。然后取出每一个字符，比较一下，相同就下个字符，不同，都转换成大写，比较一次，如果相同就比较下一个字符，如果不相同就都转化成小写在比较一下。解释是说：有时候，转大写不一定每次都会正确。</p>\n<p>4.  startsWith:</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">boolean</span> <span class=\"title\">startsWith</span><span class=\"params\">(String prefix, <span class=\"keyword\">int</span> toffset)</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">char</span> ta[] = value;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">int</span> to = toffset;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">char</span> pa[] = prefix.value;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">int</span> po = <span class=\"number\">0</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">int</span> pc = prefix.value.length;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// Note: toffset might be near -1&gt;&gt;&gt;1.</span></span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> ((toffset &lt; <span class=\"number\">0</span>) || (toffset &gt; value.length - pc)) &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"keyword\">false</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">while</span> (--pc &gt;= <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"keyword\">if</span> (ta[to++] != pa[po++]) &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">                <span class=\"keyword\">return</span> <span class=\"keyword\">false</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">            &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">true</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br></pre></td></tr></table></figure>\n<p>5.  endsWith</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">boolean</span> <span class=\"title\">endsWith</span><span class=\"params\">(String suffix)</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">return</span> startsWith(suffix, value.length - suffix.value.length);</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>6.  重点来了：hashCode</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">int</span> <span class=\"title\">hashCode</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">int</span> h = hash;  <span class=\"comment\">///先获取缓存中的hash值。</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span>(h == <span class=\"number\">0</span> &amp;&amp; value.length &gt; <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">char</span> val[] = value;</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"keyword\">for</span> (<span class=\"keyword\">int</span> i = <span class=\"number\">0</span>; i &lt; value.length; i++) &#123;</span><br><span class=\"line\">               h = <span class=\"number\">31</span> * h + val[i];   <span class=\"comment\">// hash值算法。31</span></span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            hash = h;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> h;</span><br><span class=\"line\">    &#125;</span><br></pre></td></tr></table></figure>\n<p>7.  replace</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> String <span class=\"title\">replace</span><span class=\"params\">(<span class=\"keyword\">char</span> oldChar, <span class=\"keyword\">char</span> newChar)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (oldChar != newChar) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">int</span> len = value.length;</span><br><span class=\"line\">            <span class=\"keyword\">int</span> i = -<span class=\"number\">1</span>;</span><br><span class=\"line\">            <span class=\"keyword\">char</span>[] val = value; <span class=\"comment\">/* avoid getfield opcode */</span></span><br><span class=\"line\">            <span class=\"keyword\">while</span> (++i &lt; len) &#123;</span><br><span class=\"line\">                <span class=\"keyword\">if</span> (val[i] == oldChar) &#123;</span><br><span class=\"line\">                    <span class=\"keyword\">break</span>;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (i &lt; len) &#123;</span><br><span class=\"line\">                <span class=\"keyword\">char</span> buf[] = <span class=\"keyword\">new</span> <span class=\"keyword\">char</span>[len];</span><br><span class=\"line\">                <span class=\"keyword\">for</span> (<span class=\"keyword\">int</span> j = <span class=\"number\">0</span>; j &lt; i; j++) &#123;</span><br><span class=\"line\">                    buf[j] = val[j];</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">                <span class=\"keyword\">while</span> (i &lt; len) &#123;</span><br><span class=\"line\">                    <span class=\"keyword\">char</span> c = val[i];</span><br><span class=\"line\">                    buf[i] = (c == oldChar) ? newChar : c;</span><br><span class=\"line\">                    i++;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">                <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> String(buf, <span class=\"keyword\">true</span>);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">this</span>;</span><br><span class=\"line\">    &#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"最后\"><a class=\"markdownIt-Anchor\" href=\"#最后\">#</a> 最后</h3>\n<p>期望与你一起遇见更好的自己</p>\n<p><img data-src=\"/images/qrcode.jpg\" alt=\"期望与你一起遇见更好的自己\"></p>\n",
            "tags": [
                "源码",
                "String"
            ]
        },
        {
            "id": "https://fangjiaxiaobai.github.io/2021/07/15/JDK%E6%BA%90%E7%A0%81/HashMap/HashMap/",
            "url": "https://fangjiaxiaobai.github.io/2021/07/15/JDK%E6%BA%90%E7%A0%81/HashMap/HashMap/",
            "title": "全网最全的 HashMap 源码解读",
            "date_published": "2021-07-15T06:48:55.000Z",
            "content_html": "<h2 id=\"要思考的问题\"><a class=\"markdownIt-Anchor\" href=\"#要思考的问题\">#</a> 要思考的问题</h2>\n<ul>\n<li>HashMap 的底层数据结构 (节点结构，这种结构有什么优点)</li>\n<li>如何处理 hash 冲突</li>\n<li>怎么扩容？扩展机制是什么？</li>\n<li>增删改查过程</li>\n<li>链表到红黑树的转换过程，反之？</li>\n<li>红黑树相关 (见另一篇数据结构之红黑树)</li>\n<li>hash 计算</li>\n</ul>\n<h2 id=\"达到的目标\"><a class=\"markdownIt-Anchor\" href=\"#达到的目标\">#</a> 达到的目标</h2>\n<ul class=\"task-list\">\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"cbx_0\" checked=\"true\" disabled=\"true\"><label for=\"cbx_0\"> 掌握底层数据结构</label></li>\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"cbx_1\" checked=\"true\" disabled=\"true\"><label for=\"cbx_1\"> 掌握扩容原理</label></li>\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"cbx_2\" checked=\"true\" disabled=\"true\"><label for=\"cbx_2\"> 掌握 hash 冲突的处理过程</label></li>\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"cbx_3\" checked=\"true\" disabled=\"true\"><label for=\"cbx_3\"> 掌握增删改查过程</label></li>\n</ul>\n<h2 id=\"看之前要掌握的知识点\"><a class=\"markdownIt-Anchor\" href=\"#看之前要掌握的知识点\">#</a> 看之前要掌握的知识点</h2>\n<h3 id=\"红黑树\"><a class=\"markdownIt-Anchor\" href=\"#红黑树\">#</a> 红黑树</h3>\n<h2 id=\"看之前大体了解的知识点\"><a class=\"markdownIt-Anchor\" href=\"#看之前大体了解的知识点\">#</a> 看之前大体了解的知识点</h2>\n<h3 id=\"hash算法\"><a class=\"markdownIt-Anchor\" href=\"#hash算法\">#</a> hash 算法</h3>\n<h3 id=\"poisson分布\"><a class=\"markdownIt-Anchor\" href=\"#poisson分布\">#</a> Poisson 分布</h3>\n<p><span class=\"exturl\" data-url=\"aHR0cDovL2VuLndpa2lwZWRpYS5vcmcvd2lraS9Qb2lzc29uX2Rpc3RyaWJ1dGlvbg==\">poisson 分布</span></p>\n<h2 id=\"开始\"><a class=\"markdownIt-Anchor\" href=\"#开始\">#</a> 开始</h2>\n<h3 id=\"hashmap的继承体系\"><a class=\"markdownIt-Anchor\" href=\"#hashmap的继承体系\">#</a> HashMap 的继承体系</h3>\n<p><img data-src=\"/images/JavaSourceCode/HashMap/HashMap01-%E7%BB%A7%E6%89%BF%E4%BD%93%E7%B3%BB.png\" alt=\"HashMap01-继承体系.png\"></p>\n<ul>\n<li>AbstractMap: map 的抽象类，以最大限度的减少实现 Map 接口的类的工作量。</li>\n</ul>\n<h3 id=\"hashmap结构\"><a class=\"markdownIt-Anchor\" href=\"#hashmap结构\">#</a> hashMap 结构</h3>\n<h3 id=\"字段解释\"><a class=\"markdownIt-Anchor\" href=\"#字段解释\">#</a> 字段解释</h3>\n<h4 id=\"常量字段默认值字段\"><a class=\"markdownIt-Anchor\" href=\"#常量字段默认值字段\">#</a> 常量字段 (默认值字段)</h4>\n<ul>\n<li>DEFAULT_INITIAL_CAPACITY=1&lt;&lt;4: 默认的初始容量，默认是为 16, 必须是 2 的 n 次方。为什么呢？见扩容的方法。</li>\n<li>DEFAULT_LOAD_FACTOR=0.75f: 默认的负载因子。它和哈希表的容量的乘积是决定是否重新 hash 的阈值。</li>\n<li>TREEIFY_THRESHOLD=8: 使用树而不是链表的计数阈值。当桶的元素添加到具有至少这么多节点时，桶被转换为树。</li>\n<li>UNTREEIFY_THRESHOLD=6: 用于在调整大小操作期间解除（拆分）桶的桶计数阈值。(untreeifying 不是一个英语单词，这里的以是非树化，即转换成普通列表的过程). 也就是说从树转换成普通的桶 (链表) 的阈值。</li>\n<li>MAXIMUM_CAPACITY=1&lt;&lt;30: 最大的容量:  <code>1&lt;&lt;30</code> ，如果具有参数的任一构造函数隐式指定更高的值，则使用此参数。必须是 2 的 n 次方，小于等于 <code>1&lt;&lt;30</code></li>\n<li>MIN_TREEIFY_CAPACITY=64: 容器可以树化的最小容量 (否则，如果 bin 中的节点太多，则会调整表的大小.) 应该至少为 4 * TREEIFY_THRESHOLD，以避免调整大小和树化阈值之间的冲突.</li>\n</ul>\n<h4 id=\"类属性\"><a class=\"markdownIt-Anchor\" href=\"#类属性\">#</a> 类属性</h4>\n<ul>\n<li>table:  <code>transient HashMap.Node&lt;K,V&gt;[] table</code> ; table 在首次使用时初始化，并根据需要调整大小。分配时，长度始终是 2 的幂。(我们还在一些操作中容忍长度为零，以允许当前不需要的自举机制)</li>\n<li>entrySet:  <code>transient Set&lt;Map.Entry&lt;K,V&gt;&gt; entrySet</code> ; 保存缓存的 entrySet.</li>\n<li>size:  <code>transient int size</code> ; map 中元素的数量。结构修改是那些改变 HashMap 中映射数量或以其他方式修改其内部结构（例如，rehash）的修改。此字段用于在 HashMap 的 Collection-views 上快速生成迭代器 (见 ConcurrentModificationException)</li>\n</ul>\n<hr>\n<p>注意：这些字段都是  <code>transient</code>  的？为什么呢？</p>\n<ul>\n<li>loadFactor:  <code>final float loadFactor;</code>  hash 表的负载因子，在实例化 hashTable 的时候指定，该对象内不能变更 (final);</li>\n<li>threshold:  <code>int threshold;</code> , 下一次调整容器大小的阈值. threshold=capacity * load factor</li>\n</ul>\n<h4 id=\"hashmap的两种节点\"><a class=\"markdownIt-Anchor\" href=\"#hashmap的两种节点\">#</a> HashMap 的两种节点</h4>\n<ul>\n<li>基本的哈希桶的节点 (链表的结点) Node</li>\n</ul>\n<p><code>static class Node&lt;K,V&gt; implements Map.Entry&lt;K,V&gt;</code>  它继承了 Map 的 Entry, 是对子类的行为规范。要求提供了 getKey (),getValue () 等常用方法。</p>\n<p>链表节点的结构如下:</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">static</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Node</span>&lt;<span class=\"title\">K</span>,<span class=\"title\">V</span>&gt; <span class=\"keyword\">implements</span> <span class=\"title\">Map</span>.<span class=\"title\">Entry</span>&lt;<span class=\"title\">K</span>,<span class=\"title\">V</span>&gt; </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> hash; <span class=\"comment\">// 避免重复计算key的hash值</span></span><br><span class=\"line\">    <span class=\"keyword\">final</span> K key;</span><br><span class=\"line\">    V value;</span><br><span class=\"line\">    <span class=\"comment\">// 指向下一个节点的指针</span></span><br><span class=\"line\">    HashMap.Node&lt;K,V&gt; next;</span><br><span class=\"line\"></span><br><span class=\"line\">    Node(<span class=\"keyword\">int</span> hash, K key, V value, HashMap.Node&lt;K,V&gt; next) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.hash = hash;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.key = key;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.value = value;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.next = next;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">final</span> K <span class=\"title\">getKey</span><span class=\"params\">()</span>        </span>&#123; <span class=\"keyword\">return</span> key; &#125;</span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">final</span> V <span class=\"title\">getValue</span><span class=\"params\">()</span>      </span>&#123; <span class=\"keyword\">return</span> value; &#125;</span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">final</span> String <span class=\"title\">toString</span><span class=\"params\">()</span> </span>&#123; <span class=\"keyword\">return</span> key + <span class=\"string\">&quot;=&quot;</span> + value; &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// todo 没有找到在哪里使用了这个方法</span></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> <span class=\"title\">hashCode</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> Objects.hashCode(key) ^ Objects.hashCode(value);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">final</span> V <span class=\"title\">setValue</span><span class=\"params\">(V newValue)</span> </span>&#123;</span><br><span class=\"line\">        V oldValue = value;</span><br><span class=\"line\">        value = newValue;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> oldValue;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">final</span> <span class=\"keyword\">boolean</span> <span class=\"title\">equals</span><span class=\"params\">(Object o)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (o == <span class=\"keyword\">this</span>)</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"keyword\">true</span>;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (o <span class=\"keyword\">instanceof</span> Map.Entry) &#123;</span><br><span class=\"line\">            Map.Entry&lt;?,?&gt; e = (Map.Entry&lt;?,?&gt;)o;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (Objects.equals(key, e.getKey()) &amp;&amp;</span><br><span class=\"line\">                    Objects.equals(value, e.getValue()))</span><br><span class=\"line\">                <span class=\"keyword\">return</span> <span class=\"keyword\">true</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">false</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<ul>\n<li>Tree 的节点 TreeNode</li>\n</ul>\n<p><code>static final class TreeNode&lt;K,V&gt; extends LinkedHashMap.Entry&lt;K,V&gt;</code>  继承了其子类的 Entry, 子类的 Entry 继承了父类的 Node. 注意了，这里乍一看还挺乱。来张图吧。<br>\n<img data-src=\"/images/JavaSourceCode/HashMap/hashMap%E7%9A%84%E8%8A%82%E7%82%B9%E7%9A%84%E7%BB%A7%E6%89%BF%E5%9B%BE.png\" alt=\"hashMap的节点的继承图.png\"></p>\n<p>这里呢，TreeNode 其实是 Node 的孙子，也就是说 HashMap 的树节点是链表节点的孙子辈儿的。<br>\n为什么要使两种节点有继承关系呢？为什么 TreeNode 不直接继承 Node 节点呢？</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">static</span> <span class=\"keyword\">final</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">TreeNode</span>&lt;<span class=\"title\">K</span>,<span class=\"title\">V</span>&gt; <span class=\"keyword\">extends</span> <span class=\"title\">LinkedHashMap</span>.<span class=\"title\">Entry</span>&lt;<span class=\"title\">K</span>,<span class=\"title\">V</span>&gt; </span>&#123;</span><br><span class=\"line\">    HashMap.TreeNode&lt;K,V&gt; parent;  <span class=\"comment\">// red-black tree links</span></span><br><span class=\"line\">    HashMap.TreeNode&lt;K,V&gt; left;</span><br><span class=\"line\">    HashMap.TreeNode&lt;K,V&gt; right;</span><br><span class=\"line\">    HashMap.TreeNode&lt;K,V&gt; prev;    <span class=\"comment\">// needed to unlink next upon deletion</span></span><br><span class=\"line\">    <span class=\"keyword\">boolean</span> red;</span><br><span class=\"line\">    TreeNode(<span class=\"keyword\">int</span> hash, K key, V val, HashMap.Node&lt;K,V&gt; next) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">super</span>(hash, key, val, next);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"comment\">// 省略其他代码</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"hashmap增加方法-hashmapput\"><a class=\"markdownIt-Anchor\" href=\"#hashmap增加方法-hashmapput\">#</a> HashMap 增加方法 HashMap#put ()</h3>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">*  将指定的value和key关联在map中。</span></span><br><span class=\"line\"><span class=\"comment\">*  如果map中已经存在了key,那么将会替换掉老的value。</span></span><br><span class=\"line\"><span class=\"comment\">* <span class=\"doctag\">@param</span> key key 指定的key</span></span><br><span class=\"line\"><span class=\"comment\">* <span class=\"doctag\">@param</span> value value 和指定key关联的value</span></span><br><span class=\"line\"><span class=\"comment\">* <span class=\"doctag\">@return</span> 如果返回了value，就说明map中原来和key关联是有值的。如果返回null就说明没有value。</span></span><br><span class=\"line\"><span class=\"comment\">*/</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> V <span class=\"title\">put</span><span class=\"params\">(K key, V value)</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> putVal(hash(key), key, value, <span class=\"keyword\">false</span>, <span class=\"keyword\">true</span>);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>这里就比较有看点了，1. 这里是 hashMap 的增加方法，增加方法里必然会遇到 hash 冲突的问题，我们等会看下 hash 冲突是如何处理的，还会涉及到扩容的问题，我们也要来看看他是怎么扩容的，扩容的过程中还会遇到普通的桶转换成树的过程。我们先来看下 hash 值是怎么计算出来的。</p>\n<ul>\n<li TODO=\"\" 和jdk1.7中的比较=\"\"><code>hash</code>  值的计算</li>\n</ul>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * 计算key的hashCode并且和hashCode值高16位进行异或运算。(异或: 相同为0，不同为1)</span></span><br><span class=\"line\"><span class=\"comment\"> * 混和低位和高位，就是为了加大低位的随机性,而且混合后的低位掺杂了高位的部分特征,</span></span><br><span class=\"line\"><span class=\"comment\"> * 这样高位的信息也被变相的保留了下来。</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">static</span> <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> <span class=\"title\">hash</span><span class=\"params\">(Object key)</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">int</span> h;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> (key == <span class=\"keyword\">null</span>) ? <span class=\"number\">0</span> : (h = key.hashCode()) ^ (h &gt;&gt;&gt; <span class=\"number\">16</span>);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>为什么这么做呢？见<a href=\"/2021/07/15/source%20code/HashMap/HashMap%E7%9A%84Hash%E5%87%BD%E6%95%B0%E5%88%B0%E5%BA%95%E6%9C%89%E4%BB%80%E4%B9%88%E6%84%8F%E4%B9%89/\"> HashMap 的 Hash 函数到底有什么意义</a></p>\n<ul>\n<li>那我们接下接着看 <code>putVal()</code>  方法。</li>\n</ul>\n<figure class=\"highlight java\"><figcaption><span>&#123;.line-numbers&#125;</span></figcaption><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * 实现Map.put相关的方法。</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@param</span> hash hash for key</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@param</span> key the key</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@param</span> value the value to put</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@param</span> onlyIfAbsent if true, don&#x27;t change existing value</span></span><br><span class=\"line\"><span class=\"comment\"> *                     如果是true的,不会修改存在的值。返回老的值。</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@param</span> evict if false, the table is in creation mode.</span></span><br><span class=\"line\"><span class=\"comment\"> *              如果为false的时候,表属于创建模式,第一次新增元素的时候。</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@return</span> previous value, or null if none</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">final</span> V <span class=\"title\">putVal</span><span class=\"params\">(<span class=\"keyword\">int</span> hash, K key, V value, <span class=\"keyword\">boolean</span> onlyIfAbsent,</span></span></span><br><span class=\"line\"><span class=\"params\"><span class=\"function\">                <span class=\"keyword\">boolean</span> evict)</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    HashMap.Node&lt;K,V&gt;[] tab;</span><br><span class=\"line\">    HashMap.Node&lt;K,V&gt; p;</span><br><span class=\"line\">    <span class=\"keyword\">int</span> n, i;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ((tab = table) == <span class=\"keyword\">null</span> || (n = tab.length) == <span class=\"number\">0</span>)</span><br><span class=\"line\">        <span class=\"comment\">// 如果数组为null,或者数组长度为0的时候，数组需要调整大小。</span></span><br><span class=\"line\">        n = (tab = resize()).length;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ((p = tab[i = (n - <span class=\"number\">1</span>) &amp; hash]) == <span class=\"keyword\">null</span>)</span><br><span class=\"line\">        <span class=\"comment\">// 定位到数组的桶为null的时候,创建桶内的第一个元素。next=null;</span></span><br><span class=\"line\">        tab[i] = newNode(hash, key, value, <span class=\"keyword\">null</span>);</span><br><span class=\"line\">    <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">        <span class=\"comment\">// 如果桶不为null，则创建链表</span></span><br><span class=\"line\">        HashMap.Node&lt;K,V&gt; e; K k;</span><br><span class=\"line\">        <span class=\"comment\">// p表示当前桶的第一个元素。</span></span><br><span class=\"line\">        <span class=\"comment\">// 如果新增的元素和第一个元素相等的话(出现hash冲突),暂存已经存在的元素到变量e中。</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (p.hash == hash &amp;&amp;</span><br><span class=\"line\">                ((k = p.key) == key || (key != <span class=\"keyword\">null</span> &amp;&amp; key.equals(k))))</span><br><span class=\"line\">            e = p;</span><br><span class=\"line\">        <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (p <span class=\"keyword\">instanceof</span> HashMap.TreeNode)</span><br><span class=\"line\">            <span class=\"comment\">// 如果是树节点。</span></span><br><span class=\"line\">            e = ((HashMap.TreeNode&lt;K,V&gt;)p).putTreeVal(<span class=\"keyword\">this</span>, tab, hash, key, value);</span><br><span class=\"line\">        <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">            <span class=\"comment\">// 链表元素新增的过程了。</span></span><br><span class=\"line\">            <span class=\"keyword\">for</span> (<span class=\"keyword\">int</span> binCount = <span class=\"number\">0</span>; ; ++binCount) &#123;</span><br><span class=\"line\">                <span class=\"keyword\">if</span> ((e = p.next) == <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">                    p.next = newNode(hash, key, value, <span class=\"keyword\">null</span>);</span><br><span class=\"line\">                    <span class=\"keyword\">if</span> (binCount &gt;= TREEIFY_THRESHOLD - <span class=\"number\">1</span>)</span><br><span class=\"line\">                        <span class=\"comment\">// 如果桶内的元素数量达到树化的阈值,将链表转换成树。</span></span><br><span class=\"line\">                        treeifyBin(tab, hash);</span><br><span class=\"line\">                    <span class=\"keyword\">break</span>;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">                <span class=\"keyword\">if</span> (e.hash == hash &amp;&amp;</span><br><span class=\"line\">                        ((k = e.key) == key || (key != <span class=\"keyword\">null</span> &amp;&amp; key.equals(k))))</span><br><span class=\"line\">                    <span class=\"comment\">// 如果第一个元素和要新增的元素hash,key都相等的话,直接进行新增操作。</span></span><br><span class=\"line\">                    <span class=\"keyword\">break</span>;</span><br><span class=\"line\">                p = e;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (e != <span class=\"keyword\">null</span>) &#123; <span class=\"comment\">// existing mapping for key</span></span><br><span class=\"line\">            <span class=\"comment\">// 如果原来的元素不为空,保留原来的值。</span></span><br><span class=\"line\">            V oldValue = e.value;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (!onlyIfAbsent || oldValue == <span class=\"keyword\">null</span>)</span><br><span class=\"line\">                <span class=\"comment\">// 覆盖掉原来的value;</span></span><br><span class=\"line\">                e.value = value;</span><br><span class=\"line\">            <span class=\"comment\">// 留一个无方法体的方法，供子类扩展</span></span><br><span class=\"line\">            afterNodeAccess(e);</span><br><span class=\"line\">            <span class=\"keyword\">return</span> oldValue;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"comment\">// failFast计数</span></span><br><span class=\"line\">    ++modCount;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (++size &gt; threshold)</span><br><span class=\"line\">        <span class=\"comment\">// 如果table中的桶的数量超过了阈值。扩容。</span></span><br><span class=\"line\">        resize();</span><br><span class=\"line\">    <span class=\"comment\">// 供子类扩展的方法。</span></span><br><span class=\"line\">    afterNodeInsertion(evict);</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"keyword\">null</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>这段代码里中有三处重要的地方， <code>resize()</code> , <code>treeifyBin()</code> , <code>putTreeNode()</code> , 接下来我们依次看下这三个方法。</p>\n<h4 id=\"resize\"><a class=\"markdownIt-Anchor\" href=\"#resize\">#</a> resize</h4>\n<figure class=\"highlight java\"><figcaption><span>&#123;.line-numbers&#125;</span></figcaption><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * 初始化，或者加倍表格的大小</span></span><br><span class=\"line\"><span class=\"comment\"> * 如果为null时候，根据字段threshold的初始容量进行分配</span></span><br><span class=\"line\"><span class=\"comment\"> * 否则，因为我们正在使用二次幂扩展，所以每个bin中的元素必须保持相同的索引，或者在新表中以两个偏移的幂移动</span></span><br><span class=\"line\"><span class=\"comment\"> *</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@return</span> the table 新的表</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"keyword\">final</span> HashMap.Node&lt;K, V&gt;[] resize() &#123;</span><br><span class=\"line\">    HashMap.Node&lt;K, V&gt;[] oldTab = table;</span><br><span class=\"line\">    <span class=\"keyword\">int</span> oldCap = (oldTab == <span class=\"keyword\">null</span>) ? <span class=\"number\">0</span> : oldTab.length;</span><br><span class=\"line\">    <span class=\"keyword\">int</span> oldThr = threshold;</span><br><span class=\"line\">    <span class=\"keyword\">int</span> newCap, newThr = <span class=\"number\">0</span>;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (oldCap &gt; <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">        <span class=\"comment\">// 如果旧表的大小大于0</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (oldCap &gt;= MAXIMUM_CAPACITY) &#123;</span><br><span class=\"line\">            <span class=\"comment\">// hash表达到最大容量</span></span><br><span class=\"line\">            threshold = Integer.MAX_VALUE;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> oldTab;</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> ((newCap = oldCap &lt;&lt; <span class=\"number\">1</span>) &lt; MAXIMUM_CAPACITY &amp;&amp;</span><br><span class=\"line\">                oldCap &gt;= DEFAULT_INITIAL_CAPACITY) &#123;</span><br><span class=\"line\">            <span class=\"comment\">// 如果翻倍后旧表大小&lt;最大表长度，并且旧表长度&gt;默认初始化长度。</span></span><br><span class=\"line\">            <span class=\"comment\">// 扩容的阈值也翻倍。 还是等级 table.length*loadFactor</span></span><br><span class=\"line\">            newThr = oldThr &lt;&lt; <span class=\"number\">1</span>; <span class=\"comment\">// double threshold</span></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (oldThr &gt; <span class=\"number\">0</span>) &#123; <span class=\"comment\">// initial capacity was placed in threshold</span></span><br><span class=\"line\">        <span class=\"comment\">// 旧表长度&lt;=0,旧的threshold&gt;0,</span></span><br><span class=\"line\">        <span class=\"comment\">// 就把threshold设置为表长度。</span></span><br><span class=\"line\">        newCap = oldThr;</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;               <span class=\"comment\">// zero initial threshold signifies using defaults</span></span><br><span class=\"line\">        <span class=\"comment\">// 设置为默认值。</span></span><br><span class=\"line\">        newCap = DEFAULT_INITIAL_CAPACITY;</span><br><span class=\"line\">        newThr = (<span class=\"keyword\">int</span>) (DEFAULT_LOAD_FACTOR * DEFAULT_INITIAL_CAPACITY);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (newThr == <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">        <span class=\"comment\">// 如果新的扩缩容阈值等于0,设置新的扩缩容阈值为新的容量*负载因子.</span></span><br><span class=\"line\">        <span class=\"keyword\">float</span> ft = (<span class=\"keyword\">float</span>) newCap * loadFactor;</span><br><span class=\"line\">        newThr = (newCap &lt; MAXIMUM_CAPACITY &amp;&amp; ft &lt; (<span class=\"keyword\">float</span>) MAXIMUM_CAPACITY ?</span><br><span class=\"line\">                (<span class=\"keyword\">int</span>) ft : Integer.MAX_VALUE);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    threshold = newThr;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// 重新创建新的hash表</span></span><br><span class=\"line\">    <span class=\"meta\">@SuppressWarnings(&#123;&quot;rawtypes&quot;, &quot;unchecked&quot;&#125;)</span></span><br><span class=\"line\">    HashMap.Node&lt;K, V&gt;[] newTab = (HashMap.Node&lt;K, V&gt;[]) <span class=\"keyword\">new</span> HashMap.Node[newCap];</span><br><span class=\"line\">    table = newTab;</span><br><span class=\"line\">    <span class=\"comment\">// 如果旧表不为空,进行扩容.</span></span><br><span class=\"line\">    <span class=\"comment\">// 否则(旧表为空)就进行初始化过程.</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (oldTab != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">for</span> (<span class=\"keyword\">int</span> j = <span class=\"number\">0</span>; j &lt; oldCap; ++j) &#123;</span><br><span class=\"line\">            HashMap.Node&lt;K, V&gt; e;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> ((e = oldTab[j]) != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">                oldTab[j] = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">                <span class=\"keyword\">if</span> (e.next == <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">                    <span class=\"comment\">// 如果当前桶只有一个节点。</span></span><br><span class=\"line\">                    newTab[e.hash &amp; (newCap - <span class=\"number\">1</span>)] = e;</span><br><span class=\"line\">                &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (e <span class=\"keyword\">instanceof</span> HashMap.TreeNode) &#123;</span><br><span class=\"line\">                    <span class=\"comment\">// 如果当前桶是棵红黑树</span></span><br><span class=\"line\">                    ((HashMap.TreeNode&lt;K, V&gt;) e).split(<span class=\"keyword\">this</span>, newTab, j, oldCap);</span><br><span class=\"line\">                &#125; <span class=\"keyword\">else</span> &#123; <span class=\"comment\">// preserve order</span></span><br><span class=\"line\">                    <span class=\"comment\">// 桶是链表,将该桶内的元素重新分配到表中。</span></span><br><span class=\"line\"></span><br><span class=\"line\">                    HashMap.Node&lt;K, V&gt; loHead = <span class=\"keyword\">null</span>, loTail = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">                    HashMap.Node&lt;K, V&gt; hiHead = <span class=\"keyword\">null</span>, hiTail = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">                    HashMap.Node&lt;K, V&gt; next;</span><br><span class=\"line\"></span><br><span class=\"line\">                    <span class=\"comment\">// 遍历桶内的元素，将元素重新分配到hash表内的各个桶中。</span></span><br><span class=\"line\">                    <span class=\"comment\">// 具体的实现过程是: 将当前的元素的hash值和容量取&amp;,如果&gt;0,那就说明该元素应该分配到新的桶内。</span></span><br><span class=\"line\">                    <span class=\"comment\">// 桶的位置就是: oldCap+j.即桶原来容器+该元素所在的桶的下标。(hiHead所标识的位置)</span></span><br><span class=\"line\">                    <span class=\"comment\">// 反之如果hash值是==0的,那么该元素就应该还在当前桶内。(loHead所标识的位置)</span></span><br><span class=\"line\">                    <span class=\"comment\">// 这里所说的位置都是指桶的下标,整个表都是新的了,位置肯定都变了。</span></span><br><span class=\"line\">                    <span class=\"comment\">// 为什么可以这么实现呢？</span></span><br><span class=\"line\">                    <span class=\"comment\">// 因为扩容的时候，使用的是原来容量的2倍进行扩容的。所以就可以使用(oldCap+j)的方式来确定元素的新位置了。</span></span><br><span class=\"line\">                    <span class=\"keyword\">do</span> &#123;</span><br><span class=\"line\">                        next = e.next;</span><br><span class=\"line\">                        <span class=\"keyword\">if</span> ((e.hash &amp; oldCap) == <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">                            <span class=\"comment\">// 还在原桶中</span></span><br><span class=\"line\">                            <span class=\"keyword\">if</span> (loTail == <span class=\"keyword\">null</span>)</span><br><span class=\"line\">                                loHead = e;</span><br><span class=\"line\">                            <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                                <span class=\"comment\">// 位置最后一个节点为空,使用e=next的时候，next为null的情况。</span></span><br><span class=\"line\">                                <span class=\"comment\">// 在桶内元素遍历完成后,会把桶的最后一个元素的next置为null。</span></span><br><span class=\"line\">                                loTail.next = e;</span><br><span class=\"line\">                            &#125;</span><br><span class=\"line\">                            loTail = e;</span><br><span class=\"line\">                        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                            <span class=\"comment\">// 放置到新的桶内。</span></span><br><span class=\"line\">                            <span class=\"keyword\">if</span> (hiTail == <span class=\"keyword\">null</span>)</span><br><span class=\"line\">                                hiHead = e;</span><br><span class=\"line\">                            <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                                <span class=\"comment\">// 位置最后一个节点为空,使用e=next的时候，next为null的情况。</span></span><br><span class=\"line\">                                <span class=\"comment\">// 在桶内元素遍历完成后,会把桶的最后一个元素的next置为null。</span></span><br><span class=\"line\">                                hiTail.next = e;</span><br><span class=\"line\">                            &#125;</span><br><span class=\"line\">                            hiTail = e;</span><br><span class=\"line\">                        &#125;</span><br><span class=\"line\">                    &#125; <span class=\"keyword\">while</span> ((e = next) != <span class=\"keyword\">null</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">                    <span class=\"keyword\">if</span> (loTail != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">                        loTail.next = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">                        <span class=\"comment\">// 原来桶的位置。</span></span><br><span class=\"line\">                        newTab[j] = loHead;</span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">                    <span class=\"keyword\">if</span> (hiTail != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">                        hiTail.next = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">                        <span class=\"comment\">// 确定新桶的位置</span></span><br><span class=\"line\">                        newTab[j + oldCap] = hiHead;</span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> newTab;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>看一个散列还算非常均匀的例子来看扩容过程。</p>\n<p><img data-src=\"/images/JavaSourceCode/HashMap/hashMap04-Put%E6%96%B9%E6%B3%95%E8%BF%87%E7%A8%8B01.png\" alt=\"hashMap04-Put方法过程01.png\"></p>\n<p>那么进行扩容的过程是怎么样的呢？</p>\n<p><img data-src=\"/images/JavaSourceCode/HashMap/hashMap05-resize%E6%96%B9%E6%B3%9501.png\" alt=\"hashMap05-resize方法01.png\"></p>\n<p>以元素 1 和 12 为例，看扩容过程:<br>\n 元素 1 的 hash 值为 49.(以 hashMap 计算 hash 值的方式得出。)， 与 15 取 &amp; 计算桶的下标为 1, 扩容后，与 31 取 &amp;, 计算桶的下标为 17. 所以扩容前位置是 0，扩容后元素 1 的存放位置是 17。<br>\n代码中是怎么完成这个过程的呢？<br>\n和扩容前 hash 表的容量取 &amp;, 得  <code>49 &amp; 16 = 16 &gt; 0</code>  (代码第 86-96 行), 新的桶的头节点 (对应代码里的 hiHead) 就是当前节点 1，尾节点 (hiTail) 赋为当前节点。然后进行下一次 <code>do...while</code>  循环，处理节点 12, 计算出节点 12 的 hash 值为 <code>1569</code> , 进行计算 <code>1569 &amp; 16 = 0 == 0</code>  原来桶的头结点是节点 12, 尾节点也是节点 12 (对应着代码第 76-86 行), 这样 hitail 和 loTail 均不为 null, 所以然后直接使用 <code>newTab[j] = loHead;</code>  和  <code>newTab[j + oldCap] = hiHead;</code>  的方式确定桶的位置。这个案例里，处理完节点 12 才会确定桶的位置。因为原来的表中下标为 1 的桶中有两个元素 1 和 12. 那桶里只有一个元素的怎么处理的呢？ <code>newTab[e.hash &amp; (newCap - 1)] = e;</code>  e 是当前节点，newCap 是新表的容量。</p>\n<blockquote>\n<p>如果你想问为什么能使用   <code>hash &amp; olcCap==0?</code>  来决定是 <code>newTab[j]</code>  还是  <code>newTab[j+oldCap]</code>  这种方式来确定新的桶的下标的话。 那么原因就是扩容使用的是 2 次幂的方式，容量是原来容量的 2 倍。所以就可以使用  <code>hash &amp; olcCap==0?</code>  来判断了。</p>\n</blockquote>\n<p>这个例子呢，演示了扩容过程中的链表的新增和扩容过程。再回头看 resize 方法，还有一种情况我们没有分析过。那就是</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">...</span><br><span class=\"line\"><span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (e <span class=\"keyword\">instanceof</span> HashMap.TreeNode) &#123;</span><br><span class=\"line\">    <span class=\"comment\">// 如果当前桶是棵红黑树</span></span><br><span class=\"line\">    ((HashMap.TreeNode&lt;K, V&gt;) e).split(<span class=\"keyword\">this</span>, newTab, j, oldCap);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">...</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight java\"><figcaption><span>&#123;.line-numbers&#125;</span></figcaption><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">    * 将原来树桶中的节点拆分为更低或更高的树桶,如果太小的话就转化成链表</span></span><br><span class=\"line\"><span class=\"comment\">    * 只被resize方法调用</span></span><br><span class=\"line\"><span class=\"comment\">    *</span></span><br><span class=\"line\"><span class=\"comment\">    * <span class=\"doctag\">@param</span> map   hash表</span></span><br><span class=\"line\"><span class=\"comment\">    * <span class=\"doctag\">@param</span> tab   表中的指定的桶的头结点(桶是一个棵树)</span></span><br><span class=\"line\"><span class=\"comment\">    * <span class=\"doctag\">@param</span> index 要拆分的hash表的节点</span></span><br><span class=\"line\"><span class=\"comment\">    * <span class=\"doctag\">@param</span> bit   the bit of hash to split on 要分裂的hash位</span></span><br><span class=\"line\"><span class=\"comment\">    */</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">final</span> <span class=\"keyword\">void</span> <span class=\"title\">split</span><span class=\"params\">(HashMap&lt;K, V&gt; map, HashMap.Node&lt;K, V&gt;[] tab, <span class=\"keyword\">int</span> index, <span class=\"keyword\">int</span> bit)</span> </span>&#123;</span><br><span class=\"line\">    HashMap.TreeNode&lt;K, V&gt; b = <span class=\"keyword\">this</span>;</span><br><span class=\"line\">    <span class=\"comment\">// Relink into lo and hi lists, preserving order</span></span><br><span class=\"line\">    HashMap.TreeNode&lt;K, V&gt; loHead = <span class=\"keyword\">null</span>, loTail = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">    HashMap.TreeNode&lt;K, V&gt; hiHead = <span class=\"keyword\">null</span>, hiTail = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">    <span class=\"comment\">// lc代表的是原来的桶的元素的数量</span></span><br><span class=\"line\">    <span class=\"comment\">// hc代表新的桶中的元素的数量, 用来和UNTREEIFY_THRESHOLD比较决定是否要转换结构.</span></span><br><span class=\"line\">    <span class=\"keyword\">int</span> lc = <span class=\"number\">0</span>, hc = <span class=\"number\">0</span>;</span><br><span class=\"line\">    <span class=\"comment\">// 这里还是当做链表去处理，把桶内的元素重新散列。</span></span><br><span class=\"line\">    <span class=\"keyword\">for</span> (HashMap.TreeNode&lt;K, V&gt; e = b, next; e != <span class=\"keyword\">null</span>; e = next) &#123;</span><br><span class=\"line\">        next = (HashMap.TreeNode&lt;K, V&gt;) e.next;</span><br><span class=\"line\">        e.next = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> ((e.hash &amp; bit) == <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> ((e.prev = loTail) == <span class=\"keyword\">null</span>)</span><br><span class=\"line\">                loHead = e;</span><br><span class=\"line\">            <span class=\"keyword\">else</span></span><br><span class=\"line\">                loTail.next = e;</span><br><span class=\"line\">            loTail = e;</span><br><span class=\"line\">            ++lc;</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> ((e.prev = hiTail) == <span class=\"keyword\">null</span>)</span><br><span class=\"line\">                hiHead = e;</span><br><span class=\"line\">            <span class=\"keyword\">else</span></span><br><span class=\"line\">                hiTail.next = e;</span><br><span class=\"line\">            hiTail = e;</span><br><span class=\"line\">            ++hc;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"comment\">//  散列完后，判断原来的桶(lo)和新的桶中的元素个数</span></span><br><span class=\"line\">    <span class=\"comment\">//  然后决定转换为树还是链表</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (loHead != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (lc &lt;= UNTREEIFY_THRESHOLD)</span><br><span class=\"line\">            tab[index] = loHead.untreeify(map);</span><br><span class=\"line\">        <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">            tab[index] = loHead;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (hiHead != <span class=\"keyword\">null</span>) <span class=\"comment\">// (else is already treeified)</span></span><br><span class=\"line\">                loHead.treeify(tab);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (hiHead != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (hc &lt;= UNTREEIFY_THRESHOLD)</span><br><span class=\"line\">            tab[index + bit] = hiHead.untreeify(map);</span><br><span class=\"line\">        <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">            tab[index + bit] = hiHead;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (loHead != <span class=\"keyword\">null</span>)</span><br><span class=\"line\">                hiHead.treeify(tab);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>将树重新穿换成链表的过程就比较简单了：</p>\n<figure class=\"highlight java\"><figcaption><span>&#123;.line-numbers&#125;</span></figcaption><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">    * Returns a list of non-TreeNodes replacing those linked from</span></span><br><span class=\"line\"><span class=\"comment\">    * this node.</span></span><br><span class=\"line\"><span class=\"comment\">    */</span></span><br><span class=\"line\"><span class=\"keyword\">final</span> HashMap.<span class=\"function\">Node&lt;K, V&gt; <span class=\"title\">untreeify</span><span class=\"params\">(HashMap&lt;K, V&gt; map)</span> </span>&#123;</span><br><span class=\"line\">    HashMap.Node&lt;K, V&gt; hd = <span class=\"keyword\">null</span>, tl = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">    <span class=\"keyword\">for</span> (HashMap.Node&lt;K, V&gt; q = <span class=\"keyword\">this</span>; q != <span class=\"keyword\">null</span>; q = q.next) &#123;</span><br><span class=\"line\">        <span class=\"comment\">// replacementNode:将TreeNode转成Node</span></span><br><span class=\"line\">        HashMap.Node&lt;K, V&gt; p = map.replacementNode(q, <span class=\"keyword\">null</span>);</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (tl == <span class=\"keyword\">null</span>)</span><br><span class=\"line\">            hd = p;</span><br><span class=\"line\">        <span class=\"keyword\">else</span></span><br><span class=\"line\">            tl.next = p;</span><br><span class=\"line\">        tl = p;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> hd;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>这里就是和红黑树相关的内容了，这里关键的是 split 调用了一个 treeify 的方法。这个方法同时也被 treeifyBin 调用了。所以 treeify 方法就和 treeifyBin 方法一块分享。<br>\n顺便提一嘴，他们有如下的关系:</p>\n<p><img data-src=\"/images/JavaSourceCode/HashMap/hashMap06-%E7%BA%A2%E9%BB%91%E6%A0%91%E7%9B%B8%E5%85%B3%E6%96%B9%E6%B3%95%E8%B0%83%E7%94%A8%E5%85%B3%E7%B3%BB.png\" alt=\"hashMap06-红黑树相关方法调用关系.png\"><br>\n 其中蓝色的是红黑树的方法，黄色的是 HashMap 调用的方法。</p>\n<h4 id=\"treeifybin\"><a class=\"markdownIt-Anchor\" href=\"#treeifybin\">#</a> treeifyBin</h4>\n<figure class=\"highlight java\"><figcaption><span>&#123;.line-numbers&#125;</span></figcaption><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">* 将链表转换成树。</span></span><br><span class=\"line\"><span class=\"comment\">* 替换给定hash值的索引处的桶的所有节点，如果表太小(table.length小于64),就调整大小.这里其实是对hash表的一种优化,防止因为表长度太小而转换成树,造成性能浪费</span></span><br><span class=\"line\"><span class=\"comment\">* <span class=\"doctag\">@param</span> hash 用于确定桶的位置。</span></span><br><span class=\"line\"><span class=\"comment\">*/</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">final</span> <span class=\"keyword\">void</span> <span class=\"title\">treeifyBin</span><span class=\"params\">(HashMap.Node&lt;K, V&gt;[] tab, <span class=\"keyword\">int</span> hash)</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">int</span> n, index;</span><br><span class=\"line\">    <span class=\"comment\">// 链表的节点</span></span><br><span class=\"line\">    HashMap.Node&lt;K, V&gt; e;</span><br><span class=\"line\">    <span class=\"comment\">// 如果hash表为空或者hash表的长度小于最小化的树化容量(64)，这时会重调整大小。</span></span><br><span class=\"line\">    <span class=\"comment\">// 将容量扩大为原来的两倍。</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (tab == <span class=\"keyword\">null</span> || (n = tab.length) &lt; MIN_TREEIFY_CAPACITY) &#123;</span><br><span class=\"line\">        resize();</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> ((e = tab[index = (n - <span class=\"number\">1</span>) &amp; hash]) != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">        `HashMap.TreeNode&lt;K, V&gt; hd = <span class=\"keyword\">null</span>, tl = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">        <span class=\"keyword\">do</span> &#123;</span><br><span class=\"line\">            <span class=\"comment\">// 构建一个树的节点。</span></span><br><span class=\"line\">            HashMap.TreeNode&lt;K, V&gt; p = replacementTreeNode(e, <span class=\"keyword\">null</span>);</span><br><span class=\"line\">            <span class=\"comment\">// 如果尾为null,说明这个节点是该桶中的第一个元素，</span></span><br><span class=\"line\">            <span class=\"comment\">// 所以要将其赋于头节点。</span></span><br><span class=\"line\">            <span class=\"keyword\">if</span> (tl == <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">                hd = p;</span><br><span class=\"line\">            &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                <span class=\"comment\">// 将该节点放在尾节点后。</span></span><br><span class=\"line\">                p.prev = tl;</span><br><span class=\"line\">                tl.next = p;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"comment\">// 当前节点作为尾节点。</span></span><br><span class=\"line\">            tl = p;</span><br><span class=\"line\">        &#125; <span class=\"keyword\">while</span> ((e = e.next) != <span class=\"keyword\">null</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// 如果该桶中有元素，则进行树化。</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> ((tab[index] = hd) != <span class=\"keyword\">null</span>)&#123;</span><br><span class=\"line\">            hd.treeify(tab);</span><br><span class=\"line\">        &#125;`</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>其实呢，这个 <code>treeifyBin</code>  方法还是做了一些将桶树化的前置操作，然后将装有 <code>TreeNode</code>  节点的桶交给了 <code>treeify</code>  方法去真正的转换为一棵红黑树。那我们接下来看下 <code>treeify</code>  方法。注意这个方法定义在 <code>HashMap.TreeNode#treeify()</code></p>\n<h5 id=\"treeify方法\"><a class=\"markdownIt-Anchor\" href=\"#treeify方法\">#</a> treeify () 方法</h5>\n<figure class=\"highlight java\"><figcaption><span>&#123;.line-numbers&#125;</span></figcaption><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * Forms tree of the nodes linked from this node.</span></span><br><span class=\"line\"><span class=\"comment\"> * 把该节点连接的所有节点组成一棵树。(树化的过程)</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">final</span> <span class=\"keyword\">void</span> <span class=\"title\">treeify</span><span class=\"params\">(HashMap.Node&lt;K, V&gt;[] tab)</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"comment\">// 该棵树的根节点。</span></span><br><span class=\"line\">    HashMap.TreeNode&lt;K, V&gt; root = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">    <span class=\"comment\">// x是遍历的每个节点。</span></span><br><span class=\"line\">    <span class=\"keyword\">for</span> (HashMap.TreeNode&lt;K, V&gt; x = <span class=\"keyword\">this</span>, next; x != <span class=\"keyword\">null</span>; x = next) &#123;</span><br><span class=\"line\">        <span class=\"comment\">// 存下下一个节点。(指向下一个节点的指针)</span></span><br><span class=\"line\">        next = (HashMap.TreeNode&lt;K, V&gt;) x.next;</span><br><span class=\"line\">        x.left = x.right = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">        <span class=\"comment\">// 对根节点就行赋值(无父节点,黑色)</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (root == <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">            x.parent = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">            x.red = <span class=\"keyword\">false</span>;</span><br><span class=\"line\">            root = x;</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">            K k = x.key;</span><br><span class=\"line\">            <span class=\"keyword\">int</span> h = x.hash;</span><br><span class=\"line\">            Class&lt;?&gt; kc = <span class=\"keyword\">null</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"keyword\">for</span> (HashMap.TreeNode&lt;K, V&gt; p = root; ; ) &#123;</span><br><span class=\"line\">                <span class=\"comment\">// dir,负值和0为左子树，正值为右子树。</span></span><br><span class=\"line\">                <span class=\"keyword\">int</span> dir, ph;</span><br><span class=\"line\">                K pk = p.key;</span><br><span class=\"line\"></span><br><span class=\"line\">                <span class=\"comment\">/*************判断节点在左子树还是右子树 -start***************/</span></span><br><span class=\"line\">                <span class=\"comment\">// h为当前节点的hash值。</span></span><br><span class=\"line\">                <span class=\"comment\">// p是父节点, ph是父节点的hash值。</span></span><br><span class=\"line\">                <span class=\"keyword\">if</span> ((ph = p.hash) &gt; h) &#123;</span><br><span class=\"line\">                    <span class=\"comment\">// 放在左子树</span></span><br><span class=\"line\">                    dir = -<span class=\"number\">1</span>;</span><br><span class=\"line\">                &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (ph &lt; h) &#123;</span><br><span class=\"line\">                    <span class=\"comment\">// 放在又子树</span></span><br><span class=\"line\">                    dir = <span class=\"number\">1</span>;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">                <span class=\"comment\">//如果当前节点和父节点的hash值相等:</span></span><br><span class=\"line\">                <span class=\"comment\">//如果节点的key实现了Comparable, 或者 父节点和当前节点的key为一个。</span></span><br><span class=\"line\">                <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> ((kc == <span class=\"keyword\">null</span> &amp;&amp; (kc = comparableClassFor(k)) == <span class=\"keyword\">null</span>) ||</span><br><span class=\"line\">                        (dir = compareComparables(kc, k, pk)) == <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">                    <span class=\"comment\">// k是当前节点的key，pk是父节点的key</span></span><br><span class=\"line\">                    <span class=\"comment\">// 根据hashMap定义的规则,判断当前节点应该位于左子树还是右子树。</span></span><br><span class=\"line\">                    dir = tieBreakOrder(k, pk);</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">                <span class=\"comment\">/*************判断节点在左子树还是右子树 -end***************/</span></span><br><span class=\"line\"></span><br><span class=\"line\">                HashMap.TreeNode&lt;K, V&gt; xp = p;</span><br><span class=\"line\">                <span class=\"comment\">// p==null,代表着遍历到了叶子节点。</span></span><br><span class=\"line\">                <span class=\"keyword\">if</span> ((p = (dir &lt;= <span class=\"number\">0</span>) ? p.left : p.right) == <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">                    <span class=\"comment\">// xp是当前节点的父节点。</span></span><br><span class=\"line\">                    x.parent = xp;</span><br><span class=\"line\">                    <span class=\"keyword\">if</span> (dir &lt;= <span class=\"number\">0</span>)&#123;</span><br><span class=\"line\">                        xp.left = x;</span><br><span class=\"line\">                    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                        xp.right = x;</span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\">                    <span class=\"comment\">// 平衡插入的红黑树(完成插入后，红黑树的性质可能被破坏,这里进行重新平衡)</span></span><br><span class=\"line\">                    root = balanceInsertion(root, x);</span><br><span class=\"line\">                    <span class=\"keyword\">break</span>;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"comment\">//确保红黑树的根节点是桶的第一个节点。</span></span><br><span class=\"line\">    moveRootToFront(tab, root);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>在这里呢，有 3 个方法没有仔细去说明，分别是 tieBreakOrder (),balanceInsertion () 和 moveRootToFront (tab, root), 注意，这三个方法在下面的 PutTreeVal 中也有调用。当然包括调整平衡的左旋 (rotateLeft), 右旋 (rotateRight) 方法。我们接着往下看吧。</p>\n<h5 id=\"balanceinsertion方法\"><a class=\"markdownIt-Anchor\" href=\"#balanceinsertion方法\">#</a> balanceInsertion 方法</h5>\n<p>在说这个方法之前，先总结下红黑树变换的 5 条规则。</p>\n<ul>\n<li>规则 1: 红黑树为空树 ==&gt; {<mark>直接插入当前节点，节点涂为黑色。</mark>}</li>\n<li>规则 2: 插入节点的父节点是黑色 ==&gt; {<mark>直接插入当前节点.</mark>}</li>\n<li>规则 3: 当前节点的父节点是红色，并且叔叔节点是红色。==&gt; {<mark>父节点涂黑，叔叔节点涂黑，祖父节点涂红.</mark>}</li>\n<li>规则 4: 当前节点的父节点是红色，叔叔是黑色，当前节点是父节点的右子树. ==&gt; {<mark>当前节点的父节点作为新的当前节点，以新的当前节点左旋。</mark>}</li>\n<li>规则 5: 当前节点的父节点是红色，叔叔节点是黑色，当前节点是父节点的左子树. ==&gt; {<mark>父节点变为黑色，祖父节点变为红色，以祖父节点为支点右旋.</mark>}<br>\n 下面结合代码看 HashMap 是怎么实现上面这个 5 个规则的:</li>\n</ul>\n<figure class=\"highlight java\"><figcaption><span>&#123;.line-numbers&#125;</span></figcaption><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * 调整红黑树</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@param</span> root 根节点</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@param</span> x 当前节点</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"keyword\">static</span> &lt;K, V&gt; HashMap.<span class=\"function\">TreeNode&lt;K, V&gt; <span class=\"title\">balanceInsertion</span><span class=\"params\">(HashMap.TreeNode&lt;K, V&gt; root,</span></span></span><br><span class=\"line\"><span class=\"params\"><span class=\"function\">                                                        HashMap.TreeNode&lt;K, V&gt; x)</span> </span>&#123;</span><br><span class=\"line\">    x.red = <span class=\"keyword\">true</span>;</span><br><span class=\"line\">    <span class=\"comment\">// xp: 当前节点的父节点(父节点)</span></span><br><span class=\"line\">    <span class=\"comment\">// xpp: 当前节点的父节点的父节点(祖父节点)</span></span><br><span class=\"line\">    <span class=\"comment\">// xppl: 当前节点的父节点的父节点的左子树(叔叔节点)</span></span><br><span class=\"line\">    <span class=\"comment\">// xppr: 当前节点的父节点的父节点的右子树(叔叔节点)</span></span><br><span class=\"line\">    <span class=\"keyword\">for</span> (HashMap.TreeNode&lt;K, V&gt; xp, xpp, xppl, xppr; ; ) &#123;</span><br><span class=\"line\">        <span class=\"comment\">// 规则1</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> ((xp = x.parent) == <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">            x.red = <span class=\"keyword\">false</span>;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> x;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"comment\">// 父节点为黑色 或者祖父节点为空==&gt;规则2</span></span><br><span class=\"line\">        <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (!xp.red || (xpp = xp.parent) == <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> root;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// 父节点是左子树</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (xp == (xppl = xpp.left)) &#123;</span><br><span class=\"line\">            <span class=\"comment\">// 父节点是左子树,且祖父节点存在右子树(叔叔节点为右子树)，并且叔叔为红色。 ==&gt; 父节点是右子树时的性质1.</span></span><br><span class=\"line\">            <span class=\"keyword\">if</span> ((xppr = xpp.right) != <span class=\"keyword\">null</span> &amp;&amp; xppr.red) &#123;</span><br><span class=\"line\">                <span class=\"comment\">// 叔叔节点涂黑</span></span><br><span class=\"line\">                xppr.red = <span class=\"keyword\">false</span>;</span><br><span class=\"line\">                <span class=\"comment\">// 父节点涂黑</span></span><br><span class=\"line\">                xp.red = <span class=\"keyword\">false</span>;</span><br><span class=\"line\">                <span class=\"comment\">// 祖父节点涂红</span></span><br><span class=\"line\">                xpp.red = <span class=\"keyword\">true</span>;</span><br><span class=\"line\">                <span class=\"comment\">// 以祖父节点为新的当前节点</span></span><br><span class=\"line\">                x = xpp;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"comment\">// 祖父节点没有右子树或者有右子树,颜色为黑色。</span></span><br><span class=\"line\">            <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                <span class=\"comment\">// 当前节点是父节点的右子树==&gt; 规则4</span></span><br><span class=\"line\">                <span class=\"keyword\">if</span> (x == xp.right) &#123;</span><br><span class=\"line\">                    <span class=\"comment\">// 左旋</span></span><br><span class=\"line\">                    root = rotateLeft(root, x = xp);</span><br><span class=\"line\">                    <span class=\"comment\">// 设置祖父节点要么为空要么是父节点。</span></span><br><span class=\"line\">                    xpp = (xp = x.parent) == <span class=\"keyword\">null</span> ? <span class=\"keyword\">null</span> : xp.parent;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">                <span class=\"comment\">// 规则5</span></span><br><span class=\"line\">                <span class=\"keyword\">if</span> (xp != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">                    <span class=\"comment\">// 父节点涂成黑色</span></span><br><span class=\"line\">                    <span class=\"comment\">// 此时xp可能为root.</span></span><br><span class=\"line\">                    xp.red = <span class=\"keyword\">false</span>;</span><br><span class=\"line\">                    <span class=\"comment\">// 如果xp不是root的时候。</span></span><br><span class=\"line\">                    <span class=\"keyword\">if</span> (xpp != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">                        <span class=\"comment\">// 祖父节点涂成红色,右旋。</span></span><br><span class=\"line\">                        xpp.red = <span class=\"keyword\">true</span>;</span><br><span class=\"line\">                        root = rotateRight(root, xpp);</span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// 父节点不是左子树==&gt; 父节点是右子树。</span></span><br><span class=\"line\">        <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">            <span class=\"comment\">// 叔叔节点(祖父节点的左子树),叔叔为红色 ==&gt; 规则3</span></span><br><span class=\"line\">            <span class=\"keyword\">if</span> (xppl != <span class=\"keyword\">null</span> &amp;&amp; xppl.red) &#123;</span><br><span class=\"line\">                    <span class=\"comment\">// 叔叔涂黑</span></span><br><span class=\"line\">                xppl.red = <span class=\"keyword\">false</span>;</span><br><span class=\"line\">                <span class=\"comment\">// 父节点涂黑</span></span><br><span class=\"line\">                xp.red = <span class=\"keyword\">false</span>;</span><br><span class=\"line\">                <span class=\"comment\">// 祖父节点涂红</span></span><br><span class=\"line\">                xpp.red = <span class=\"keyword\">true</span>;</span><br><span class=\"line\">                <span class=\"comment\">// 以祖父节点为新的当前节点</span></span><br><span class=\"line\">                x = xpp;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"comment\">// 祖父节点没有右子树或者有右子树,颜色为黑色。 ==&gt; 规则4</span></span><br><span class=\"line\">            <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                <span class=\"comment\">// 当前节点是左子树</span></span><br><span class=\"line\">                <span class=\"keyword\">if</span> (x == xp.left) &#123;</span><br><span class=\"line\">                    <span class=\"comment\">// 右旋</span></span><br><span class=\"line\">                    root = rotateRight(root, x = xp);</span><br><span class=\"line\">                    <span class=\"comment\">// 设置祖父节点要么为空要么是父节点。</span></span><br><span class=\"line\">                    xpp = (xp = x.parent) == <span class=\"keyword\">null</span> ? <span class=\"keyword\">null</span> : xp.parent;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">                <span class=\"comment\">// ==&gt; 规则5</span></span><br><span class=\"line\">                <span class=\"keyword\">if</span> (xp != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">                    xp.red = <span class=\"keyword\">false</span>;</span><br><span class=\"line\">                    <span class=\"comment\">// 如果有祖父</span></span><br><span class=\"line\">                    <span class=\"keyword\">if</span> (xpp != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">                        <span class=\"comment\">// 祖父节点涂成红色,右旋。</span></span><br><span class=\"line\">                        xpp.red = <span class=\"keyword\">true</span>;</span><br><span class=\"line\">                        root = rotateLeft(root, xpp);</span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h5 id=\"rotateleft-左旋\"><a class=\"markdownIt-Anchor\" href=\"#rotateleft-左旋\">#</a> rotateLeft 左旋</h5>\n<p>这里的代码不能用语言描述，真的是只能意会不能言传啊。</p>\n<figure class=\"highlight java\"><figcaption><span>&#123;.line-numbers&#125;</span></figcaption><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">static</span> &lt;K, V&gt; HashMap.<span class=\"function\">TreeNode&lt;K, V&gt; <span class=\"title\">rotateLeft2</span><span class=\"params\">(HashMap.TreeNode&lt;K, V&gt; root, HashMap.TreeNode&lt;K, V&gt; p)</span> </span>&#123;</span><br><span class=\"line\">            HashMap.TreeNode&lt;K, V&gt; r, pp, rl;</span><br><span class=\"line\">            <span class=\"comment\">// p是父节点</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (p != <span class=\"keyword\">null</span> &amp;&amp; p.right != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">        <span class=\"comment\">// 右孩子</span></span><br><span class=\"line\">        r = p.right;</span><br><span class=\"line\">        <span class=\"comment\">// 右孩子有左孩子的话.</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (r.left != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">            <span class=\"comment\">// 右孩子变成右孩子的左孩子。即rl变成了p的右孩子。</span></span><br><span class=\"line\">            p.right = r.left;</span><br><span class=\"line\">            rl = r.left;</span><br><span class=\"line\">            rl.parent = p;</span><br><span class=\"line\">            <span class=\"comment\">// 注意此时r没有关联。</span></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        pp = p.parent;</span><br><span class=\"line\">        <span class=\"comment\">// 如果p没有有父节点的话。</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (p.parent == <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">            <span class=\"comment\">// 将r的父节点置为null</span></span><br><span class=\"line\">            r.parent = p.parent;</span><br><span class=\"line\">            <span class=\"comment\">// 颜色涂成黑色，并且r就是根节点。</span></span><br><span class=\"line\">            (root = r).red = <span class=\"keyword\">false</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"comment\">//  如果p节点有父节点，并且p是左子树的话</span></span><br><span class=\"line\">        <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (pp.left == p) &#123;</span><br><span class=\"line\">            <span class=\"comment\">// 将祖父节点的左子树置为r,</span></span><br><span class=\"line\">            pp.left = r;</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">            <span class=\"comment\">// 将祖父节点的右子树置为r,</span></span><br><span class=\"line\">            pp.right = r;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"comment\">// 将r和p连接起来。</span></span><br><span class=\"line\">        r.left = p;</span><br><span class=\"line\">        p.parent = r;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> root;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>注意下，这里的代码是我修改之后，JDK 的源码看起来很精简，理解起来，啧啧啧。</p>\n<p>MD, 来张图:</p>\n<p><img data-src=\"/images/JavaSourceCode/HashMap/HashMap07-%E5%B7%A6%E6%97%8B%E7%9A%84%E8%BF%87%E7%A8%8B.png\" alt=\"HashMap07-左旋的过程.md\"></p>\n<p>这里假设右孩子是有左孩子的。如果没有的话，那就直接去掉绿色的 rl 就好了。</p>\n<h5 id=\"rotateright\"><a class=\"markdownIt-Anchor\" href=\"#rotateright\">#</a> rotateRight</h5>\n<p>右旋的过程同理:</p>\n<figure class=\"highlight java\"><figcaption><span>&#123;,.line-numbers&#125;</span></figcaption><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">static</span> &lt;K, V&gt; HashMap.<span class=\"function\">TreeNode&lt;K, V&gt; <span class=\"title\">rotateRight</span><span class=\"params\">(HashMap.TreeNode&lt;K, V&gt; root,</span></span></span><br><span class=\"line\"><span class=\"params\"><span class=\"function\">                                                         HashMap.TreeNode&lt;K, V&gt; p)</span> </span>&#123;</span><br><span class=\"line\">    HashMap.TreeNode&lt;K, V&gt; l, pp, lr;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (p != <span class=\"keyword\">null</span> &amp;&amp; (l = p.left) != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> ((lr = p.left = l.right) != <span class=\"keyword\">null</span>)</span><br><span class=\"line\">            lr.parent = p;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> ((pp = l.parent = p.parent) == <span class=\"keyword\">null</span>)</span><br><span class=\"line\">            (root = l).red = <span class=\"keyword\">false</span>;</span><br><span class=\"line\">        <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (pp.right == p)</span><br><span class=\"line\">            pp.right = l;</span><br><span class=\"line\">        <span class=\"keyword\">else</span></span><br><span class=\"line\">            pp.left = l;</span><br><span class=\"line\">        l.right = p;</span><br><span class=\"line\">        p.parent = l;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> root;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>这图啊，有空再做吧。今天太累了。</p>\n<p>还有一个方法:</p>\n<h5 id=\"moveroottofront\"><a class=\"markdownIt-Anchor\" href=\"#moveroottofront\">#</a> moveRootToFront</h5>\n<figure class=\"highlight java\"><figcaption><span>&#123;.line-numbers&#125;</span></figcaption><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"> <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">  * Ensures that the given root is the first node of its bin.</span></span><br><span class=\"line\"><span class=\"comment\">  * // 确保红黑树的根节点是桶的第一个节点。</span></span><br><span class=\"line\"><span class=\"comment\">  * 为什么不直接将tab[index]==root? 是为了树重新转换成链表的时候使用的。</span></span><br><span class=\"line\"><span class=\"comment\">  */</span></span><br><span class=\"line\"><span class=\"keyword\">static</span> &lt;K, V&gt; <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">moveRootToFront</span><span class=\"params\">(HashMap.Node&lt;K, V&gt;[] tab, HashMap.TreeNode&lt;K, V&gt; root)</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">int</span> n;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (root != <span class=\"keyword\">null</span> &amp;&amp; tab != <span class=\"keyword\">null</span> &amp;&amp; (n = tab.length) &gt; <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">int</span> index = (n - <span class=\"number\">1</span>) &amp; root.hash;</span><br><span class=\"line\">        HashMap.TreeNode&lt;K, V&gt; first = (HashMap.TreeNode&lt;K, V&gt;) tab[index];</span><br><span class=\"line\">        <span class=\"comment\">// 判断第一个节点和root是不是相等的,判断的是地址。</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (root != first) &#123;</span><br><span class=\"line\">            HashMap.Node&lt;K, V&gt; rn;</span><br><span class=\"line\">            tab[index] = root;</span><br><span class=\"line\">            HashMap.TreeNode&lt;K, V&gt; rp = root.prev;</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"keyword\">if</span> ((rn = root.next) != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">                <span class=\"comment\">// root的后一个节点的指向前的指针指向root的前一个节点。</span></span><br><span class=\"line\">                ((HashMap.TreeNode&lt;K, V&gt;) rn).prev = rp;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"keyword\">if</span> (rp != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">                <span class=\"comment\">// root的前一个节点的指向后的指针指向root的后一个节点。</span></span><br><span class=\"line\">                rp.next = rn;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"keyword\">if</span> (first != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">                <span class=\"comment\">// 第一个元素的前指针指向root</span></span><br><span class=\"line\">                first.prev = root;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"comment\">// root的后向指针指向first</span></span><br><span class=\"line\">            root.next = first;</span><br><span class=\"line\">            <span class=\"comment\">// root的前向指针置为null</span></span><br><span class=\"line\">            root.prev = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"comment\">// 递归不变检查</span></span><br><span class=\"line\">        <span class=\"function\"><span class=\"keyword\">assert</span> <span class=\"title\">checkInvariants</span><span class=\"params\">(root)</span></span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h4 id=\"puttreenode\"><a class=\"markdownIt-Anchor\" href=\"#puttreenode\">#</a> putTreeNode</h4>\n<figure class=\"highlight java\"><figcaption><span>&#123;./line-bumbers&#125;</span></figcaption><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">final</span> HashMap.<span class=\"function\">TreeNode&lt;K, V&gt; <span class=\"title\">putTreeVal</span><span class=\"params\">(HashMap&lt;K, V&gt; map, HashMap.Node&lt;K, V&gt;[] tab,</span></span></span><br><span class=\"line\"><span class=\"params\"><span class=\"function\">                                                <span class=\"keyword\">int</span> h, K k, V v)</span> </span>&#123;</span><br><span class=\"line\">    Class&lt;?&gt; kc = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">    <span class=\"keyword\">boolean</span> searched = <span class=\"keyword\">false</span>;</span><br><span class=\"line\">    HashMap.TreeNode&lt;K, V&gt; root = (parent != <span class=\"keyword\">null</span>) ? root() : <span class=\"keyword\">this</span>;</span><br><span class=\"line\">    <span class=\"keyword\">for</span> (HashMap.TreeNode&lt;K, V&gt; p = root; ; ) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">int</span> dir, ph;</span><br><span class=\"line\">        K pk;</span><br><span class=\"line\">        <span class=\"comment\">/***************判断 左右子树 ******************/</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> ((ph = p.hash) &gt; h) &#123;</span><br><span class=\"line\">            dir = -<span class=\"number\">1</span>;</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (ph &lt; h) &#123;</span><br><span class=\"line\">            dir = <span class=\"number\">1</span>;</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> ((pk = p.key) == k || (k != <span class=\"keyword\">null</span> &amp;&amp; k.equals(pk))) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> p;</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> ((kc == <span class=\"keyword\">null</span> &amp;&amp;</span><br><span class=\"line\">                (kc = comparableClassFor(k)) == <span class=\"keyword\">null</span>) ||</span><br><span class=\"line\">                (dir = compareComparables(kc, k, pk)) == <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (!searched) &#123;</span><br><span class=\"line\">                HashMap.TreeNode&lt;K, V&gt; q, ch;</span><br><span class=\"line\">                searched = <span class=\"keyword\">true</span>;</span><br><span class=\"line\">                <span class=\"keyword\">if</span> (((ch = p.left) != <span class=\"keyword\">null</span> &amp;&amp;</span><br><span class=\"line\">                        (q = ch.find(h, k, kc)) != <span class=\"keyword\">null</span>) ||</span><br><span class=\"line\">                        ((ch = p.right) != <span class=\"keyword\">null</span> &amp;&amp;</span><br><span class=\"line\">                                (q = ch.find(h, k, kc)) != <span class=\"keyword\">null</span>))</span><br><span class=\"line\">                    <span class=\"keyword\">return</span> q;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            dir = tieBreakOrder(k, pk);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">/***************判断 左右子树 end******************/</span></span><br><span class=\"line\"></span><br><span class=\"line\">        HashMap.TreeNode&lt;K, V&gt; xp = p;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> ((p = (dir &lt;= <span class=\"number\">0</span>) ? p.left : p.right) == <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">            HashMap.Node&lt;K, V&gt; xpn = xp.next;</span><br><span class=\"line\">            HashMap.TreeNode&lt;K, V&gt; x = map.newTreeNode(h, k, v, xpn);</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (dir &lt;= <span class=\"number\">0</span>)</span><br><span class=\"line\">                xp.left = x;</span><br><span class=\"line\">            <span class=\"keyword\">else</span></span><br><span class=\"line\">                xp.right = x;</span><br><span class=\"line\">            xp.next = x;</span><br><span class=\"line\">            x.parent = x.prev = xp;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (xpn != <span class=\"keyword\">null</span>)</span><br><span class=\"line\">                ((HashMap.TreeNode&lt;K, V&gt;) xpn).prev = x;</span><br><span class=\"line\">            <span class=\"comment\">// 这里比较重要了，不过我们在treeify中已经说过了。</span></span><br><span class=\"line\">            moveRootToFront(tab, balanceInsertion(root, x));</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"keyword\">null</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>这样，HashMap 的新增过程我们就处理完了。</p>\n<h3 id=\"hashmap删除方法-hashmapremove\"><a class=\"markdownIt-Anchor\" href=\"#hashmap删除方法-hashmapremove\">#</a> HashMap 删除方法 HashMap#remove ()</h3>\n<figure class=\"highlight java\"><figcaption><span>&#123;.line-numbers&#125;</span></figcaption><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * 从map中删除指定的key,如果key存在的话</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@param</span> key key whose mapping is to be removed from the map</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@return</span> value 如果key存在,返回key对应的Value,如果不存在返回null</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> V <span class=\"title\">remove</span><span class=\"params\">(Object key)</span> </span>&#123;</span><br><span class=\"line\">    HashMap.Node&lt;K, V&gt; e;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> (e = removeNode(hash(key), key, <span class=\"keyword\">null</span>, <span class=\"keyword\">false</span>, <span class=\"keyword\">true</span>)) == <span class=\"keyword\">null</span> ?</span><br><span class=\"line\">            <span class=\"keyword\">null</span> : e.value;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>其中计算 hash 值的方法还是和之前的一样。</p>\n<h4 id=\"removenode\"><a class=\"markdownIt-Anchor\" href=\"#removenode\">#</a> removeNode</h4>\n<figure class=\"highlight java\"><figcaption><span>&#123;.line-numbers&#125;</span></figcaption><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * Implements Map.remove and related methods.</span></span><br><span class=\"line\"><span class=\"comment\"> * 实现Map.remove相关的方法</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@param</span> hash       hashCode</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@param</span> key       key</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@param</span> value     value</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@param</span> matchValue 如果是true，仅在value相等的时候删除。</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@param</span> movable   如果为false，则在删除节点的时候不移动其他节点。</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@return</span> 返回删除的节点</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"keyword\">final</span> HashMap.<span class=\"function\">Node&lt;K, V&gt; <span class=\"title\">removeNode</span><span class=\"params\">(<span class=\"keyword\">int</span> hash, Object key, Object value,</span></span></span><br><span class=\"line\"><span class=\"params\"><span class=\"function\">                                    <span class=\"keyword\">boolean</span> matchValue, <span class=\"keyword\">boolean</span> movable)</span> </span>&#123;</span><br><span class=\"line\">    HashMap.Node&lt;K, V&gt;[] tab;</span><br><span class=\"line\">    HashMap.Node&lt;K, V&gt; p;</span><br><span class=\"line\">    <span class=\"keyword\">int</span> n, index;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ((tab = table) != <span class=\"keyword\">null</span> &amp;&amp; (n = tab.length) &gt; <span class=\"number\">0</span> &amp;&amp;</span><br><span class=\"line\">            (p = tab[index = (n - <span class=\"number\">1</span>) &amp; hash]) != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">        HashMap.Node&lt;K, V&gt; node = <span class=\"keyword\">null</span>, e;</span><br><span class=\"line\">        K k;</span><br><span class=\"line\">        V v;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (p.hash == hash &amp;&amp;</span><br><span class=\"line\">                ((k = p.key) == key || (key != <span class=\"keyword\">null</span> &amp;&amp; key.equals(k))))</span><br><span class=\"line\">            node = p;</span><br><span class=\"line\">        <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> ((e = p.next) != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (p <span class=\"keyword\">instanceof</span> HashMap.TreeNode) &#123;</span><br><span class=\"line\">                <span class=\"comment\">// 找到红黑树中的节点</span></span><br><span class=\"line\">                node = ((HashMap.TreeNode&lt;K, V&gt;) p).getTreeNode(hash, key);</span><br><span class=\"line\">            &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                <span class=\"comment\">// 删除链表中的节点1: 查找到节点的位置。</span></span><br><span class=\"line\">                <span class=\"keyword\">do</span> &#123;</span><br><span class=\"line\">                    <span class=\"keyword\">if</span> (e.hash == hash &amp;&amp;</span><br><span class=\"line\">                            ((k = e.key) == key ||</span><br><span class=\"line\">                                    (key != <span class=\"keyword\">null</span> &amp;&amp; key.equals(k)))) &#123;</span><br><span class=\"line\">                        node = e;</span><br><span class=\"line\">                        <span class=\"keyword\">break</span>;</span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\">                    p = e;</span><br><span class=\"line\">                &#125; <span class=\"keyword\">while</span> ((e = e.next) != <span class=\"keyword\">null</span>);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"comment\">// 真正的去删除的过程。</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (node != <span class=\"keyword\">null</span> &amp;&amp; (!matchValue || (v = node.value) == value ||</span><br><span class=\"line\">                (value != <span class=\"keyword\">null</span> &amp;&amp; value.equals(v)))) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (node <span class=\"keyword\">instanceof</span> HashMap.TreeNode) &#123;</span><br><span class=\"line\">                <span class=\"comment\">// 删除红黑树的节点</span></span><br><span class=\"line\">                ((HashMap.TreeNode&lt;K, V&gt;) node).removeTreeNode(<span class=\"keyword\">this</span>, tab, movable);</span><br><span class=\"line\">            &#125;<span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (node == p) &#123;</span><br><span class=\"line\">                <span class=\"comment\">// 桶中只有当前的节点。</span></span><br><span class=\"line\">                tab[index] = node.next;</span><br><span class=\"line\">            &#125;<span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                <span class=\"comment\">// 链表中节点的删除</span></span><br><span class=\"line\">                p.next = node.next;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"comment\">// 修改次数+1</span></span><br><span class=\"line\">            ++modCount;</span><br><span class=\"line\">            --size;</span><br><span class=\"line\">            afterNodeRemoval(node);</span><br><span class=\"line\">            <span class=\"keyword\">return</span> node;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"keyword\">null</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>还有一个最难理解的方法落在了红黑树的移除上了。</p>\n<h4 id=\"hashmaptreenoderemovetreenode\"><a class=\"markdownIt-Anchor\" href=\"#hashmaptreenoderemovetreenode\">#</a> HashMap#TreeNode#removeTreeNode</h4>\n<p>还是先看下红黑树的删除是怎么回事。</p>\n<p>在删除方法调用之前必须要有存在的给定节点。<br>\n这比典型的红黑删除代码更混乱，因为我们不能将内部节点的内容与叶子后继交换，后者由遍历期间可独立访问的 “下一个” 指针固定。 所以我们交换树链接。 如果当前树似乎有太少的节点，则红黑树 (bin) 将转换回普通的链表 (普通 bin). （测试会在 2 到 6 个节点之间触发，具体取决于树结构）。<br>\n上面是 removeTreeNode 方法的解释。说实话，没理解…</p>\n<p>HashMap 的删除不同于普通的红黑树的删除，因为它其中还维护了，一个链表的指向. HashMap 采用的是将树中的两个节点进行换位，颜色也要进行互换，来保证红黑树的平衡，并不改变二者在链表中的位置，互换后，删除节点此时的左子树是空的，将问题转换成了对左子树为空的节点的删除。</p>\n<p>有一个简单的问题，千万不要弄混了，就是 TreeNode 中要删除的节点是谁？？</p>\n<p>删除的签名是这样的: <code> final void removeTreeNode(HashMap&lt;K, V&gt; map, HashMap.Node&lt;K, V&gt;[] tab,boolean movable)</code> , 并没有传 TreeNode 啊？是不是？？</p>\n<p>干吗呢！大兄嘚。要删除的节点是：this 啊。我们现在走到了 TreeNode 内部了！！它本身就是要被删除的节点啊。</p>\n<p>好了，那我现在要告诉你：删除自己！</p>\n<p>HashMap 删除红黑树的节点，实际上就是 TreeNode 自己删除自己。那么它是怎么删的呢？</p>\n<p>它分成了三步:</p>\n<ul>\n<li>1. 将删除节点从双链向链表中删除.</li>\n<li>2. 将删除节点与其右子树最小节点互换，之后平衡树</li>\n<li>3. 将树根节点，移动到 <code>tab[index]</code>  指针处</li>\n</ul>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">final</span> <span class=\"keyword\">void</span> <span class=\"title\">removeTreeNode</span><span class=\"params\">(HashMap&lt;K, V&gt; map, HashMap.Node&lt;K, V&gt;[] tab,</span></span></span><br><span class=\"line\"><span class=\"params\"><span class=\"function\">                                  <span class=\"keyword\">boolean</span> movable)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"comment\">// 注意了： 这个时候被删除的节点是谁??</span></span><br><span class=\"line\">        <span class=\"comment\">// 是this.</span></span><br><span class=\"line\">        <span class=\"keyword\">int</span> n;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (tab == <span class=\"keyword\">null</span> || (n = tab.length) == <span class=\"number\">0</span>)</span><br><span class=\"line\">            <span class=\"keyword\">return</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// 找到对应的索引(确定对应桶的位置), n 是当前表的长度</span></span><br><span class=\"line\">        <span class=\"keyword\">int</span> index = (n - <span class=\"number\">1</span>) &amp; hash;</span><br><span class=\"line\">        <span class=\"comment\">// first: 第一个树节点(当前为父节点),root，父节点。rl:</span></span><br><span class=\"line\">        HashMap.TreeNode&lt;K, V&gt; first = (HashMap.TreeNode&lt;K, V&gt;) tab[index], root = first, rl;</span><br><span class=\"line\">        <span class=\"comment\">// succ:下一个节点(链表的指向)。pred, 前一个节点。</span></span><br><span class=\"line\">        HashMap.TreeNode&lt;K, V&gt; succ = (HashMap.TreeNode&lt;K, V&gt;) next, pred = prev;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (pred == <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">            <span class=\"comment\">// 前一个为空时，即当前接是父节点:(被删除的节点是根节点)</span></span><br><span class=\"line\">            tab[index] = first = succ;</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">            <span class=\"comment\">// 否测,前一个节点的下一个执行当前节点的下一个。(意会)</span></span><br><span class=\"line\">            pred.next = succ;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (succ != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">            <span class=\"comment\">// 当前节点的后节点不为null,后一个节点的前节点指向当前节点的前节点(意会)</span></span><br><span class=\"line\">            succ.prev = pred;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (first == <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">            <span class=\"comment\">// 如果删除当前节点，该桶变成了null的。就直接返回</span></span><br><span class=\"line\">            <span class=\"keyword\">return</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (root.parent != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">            <span class=\"comment\">// 重置table[index]处为树的根节点。</span></span><br><span class=\"line\">            root = root.root();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// PS: 说点没用， JDK除了部分ifelse不加括号之外，</span></span><br><span class=\"line\">        <span class=\"comment\">// 其实换行，还是用的挺多的，看起来也挺舒服的。</span></span><br><span class=\"line\">        <span class=\"comment\">// 值得借鉴</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (root == <span class=\"keyword\">null</span></span><br><span class=\"line\">                || (movable &amp;&amp; (root.right == <span class=\"keyword\">null</span></span><br><span class=\"line\">                || (rl = root.left) == <span class=\"keyword\">null</span></span><br><span class=\"line\">                || rl.left == <span class=\"keyword\">null</span>))) &#123;</span><br><span class=\"line\">            <span class=\"comment\">// 树太小了，将树转换成链表</span></span><br><span class=\"line\">            tab[index] = first.untreeify(map);  <span class=\"comment\">// too small</span></span><br><span class=\"line\">            <span class=\"keyword\">return</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"comment\">/*****注意！！！ 此时已经从双向链表中删除了, 第一步走完。******/</span></span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// p是待删除的节点，pl当前节点的左孩子节点,pr当前节点的右孩子节点,replacement,用来交换的节点。</span></span><br><span class=\"line\">        HashMap.TreeNode&lt;K, V&gt; p = <span class=\"keyword\">this</span>, pl = left, pr = right, replacement;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (pl != <span class=\"keyword\">null</span> &amp;&amp; pr != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"comment\">// s为右子树的最小的节点,sl为左子树(一下五行和源码略有不同)</span></span><br><span class=\"line\">            HashMap.TreeNode&lt;K, V&gt; s = pr, sl = s.left;</span><br><span class=\"line\">            <span class=\"keyword\">while</span> (sl != <span class=\"keyword\">null</span>) &#123; <span class=\"comment\">// find successor</span></span><br><span class=\"line\">                s = sl;</span><br><span class=\"line\">                sl = s.left;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"comment\">// 交换颜色</span></span><br><span class=\"line\">            <span class=\"keyword\">boolean</span> c = s.red;</span><br><span class=\"line\">            s.red = p.red;</span><br><span class=\"line\">            p.red = c; <span class=\"comment\">// swap colors</span></span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"comment\">// 交换节点连接</span></span><br><span class=\"line\">            HashMap.TreeNode&lt;K, V&gt; sr = s.right;</span><br><span class=\"line\">            HashMap.TreeNode&lt;K, V&gt; pp = p.parent;</span><br><span class=\"line\">            <span class=\"comment\">// pr是当前节点的右孩子节点</span></span><br><span class=\"line\">            <span class=\"comment\">// s是当前节点的右子树的最小的节点</span></span><br><span class=\"line\">            <span class=\"comment\">// p的右子树,只有s这一个节点</span></span><br><span class=\"line\">            <span class=\"keyword\">if</span> (s == pr) &#123; <span class=\"comment\">// p was s&#x27;s direct parent</span></span><br><span class=\"line\">                p.parent = s;</span><br><span class=\"line\">                s.right = p;</span><br><span class=\"line\">            &#125; <span class=\"keyword\">else</span> &#123; <span class=\"comment\">//</span></span><br><span class=\"line\">                <span class=\"comment\">// sp： 最小节点的父节点</span></span><br><span class=\"line\">                HashMap.TreeNode&lt;K, V&gt; sp = s.parent;</span><br><span class=\"line\">                <span class=\"keyword\">if</span> ((p.parent = sp) != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">                    <span class=\"keyword\">if</span> (s == sp.left)</span><br><span class=\"line\">                        sp.left = p;</span><br><span class=\"line\">                    <span class=\"keyword\">else</span></span><br><span class=\"line\">                        sp.right = p;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">                <span class=\"keyword\">if</span> ((s.right = pr) != <span class=\"keyword\">null</span>)</span><br><span class=\"line\">                    pr.parent = s;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"comment\">// 置null孩子。</span></span><br><span class=\"line\">            p.left = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> ((p.right = sr) != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">                sr.parent = p;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> ((s.left = pl) != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">                pl.parent = s;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> ((s.parent = pp) == <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">                root = s;</span><br><span class=\"line\">            &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (p == pp.left) &#123;</span><br><span class=\"line\">                pp.left = s;</span><br><span class=\"line\">            &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                pp.right = s;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"comment\">// 确定要交换的节点完毕，交换节点</span></span><br><span class=\"line\">            <span class=\"keyword\">if</span> (sr != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">                replacement = sr;</span><br><span class=\"line\">            &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                replacement = p;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (pl != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">            <span class=\"comment\">// 当前树只含有左子树</span></span><br><span class=\"line\">            replacement = pl;</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (pr != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">            <span class=\"comment\">// 当前树，只有又子树</span></span><br><span class=\"line\">            replacement = pr;</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">            <span class=\"comment\">// 无孩子</span></span><br><span class=\"line\">            replacement = p;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (replacement != p) &#123;</span><br><span class=\"line\">            HashMap.TreeNode&lt;K, V&gt; pp = replacement.parent = p.parent;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (pp == <span class=\"keyword\">null</span>)</span><br><span class=\"line\">                root = replacement;</span><br><span class=\"line\">            <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (p == pp.left)</span><br><span class=\"line\">                pp.left = replacement;</span><br><span class=\"line\">            <span class=\"keyword\">else</span></span><br><span class=\"line\">                pp.right = replacement;</span><br><span class=\"line\">            p.left = p.right = p.parent = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// 是否要进行重平衡树?</span></span><br><span class=\"line\">        HashMap.TreeNode&lt;K, V&gt; r = p.red ? root : balanceDeletion(root, replacement);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// 在平衡后删除该节点</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (replacement == p) &#123;  <span class=\"comment\">// detach</span></span><br><span class=\"line\">            HashMap.TreeNode&lt;K, V&gt; pp = p.parent;</span><br><span class=\"line\">            p.parent = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (pp != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">                <span class=\"keyword\">if</span> (p == pp.left)</span><br><span class=\"line\">                    pp.left = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">                <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (p == pp.right)</span><br><span class=\"line\">                    pp.right = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"comment\">// 参数moveable控制是否删除节点后确保树的根节点为链表的头节点</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (movable) &#123;</span><br><span class=\"line\">            <span class=\"comment\">// 将树根节点，移动到tab[index]指针处</span></span><br><span class=\"line\">            moveRootToFront(tab, r);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br></pre></td></tr></table></figure>\n<p>这样呢，整个删除过程就完成了。<br>\n用官方中的话，比较混乱。尤其是涉及到红黑树的删除，这部分内容。还是需要好好消化，消化的。</p>\n<p>下面我们还剩下两个内容：修改和查找</p>\n<h3 id=\"hashmap的查找方法\"><a class=\"markdownIt-Anchor\" href=\"#hashmap的查找方法\">#</a> HashMap 的查找方法</h3>\n<p><code>HashMap</code>  的查找的方法，有 <code>get</code> , <code>getOrDefault</code> . 很明显，这两个方法前者不存在的时候返回的是 <code>null</code> ，后者返回的就是 <code>defaultValue</code> .</p>\n<p>先来看下这两个方法:</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * 根据指定的key返回映射的Value，当没有包含key的映射时，会返回 null</span></span><br><span class=\"line\"><span class=\"comment\"> * 更正式的情况下： 如果存在一个key(K)的映射 value (V),使得 key==null?K==null:key.equals(K),</span></span><br><span class=\"line\"><span class=\"comment\"> * 如果等式的值为 true, 那么返回V</span></span><br><span class=\"line\"><span class=\"comment\"> * 否则返回 null</span></span><br><span class=\"line\"><span class=\"comment\"> * 不能通过 返回值为null 来判断是否含有&lt;K,V&gt; 映射，因为HashMap允许value为null。</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> V <span class=\"title\">get</span><span class=\"params\">(Object key)</span> </span>&#123;</span><br><span class=\"line\">    Node&lt;K,V&gt; e;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> (e = getNode(hash(key), key)) == <span class=\"keyword\">null</span> ? <span class=\"keyword\">null</span> : e.value;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> V <span class=\"title\">getOrDefault</span><span class=\"params\">(Object key, V defaultValue)</span> </span>&#123;</span><br><span class=\"line\">    Node&lt;K,V&gt; e;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> (e = getNode(hash(key), key)) == <span class=\"keyword\">null</span> ? defaultValue : e.value;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>我们可以看到，它调用的都是同一个方法，顺藤摸瓜，我们看这个  <code>getNode</code>  方法.</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">final</span> HashMap.<span class=\"function\">Node&lt;K, V&gt; <span class=\"title\">getNode</span><span class=\"params\">(<span class=\"keyword\">int</span> hash, Object key)</span> </span>&#123;</span><br><span class=\"line\">    HashMap.Node&lt;K, V&gt;[] tab;</span><br><span class=\"line\">    HashMap.Node&lt;K, V&gt; first, e;</span><br><span class=\"line\">    <span class=\"keyword\">int</span> n;</span><br><span class=\"line\">    K k;</span><br><span class=\"line\">    <span class=\"comment\">// 数组不为空，并且对应的桶(bin)不为null</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> ((tab = table) != <span class=\"keyword\">null</span> &amp;&amp; (n = tab.length) &gt; <span class=\"number\">0</span> &amp;&amp;</span><br><span class=\"line\">            (first = tab[(n - <span class=\"number\">1</span>) &amp; hash]) != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">        <span class=\"comment\">// 检查是否为桶内的第一个节点是否满足</span></span><br><span class=\"line\">        <span class=\"comment\">// 为什么要检测第一个节点，直接进入循环或者树节点的检测不行吗?</span></span><br><span class=\"line\">        <span class=\"comment\">// 假设第一个节点是目的节点,可以直接返回，少执行一次if判断，来判断其是树节点还是链表节点。</span></span><br><span class=\"line\">        <span class=\"comment\">// 如果不是第一个节点，循环也会少执行一次,树节点的遍历，也会少遍历一次。</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (first.hash == hash &amp;&amp; <span class=\"comment\">// always check first node</span></span><br><span class=\"line\">                ((k = first.key) == key || (key != <span class=\"keyword\">null</span> &amp;&amp; key.equals(k))))</span><br><span class=\"line\">            <span class=\"keyword\">return</span> first;</span><br><span class=\"line\">        <span class=\"comment\">//如果第一个节点不是要查找的节点</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> ((e = first.next) != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">            <span class=\"comment\">// 如果是树节点</span></span><br><span class=\"line\">            <span class=\"keyword\">if</span> (first <span class=\"keyword\">instanceof</span> HashMap.TreeNode) &#123;</span><br><span class=\"line\">                <span class=\"keyword\">return</span> ((HashMap.TreeNode&lt;K, V&gt;) first).getTreeNode(hash, key);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"comment\">// 如果是链表,遍历查找。</span></span><br><span class=\"line\">            <span class=\"keyword\">do</span> &#123;</span><br><span class=\"line\">                <span class=\"keyword\">if</span> (e.hash == hash &amp;&amp;</span><br><span class=\"line\">                        ((k = e.key) == key || (key != <span class=\"keyword\">null</span> &amp;&amp; key.equals(k))))</span><br><span class=\"line\">                    <span class=\"keyword\">return</span> e;</span><br><span class=\"line\">            &#125; <span class=\"keyword\">while</span> ((e = e.next) != <span class=\"keyword\">null</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"keyword\">null</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>由于 jdk8 之后，有两种类型的节点，我们还说过，这两种节点是  <code>爷孙</code>  的关系.<br>\n 链表的节点遍历就不用看了，比较简单。我们看下 红黑树的节点的查找:</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">final</span> HashMap.<span class=\"function\">TreeNode&lt;K, V&gt; <span class=\"title\">getTreeNode</span><span class=\"params\">(<span class=\"keyword\">int</span> h, Object k)</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"comment\">// 如果当前节点不是根节点,找到根节点，调用find进行查找,</span></span><br><span class=\"line\">    <span class=\"comment\">// 如果是根节点，调用find进行查找。</span></span><br><span class=\"line\">    <span class=\"keyword\">return</span> ((parent != <span class=\"keyword\">null</span>) ? root() : <span class=\"keyword\">this</span>).find(h, k, <span class=\"keyword\">null</span>);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"comment\">/*</span></span><br><span class=\"line\"><span class=\"comment\">* 红黑树的查找，</span></span><br><span class=\"line\"><span class=\"comment\">* 从根节点开始, 直接判断hash值即可。</span></span><br><span class=\"line\"><span class=\"comment\">* 如果hash值，小于当前节点hash值，对其左子树进行遍历。</span></span><br><span class=\"line\"><span class=\"comment\">* 反之，对右子树进行遍历。</span></span><br><span class=\"line\"><span class=\"comment\">* key值相等直接返回.</span></span><br><span class=\"line\"><span class=\"comment\">* 注意: 这里有左右子树为null的情况。</span></span><br><span class=\"line\"><span class=\"comment\">* 对接k和k的类进行比较,判断其要遍历的树为左子树或者右子树。</span></span><br><span class=\"line\"><span class=\"comment\">*/</span></span><br><span class=\"line\"><span class=\"keyword\">final</span> HashMap.<span class=\"function\">TreeNode&lt;K, V&gt; <span class=\"title\">find</span><span class=\"params\">(<span class=\"keyword\">int</span> h, Object k, Class&lt;?&gt; kc)</span> </span>&#123;</span><br><span class=\"line\">    HashMap.TreeNode&lt;K, V&gt; p = <span class=\"keyword\">this</span>;</span><br><span class=\"line\">    <span class=\"keyword\">do</span> &#123;</span><br><span class=\"line\">        <span class=\"keyword\">int</span> ph, dir;</span><br><span class=\"line\">        K pk;</span><br><span class=\"line\">        HashMap.TreeNode&lt;K, V&gt; pl = p.left, pr = p.right, q;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> ((ph = p.hash) &gt; h)</span><br><span class=\"line\">            p = pl;</span><br><span class=\"line\">        <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (ph &lt; h)</span><br><span class=\"line\">            p = pr;</span><br><span class=\"line\">        <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> ((pk = p.key) == k || (k != <span class=\"keyword\">null</span> &amp;&amp; k.equals(pk)))</span><br><span class=\"line\">            <span class=\"keyword\">return</span> p;</span><br><span class=\"line\">        <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (pl == <span class=\"keyword\">null</span>)</span><br><span class=\"line\">            p = pr;</span><br><span class=\"line\">        <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (pr == <span class=\"keyword\">null</span>)</span><br><span class=\"line\">            p = pl;</span><br><span class=\"line\">        <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> ((kc != <span class=\"keyword\">null</span> ||</span><br><span class=\"line\">                (kc = comparableClassFor(k)) != <span class=\"keyword\">null</span>) &amp;&amp;</span><br><span class=\"line\">                (dir = compareComparables(kc, k, pk)) != <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">            p = (dir &lt; <span class=\"number\">0</span>) ? pl : pr;</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> ((q = pr.find(h, k, kc)) != <span class=\"keyword\">null</span>)</span><br><span class=\"line\">            <span class=\"keyword\">return</span> q;</span><br><span class=\"line\">        <span class=\"keyword\">else</span></span><br><span class=\"line\">            p = pl;</span><br><span class=\"line\">    &#125; <span class=\"keyword\">while</span> (p != <span class=\"keyword\">null</span>);</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"keyword\">null</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>这个查找关键因素在于判断对左子树还是右子树进行递归遍历匹配。</p>\n<p>以上就是红黑树的查找过程了。</p>\n<h3 id=\"hashmap的其他常用方法\"><a class=\"markdownIt-Anchor\" href=\"#hashmap的其他常用方法\">#</a> HashMap 的其他常用方法</h3>\n<p>这些方法中的实现，我们大部分都分享过了。接下来，我们简单的看下其是如何调用的就好了.</p>\n<h4 id=\"hashmapcontainskey-和-hashmapcontainsvalue\"><a class=\"markdownIt-Anchor\" href=\"#hashmapcontainskey-和-hashmapcontainsvalue\">#</a>  <code>HashMap.containsKey()</code>  和  <code>HashMap.containsValue()</code></h4>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * 如果Map中包含一个映射关系,则返回true,注意是包含映射关系就会返回ture.</span></span><br><span class=\"line\"><span class=\"comment\"> * hashMap.put(&quot;1&quot;,null),也会返回true</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">boolean</span> <span class=\"title\">containsKey</span><span class=\"params\">(Object key)</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> getNode(hash(key), key) != <span class=\"keyword\">null</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * 如果存在指定的Value,就会返回true</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">boolean</span> <span class=\"title\">containsValue</span><span class=\"params\">(Object value)</span> </span>&#123;</span><br><span class=\"line\">    HashMap.Node&lt;K, V&gt;[] tab;</span><br><span class=\"line\">    V v;</span><br><span class=\"line\">    <span class=\"comment\">// 如果table的长度不为空</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> ((tab = table) != <span class=\"keyword\">null</span> &amp;&amp; size &gt; <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">        <span class=\"comment\">// 遍历每个bin</span></span><br><span class=\"line\">        <span class=\"keyword\">for</span> (<span class=\"keyword\">int</span> i = <span class=\"number\">0</span>; i &lt; tab.length; ++i) &#123;</span><br><span class=\"line\">            <span class=\"comment\">// 遍历bin下的每个Node</span></span><br><span class=\"line\">            <span class=\"keyword\">for</span> (HashMap.Node&lt;K, V&gt; e = tab[i]; e != <span class=\"keyword\">null</span>; e = e.next) &#123;</span><br><span class=\"line\">                <span class=\"keyword\">if</span> ((v = e.value) == value ||</span><br><span class=\"line\">                        (value != <span class=\"keyword\">null</span> &amp;&amp; value.equals(v)))</span><br><span class=\"line\">                    <span class=\"keyword\">return</span> <span class=\"keyword\">true</span>;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"keyword\">false</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>这里为什么可以通过  <code>.next</code>  的方式去遍历呢？<br>\n 这个主要是考虑在转换成树节点和树节点的新增的时候。 <code>hashMap</code>  在这两个时刻都对 <code>HashMap</code>  的 <code>next</code>  &quot;指针&quot; 进行了维护。所以，在这里就可以明白了，为什么树化节点时候还要维护 <code>.next</code>  了.</p>\n<h4 id=\"hashmapsize\"><a class=\"markdownIt-Anchor\" href=\"#hashmapsize\">#</a>  <code>HashMap.size()</code></h4>\n<p><code>HashMap</code>   的  <code>size</code>  函数最简单了，因为  <code>HashMap</code>  内部本来就维护了一个  <code>size</code>  字段，来记录  <code>HashMap</code>  的元素数量.</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * 返回HashMap的映射数量</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"meta\">@Override</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">int</span> <span class=\"title\">size</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> size;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h4 id=\"hashmapisempty\"><a class=\"markdownIt-Anchor\" href=\"#hashmapisempty\">#</a>  <code>HashMap.isEmpty()</code></h4>\n<p>HashMap 的 isEmpty 同样简单，废话少说，看下它的实现</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * 如果为映射数量为0的时候，返回true</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"meta\">@Override</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">boolean</span> <span class=\"title\">isEmpty</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> size == <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h4 id=\"hashmapentryset\"><a class=\"markdownIt-Anchor\" href=\"#hashmapentryset\">#</a>  <code>HashMap.entrySet()</code></h4>\n<p>这个方法是我们在遍历的时候，常用的一个方法，它的实现有点小复杂。 我们来看下。</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * 返回这个Map里映射关系的一个 Set 视图.</span></span><br><span class=\"line\"><span class=\"comment\"> * 修改HashMap会影响这个 Set 视图, 同样的，在这个视图里修改, 也会影响HashMap</span></span><br><span class=\"line\"><span class=\"comment\"> * 如果通过对视图的迭代过程来修改HashMap(除了迭代器自身的remove方法,或者对迭代器返回的Entry的setValue操作),</span></span><br><span class=\"line\"><span class=\"comment\"> * 修改的结果是不确定的。</span></span><br><span class=\"line\"><span class=\"comment\"> * 这个 set 视图, 支持元素的删除, 也会从 HashMap 中删除对应的元素.</span></span><br><span class=\"line\"><span class=\"comment\"> *  支持 Iterator.remove, Set.remove,  Set.removeAll, Set.retainAll, Set.clear 等操作</span></span><br><span class=\"line\"><span class=\"comment\"> * 但是它不支持 add, addAll 操作</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> Set&lt;Map.Entry&lt;K, V&gt;&gt; entrySet() &#123;</span><br><span class=\"line\">    Set&lt;Map.Entry&lt;K, V&gt;&gt; es;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> (es = entrySet) == <span class=\"keyword\">null</span> ? (entrySet = <span class=\"keyword\">new</span> HashMap.EntrySet()) : es;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>从上面的代码可以看出，如果 <code>entrySet</code>  这个属性的为 <code>null</code>  的时候，就会返回一个空的 <code>HashMap</code>  的 <code>entry</code> , 否则就返回 <code>entrySet(es)</code> .<br>\n 那么  <code>entrySet</code>  这个字段是怎么来的呢？</p>\n<p>最先 HashMap 定义了一个这样的字段。</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * 保存缓存的 entrySet().</span></span><br><span class=\"line\"><span class=\"comment\"> * 注意: 这个AbstractMap 的字段会被 keySet() 和 values()使用。</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"keyword\">transient</span> Set&lt;Map.Entry&lt;K, V&gt;&gt; entrySet;</span><br></pre></td></tr></table></figure>\n<p>好了，我们接着来看  <code>HashMap.EntrySet()</code></p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">    * EntrySet 继承的是 AbstractSet,</span></span><br><span class=\"line\"><span class=\"comment\">    * 泛型传入</span></span><br><span class=\"line\"><span class=\"comment\">    */</span></span><br><span class=\"line\"><span class=\"keyword\">final</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">EntrySet</span> <span class=\"keyword\">extends</span> <span class=\"title\">AbstractSet</span>&lt;<span class=\"title\">Map</span>.<span class=\"title\">Entry</span>&lt;<span class=\"title\">K</span>, <span class=\"title\">V</span>&gt;&gt; </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> <span class=\"title\">size</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> size;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">final</span> <span class=\"keyword\">void</span> <span class=\"title\">clear</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        HashMap.<span class=\"keyword\">this</span>.clear();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">        * 直接调用 HashMap 迭代器</span></span><br><span class=\"line\"><span class=\"comment\">        *</span></span><br><span class=\"line\"><span class=\"comment\">        * <span class=\"doctag\">@return</span></span></span><br><span class=\"line\"><span class=\"comment\">        */</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">final</span> Iterator&lt;Map.Entry&lt;K, V&gt;&gt; iterator() &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> HashMap.EntryIterator();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">        * 判断是否存在,</span></span><br><span class=\"line\"><span class=\"comment\">        * 直接调用的是hashMap的getNode方法</span></span><br><span class=\"line\"><span class=\"comment\">        */</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">final</span> <span class=\"keyword\">boolean</span> <span class=\"title\">contains</span><span class=\"params\">(Object o)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!(o <span class=\"keyword\">instanceof</span> Map.Entry))</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"keyword\">false</span>;</span><br><span class=\"line\">        Map.Entry&lt;?, ?&gt; e = (Map.Entry&lt;?, ?&gt;) o;</span><br><span class=\"line\">        Object key = e.getKey();</span><br><span class=\"line\">        HashMap.Node&lt;K, V&gt; candidate = getNode(hash(key), key);</span><br><span class=\"line\">        <span class=\"keyword\">return</span> candidate != <span class=\"keyword\">null</span> &amp;&amp; candidate.equals(e);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">        * 直接调用的 HashMap的删除方法.</span></span><br><span class=\"line\"><span class=\"comment\">        * 从这个方法中也可以看出来, 我们在 set试图中删除元素是会直接影响Hashmap的。</span></span><br><span class=\"line\"><span class=\"comment\">        */</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">final</span> <span class=\"keyword\">boolean</span> <span class=\"title\">remove</span><span class=\"params\">(Object o)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (o <span class=\"keyword\">instanceof</span> Map.Entry) &#123;</span><br><span class=\"line\">            Map.Entry&lt;?, ?&gt; e = (Map.Entry&lt;?, ?&gt;) o;</span><br><span class=\"line\">            Object key = e.getKey();</span><br><span class=\"line\">            Object value = e.getValue();</span><br><span class=\"line\">            <span class=\"keyword\">return</span> removeNode(hash(key), key, value, <span class=\"keyword\">true</span>, <span class=\"keyword\">true</span>) != <span class=\"keyword\">null</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">false</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">        * entrySet 的分隔器</span></span><br><span class=\"line\"><span class=\"comment\">        */</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">final</span> Spliterator&lt;Map.Entry&lt;K, V&gt;&gt; spliterator() &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> HashMap.EntrySpliterator&lt;&gt;(HashMap.<span class=\"keyword\">this</span>, <span class=\"number\">0</span>, -<span class=\"number\">1</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">        * entrySet 的迭代器</span></span><br><span class=\"line\"><span class=\"comment\">        */</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">final</span> <span class=\"keyword\">void</span> <span class=\"title\">forEach</span><span class=\"params\">(Consumer&lt;? <span class=\"keyword\">super</span> Map.Entry&lt;K, V&gt;&gt; action)</span> </span>&#123;</span><br><span class=\"line\">        HashMap.Node&lt;K, V&gt;[] tab;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (action == <span class=\"keyword\">null</span>)</span><br><span class=\"line\">            <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> NullPointerException();</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (size &gt; <span class=\"number\">0</span> &amp;&amp; (tab = table) != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">int</span> mc = modCount;</span><br><span class=\"line\">            <span class=\"keyword\">for</span> (<span class=\"keyword\">int</span> i = <span class=\"number\">0</span>; i &lt; tab.length; ++i) &#123;</span><br><span class=\"line\">                <span class=\"keyword\">for</span> (HashMap.Node&lt;K, V&gt; e = tab[i]; e != <span class=\"keyword\">null</span>; e = e.next)</span><br><span class=\"line\">                    action.accept(e);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (modCount != mc)</span><br><span class=\"line\">                <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> ConcurrentModificationException();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h4 id=\"hashmapreplace\"><a class=\"markdownIt-Anchor\" href=\"#hashmapreplace\">#</a>  <code>HashMap.replace()</code></h4>\n<p>这个是  <code>HashMap</code>  覆盖掉 <code>JDK8</code>  版本中 的替换方法，将制定的 <code>K-V</code>  映射替换掉。这个方法也会匹配 <code>Value</code>  的值是否相等。</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@Override</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">boolean</span> <span class=\"title\">replace</span><span class=\"params\">(K key, V oldValue, V newValue)</span> </span>&#123;</span><br><span class=\"line\">    HashMap.Node&lt;K, V&gt; e;</span><br><span class=\"line\">    V v;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ((e = getNode(hash(key), key)) != <span class=\"keyword\">null</span> &amp;&amp;</span><br><span class=\"line\">            ((v = e.value) == oldValue || (v != <span class=\"keyword\">null</span> &amp;&amp; v.equals(oldValue)))) &#123;</span><br><span class=\"line\">        e.value = newValue;</span><br><span class=\"line\">        afterNodeAccess(e);</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">true</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"keyword\">false</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>这个也是覆盖  <code>JDK8</code>  版本中  <code>Map</code>  的方法，返回原来的值。</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@Override</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> V <span class=\"title\">replace</span><span class=\"params\">(K key, V value)</span> </span>&#123;</span><br><span class=\"line\">    HashMap.Node&lt;K, V&gt; e;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ((e = getNode(hash(key), key)) != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">        V oldValue = e.value;</span><br><span class=\"line\">        e.value = value;</span><br><span class=\"line\">        afterNodeAccess(e);</span><br><span class=\"line\">        <span class=\"keyword\">return</span> oldValue;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"keyword\">null</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h4 id=\"hashmapforeach\"><a class=\"markdownIt-Anchor\" href=\"#hashmapforeach\">#</a>  <code>HashMap.forEach()</code></h4>\n<p>这个也是一个常用的方法，实现也比较简单。</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"> <span class=\"meta\">@Override</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">forEach</span><span class=\"params\">(BiConsumer&lt;? <span class=\"keyword\">super</span> K, ? <span class=\"keyword\">super</span> V&gt; action)</span> </span>&#123;</span><br><span class=\"line\">    HashMap.Node&lt;K, V&gt;[] tab;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (action == <span class=\"keyword\">null</span>)</span><br><span class=\"line\">        <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> NullPointerException();</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (size &gt; <span class=\"number\">0</span> &amp;&amp; (tab = table) != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">int</span> mc = modCount;</span><br><span class=\"line\">        <span class=\"keyword\">for</span> (<span class=\"keyword\">int</span> i = <span class=\"number\">0</span>; i &lt; tab.length; ++i) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">for</span> (HashMap.Node&lt;K, V&gt; e = tab[i]; e != <span class=\"keyword\">null</span>; e = e.next)</span><br><span class=\"line\">                action.accept(e.key, e.value);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (modCount != mc)</span><br><span class=\"line\">            <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> ConcurrentModificationException();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h4 id=\"hashmapclear\"><a class=\"markdownIt-Anchor\" href=\"#hashmapclear\">#</a>  <code>HashMap.clear()</code></h4>\n<p>清空方法也是很简单的，逐一置空 <code>null</code>   <code>HashMap</code>  的每个 <code>bin</code></p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">clear</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">    HashMap.Node&lt;K, V&gt;[] tab;</span><br><span class=\"line\">    modCount++;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ((tab = table) != <span class=\"keyword\">null</span> &amp;&amp; size &gt; <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">        size = <span class=\"number\">0</span>;</span><br><span class=\"line\">        <span class=\"keyword\">for</span> (<span class=\"keyword\">int</span> i = <span class=\"number\">0</span>; i &lt; tab.length; ++i)</span><br><span class=\"line\">            tab[i] = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"问题解答\"><a class=\"markdownIt-Anchor\" href=\"#问题解答\">#</a> 问题解答</h2>\n<ul>\n<li>如果我的 HashMap 的初始大小设置为 <code>[3|9|12]</code> , 第一次扩容的时候，容量变为了多少？是如何进行扩容的？</li>\n<li>(有毒的问题) 假设 Hash 表的长度是 32, 已知某一个 bin 中的链表长度为 7, 如果新增一个元素还是在该 bin 中的时，会进行什么操作？  <code>resize</code>  还是 <code>treeifyBin</code> ? 假设完成这个操作后该 bin 中元素数量没变，又新增一个元素还是到该 bin 中，这时进行什么操作？</li>\n</ul>\n<h2 id=\"总结\"><a class=\"markdownIt-Anchor\" href=\"#总结\">#</a> 总结</h2>\n<ul>\n<li>表中允许 null 的键和 null 值。</li>\n<li>线程不同步，</li>\n<li>不保证元素的顺序。</li>\n</ul>\n<h2 id=\"网上常见面试问题汇总以及参考解答\"><a class=\"markdownIt-Anchor\" href=\"#网上常见面试问题汇总以及参考解答\">#</a> 网上常见面试问题汇总以及参考解答</h2>\n<h2 id=\"冷门知识点\"><a class=\"markdownIt-Anchor\" href=\"#冷门知识点\">#</a> 冷门知识点</h2>\n<ul class=\"task-list\">\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"cbx_4\" disabled=\"true\"><label for=\"cbx_4\"> failFast 机制。</label></li>\n</ul>\n<h2 id=\"jdk变更历史说明\"><a class=\"markdownIt-Anchor\" href=\"#jdk变更历史说明\">#</a> JDK 变更历史说明</h2>\n<h2 id=\"课后娱乐\"><a class=\"markdownIt-Anchor\" href=\"#课后娱乐\">#</a> 课后娱乐</h2>\n<ul>\n<li>java 实现红黑树</li>\n<li>自定义实现 hashMap。</li>\n</ul>\n<h2 id=\"参考文档答谢\"><a class=\"markdownIt-Anchor\" href=\"#参考文档答谢\">#</a> 参考文档 &amp; 答谢</h2>\n<h2 id=\"感受\"><a class=\"markdownIt-Anchor\" href=\"#感受\">#</a> 感受</h2>\n<ul>\n<li>注释：新字段要加注释标注此字段的作用，该字段是什么含义。</li>\n</ul>\n<hr>\n<p>阅读之前记录</p>\n<p>1. 图解。遇到问题，画图说明。<br>\n2. 一定要有自己的理解。<br>\n3. 对比其他版本 JDK。</p>\n<h3 id=\"最后\"><a class=\"markdownIt-Anchor\" href=\"#最后\">#</a> 最后</h3>\n<p>期望与你一起遇见更好的自己</p>\n<p><img data-src=\"/images/qrcode.jpg\" alt=\"期望与你一起遇见更好的自己\"></p>\n",
            "tags": [
                "源码",
                "HashMap"
            ]
        }
    ]
}